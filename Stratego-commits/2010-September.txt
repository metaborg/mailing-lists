From L.C.L.Kats at tudelft.nl  Wed Sep  1 13:37:15 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 01 Sep 2010 11:37:15 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21197 - in
	spoofax-imp/trunk: org.strategoxt.imp.editors.aster
	org.strategoxt.imp.editors.aterm
	org.strategoxt.imp.editors.editorservice
	org.strategoxt.imp.editors.pp org....
Message-ID: <201009011137.o81BbFBn007700@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Wed Sep  1 11:37:14 2010
New Revision: 21197
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21197&sc=1

Log:
Release 0.5.3.3
- Revisited Spoofax/210: Add an example Java method to the entities editor, adding compatibility for jar-based and legacy projects
- Another measure to fix Spoofax/227: Spoofax reports that an operation was canceled

Deleted:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.meta
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/options.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-project-file.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/configure-main-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizardPage.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -7,6 +7,13 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/editors/aster/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.aster" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -24,6 +31,8 @@
         <condition property="metasdfmodule.available" value="1">
             <available file="${syntax}/${metasdfmodule}.sdf"/>
         </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
         <mkdir dir="${build}"/>
         <mkdir dir="${src-gen}"/>
         <mkdir dir="${dist}"/>
@@ -315,7 +324,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -354,10 +363,10 @@
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
                 <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
                 <param name="build.stratego.extension" value="java"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,6 +4,7 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="Stratego-Attributes"/>
+        <property name="metasdfmodule" value="Stratego-Stratego-Attributes"/>
         <property name="esvmodule" value="Stratego-Attributes"/>
         <property name="strmodule" value="stratego_attributes"/>
     
@@ -18,13 +19,17 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="--library
-                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
+        <!-- External .def and .jar locations
         <property name="externaldef" location="syntax/${sdfmodule}.def"/>
-        <property name="externaljar" value="utils/aster.jar"/>
-        <property name="externaljarflags" value="-la org.strategoxt.aster"/>
+        <property name="externaljar" value="../lib.jar"/>
+        <property name="externaljarflags" value="-la org.lib"/>
+        -->
     
         <!-- Environment configuration for command-line builds -->
         <condition property="build.strategoxt.sdf" value="${eclipse.spoofaximp.nativeprefix}" else="">
@@ -35,5 +40,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default"/>
-    </project>
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -7,6 +7,13 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/editors/aterm/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.aterm" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -24,6 +31,8 @@
         <condition property="metasdfmodule.available" value="1">
             <available file="${syntax}/${metasdfmodule}.sdf"/>
         </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
         <mkdir dir="${build}"/>
         <mkdir dir="${src-gen}"/>
         <mkdir dir="${dist}"/>
@@ -315,7 +324,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -354,10 +363,10 @@
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
                 <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
                 <param name="build.stratego.extension" value="java"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,6 +4,7 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="ATerm"/>
+        <property name="metasdfmodule" value="Stratego-ATerm"/>
         <property name="esvmodule" value="ATerm"/>
         <property name="strmodule" value="aterm"/>
     
@@ -18,12 +19,14 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="--library
-                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <property name="externaldef" location="syntax/ATerm.def"/>
         <!-- External .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -37,5 +40,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="utils-files,sdf2table,stratego.ctree,sdf2imp"/>
-    </project>
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -7,6 +7,13 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/editors/editorservice/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.editorservice" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -24,6 +31,8 @@
         <condition property="metasdfmodule.available" value="1">
             <available file="${syntax}/${metasdfmodule}.sdf"/>
         </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
         <mkdir dir="${build}"/>
         <mkdir dir="${src-gen}"/>
         <mkdir dir="${dist}"/>
@@ -315,7 +324,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -354,10 +363,10 @@
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
                 <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
                 <param name="build.stratego.extension" value="java"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,6 +4,7 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="EditorService"/>
+        <property name="metasdfmodule" value="Stratego-EditorService"/>
         <property name="esvmodule" value="EditorService"/>
         <property name="strmodule" value="editorservice"/>
     
@@ -18,13 +19,14 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="--library
-                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
-                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm
-                        -la stratego-sdf"/>
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <property name="externaldef" location="../org.strategoxt.imp.generator/src/syntax/EditorService.def"/>
         <!-- External .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -38,5 +40,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.jar"/>
-    </project>
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -7,6 +7,13 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/editors/pp/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.pp" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -24,6 +31,8 @@
         <condition property="metasdfmodule.available" value="1">
             <available file="${syntax}/${metasdfmodule}.sdf"/>
         </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
         <mkdir dir="${build}"/>
         <mkdir dir="${src-gen}"/>
         <mkdir dir="${dist}"/>
@@ -315,7 +324,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -354,10 +363,10 @@
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
                 <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
                 <param name="build.stratego.extension" value="java"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,6 +4,7 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="BoxPP"/>
+        <property name="metasdfmodule" value="Stratego-BoxPP"/>
         <property name="esvmodule" value="BoxPP"/>
         <property name="strmodule" value="boxpp"/>
     
@@ -18,13 +19,14 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="--library
-                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
-        
         <!-- External .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -38,5 +40,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default"/>
-    </project>
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -7,6 +7,13 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/editors/sdf/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.sdf" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -24,6 +31,8 @@
         <condition property="metasdfmodule.available" value="1">
             <available file="${syntax}/${metasdfmodule}.sdf"/>
         </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
         <mkdir dir="${build}"/>
         <mkdir dir="${src-gen}"/>
         <mkdir dir="${dist}"/>
@@ -315,7 +324,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -354,10 +363,10 @@
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
                 <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
                 <param name="build.stratego.extension" value="java"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,6 +4,7 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="SDF"/>
+        <property name="metasdfmodule" value="Stratego-SDF"/>
         <property name="esvmodule" value="SDF"/>
         <property name="strmodule" value="sdf"/>
     
@@ -18,13 +19,14 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="--library
-                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
-                        -la strc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm
-                        -la stratego-sdf"/>
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <property name="externaldef" location="syntax/SDF.def"/>
         <!-- External .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -38,5 +40,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="sdf2table,stratego.jar,sdf2imp,refresh"/>
-    </project>
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -7,6 +7,13 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/editors/stratego/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.stratego" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -24,6 +31,8 @@
         <condition property="metasdfmodule.available" value="1">
             <available file="${syntax}/${metasdfmodule}.sdf"/>
         </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
         <mkdir dir="${build}"/>
         <mkdir dir="${src-gen}"/>
         <mkdir dir="${dist}"/>
@@ -315,7 +324,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -354,10 +363,10 @@
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
                 <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
                 <param name="build.stratego.extension" value="java"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,6 +4,7 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="Stratego-Sugar"/>
+        <property name="metasdfmodule" value="Stratego-Stratego-Sugar"/>
         <property name="esvmodule" value="Stratego-Sugar"/>
         <property name="strmodule" value="stratego_sugar"/>
     
@@ -18,12 +19,14 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="--library
-                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
-                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm -la strc"/>
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <property name="externaldef" location="syntax/Stratego-Sugar.def"/>
         <!-- External .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -37,5 +40,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="utils-files,sdf2table,ppgen.helper.fallback,pppack.helper.fallback,stratego.jar,sdf2imp"/>
-    </project>
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	Wed Sep  1 11:37:14 2010	(r21197)
@@ -10,6 +10,7 @@
                   {| | // hack: interacts with { }
                   <% %>
                   |[ ]|
+                  (|[ "" // hack: interacts with |[ ]| 
                   $[ ]
                   ${ }
                   $< >

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.5.3.2"
+      version="0.5.3.3"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -103,6 +103,7 @@
       create-grammar;
       create-pp-table;
       create-example-trans;
+      create-java-strategy;
       input @ FILE(inputname) := <pack-default-sdf> FILE($[syntax/[<get-sdf-main-module>].sdf]);
       rules(DefaultDefFile := inputname)
     end;
@@ -141,10 +142,10 @@
     create-manifest;
     create-plugin-xml;
     create-build-xml;
+    create-build-generated-xml;
     create-builder-xml;
     create-example-file;
     create-common-trans;
-    create-java-strategy;
     copy-jars;
     copy-def-file;
     

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/options.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/options.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/options.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -98,6 +98,9 @@
     string-tokenize('.');
     map(!Id(<id>));
     !PackageName(<id>)
+    
+  get-package-name-text =
+    BasePackage <+ default-package-name
   
   default-package-name =
     get-sdf-main-module;

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -1,6 +1,7 @@
 module project/create-build-xml
 
 imports
+  sdf2imp/options
   sdf2imp/util/-
   sdf2imp/project/create-example-trans
 
@@ -9,7 +10,6 @@
   create-build-xml =
     // Note that we cannot call this file build.xml,
     // as Eclipse will delete it as it deploys plugins
-    create-build-generated-xml;
     <file-exists> "build.main.xml"
   <+
     name       := <get-sdf-main-module>;
@@ -44,7 +44,7 @@
                         -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <!-- External .def and .jar locations
+        <!-- Optional: external .def and .jar locations
         <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
@@ -67,6 +67,8 @@
     name       := <get-sdf-main-module>;
     name'      := <trans-module-name>;
     classname  := <get-main-class-name>;
+    pkgname    := <get-package-name-text>;
+    pkgdir     := <string-replace(|".", "/")> pkgname;
     
     <output-xml-file(|[], "build.generated.xml")>
     %>
@@ -78,6 +80,13 @@
         <target name="spoofaximp.default.jar"   depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
+        <available file="${build}/<%= pkgdir %>/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la <%= pkgname %>.strategies" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
         <dirname property="externaldefdir" file="${externaldef}"/>
         <condition property="externaldefimport" value="-I ${externaldefdir}" else="">
@@ -388,7 +397,7 @@
             </java>
         </target>
         
-        <target name="java.jar">
+        <target name="java.jar" if="java.jar.enabled">
             <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
         </target>
     
@@ -405,10 +414,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputpath" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -426,11 +433,10 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front"/>
-                <param name="build.stratego.extension" value="java"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
             </antcall>
-            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
             <copy todir="${build}/trans">
                 <fileset dir="${src-gen}/trans" excludes="**/*.java"/>
@@ -453,7 +459,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -462,7 +468,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>
@@ -501,18 +507,3 @@
         </target>
     </project>
     <%
-
-/*
-        <available file="${build.strategoxt.stratego}/strj" property="build.stratego.usenativestrj"/>
-
-        <target name="stratego.java.native" if="build.stratego.usenativestrj">
-            <antcall target="stratego.c.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
-                <param name="build.stratego.extraargs" value="-la java-front -p trans"/>
-                <param name="build.stratego.extension" value="java"/>
-                <param name="build.stratego.compiler" value="strj"/>
-            </antcall>
-            <javac classpath="utils/strategoxt.jar${externaljarimport}" srcdir="${src-gen}/trans" destdir="${build}" source="1.5" debug="on"/>
-            <jar basedir="${build}" includes="trans/**" destfile="${include}/${strmodule}.jar"/>
-        </target>
-*/

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -4,18 +4,20 @@
   sdf2imp/util/-
 
 strategies
-  
+
   create-java-strategy =
     create-java-strategy-1;
-    create-java-strategy-2
+    create-java-strategy-2;
+    create-java-strategy-3
 
   create-java-strategy-1 =
-    <file-exists> "editor/java/InteropRegisterer.java"
+    <file-exists> "editor/java/strategies/InteropRegisterer.java"
   <+
-    pkgname := <get-package-name>;
+    pkgname  := <get-package-name-text>;
+    pkgpart* := <string-tokenize('.')> pkgname;
     
-    <output-java-file> |[
-       package pkgname;
+    <output-text-file(|["editor","java",pkgpart*,"strategies"],"InteropRegisterer.java")>
+    $[ package [pkgname].strategies;
 
        import org.strategoxt.lang.JavaInteropRegisterer;
        import org.strategoxt.lang.Strategy;
@@ -23,24 +25,38 @@
        public class InteropRegisterer extends JavaInteropRegisterer {
 
          public InteropRegisterer() {
-           super(new Strategy[] { java_strategy_0_0.instance });
+           super(new Strategy$[$$]$ { java_strategy_0_0.instance });
          }
        }
-    ]|
+    ]
   
   create-java-strategy-2 =
-    <file-exists> "editor/java/java_strategy_0_0.java"
+    <file-exists> "editor/java/strategies/java_strategy_0_0.java"
   <+
-    pkgname := <get-package-name>;
+    pkgname  := <get-package-name-text>;
+    pkgpart* := <string-tokenize('.')> pkgname;
     
-    <output-java-file>
-    |[ package pkgname;
+    <output-text-file(|["editor","java",pkgpart*,"strategies"],"java_strategy_0_0.java")>
+    $[ package [pkgname].strategies;
 
        import org.spoofax.interpreter.terms.IStrategoTerm;
        import org.spoofax.interpreter.terms.ITermFactory;
        import org.strategoxt.lang.Context;
        import org.strategoxt.lang.Strategy;
        
+       /**
+        * Example Java strategy implementation.
+        *
+        * This strategy can be used by editor services and can be called
+        * in Stratego modules by declaring it as an external strategy
+        * as follows:
+        *
+        * <code>
+        *  external java-strategy(|)
+        * </code>
+        *
+        * @see InteropRegisterer  This class registers java_strategy_0_0 for use.
+        */
        public class java_strategy_0_0 extends Strategy {
          
          public static java_strategy_0_0 instance = new java_strategy_0_0();
@@ -49,8 +65,28 @@
          public IStrategoTerm invoke(Context context, IStrategoTerm current) {
            context.getIOAgent().printError("Input for java-strategy: " + current);
            ITermFactory factory = context.getFactory();
-           return factory.makeString("Goodbye world");
+           return factory.makeString("Regards from java-strategy");
+         }
+       
+       }
+    ]
+  
+  create-java-strategy-3 =
+    <file-exists> "editor/java/strategies/Main.java"
+  <+
+    pkgname  := <get-package-name-text>;
+    pkgpart* := <string-tokenize('.')> pkgname;
+    
+   <output-text-file(|["editor","java",pkgpart*,"strategies"],"Main.java")>
+    $[ package [pkgname].strategies;
+
+       import org.strategoxt.lang.Context;
+       
+       public class Main {
+         
+         public static void init(Context context) {
+           // Called when the editor is being initialized
          }
        
        }
-    ]|
\ No newline at end of file
+    ]

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-project-file.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-project-file.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-project-file.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -19,22 +19,22 @@
       <name><%= package::cdata %></name>
       <comment></comment>
       <buildSpec>
-		<buildCommand>
-			<name>org.eclipse.ui.externaltools.ExternalToolBuilder</name>
-			<triggers>full,incremental,</triggers>
-			<arguments>
-				<dictionary>
-					<key>LaunchConfigHandle</key>
-					<value><%= builder-xml::cdata %></value>
-				</dictionary>
-			</arguments>
-		</buildCommand>
         <buildCommand>
           <name>org.eclipse.jdt.core.javabuilder</name>
           <arguments>
           </arguments>
         </buildCommand>
         <buildCommand>
+            <name>org.eclipse.ui.externaltools.ExternalToolBuilder</name>
+            <triggers>full,incremental,</triggers>
+            <arguments>
+                <dictionary>
+                    <key>LaunchConfigHandle</key>
+                    <value><%= builder-xml::cdata %></value>
+                </dictionary>
+            </arguments>
+        </buildCommand>
+        <buildCommand>
           <name>org.eclipse.pde.ManifestBuilder</name>
           <arguments>
           </arguments>

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/configure-main-descriptor.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/configure-main-descriptor.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/configure-main-descriptor.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -60,7 +60,8 @@
                fatal-err-msg(|["Could not import module ", m])
              end
            where
-             not(<eq> (<main-descriptor-name>, m)) // silently ignore non-main import fails
+             not(<eq> (<main-descriptor-name>, m)); // silently ignore non-main import fails
+             warn(|["Could not import module", m]) //DEBUG
        );
        main-descriptor-name;
        input-descriptor-file;

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	Wed Sep  1 11:37:14 2010	(r21197)
@@ -12,7 +12,8 @@
   create-builders-descriptor =
     output-initial-descriptor-file(
       <descriptor-name> "-Builders"
-    , provider := <conc-strings> ("include/", <trans-module-name>, ".ctree");
+    , provider1 := <conc-strings> ("include/", <trans-module-name>, ".ctree");
+      provider2 := <conc-strings> ("include/", <trans-module-name>, "-java.jar");
       !|[
         module <descriptor-name> "-Builders"
         
@@ -25,7 +26,8 @@
           ~~// See the imported file for a brief introduction and examples.
         builders
           ~~
-          provider: ~provider
+          provider: ~provider1
+          provider: ~provider2
           ~~
           observer: editor-analyze
           ~~

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizardPage.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizardPage.java	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizardPage.java	Wed Sep  1 11:37:14 2010	(r21197)
@@ -264,7 +264,8 @@
 			if (Character.isLetterOrDigit(c) || c == '.' || c == '_')
 				output.append(c);
 		}
-		return output.toString();
+		String result = output.toString().replaceAll("\\.(?=\\.|[0-9]|\\Z)", "");
+		return result;
 	}
 	
 	private static String toExtension(String name) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Wed Sep  1 11:37:14 2010	(r21197)
@@ -13,7 +13,6 @@
 import org.eclipse.core.runtime.jobs.Job;
 import org.eclipse.imp.parser.IParseController;
 import org.strategoxt.imp.runtime.Environment;
-import org.strategoxt.imp.runtime.MonitorStateWatchDog;
 
 /**
  * A workbench-global queue of Stratego operations.
@@ -70,9 +69,11 @@
 		protected IStatus run(IProgressMonitor monitor) {
 
 			running = true;
+			/* May cause Spoofax/227
 			MonitorStateWatchDog protector = new MonitorStateWatchDog(this, monitor, job.getObserver());
 			if (!isSystem())
 				protector.beginProtect();
+			*/
 
 			IStatus status;
 			try {
@@ -86,8 +87,10 @@
 				Environment.logException("Error running scheduled analysis", e);
 				status = Status.CANCEL_STATUS;
 			} finally {
+				/*
 				if (!isSystem())
 					protector.endProtect();
+				*/
 			}
 
 			// Run next task

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Wed Sep  1 11:37:14 2010	(r21197)
@@ -9,6 +9,8 @@
 import java.io.ByteArrayInputStream;
 import java.io.FileNotFoundException;
 import java.io.InputStream;
+import java.io.PrintWriter;
+import java.io.Writer;
 import java.util.Map;
 import java.util.WeakHashMap;
 import java.util.concurrent.CancellationException;
@@ -32,6 +34,7 @@
 import org.spoofax.interpreter.core.InterpreterException;
 import org.spoofax.interpreter.core.InterpreterExit;
 import org.spoofax.interpreter.core.UndefinedStrategyException;
+import org.spoofax.interpreter.library.IOAgent;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.EditorState;
@@ -315,7 +318,13 @@
 	private void reportGenericException(EditorState editor, Throwable e) {
 		boolean isDynamic = editor.getDescriptor().isDynamicallyLoaded();
 		Environment.logException("Builder failed for " + (isDynamic ? "" : "non-") + "dynamically loaded editor", e);
-		if (isDynamic) StrategoConsole.activateConsole();
+		if (isDynamic) {
+			Writer writer = observer.getRuntime().getIOAgent().getWriter(IOAgent.CONST_STDERR);
+			PrintWriter printWriter = new PrintWriter(writer);
+			e.printStackTrace(printWriter);
+			printWriter.flush();
+			StrategoConsole.activateConsole();
+		}
 		
 		if (EditorState.isUIThread()) {
 			// Only show if builder runs interactively (and not from the StrategoBuilderListener background builder)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Tue Aug 31 09:31:21 2010	(r21196)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Wed Sep  1 11:37:14 2010	(r21197)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.5.3.2.jar" id="org.strategoxt.imp" version="0.5.3.2">
+   <feature url="features/org.strategoxt.imp_0.5.3.3.jar" id="org.strategoxt.imp" version="0.5.3.3">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">


From L.C.L.Kats at tudelft.nl  Wed Sep  1 16:59:49 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 01 Sep 2010 14:59:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21199 - in
	spoofax-imp/trunk: org.strategoxt.imp.editors.aster
	org.strategoxt.imp.editors.aterm
	org.strategoxt.imp.editors.editorservice
	org.strategoxt.imp.editors.pp org....
Message-ID: <201009011459.o81ExnE9010647@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Wed Sep  1 14:59:47 2010
New Revision: 21199
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21199&sc=1

Log:
- Fixed "stop button" behavior for analysis
- Typo in generated build xml (included in 0.5.3.3)

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.generated.xml	Wed Sep  1 14:59:47 2010	(r21199)
@@ -7,8 +7,8 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
-        <available file="${src-gen}/org/strategoxt/imp/editors/aster/Main.java" property="java.jar.enabled"/>
-        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.aster" else="">
+        <available file="${build}/org/strategoxt/imp/editors/aster/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.aster.strategies" else="">
             <isset property="java.jar.enabled"/>
         </condition>
         <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
@@ -341,10 +341,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -362,9 +360,8 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
                 <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
-                <param name="build.stratego.extension" value="java"/>
             </antcall>
             <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
@@ -389,7 +386,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -398,7 +395,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml	Wed Sep  1 14:59:47 2010	(r21199)
@@ -7,8 +7,8 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
-        <available file="${src-gen}/org/strategoxt/imp/editors/aterm/Main.java" property="java.jar.enabled"/>
-        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.aterm" else="">
+        <available file="${build}/org/strategoxt/imp/editors/aterm/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.aterm.strategies" else="">
             <isset property="java.jar.enabled"/>
         </condition>
         <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
@@ -341,10 +341,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -362,9 +360,8 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
                 <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
-                <param name="build.stratego.extension" value="java"/>
             </antcall>
             <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
@@ -389,7 +386,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -398,7 +395,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml	Wed Sep  1 14:59:47 2010	(r21199)
@@ -7,8 +7,8 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
-        <available file="${src-gen}/org/strategoxt/imp/editors/editorservice/Main.java" property="java.jar.enabled"/>
-        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.editorservice" else="">
+        <available file="${build}/org/strategoxt/imp/editors/editorservice/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.editorservice.strategies" else="">
             <isset property="java.jar.enabled"/>
         </condition>
         <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
@@ -341,10 +341,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -362,9 +360,8 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
                 <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
-                <param name="build.stratego.extension" value="java"/>
             </antcall>
             <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
@@ -389,7 +386,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -398,7 +395,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.generated.xml	Wed Sep  1 14:59:47 2010	(r21199)
@@ -7,8 +7,8 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
-        <available file="${src-gen}/org/strategoxt/imp/editors/pp/Main.java" property="java.jar.enabled"/>
-        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.pp" else="">
+        <available file="${build}/org/strategoxt/imp/editors/pp/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.pp.strategies" else="">
             <isset property="java.jar.enabled"/>
         </condition>
         <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
@@ -341,10 +341,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -362,9 +360,8 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
                 <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
-                <param name="build.stratego.extension" value="java"/>
             </antcall>
             <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
@@ -389,7 +386,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -398,7 +395,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml	Wed Sep  1 14:59:47 2010	(r21199)
@@ -7,8 +7,8 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
-        <available file="${src-gen}/org/strategoxt/imp/editors/sdf/Main.java" property="java.jar.enabled"/>
-        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.sdf" else="">
+        <available file="${build}/org/strategoxt/imp/editors/sdf/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.sdf.strategies" else="">
             <isset property="java.jar.enabled"/>
         </condition>
         <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
@@ -341,10 +341,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -362,9 +360,8 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
                 <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
-                <param name="build.stratego.extension" value="java"/>
             </antcall>
             <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
@@ -389,7 +386,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -398,7 +395,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml	Wed Sep  1 14:59:47 2010	(r21199)
@@ -7,8 +7,8 @@
         <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  java.jar,sdf2imp,refresh"/>
     
         <!-- Initialization -->
-        <available file="${src-gen}/org/strategoxt/imp/editors/stratego/Main.java" property="java.jar.enabled"/>
-        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.stratego" else="">
+        <available file="${build}/org/strategoxt/imp/editors/stratego/strategies/Main.class" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.editors.stratego.strategies" else="">
             <isset property="java.jar.enabled"/>
         </condition>
         <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
@@ -341,10 +341,8 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
-                <param name="build.stratego.extension" value="ctree"/>
-                <param name="build.stratego.compiler" value="strc"/>
             </antcall>
         </target>
     
@@ -362,9 +360,8 @@
             <antcall target="copy-jar"/>
             <antcall target="stratego.jar.deletehelper"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${src-gen}/trans"/>
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
                 <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
-                <param name="build.stratego.extension" value="java"/>
             </antcall>
             <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
             <!-- copy imported terms -->
@@ -389,7 +386,7 @@
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>
                 <arg value="-o"/>
-                <arg value="${build.stratego.outputpath}/${strmodule}.${build.stratego.extension}"/>
+                <arg value="${build.stratego.outputfile}"/>
                 <arg value="-p"/>
                 <arg value="trans"/>
                 <arg value="--library"/>
@@ -398,7 +395,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	Wed Sep  1 14:59:47 2010	(r21199)
@@ -414,7 +414,7 @@
             <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
             <antcall target="copy-jar"/>
             <antcall target="stratego.jvm.helper">
-                <param name="build.stratego.outputpath" value="${include}/${strmodule}.ctree"/>
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
                 <param name="build.stratego.extraargs" value="-F"/>
             </antcall>
         </target>

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-java-strategy.str	Wed Sep  1 14:59:47 2010	(r21199)
@@ -22,6 +22,9 @@
        import org.strategoxt.lang.JavaInteropRegisterer;
        import org.strategoxt.lang.Strategy;
 
+       /**
+        * Helper class for {@link java_strategy_0_0}.
+        */
        public class InteropRegisterer extends JavaInteropRegisterer {
 
          public InteropRegisterer() {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Wed Sep  1 14:59:47 2010	(r21199)
@@ -13,6 +13,7 @@
 import org.eclipse.core.runtime.jobs.Job;
 import org.eclipse.imp.parser.IParseController;
 import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.imp.runtime.MonitorStateWatchDog;
 
 /**
  * A workbench-global queue of Stratego operations.
@@ -40,7 +41,7 @@
 	 */
 	private volatile boolean running = false;
 
-	private class UpdateJob extends Job {
+	protected class UpdateJob extends Job {
 
 		private static final int BACKGROUND = LONG;
 
@@ -49,6 +50,8 @@
 		private final long delay;
 		
 		private boolean cancelled;
+		
+		private MonitorStateWatchDog protector;
 
 		protected UpdateJob(StrategoAnalysisJob job, IPath path, int priority, boolean isSystem,
 				long delay) {
@@ -69,11 +72,9 @@
 		protected IStatus run(IProgressMonitor monitor) {
 
 			running = true;
-			/* May cause Spoofax/227
-			MonitorStateWatchDog protector = new MonitorStateWatchDog(this, monitor, job.getObserver());
+			protector = new MonitorStateWatchDog(this, monitor, job.getObserver());
 			if (!isSystem())
 				protector.beginProtect();
-			*/
 
 			IStatus status;
 			try {
@@ -87,10 +88,8 @@
 				Environment.logException("Error running scheduled analysis", e);
 				status = Status.CANCEL_STATUS;
 			} finally {
-				/*
 				if (!isSystem())
 					protector.endProtect();
-				*/
 			}
 
 			// Run next task
@@ -104,6 +103,12 @@
 			super.schedule(this.delay);
 		}
 		
+		public void cancelNonImmediate() {
+			if (protector != null)
+				protector.endProtect();
+			cancel();
+		}
+		
 		@Override
 		protected void canceling() {
 			cancelled = true;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	Wed Sep  1 12:33:10 2010	(r21198)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	Wed Sep  1 14:59:47 2010	(r21199)
@@ -23,7 +23,6 @@
 import org.eclipse.core.resources.IResource;
 import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.NullProgressMonitor;
-import org.eclipse.core.runtime.jobs.Job;
 import org.eclipse.imp.parser.IModelListener;
 import org.eclipse.imp.parser.IParseController;
 import org.spoofax.IAsyncCancellable;
@@ -51,6 +50,7 @@
 import org.strategoxt.imp.runtime.dynamicloading.IDynamicLanguageService;
 import org.strategoxt.imp.runtime.parser.SGLRParseController;
 import org.strategoxt.imp.runtime.parser.ast.AstMessageHandler;
+import org.strategoxt.imp.runtime.services.StrategoAnalysisQueue.UpdateJob;
 import org.strategoxt.imp.runtime.stratego.EditorIOAgent;
 import org.strategoxt.imp.runtime.stratego.IMPJSGLRLibrary;
 import org.strategoxt.imp.runtime.stratego.StrategoConsole;
@@ -97,7 +97,7 @@
 	
 	private volatile boolean rushNextUpdate;
 	
-	private Job updateJob;
+	private UpdateJob updateJob;
 	
 	private boolean wasExceptionLogged;
 	
@@ -256,7 +256,7 @@
 		try {
 			StrategoAnalysisQueue queue = StrategoAnalysisQueueFactory.getInstance();
 			if (this.updateJob != null) {
-				this.updateJob.cancel();
+				this.updateJob.cancelNonImmediate();
 			}
 			
 			if (this.rushNextUpdate) {


From L.C.L.Kats at tudelft.nl  Wed Sep  1 17:00:12 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 01 Sep 2010 15:00:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21200 - in
	strc-java/trunk/java/runtime/org/strategoxt: . lang
Message-ID: <201009011500.o81F0CxC010660@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Wed Sep  1 15:00:11 2010
New Revision: 21200
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21200&sc=1

Log:


Modified:
   strc-java/trunk/java/runtime/org/strategoxt/IncompatibleJarException.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/JavaInteropRegisterer.java

Modified: strc-java/trunk/java/runtime/org/strategoxt/IncompatibleJarException.java
==============================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/IncompatibleJarException.java	Wed Sep  1 14:59:47 2010	(r21199)
+++ strc-java/trunk/java/runtime/org/strategoxt/IncompatibleJarException.java	Wed Sep  1 15:00:11 2010	(r21200)
@@ -16,7 +16,7 @@
 	}
 
 	public IncompatibleJarException(URL jar, Throwable cause) {
-		super("Incompatible jar:" + jar, cause);
+		super("Incompatible Stratego jar: " + jar, cause);
 		this.jar = jar;
 	}
 

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/JavaInteropRegisterer.java
==============================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/JavaInteropRegisterer.java	Wed Sep  1 14:59:47 2010	(r21199)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/JavaInteropRegisterer.java	Wed Sep  1 15:00:11 2010	(r21200)
@@ -22,11 +22,11 @@
 	
 	private final Strategy[] strategies;
 	
-	public JavaInteropRegisterer(Strategy[] strategies) {
+	public JavaInteropRegisterer(Strategy... strategies) {
 		if (strategies == null)
 			throw new IllegalArgumentException("strategies");
 		if (!getClass().getSimpleName().equals("InteropRegisterer"))
-			throw new IllegalStateException("Class must be named InteropRegisterer: " + getClass().getSimpleName());
+			throw new IllegalStateException("Class must be named InteropRegisterer: " + getClass().getName());
 		this.strategies = strategies;
 	}
 


From g.h.wachsmuth at tudelft.nl  Wed Sep  1 21:19:33 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 01 Sep 2010 19:19:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21201 -
	tiger-spoofax/trans/analysis/names
Message-ID: <201009011919.o81JJXvw013725@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  1 19:19:32 2010
New Revision: 21201
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21201&sc=1

Log:
correct implementation for hiding variable declarations, separated function declarations, and separated type declarations

Modified:
   tiger-spoofax/trans/analysis/names/rename.str

Modified: tiger-spoofax/trans/analysis/names/rename.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/rename.str	Wed Sep  1 15:00:11 2010	(r21200)
+++ tiger-spoofax/trans/analysis/names/rename.str	Wed Sep  1 19:19:32 2010	(r21201)
@@ -15,7 +15,19 @@
 strategies
 
 	rename-all = alltd(propose <+ rename)
+
+rules
 	
+	rename-decl-groups : 
+		([g|gs], es) -> ([g'|gs'], es')
+		where
+			new-scope(
+				<rename-decl-group> g => g' ;
+				<rename-decl-groups> (gs, es) => (gs', es') 
+			)
+			
+	rename-decl-groups :
+		([], es) -> ([], <rename-all> es) 
 rules
 	
 	rename-decl-group :
@@ -56,12 +68,9 @@
 	rename:
 		Let(ds, es) -> Let(ds', es')
 		where
-			new-scope (
-				<group-decls> ds => gs ;
-				<map(rename-decl-group)> gs => gs' ;
-				<flatten-list> gs' => ds' ;
-				<rename-all> es => es'
-			)
+			<group-decls> ds => gs ;
+			<rename-decl-groups> (gs, es) => (gs', es') ;
+			<flatten-list> gs' => ds'
 
 	rename :
 		For(x, e1, e2, e3) -> For(y, e1', e2', e3')
@@ -79,12 +88,12 @@
 		FunDec(f, as, t, e) -> FunDec(g, as, t, e)
     	where 
     		<rename-declaration> (Vars(), f) => g 
-    
-    rename-decl-group :
+
+	rename-decl-group :
 		FunDec(f, as, e) -> FunDec(g, as, e)
     	where 
     		<rename-declaration> (Vars(), f) => g 
-
+    			
 	rename :
 		FunDec(f, as, t, e) -> FunDec(f, as', t', e')
     	where 
@@ -113,7 +122,7 @@
 		where
 			<rename-all> es => es' ;
 			<rename-reference> (Vars(), f) => g
-			
+    		
 rules
 	
 	group-decls :


From g.h.wachsmuth at tudelft.nl  Wed Sep  1 21:42:18 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 01 Sep 2010 19:42:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21202 -
	tiger-spoofax/trans/editor
Message-ID: <201009011942.o81JgIO8013870@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  1 19:42:17 2010
New Revision: 21202
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21202&sc=1

Log:
added debugging

is this a bug?

Modified:
   tiger-spoofax/trans/editor/resolve.str

Modified: tiger-spoofax/trans/editor/resolve.str
==============================================================================
--- tiger-spoofax/trans/editor/resolve.str	Wed Sep  1 19:19:32 2010	(r21201)
+++ tiger-spoofax/trans/editor/resolve.str	Wed Sep  1 19:42:17 2010	(r21202)
@@ -17,9 +17,10 @@
 rules
 
 	editor-resolve: (node, position, ast, path, project-path) -> elem
+		where <debug> ast ; <debug> node
 		where 
 			<resolve> node => elem
-
+		
 	editor-resolve: (node, position, ast, path, project-path) -> elem
 		where 
 			<parent-at-position(|<at-last(![])> position)> ast => grandparent ;		
@@ -27,9 +28,9 @@
 
 rules
 	
-	resolve : Tid(t) 	 -> <project-declaration(type-name)> (Types(), t)  
+	resolve : Tid(t) 	 -> <project-declaration(type-name)> (Types(), t)  where <debug> (t, t)
 	resolve : Var(x) 	 -> <project-declaration(var-name)> (Vars(), x)  
-	resolve : Call(f, _) -> <project-declaration(fun-name)> (Vars(), f)  
+	resolve : Call(f, _) -> <project-declaration(fun-name)> (Vars(), f)  where <debug> (f, f)
 
 	resolve : 
 		FieldVar(e, f) -> fdef


From L.C.L.Kats at tudelft.nl  Thu Sep  2 11:24:05 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 02 Sep 2010 09:24:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21207 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009020924.o829O5U8026011@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Thu Sep  2 09:24:05 2010
New Revision: 21207
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21207&sc=1

Log:
Spoofax/242: content completion templates hide each other

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java	Thu Sep  2 08:53:46 2010	(r21206)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java	Thu Sep  2 09:24:05 2010	(r21207)
@@ -222,7 +222,9 @@
 		if (!(obj instanceof ContentProposal))
 			return false;
 		ContentProposal other = (ContentProposal) obj;
-		return other.getDisplayString().equals(getDisplayString()) && isKeywordProposal() == other.isKeywordProposal();
+		return other.getDisplayString().equals(getDisplayString())
+			&& other.newTextParts.equals(newTextParts) 
+			&& isKeywordProposal() == other.isKeywordProposal();
 	}
 	
 	@Override


From R.B.Vermaas at tudelft.nl  Wed Sep  1 14:33:11 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 01 Sep 2010 12:33:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21198 - hydra/jobs
Message-ID: <201009011233.o81CXBen008542@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Wed Sep  1 12:33:10 2010
New Revision: 21198
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21198&sc=1

Log:
add aspectj-front to strategoxt-packages jobset

Modified:
   hydra/jobs/strategoxt-packages.nix

Modified: hydra/jobs/strategoxt-packages.nix
==============================================================================
--- hydra/jobs/strategoxt-packages.nix	Wed Sep  1 11:37:14 2010	(r21197)
+++ hydra/jobs/strategoxt-packages.nix	Wed Sep  1 12:33:10 2010	(r21198)
@@ -5,6 +5,7 @@
 , javaFrontTarball ? { outPath = ./java-front-0.9.tar.gz; }
 , dryadTarball ? { outPath = ./dryad-0.2pre18756.tar.gz; }
 , strcJavaTarball
+, aspectjFrontTarball
 } :
 
 let
@@ -15,7 +16,7 @@
     aterm = pkgs.strategoPackages018.aterm ;
     sdf2Bundle = pkgs.strategoPackages018.sdf ;
 
-    inherit strategoxtTarball strategoxtUtilsTarball javaFrontTarball dryadTarball strcJavaTarball;
+    inherit strategoxtTarball strategoxtUtilsTarball javaFrontTarball dryadTarball strcJavaTarball aspectjFrontTarball;
   };
   builder = import ../build.nix { inherit baseline pkgsDefault nixpkgs; } ;
 
@@ -29,6 +30,7 @@
     javaFront       = {system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball javaFrontTarball sysPkgs (specs.javaFront sysPkgs) ;
     dryad           = {system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball dryadTarball sysPkgs (specs.dryad sysPkgs) ;
     strcJava        = {system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball strcJavaTarball sysPkgs (specs.strcJava sysPkgs) ;
+    aspectjFront    = {system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball aspectjFrontTarball sysPkgs (specs.aspectjFront sysPkgs) ;
 
   };
 in jobs


From R.B.Vermaas at tudelft.nl  Thu Sep  2 10:49:42 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 02 Sep 2010 08:49:42 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21203 - hydra/jobs
Message-ID: <201009020849.o828ng95025289@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  2 08:49:42 2010
New Revision: 21203
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21203&sc=1

Log:
added typo for a check

Modified:
   hydra/jobs/xdoc.nix

Modified: hydra/jobs/xdoc.nix
==============================================================================
--- hydra/jobs/xdoc.nix	Wed Sep  1 19:42:17 2010	(r21202)
+++ hydra/jobs/xdoc.nix	Thu Sep  2 08:49:42 2010	(r21203)
@@ -18,7 +18,7 @@
         baselineNix = "${hydraConfig}/baseline.nix" ;
         inherit nixpkgs; 
       } ; 
-   
+asd   
       spec = specs.xdoc ; 
     } ;
 


From R.B.Vermaas at tudelft.nl  Thu Sep  2 10:51:42 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 02 Sep 2010 08:51:42 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21204 - hydra/jobs
Message-ID: <201009020851.o828pgoD025337@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  2 08:51:41 2010
New Revision: 21204
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21204&sc=1

Log:
added typo for a check

Modified:
   hydra/jobs/xdoc.nix

Modified: hydra/jobs/xdoc.nix
==============================================================================
--- hydra/jobs/xdoc.nix	Thu Sep  2 08:49:42 2010	(r21203)
+++ hydra/jobs/xdoc.nix	Thu Sep  2 08:51:41 2010	(r21204)
@@ -5,7 +5,8 @@
 , xdocCheckout ? { outPath = ../../xdoc ; rev = 1234 ; }
 , strategoxtUtils ? (import ./strategoxt-utils.nix {}).build {}
 } :
-
+{}
+/*
 let
   specs = import (hydraConfig + "/strategoxt/packages.nix") ; 
   jobs = 
@@ -18,9 +19,9 @@
         baselineNix = "${hydraConfig}/baseline.nix" ;
         inherit nixpkgs; 
       } ; 
-asd   
       spec = specs.xdoc ; 
     } ;
 
 in jobs
 
+*/


From R.B.Vermaas at tudelft.nl  Thu Sep  2 10:53:13 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 02 Sep 2010 08:53:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21205 - hydra/jobs
Message-ID: <201009020853.o828rDnf025364@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  2 08:53:12 2010
New Revision: 21205
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21205&sc=1

Log:
added typo for a check

Modified:
   hydra/jobs/xdoc.nix

Modified: hydra/jobs/xdoc.nix
==============================================================================
--- hydra/jobs/xdoc.nix	Thu Sep  2 08:51:41 2010	(r21204)
+++ hydra/jobs/xdoc.nix	Thu Sep  2 08:53:12 2010	(r21205)
@@ -5,7 +5,9 @@
 , xdocCheckout ? { outPath = ../../xdoc ; rev = 1234 ; }
 , strategoxtUtils ? (import ./strategoxt-utils.nix {}).build {}
 } :
-{}
+{
+asd = abort "";
+}
 /*
 let
   specs = import (hydraConfig + "/strategoxt/packages.nix") ; 


From R.B.Vermaas at tudelft.nl  Thu Sep  2 10:53:46 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 02 Sep 2010 08:53:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21206 - hydra/jobs
Message-ID: <201009020853.o828rkS4025380@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  2 08:53:46 2010
New Revision: 21206
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21206&sc=1

Log:
correct typo for a check

Modified:
   hydra/jobs/xdoc.nix

Modified: hydra/jobs/xdoc.nix
==============================================================================
--- hydra/jobs/xdoc.nix	Thu Sep  2 08:53:12 2010	(r21205)
+++ hydra/jobs/xdoc.nix	Thu Sep  2 08:53:46 2010	(r21206)
@@ -5,10 +5,6 @@
 , xdocCheckout ? { outPath = ../../xdoc ; rev = 1234 ; }
 , strategoxtUtils ? (import ./strategoxt-utils.nix {}).build {}
 } :
-{
-asd = abort "";
-}
-/*
 let
   specs = import (hydraConfig + "/strategoxt/packages.nix") ; 
   jobs = 
@@ -26,4 +22,3 @@
 
 in jobs
 
-*/


From R.B.Vermaas at tudelft.nl  Thu Sep  2 11:37:19 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 02 Sep 2010 09:37:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21208 -
	hydra/strategoxt
Message-ID: <201009020937.o829bJZU026213@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  2 09:37:19 2010
New Revision: 21208
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21208&sc=1

Log:
dryad build: add lib/darwin dir to includes

Modified:
   hydra/strategoxt/packages.nix

Modified: hydra/strategoxt/packages.nix
==============================================================================
--- hydra/strategoxt/packages.nix	Thu Sep  2 09:24:05 2010	(r21207)
+++ hydra/strategoxt/packages.nix	Thu Sep  2 09:37:19 2010	(r21208)
@@ -373,6 +373,10 @@
       buildInputs = [pkgs.pkgconfig pkgs.unzip pkgs.zlib pkgs.jdk];
       requires = svnRequires;
 
+      customEnv = pkgs.lib.optionalAttrs pkgs.stdenv.isDarwin {
+        NIX_CFLAGS_COMPILE = "-I${pkgs.jdk}/include/darwin";
+      };
+
       rpmBuildSupported = true;
       rpmRequires = requires ++ [jdk];
       systemSupported = systemSupport pkgs {


From R.B.Vermaas at tudelft.nl  Fri Sep  3 10:45:21 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 03 Sep 2010 08:45:21 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21209 - hydra
Message-ID: <201009030845.o838jL9f013914@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Fri Sep  3 08:45:21 2010
New Revision: 21209
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21209&sc=1

Log:


Modified:
   hydra/build.nix

Modified: hydra/build.nix
==============================================================================
--- hydra/build.nix	Thu Sep  2 09:37:19 2010	(r21208)
+++ hydra/build.nix	Fri Sep  3 08:45:21 2010	(r21209)
@@ -90,13 +90,12 @@
 
       meta.maintainers = if specpkgs ? notifyAddresses then specpkgs.notifyAddresses else [] ;
 
-    } // (if pkgs.stdenv.system == "i686-cygwin" then 
+    } // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "i686-cygwin") 
             { preConfigure = ''
-                export PATH=$PATH:$out/lib:${pkgs.lib.concatStringsSep ":" (map (p: "${p}/lib") buildInputs)}
+                export PATH=$PATH:$out/bin:${pkgs.lib.concatStringsSep ":" (map (p: "${p}/bin") buildInputs)}
               ''; 
-            } 
-          else {}
-         ));
+            }
+         );
 
   svnInputFromInputs = spec :
     builtins.getAttr ((spec pkgsDefault).attrPrefix + "Checkout") inputs;


From R.B.Vermaas at tudelft.nl  Fri Sep  3 13:51:19 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 03 Sep 2010 11:51:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21210 -
	hydra/strategoxt
Message-ID: <201009031151.o83BpJf2018117@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Fri Sep  3 11:51:18 2010
New Revision: 21210
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21210&sc=1

Log:


Modified:
   hydra/strategoxt/packages.nix

Modified: hydra/strategoxt/packages.nix
==============================================================================
--- hydra/strategoxt/packages.nix	Fri Sep  3 08:45:21 2010	(r21209)
+++ hydra/strategoxt/packages.nix	Fri Sep  3 11:51:18 2010	(r21210)
@@ -697,7 +697,7 @@
        */
       customEnv =
         pkgs.lib.optionalAttrs ( (isMinGW pkgs) || (isCygwin pkgs) ) { CFLAGS = "-O2 -Wl,--stack=0x2300000";} 
-        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; } ;
+        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; NIX_LDFLAGS = "-stack_size 0x10000000 -stack_addr 0xc0000000"; } ;
 
       /**
        * On MinGW we don't have Stratego/XT, so we cannot run a check.


From R.B.Vermaas at tudelft.nl  Fri Sep  3 13:54:40 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 03 Sep 2010 11:54:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21211 -
	hydra/strategoxt
Message-ID: <201009031154.o83BseCl018167@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Fri Sep  3 11:54:40 2010
New Revision: 21211
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21211&sc=1

Log:


Modified:
   hydra/strategoxt/packages.nix

Modified: hydra/strategoxt/packages.nix
==============================================================================
--- hydra/strategoxt/packages.nix	Fri Sep  3 11:51:18 2010	(r21210)
+++ hydra/strategoxt/packages.nix	Fri Sep  3 11:54:40 2010	(r21211)
@@ -697,7 +697,7 @@
        */
       customEnv =
         pkgs.lib.optionalAttrs ( (isMinGW pkgs) || (isCygwin pkgs) ) { CFLAGS = "-O2 -Wl,--stack=0x2300000";} 
-        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; NIX_LDFLAGS = "-stack_size 0x10000000 -stack_addr 0xc0000000"; } ;
+        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; NIX_LDFLAGS = "-stack_size 0x10000000"; } ;
 
       /**
        * On MinGW we don't have Stratego/XT, so we cannot run a check.


From R.B.Vermaas at tudelft.nl  Fri Sep  3 13:56:47 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 03 Sep 2010 11:56:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21212 -
	hydra/strategoxt
Message-ID: <201009031156.o83BulgH018224@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Fri Sep  3 11:56:46 2010
New Revision: 21212
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21212&sc=1

Log:


Modified:
   hydra/strategoxt/packages.nix

Modified: hydra/strategoxt/packages.nix
==============================================================================
--- hydra/strategoxt/packages.nix	Fri Sep  3 11:54:40 2010	(r21211)
+++ hydra/strategoxt/packages.nix	Fri Sep  3 11:56:46 2010	(r21212)
@@ -697,7 +697,7 @@
        */
       customEnv =
         pkgs.lib.optionalAttrs ( (isMinGW pkgs) || (isCygwin pkgs) ) { CFLAGS = "-O2 -Wl,--stack=0x2300000";} 
-        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; NIX_LDFLAGS = "-stack_size 0x10000000"; } ;
+        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; NIX_CFLAGS_COMPILE = "-Wl,-stack_size,0x10000000"; } ;
 
       /**
        * On MinGW we don't have Stratego/XT, so we cannot run a check.


From R.B.Vermaas at tudelft.nl  Fri Sep  3 14:18:14 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 03 Sep 2010 12:18:14 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21213 -
	hydra/strategoxt
Message-ID: <201009031218.o83CIEBj018708@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Fri Sep  3 12:18:13 2010
New Revision: 21213
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21213&sc=1

Log:
disable check on 64 bit darwin for now

Modified:
   hydra/strategoxt/packages.nix

Modified: hydra/strategoxt/packages.nix
==============================================================================
--- hydra/strategoxt/packages.nix	Fri Sep  3 11:56:46 2010	(r21212)
+++ hydra/strategoxt/packages.nix	Fri Sep  3 12:18:13 2010	(r21213)
@@ -696,13 +696,12 @@
        * On Cygwin using -g prints a lot warnings (STR-556)
        */
       customEnv =
-        pkgs.lib.optionalAttrs ( (isMinGW pkgs) || (isCygwin pkgs) ) { CFLAGS = "-O2 -Wl,--stack=0x2300000";} 
-        // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "x86_64-darwin") { preConfigure = "ulimit -s 64000"; NIX_CFLAGS_COMPILE = "-Wl,-stack_size,0x10000000"; } ;
+        pkgs.lib.optionalAttrs ( (isMinGW pkgs) || (isCygwin pkgs) ) { CFLAGS = "-O2 -Wl,--stack=0x2300000";} ;
 
       /**
        * On MinGW we don't have Stratego/XT, so we cannot run a check.
        */
-      checkSupported = !(isMinGW pkgs);
+      checkSupported = !(isMinGW pkgs || pkgs.stdenv.system == "x86_64-darwin") ;
 
       makeDistRequiresInstall = true;
       rpmBuildSupported = true;


From L.C.L.Kats at tudelft.nl  Mon Sep  6 11:40:07 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 06 Sep 2010 09:40:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21214 -
	spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building
Message-ID: <201009060940.o869e7Il006117@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep  6 09:40:06 2010
New Revision: 21214
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21214&sc=1

Log:
Show error message if main.esv file is missing

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/AntDescriptorBuilder.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/AntDescriptorBuilder.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/AntDescriptorBuilder.java	Fri Sep  3 12:18:13 2010	(r21213)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/AntDescriptorBuilder.java	Mon Sep  6 09:40:06 2010	(r21214)
@@ -1,8 +1,9 @@
 package org.strategoxt.imp.metatooling.building;
 
-import static org.strategoxt.imp.metatooling.loading.DynamicDescriptorLoader.*;
+import static org.strategoxt.imp.metatooling.loading.DynamicDescriptorLoader.getSourceDescriptor;
 
 import java.io.File;
+import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.net.URI;
 
@@ -36,9 +37,16 @@
 				String descriptor = args[0];
 				
 				IResource source = getResource(getSourceDescriptor(descriptor));
+				if (!source.exists()) {
+					Environment.logException("Could not find source descriptor:" + source, new FileNotFoundException(source.getFullPath().toOSString()));
+					System.err.println("Build failed: could not find source descriptor " + source);
+					System.exit(1);
+				}
 				boolean success = builder.updateResource(source, new NullProgressMonitor());
-				if (!success)
+				if (!success) {
+					System.err.println("Build failed; see error log.");
 					System.exit(1);
+				}
 			} finally {
 				active = false;
 			}


From L.C.L.Kats at tudelft.nl  Mon Sep  6 15:53:13 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 06 Sep 2010 13:53:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21215 -
	sglr-recovery/trunk/permissive-grammars/trans/make-permissive
	spoofax-imp/trunk/org.strategoxt.imp.generator/lib
Message-ID: <201009061353.o86DrDdI010467@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep  6 13:53:13 2010
New Revision: 21215
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21215&sc=1

Log:
Spoofax/244: Error recovery failure

Modified:
   sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr
   spoofax-imp/trunk/org.strategoxt.imp.generator/lib/make_permissive.jar

Modified: sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr
==============================================================================
--- sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr	Mon Sep  6 09:40:06 2010	(r21214)
+++ sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr	Mon Sep  6 13:53:13 2010	(r21215)
@@ -15,10 +15,9 @@
        
        lexical syntax
          ~%% Water-based recovery rule set-up
-         [A-Za-z0-9\_]                  -> WATERTOKENSTART {recover}
-         WATERTOKENSTART [A-Za-z0-9\_]* -> WATERTOKEN
-         ~[A-Za-z0-9\_\ \t\12\r\n\*]    -> WATERTOKENSEPARATOR {recover}
-         "*"                            -> WATERTOKENSTAR {recover}
+         [A-Za-z0-9\_]+                 -> WATERTOKEN          {recover, avoid}
+         ~[A-Za-z0-9\_\ \t\12\r\n\*]    -> WATERTOKENSEPARATOR {recover, avoid}
+         "*"                            -> WATERTOKENSTAR      {recover, avoid}
          WATERTOKEN                     -> WATER
          WATERTOKENSEPARATOR            -> WATER
          WATERTOKENSTAR                 -> WATER

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/lib/make_permissive.jar
==============================================================================
Binary file (source and/or target). No diff available.


From L.C.L.Kats at tudelft.nl  Mon Sep  6 16:15:54 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 06 Sep 2010 14:15:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21216 - in
	spoofax-imp/trunk: org.strategoxt.imp.editors.aster
	org.strategoxt.imp.editors.aterm
	org.strategoxt.imp.editors.editorservice
	org.strategoxt.imp.editors.pp org....
Message-ID: <201009061415.o86EFsnu011040@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep  6 14:15:54 2010
New Revision: 21216
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21216&sc=1

Log:
Fixed strange build file regression/reset.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml   (contents, props changed)
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml   (contents, props changed)
   spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml   (contents, props changed)
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml   (contents, props changed)

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml	Mon Sep  6 13:53:13 2010	(r21215)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aster/build.main.xml	Mon Sep  6 14:15:54 2010	(r21216)
@@ -4,7 +4,6 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="Stratego-Attributes"/>
-        <property name="metasdfmodule" value="Stratego-Stratego-Attributes"/>
         <property name="esvmodule" value="Stratego-Attributes"/>
         <property name="strmodule" value="stratego_attributes"/>
     
@@ -19,17 +18,13 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="
-                        --library
-                        -I &quot;${trans}&quot;
-                        -I &quot;${basedir}&quot;
+        <property name="build.stratego.args" value="--library
+                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <!-- External .def and .jar locations
         <property name="externaldef" location="syntax/${sdfmodule}.def"/>
-        <property name="externaljar" value="../lib.jar"/>
-        <property name="externaljarflags" value="-la org.lib"/>
-        -->
+        <property name="externaljar" value="utils/aster.jar"/>
+        <property name="externaljarflags" value="-la org.strategoxt.aster"/>
     
         <!-- Environment configuration for command-line builds -->
         <condition property="build.strategoxt.sdf" value="${eclipse.spoofaximp.nativeprefix}" else="">
@@ -40,5 +35,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
-    </project>
\ No newline at end of file
+        <target name="all" depends="spoofaximp.default"/>
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml	Mon Sep  6 13:53:13 2010	(r21215)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.main.xml	Mon Sep  6 14:15:54 2010	(r21216)
@@ -4,7 +4,6 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="ATerm"/>
-        <property name="metasdfmodule" value="Stratego-ATerm"/>
         <property name="esvmodule" value="ATerm"/>
         <property name="strmodule" value="aterm"/>
     
@@ -19,14 +18,12 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="
-                        --library
-                        -I &quot;${trans}&quot;
-                        -I &quot;${basedir}&quot;
+        <property name="build.stratego.args" value="--library
+                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
+        <property name="externaldef" location="syntax/ATerm.def"/>
         <!-- External .def and .jar locations
-        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -40,5 +37,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
-    </project>
\ No newline at end of file
+        <target name="all" depends="utils-files,sdf2table,stratego.ctree,sdf2imp"/>
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml	Mon Sep  6 13:53:13 2010	(r21215)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.main.xml	Mon Sep  6 14:15:54 2010	(r21216)
@@ -4,7 +4,6 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="EditorService"/>
-        <property name="metasdfmodule" value="Stratego-EditorService"/>
         <property name="esvmodule" value="EditorService"/>
         <property name="strmodule" value="editorservice"/>
     
@@ -19,14 +18,13 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="
-                        --library
-                        -I &quot;${trans}&quot;
-                        -I &quot;${basedir}&quot;
-                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
+        <property name="build.stratego.args" value="--library
+                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm
+                        -la stratego-sdf"/>
         
+        <property name="externaldef" location="../org.strategoxt.imp.generator/src/syntax/EditorService.def"/>
         <!-- External .def and .jar locations
-        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -40,5 +38,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
-    </project>
\ No newline at end of file
+        <target name="all" depends="spoofaximp.default.jar"/>
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml	Mon Sep  6 13:53:13 2010	(r21215)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.pp/build.main.xml	Mon Sep  6 14:15:54 2010	(r21216)
@@ -4,7 +4,6 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="BoxPP"/>
-        <property name="metasdfmodule" value="Stratego-BoxPP"/>
         <property name="esvmodule" value="BoxPP"/>
         <property name="strmodule" value="boxpp"/>
     
@@ -19,14 +18,13 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="
-                        --library
-                        -I &quot;${trans}&quot;
-                        -I &quot;${basedir}&quot;
+        <property name="build.stratego.args" value="--library
+                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
                         -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
-        <!-- External .def and .jar locations
         <property name="externaldef" location="syntax/${sdfmodule}.def"/>
+        
+        <!-- External .def and .jar locations
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -40,5 +38,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
-    </project>
\ No newline at end of file
+        <target name="all" depends="spoofaximp.default"/>
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	Mon Sep  6 13:53:13 2010	(r21215)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	Mon Sep  6 14:15:54 2010	(r21216)
@@ -4,7 +4,6 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="SDF"/>
-        <property name="metasdfmodule" value="Stratego-SDF"/>
         <property name="esvmodule" value="SDF"/>
         <property name="strmodule" value="sdf"/>
     
@@ -19,14 +18,13 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="
-                        --library
-                        -I &quot;${trans}&quot;
-                        -I &quot;${basedir}&quot;
-                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
+        <property name="build.stratego.args" value="--library
+                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
+                        -la strc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm
+                        -la stratego-sdf"/>
         
+        <property name="externaldef" location="syntax/SDF.def"/>
         <!-- External .def and .jar locations
-        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -40,5 +38,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
-    </project>
\ No newline at end of file
+        <target name="all" depends="sdf2table,stratego.jar,sdf2imp,refresh"/>
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml	Mon Sep  6 13:53:13 2010	(r21215)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.main.xml	Mon Sep  6 14:15:54 2010	(r21216)
@@ -4,7 +4,6 @@
         
         <!-- Key input modules -->
         <property name="sdfmodule" value="Stratego-Sugar"/>
-        <property name="metasdfmodule" value="Stratego-Stratego-Sugar"/>
         <property name="esvmodule" value="Stratego-Sugar"/>
         <property name="strmodule" value="stratego_sugar"/>
     
@@ -19,14 +18,12 @@
         
         <!-- Imports -->
         <property name="build.sdf.imports" value=""/>
-        <property name="build.stratego.args" value="
-                        --library
-                        -I &quot;${trans}&quot;
-                        -I &quot;${basedir}&quot;
-                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
+        <property name="build.stratego.args" value="--library
+                        -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm -la strc"/>
         
+        <property name="externaldef" location="syntax/Stratego-Sugar.def"/>
         <!-- External .def and .jar locations
-        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
@@ -40,5 +37,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
-    </project>
\ No newline at end of file
+        <target name="all" depends="utils-files,sdf2table,ppgen.helper.fallback,pppack.helper.fallback,stratego.jar,sdf2imp"/>
+    </project>


From L.C.L.Kats at tudelft.nl  Mon Sep  6 16:16:25 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 06 Sep 2010 14:16:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21217 -
	sglr-recovery/trunk/permissive-grammars/trans/make-permissive
	spoofax-imp/trunk/org.strategoxt.imp.generator/lib
Message-ID: <201009061416.o86EGPH6011048@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep  6 14:16:24 2010
New Revision: 21217
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21217&sc=1

Log:
Added the 2-line hack again per Maartje's recommendation

Modified:
   sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr
   spoofax-imp/trunk/org.strategoxt.imp.generator/lib/make_permissive.jar

Modified: sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr
==============================================================================
--- sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr	Mon Sep  6 14:15:54 2010	(r21216)
+++ sglr-recovery/trunk/permissive-grammars/trans/make-permissive/water-sections.astr	Mon Sep  6 14:16:24 2010	(r21217)
@@ -15,7 +15,8 @@
        
        lexical syntax
          ~%% Water-based recovery rule set-up
-         [A-Za-z0-9\_]+                 -> WATERTOKEN          {recover, avoid}
+         [A-Za-z0-9\_]                  -> WATERTOKENSTART     {recover, avoid}
+         WATERTOKENSTART [A-Za-z0-9\_]* -> WATERTOKEN
          ~[A-Za-z0-9\_\ \t\12\r\n\*]    -> WATERTOKENSEPARATOR {recover, avoid}
          "*"                            -> WATERTOKENSTAR      {recover, avoid}
          WATERTOKEN                     -> WATER

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/lib/make_permissive.jar
==============================================================================
Binary file (source and/or target). No diff available.


From L.C.L.Kats at tudelft.nl  Mon Sep  6 16:18:19 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 06 Sep 2010 14:18:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21218 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009061418.o86EIJ7U011063@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep  6 14:18:19 2010
New Revision: 21218
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21218&sc=1

Log:


Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	Mon Sep  6 14:16:24 2010	(r21217)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	Mon Sep  6 14:18:19 2010	(r21218)
@@ -165,9 +165,14 @@
 	private void printCompletionTip(IParseController controller, Set<String> sorts) {
 		if (Environment.getDescriptor(controller.getLanguage()).isDynamicallyLoaded()) {
 			try {
+				String parseErrorHelp = currentCompletionNode != null
+					&& currentCompletionNode.getConstructor() == COMPLETION_UNKNOWN
+					? "\n   (context could not be parsed with this grammar; consider experimenting\n   with additional productions for this partial construct, possibly\n   marked with a {recover} annotation.)"
+					: "";
 				StrategoConsole.getOutputWriter().write(
 					":: Completion triggered for: " + currentCompletionNode
-					+ " (candidate sorts: " + sorts + ")\n");
+					+ parseErrorHelp
+					+ " (candidate sorts: " + sorts + ")" + "\n");
 				StrategoConsole.activateConsole(true);
 			} catch (IOException e) {
 				Environment.logWarning("Could not write to console", e);


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:20:45 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:20:45 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21219 -
	tiger-spoofax/editor
Message-ID: <201009080720.o887KjE4015389@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:20:44 2010
New Revision: 21219
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21219&sc=1

Log:
include types in outline

Modified:
   tiger-spoofax/editor/Tiger-Outliner.esv

Modified: tiger-spoofax/editor/Tiger-Outliner.esv
==============================================================================
--- tiger-spoofax/editor/Tiger-Outliner.esv	Mon Sep  6 14:18:19 2010	(r21218)
+++ tiger-spoofax/editor/Tiger-Outliner.esv	Wed Sep  8 07:20:44 2010	(r21219)
@@ -8,4 +8,5 @@
 	Dec
 	Field
 	FArg
+	TypeId
 	
\ No newline at end of file


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:22:34 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:22:34 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21220 -
	tiger-spoofax/trans/editor
Message-ID: <201009080722.o887MY91015435@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:22:33 2010
New Revision: 21220
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21220&sc=1

Log:
no debugging

Modified:
   tiger-spoofax/trans/editor/resolve.str

Modified: tiger-spoofax/trans/editor/resolve.str
==============================================================================
--- tiger-spoofax/trans/editor/resolve.str	Wed Sep  8 07:20:44 2010	(r21219)
+++ tiger-spoofax/trans/editor/resolve.str	Wed Sep  8 07:22:33 2010	(r21220)
@@ -17,7 +17,7 @@
 rules
 
 	editor-resolve: (node, position, ast, path, project-path) -> elem
-		where <debug> ast ; <debug> node
+		//where <debug> ast ; <debug> node
 		where 
 			<resolve> node => elem
 		
@@ -28,9 +28,9 @@
 
 rules
 	
-	resolve : Tid(t) 	 -> <project-declaration(type-name)> (Types(), t)  where <debug> (t, t)
+	resolve : Tid(t) 	 -> <project-declaration(type-name)> (Types(), t)  //where <debug> (t, t)
 	resolve : Var(x) 	 -> <project-declaration(var-name)> (Vars(), x)  
-	resolve : Call(f, _) -> <project-declaration(fun-name)> (Vars(), f)  where <debug> (f, f)
+	resolve : Call(f, _) -> <project-declaration(fun-name)> (Vars(), f)  //where <debug> (f, f)
 
 	resolve : 
 		FieldVar(e, f) -> fdef


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:31:49 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:31:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21221 -
	tiger-spoofax/test
Message-ID: <201009080731.o887VnSH015534@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:31:49 2010
New Revision: 21221
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21221&sc=1

Log:
example from the lecture

Added:
   tiger-spoofax/test/lecture.tig

Added: tiger-spoofax/test/lecture.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/test/lecture.tig	Wed Sep  8 07:31:49 2010	(r21221)
@@ -0,0 +1,12 @@
+/* factorial function */
+
+let 
+	var x : int := 0
+	
+	function fact(n : int) : int = 
+		if n < 1 then 1 else (n * fact(n - 1))
+
+in 
+   x := fact(5) ;
+   printint(x) ;
+end
\ No newline at end of file


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:33:47 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:33:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21222 -
	tiger-spoofax/test
Message-ID: <201009080733.o887XlMs015548@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:33:47 2010
New Revision: 21222
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21222&sc=1

Log:


Modified:
   tiger-spoofax/test/lecture.tig

Modified: tiger-spoofax/test/lecture.tig
==============================================================================
--- tiger-spoofax/test/lecture.tig	Wed Sep  8 07:31:49 2010	(r21221)
+++ tiger-spoofax/test/lecture.tig	Wed Sep  8 07:33:47 2010	(r21222)
@@ -8,5 +8,5 @@
 
 in 
    x := fact(5) ;
-   printint(x) ;
+   printint(x) 
 end
\ No newline at end of file


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:34:22 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:34:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21223 - in
	tiger-spoofax: editor trans trans/generation
Message-ID: <201009080734.o887YMbW015561@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:34:22 2010
New Revision: 21223
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21223&sc=1

Log:
JBC generation

Modified:
   tiger-spoofax/editor/Tiger-Builders.esv
   tiger-spoofax/trans/generation/generate.str
   tiger-spoofax/trans/tiger.str

Modified: tiger-spoofax/editor/Tiger-Builders.esv
==============================================================================
--- tiger-spoofax/editor/Tiger-Builders.esv	Wed Sep  8 07:33:47 2010	(r21222)
+++ tiger-spoofax/editor/Tiger-Builders.esv	Wed Sep  8 07:34:22 2010	(r21223)
@@ -11,12 +11,11 @@
 
 builders
                                                                                                                
-	provider                  : include/tiger.ctree                                                              
+	provider	: include/tiger.ctree                                                              
                                                                                                                
-	observer                  : editor-analyse                                                                   
-                                                                                                               
-	builder                   : "Show abstract syntax" = generate-aterm (openeditor) (realtime) (meta) (source)  
-	builder                   : "Show renamed AST" = rename-aterm (openeditor) (realtime) (meta) 
-    builder                   : "Show desugared AST" = desugar-aterm (openeditor) (realtime) (meta) 
-                                                                                                               
-  
\ No newline at end of file
+	observer	: editor-analyse                                                                   
+ 	
+	builder		: "Generate JBC" = generate-jbc (openeditor) (realtime)              
+	builder		: "Show abstract syntax" = generate-aterm (openeditor) (realtime) (meta) (source)  
+    builder		: "Show desugared AST" = desugar-aterm (openeditor) (realtime) (meta) 
+	builder		: "Show renamed AST" = rename-aterm (openeditor) (realtime) (meta)                                                                                                                

Modified: tiger-spoofax/trans/generation/generate.str
==============================================================================
--- tiger-spoofax/trans/generation/generate.str	Wed Sep  8 07:33:47 2010	(r21222)
+++ tiger-spoofax/trans/generation/generate.str	Wed Sep  8 07:34:22 2010	(r21223)
@@ -4,35 +4,56 @@
 	include/Tiger
 	lib/JavaBytecode
 	
-	analysis/types/desugar-ops
+	analysis/main
+	analysis/types/operators
 	analysis/types/types
 	analysis/types/project
 	
 rules
 	
+	// Prints the desugared abstract syntax ATerm of a selection.
+	generate-jbc:
+		(selected, position, ast, path, project-path) -> (filename, result)
+		where
+			<guarantee-extension(|"jbc")> path => filename ;
+			<desugar-all ; to-jbc ; flatten-list ; pp-jbc <+ !""> selected => result
+
 	to-jbc:	Int(i) -> LDC(Int(i)) 
 	
 	to-jbc: Bop(op, e1, e2) -> [ <to-jbc> e1, <to-jbc> e2, <to-jbc> op ]
-	to-jbc: Rop(op, e1, e2) -> [ <to-jbc> e1, <to-jbc> e2, <to-jbc> op ]
 	
 	to-jbc: PLUS() 	-> IADD()
 	to-jbc: MINUS()	-> ISUB()
 	to-jbc: MUL() 	-> IMUL()
 	to-jbc: DIV()	-> IDIV()
 	
-	to-jbc:
-		Lt(e1, e2) -> [ <to-jbc> e1, 
-						<to-jbc> e2, 
-						IF_ICMPGE(LabelRef(l1)), 
-						ICONST_1(), 
-						GOTO(LabelRef(l2)),
-						Label(l1),
-						ICONST_0(),
-						Label(l2) ]
+	to-jbc: 
+		Rop(op, e1, e2)    -> [ <to-jbc> e1, 
+							 	<to-jbc> e2, 
+								cmp, 
+								ICONST_1(), 
+								GOTO(LabelRef(l2)),
+								Label(l1),
+								ICONST_0(),
+								Label(l2) ]
 		where
-			<type-of> e1 => INT() ;
-			<type-of> e2 => INT() ;
 			<newname> "label" => l1 ;
-			<newname> "label" => l2
-	
+			<newname> "label" => l2 ;
+			<eq-or-nil> (<type-of> e1, <type-of> e2) => t; 
+			<to-jbc(|l1)> (t, op) => cmp 
+	
+	to-jbc(|l): (INT(), EQ()) -> IF_ICMPEQ(LabelRef(l))
+	to-jbc(|l): (INT(), NE()) -> IF_ICMPNE(LabelRef(l))
+	to-jbc(|l): (INT(), LT()) -> IF_ICMPLT(LabelRef(l))
+	to-jbc(|l): (INT(), LE()) -> IF_ICMPLE(LabelRef(l))
+	
+	pp-jbc: [] 			-> $[]
+	pp-jbc: [i|is] 		-> $[[<pp-jbc> i]
+							 [<pp-jbc> is]]
+	
+	pp-jbc: LDC(Int(i)) -> $[ldc [i]]
+	pp-jbc: IADD() 		-> $[iadd]
+	pp-jbc: ISUB() 		-> $[isub]
+	pp-jbc: IMUL() 		-> $[imul]
+	pp-jbc: IDIV() 		-> $[idiv]
 	
\ No newline at end of file

Modified: tiger-spoofax/trans/tiger.str
==============================================================================
--- tiger-spoofax/trans/tiger.str	Wed Sep  8 07:33:47 2010	(r21222)
+++ tiger-spoofax/trans/tiger.str	Wed Sep  8 07:34:22 2010	(r21223)
@@ -12,6 +12,7 @@
 	editor/resolve
 	editor/hover
 	editor/complete
+	generation/generate
 	
 rules // Main editor interface (defined by editor/Tiger-Builders and -References.esv)
   


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:36:19 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:36:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21224 -
	tiger-spoofax/editor
Message-ID: <201009080736.o887aJ7V015582@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:36:18 2010
New Revision: 21224
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21224&sc=1

Log:
ignore generated files

Modified:
   tiger-spoofax/editor/   (props changed)


From g.h.wachsmuth at tudelft.nl  Wed Sep  8 09:38:17 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 08 Sep 2010 07:38:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21225 - in
	tiger-spoofax: . META-INF
Message-ID: <201009080738.o887cH7g015602@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed Sep  8 07:38:17 2010
New Revision: 21225
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21225&sc=1

Log:
renamed project

Modified:
   tiger-spoofax/.project
   tiger-spoofax/META-INF/MANIFEST.MF

Modified: tiger-spoofax/.project
==============================================================================
--- tiger-spoofax/.project	Wed Sep  8 07:36:18 2010	(r21224)
+++ tiger-spoofax/.project	Wed Sep  8 07:38:17 2010	(r21225)
@@ -1,9 +1,10 @@
-<?xml version="1.0" encoding="UTF-8" ?>
-
+<?xml version="1.0" encoding="UTF-8"?>
 <projectDescription>
-      <name>org.strategoxt.spoofax.tiger</name>
-      <comment></comment>
-      <buildSpec>
+	<name>Tiger</name>
+	<comment></comment>
+	<projects>
+	</projects>
+	<buildSpec>
 		<buildCommand>
 			<name>org.eclipse.ui.externaltools.ExternalToolBuilder</name>
 			<triggers>full,incremental,</triggers>
@@ -14,24 +15,24 @@
 				</dictionary>
 			</arguments>
 		</buildCommand>
-        <buildCommand>
-          <name>org.eclipse.jdt.core.javabuilder</name>
-          <arguments>
-          </arguments>
-        </buildCommand>
-        <buildCommand>
-          <name>org.eclipse.pde.ManifestBuilder</name>
-          <arguments>
-          </arguments>
-        </buildCommand>
-        <buildCommand>
-          <name>org.eclipse.pde.SchemaBuilder</name>
-          <arguments>
-          </arguments>
-        </buildCommand>
-      </buildSpec>
-      <natures>
-        <nature>org.eclipse.pde.PluginNature</nature>
-        <nature>org.eclipse.jdt.core.javanature</nature>
-      </natures>
-    </projectDescription>
\ No newline at end of file
+		<buildCommand>
+			<name>org.eclipse.jdt.core.javabuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+		<buildCommand>
+			<name>org.eclipse.pde.ManifestBuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+		<buildCommand>
+			<name>org.eclipse.pde.SchemaBuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+	</buildSpec>
+	<natures>
+		<nature>org.eclipse.pde.PluginNature</nature>
+		<nature>org.eclipse.jdt.core.javanature</nature>
+	</natures>
+</projectDescription>

Modified: tiger-spoofax/META-INF/MANIFEST.MF
==============================================================================
--- tiger-spoofax/META-INF/MANIFEST.MF	Wed Sep  8 07:36:18 2010	(r21224)
+++ tiger-spoofax/META-INF/MANIFEST.MF	Wed Sep  8 07:38:17 2010	(r21225)
@@ -1,7 +1,7 @@
 Manifest-Version: 1.0
 Bundle-ManifestVersion: 2
 Bundle-Name: Tiger Plug-in
-Bundle-SymbolicName: org.strategoxt.spoofax.tiger; singleton:=true
+Bundle-SymbolicName: Tiger;singleton:=true
 Bundle-Version: 1.0.0
 Bundle-Activator: org.strategoxt.spoofax.tiger.Activator
 Import-Package: org.osgi.framework;version="1.3.0"


From L.C.L.Kats at tudelft.nl  Wed Sep  8 12:33:35 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 08 Sep 2010 10:33:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21226 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast
Message-ID: <201009081033.o88AXZC4018308@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Wed Sep  8 10:33:34 2010
New Revision: 21226
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21226&sc=1

Log:
StrategoXT/838: Using token [] causes Internal parsing error.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixAnalyzer.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixAnalyzer.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixAnalyzer.java	Wed Sep  8 07:38:17 2010	(r21225)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixAnalyzer.java	Wed Sep  8 10:33:34 2010	(r21226)
@@ -1,9 +1,13 @@
 package org.strategoxt.imp.runtime.parser.ast;
 
 import static org.spoofax.jsglr.Term.applAt;
+import static org.spoofax.jsglr.Term.asAppl;
+import static org.spoofax.jsglr.Term.isAppl;
+import static org.spoofax.jsglr.Term.termAt;
 import static org.strategoxt.imp.runtime.Environment.getATermFactory;
 import jjtraveler.Visitable;
 import aterm.AFun;
+import aterm.ATerm;
 import aterm.ATermAppl;
 
 public class AsfixAnalyzer {
@@ -39,12 +43,14 @@
 	private static final AFun ITER_PLUS_SEP_FUN = getATermFactory().makeAFun("iter-plus-sep", 2, false);
 
 	public static boolean isLayout(ATermAppl sort) {
-		ATermAppl details = applAt(sort, 0);
+		ATerm details = termAt(sort, 0);
+		if (!isAppl(details))
+			return false;
 		
-		if (OPT_FUN == details.getAFun())
+		if (OPT_FUN == asAppl(details).getAFun())
 			details = applAt(details, 0);
 		
-		return LAYOUT_FUN == details.getAFun();
+		return LAYOUT_FUN == asAppl(details).getAFun();
 	}
 
 	public static boolean isLiteral(ATermAppl sort) {


From R.B.Vermaas at tudelft.nl  Thu Sep  9 08:13:43 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 09 Sep 2010 06:13:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21227 - hydra
Message-ID: <201009090613.o896DhBh002888@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  9 06:13:40 2010
New Revision: 21227
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21227&sc=1

Log:
build.nix: on cygwin add both bin/ and lib/ dirs of buildinputs to PATH

Modified:
   hydra/build.nix

Modified: hydra/build.nix
==============================================================================
--- hydra/build.nix	Wed Sep  8 10:33:34 2010	(r21226)
+++ hydra/build.nix	Thu Sep  9 06:13:40 2010	(r21227)
@@ -92,7 +92,7 @@
 
     } // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "i686-cygwin") 
             { preConfigure = ''
-                export PATH=$PATH:$out/bin:${pkgs.lib.concatStringsSep ":" (map (p: "${p}/bin") buildInputs)}
+                export PATH=$PATH:$out/bin:$out/lib:${pkgs.lib.concatStringsSep ":" (map (p: "${p}/bin:${p}/lib") buildInputs)}
               ''; 
             }
          );


From R.B.Vermaas at tudelft.nl  Thu Sep  9 08:35:42 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 09 Sep 2010 06:35:42 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21228 - in hydra: .
	webdsl
Message-ID: <201009090635.o896Zghc003427@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  9 06:35:42 2010
New Revision: 21228
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21228&sc=1

Log:
undo previous change

Modified:
   hydra/build.nix
   hydra/webdsl/machine.nix
   hydra/webdsl/tests.nix

Modified: hydra/build.nix
==============================================================================
--- hydra/build.nix	Thu Sep  9 06:13:40 2010	(r21227)
+++ hydra/build.nix	Thu Sep  9 06:35:42 2010	(r21228)
@@ -92,7 +92,7 @@
 
     } // pkgs.lib.optionalAttrs (pkgs.stdenv.system == "i686-cygwin") 
             { preConfigure = ''
-                export PATH=$PATH:$out/bin:$out/lib:${pkgs.lib.concatStringsSep ":" (map (p: "${p}/bin:${p}/lib") buildInputs)}
+                export PATH=$PATH:$out/bin:${pkgs.lib.concatStringsSep ":" (map (p: "${p}/bin") buildInputs)}
               ''; 
             }
          );

Modified: hydra/webdsl/machine.nix
==============================================================================
--- hydra/webdsl/machine.nix	Thu Sep  9 06:13:40 2010	(r21227)
+++ hydra/webdsl/machine.nix	Thu Sep  9 06:35:42 2010	(r21228)
@@ -1,7 +1,8 @@
 { config, pkgs, ... }:
 {
+  virtualisation.memorySize = pkgs.lib.mkOverride 150 {} 2047;
   virtualisation.diskSize = 2048;
-  environment.systemPackages = [ pkgs.firefox pkgs.ant pkgs.jdk ];
+  environment.systemPackages = [ pkgs.firefox pkgs.ant pkgs.jdk pkgs.subversion pkgs.maven2 ];
   system.copySystemConfiguration = false;
 }
 

Modified: hydra/webdsl/tests.nix
==============================================================================
--- hydra/webdsl/tests.nix	Thu Sep  9 06:13:40 2010	(r21227)
+++ hydra/webdsl/tests.nix	Thu Sep  9 06:35:42 2010	(r21228)
@@ -68,8 +68,9 @@
           name = "webdsl-webcheck-r${toString webdslSrc.rev}";
           buildInputs = [pkgs.ant pkgs.jdk pkgs.firefox webdsl];
           buildCommand = '' 
-            cp -R ${webdslSrc}/test/succeed-web succeed-web
             ensureDir $out
+exit 0
+            cp -R ${webdslSrc}/test/succeed-web succeed-web
             
             cd succeed-web
             TOPDIR=`pwd`
@@ -85,7 +86,7 @@
               webdsl test-web $FILE 2>&1 || export FAILED="1"
               stopNest
             done
-            echo "Test FAILED: $FAILED"
+
             if test -z "$FAILED"; then
               exit 0
             else


From R.B.Vermaas at tudelft.nl  Thu Sep  9 08:38:24 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 09 Sep 2010 06:38:24 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21229 - hydra/webdsl
Message-ID: <201009090638.o896cOBZ003457@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Thu Sep  9 06:38:24 2010
New Revision: 21229
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21229&sc=1

Log:
grmbl, committed too much in last commit

Modified:
   hydra/webdsl/tests.nix

Modified: hydra/webdsl/tests.nix
==============================================================================
--- hydra/webdsl/tests.nix	Thu Sep  9 06:35:42 2010	(r21228)
+++ hydra/webdsl/tests.nix	Thu Sep  9 06:38:24 2010	(r21229)
@@ -69,7 +69,6 @@
           buildInputs = [pkgs.ant pkgs.jdk pkgs.firefox webdsl];
           buildCommand = '' 
             ensureDir $out
-exit 0
             cp -R ${webdslSrc}/test/succeed-web succeed-web
             
             cd succeed-web


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:44:40 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:44:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21230 -
	tiger-spoofax/lib
Message-ID: <201009110844.o8B8ie6A014358@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:44:39 2010
New Revision: 21230
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21230&sc=1

Log:


Modified:
   tiger-spoofax/lib/editor-common.generated.str

Modified: tiger-spoofax/lib/editor-common.generated.str
==============================================================================
--- tiger-spoofax/lib/editor-common.generated.str	Thu Sep  9 06:38:24 2010	(r21229)
+++ tiger-spoofax/lib/editor-common.generated.str	Sat Sep 11 08:44:39 2010	(r21230)
@@ -98,6 +98,8 @@
       cache-path   := $[[cache-dir]/[full-path'].sig]
 
   project-path = prim("SSL_EXT_projectpath")
+  
+  plugin-path = prim("SSL_EXT_pluginpath")
 
   is-newer:
     (file1, file2) -> <id>
@@ -113,6 +115,9 @@
   
   refresh-workspace-file:
     path -> <prim("SSL_EXT_refreshresource", path)>
+  
+  string-starts-with-capital =
+    explode-string; Hd; is-upper
 
 strategies
   


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:45:17 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:45:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21231 -
	tiger-spoofax/syntax
Message-ID: <201009110845.o8B8jHAi014376@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:45:17 2010
New Revision: 21231
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21231&sc=1

Log:
added missing import

Modified:
   tiger-spoofax/syntax/Tiger-Expressions.sdf

Modified: tiger-spoofax/syntax/Tiger-Expressions.sdf
==============================================================================
--- tiger-spoofax/syntax/Tiger-Expressions.sdf	Sat Sep 11 08:44:39 2010	(r21230)
+++ tiger-spoofax/syntax/Tiger-Expressions.sdf	Sat Sep 11 08:45:17 2010	(r21231)
@@ -3,6 +3,7 @@
 imports 
 	lexical/Tiger-Constants
 	lexical/Tiger-Identifiers 
+	Tiger-Declarations
 	
 exports
 	sorts LValue Exp


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:45:49 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:45:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21232 -
	tiger-spoofax/syntax/lexical
Message-ID: <201009110845.o8B8jnZX014387@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:45:49 2010
New Revision: 21232
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21232&sc=1

Log:
bug fix: slashes in nested comments

Modified:
   tiger-spoofax/syntax/lexical/Tiger-Comments.sdf

Modified: tiger-spoofax/syntax/lexical/Tiger-Comments.sdf
==============================================================================
--- tiger-spoofax/syntax/lexical/Tiger-Comments.sdf	Sat Sep 11 08:45:17 2010	(r21231)
+++ tiger-spoofax/syntax/lexical/Tiger-Comments.sdf	Sat Sep 11 08:45:49 2010	(r21232)
@@ -10,7 +10,7 @@
     	Asterisk			-> CommChar
     	Slash				-> CommChar
     	[\*]				-> Asterisk
-		[\/]				-> Asterisk
+		[\/]				-> Slash
 
 	lexical syntax
 		


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:48:05 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:48:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21233 - in
	tiger-spoofax/trans: . analysis analysis/names
	analysis/normal analysis/types generation
Message-ID: <201009110848.o8B8m5Qi014416@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:48:05 2010
New Revision: 21233
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21233&sc=1

Log:
restructuring: put normalisation transformations in own directory
declaration grouping now in desugaring phase

Added:
   tiger-spoofax/trans/analysis/normal/
   tiger-spoofax/trans/analysis/normal/desugar.str
   tiger-spoofax/trans/analysis/normal/signature.str
Modified:
   tiger-spoofax/trans/analysis/main.str
   tiger-spoofax/trans/analysis/names/rename.str
   tiger-spoofax/trans/analysis/types/check.str
   tiger-spoofax/trans/analysis/types/project.str
   tiger-spoofax/trans/generation/generate.str
   tiger-spoofax/trans/tiger.str

Modified: tiger-spoofax/trans/analysis/main.str
==============================================================================
--- tiger-spoofax/trans/analysis/main.str	Sat Sep 11 08:45:49 2010	(r21232)
+++ tiger-spoofax/trans/analysis/main.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -1,21 +1,21 @@
 module analysis/main
 
 imports
-	libstratego-lib
 	lib/editor-common.generated
 
 imports	
+	include/Tiger
+	
 	analysis/names/rename
 	analysis/names/map
 	analysis/names/check
 	
-	analysis/types/desugar
+	analysis/normal/desugar
+	
 	analysis/types/check
 		
 strategies
 
-	desugar-all = topdown(repeat(desugar))	
-			
 	analyse = desugar-all ; rename-all ; store-all
 
 rules
@@ -28,3 +28,4 @@
 			<collect-all(editor-error, conc)> ast' 		=> errors;
 			<collect-all(editor-warning, conc)> ast' 	=> warnings;
 			<collect-all(fail, conc)> ast'				=> notes
+		
\ No newline at end of file

Modified: tiger-spoofax/trans/analysis/names/rename.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/rename.str	Sat Sep 11 08:45:49 2010	(r21232)
+++ tiger-spoofax/trans/analysis/names/rename.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -6,6 +6,7 @@
 
 imports
 	include/Tiger 
+	analysis/normal/signature
 
 imports
 	analysis/names/namespaces
@@ -18,59 +19,66 @@
 
 rules
 	
-	rename-decl-groups : 
-		([g|gs], es) -> ([g'|gs'], es')
+	rename-decs :
+		([], es) -> ([], <rename-all> es) 
+
+	rename-decs : 
+		([d|ds], es) -> ([d'|ds'], es')
 		where
 			new-scope(
-				<rename-decl-group> g => g' ;
-				<rename-decl-groups> (gs, es) => (gs', es') 
+				<rename-dec> d => d' ;
+				<rename-decs> (ds, es) => (ds', es') 
 			)
 			
-	rename-decl-groups :
-		([], es) -> ([], <rename-all> es) 
-rules
-	
-	rename-decl-group :
-		ds@[_|_] ->  <rename-all> <map(rename-decl-group)> ds
+rules // let declarations
 	
-rules // type declarations
+	rename-dec :
+		DecGroup(decs) ->  <rename-all> <map(rename-dec)> decs
 
-	rename-decl-group :
+	rename-dec :
 		TypeDec(x, t) -> TypeDec(y, t)
 		where 
 			<rename-declaration> (Types(), x) => y 
 
-	rename :	
-		Tid(x) -> Tid(y) 
-		where 	
-			<rename-reference> (Types(), x) => y 
-
-rules // variables and their declarations
-			 
-	rename-decl-group :
+	rename-dec :
     	VarDec(x, t, e) -> VarDec(y, t', e')
     	where 
     		<rename-all> t => t';
     		<rename-all> e => e';
     		<rename-declaration> (Vars(), x) => y
     		
-	rename-decl-group :
+	rename-dec :
     	VarDec(x, t) -> VarDec(y, t')
     	where 
     		<rename-all> t => t' ;
     		<rename-declaration> (Vars(), x) => y 
 
-	rename:	
-		Var(x) -> Var(y) 
-		where 	
-			<rename-reference> (Vars(), x) => y  
+	rename-dec :
+		FunDec(f, as, t, e) -> FunDec(g, as, t, e)
+    	where 
+    		<rename-declaration> (Vars(), f) => g 
+
+	rename-dec :
+		FunDec(f, as, e) -> FunDec(g, as, e)
+    	where 
+    		<rename-declaration> (Vars(), f) => g 
 
-	rename:
-		Let(ds, es) -> Let(ds', es')
+rules
+
+	rename : 
+		Tid(x) -> Tid(y) 
 		where
-			<group-decls> ds => gs ;
-			<rename-decl-groups> (gs, es) => (gs', es') ;
-			<flatten-list> gs' => ds'
+			<rename-reference> (Types(), x) => y 
+
+	rename : 
+		Var(x) -> Var(y)
+		where
+			<rename-reference> (Vars(), x) => y  
+
+	rename : 
+		Let(ds, es) -> Let(ds', es') 
+		where 
+			<rename-decs> (ds, es) => (ds', es')
 
 	rename :
 		For(x, e1, e2, e3) -> For(y, e1', e2', e3')
@@ -82,18 +90,6 @@
 				<rename-all> e3 => e3'
 			)
 
-rules // functions
-    		
-	rename-decl-group :
-		FunDec(f, as, t, e) -> FunDec(g, as, t, e)
-    	where 
-    		<rename-declaration> (Vars(), f) => g 
-
-	rename-decl-group :
-		FunDec(f, as, e) -> FunDec(g, as, e)
-    	where 
-    		<rename-declaration> (Vars(), f) => g 
-    			
 	rename :
 		FunDec(f, as, t, e) -> FunDec(f, as', t', e')
     	where 
@@ -123,41 +119,4 @@
 			<rename-all> es => es' ;
 			<rename-reference> (Vars(), f) => g
     		
-rules
-	
-	group-decls :
-		[] -> []
-		
-	group-decls :
-		[d at VarDec(_, _) | ds] -> [d | <group-decls> ds]
-	
-	group-decls :
-		[d at VarDec(_, _, _) | ds] -> [d | <group-decls> ds]
-		
-	group-decls :
-		[d at TypeDec(_, _) | ds] -> r
-		where
-			(
-				<split-fetch-keep(not(?TypeDec(_, _)))> [d | ds] => (tds, rd, rds) ;
-				![tds | <group-decls> [rd | rds]] => r
-			) <+ 
-			![[d | ds]] => r
-			
-	group-decls :
-		[d at FunDec(_, _, _) | ds] -> r
-		where
-			(
-				<split-fetch-keep(not(?FunDec(_, _, _) <+ ?FunDec(_, _, _, _)))> [d | ds] => (tds, rd, rds) ;
-				![tds | <group-decls> [rd | rds]] => r
-			) <+ 
-			![[d | ds]] => r
-
-	group-decls :
-		[d at FunDec(_, _, _, _) | ds] -> r
-		where
-			(
-				<split-fetch-keep(not(?FunDec(_, _, _) <+ ?FunDec(_, _, _, _)))> [d | ds] => (tds, rd, rds) ;
-				![tds | <group-decls> [rd | rds]] => r
-			) <+ 
-			![[d | ds]] => r
 			 
\ No newline at end of file

Added: tiger-spoofax/trans/analysis/normal/desugar.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/trans/analysis/normal/desugar.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -0,0 +1,54 @@
+module analysis/normal/desugar
+
+imports 
+	include/Tiger
+	analysis/normal/signature
+
+strategies
+	
+	desugar-all = topdown(try(group-let-decs)) ; innermost(desugar) 
+	
+rules // operators
+
+	desugar: Uminus(e) 		-> Bop(MINUS(), Int("0"), e)
+	
+	desugar: Plus(e1, e2) 	-> Bop(PLUS(), e1, e2)
+	desugar: Minus(e1, e2) 	-> Bop(MINUS(), e1, e2)
+	desugar: Times(e1, e2) 	-> Bop(MUL(), e1, e2)
+	desugar: Divide(e1, e2)	-> Bop(DIV(), e1, e2)
+	
+	desugar: Eq(e1, e2) 	-> Rop(EQ(), e1, e2)
+	desugar: Neq(e1, e2) 	-> Rop(NE(), e1, e2)
+	desugar: Leq(e1, e2) 	-> Rop(LE(), e1, e2)
+	desugar: Lt(e1, e2) 	-> Rop(LT(), e1, e2)
+	desugar: Geq(e1, e2) 	-> Rop(LE(), e2, e1)
+	desugar: Gt(e1, e2) 	-> Rop(LT(), e2, e1)
+
+	desugar: And(e1, e2) 	-> IfThenElse(e1, e2, Int("0"))
+	desugar: Or(e1, e2) 	-> IfThenElse(e1, Int("1"), e2)
+
+rules // if
+		
+	desugar: IfThen(e1, e2) -> IfThenElse(e1, e2, NoVal())
+
+rules // declaration groups
+	
+	group-let-decs : Let(decs, exps) -> Let(<group-decs> decs, exps)
+	
+	group-decs : [] -> []
+		
+	group-decs : [d at VarDec(_, _)    | ds] -> [d | <group-decs> ds]
+	group-decs : [d at VarDec(_, _, _) | ds] -> [d | <group-decs> ds]
+	
+	group-decs : [d at TypeDec(_, _)      | ds] -> <group-decs(is-type-dec)> [d|ds]				
+	group-decs : [d at FunDec(_, _, _)    | ds] -> <group-decs(is-fun-dec)> [d|ds]
+	group-decs : [d at FunDec(_, _, _, _) | ds] -> <group-decs(is-fun-dec)> [d|ds]
+	
+strategies
+	
+	group-decs(s) = 
+		split-fetch-keep(not(s)) => (gdecs, other, decs) < 
+			![DecGroup(gdecs) | <group-decs> [other|decs]] + ![DecGroup(<id>)]
+
+	is-type-dec = ?TypeDec(_,_)
+	is-fun-dec  = ?FunDec(_, _, _) + ?FunDec(_, _, _, _)
\ No newline at end of file

Added: tiger-spoofax/trans/analysis/normal/signature.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/trans/analysis/normal/signature.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -0,0 +1,22 @@
+module analysis/normal/signature 
+
+imports
+	include/Tiger
+	
+signature constructors // operators
+	PLUS: 	BinOp
+	MINUS: 	BinOp
+	MUL: 	BinOp
+	DIV: 	BinOp
+	
+	EQ: 	RelOp
+	NE: 	RelOp
+	LE: 	RelOp
+	LT: 	RelOp
+	
+	Bop: BinOp * Expr * Expr -> Expr
+	Rop: RelOp * Expr * Expr -> Expr
+
+signature constructors // declaration groups
+	
+	DecGroup:	List(Dec) -> Dec
\ No newline at end of file

Modified: tiger-spoofax/trans/analysis/types/check.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/check.str	Sat Sep 11 08:45:49 2010	(r21232)
+++ tiger-spoofax/trans/analysis/types/check.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -5,9 +5,9 @@
 	
 imports
 	include/Tiger
+	analysis/normal/signature
 
 imports
-	analysis/types/operators
 	analysis/types/types
 	analysis/types/project
 	analysis/types/predefined

Modified: tiger-spoofax/trans/analysis/types/project.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/project.str	Sat Sep 11 08:45:49 2010	(r21232)
+++ tiger-spoofax/trans/analysis/types/project.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -8,8 +8,9 @@
 
 	analysis/names/namespaces
 
+	analysis/normal/signature
+	
 	analysis/types/types
-	analysis/types/operators
 	analysis/types/predefined
 	
 rules // declarations

Modified: tiger-spoofax/trans/generation/generate.str
==============================================================================
--- tiger-spoofax/trans/generation/generate.str	Sat Sep 11 08:45:49 2010	(r21232)
+++ tiger-spoofax/trans/generation/generate.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -5,7 +5,10 @@
 	lib/JavaBytecode
 	
 	analysis/main
-	analysis/types/operators
+	
+	analysis/normal/signature
+	analysis/normal/desugar
+	
 	analysis/types/types
 	analysis/types/project
 	
@@ -18,6 +21,8 @@
 			<guarantee-extension(|"jbc")> path => filename ;
 			<desugar-all ; to-jbc ; flatten-list ; pp-jbc <+ !""> selected => result
 
+rules
+	
 	to-jbc:	Int(i) -> LDC(Int(i)) 
 	
 	to-jbc: Bop(op, e1, e2) -> [ <to-jbc> e1, <to-jbc> e2, <to-jbc> op ]

Modified: tiger-spoofax/trans/tiger.str
==============================================================================
--- tiger-spoofax/trans/tiger.str	Sat Sep 11 08:45:49 2010	(r21232)
+++ tiger-spoofax/trans/tiger.str	Sat Sep 11 08:48:05 2010	(r21233)
@@ -1,17 +1,21 @@
 module tiger
 
 imports
-	libstratego-lib
-	libstratego-gpp
-	libstratego-aterm
 	lib/editor-common.generated
 
 imports
 	include/Tiger
+	
 	analysis/main
+	
+	analysis/normal/desugar
+	analysis/normal/eval
+	analysis/rename
+	
 	editor/resolve
 	editor/hover
 	editor/complete
+	
 	generation/generate
 	
 rules // Main editor interface (defined by editor/Tiger-Builders and -References.esv)
@@ -29,7 +33,7 @@
 		(selected, position, ast, path, project-path) -> (filename, result)
 		where
 			<guarantee-extension(|"aterm")> path => filename ;
-			result := ast
+			result := selected
 			
 	// Prints the desugared abstract syntax ATerm of a selection.
 	desugar-aterm:
@@ -38,3 +42,16 @@
 			<guarantee-extension(|"aterm")> path => filename ;
 			<desugar-all> selected => result
 
+	// Prints the evaluated abstract syntax ATerm of a selection.
+	eval-aterm:
+		(selected, position, ast, path, project-path) -> (filename, result)
+		where
+			<guarantee-extension(|"aterm")> path => filename ;
+			<eval-all> selected => result
+
+	type-rename-aterm:
+		(selected, position, ast, path, project-path) -> (filename, result)
+		where
+			<guarantee-extension(|"aterm")> path => filename ;
+			<type-rename-all> selected => result
+


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:48:51 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:48:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21234 -
	tiger-spoofax/trans/analysis/types
Message-ID: <201009110848.o8B8mpe2014431@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:48:50 2010
New Revision: 21234
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21234&sc=1

Log:
restructuring: put normalisation transformations in own directory
declaration grouping now in desugaring phase

Deleted:
   tiger-spoofax/trans/analysis/types/desugar.str
   tiger-spoofax/trans/analysis/types/operators.str


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:50:00 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:50:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21235 - in
	tiger-spoofax: editor trans/analysis/normal
Message-ID: <201009110850.o8B8o0xO014440@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:50:00 2010
New Revision: 21235
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21235&sc=1

Log:
included examples from the lecture

Added:
   tiger-spoofax/trans/analysis/normal/eval.str
   tiger-spoofax/trans/analysis/normal/normalise.str
Modified:
   tiger-spoofax/editor/Tiger-Builders.esv

Modified: tiger-spoofax/editor/Tiger-Builders.esv
==============================================================================
--- tiger-spoofax/editor/Tiger-Builders.esv	Sat Sep 11 08:48:50 2010	(r21234)
+++ tiger-spoofax/editor/Tiger-Builders.esv	Sat Sep 11 08:50:00 2010	(r21235)
@@ -15,7 +15,11 @@
                                                                                                                
 	observer	: editor-analyse                                                                   
  	
-	builder		: "Generate JBC" = generate-jbc (openeditor) (realtime)              
-	builder		: "Show abstract syntax" = generate-aterm (openeditor) (realtime) (meta) (source)  
-    builder		: "Show desugared AST" = desugar-aterm (openeditor) (realtime) (meta) 
-	builder		: "Show renamed AST" = rename-aterm (openeditor) (realtime) (meta)                                                                                                                
+	builder		: "Generate JBC (selection)" = generate-jbc (openeditor) (realtime)              
+	
+	builder		: "Show abstract syntax (selection)" = generate-aterm (openeditor) (realtime) (meta) (source)  
+    builder		: "Desugar (selection)" = desugar-aterm (openeditor) (realtime) (meta) (source) 
+	builder		: "Evaluate (selection)" = eval-aterm (openeditor) (realtime) (meta) (source)
+	builder		: "Rename types (selection)" = type-rename-aterm (openeditor) (realtime) (meta) (source)                                                                                                               
+
+	builder		: "Show analysed abstract syntax (selection)" = rename-aterm (openeditor) (realtime) (meta)                                                                                                                

Added: tiger-spoofax/trans/analysis/normal/eval.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/trans/analysis/normal/eval.str	Sat Sep 11 08:50:00 2010	(r21235)
@@ -0,0 +1,29 @@
+module analysis/normal/eval
+
+imports
+	include/Tiger
+	analysis/normal/signature
+	analysis/normal/desugar
+	
+strategies
+	
+	eval-all = innermost(desugar + eval)
+
+rules
+	
+	eval: Bop(PLUS(), Int(i1), Int(i2))  -> Int(<addS> (i1, i2))
+	eval: Bop(MINUS(), Int(i1), Int(i2)) -> Int(<subtS> (i1, i2))
+	eval: Bop(MUL(), Int(i1), Int(i2))   -> Int(<mulS> (i1, i2))
+	eval: Bop(DIV(), Int(i1), Int(i2))   -> Int(<divS> (i1, i2))
+		
+	eval: Rop(EQ(), Int(i), Int(i))   -> Int("1")
+
+	eval: Rop(NE(), Int(i), Int(i))   -> Int("0")
+	eval: Rop(NE(), Int(i1), Int(i2)) -> Int("1") where not( <eq> (i1, i2) )
+		
+	eval: Rop(LT(), Int(i1), Int(i2)) -> Int("1") where <ltS> (i1, i2)
+	eval: Rop(LT(), Int(i1), Int(i2)) -> Int("0") where not( <ltS> (i1, i2) )
+		
+	eval: Rop(LE(), Int(i1), Int(i2)) -> Int("1") where <leqS> (i1, i2)
+	eval: Rop(LE(), Int(i1), Int(i2)) -> Int("0") where not( <leqS> (i1, i2))
+

Added: tiger-spoofax/trans/analysis/normal/normalise.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/trans/analysis/normal/normalise.str	Sat Sep 11 08:50:00 2010	(r21235)
@@ -0,0 +1,15 @@
+module analysis/normal/normalise
+
+imports
+	include/Tiger
+	analysis/normal/signature
+	
+rules
+
+normalise: For(v, e1, e2, e3) -> Let([decl], [while])
+	where
+		!VarDec(v, Tid("int"), e1) => decl ;
+		!Rop(LE(), Var(v), e2) => check ;
+		!Assign(Var(v), Bop(PLUS(), Var(v), Int("1"))) => inc ;
+		!While(check, Seq([e3, inc])) => while
+			
\ No newline at end of file


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:54:31 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:54:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21236 - in
	tiger-spoofax/trans: . analysis/names
Message-ID: <201009110854.o8B8sVAK014476@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:54:31 2010
New Revision: 21236
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21236&sc=1

Log:
added type-rename example from the lecture

Added:
   tiger-spoofax/trans/analysis/names/type-rename.str
Modified:
   tiger-spoofax/trans/tiger.str

Added: tiger-spoofax/trans/analysis/names/type-rename.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/trans/analysis/names/type-rename.str	Sat Sep 11 08:54:31 2010	(r21236)
@@ -0,0 +1,51 @@
+module analysis/names/type-rename
+
+imports
+	include/Tiger
+	analysis/normal/signature
+	
+strategies
+
+	type-rename-all = alltd(type-rename)
+
+rules
+
+	type-rename-decs :
+		([], es) -> ([], <type-rename-all> es) 
+	
+	type-rename-decs : 
+		([d|ds], es) -> ([d'|ds'], es')
+		where
+			{| RenamedType :
+				<type-rename-all> <try(type-rename-dec)> d => d' ;
+				<type-rename-decs> (ds, es) => (ds', es') 
+			|}
+			
+rules // grouped declarations
+	
+	type-rename-dec :
+		DecGroup(decs) -> <map(try(type-rename-dec))> decs
+	
+rules // type declarations
+
+	type-rename-dec :
+		TypeDec(x, t) -> TypeDec(y, t)
+		where 
+			<newname> x => y
+		where rules (
+			RenamedType: x -> y
+		)
+		
+	type-rename :	
+		Tid(x) -> Tid(y)
+		where <debug> x
+		where
+			<RenamedType> x => y 
+
+rules // variables and their declarations
+			 
+	type-rename:
+		Let(ds, es) -> Let(ds', es')
+		where
+			<type-rename-decs> (ds, es) => (ds', es') 
+			 
\ No newline at end of file

Modified: tiger-spoofax/trans/tiger.str
==============================================================================
--- tiger-spoofax/trans/tiger.str	Sat Sep 11 08:50:00 2010	(r21235)
+++ tiger-spoofax/trans/tiger.str	Sat Sep 11 08:54:31 2010	(r21236)
@@ -10,7 +10,7 @@
 	
 	analysis/normal/desugar
 	analysis/normal/eval
-	analysis/rename
+	analysis/names/type-rename
 	
 	editor/resolve
 	editor/hover


From g.h.wachsmuth at tudelft.nl  Sat Sep 11 10:55:07 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sat, 11 Sep 2010 08:55:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21237 - tiger-spoofax
Message-ID: <201009110855.o8B8t7Eg014489@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sat Sep 11 08:55:07 2010
New Revision: 21237
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21237&sc=1

Log:
new spoofax version

Modified:
   tiger-spoofax/build.generated.xml

Modified: tiger-spoofax/build.generated.xml
==============================================================================
--- tiger-spoofax/build.generated.xml	Sat Sep 11 08:54:31 2010	(r21236)
+++ tiger-spoofax/build.generated.xml	Sat Sep 11 08:55:07 2010	(r21237)
@@ -3,8 +3,8 @@
 <project name="build.generated">
 
         <target name="spoofaximp.default" depends="spoofaximp.default.ctree"/>
-        <target name="spoofaximp.default.ctree" depends="sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.ctree,sdf2imp,refresh"/>
-        <target name="spoofaximp.default.jar" depends="sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  sdf2imp,refresh"/>
+        <target name="spoofaximp.default.ctree" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.ctree,sdf2imp,refresh"/>
+        <target name="spoofaximp.default.jar" depends="check-classpath,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,stratego.jar,  sdf2imp,refresh"/>
     
         <!-- Initialization -->
         <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
@@ -55,7 +55,9 @@
             <eclipse.refreshLocal resource="${eclipse.path.src-gen}" depth="infinite"/>
             <eclipse.convertPath fileSystemPath="${build}" property="eclipse.path.build"/>
             <eclipse.refreshLocal resource="${eclipse.path.build}" depth="infinite"/>
-            <eclipse.refreshLocal resource="${projectdir}/include" depth="infinite"/>
+            <!-- Might cause the editor to be reloaded?
+            <eclipse.refreshLocal resource="${projectdir}/include" depth="infinite" />
+            -->
         </target>
         
         <target name="sdf2imp.standalone" unless="eclipse.running" depends="sdf2rtg">
@@ -66,6 +68,22 @@
                 <arg value="${include}/${sdfmodule}.tbl"/>
             </java>
         </target>
+        
+        <target name="check-classpath">
+            <available classname="org.strategoxt.imp.generator.sdf2imp" property="check-classpath.available"/>
+            <antcall target="check-classpath.helper"/>  
+        </target>
+  
+        <target name="check-classpath.helper" unless="check-classpath.available">
+            <echo level="error" message="Could not load the Spoofax plugin loading classes."/>
+            <echo level="error" message="Make sure it is on the class path."/>
+            <echo level="error" message=""/>               
+            <echo level="error" message="In Eclipse, make sure the Ant builder is configured properly:"/>
+            <echo level="error" message="right-click on build.main.xml, go to Run as, Ant build..., JRE tab,"/>
+            <echo level="error" message="and ensure Run in the same JRE as the workspace is selected"/>
+            <echo level="error" message="alternatively, build the project using Build Project in the Project menu"/>
+            <fail/>
+        </target>
     
         <target name="sdf2table" depends="make-permissive">
             <apply executable="${build.strategoxt.sdf}sdf2table" dest="${include}" failonerror="true">
@@ -87,6 +105,12 @@
                 <param name="sdfmodule" value="${metasdfmodule}"/>
                 <param name="build.sdf.imports" value="-Idef &quot;${eclipse.spoofaximp.jars}/StrategoMix.def&quot; ${build.sdf.imports}"/>
             </antcall>
+            <antcall target="meta-sdf2table.helper"/>
+        </target>
+        
+        <target name="meta-sdf2table.helper" if="eclipse.running">
+           <eclipse.convertPath fileSystemPath="${include}" property="includeresource"/>
+           <eclipse.refreshLocal resource="${includeresource}/${metasdfmodule}.tbl" depth="infinite"/>
         </target>
         
         <target name="make-permissive" depends="pack-sdf,copy-sdf">
@@ -361,7 +385,7 @@
                 <arg line="${build.stratego.extraargs}"/>
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
-                <arg line="-I &quot;${lib}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot;  --cache-dir &quot;${basedir}/.cache&quot;"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>


From g.h.wachsmuth at tudelft.nl  Sun Sep 12 18:12:27 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 12 Sep 2010 16:12:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21238 -
	tiger-spoofax/trans/analysis/names
Message-ID: <201009121612.o8CGCRBS007188@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun Sep 12 16:12:27 2010
New Revision: 21238
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21238&sc=1

Log:
simplified renaming rules

Modified:
   tiger-spoofax/trans/analysis/names/rename.str
   tiger-spoofax/trans/analysis/names/type-rename.str

Modified: tiger-spoofax/trans/analysis/names/rename.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/rename.str	Sat Sep 11 08:55:07 2010	(r21237)
+++ tiger-spoofax/trans/analysis/names/rename.str	Sun Sep 12 16:12:27 2010	(r21238)
@@ -9,6 +9,7 @@
 	analysis/normal/signature
 
 imports
+	analysis/normal/desugar
 	analysis/names/namespaces
 	analysis/names/project
 	editor/complete
@@ -17,23 +18,10 @@
 
 	rename-all = alltd(propose <+ rename)
 
-rules
-	
-	rename-decs :
-		([], es) -> ([], <rename-all> es) 
-
-	rename-decs : 
-		([d|ds], es) -> ([d'|ds'], es')
-		where
-			new-scope(
-				<rename-dec> d => d' ;
-				<rename-decs> (ds, es) => (ds', es') 
-			)
-			
 rules // let declarations
 	
 	rename-dec :
-		DecGroup(decs) ->  <rename-all> <map(rename-dec)> decs
+		DecGroup(decs) ->  DecGroup(<map(rename-dec) ; rename-all> decs)
 
 	rename-dec :
 		TypeDec(x, t) -> TypeDec(y, t)
@@ -75,11 +63,17 @@
 		where
 			<rename-reference> (Vars(), x) => y  
 
-	rename : 
-		Let(ds, es) -> Let(ds', es') 
-		where 
-			<rename-decs> (ds, es) => (ds', es')
+	rename :
+		Let([], es)  -> Let([], <rename-all> es)
 
+	rename : 
+		Let([d|ds], es) -> Let([d'|ds'], es')
+		where
+			new-scope(
+				<rename-dec> d => d' ;
+				<rename> Let(ds, es) => Let(ds', es') 
+			)
+			
 	rename :
 		For(x, e1, e2, e3) -> For(y, e1', e2', e3')
 		where 

Modified: tiger-spoofax/trans/analysis/names/type-rename.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/type-rename.str	Sat Sep 11 08:55:07 2010	(r21237)
+++ tiger-spoofax/trans/analysis/names/type-rename.str	Sun Sep 12 16:12:27 2010	(r21238)
@@ -3,30 +3,18 @@
 imports
 	include/Tiger
 	analysis/normal/signature
+	analysis/normal/desugar
 	
 strategies
 
-	type-rename-all = alltd(type-rename)
+	type-rename-all = topdown(try(group-let-decs)) ; alltd(type-rename)
 
-rules
-
-	type-rename-decs :
-		([], es) -> ([], <type-rename-all> es) 
-	
-	type-rename-decs : 
-		([d|ds], es) -> ([d'|ds'], es')
-		where
-			{| RenamedType :
-				<type-rename-all> <try(type-rename-dec)> d => d' ;
-				<type-rename-decs> (ds, es) => (ds', es') 
-			|}
-			
 rules // grouped declarations
 	
 	type-rename-dec :
-		DecGroup(decs) -> <map(try(type-rename-dec))> decs
+		DecGroup(decs) -> DecGroup(<map(try(type-rename-dec))> decs)
 	
-rules // type declarations
+rules // type declarations and references
 
 	type-rename-dec :
 		TypeDec(x, t) -> TypeDec(y, t)
@@ -41,11 +29,19 @@
 		where <debug> x
 		where
 			<RenamedType> x => y 
+		where <debug> y
+		
 
-rules // variables and their declarations
+rules // let expressions
 			 
-	type-rename:
-		Let(ds, es) -> Let(ds', es')
+	type-rename :
+		Let([], es) -> Let([], <type-rename-all> es) 
+	
+	type-rename : 
+		Let([d|ds], es) -> Let([d'|ds'], es')
 		where
-			<type-rename-decs> (ds, es) => (ds', es') 
-			 
\ No newline at end of file
+			{| RenamedType :
+				<type-rename-all> <try(type-rename-dec)> d => d' ;
+				<type-rename> Let(ds, es) => Let(ds', es') 
+			|}
+			


From g.h.wachsmuth at tudelft.nl  Sun Sep 12 18:13:36 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 12 Sep 2010 16:13:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21239 -
	tiger-spoofax/editor
Message-ID: <201009121613.o8CGDasQ007210@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun Sep 12 16:13:35 2010
New Revision: 21239
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21239&sc=1

Log:
re-ordering

Modified:
   tiger-spoofax/editor/Tiger-Builders.esv

Modified: tiger-spoofax/editor/Tiger-Builders.esv
==============================================================================
--- tiger-spoofax/editor/Tiger-Builders.esv	Sun Sep 12 16:12:27 2010	(r21238)
+++ tiger-spoofax/editor/Tiger-Builders.esv	Sun Sep 12 16:13:35 2010	(r21239)
@@ -17,9 +17,11 @@
  	
 	builder		: "Generate JBC (selection)" = generate-jbc (openeditor) (realtime)              
 	
-	builder		: "Show abstract syntax (selection)" = generate-aterm (openeditor) (realtime) (meta) (source)  
-    builder		: "Desugar (selection)" = desugar-aterm (openeditor) (realtime) (meta) (source) 
+	builder		: "Abstract syntax (selection)" = generate-aterm (openeditor) (realtime) (meta) (source)  
+    builder		: "Analysed abstract syntax (selection)" = rename-aterm (openeditor) (realtime) (meta)                                                                                                                
+	
+	builder		: "Desugar (selection)" = desugar-aterm (openeditor) (realtime) (meta) (source) 
 	builder		: "Evaluate (selection)" = eval-aterm (openeditor) (realtime) (meta) (source)
 	builder		: "Rename types (selection)" = type-rename-aterm (openeditor) (realtime) (meta) (source)                                                                                                               
 
-	builder		: "Show analysed abstract syntax (selection)" = rename-aterm (openeditor) (realtime) (meta)                                                                                                                
+	
\ No newline at end of file


From n.bruning at student.tudelft.nl  Fri Sep 17 17:41:57 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Fri, 17 Sep 2010 15:41:57 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21240 - in
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime:
	services stratego
Message-ID: <201009171541.o8HFfvSx028087@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Fri Sep 17 15:41:57 2010
New Revision: 21240
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21240&sc=1

Log:
Fix background jobs for projects that are not located within the workspace

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Sun Sep 12 16:13:35 2010	(r21239)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Fri Sep 17 15:41:57 2010	(r21240)
@@ -90,12 +90,12 @@
 			} finally {
 				if (!isSystem())
 					protector.endProtect();
+				
+				// Run next task
+				running = false;
+				wake();
 			}
 
-			// Run next task
-			running = false;
-			wake();
-
 			return status;
 		}
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java	Sun Sep 12 16:13:35 2010	(r21239)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java	Fri Sep 17 15:41:57 2010	(r21240)
@@ -7,7 +7,12 @@
 import java.io.InputStream;
 import java.io.OutputStream;
 import java.io.Writer;
+import java.net.URI;
+import java.net.URISyntaxException;
 
+import org.eclipse.core.resources.IContainer;
+import org.eclipse.core.resources.IProject;
+import org.eclipse.core.resources.ResourcesPlugin;
 import org.spoofax.interpreter.library.LoggingIOAgent;
 import org.strategoxt.imp.runtime.Debug;
 import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
@@ -114,4 +119,29 @@
 	public StrategoAnalysisJob getJob() {
 		return this.job;
 	}
+	
+	/**
+	 * Find the IProject for this agent.
+	 * If no project is found for this agent, the given IPath is used.
+	 * @param file
+	 */
+	public IProject getProject() {
+
+		IProject project = null;
+		try {
+			IContainer[] containers = 
+				ResourcesPlugin.getWorkspace().getRoot().findContainersForLocationURI(new URI("file://" + getProjectPath()));
+			for(IContainer container : containers) {
+				if (container instanceof IProject) {
+					project = (IProject)container;
+				}
+			}
+
+		} catch (URISyntaxException e) {
+			e.printStackTrace();
+		}
+		
+		return project;
+		
+	}
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java	Sun Sep 12 16:13:35 2010	(r21239)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java	Fri Sep 17 15:41:57 2010	(r21240)
@@ -3,6 +3,7 @@
  */
 package org.strategoxt.imp.runtime.stratego;
 
+import org.eclipse.core.resources.IContainer;
 import org.eclipse.core.resources.IProject;
 import org.eclipse.core.resources.ResourcesPlugin;
 import org.eclipse.core.runtime.IPath;
@@ -49,11 +50,7 @@
 			IStrategoTerm term = env.current();
 			Descriptor descriptor = agent.getDescriptor();
 			
-			IPath projectPath = new Path(agent.getProjectPath());
-			IPath workspacePath = ResourcesPlugin.getWorkspace().getRoot().getLocation();
-			IPath workspaceLocalPath = projectPath.removeFirstSegments(projectPath.matchingFirstSegments(workspacePath));
-			IProject project = ResourcesPlugin.getWorkspace().getRoot().findMember(workspaceLocalPath).getProject();
-			
+			IProject project = agent.getProject();
 			StrategoObserverBackgroundJob job = new StrategoObserverBackgroundJob(strategyName, term, descriptor);
 			job.setup(project);
 			

From L.C.L.Kats at tudelft.nl  Mon Sep 20 10:28:54 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 20 Sep 2010 08:28:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21241 - in
	spoofax-imp/trunk: org.strategoxt.imp.editors.sdf/trans
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009200828.o8K8SsLD014075@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep 20 08:28:53 2010
New Revision: 21241
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21241&sc=1

Log:
Spoofax/248: Term caption collision internal <-> user defined

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/LabelProvider.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	Fri Sep 17 15:41:57 2010	(r21240)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	Mon Sep 20 08:28:53 2010	(r21241)
@@ -89,6 +89,7 @@
     where
       <one(bracket())> a*
    
+  // TODO: don't warn for | in {reject} productions
   context-free-syntax-warning:
     alt(x, y) -> (<id>, $[The | construct is deprecated: instead of A|B->C use A->C B->C])
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/LabelProvider.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/LabelProvider.java	Fri Sep 17 15:41:57 2010	(r21240)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/LabelProvider.java	Mon Sep 20 08:28:53 2010	(r21241)
@@ -40,11 +40,14 @@
 		// HACK: Hardcoded outlining, until we have support for patterns
 		String constructor = node == null ? null : node.getConstructor();
 		
-		if ("MethodDec".equals(constructor)) {
+		if ("MethodDec".equals(constructor)
+				&& node.getChildren().size() > 0 && node.getChildren().get(0).getChildren().size() > 3) {
 			return node.getChildren().get(0).getChildren().get(3).toString();
-		} else if ("ClassDec".equals(constructor)) {
+		} else if ("ClassDec".equals(constructor)
+				&& node.getChildren().size() > 0 && node.getChildren().get(0).getChildren().size() > 1) {
 			return node.getChildren().get(0).getChildren().get(1).toString();
-		} else if (node.getChildren().size() == 1 && node.getChildren().get(0).isList()) {
+		} else if (node.getChildren().size() == 1
+				&& node.getChildren().size() > 0 && node.getChildren().get(0).isList()) {
 			return node.getLeftIToken().toString(); // e.g., "rules", "strategies"
 		} else {
 			return getIdentifier(node);

From L.C.L.Kats at tudelft.nl  Mon Sep 20 21:33:41 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 20 Sep 2010 19:33:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21242 - in
	spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.updatesite
Message-ID: <201009201933.o8KJXgt2026109@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Mon Sep 20 19:33:40 2010
New Revision: 21242
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21242&sc=1

Log:
Release 0.5.3.4

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Mon Sep 20 08:28:53 2010	(r21241)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Mon Sep 20 19:33:40 2010	(r21242)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.5.3.3"
+      version="0.5.3.4"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Mon Sep 20 08:28:53 2010	(r21241)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Mon Sep 20 19:33:40 2010	(r21242)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.5.3.3.jar" id="org.strategoxt.imp" version="0.5.3.3">
+   <feature url="features/org.strategoxt.imp_0.5.3.4.jar" id="org.strategoxt.imp" version="0.5.3.4">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">

From L.C.L.Kats at tudelft.nl  Tue Sep 21 14:00:12 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 21 Sep 2010 12:00:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21243 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter
	strc-java/trunk/java/runtime/org/strategoxt/lang/terms
Message-ID: <201009211200.o8LC0Clh011145@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Tue Sep 21 12:00:12 2010
New Revision: 21243
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21243&sc=1

Log:
Added null check for Spoofax/254.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/terms/StrategoConstructor.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java	Mon Sep 20 19:33:40 2010	(r21242)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java	Tue Sep 21 12:00:12 2010	(r21243)
@@ -36,7 +36,8 @@
 				result = new WrappedAstNodeList(this, node, 0);
 				break;
 			case APPL:
-				result = "".equals(node.getConstructor())
+				String constructor = node.getConstructor();
+				result = constructor == null || constructor.length() == 0
 					? new WrappedAstNodeTuple(node)
 					: new WrappedAstNodeAppl(this, node);
 				break;

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/terms/StrategoConstructor.java
==============================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/terms/StrategoConstructor.java	Mon Sep 20 19:33:40 2010	(r21242)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/terms/StrategoConstructor.java	Tue Sep 21 12:00:12 2010	(r21243)
@@ -24,6 +24,7 @@
         super(null);
         this.name = name;
         this.arity = arity;
+        if (name == null) throw new IllegalArgumentException("name cannot be null");
     }
     
     public int getStorageType() {

From n.bruning at student.tudelft.nl  Tue Sep 21 20:46:58 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Tue, 21 Sep 2010 18:46:58 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21244 - in
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime:
	services stratego
Message-ID: <201009211846.o8LIkw9f019159@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Tue Sep 21 18:46:57 2010
New Revision: 21244
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21244&sc=1

Log:
Fix analysis queuing for out-of-workspace projects

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java	Tue Sep 21 12:00:12 2010	(r21243)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java	Tue Sep 21 18:46:57 2010	(r21244)
@@ -40,10 +40,10 @@
 		
 		try {
 			
-			IPath fullPath = project.getFullPath().append(path);
+			IPath absolutePath = project == null ? path : project.getLocation().append(path);
 			
 			// Get descriptor
-			Language lang = LanguageRegistry.findLanguage(fullPath, null);
+			Language lang = LanguageRegistry.findLanguage(absolutePath, null);
 			Descriptor descriptor = Environment.getDescriptor(lang); 
 			
 			// Get parse controller
@@ -54,9 +54,6 @@
 			parseController.setPerformInitialUpdate(false);
 			
 			// Read file
-			IPath absolutePath = project == null ? path : project.getFullPath().append(path);
-			absolutePath = ResourcesPlugin.getWorkspace().getRoot().getLocation().append(absolutePath);
-			
 			File file = absolutePath.toFile();
 			byte[] buffer = new byte[(int) file.length()];
 		    BufferedInputStream f = new BufferedInputStream(new FileInputStream(file));

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java	Tue Sep 21 12:00:12 2010	(r21243)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java	Tue Sep 21 18:46:57 2010	(r21244)
@@ -4,7 +4,6 @@
 package org.strategoxt.imp.runtime.stratego;
 
 import org.eclipse.core.resources.IProject;
-import org.eclipse.core.resources.ResourcesPlugin;
 import org.eclipse.core.runtime.IPath;
 import org.eclipse.core.runtime.Path;
 import org.spoofax.interpreter.core.IContext;
@@ -60,16 +59,14 @@
 		if (!(agent instanceof EditorIOAgent) || ((EditorIOAgent) agent).getProjectPath() == null) {
 			throw new InterpreterException("Agent not instanceof EditorIOAgent or not in project.");
 		}
-		String projectPathStr = ((EditorIOAgent)agent).getProjectPath();
+		EditorIOAgent editorAgent = (EditorIOAgent)agent;
 		
 		// Make path project local
+		String projectPathStr = editorAgent.getProjectPath();
 		IPath projectPath = new Path(projectPathStr); 
 		IPath projectRelativePath = filePath.removeFirstSegments(filePath.matchingFirstSegments(projectPath)); 
-		
-		// Fetch project
-		IPath workspacePath = ResourcesPlugin.getWorkspace().getRoot().getLocation();
-		IPath workspaceLocalPath = projectPath.removeFirstSegments(projectPath.matchingFirstSegments(workspacePath));
-		IProject project = ResourcesPlugin.getWorkspace().getRoot().findMember(workspaceLocalPath).getProject();
+
+		IProject project = editorAgent.getProject();
 		
 		StrategoAnalysisQueueFactory.getInstance().queueAnalysis(projectRelativePath, project);
 		

From g.h.wachsmuth at tudelft.nl  Thu Sep 23 09:45:39 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 23 Sep 2010 07:45:39 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21245 -
	tiger-spoofax/lib
Message-ID: <201009230745.o8N7jdvv023969@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu Sep 23 07:45:38 2010
New Revision: 21245
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21245&sc=1

Log:
new version of the namespace library

Modified:
   tiger-spoofax/lib/namespace.str

Modified: tiger-spoofax/lib/namespace.str
==============================================================================
--- tiger-spoofax/lib/namespace.str	Tue Sep 21 18:46:57 2010	(r21244)
+++ tiger-spoofax/lib/namespace.str	Thu Sep 23 07:45:38 2010	(r21245)
@@ -1,6 +1,6 @@
 module lib/namespace
 
-rules
+rules // scoped renaming
 	
 	new-scope(s) :
 		x -> y
@@ -11,8 +11,8 @@
 				<s> x => y
 			|} 
 			
-	rename-declaration : 
-		(namespace, x) -> x'
+	rename-declaration(|namespace) : 
+		x -> x'
 		where 
 			CurrentScope => scope ;
 			(
@@ -24,40 +24,60 @@
 			Renamed: (namespace, x) -> x'
 		)
 	
-	rename-reference :
-		(namespace, x) -> x'
+	rename-reference(|namespace) :
+		x -> x'
 		where
 			<Renamed> (namespace, x) => x'
+
+rules // store declarations and references
 	
-	store-declaration :
-		(namespace, x, d) -> x
+	new-analysis(s) = {| Declared, Referred: s |}
+		
+	store-declaration(|namespace) :
+		(x, d) -> d
 		where rules(
 			Declared:+ (namespace, x) -> d
 		)
 		
-	store-reference :
-		(namespace, x) -> x
+	store-reference(|namespace) :
+		x -> x
 		where rules (
 			Referred:+ (namespace, x) -> x
 		)	
 		
-strategies
-	
-	get-declarations = bagof-Declared
+strategies // access project declarations
 	
-	get-all-renames = ?ns ; all-keys-Renamed ; filter(?(ns, <id>))
+	get-declarations(|namespace) = !(namespace, <id>) ; bagof-Declared
 	
-	get-unique-declaration = get-declarations ; ?[<id>]
+	get-unique-declaration(|namespace) = get-declarations(|namespace) ; ?[<id>]
 	
-	is-declared = get-declarations ; ?[_|_]
+	is-declared(|namespace) = get-declarations(|namespace) ; ?[_|_]
 	
-	get-declaration(s) = get-declarations ; fetch-elem(where(s)) 
+	get-declaration(s|namespace) = get-declarations(|namespace) ; fetch-elem(where(s)) 
 	
-	project-declarations(s) = get-declarations ; filter(s) 
+	project-declarations(s|namespace) = get-declarations(|namespace) ; filter(s) 
 	
-	project-declaration(s) = get-declarations ; fetch-elem(s) 
+	project-declaration(s|namespace) = get-declarations(|namespace) ; fetch-elem(s) 
 	 
-	get-references = bagof-Referred
+strategies // access references
+
+	get-references(|namespace) = !(namespace, <id>) ; bagof-Referred
+	
+	is-referred(|namespace) = get-references(|namespace) ; ?[_|_]
+
+strategies	
+	
+	get-proposal-candidates(|namespace) = all-keys-Renamed ; filter(?(namespace, _) ; Renamed)
+	
+	store-proposal-candidates(|namespace) = get-proposal-candidates(|namespace) ; store-proposals
+	
+	store-proposals = ?x ; where (rules ( Propose : () -> x ))
+	
+	get-proposals = ( <Propose> () ; map(rm-annotations) ) <+ ![]
 	
-	is-referred = get-references ; ?[_|_]
-	
\ No newline at end of file
+	get-proposals(s|namespace) = 
+		( 
+			<Propose> () ; 
+			filter(where( get-declaration(s|namespace) )) ; 
+			map(rm-annotations) 
+		) <+ ![]

From g.h.wachsmuth at tudelft.nl  Thu Sep 23 09:53:45 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 23 Sep 2010 07:53:45 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21246 - in
	tiger-spoofax/trans: analysis analysis/names analysis/normal
	analysis/types normal
Message-ID: <201009230753.o8N7rjjK024041@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu Sep 23 07:53:45 2010
New Revision: 21246
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21246&sc=1

Log:
new version of the namespace library
moved desugaring into new normalisation folder

Added:
   tiger-spoofax/trans/normal/
      - copied from r21233, tiger-spoofax/trans/analysis/normal/
   tiger-spoofax/trans/normal/eval.str
      - copied, changed from r21235, tiger-spoofax/trans/analysis/normal/eval.str
   tiger-spoofax/trans/normal/normalise.str
      - copied, changed from r21235, tiger-spoofax/trans/analysis/normal/normalise.str
Deleted:
   tiger-spoofax/trans/analysis/normal/
Modified:
   tiger-spoofax/trans/analysis/main.str
   tiger-spoofax/trans/analysis/names/check.str
   tiger-spoofax/trans/analysis/names/map.str
   tiger-spoofax/trans/analysis/names/rename.str
   tiger-spoofax/trans/analysis/names/type-rename.str
   tiger-spoofax/trans/analysis/types/check.str
   tiger-spoofax/trans/analysis/types/project.str
   tiger-spoofax/trans/analysis/types/types.str
   tiger-spoofax/trans/normal/desugar.str

Modified: tiger-spoofax/trans/analysis/main.str
==============================================================================
--- tiger-spoofax/trans/analysis/main.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/main.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -10,13 +10,13 @@
 	analysis/names/map
 	analysis/names/check
 	
-	analysis/normal/desugar
+	normal/desugar
 	
 	analysis/types/check
 		
 strategies
 
-	analyse = desugar-all ; rename-all ; store-all
+	analyse = desugar-all ; rename-all ; store-all // rename
 
 rules
 	

Modified: tiger-spoofax/trans/analysis/names/check.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/check.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/names/check.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -15,16 +15,16 @@
 	
 	editor-error:
 		e at Tid(t) -> (e, $[Type [t] is not declared.])
-		where not ( <is-declared> (Types(), t) )
+		where not ( <is-declared(| Types())> t )
 		where not ( <primitive-type> t )
 		
 	editor-error:
 		e at Var(x) -> (e, $[Variable [x] is not declared.])
-		where not ( <get-declaration(var-name)> (Vars(), x) )
+		where not ( <get-declaration(var-name | Vars())> x )
 	
 	editor-error:
 		e at Call(f, _) -> (e, $[Function [f] is not declared.])
-		where not ( <get-declaration(fun-name)> (Vars(), f) )
+		where not ( <get-declaration(fun-name | Vars())> f )
 		where not ( <standard-lib-fun> f )
 		
 rules // multiple declarations
@@ -32,27 +32,27 @@
 	editor-error:
 		d -> (d, $[Multiple declarations for variable or function name [x].])
 		where <var-name <+ fun-name> d => x 
-		where not ( <get-unique-declaration> (Vars(), x) )
+		where not ( <get-unique-declaration(|Vars())> x )
 
 	editor-error:
 		d at TypeDec(t, _) -> (d, $[Multiple declarations for type name [t].])
-		where not ( <get-unique-declaration> (Types(), t) )
+		where not ( <get-unique-declaration(|Types())> t )
 	
 rules // unused declarations
 	
 	editor-warning: 
 		d -> (d, $[Type [t] is never used.])
 		where <type-name> d => t 
-		where not ( <is-referred> (Types(), t) )
+		where not ( <is-referred(|Types())> t )
 				
 	editor-warning: 
 		d -> (d, $[Variable [x] is never used.])
 		where <var-name> d => x 
 		where not ( <?For(_, _, _, _)> d )
-		where not ( <is-referred> (Vars(), x) )
+		where not ( <is-referred(|Vars())> x )
 				
 	editor-warning: 
 		d -> (d, $[Function [f] is never called.])
 		where <fun-name> d => f 
-		where not ( <is-referred> (Vars(), f) )
+		where not (<is-referred(|Vars())> f )
 			
\ No newline at end of file

Modified: tiger-spoofax/trans/analysis/names/map.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/map.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/names/map.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -16,55 +16,35 @@
 rules // declarations
 	
 	store :
-		d at TypeDec(t, _) -> d
-		where
-			<store-declaration> (Types(), t, d)
+		d at TypeDec(t, _) -> <store-declaration(|Types())> (t, d)
 			
 	store :
-		d at VarDec(x, _, _) -> d
-		where
-			<store-declaration> (Vars(), x, d) 	
+		d at VarDec(x, _, _) -> <store-declaration(|Vars())> (x, d) 	
 
 	store :
-		d at VarDec(x, _) -> d
-		where
-			<store-declaration> (Vars(), x, d) 	
+		d at VarDec(x, _) -> <store-declaration(|Vars())> (x, d) 	
 
 	store :
-		d at FArg(x, _) -> d
-		where
-			<store-declaration> (Vars(), x, d) 	
+		d at FArg(x, _) -> <store-declaration(|Vars())> (x, d) 	
 
 	store :
-		d at For(x, _, _, _) -> d
-		where
-			<store-declaration> (Vars(), x, d) 	
+		d at For(x, _, _, _) -> <store-declaration(|Vars())> (x, d) 	
 
 	store :
-		d at FunDec(f, _, _, _) -> d
-		where
-			<store-declaration> (Vars(), f, d) 	
+		d at FunDec(f, _, _, _) -> <store-declaration(|Vars())> (f, d) 	
 
 	store :
-		d at FunDec(f, _, _) -> d
-		where
-			<store-declaration> (Vars(), f, d) 
+		d at FunDec(f, _, _) -> <store-declaration(|Vars())> (f, d) 
 			
 rules // references
 	
 	store :
-		r at Tid(t) -> r
-		where
-			<store-reference> (Types(), t)
+		r at Tid(t) -> r where <store-reference(|Types())> t
 	
 	store :
-		r at Var(x) -> r
-		where
-			<store-reference> (Vars(), x)
+		r at Var(x) ->  r where <store-reference(|Vars())> x
 	
 	store :
-		r at Call(f, _) -> r
-		where
-			<store-reference> (Vars(), f)
+		r at Call(f, _) ->  r where <store-reference(|Vars())> f
 	
 

Modified: tiger-spoofax/trans/analysis/names/rename.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/rename.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/names/rename.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -6,10 +6,10 @@
 
 imports
 	include/Tiger 
-	analysis/normal/signature
+	normal/signature
 
 imports
-	analysis/normal/desugar
+	normal/desugar
 	analysis/names/namespaces
 	analysis/names/project
 	editor/complete
@@ -26,43 +26,37 @@
 	rename-dec :
 		TypeDec(x, t) -> TypeDec(y, t)
 		where 
-			<rename-declaration> (Types(), x) => y 
-
+			<rename-declaration(|Types())> x => y 
+			
 	rename-dec :
     	VarDec(x, t, e) -> VarDec(y, t', e')
     	where 
     		<rename-all> t => t';
     		<rename-all> e => e';
-    		<rename-declaration> (Vars(), x) => y
+    		<rename-declaration(|Vars())> x => y
     		
 	rename-dec :
     	VarDec(x, t) -> VarDec(y, t')
     	where 
     		<rename-all> t => t' ;
-    		<rename-declaration> (Vars(), x) => y 
+    		<rename-declaration(|Vars())> x => y
 
 	rename-dec :
 		FunDec(f, as, t, e) -> FunDec(g, as, t, e)
     	where 
-    		<rename-declaration> (Vars(), f) => g 
+    		<rename-declaration(|Vars())> f => g 
 
 	rename-dec :
 		FunDec(f, as, e) -> FunDec(g, as, e)
     	where 
-    		<rename-declaration> (Vars(), f) => g 
+    		<rename-declaration(|Vars())> f => g
 
 rules
 
-	rename : 
-		Tid(x) -> Tid(y) 
-		where
-			<rename-reference> (Types(), x) => y 
-
-	rename : 
-		Var(x) -> Var(y)
-		where
-			<rename-reference> (Vars(), x) => y  
-
+	rename : Tid(t) -> Tid(<rename-reference(|Types())> t) 
+	
+	rename :  Var(x) -> Var(<rename-reference(|Vars())> x)
+	
 	rename :
 		Let([], es)  -> Let([], <rename-all> es)
 
@@ -80,7 +74,7 @@
 			<rename-all> e1 => e1' ;
 			<rename-all> e2 => e2' ;
 			new-scope (
-				<rename-declaration> (Vars(), x) => y ;
+				<rename-declaration(|Vars())> x => y ;
 				<rename-all> e3 => e3'
 			)
 
@@ -105,12 +99,12 @@
 		FArg(x, t) -> FArg(y, t')
 		where
 			<rename-all> t => t' ;
-			<rename-declaration> (Vars(), x) => y 
+			<rename-declaration(|Vars())> x => y
 			
 	rename :
 		Call(f, es) -> Call(g, es')
 		where
 			<rename-all> es => es' ;
-			<rename-reference> (Vars(), f) => g
+			<rename-reference(|Vars())> f => g
     		
 			 
\ No newline at end of file

Modified: tiger-spoofax/trans/analysis/names/type-rename.str
==============================================================================
--- tiger-spoofax/trans/analysis/names/type-rename.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/names/type-rename.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -2,8 +2,8 @@
 
 imports
 	include/Tiger
-	analysis/normal/signature
-	analysis/normal/desugar
+	normal/signature
+	normal/desugar
 	
 strategies
 

Modified: tiger-spoofax/trans/analysis/types/check.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/check.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/types/check.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -5,9 +5,10 @@
 	
 imports
 	include/Tiger
-	analysis/normal/signature
+	normal/signature
 
 imports
+	analysis/names/namespaces
 	analysis/types/types
 	analysis/types/project
 	analysis/types/predefined
@@ -80,14 +81,13 @@
 	
 	editor-error:
 		e at Call(f, es) -> (e, "Wrong number of arguments.")
-		where <project-declaration(type-of) <+ standard-lib-fun> f => (ts, t)
+		where <project-declaration(dec-type|Vars()) <+ standard-lib-fun> f => (ts, t)
 		where not( <eq> (<length> es, <length> ts) ) 
 
 	editor-error:
 		Call(f, es) -> errors
-		
-		where <project-declaration(type-of) <+ standard-lib-fun> f => (ts, t)
-		where <zip(check-exp(eq-or-nil))> (es, ts) => errors 
+		where <project-declaration(dec-type|Vars()) <+ standard-lib-fun> f => (ts, t)
+		where <zip ; filter(check-exp(eq-or-nil))> (es, ts) => errors 
 				
 rules // binary expressions
 	
@@ -126,10 +126,6 @@
 		where <filter(check-exp(eq-or-nil <+ noval-noval))> [(e1, INT()), (e3, t)] => errors
 
 	editor-error:
-		IfThen(e1, e2) -> errors
-		where <filter(check-exp(eq))> [(e1, INT()), (e2, NO_VAL())] => errors
-
-	editor-error:
 		While(e1, e2) -> errors
 		where <filter(check-exp(eq))> [(e1, INT()), (e2, NO_VAL())] => errors
 

Modified: tiger-spoofax/trans/analysis/types/project.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/project.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/types/project.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -8,22 +8,22 @@
 
 	analysis/names/namespaces
 
-	analysis/normal/signature
+	normal/signature
 	
 	analysis/types/types
 	analysis/types/predefined
 	
 rules // declarations
 	
-	type-type	: TypeDec(_, t) -> t
+	dec-type : TypeDec(_, t) -> t
 	
-	type-of	: VarDec(_, e) 		-> <type-of> e
-	type-of	: VarDec(_, t, _) 	-> <type-of> t
-	type-of	: For(_, _, _, _) 	-> INT()
-	type-of	: FArg(_, t) 		-> <type-of> t
+	dec-type : VarDec(_, e) 	-> <type-of> e
+	dec-type : VarDec(_, tn, _) -> <type-of> tn
+	dec-type : For(_, _, _, _) 	-> INT()
+	dec-type : FArg(_, tn) 		-> <type-of> tn
 		
-	type-of	: FunDec(_, as, _) 		-> (<map(type-of)> as, NO_VAL())
-	type-of	: FunDec(_, as, t, _) 	-> (<map(type-of)> as, <type-of> t)
+	dec-type : FunDec(_, as, _) 	-> (<map(dec-type)> as, NO_VAL())
+	dec-type : FunDec(_, as, t, _) 	-> (<map(dec-type)> as, <type-of> t)
 
 rules // types
 	
@@ -31,7 +31,7 @@
 		tn at Tid(i) -> t
 		where
 			(
-				<project-declaration(type-type)> (Types(), i) => d ; 
+				<project-declaration(dec-type | Types())> i => d ; 
 				<declared-type> (tn, tn, d) => t
 			) <+ 
 			<primitive-type> i => t
@@ -41,7 +41,7 @@
 		where 
 			(
 				not( <eq> (t1, t3) ) ;
-				<project-declaration(type-type)> (Types(), t3) => d ;
+				<project-declaration(dec-type | Types())> t3 => d ;
 				<declared-type> (t1, t3, d) => t
 			) <+  
 			<primitive-type> t3 => t 
@@ -54,7 +54,7 @@
 rules // lvalues
 	
 	type-of : 
-		Var(x) 	-> <project-declaration(type-of)> (Vars(), x) 
+		Var(x) 	-> <project-declaration(dec-type | Vars())> x 
   	
   	type-of :
   		FieldVar(e, f) -> t
@@ -74,12 +74,12 @@
 	type-of : 
 		Call(f, es) -> t
 		where
-			<project-declaration(type-of) <+ standard-lib-fun> f => (ts, t) ;
+			<project-declaration(dec-type  | Vars()) <+ standard-lib-fun> f => (ts, t) ;
 			<zip(eq-or-nil)> (ts, <map(type-of)> es)
 								
   	type-of : NilExp() 	-> NIL()
 	type-of : NoVal() 	-> NO_VAL()
-	type-of : Seq(es) 	->  <last> <map(type-of)> es 
+	type-of : Seq(es) 	-> <map(type-of) ; last> es 
   	type-of : Int(_) 	-> INT()
 	type-of : String(_) -> STRING()		
  	
@@ -141,12 +141,6 @@
  			<eq-or-nil <+ noval-noval> (t1, t2) => t 
 	
 	type-of :
-		IfThen(e1, e2) -> NO_VAL()
-		where
-			<type-of> e1 => INT() ;
-			<type-of> e2 => NO_VAL()
- 			
-	type-of :
 		While(e1, e2) -> NO_VAL()
 		where
 			<type-of> e1 => INT() ;
@@ -162,7 +156,7 @@
 	type-of : Break() -> NO_VAL()
 	
 	type-of : Let(_, []) 		-> NO_VAL()
-	type-of : Let(_, es@[_|_]) 	-> <last> <map(type-of)> es	
+	type-of : Let(_, es@[_|_]) 	-> <map(type-of) ; last> es	
 
 strategies 
 		

Modified: tiger-spoofax/trans/analysis/types/types.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/types.str	Thu Sep 23 07:45:38 2010	(r21245)
+++ tiger-spoofax/trans/analysis/types/types.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -10,10 +10,10 @@
 	NO_VAL 	: Ty
 
 	NIL 	: Ty	
-	RECORD 	: Id * List(FEntry) -> Ty
-	ARRAY 	: Tid * Tid -> Ty
+	RECORD 	: TypeId * List(FEntry) -> Ty
+	ARRAY 	: TypeId * TypeId -> Ty
 	
-	FIELD	: Id * Tid -> FEntry
+	FIELD	: Id * TypeId -> FEntry
 
 rules
 	
@@ -25,6 +25,6 @@
 	pp: NIL()		-> $["nil"]
 	
 	pp: RECORD(Tid(i), _) -> $["record [i]"]
-	pp: ARRAY(Tid(i), _) -> $["array [i]"]
+	pp: ARRAY(_, Tid(i)) -> $["array [i]"]
 	
 	
\ No newline at end of file

Modified: tiger-spoofax/trans/normal/desugar.str
==============================================================================
--- tiger-spoofax/trans/analysis/normal/desugar.str	Sat Sep 11 08:48:05 2010	(r21233)
+++ tiger-spoofax/trans/normal/desugar.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -2,7 +2,7 @@
 
 imports 
 	include/Tiger
-	analysis/normal/signature
+	normal/signature
 
 strategies
 	
@@ -40,15 +40,19 @@
 	group-decs : [d at VarDec(_, _)    | ds] -> [d | <group-decs> ds]
 	group-decs : [d at VarDec(_, _, _) | ds] -> [d | <group-decs> ds]
 	
-	group-decs : [d at TypeDec(_, _)      | ds] -> <group-decs(is-type-dec)> [d|ds]				
-	group-decs : [d at FunDec(_, _, _)    | ds] -> <group-decs(is-fun-dec)> [d|ds]
-	group-decs : [d at FunDec(_, _, _, _) | ds] -> <group-decs(is-fun-dec)> [d|ds]
+	group-decs : [d at TypeDec(_, _)      | ds] -> <group-decs(is-type-dec)> (ds, [d]) 				
+	group-decs : [d at FunDec(_, _, _)    | ds] -> <group-decs(is-fun-dec)> (ds, [d])
+	group-decs : [d at FunDec(_, _, _, _) | ds] -> <group-decs(is-fun-dec)> (ds, [d])
+	
+	group-decs(s) : ([], ds)	  -> [DecGroup(ds)]
+	group-decs(s) : ([d|ds], gds) -> ds' 
+		where 
+			((<s> d) < 
+				<group-decs(s)> (ds, [d|gds]) 
+			+	![DecGroup(gds)|<group-decs> [d|ds]]
+			) => ds'
 	
 strategies
 	
-	group-decs(s) = 
-		split-fetch-keep(not(s)) => (gdecs, other, decs) < 
-			![DecGroup(gdecs) | <group-decs> [other|decs]] + ![DecGroup(<id>)]
-
 	is-type-dec = ?TypeDec(_,_)
 	is-fun-dec  = ?FunDec(_, _, _) + ?FunDec(_, _, _, _)
\ No newline at end of file

Copied and modified: tiger-spoofax/trans/normal/eval.str (from r21235, tiger-spoofax/trans/analysis/normal/eval.str)
==============================================================================
--- tiger-spoofax/trans/analysis/normal/eval.str	Sat Sep 11 08:50:00 2010	(r21235, copy source)
+++ tiger-spoofax/trans/normal/eval.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -2,8 +2,8 @@
 
 imports
 	include/Tiger
-	analysis/normal/signature
-	analysis/normal/desugar
+	normal/signature
+	normal/desugar
 	
 strategies
 	

Copied and modified: tiger-spoofax/trans/normal/normalise.str (from r21235, tiger-spoofax/trans/analysis/normal/normalise.str)
==============================================================================
--- tiger-spoofax/trans/analysis/normal/normalise.str	Sat Sep 11 08:50:00 2010	(r21235, copy source)
+++ tiger-spoofax/trans/normal/normalise.str	Thu Sep 23 07:53:45 2010	(r21246)
@@ -2,14 +2,63 @@
 
 imports
 	include/Tiger
-	analysis/normal/signature
+	analysis/types/types
+	analysis/types/project
+	
+	normal/signature
+	
+strategies
+	
+	normalise-all = innermost(normalise)
 	
 rules
 
-normalise: For(v, e1, e2, e3) -> Let([decl], [while])
+normalise : VarDec(v, e)    -> VarDec(v, <type-of> e, e) 
+normalise : VarDec(v, t, e) -> VarDec(v, <type-of> t, e) 
+
+normalise : FunDec(f, as, e)    -> FunDec(f, as, NO_VAL(), e)
+normalise : FunDec(f, as, t, e) -> FunDec(f, as, <type-of> t, e)
+
+normalise : 
+	For(v, e1, e2, e3) -> Let([decl], [while]) 
 	where
-		!VarDec(v, Tid("int"), e1) => decl ;
+		!VarDec(v, INT(), e1) => decl ;
 		!Rop(LE(), Var(v), e2) => check ;
 		!Assign(Var(v), Bop(PLUS(), Var(v), Int("1"))) => inc ;
 		!While(check, Seq([e3, inc])) => while
-			
\ No newline at end of file
+	
+normalise : Seq([]) -> NoVal()
+normalise : Seq([e]) -> e
+normalise : Seq([NoVal()|es])  -> Seq(es)
+normalise : Seq([e1,e2,e3|es]) -> Seq([e1, Seq([e2, e3|es])])
+normalise : Seq([Seq(es1)|es2]) -> Seq(<conc> (es1, es2))
+
+rules
+
+normalise : Let(_, []) -> NoVal()
+normalise : Let(ds, [NoVal()|es])  -> Let(ds, es)
+normalise : Let(ds, [e1,e2|es]) -> Let(ds, [Seq([e1, e2|es])])
+	
+normalise : Bop(op, Let(ds, es), e) -> Let(ds, [Bop(op, Seq(es), e)])
+normalise : Bop(op, e, Let(ds, es)) -> Let(ds, [Bop(op, e, Seq(es))])
+normalise : Rop(op, Let(ds, es), e) -> Let(ds, [Rop(op, Seq(es), e)])
+normalise : Rop(op, e, Let(ds, es)) -> Let(ds, [Rop(op, e, Seq(es))])
+
+normalise : Assign(Let(ds, es), e) -> Let(ds, [Assign(Seq(es), e)])
+normalise : Assign(e, Let(ds, es)) -> Let(ds, [Assign(e, Seq(es))])
+
+normalise : Subscript(Let(ds, es), e) -> Let(ds, [Subscript(Seq(es), e)])
+normalise : Subscript(e, Let(ds, es)) -> Let(ds, [Subscript(e, Seq(es))])
+
+normalise : IfThenElse(Let(ds, es), e2, e3) -> Let(ds, [IfThenElse(Seq(es), e2, e3)])
+normalise : IfThenElse(e1, Let(ds, es), e3) -> Let(ds, [IfThenElse(e1, Seq(es), e3)])
+normalise : IfThenElse(e1, e2, Let(ds, es)) -> Let(ds, [IfThenElse(e1, e2, Seq(es))])
+
+normalise : While(Let(ds, es), e2) -> Let(ds, [While(Seq(es), e2)])
+normalise : While(e1, Let(ds, es)) -> Let(ds, [While(e1, Seq(es))])
+
+normalise : Seq([Let(ds, es1)|es2]) -> Let(ds, <conc> (es1, es2))
+normalise : Let(ds1, [Let(ds2, es1)|es2]) -> Let(<conc> (ds1, ds2), <conc> (es1, es2))
+
+normalise : Array(t, Let(ds, es), e) -> Let(ds, [Array(t, Seq(es), e)])
+normalise : Array(t, e, Let(ds, es)) -> Let(ds, [Array(t, e, Seq(es))])

From g.h.wachsmuth at tudelft.nl  Thu Sep 23 09:54:13 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 23 Sep 2010 07:54:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21247 -
	tiger-spoofax/trans/generation
Message-ID: <201009230754.o8N7sDZ0024045@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu Sep 23 07:54:12 2010
New Revision: 21247
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21247&sc=1

Log:
more generation rules

Modified:
   tiger-spoofax/trans/generation/generate.str

Modified: tiger-spoofax/trans/generation/generate.str
==============================================================================
--- tiger-spoofax/trans/generation/generate.str	Thu Sep 23 07:53:45 2010	(r21246)
+++ tiger-spoofax/trans/generation/generate.str	Thu Sep 23 07:54:12 2010	(r21247)
@@ -6,23 +6,28 @@
 	
 	analysis/main
 	
-	analysis/normal/signature
-	analysis/normal/desugar
+	normal/signature
+	normal/desugar
+	normal/normalise
 	
 	analysis/types/types
 	analysis/types/project
 	
 rules
 	
-	// Prints the desugared abstract syntax ATerm of a selection.
 	generate-jbc:
 		(selected, position, ast, path, project-path) -> (filename, result)
 		where
 			<guarantee-extension(|"jbc")> path => filename ;
-			<desugar-all ; to-jbc ; flatten-list ; pp-jbc <+ !""> selected => result
-
+			<debug; normalise-all ; debug; to-jbc ; debug; try(flatten-list) ; pp-jbc <+ !""> selected => result
+		where
+			s := $[aconst_0 [ast]]
 rules
 	
+	to-jbc: Nil() -> ACONST_NULL()
+	to-jbc: NoVal() -> NOP()
+	to-jbc: Seq(es) -> <map(to-jbc)> es
+	
 	to-jbc:	Int(i) -> LDC(Int(i)) 
 	
 	to-jbc: Bop(op, e1, e2) -> [ <to-jbc> e1, <to-jbc> e2, <to-jbc> op ]
@@ -31,34 +36,90 @@
 	to-jbc: MINUS()	-> ISUB()
 	to-jbc: MUL() 	-> IMUL()
 	to-jbc: DIV()	-> IDIV()
+
+	to-jbc: Assign(lhs, e) -> [ <to-jbc> e, <lhs-to-jbc> lhs ]
+	
+	to-jbc: 	Var(x) -> ILOAD(x) where <type-of> Var(x) => INT()
+	lhs-to-jbc: Var(x) -> ISTORE(x) where <type-of> Var(x) => INT()
 	
+	//to-jbc: 
+	//	While(e1, e2) -> [Label(check), <to-jbc> e1, IFEQ(LabelRef(end)), <to-jbc> e2, GOTO(LabelRef(check)), Label(end) ]
+	//	where <newname> "test" => check
+	//	where <newname> "end" => end
+	
+	to-jbc:
+		IfThenElse(e1, e2, e3) -> [ <to-jbc> e1, 
+									IFEQ(LabelRef(else)), 
+									<to-jbc> e2, 
+									GOTO(LabelRef(end)), 
+									Label(else), 
+									<to-jbc> e3, 
+									Label(end) ]
+		where <newname> "else" => else
+		where <newname> "end"  => end
+	
+	to-jbc: 
+		While(e1, e2) -> [ GOTO(LabelRef(check)), 
+						   Label(body), 
+						   <to-jbc> e2, 
+						   Label(check), 
+						   <to-jbc> e1, 
+						   IFNE(LabelRef(body))]
+		where <newname> "test" => check
+		where <newname> "body" => body
+				
+	to-jbc(|label):
+		Rop(op, e1, e2) -> [ <to-jbc> e1 ,
+							 <to-jbc> e2 , 
+							 <to-jbc(|label)> (type, op) ]
+							 
+		where <eq-or-nil> (<type-of> e1, <type-of> e2) => type
+		
 	to-jbc: 
-		Rop(op, e1, e2)    -> [ <to-jbc> e1, 
-							 	<to-jbc> e2, 
-								cmp, 
-								ICONST_1(), 
-								GOTO(LabelRef(l2)),
-								Label(l1),
-								ICONST_0(),
-								Label(l2) ]
+		Rop(op, e1, e2) -> [ <to-jbc> e1, 
+						 	 <to-jbc> e2, 
+							 cmp, 
+							 LDC(Int("0")), 
+							 GOTO(LabelRef(l2)),
+							 Label(l1),
+							 LDC(Int("1")), 
+							 Label(l2) ]
 		where
 			<newname> "label" => l1 ;
 			<newname> "label" => l2 ;
 			<eq-or-nil> (<type-of> e1, <type-of> e2) => t; 
 			<to-jbc(|l1)> (t, op) => cmp 
 	
-	to-jbc(|l): (INT(), EQ()) -> IF_ICMPEQ(LabelRef(l))
-	to-jbc(|l): (INT(), NE()) -> IF_ICMPNE(LabelRef(l))
-	to-jbc(|l): (INT(), LT()) -> IF_ICMPLT(LabelRef(l))
-	to-jbc(|l): (INT(), LE()) -> IF_ICMPLE(LabelRef(l))
-	
+	to-jbc(|label): (INT(), EQ()) -> IF_ICMPEQ(LabelRef(label))
+	to-jbc(|label): (INT(), NE()) -> IF_ICMPNE(LabelRef(label))
+	to-jbc(|label): (INT(), LT()) -> IF_ICMPLT(LabelRef(label))
+	to-jbc(|label): (INT(), LE()) -> IF_ICMPLE(LabelRef(label))
+				
 	pp-jbc: [] 			-> $[]
 	pp-jbc: [i|is] 		-> $[[<pp-jbc> i]
 							 [<pp-jbc> is]]
 	
-	pp-jbc: LDC(Int(i)) -> $[ldc [i]]
-	pp-jbc: IADD() 		-> $[iadd]
-	pp-jbc: ISUB() 		-> $[isub]
-	pp-jbc: IMUL() 		-> $[imul]
-	pp-jbc: IDIV() 		-> $[idiv]
+	pp-jbc: ACONST_NULL()	-> $[aconst_null]
+	pp-jbc: LDC(Int(i)) 	-> $[ldc [i]]
+	pp-jbc: IADD() 			-> $[iadd]
+	pp-jbc: ISUB() 			-> $[isub]
+	pp-jbc: IMUL() 			-> $[imul]
+	pp-jbc: IDIV() 			-> $[idiv]
+	
+	pp-jbc: ISTORE(x)		-> $[istore [x]]
+	pp-jbc: ILOAD(x)		-> $[iload [x]]
+	pp-jbc: ASTORE(x)		-> $[astore [x]]
+	pp-jbc: ALOAD(x)		-> $[aload [x]]
+	
+	pp-jbc: Label(l) 			-> $[[l]: ]
+	pp-jbc: GOTO(LabelRef(l)) 	-> $[goto [l]]
+	pp-jbc: IFEQ(LabelRef(l)) 	-> $[ifeq [l]]
+	pp-jbc: IFNE(LabelRef(l)) 	-> $[ifne [l]]
+	
+	pp-jbc: IF_ICMPEQ(LabelRef(l)) 	-> $[if_icmpeq [l]]
+	pp-jbc: IF_ICMPNE(LabelRef(l)) 	-> $[if_icmpne [l]]
+	pp-jbc: IF_ICMPLE(LabelRef(l)) 	-> $[if_icmple [l]]
+	pp-jbc: IF_ICMPLT(LabelRef(l)) 	-> $[if_icmplt [l]]
+	
+	pp-jbc: NOP()	-> $[nop]
 	
\ No newline at end of file

From g.h.wachsmuth at tudelft.nl  Thu Sep 23 09:55:09 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 23 Sep 2010 07:55:09 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21248 -
	tiger-spoofax/trans/editor
Message-ID: <201009230755.o8N7t959024062@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu Sep 23 07:55:09 2010
New Revision: 21248
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21248&sc=1

Log:
new namespace library
better completion support

Modified:
   tiger-spoofax/trans/editor/complete.str
   tiger-spoofax/trans/editor/resolve.str

Modified: tiger-spoofax/trans/editor/complete.str
==============================================================================
--- tiger-spoofax/trans/editor/complete.str	Thu Sep 23 07:54:12 2010	(r21247)
+++ tiger-spoofax/trans/editor/complete.str	Thu Sep 23 07:55:09 2010	(r21248)
@@ -5,6 +5,7 @@
 	lib/namespace
 	
 	analysis/names/namespaces
+	analysis/names/project
 	
 imports
 	include/Tiger
@@ -19,24 +20,21 @@
     	where
 			editor-init ;
 			<analyse> ast ;
-			<Propose> node => proposals
-
+			<propose-analysed> node => proposals
+	
+	propose-analysed = ?Var(COMPLETION(_)) ; !( <get-proposals(var-name|Vars())>, <get-proposals(fun-name|Vars()); map(!(<id>, "()") ; conc-strings)> ) ; conc
+	
+	
+	propose-analysed = ?Call(COMPLETION(_), _) ; get-proposals(fun-name|Vars()) 
+	
+	propose-analysed = ?Tid(COMPLETION(_)) ; get-proposals
+	
 rules
 	
-	propose:	
-		n at Var(COMPLETION(p)) -> Var(COMPLETION(p)) 
-		where 	
-			<get-all-renames> Vars() => proposals  
-		where rules (
-			Propose: n -> proposals
-		)
-		
-	propose:	
-		n at Tid(COMPLETION(p)) -> Tid(COMPLETION(p)) 
-		where 	
-			<get-all-renames> Types() => proposals  
-		where rules (
-			Propose: n -> proposals
-		)
+	propose = ?Var(COMPLETION(_)) ; store-proposal-candidates(|Vars())
+	
+	propose = ?Call(COMPLETION(_), _) ; store-proposal-candidates(|Vars())	
+	
+	propose = ?Tid(COMPLETION(_)) ; store-proposal-candidates(|Types()) 
 		
 	
\ No newline at end of file

Modified: tiger-spoofax/trans/editor/resolve.str
==============================================================================
--- tiger-spoofax/trans/editor/resolve.str	Thu Sep 23 07:54:12 2010	(r21247)
+++ tiger-spoofax/trans/editor/resolve.str	Thu Sep 23 07:55:09 2010	(r21248)
@@ -28,9 +28,9 @@
 
 rules
 	
-	resolve : Tid(t) 	 -> <project-declaration(type-name)> (Types(), t)  //where <debug> (t, t)
-	resolve : Var(x) 	 -> <project-declaration(var-name)> (Vars(), x)  
-	resolve : Call(f, _) -> <project-declaration(fun-name)> (Vars(), f)  //where <debug> (f, f)
+	resolve : Tid(t) 	 -> <project-declaration(type-name | Types())> t
+	resolve : Var(x) 	 -> <project-declaration(var-name | Vars())> x
+	resolve : Call(f, _) -> <project-declaration(fun-name | Vars())> f
 
 	resolve : 
 		FieldVar(e, f) -> fdef

From g.h.wachsmuth at tudelft.nl  Thu Sep 23 09:55:35 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 23 Sep 2010 07:55:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21249 -
	tiger-spoofax/trans
Message-ID: <201009230755.o8N7tZKr024071@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu Sep 23 07:55:35 2010
New Revision: 21249
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21249&sc=1

Log:


Modified:
   tiger-spoofax/trans/tiger.str

Modified: tiger-spoofax/trans/tiger.str
==============================================================================
--- tiger-spoofax/trans/tiger.str	Thu Sep 23 07:55:09 2010	(r21248)
+++ tiger-spoofax/trans/tiger.str	Thu Sep 23 07:55:35 2010	(r21249)
@@ -8,8 +8,8 @@
 	
 	analysis/main
 	
-	analysis/normal/desugar
-	analysis/normal/eval
+	normal/desugar
+	normal/eval
 	analysis/names/type-rename
 	
 	editor/resolve

From n.bruning at student.tudelft.nl  Thu Sep 23 14:43:05 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Thu, 23 Sep 2010 12:43:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21250 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <201009231243.o8NCh5a5029257@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Thu Sep 23 12:43:05 2010
New Revision: 21250
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21250&sc=1

Log:
Enable refreshing of projects, not just files

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	Thu Sep 23 07:55:35 2010	(r21249)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	Thu Sep 23 12:43:05 2010	(r21250)
@@ -3,7 +3,7 @@
 import java.io.File;
 import java.io.FileNotFoundException;
 
-import org.eclipse.core.resources.IFile;
+import org.eclipse.core.resources.IResource;
 import org.spoofax.interpreter.library.IOperatorRegistry;
 import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoTerm;
@@ -51,7 +51,7 @@
 		}
 		
 		AstNode result = imploder.implode(asfixATerm, tokenizer);
-		IFile resource;
+		IResource resource;
 		try {
 			resource = RefreshResourcePrimitive.getResource(inputFile);
 		} catch (FileNotFoundException e) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	Thu Sep 23 07:55:35 2010	(r21249)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	Thu Sep 23 12:43:05 2010	(r21250)
@@ -8,7 +8,6 @@
 import java.io.FileNotFoundException;
 import java.net.URI;
 
-import org.eclipse.core.resources.IFile;
 import org.eclipse.core.resources.IResource;
 import org.eclipse.core.resources.IWorkspace;
 import org.eclipse.core.resources.ResourcesPlugin;
@@ -75,7 +74,7 @@
 		return true;
 	}
 
-	public static IFile getResource(IContext env, String file) throws FileNotFoundException {
+	public static IResource getResource(IContext env, String file) throws FileNotFoundException {
 		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
 		File file2 = new File(file);
 		if (!file2.exists() && !file2.isAbsolute())
@@ -83,14 +82,14 @@
 		return getResource(file2);
 	}
 
-	public static IFile getResource(File file) throws FileNotFoundException {
+	public static IResource getResource(File file) throws FileNotFoundException {
 		if (file == null) {
 			assert false : "file should not be null";
 			return null;
 		}
 		URI uri = file.toURI();
 		IWorkspace workspace = ResourcesPlugin.getWorkspace();
-		IFile[] resources = workspace.getRoot().findFilesForLocationURI(uri);
+		IResource[] resources = workspace.getRoot().findContainersForLocationURI(uri);
 		if (resources.length == 0)
 			throw new FileNotFoundException("File not in workspace: " + file);
 		return resources[0];

From n.bruning at student.tudelft.nl  Thu Sep 23 14:43:27 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Thu, 23 Sep 2010 12:43:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21251 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009231243.o8NChRZ9029264@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Thu Sep 23 12:43:27 2010
New Revision: 21251
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21251&sc=1

Log:
Avoid java exception on error

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Thu Sep 23 12:43:05 2010	(r21250)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Thu Sep 23 12:43:27 2010	(r21251)
@@ -189,6 +189,7 @@
 				} else if (!isTermTuple(resultTerm) || !isTermString(termAt(resultTerm, 0))) {
 					Environment.logException("Illegal builder result (must be a filename/string tuple or None())");
 					openError(editor, "Illegal builder result (must be a filename/string tuple or None()): " + resultTerm);
+					return;
 				}
 	
 				file = getFile(resultTerm);

From n.bruning at student.tudelft.nl  Fri Sep 24 14:38:31 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Fri, 24 Sep 2010 12:38:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21252 - in
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime:
	services stratego
Message-ID: <201009241238.o8OCcV4b021244@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Fri Sep 24 12:38:31 2010
New Revision: 21252
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21252&sc=1

Log:
Add static getFile() method to get a file resource

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	Thu Sep 23 12:43:27 2010	(r21251)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	Fri Sep 24 12:38:31 2010	(r21252)
@@ -72,7 +72,7 @@
 					String file = asJavaString(termAt(result, 0));
 					String contents = asJavaString(termAt(result, 1));
 					try {
-						IFile resource = RefreshResourcePrimitive.getResource(runtime.getRuntime().getContext(), file);
+						IFile resource = RefreshResourcePrimitive.getFile(runtime.getRuntime().getContext(), file);
 						StrategoBuilder.setFileContentsDirect(resource, contents);
 					} catch (FileNotFoundException e) {
 						Environment.logException("Problem when handling on save event", e);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Thu Sep 23 12:43:27 2010	(r21251)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Fri Sep 24 12:38:31 2010	(r21252)
@@ -252,7 +252,7 @@
 
 	private IFile getFile(IStrategoTerm resultTerm) throws FileNotFoundException {
 		String filename = asJavaString(termAt(resultTerm, 0));
-		IFile result = RefreshResourcePrimitive.getResource(
+		IFile result = RefreshResourcePrimitive.getFile(
 				observer.getRuntime().getContext(), filename);
 		return result;
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java	Thu Sep 23 12:43:27 2010	(r21251)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java	Fri Sep 24 12:38:31 2010	(r21252)
@@ -5,7 +5,6 @@
 import java.io.FileInputStream;
 
 import org.eclipse.core.resources.IProject;
-import org.eclipse.core.resources.ResourcesPlugin;
 import org.eclipse.core.runtime.IPath;
 import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.IStatus;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	Thu Sep 23 12:43:27 2010	(r21251)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	Fri Sep 24 12:38:31 2010	(r21252)
@@ -8,6 +8,7 @@
 import java.io.FileNotFoundException;
 import java.net.URI;
 
+import org.eclipse.core.resources.IFile;
 import org.eclipse.core.resources.IResource;
 import org.eclipse.core.resources.IWorkspace;
 import org.eclipse.core.resources.ResourcesPlugin;
@@ -74,6 +75,16 @@
 		return true;
 	}
 
+	public static IFile getFile(IContext env, String file) throws FileNotFoundException {
+		
+		IResource res = getResource(env, file);
+		if (res.getType() == IResource.FILE) {
+			return (IFile)res;
+		}
+		throw new FileNotFoundException("Resource is not a file: " + file);
+		
+	}
+	
 	public static IResource getResource(IContext env, String file) throws FileNotFoundException {
 		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
 		File file2 = new File(file);

From n.bruning at student.tudelft.nl  Fri Sep 24 14:39:04 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Fri, 24 Sep 2010 12:39:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21253 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009241239.o8OCd42h021266@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Fri Sep 24 12:39:04 2010
New Revision: 21253
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21253&sc=1

Log:
Prevent analyzing the same file multiple times

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Fri Sep 24 12:38:31 2010	(r21252)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoAnalysisQueue.java	Fri Sep 24 12:39:04 2010	(r21253)
@@ -1,6 +1,7 @@
 package org.strategoxt.imp.runtime.services;
 
 import java.util.concurrent.CancellationException;
+import java.util.concurrent.ConcurrentHashMap;
 import java.util.concurrent.PriorityBlockingQueue;
 
 import org.eclipse.core.resources.IProject;
@@ -34,6 +35,8 @@
 	private static final long serialVersionUID = 1L;
 
 	private final PriorityBlockingQueue<UpdateJob> queue;
+	
+	private final ConcurrentHashMap<IPath,UpdateJob> pendingUpdates = new ConcurrentHashMap<IPath, UpdateJob>();
 
 	/*
 	 * Indicates whether a job is currently running.
@@ -52,13 +55,16 @@
 		private boolean cancelled;
 		
 		private MonitorStateWatchDog protector;
+		
+		private IPath path;
 
 		protected UpdateJob(StrategoAnalysisJob job, IPath path, int priority, boolean isSystem,
 				long delay) {
 			super("");
 			this.job = job;
 			this.delay = delay;
-
+			this.path = path;
+		
 			// Should be set before scheduling the job
 			this.setName(JOB_DESCRIPTION + path);
 
@@ -78,6 +84,7 @@
 
 			IStatus status;
 			try {
+				pendingUpdates.remove(this.path);
 				status = job.analyze(monitor);
 			} catch (CancellationException e) {
 				status = Status.CANCEL_STATUS;
@@ -208,8 +215,14 @@
 	public UpdateJob queueAnalysis(IPath path, IProject project) {
 
 		StrategoObserverBackgroundUpdateJob job = new StrategoObserverBackgroundUpdateJob(path, project);
-
-		UpdateJob updateJob = new UpdateJob(job, path, UpdateJob.BACKGROUND, true, 0);
+		
+		// See if an update is already pending for this path
+		IPath absolutePath = project.getLocation().append(path);
+		UpdateJob pendingUpdate = pendingUpdates.get(absolutePath);
+		if (pendingUpdate != null) return pendingUpdate;
+		
+		UpdateJob updateJob = new UpdateJob(job, absolutePath, UpdateJob.BACKGROUND, true, 0);
+		pendingUpdates.put(absolutePath, updateJob);
 		add(updateJob);
 		wake();
 

From g.h.wachsmuth at tudelft.nl  Mon Sep 27 15:35:48 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Mon, 27 Sep 2010 13:35:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21254 -
	tiger-spoofax/lib
Message-ID: <201009271335.o8RDZmA9014418@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Mon Sep 27 13:35:48 2010
New Revision: 21254
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21254&sc=1

Log:


Deleted:
   tiger-spoofax/lib/namespace.str

From g.h.wachsmuth at tudelft.nl  Mon Sep 27 15:36:08 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Mon, 27 Sep 2010 13:36:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21255 -
	tiger-spoofax/lib
Message-ID: <201009271336.o8RDa8rT014422@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Mon Sep 27 13:36:07 2010
New Revision: 21255
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21255&sc=1

Log:
new version

Added:
   tiger-spoofax/lib/namespace.str

Added: tiger-spoofax/lib/namespace.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ tiger-spoofax/lib/namespace.str	Mon Sep 27 13:36:07 2010	(r21255)
@@ -0,0 +1,95 @@
+module lib/namespace
+
+rules // scoped renaming
+	
+	new-scope(s) :
+		x -> y
+		where
+			<newname> x => scope ;
+			{| Renamed, RenamedInScope, CurrentScope:
+				rules (CurrentScope: _ -> scope) ;
+				<s> x => y
+			|} 
+			
+	rename-declaration(|namespace) : 
+		x -> x'
+		where 
+			CurrentScope => scope ;
+			(
+				<RenamedInScope> (namespace, scope, x) => x' <+
+				x' := x{<newname> x}
+			)
+		where rules(
+			RenamedInScope: (namespace, scope, x) -> x' 
+			Renamed: (namespace, x) -> x'
+		)
+	
+	rename-reference(|namespace) :
+		x -> x'
+		where
+			<Renamed> (namespace, x) => x'
+
+rules // store declarations and references
+	
+	new-analysis(s) = {| Declared, Referred: s |}
+		
+	store-declaration(|namespace) :
+		(x, d) -> d
+		where rules(
+			Declared:+ (namespace, x) -> d
+		)
+		
+	store-reference(|namespace) :
+		x -> x
+		where rules (
+			Referred:+ (namespace, x) -> x
+		)	
+		
+strategies // access declarations
+	
+	get-declarations(|namespace) = !(namespace, <id>) ; bagof-Declared
+	
+	is-declared(|namespace) = get-declarations(|namespace) ; ?[_|_]
+	
+	get-unique-declaration(|namespace) = get-declarations(|namespace) ; ?[<id>]
+	
+strategies // project declarations
+	
+	get-declaration(s|namespace) = get-declarations(|namespace) ; fetch-elem(where(s)) 
+	
+	get-declarations(s|namespace) = get-declarations(|namespace) ; filter(where(s)) 
+	
+	project-declaration(s|namespace) = get-declarations(|namespace) ; fetch-elem(s) 
+
+	project-declarations(s|namespace) = get-declarations(|namespace) ; filter(s) 
+		
+strategies // access all declarations
+	
+	get-all-declarations(|namespace) = all-keys-Declared ; filter(?(namespace, _) ; Declared)
+	
+	get-all-declarations(s|namespace) = get-all-declarations(|namespace) ; filter(where(s)) 
+
+	project-all-declarations(s|namespace) = get-all-declarations(|namespace) ; filter(s) 
+	 
+strategies // access references
+
+	get-references(|namespace) = !(namespace, <id>) ; bagof-Referred
+	
+	is-referred(|namespace) = get-references(|namespace) ; ?[_|_]
+
+strategies	
+	
+	get-proposal-candidates(|namespace) = all-keys-Renamed ; filter(?(namespace, _) ; Renamed)
+	
+	store-proposal-candidates(|namespace) = get-proposal-candidates(|namespace) ; store-proposals
+	
+	store-proposals = ?x ; where (rules ( Propose : () -> x ))
+	
+	get-proposals = ( <Propose> () ; map(rm-annotations) ) <+ ![]
+	
+	get-proposals(s|namespace) = 
+		( 
+			<Propose> () ; 
+			filter(where( get-declaration(s|namespace) )) ; 
+			map(rm-annotations) 
+		) <+ ![]

From g.h.wachsmuth at tudelft.nl  Mon Sep 27 15:36:24 2010
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Mon, 27 Sep 2010 13:36:24 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21256 -
	tiger-spoofax/trans/analysis/types
Message-ID: <201009271336.o8RDaOx3014429@proliant.st.ewi.tudelft.nl>

Author: GuidoWachsmuth
Date: Mon Sep 27 13:36:23 2010
New Revision: 21256
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21256&sc=1

Log:
bug fixing

Modified:
   tiger-spoofax/trans/analysis/types/check.str
   tiger-spoofax/trans/analysis/types/project.str
   tiger-spoofax/trans/analysis/types/types.str

Modified: tiger-spoofax/trans/analysis/types/check.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/check.str	Mon Sep 27 13:36:07 2010	(r21255)
+++ tiger-spoofax/trans/analysis/types/check.str	Mon Sep 27 13:36:23 2010	(r21256)
@@ -132,7 +132,20 @@
 	editor-error:
 		For(v, e1, e2, e3) -> errors
 		where <filter(check-exp(eq))> [(e1, INT()), (e2, INT()), (e3, NO_VAL())] => errors
+
+rules // function declarations
 	
+	editor-error:
+		FunDec(f, as, e) -> (f, $[Function body is of type [<pp> t] instead of type [<pp> NO_VAL()].])
+		where <type-of> e => t
+		where not (<eq> (NO_VAL(), t))
+
+	editor-error:
+		FunDec(f, as, t, e) -> (f, $[Function body is of type [<pp> t1] instead of type [<pp> t2].])
+		where <type-of> e => t1
+		where <type-of> t => t2
+		where not (<eq-or-nil> (t2, t1))
+		
 rules
 		
 	check-exp(eq):

Modified: tiger-spoofax/trans/analysis/types/project.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/project.str	Mon Sep 27 13:36:07 2010	(r21255)
+++ tiger-spoofax/trans/analysis/types/project.str	Mon Sep 27 13:36:23 2010	(r21256)
@@ -37,16 +37,16 @@
 			<primitive-type> i => t
 
 	declared-type : 
-		(t1, t2, NameTy(Tid(t3))) -> t
+		(Tid(t1), _, NameTy(Tid(t3))) -> t
 		where 
 			(
 				not( <eq> (t1, t3) ) ;
 				<project-declaration(dec-type | Types())> t3 => d ;
-				<declared-type> (t1, t3, d) => t
+				<declared-type> (Tid(t1), Tid(t3), d) => t
 			) <+  
 			<primitive-type> t3 => t 
 				
-	declared-type : (t1, t2, ArrayTy(t3)) 	-> ARRAY(t2, t3)
+	declared-type : (_, t2, ArrayTy(t3)) 	-> ARRAY(t2, t3)
 	declared-type : (_, t, RecordTy(fs)) 	-> RECORD(t, <map(declared-field)> fs)
 	
 	declared-field : Field(f, t) -> FIELD(f, t)
@@ -104,7 +104,7 @@
 	type-of :
 		Record(tn, inits) -> t
 		where
-			<type-of> tn => t at RECORD(tn, fields) ;
+			<type-of> tn => t at RECORD(_, fields) ;
 			<zip(check-field)> (inits, fields)
 			
 	check-field :
@@ -117,7 +117,7 @@
 	type-of :
 		Array(tn, e1, e2) -> t
 		where
-			<type-of> tn => t at ARRAY(tn, vtn) ;
+			<type-of> tn => t at ARRAY(_, vtn) ;
 			<type-of> vtn => vt1 ;
 			<type-of> e1 => INT() ;
 			<type-of> e2 => vt2 ;

Modified: tiger-spoofax/trans/analysis/types/types.str
==============================================================================
--- tiger-spoofax/trans/analysis/types/types.str	Mon Sep 27 13:36:07 2010	(r21255)
+++ tiger-spoofax/trans/analysis/types/types.str	Mon Sep 27 13:36:23 2010	(r21256)
@@ -25,6 +25,6 @@
 	pp: NIL()		-> $["nil"]
 	
 	pp: RECORD(Tid(i), _) -> $["record [i]"]
-	pp: ARRAY(_, Tid(i)) -> $["array [i]"]
+	pp: ARRAY(Tid(t), Tid(i)) -> $["[t]: array [i]"]
 	
 	
\ No newline at end of file

From L.C.L.Kats at tudelft.nl  Wed Sep 29 10:43:58 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 29 Sep 2010 08:43:58 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21257 - in
	spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.updatesite
Message-ID: <201009290843.o8T8hwGi024627@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Wed Sep 29 08:43:56 2010
New Revision: 21257
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21257&sc=1

Log:
Release 0.5.3.5

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Mon Sep 27 13:36:23 2010	(r21256)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Wed Sep 29 08:43:56 2010	(r21257)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.5.3.4"
+      version="0.5.3.5"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Mon Sep 27 13:36:23 2010	(r21256)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Wed Sep 29 08:43:56 2010	(r21257)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.5.3.4.jar" id="org.strategoxt.imp" version="0.5.3.4">
+   <feature url="features/org.strategoxt.imp_0.5.3.5.jar" id="org.strategoxt.imp" version="0.5.3.5">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">

From L.C.L.Kats at tudelft.nl  Wed Sep 29 10:47:40 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 29 Sep 2010 08:47:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21258 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009290847.o8T8le6s024671@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Wed Sep 29 08:47:40 2010
New Revision: 21258
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21258&sc=1

Log:
Fixed null-pointer exception (Spoofax/260)

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	Wed Sep 29 08:43:56 2010	(r21257)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	Wed Sep 29 08:47:40 2010	(r21258)
@@ -122,7 +122,8 @@
 			return createErrorProposal("No proposals available - completion lexical must allow letters and numbers", offset);
 		
 		RootAstNode ast = constructAst(getParser(controller), offset, document);
-		Set<String> sorts = new AstSortInspector(ast).getSortsAtOffset(offset - currentCompletionPrefix.length(), offset);
+		int prefixLength = currentCompletionPrefix == null ? 0 : currentCompletionPrefix.length();
+		Set<String> sorts = new AstSortInspector(ast).getSortsAtOffset(offset - prefixLength, offset);
 		if (currentCompletionNode == null)
 			return getParseFailureProposals(controller, document, offset, sorts);
 

From R.B.Vermaas at tudelft.nl  Wed Sep 29 12:04:59 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 29 Sep 2010 10:04:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21259 - hydra/webdsl
Message-ID: <201009291004.o8TA4xUf026104@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Wed Sep 29 10:04:58 2010
New Revision: 21259
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21259&sc=1

Log:
remove dummy argument for mkOverride

Modified:
   hydra/webdsl/machine.nix

Modified: hydra/webdsl/machine.nix
==============================================================================
--- hydra/webdsl/machine.nix	Wed Sep 29 08:47:40 2010	(r21258)
+++ hydra/webdsl/machine.nix	Wed Sep 29 10:04:58 2010	(r21259)
@@ -1,6 +1,6 @@
 { config, pkgs, ... }:
 {
-  virtualisation.memorySize = pkgs.lib.mkOverride 150 {} 2047;
+  virtualisation.memorySize = pkgs.lib.mkOverride 150 2047;
   virtualisation.diskSize = 2048;
   environment.systemPackages = [ pkgs.firefox pkgs.ant pkgs.jdk pkgs.subversion pkgs.maven2 ];
   system.copySystemConfiguration = false;

From R.B.Vermaas at tudelft.nl  Wed Sep 29 13:16:40 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 29 Sep 2010 11:16:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21260 -
	strategoxt-manual/trunk/doc/tutorial/library
Message-ID: <201009291116.o8TBGeAP027235@proliant.st.ewi.tudelft.nl>

Author: rob
Date: Wed Sep 29 11:16:39 2010
New Revision: 21260
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21260&sc=1

Log:
fix StrategoXT/840: fetch -> fetch-elem

Modified:
   strategoxt-manual/trunk/doc/tutorial/library/lists.xml

Modified: strategoxt-manual/trunk/doc/tutorial/library/lists.xml
==============================================================================
--- strategoxt-manual/trunk/doc/tutorial/library/lists.xml	Wed Sep 29 10:04:58 2010	(r21259)
+++ strategoxt-manual/trunk/doc/tutorial/library/lists.xml	Wed Sep 29 11:16:39 2010	(r21260)
@@ -88,11 +88,11 @@
 </screen>  
 
   <para>
-    Finally, the <code>fetch(s)</code> strategy can be used to find
+    Finally, the <code>fetch-elem(s)</code> strategy can be used to find
     the first element for which <code>s</code> succeeds:
   </para>
 <screen>
-<prompt>stratego></prompt> &lt;fetch(?2)> [1,2,3]
+<prompt>stratego></prompt> &lt;fetch-elem(?2)> [1,2,3]
 2
 </screen>  
 

From L.C.L.Kats at tudelft.nl  Thu Sep 30 10:44:40 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 30 Sep 2010 08:44:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21261 -
	spoofax-imp/trunk/org.eclipse.imp
Message-ID: <201009300844.o8U8ieDB014145@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Thu Sep 30 08:44:40 2010
New Revision: 21261
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21261&sc=1

Log:
Spoofax/178: toggle comment is broken

Modified:
   spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch

Modified: spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch
==============================================================================
--- spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	Wed Sep 29 11:16:39 2010	(r21260)
+++ spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	Thu Sep 30 08:44:40 2010	(r21261)
@@ -81,6 +81,262 @@
  
      public void initialize() {
          IRegionSelectionService regionSelector= (IRegionSelectionService) fTextEditor.getAdapter(IRegionSelectionService.class);
+Index: org.eclipse.imp.runtime/src/org/eclipse/imp/editor/StructuredSourceViewer.java
+===================================================================
+--- org.eclipse.imp.runtime/src/org/eclipse/imp/editor/StructuredSourceViewer.java	(revision 22255)
++++ org.eclipse.imp.runtime/src/org/eclipse/imp/editor/StructuredSourceViewer.java	(working copy)
+@@ -7,7 +7,6 @@
+ *
+ * Contributors:
+ *    Robert Fuhrer (rfuhrer at watson.ibm.com) - initial API and implementation
+-
+ *******************************************************************************/
+ 
+ package org.eclipse.imp.editor;
+@@ -16,6 +15,7 @@
+ 
+ import org.eclipse.imp.editor.UniversalEditor.StructuredSourceViewerConfiguration;
+ import org.eclipse.imp.parser.IParseController;
++import org.eclipse.imp.runtime.RuntimePlugin;
+ import org.eclipse.imp.services.IAutoEditStrategy;
+ import org.eclipse.imp.services.ILanguageSyntaxProperties;
+ import org.eclipse.imp.services.base.DefaultAutoIndentStrategy;
+@@ -63,7 +63,6 @@
+      */
+     public static final int MARK_OCCURRENCES= 55;
+ 
+-    // mmk 4/8/08
+     /**
+      * Text operation code for indenting the currently selected text.
+      */
+@@ -77,16 +76,8 @@
+ 
+     private IAutoEditStrategy fAutoEditStrategy;
+ 
+-    // SMS 29 May 2007
+     private IParseController fParseController;
+     
+-    /**
+-     * Is this source viewer configured?
+-     *
+-     * @since 3.0
+-     */
+-    private boolean fIsConfigured;
+-
+     public StructuredSourceViewer(Composite parent, IVerticalRuler verticalRuler, IOverviewRuler overviewRuler, boolean showAnnotationsOverview, int styles) {
+         super(parent, verticalRuler, overviewRuler, showAnnotationsOverview, styles);
+     }
+@@ -139,8 +130,7 @@
+         }
+         super.doOperation(operation);
+     }
+-    
+-    // SMS 29 May 2007 (see doToggleComment())
++
+     public void setParseController(IParseController parseController) {
+     	fParseController = parseController;
+     }
+@@ -152,13 +142,14 @@
+     private void doToggleComment() {
+         ILanguageSyntaxProperties syntaxProps= fParseController.getSyntaxProperties();
+ 
+-        if (syntaxProps == null)
++        // LK: single line comment prefix can be null
++        if (syntaxProps == null || syntaxProps.getSingleLineCommentPrefix() == null)
+             return;
+ 
+         IDocument doc= this.getDocument();
+         DocumentRewriteSession rewriteSession= null;
+         Point p= this.getSelectedRange();
+-        final String lineCommentStart= syntaxProps.getSingleLineCommentPrefix();
++        final String lineCommentPrefix= syntaxProps.getSingleLineCommentPrefix();
+ 
+     	if (doc instanceof IDocumentExtension4) {
+     	    IDocumentExtension4 extension= (IDocumentExtension4) doc;
+@@ -172,22 +163,35 @@
+             final int startLine= doc.getLineOfOffset(selStart);
+             int endLine= doc.getLineOfOffset(selEnd);
+ 
+-            if (selLen > 0 && doc.getChar(selEnd - 1) == '\n')
++            if (selLen > 0 && lookingAtLineEnd(doc, selEnd))
+                 endLine--;
++
++            boolean linesAllHaveCommentPrefix= linesHaveCommentPrefix(doc, lineCommentPrefix, startLine, endLine);
++        	boolean useCommonLeadingSpace= true; // take from a preference?
++			int leadingSpaceToUse= useCommonLeadingSpace ? calculateLeadingSpace(doc, startLine, endLine) : 0;
++
+             for(int line= startLine; line <= endLine; line++) {
+-                int lineStartOffset= doc.getLineOffset(line);
+-                int offset= lineStartOffset;
++                int lineStart= doc.getLineOffset(line);
++                int lineEnd= lineStart + doc.getLineLength(line) - 1;
+ 
+-                while (Character.isWhitespace(doc.getChar(offset)) && offset < doc.getLength())
+-                    offset++;
+-                if (doc.get(offset, lineCommentStart.length()).equals(lineCommentStart)) {
+-                    int len= lineCommentStart.length();
+-
+-                    while (Character.isWhitespace(doc.getChar(offset + len)))
+-                        len++;
+-                    doc.replace(offset, len, "");
+-                } else
+-                    doc.replace(offset, 0, lineCommentStart + " ");
++                if (linesAllHaveCommentPrefix) {
++                	// remove the comment prefix from each line, wherever it occurs in the line
++                	int offset= lineStart;
++                    while (Character.isWhitespace(doc.getChar(offset)) && offset < lineEnd) {
++                        offset++;
++                    }
++                    // LK: remove additional space after comment prefix
++                    int offsetEnd = offset + lineCommentPrefix.length();
++					if (offsetEnd < lineEnd && doc.getChar(offsetEnd) == ' ') {
++						doc.replace(offset, lineCommentPrefix.length() + 1, "");
++					} else {
++						doc.replace(offset, lineCommentPrefix.length(), "");
++					}
++                } else {
++                	// add the comment prefix to each line, after however many spaces leadingSpaceToAdd indicates
++                	int offset= lineStart + leadingSpaceToUse;
++                	doc.replace(offset, 0, lineCommentPrefix + " ");
++                }
+             }
+         } catch (BadLocationException e) {
+             e.printStackTrace();
+@@ -200,8 +204,54 @@
+         }
+     }
+ 
+-    // mmk 4/8/08
+-    private void doIndentLines() {
++    private int calculateLeadingSpace(IDocument doc, int startLine, int endLine) {
++    	try {
++        	int result= Integer.MAX_VALUE;
++        	for(int line= startLine; line <= endLine; line++) {
++        		int lineStart= doc.getLineOffset(line);
++        		int lineEnd= lineStart + doc.getLineLength(line) - 1;
++        		int offset= lineStart;
++        		while (Character.isWhitespace(doc.getChar(offset)) && offset < lineEnd) {
++        			offset++;
++        		}
++        		int leadingSpaces= offset - lineStart;
++				result= Math.min(result, leadingSpaces);
++        	}
++    		return result;
++    	} catch (BadLocationException e) {
++    		return 0;
++    	}
++	}
++
++	/**
++     * @return true, if the given inclusive range of lines all start with the single-line comment prefix,
++     * even if they have different amounts of leading whitespace
++     */
++    private boolean linesHaveCommentPrefix(IDocument doc, String lineCommentPrefix, int startLine, int endLine) {
++    	try {
++    		int docLen= doc.getLength();
++
++    		for(int line= startLine; line <= endLine; line++) {
++                int lineStart= doc.getLineOffset(line);
++                int lineEnd= lineStart + doc.getLineLength(line) - 1;
++                int offset= lineStart;
++
++                while (Character.isWhitespace(doc.getChar(offset)) && offset < lineEnd) {
++                    offset++;
++                }
++                if (docLen - offset > lineCommentPrefix.length() && doc.get(offset, lineCommentPrefix.length()).equals(lineCommentPrefix)) {
++                	// this line starts with the single-line comment prefix
++                } else {
++                	return false;
++                }
++            }
++    	} catch (BadLocationException e) {
++    		return false;
++    	}
++		return true;
++	}
++
++	private void doIndentLines() {
+         IDocument doc= this.getDocument();
+         DocumentRewriteSession rewriteSession= null;
+         Point p= this.getSelectedRange();
+@@ -218,18 +268,16 @@
+             final int startLine= doc.getLineOfOffset(selStart);
+             int endLine= doc.getLineOfOffset(selEnd);
+ 
+-            if (selLen > 0 && doc.getChar(selEnd - 1) == '\n')
++            if (selLen > 0 && lookingAtLineEnd(doc, selEnd))
+                 endLine--;
+             for(int line= startLine; line <= endLine; line++) {
+                 int lineStartOffset= doc.getLineOffset(line);
+-                int offset= lineStartOffset;
+ 
+-                // Replace the indent with desired indent
+-                // make use of the language-specific AutoEditStrategy
+-                // This strategy assumes keystroke input, so infrastructure requires a key event/DocumentCommand to work.
++                // Replace the existing indentation with the desired indentation.
++                // Use the language-specific AutoEditStrategy, which requires a DocumentCommand.
+                 DocumentCommand cmd= new DocumentCommand() { };
+                 cmd.offset= lineStartOffset;
+-                cmd.length= 1;
++                cmd.length= 0;
+                 cmd.text= Character.toString('\t');
+                 cmd.doit= true;
+                 cmd.shiftsCaret= false;
+@@ -237,7 +285,7 @@
+                 doc.replace(cmd.offset, cmd.length, cmd.text);
+             }
+         } catch (BadLocationException e) {
+-            e.printStackTrace();
++            RuntimePlugin.getInstance().logException("Indent Selection command failed", e);
+         } finally {
+             if (doc instanceof IDocumentExtension4) {
+                 IDocumentExtension4 extension= (IDocumentExtension4) doc;
+@@ -247,6 +295,21 @@
+         }
+     }
+ 
++    private boolean lookingAtLineEnd(IDocument doc, int pos) {
++        String[] legalLineTerms= doc.getLegalLineDelimiters();
++        try {
++            for(String lineTerm: legalLineTerms) {
++                int len= lineTerm.length();
++                if (pos > len && doc.get(pos - len, len).equals(lineTerm)) {
++                    return true;
++                }
++            }
++        } catch (BadLocationException e) {
++            RuntimePlugin.getInstance().logException("Error examining document for line termination", e);
++        }
++        return false;
++    }
++
+     /*
+      * @see ISourceViewer#configure(SourceViewerConfiguration)
+      */
+@@ -296,12 +359,15 @@
+                 		fAutoEditStrategy = new DefaultAutoIndentStrategy();
+                 }
+             }
++            
++            fQuickAssistAssistant = sSVConfiguration.getQuickAssistAssistant(this);
++            if (fQuickAssistAssistant != null)
++            	fQuickAssistAssistant.install(this);
+         }
+         //	if (fPreferenceStore != null) {
+         //	    fPreferenceStore.addPropertyChangeListener(this);
+         //	    initializeViewerColors();
+         //	}
+-        fIsConfigured= true;
+     }
+ 
+     /*
+@@ -332,6 +398,5 @@
+         //	if (fPreferenceStore != null)
+         //	    fPreferenceStore.removePropertyChangeListener(this);
+         super.unconfigure();
+-        fIsConfigured= false;
+     }
+ }
 Index: org.eclipse.imp.runtime/src/org/eclipse/imp/editor/ParserScheduler.java
 ===================================================================
 --- org.eclipse.imp.runtime/src/org/eclipse/imp/editor/ParserScheduler.java	(revision 22255)

From L.C.L.Kats at tudelft.nl  Thu Sep 30 11:03:55 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 30 Sep 2010 09:03:55 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21262 - in
	spoofax-imp/trunk:
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services...
Message-ID: <201009300903.o8U93tvN014892@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Thu Sep 30 09:03:53 2010
New Revision: 21262
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21262&sc=1

Log:
Fixed a regression introduced in r21250, breaking all builders :o

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -21,7 +21,7 @@
 import org.strategoxt.imp.runtime.parser.JSGLRI;
 import org.strategoxt.imp.runtime.parser.ast.RootAstNode;
 import org.strategoxt.imp.runtime.services.MetaFile;
-import org.strategoxt.imp.runtime.stratego.RefreshResourcePrimitive;
+import org.strategoxt.imp.runtime.stratego.EditorIOAgent;
 import org.strategoxt.lang.Context;
 import org.strategoxt.lang.StrategoException;
 import org.strategoxt.strc.parse_stratego_file_0_0;
@@ -45,7 +45,7 @@
 			try {
 				stream = context.getIOAgent().openInputStream(file);
 				RootAstNode ast = parser.parse(stream, file);
-				ast.setResource(RefreshResourcePrimitive.getResource(new File(file)));
+				ast.setResource(EditorIOAgent.getResource(new File(file)));
 				return ast.getTerm();
 			} finally {
 				if (stream != null) stream.close();

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -21,6 +21,7 @@
 import org.strategoxt.imp.runtime.EditorState;
 import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.ast.AstNode;
+import org.strategoxt.imp.runtime.stratego.EditorIOAgent;
 import org.strategoxt.imp.runtime.stratego.RefreshResourcePrimitive;
 
 /**
@@ -72,7 +73,7 @@
 					String file = asJavaString(termAt(result, 0));
 					String contents = asJavaString(termAt(result, 1));
 					try {
-						IFile resource = RefreshResourcePrimitive.getFile(runtime.getRuntime().getContext(), file);
+						IFile resource = EditorIOAgent.getFile(runtime.getRuntime().getContext(), file);
 						StrategoBuilder.setFileContentsDirect(resource, contents);
 					} catch (FileNotFoundException e) {
 						Environment.logException("Problem when handling on save event", e);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -42,7 +42,7 @@
 import org.strategoxt.imp.runtime.MonitorStateWatchDog;
 import org.strategoxt.imp.runtime.RuntimeActivator;
 import org.strategoxt.imp.runtime.dynamicloading.TermReader;
-import org.strategoxt.imp.runtime.stratego.RefreshResourcePrimitive;
+import org.strategoxt.imp.runtime.stratego.EditorIOAgent;
 import org.strategoxt.imp.runtime.stratego.StrategoConsole;
 import org.strategoxt.imp.runtime.stratego.adapter.IStrategoAstNode;
 import org.strategoxt.lang.Context;
@@ -252,7 +252,7 @@
 
 	private IFile getFile(IStrategoTerm resultTerm) throws FileNotFoundException {
 		String filename = asJavaString(termAt(resultTerm, 0));
-		IFile result = RefreshResourcePrimitive.getFile(
+		IFile result = EditorIOAgent.getFile(
 				observer.getRuntime().getContext(), filename);
 		return result;
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/EditorIOAgent.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -11,9 +11,15 @@
 import java.net.URISyntaxException;
 
 import org.eclipse.core.resources.IContainer;
+import org.eclipse.core.resources.IFile;
 import org.eclipse.core.resources.IProject;
+import org.eclipse.core.resources.IResource;
+import org.eclipse.core.resources.IWorkspace;
 import org.eclipse.core.resources.ResourcesPlugin;
+import org.spoofax.interpreter.core.IContext;
+import org.spoofax.interpreter.library.IOAgent;
 import org.spoofax.interpreter.library.LoggingIOAgent;
+import org.spoofax.interpreter.library.ssl.SSLLibrary;
 import org.strategoxt.imp.runtime.Debug;
 import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
 import org.strategoxt.imp.runtime.services.StrategoAnalysisJob;
@@ -144,4 +150,36 @@
 		return project;
 		
 	}
+
+	public static IFile getFile(IContext env, String file) throws FileNotFoundException {
+		IResource res = getResource(env, file);
+		if (res.getType() == IResource.FILE) {
+			return (IFile)res;
+		}
+		throw new FileNotFoundException("Resource is not a file: " + file);
+	}
+	
+	public static IResource getResource(IContext env, String file) throws FileNotFoundException {
+		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
+		File file2 = new File(file);
+		if (!file2.exists() && !file2.isAbsolute())
+			file2 = new File(agent.getWorkingDir() + "/" + file);
+		return getResource(file2);
+	}
+
+	public static IResource getResource(File file) throws FileNotFoundException {
+		if (file == null) {
+			assert false : "file should not be null";
+			return null;
+		}
+		URI uri = file.toURI();
+		IWorkspace workspace = ResourcesPlugin.getWorkspace();
+		IResource[] resources = workspace.getRoot().findContainersForLocationURI(uri);
+		if (resources.length > 0 && !resources[0].exists()) // prefer files over dirs
+			resources = workspace.getRoot().findFilesForLocationURI(uri); 
+		if (resources.length == 0)
+			throw new FileNotFoundException("File not in workspace: " + file);
+		assert resources.length == 1;
+		return resources[0];
+	}
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -53,7 +53,7 @@
 		AstNode result = imploder.implode(asfixATerm, tokenizer);
 		IResource resource;
 		try {
-			resource = RefreshResourcePrimitive.getResource(inputFile);
+			resource = EditorIOAgent.getResource(inputFile);
 		} catch (FileNotFoundException e) {
 			resource = null;
 		}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueStrategyPrimitive.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -3,11 +3,7 @@
  */
 package org.strategoxt.imp.runtime.stratego;
 
-import org.eclipse.core.resources.IContainer;
 import org.eclipse.core.resources.IProject;
-import org.eclipse.core.resources.ResourcesPlugin;
-import org.eclipse.core.runtime.IPath;
-import org.eclipse.core.runtime.Path;
 import org.eclipse.core.runtime.jobs.Job;
 import org.spoofax.interpreter.core.IContext;
 import org.spoofax.interpreter.core.InterpreterException;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	Thu Sep 30 08:44:40 2010	(r21261)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	Thu Sep 30 09:03:53 2010	(r21262)
@@ -4,14 +4,9 @@
 import static org.spoofax.interpreter.core.Tools.asJavaString;
 import static org.spoofax.interpreter.core.Tools.isTermString;
 
-import java.io.File;
 import java.io.FileNotFoundException;
-import java.net.URI;
 
-import org.eclipse.core.resources.IFile;
 import org.eclipse.core.resources.IResource;
-import org.eclipse.core.resources.IWorkspace;
-import org.eclipse.core.resources.ResourcesPlugin;
 import org.eclipse.core.runtime.CoreException;
 import org.eclipse.core.runtime.IProgressMonitor;
 import org.eclipse.core.runtime.IStatus;
@@ -21,8 +16,6 @@
 import org.spoofax.interpreter.core.IContext;
 import org.spoofax.interpreter.core.InterpreterException;
 import org.spoofax.interpreter.library.AbstractPrimitive;
-import org.spoofax.interpreter.library.IOAgent;
-import org.spoofax.interpreter.library.ssl.SSLLibrary;
 import org.spoofax.interpreter.stratego.Strategy;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 
@@ -48,7 +41,7 @@
 	public static boolean call(IContext env, String file) {
 		final IResource resource;
 		try {
-			resource = getResource(env, file);
+			resource = EditorIOAgent.getResource(env, file);
 		} catch (FileNotFoundException e) {
 			return false;
 		}
@@ -75,35 +68,4 @@
 		return true;
 	}
 
-	public static IFile getFile(IContext env, String file) throws FileNotFoundException {
-		
-		IResource res = getResource(env, file);
-		if (res.getType() == IResource.FILE) {
-			return (IFile)res;
-		}
-		throw new FileNotFoundException("Resource is not a file: " + file);
-		
-	}
-	
-	public static IResource getResource(IContext env, String file) throws FileNotFoundException {
-		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
-		File file2 = new File(file);
-		if (!file2.exists() && !file2.isAbsolute())
-			file2 = new File(agent.getWorkingDir() + "/" + file);
-		return getResource(file2);
-	}
-
-	public static IResource getResource(File file) throws FileNotFoundException {
-		if (file == null) {
-			assert false : "file should not be null";
-			return null;
-		}
-		URI uri = file.toURI();
-		IWorkspace workspace = ResourcesPlugin.getWorkspace();
-		IResource[] resources = workspace.getRoot().findContainersForLocationURI(uri);
-		if (resources.length == 0)
-			throw new FileNotFoundException("File not in workspace: " + file);
-		return resources[0];
-	}
-
 }

From L.C.L.Kats at tudelft.nl  Thu Sep 30 11:29:10 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 30 Sep 2010 09:29:10 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21263 - in
	spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.updatesite
Message-ID: <201009300929.o8U9TAYI015295@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: Thu Sep 30 09:29:09 2010
New Revision: 21263
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21263&sc=1

Log:
Release 0.5.3.6

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Thu Sep 30 09:03:53 2010	(r21262)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	Thu Sep 30 09:29:09 2010	(r21263)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.5.3.5"
+      version="0.5.3.6"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Thu Sep 30 09:03:53 2010	(r21262)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	Thu Sep 30 09:29:09 2010	(r21263)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.5.3.5.jar" id="org.strategoxt.imp" version="0.5.3.5">
+   <feature url="features/org.strategoxt.imp_0.5.3.6.jar" id="org.strategoxt.imp" version="0.5.3.6">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">

From n.bruning at student.tudelft.nl  Thu Sep 30 16:28:32 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Thu, 30 Sep 2010 14:28:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21264 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201009301428.o8UESWWw020326@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Thu Sep 30 14:28:30 2010
New Revision: 21264
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21264&sc=1

Log:
Obtain lock for background jobs

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundJob.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundJob.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundJob.java	Thu Sep 30 09:29:09 2010	(r21263)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundJob.java	Thu Sep 30 14:28:30 2010	(r21264)
@@ -41,11 +41,15 @@
 			
 			// Get parse controller
 			observer = descriptor.createService(StrategoObserver.class, null);
+			observer.getLock().lock();
+			
 			((EditorIOAgent)observer.getRuntime().getIOAgent()).setJob(this);
 			observer.invoke(strategyName, term, project);
 		    
 		} catch (Exception e) {
 			Environment.logException("Background job failed", e);
+		} finally {
+			observer.getLock().unlock();
 		}
 		
 		return Status.OK_STATUS;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java	Thu Sep 30 09:29:09 2010	(r21263)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserverBackgroundUpdateJob.java	Thu Sep 30 14:28:30 2010	(r21264)
@@ -48,6 +48,9 @@
 			// Get parse controller
 			parseController = descriptor.createService(SGLRParseController.class, null);
 			observer = descriptor.createService(StrategoObserver.class, parseController);
+			
+			this.observer.getLock().lock();
+			
 			((EditorIOAgent)observer.getRuntime().getIOAgent()).setJob(this);
 			// Don't perform initial (foreground) update
 			parseController.setPerformInitialUpdate(false);
@@ -70,6 +73,8 @@
 		} catch (Exception e) {
 			// hmm.
 			e.printStackTrace();
+		} finally {
+			observer.getLock().unlock();
 		}
 		
 		return Status.OK_STATUS;

From n.bruning at student.tudelft.nl  Thu Sep 30 23:33:05 2010
From: n.bruning at student.tudelft.nl (Nathan Bruning)
Date: Thu, 30 Sep 2010 21:33:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r21265 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <201009302133.o8ULX5ok026826@proliant.st.ewi.tudelft.nl>

Author: NathanBruning
Date: Thu Sep 30 21:33:05 2010
New Revision: 21265
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=21265&sc=1

Log:
Give a nice error when calling queue-analysis on an out-of-project file

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java	Thu Sep 30 14:28:30 2010	(r21264)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisPrimitive.java	Thu Sep 30 21:33:05 2010	(r21265)
@@ -14,6 +14,7 @@
 import org.spoofax.interpreter.stratego.Strategy;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.services.StrategoAnalysisQueueFactory;
 
 /**
@@ -61,13 +62,21 @@
 		}
 		EditorIOAgent editorAgent = (EditorIOAgent)agent;
 		
-		// Make path project local
+		IProject project = editorAgent.getProject();
+		
 		String projectPathStr = editorAgent.getProjectPath();
 		IPath projectPath = new Path(projectPathStr); 
-		IPath projectRelativePath = filePath.removeFirstSegments(filePath.matchingFirstSegments(projectPath)); 
-
-		IProject project = editorAgent.getProject();
 		
+		if (filePath.isAbsolute()) {
+			// Test if in project; can't parse it otherwise
+			if (!projectPath.isPrefixOf(filePath)) {
+				Environment.logException("Trying to analyze out-of-project file: " + filePath);
+				return;
+			}
+		}
+		
+		// Make path project local
+		IPath projectRelativePath = filePath.removeFirstSegments(filePath.matchingFirstSegments(projectPath)); 
 		StrategoAnalysisQueueFactory.getInstance().queueAnalysis(projectRelativePath, project);
 		
 	}

