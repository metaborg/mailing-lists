From oskarvanrest at gmail.com  Tue May  1 04:41:07 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Tue, 01 May 2012 02:41:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24767 - in
	experimental/graphical-editor/EntityLang/EntityLang: . editor
	editor/java/EntityLang/strategies editor/java/org
	editor/java/org/eclipse editor/java/org/eclipse/...
Message-ID: <20120501024107.697207F8003@mx1.tudelft.nl>

Author: OskarVanRest
Date: Tue May  1 02:41:00 2012
New Revision: 24767
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24767&sc=1

Log:
Not fully working version, but needed a backup.
Getting classCastExceptions at the moment because the classes in the .jars are not the same as the classes of the GMF editor.

Added:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/views/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/views/properties/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/views/properties/tabbed/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/views/properties/tabbed/ITabbedPropertySheetPageContributor.java
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/EntityLangEMF.diagram.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/EntityLangEMF.jar
      - copied, changed from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/EntityLangEMF.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.draw2d_3.5.0.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.common_2.7.0.v20110912-0920.jar
      - copied unchanged from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.common_2.7.0.v20110912-0920.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar
      - copied unchanged from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar
      - copied unchanged from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.edit.ui-2.1.0.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.edit_2.7.0.v20110606-0949.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.transaction_1.4.0.v20100331-1738.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gef_3.7.0.v20110407-2050.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.common.ui_1.5.0.v20101221-2230.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.diagram.ui.resources.editor-1.0.3-v20070601-1400.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.diagram.ui_1.3.0.v20100209-2200.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.gef.ui_1.2.0.v20090520-1343.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.notation_1.2.0.v20091021-2333.jar   (contents, props changed)
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.spoofax.text2model.jar
      - copied unchanged from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.spoofax.text2model.jar
Deleted:
   experimental/graphical-editor/EntityLang/EntityLang/lib/EntityLangEMF.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.common_2.7.0.v20110912-0920.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar
   experimental/graphical-editor/EntityLang/EntityLang/lib/org.spoofax.text2model.jar
Modified:
   experimental/graphical-editor/EntityLang/EntityLang/.classpath
   experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java
   experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str
   experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/.classpath
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/.classpath	Mon Apr 30 11:11:04 2012	(r24766)
+++ experimental/graphical-editor/EntityLang/EntityLang/.classpath	Tue May  1 02:41:00 2012	(r24767)
@@ -4,9 +4,15 @@
 	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/J2SE-1.5"/>
 	<classpathentry kind="con" path="org.eclipse.pde.core.requiredPlugins"/>
 	<classpathentry kind="con" path="org.eclipse.jdt.junit.JUNIT_CONTAINER/4"/>
-	<classpathentry kind="lib" path="lib/EntityLangEMF.jar"/>
-	<classpathentry kind="lib" path="lib/org.eclipse.emf.common_2.7.0.v20110912-0920.jar"/>
-	<classpathentry kind="lib" path="lib/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar"/>
-	<classpathentry kind="lib" path="lib/org.spoofax.text2model.jar"/>
+	<classpathentry kind="lib" path="lib/jars/EntityLangEMF.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.common_2.7.0.v20110912-0920.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.gef_3.7.0.v20110407-2050.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.gmf.runtime.diagram.ui_1.3.0.v20100209-2200.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.spoofax.text2model.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.transaction_1.4.0.v20100331-1738.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.edit_2.7.0.v20110606-0949.jar"/>
+	<classpathentry kind="lib" path="lib/jars/EntityLangEMF.diagram.jar"/>
+	<classpathentry kind="lib" path="lib/jars/org.eclipse.gmf.runtime.diagram.ui.resources.editor-1.0.3-v20070601-1400.jar"/>
 	<classpathentry kind="output" path="bin"/>
 </classpath>

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Mon Apr 30 11:11:04 2012	(r24766)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Tue May  1 02:41:00 2012	(r24767)
@@ -12,11 +12,22 @@
                                                                                                                           
   provider : include/entitylang.ctree                                                                                     
   provider : include/entitylang-java.jar                                                         
-  provider : lib/EntityLangEMF.jar                                                                                   
-  provider : lib/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar                                                                               
-  provider : lib/org.eclipse.emf.common_2.7.0.v20110912-0920.jar
-  provider : lib/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar                                                         
-  provider : lib/org.spoofax.text2model.jar                                                                               
+  provider : lib/jars/EntityLangEMF.jar                                                                                   
+  provider : lib/jars/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar                                                                               
+  provider : lib/jars/org.eclipse.emf.common_2.7.0.v20110912-0920.jar
+  provider : lib/jars/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar
+  provider : lib/jars/org.eclipse.emf.edit_2.7.0.v20110606-0949.jar
+  provider : lib/jars/org.eclipse.emf.transaction_1.4.0.v20100331-1738.jar                                                      
+  provider : lib/jars/org.spoofax.text2model.jar
+  provider : lib/jars/org.eclipse.gef_3.7.0.v20110407-2050.jar
+  provider : lib/jars/org.eclipse.gmf.runtime.diagram.ui_1.3.0.v20100209-2200.jar
+  provider : lib/jars/org.eclipse.gmf.runtime.diagram.ui.resources.editor-1.0.3-v20070601-1400.jar
+  provider : lib/jars/org.eclipse.gmf.runtime.notation_1.2.0.v20091021-2333.jar
+  provider : lib/jars/org.eclipse.gmf.runtime.common.ui_1.5.0.v20101221-2230.jar
+  provider : lib/jars/org.eclipse.gmf.runtime.gef.ui_1.2.0.v20090520-1343.jar
+  provider : lib/jars/org.eclipse.emf.edit.ui-2.1.0.jar
+  provider : lib/jars/org.eclipse.draw2d_3.5.0.jar
+  provider : lib/jars/EntityLangEMF.diagram.jar                                                   
                                                                                                                           
   observer : editor-analyze                                                                                               
                                                                                                                           

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java	Mon Apr 30 11:11:04 2012	(r24766)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java	Tue May  1 02:41:00 2012	(r24767)
@@ -15,7 +15,8 @@
     		create_instance_0_1.instance,
     		set_attribute_0_2.instance,
     		set_reference_0_2.instance,
-    		serialise_0_1.instance    
+    		serialise_0_1.instance,
+    		replace_gmf_resource_0_1.instance
     });
   }
 }

Added: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java	Tue May  1 02:41:00 2012	(r24767)
@@ -0,0 +1,73 @@
+package EntityLang.strategies;
+
+import java.io.ByteArrayInputStream;
+import java.io.IOException;
+import java.io.InputStream;
+import java.util.Collections;
+
+import org.eclipse.emf.ecore.resource.Resource;
+import org.eclipse.emf.ecore.resource.ResourceSet;
+import org.eclipse.emf.transaction.TransactionalEditingDomain;
+import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramEditor;
+import org.eclipse.ui.IEditorPart;
+import org.eclipse.ui.IEditorReference;
+import org.eclipse.ui.IWorkbench;
+import org.eclipse.ui.IWorkbenchPage;
+import org.eclipse.ui.IWorkbenchWindow;
+import org.eclipse.ui.PlatformUI;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+import EntityLangModel.diagram.part.EntityLangModelDiagramEditor;
+
+public class replace_gmf_resource_0_1 extends Strategy {
+
+	public static replace_gmf_resource_0_1 instance = new replace_gmf_resource_0_1();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm serialisedModel, IStrategoTerm packName) {
+		// find the EMF model
+		IWorkbench wb = PlatformUI.getWorkbench();
+		IWorkbenchWindow win = wb.getWorkbenchWindows()[0];
+		IWorkbenchPage page = win.getActivePage();
+		IEditorReference[] editors = page.getEditorReferences();
+		IEditorPart editor = null;
+		String editorID = packName.toString().replaceAll("\"", "") + ".diagram.part." + packName.toString().replaceAll("\"", "") + "DiagramEditorID";
+	    for (int i = 0; i < editors.length; i++) {
+			if (editors[i].getId().equals(editorID)) {
+				editor = editors[i].getEditor(false);
+			}
+		}
+
+		if (editor == null) {
+//			try {page.getViews()[0].getViewSite().getActionBars()
+//				throw new Exception();
+//			} catch (Exception e) {
+//				e.printStackTrace();
+//			}
+			return context.getFactory().makeString("0");
+		}
+		System.out.println("hoi0");
+
+		TransactionalEditingDomain editingDomain = ((DiagramEditor) editor).getEditingDomain();
+		System.out.println("hoi1");
+		ResourceSet diagramEditorResourceSet = editingDomain.getResourceSet();
+		System.out.println("hoi2");
+		Resource resource = diagramEditorResourceSet.getResources().get(1);
+		System.out.println("hoi3");
+
+		InputStream is = new ByteArrayInputStream(serialisedModel.toString().getBytes());
+		System.out.println("hoi4");
+
+		try {
+			resource.load(is, Collections.emptyMap());
+		} catch (IOException e) {
+			e.printStackTrace();
+			return context.getFactory().makeString("0");
+		}
+		
+		return context.getFactory().makeString("1");
+	}
+
+}

Added: experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/views/properties/tabbed/ITabbedPropertySheetPageContributor.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/eclipse/ui/views/properties/tabbed/ITabbedPropertySheetPageContributor.java	Tue May  1 02:41:00 2012	(r24767)
@@ -0,0 +1,39 @@
+/*******************************************************************************
+ * Copyright (c) 2001, 2006 IBM Corporation and others.
+ * All rights reserved. This program and the accompanying materials
+ * are made available under the terms of the Eclipse Public License v1.0
+ * which accompanies this distribution, and is available at
+ * http://www.eclipse.org/legal/epl-v10.html
+ * 
+ * Contributors:
+ *     IBM Corporation - initial API and implementation
+ *******************************************************************************/
+package org.eclipse.ui.views.properties.tabbed;
+
+/**
+ * Interface for a workbench part to contribute content to the tabbed property
+ * view.
+ * <p>
+ * It is expected that the contributor ID is unique for a configuration of tabs
+ * and sections. Editors and views can share a configuration by sharing a
+ * contributor ID. Editors and views cannot share tabs and sections from
+ * multiple contributors.
+ * </p>
+ * <p>
+ * As a workaround, if all the elements in a structured selection implement
+ * ITabbedPropertySheetPageContributor and they all return the same unique
+ * contributor ID, then that configuration of tabs and sections will be used by
+ * the tabbed property view for that selection.
+ * </p>
+ * 
+ * @author Anthony Hunter
+ */
+public interface ITabbedPropertySheetPageContributor {
+
+	/**
+	 * Returns the contributor ID for the tabbed property sheet page.
+	 * 
+	 * @return the contributor ID for the tabbed property sheet page.
+	 */
+	public String getContributorId();
+}

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/EntityLangEMF.diagram.jar
==============================================================================
Binary file. No diff available.

Copied and modified: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/EntityLangEMF.jar (from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/EntityLangEMF.jar)
==============================================================================
Binary file (source and/or target). No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.draw2d_3.5.0.jar
==============================================================================
Binary file. No diff available.

Copied: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.common_2.7.0.v20110912-0920.jar (from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.common_2.7.0.v20110912-0920.jar)
==============================================================================
Binary file (source and/or target). No diff available.

Copied: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar (from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar)
==============================================================================
Binary file (source and/or target). No diff available.

Copied: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar (from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar)
==============================================================================
Binary file (source and/or target). No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.edit.ui-2.1.0.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.edit_2.7.0.v20110606-0949.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.emf.transaction_1.4.0.v20100331-1738.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gef_3.7.0.v20110407-2050.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.common.ui_1.5.0.v20101221-2230.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.diagram.ui.resources.editor-1.0.3-v20070601-1400.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.diagram.ui_1.3.0.v20100209-2200.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.gef.ui_1.2.0.v20090520-1343.jar
==============================================================================
Binary file. No diff available.

Added: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.eclipse.gmf.runtime.notation_1.2.0.v20091021-2333.jar
==============================================================================
Binary file. No diff available.

Copied: experimental/graphical-editor/EntityLang/EntityLang/lib/jars/org.spoofax.text2model.jar (from r24764, experimental/graphical-editor/EntityLang/EntityLang/lib/org.spoofax.text2model.jar)
==============================================================================
Binary file (source and/or target). No diff available.

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Mon Apr 30 11:11:04 2012	(r24766)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Tue May  1 02:41:00 2012	(r24767)
@@ -86,7 +86,6 @@
 			
 rules
 	
-	external initialize-emf-package(|) //TODO
 	external create-instance(|packName)
 	external set-attribute(|element, featureName)
 	external set-reference(|element, featureName)

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Mon Apr 30 11:11:04 2012	(r24766)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Tue May  1 02:41:00 2012	(r24767)
@@ -35,8 +35,6 @@
       // initialize
 	  editor-init;
       ast' := <analyze-top> (ast, path, project-path);
-      language  := <index-origin-language> ast;
-      index-setup(|language, [project-path], $[[project-path]/[path]]);
       fileExtension := <lower-case> <packName>;
       filename := <guarantee-extension(|fileExtension)> path;
       <initialize-emf-package> <packName>;
@@ -45,11 +43,18 @@
       ast''  := <to-emf(|path)> ast';
       result := <serialise-model(|path)> ast'';
       
+      // replace GMF's semantic model
+      <replace-gmf-resource(|<packName>)> result
+      
       // write to file
-      fdescr := <fopen> (filename, "w");
-	  <fputs> (result, fdescr);
-	  <fclose> fdescr;
-	  <refresh-workspace-file> filename
+	  // fdescr := <fopen> (filename, "w");
+	  // <fputs> (result, fdescr);
+	  // <fclose> fdescr;
+	  // <refresh-workspace-file> filename
+  
+  
+  external initialize-emf-package(|)
+  external replace-gmf-resource(|packName)
   
   // Transforms a selection to Java
   generate-java:

From gabrielkonat at gmail.com  Tue May  1 11:37:40 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 01 May 2012 09:37:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24768 - in
	spoofax-contrib/separate-compilation-examples:
	c-without-macros/test c-without-macros/test/unit
	csharp-partial-classses/test csharp-partial-classses/test/unit e...
Message-ID: <20120501093741.0812E108C025@mx3.tudelft.nl>

Author: gkonat
Date: Tue May  1 09:37:39 2012
New Revision: 24768
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24768&sc=1

Log:
Moved unit tests to separate directories.

Added:
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/completion.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/c-without-macros/test/completion.spt
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/resolving.spt
      - copied unchanged from r24760, spoofax-contrib/separate-compilation-examples/c-without-macros/test/resolving.spt
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/tests.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/c-without-macros/test/tests.spt
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/completion.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/completion.spt
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/resolving.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/resolving.spt
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/tests.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/tests.spt
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/completion.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/completion.spt
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/resolving.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/resolving.spt
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/tests.spt
      - copied unchanged from r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/tests.spt
Deleted:
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/completion.spt
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/resolving.spt
   spoofax-contrib/separate-compilation-examples/c-without-macros/test/tests.spt
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/completion.spt
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/resolving.spt
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/tests.spt
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/completion.spt
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/resolving.spt
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/tests.spt

Copied: spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/completion.spt (from r24757, spoofax-contrib/separate-compilation-examples/c-without-macros/test/completion.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/completion.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/c-without-macros/test/completion.spt)
@@ -0,0 +1,73 @@
+module Tests-Completion
+
+language C-without-macros
+
+setup Header [[ 
+  typedef struct BBBBB {
+    int integer;
+    char* string;
+  } BBBBB_t;
+]]
+
+test Complete property access 1 [[
+  int f() {
+    BBBBB_t b;
+    return b.[[i]];
+  }
+]] complete to "integer"
+
+test Complete property access 2 [[
+  int f() {
+    BBBBB_t* b;
+    return b->[[i]];
+  }
+]] complete to "integer"
+
+test Complete parameter [[
+  int f(B_t* test) {
+    return [[t]]->integer;
+  }
+]] complete to "test"
+
+test Complete local variable [[
+  int f() {
+    B_t* test;
+    return [[t]]->integer;
+  }
+]] complete to "test"
+
+test Complete function call [[
+  int die() {
+  	return [[d]]();
+	}
+]] complete to "die"
+
+test Complete primitive type 1 [[
+  [[v]] f() {}
+]] complete to "void"
+
+test Complete primitive type 2 [[
+  void f() {
+  	[[i]] a;
+  }
+]] complete to "int"
+
+test Complete struct type 1 [[
+  struct [[B]] f() {} 
+]] complete to "BBBBB"
+
+test Complete struct type 2 [[
+  void f() {
+    struct [[B]] b;
+  }
+]] complete to "BBBBB"
+
+test Complete typedef 1 [[
+  [[B]] f() {} 
+]] complete to "BBBBB_t"
+
+test Complete typedef 2 [[
+  void f() {
+    [[B]] b;
+  }
+]] complete to "BBBBB_t"
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/resolving.spt (from r24760, spoofax-contrib/separate-compilation-examples/c-without-macros/test/resolving.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/resolving.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24760, spoofax-contrib/separate-compilation-examples/c-without-macros/test/resolving.spt)
@@ -0,0 +1,106 @@
+module Tests-Resolving
+
+language C-without-macros
+
+setup Header [[ 
+
+]]
+
+test Resolve struct reference 1 [[
+  struct [[B]] {
+    struct [[B]] b;
+  };
+]] resolve #2 to #1
+
+test Resolve struct reference 2 [[
+  struct [[B]] {
+  };
+  
+  struct B* f() {
+    return (struct [[B]]*)0;
+  }
+]] resolve #2 to #1
+
+test Resolve typedeffed struct reference [[
+  typedef struct B {
+  } [[B_t]];
+  
+  [[B_t]]* f() {
+    B_t* b;
+    return b;
+  }
+]] resolve #2 to #1
+
+test Resolve typedeffed struct reference [[
+  typedef struct B {
+  } B_t;
+  
+  typedef B_t [[B_t_1]];
+  
+  [[B_t_1]] f() {
+    B_t_1 b;
+    return b;
+  }
+]] resolve #2 to #1
+
+test Resolve property access 1 [[
+  struct B {
+    int [[i]];
+  };
+  
+  int f() {
+    struct B* b;
+    return b->[[i]];
+  }
+]] resolve #2 to #1
+
+test Resolve property access 2 [[
+  struct B {
+    int [[i]];
+  };
+  
+  int f() {
+    struct B b;
+    return b.[[i]];
+  }
+]] resolve #2 to #1
+
+test Resolve typedeffed property access [[
+  struct B {
+    int [[i]];
+  };
+  
+  typedef struct B B_t;
+  typedef B_t B_t_1;
+  typedef B_t_1 B_t_2;
+  
+  int f() {
+    B_t_2* b; 
+    return b->[[i]]; 
+  } 
+]] resolve #2 to #1 
+
+test Resolve local variable reference [[
+  int f() {
+    int [[i]];
+    return [[i]];
+  }
+]] resolve #2 to #1
+
+test Resolve parameter reference [[
+  char* f(char* [[s]]) {
+    return [[s]];
+  }
+]] resolve #2 to #1
+
+test Resolve function call [[
+  void* [[malloc]](int size) {
+    void* ptr;
+    // TODO: allocate memory
+    return ptr;
+  }
+  
+  char* f() {
+    return (char*)[[malloc]](0);
+  }
+]] resolve #2 to #1
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/tests.spt (from r24757, spoofax-contrib/separate-compilation-examples/c-without-macros/test/tests.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/test/unit/tests.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/c-without-macros/test/tests.spt)
@@ -0,0 +1,278 @@
+module Tests
+
+language C-without-macros
+
+setup Header [[ 
+  typedef struct A {
+    char* s;
+    int i;
+    struct A* a;
+  } A_t;
+  
+	void* malloc(int size) {
+	  void* ptr;
+	  // TODO: allocate memory
+	  return ptr;
+	}
+]]
+
+test Resolve var 1 [[
+	char* b(A_t* a) { 
+	  return a->s;
+	}
+]]
+
+test Resolve var 2 fails [[
+	char* b(A_t* a) { 
+	  return a.s;
+	}
+]] 1 error
+
+test Resolve var 3 [[
+	char* b(struct A* a) {
+	  return a->s;
+	}
+]]
+
+test Resolve var 4 fails [[
+	char* b(struct A* a) {
+	  return a.s;
+	}
+]] 1 error
+
+test Resolve var 5 [[
+  typedef A_t A_t_1;
+  
+	char* b(A_t_1* a) {
+	  return a->s;
+	}
+]]
+
+test Resolve var 6 fails [[
+  typedef A_t A_t_1;
+  
+	char* b(A_t_1* a) {
+	  return a.s;
+	}
+]] 1 error
+
+test Resolve var and type 1 fails [[
+	char* b(foo_t_2* a) {
+	  return a->s;
+	}
+]] 2 errors
+
+test Resolve var and type 2 fails [[
+	char* b(foo_t_2* a) {
+	  return a.s;
+	}
+]] 2 errors
+
+test Resolve function call 1 [[
+	void* c(A_t* a) {
+	  return malloc(a->i);
+	}
+]]
+
+test Resolve function call 2 fails [[
+  void* c(A_t* a) {
+    return malloc();
+  }
+]] 1 error
+
+test Resolve function call 3 [[
+	void* c(struct A* a) {
+	  return malloc(a->i);
+	}
+]]
+
+test Resolve function call 4 fails [[
+  void* c(struct A* a) {
+    return malloc(a->i, a->i);
+  }
+]] 1 error
+
+test Resolve function call and type fails [[
+	void* c(foo_t_2* a) {
+	  return malloc(a);
+	} 
+]] 2 errors
+
+test Resolve function call [[
+  A_t* f() {
+    A_t* a;
+    a = (A_t*)malloc(sizeof(A_t));
+    return a;
+  }
+]]
+
+test Resolve function call fails [[
+  void f() {
+    A_t* a;
+    free(a);
+  }
+]] 1 error
+
+test Resolve type fails [[
+  B f() { }
+]] 2 errors
+
+test Resolve typedeffed type [[
+  typedef A_t A_t_1;
+  typedef A_t_1 A_t_2;
+  typedef A_t_2 A_t_3;
+  
+  char* f() {
+    A_t_3* a;
+    a = (A_t_3*)malloc(sizeof(A_t_3));
+    a->s="test";
+    return a->s;
+  }
+]]
+
+test Resolve typedeffed type fail (cyclic typedef) [[
+  typedef A_t A_t_1;
+  typedef A_t_1 A_t_2;
+  typedef A_t_2 A_t_1;
+  
+  char* f() {
+    A_t_2* a;
+    a = (A_t_2*)malloc(sizeof(A_t_2));
+    a->s="test";
+    return a->s;
+  }
+]] 6 errors
+
+test Assignment [[
+  void f() {
+    int i;
+    i = 0;
+  }
+]]
+
+test Unexpected assignment type [[
+  void f() {
+    int i;
+    i = "fail";
+  }
+]] 1 error
+
+test Assignments [[
+  void f() {
+    int i;
+    char* s;
+    A_t* a;
+    
+    i = 0;
+    s = "ok";
+    a = (A_t*)malloc(sizeof(A_t));
+  }
+]]
+
+test Unexpected assignment types [[
+  void f() {
+    int i;
+    char* s;
+    A_t* a;
+    
+    i = "fail";
+    s = 1;
+    a = (void*)0;
+  }
+]] 3 errors
+
+test Return [[
+  int f() {
+  	int i;
+  	i = 1;
+  	return i;
+  }
+]]
+
+test Unexpected return type [[
+  char* f() {
+    int i;
+    i = 1;
+    return i;
+  }
+]] 1 error
+
+test Unexpected return types [[
+  A_t* f() {
+    A_t* a;
+    return 1;
+    return a->i;
+    return a->s;
+  }
+]] 3 errors
+
+test No return in void method [[
+  void sideEffect() {}
+]]
+
+test No return in non-void method fails [[
+  A_t* f() {
+
+  }
+]] 1 error
+
+// TODO: Should only have 2 errors.
+test Duplicate struct fails [[
+  struct B {};
+  struct B {};
+]] 3 errors
+
+// TODO: Should only have 2 errors.
+test Duplicate type fails [[
+  typedef struct B {} D_t;
+  typedef struct C {} D_t;
+]] 3 errors
+
+test Duplicate field fails [[
+  struct B {
+    int a;
+    int a;
+  };
+]] 2 errors
+
+// TODO: Should only have 2 errors.
+test Duplicate local variable fails [[
+  void f() {
+    int a;
+    int a;
+  }
+]] 3 errors
+
+// TODO: Should only have 2 errors.
+test Duplicate function fails [[
+  void f() {}
+  void f() {}
+]] 3 errors
+
+test Use struct before def fails [[
+  struct C {
+    struct B* b;
+  };
+  struct B {};
+]] 1 error
+
+test Use type before def fails [[
+  struct C {
+    B_t* b;
+  };
+  typedef struct B {} B_t;
+]] 1 error
+
+test Use local variable before def fails [[
+  void f() {
+    a = 1;
+    int a;
+  }
+]] 1 error
+
+test Use function before def fails [[
+  void test() {
+    f();
+  }
+  void f() {}
+]] 1 error
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/completion.spt (from r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/completion.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/completion.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/completion.spt)
@@ -0,0 +1,69 @@
+module Tests-Completion
+
+language CSharpPartialClassses
+
+setup Header [[
+  namespace TestsCompletion {
+	  class A {
+	    B b;
+	    string string;
+	    void func() {}
+	  }
+	  class ABC {}
+  }
+]]
+
+test Complete property access [[
+  namespace TestsCompletion {
+	  class B {
+	    A a;
+	    
+	    B f() {
+	      return a.b.a.[[s]];
+	    }
+	  }
+  }
+]] complete to "string"
+
+test Complete function call [[
+  namespace TestsCompletion {
+	  class B {
+	    A a;
+	    void f() {
+	      return a.[[f]]();
+	    }
+	  }
+  }
+]] complete to "func"
+
+test Complete primitive type 1 [[
+  namespace TestsCompletion {
+	  class B {
+	    [[s]] s;
+	  }
+  }
+]] complete to "string"
+
+test Complete primitive type 2 [[
+  namespace TestsCompletion {
+	  class B {
+	    [[v]] f() {}
+	  }
+  }
+]] complete to "void"
+
+test Complete class type 1 [[
+  namespace TestsCompletion {
+	  class Test {
+	    [[T]] s;
+	  }
+  }
+]] complete to "Test"
+
+test Complete class type 2 [[
+  namespace TestsCompletion {
+	  class Test {
+	    [[AB]] f() {}
+	  }
+  }
+]] complete to "ABC"
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/resolving.spt (from r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/resolving.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/resolving.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/resolving.spt)
@@ -0,0 +1,82 @@
+module Tests-Resolving
+
+language CSharpPartialClassses
+
+setup Header [[
+
+]]
+
+test Resolve class reference [[
+  namespace TestsResolving {
+	  class [[B]] {
+	    [[B]] b;
+	  }
+  }
+]] resolve #2 to #1
+
+test Resolve property access [[
+  namespace TestsResolving {
+	  class B {
+	    C v;
+	    
+	    C f() {
+	      return v.[[c]]; 
+	    }
+	  }
+	  
+	  class C {
+	    C [[c]];
+	  }
+  }
+]] resolve #1 to #2
+
+test Resolve field [[ 
+  namespace TestsResolving {
+	  class B {
+	    B [[x]];
+	    B f() {
+	      return [[x]];
+	    }
+	  }
+  }
+]] resolve #2 to #1
+
+test Resolve partial class field [[ 
+  namespace TestsResolving {
+		partial class B {
+			B [[x]];
+		}
+		
+	  partial class B {
+	    B f() {
+	      return [[x]];
+	    }
+	  }
+  }
+]] resolve #2 to #1
+
+test Resolve function [[ 
+  namespace TestsResolving {
+	  class B {
+	    B x;
+	    B [[f]]() {
+	      return x.[[f]]();
+	    }
+	  }
+  }
+]] resolve #2 to #1
+
+test Resolve partial class function [[ 
+  namespace TestsResolving {
+	  partial class B {
+	    B x;
+	    B [[fp]]() { return x.f(); }
+	  }
+	  
+	  partial class B {
+	    B f() {
+	      return x.[[fp]]();
+	    }
+	  }
+  }
+]] resolve #2 to #1
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/tests.spt (from r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/tests.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/unit/tests.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/tests.spt)
@@ -0,0 +1,233 @@
+module Tests
+
+language CSharpPartialClassses
+
+setup Header [[
+  using Hidden;
+  
+	namespace Tests {
+    class A {
+      P p;
+    }
+    
+    partial class P {
+      string a;
+      int i;
+    }
+	}
+	
+	namespace Hidden {
+	  class H {
+	    H h;
+	  }
+	}
+]]
+
+test Resolve property access [[
+  namespace Tests {
+	  partial class P {
+	    int n;
+	  }
+	    
+	  class B {
+	  	A a;
+	  	
+	    int b() {
+	    	return a.p.n;
+	    }
+	  }
+  }
+]]
+
+test Resolve property access fails [[
+  namespace Tests {
+    partial class P {
+      int n;
+    }
+      
+    class B {
+      A a;
+      
+      int b() {
+        return a.p.x;
+      }
+    }
+  }
+]] 1 error 
+
+test Resolve function call [[
+  namespace Tests {
+	  partial class P {
+	    string Geta() { return a; }
+	  }
+	  
+	  class B {
+      P p;
+      
+      string f() {
+        return p.Geta();
+      }
+    }
+  }
+]]
+
+test Resolve function call fails [[
+  namespace Tests {
+    class B {
+      P p;
+      
+      string f() {
+        return p.Geta();
+      }
+    }
+  }
+]] 1 error
+
+test Resolve type [[
+  namespace Tests {
+    class B {
+      A a;
+    }
+  }
+]]
+
+test Resolve type fails 1 [[
+  namespace Tests {
+    class B {
+      Q q;
+    }
+  }
+]] 1 error
+
+test Resolve type fails 2 [[
+  namespace NOTTests {
+    class B {
+      P p;
+    }
+  }
+]] 1 error
+
+test Resolve type from using [[
+  class B {
+    H h;
+  }
+]]
+
+test Return [[
+  namespace Tests {
+    class B {
+      A a;
+      
+      int getA() {
+        return a.p.i;
+      }
+    }
+  }
+]]
+
+test Unexpected return type 1 [[
+  namespace Tests {
+    class B {
+      A a;
+      
+      int getA() {
+        return a;
+      }
+    }
+  }
+]] 1 error
+
+test Unexpected return type 2 [[
+  namespace Tests {
+    partial class P {
+      string getA() {
+        return a;
+      }
+    }
+    class B {
+      A a;
+      
+      int getA() {
+        return a.p.getA();
+      }
+    }
+  }
+]] 1 error
+
+test Unexpected return types [[
+  namespace Tests {
+    class B {
+      A a;
+      
+      int getA() {
+        return a;
+        return a.p;
+        return a.p.a;
+      }
+    }
+  }
+]] 3 errors
+
+test No return in void method [[
+  namespace Tests {
+    class B {
+      void sideEffect() {}
+    }
+  }
+]]
+
+test No return in non-void method fails [[
+  namespace Tests {
+    class B {
+      int getA() {
+        
+      }
+    }
+  }
+]] 1 error
+
+test Duplicate class 1 fails [[
+  namespace Tests {
+    class B {}
+    class B {}
+  }
+]] 2 errors
+
+// TODO: This should fail!
+test Duplicate class 2 should fail [[
+  namespace Tests {
+    class B {}
+    partial class B {}
+  }
+]] //2 errors
+
+test Duplicate partial class allowed [[
+  namespace Tests {
+    partial class B {}
+    partial class B {}
+  }
+]]
+
+test Duplicate property fails [[
+  class B {
+    B b;
+    B b;
+  }
+]] 2 errors
+
+test Duplicate method fails [[
+  class B {
+    void f() {}
+    void f() {}
+  }
+]] 2 errors
+
+test Use before def allowed [[
+  namespace Tests {
+    class B {
+      C c;
+    }
+    
+    partial class C {}
+  }
+]]
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/completion.spt (from r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/completion.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/completion.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/completion.spt)
@@ -0,0 +1,100 @@
+module Tests-Completion
+
+language EntityWithAspects
+
+setup Header [[
+  module TestsCompletion
+    
+  entity A {
+    x : B
+  }
+]]
+
+test Complete property access [[
+  entity B {
+    yyyyy : A
+    f(a : A) {
+      var v : A = a.x.[[y]]
+    }
+  }
+]] complete to "yyyyy"
+
+test Complete parameter [[
+  entity B {
+    f(test : A) {
+      var v : A = [[t]]
+    }
+  }
+]] complete to "test"
+
+test Complete local variable [[
+  entity B {
+    f(a : A) {
+      var test : A = a
+      var b : A = [[t]]
+    }
+  }
+]] complete to "test"
+
+test Complete function call [[
+  entity B {
+    prt() print x
+    g() {
+      var test : String = [[p]]()
+    }
+  }
+]] complete to "prt"
+
+test Complete primitive type 1 [[
+  entity B {
+    t : [[St]]
+  }
+]] complete to "String"
+
+test Complete primitive type 2 [[
+  entity B {
+    t : [[I]]
+  }
+]] complete to "Int"
+
+test Complete entity type 1 [[
+	entity Test {}
+  entity B {
+    t : [[T]]
+  }
+]] complete to "Test"
+
+test Complete entity type 2 [[
+  entity StringLike {}
+  entity B {
+    t : [[StringL]]
+  }
+]] complete to "StringLike"
+
+test Complete joinpoint 1 [[
+	aspect P {
+	    pointcut StringChanged(s : String): assigned(String)
+	    advice Adv1 before(s : String): [[St]](s) print s
+	}
+]] complete to "StringChanged"
+
+test Complete joinpoint 2 [[
+  aspect P {
+      pointcut IntChanged(i : Int): assigned(Int)
+      advice Adv2 after(i : Int): [[I]](i) print i
+  }
+]] complete to "IntChanged"
+
+test Complete advice parameter 1 [[
+  aspect P {
+      pointcut StringChanged(s : String): assigned(String)
+      advice Adv1 before(string : String): StringChanged([[s]]) print string
+  }
+]] complete to "string"
+
+test Complete advice parameter 2 [[
+  aspect P {
+      pointcut IntChanged(i : Int): assigned(Int)
+      advice Adv2 after(integer : Int): IntChanged([[i]]) print integer
+  }
+]] complete to "integer"
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/resolving.spt (from r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/resolving.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/resolving.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/resolving.spt)
@@ -0,0 +1,79 @@
+module Tests-Resolving
+
+language EntityWithAspects
+
+setup Header [[
+  module TestsResolving
+    
+  entity A {
+    x : B
+  }
+]]
+
+test Resolve entity reference [[
+  entity [[B]] {
+    b : [[B]]
+  }
+]] resolve #2 to #1
+
+test Resolve property access [[
+  entity B {
+    f(c : C) {
+      var v : C = c.[[c]] 
+    }
+  }
+  entity C {
+    [[c]] : C
+  }
+]] resolve #1 to #2
+
+test Resolve local variable [[
+  entity B {
+    f() {
+      var [[a]] : A
+      var b : B = [[a]].x
+    }
+  }
+]] resolve #2 to #1
+
+test Resolve local property access [[
+  entity B {
+    [[x]] : A
+    f() {
+      var v : A = [[x]]
+    }
+  }
+]] resolve #2 to #1
+
+test Resolve parameter reference 1 [[
+  entity B {
+    x : A
+    f([[x]] : A) {
+      var v : A = [[x]]
+    }
+  }
+]] resolve #2 to #1
+
+test Resolve parameter reference 2 [[
+  entity B {}
+  aspect P {
+      pointcut StringChanged(s : String): assigned(String)
+      advice Adv1 before([[s]] : String): StringChanged(s) print [[s]]
+  }
+]] resolve #2 to #1
+
+test Resolve parameter reference 3 [[
+  entity B {}
+  aspect P {
+      pointcut StringChanged(s : String): assigned(String)
+      advice Adv1 before([[s]] : String): StringChanged([[s]]) print s
+  }
+]] resolve #2 to #1
+
+test Resolve pointcut [[
+  entity B {}
+  aspect P {
+      pointcut [[StringChanged]](s : String): assigned(String)
+      advice Adv1 before(s : String): [[StringChanged]](s) print s
+  }
+]] resolve #2 to #1
\ No newline at end of file

Copied: spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/tests.spt (from r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/tests.spt)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/unit/tests.spt	Tue May  1 09:37:39 2012	(r24768, copy of r24757, spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/tests.spt)
@@ -0,0 +1,155 @@
+module Tests
+
+language EntityWithAspects
+
+setup Header [[
+  module Tests
+    
+  entity A {
+    x : B
+  }
+]]
+
+test Resolve property access [[
+  entity B {
+    y : A
+    f(a : A) {
+      var v : A = a.x.y.x.y
+      print f(v)
+    }
+  }
+]]
+
+test Resolve property access fails 1 [[
+  entity B {
+    y : A
+    f(a : A) {
+      var v : A = a.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.y.x.x
+    }
+  }
+]] 1 error
+
+test Resolve property access fails 2 [[
+  entity B {
+    f(a : A) {
+      var v : A = a.b.c.d.e.f.g.h.i.j.k.l.m.n.o.p.q.r.s.t.u.v.w.x.y.z
+    }
+  }
+]] 25 errors
+
+test Resolve function call [[
+  entity B {
+    f(a : A) {
+      var v : A = f(a)
+      print f(v)
+    }
+  }
+]]
+
+test Resolve function call fails [[
+  entity B {
+    b : B
+    f(a : A) {
+      var v : A = f(b) 
+    }
+  }
+]] 1 error
+
+test Resolve type fails [[
+  entity B {
+    q : Q
+  }
+]] 1 error
+
+test Unexpected vardef type [[
+  entity B {
+    a : A
+    f() {
+      var v : Int = a.x
+    }
+  }
+]] 1 error
+
+test Unexpected vardef types [[
+  entity B {
+    a : A
+    f() {
+      var v1 : Int = a.x
+      var v2 : String = a.x
+      var v3 : B = a
+    }
+  }
+]] 3 errors
+
+test Unexpected assignment type [[
+  entity B {
+    a : A
+    s : String
+    
+    f() {
+      a = s
+    }
+  }
+]] 1 error
+
+test Unexpected assignment types [[
+  entity B {
+    a : A
+    s : String
+    i : Int
+    
+    f() {
+      a = a.x
+      a = s
+      a = i
+    }
+  }
+]] 3 errors
+
+test Duplicate entity fails [[
+  entity B {}
+  entity B {}
+]] 2 errors
+
+test Duplicate property fails [[
+  entity B {
+    a : Int
+    a : String
+  }
+]] 2 errors
+
+test Duplicate local variable fails [[
+  entity B {
+    f() {
+    	var a : Int
+    	var a : Int
+    }
+  }
+]] 2 errors
+
+test Duplicate function fails [[
+  entity B {
+    a : String
+    
+    f() print a
+    f() print a
+  }
+]] 2 errors
+
+test Shadowing of property allowed [[
+  entity B {
+    a : A
+    f() {
+      var a : A
+      print f()
+      print a.x
+    }
+  }
+]]
+
+test Use before def allowed [[
+  entity B {
+    c : C
+  }
+  entity C {}
+]]

From gabrielkonat at gmail.com  Tue May  1 12:05:08 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 01 May 2012 10:05:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24769 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans
	spoofax-contrib/se...
Message-ID: <20120501100508.10E3ACC089@mx4.tudelft.nl>

Author: gkonat
Date: Tue May  1 10:05:07 2012
New Revision: 24769
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24769&sc=1

Log:
Added splitter to the index but disabled for now.

Added:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Tue May  1 09:37:39 2012	(r24768)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Tue May  1 10:05:07 2012	(r24769)
@@ -26,7 +26,7 @@
     (ast, path, project-path) -> (ast'', errors, warnings, notes, filesToAnalyze')
     with
       ast'                    := <desugar-all> ast; // Optional AST desugaring
-      (ast'', filesToAnalyze) := <analyze-top-multiple(|path, project-path, Editor(), <language>)> <toplevel-split> ast';
+      (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
       index-start-transaction;
       errors                  := <collect-all(constraint-error, conc)> ast'';
       warnings                := <collect-all(constraint-warning, conc)> ast'';
@@ -140,7 +140,7 @@
     where
       editor-init;
       ast'              := <desugar-all> ast;
-      (ast'', _)        := <analyze-top-multiple(|path, project-path, Editor(), <language>)> <toplevel-split> ast';
+      (ast'', _)        := <analyze-top(|<language>)> (ast', path, project-path);
       x                 := <collect-one(?COMPLETION(_))> ast'';
       COMPLETION(name)	:= x;
       index-start-transaction;

Added: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Tue May  1 10:05:07 2012	(r24769)
@@ -0,0 +1,28 @@
+module splitter
+ 
+imports
+ 
+  include/C-without-macros
+  lib/analysis-library
+ 
+rules
+ 
+  index-split = fail
+ 
+  index-is-toplevel = ?TypeDecl(_)
+  index-is-toplevel = ?FunDecl(_, _, _, _)
+ 
+  index-is-qualifier = ?Start(_, _)
+ 
+  index-qualifier-subelements = ?Start(_, <id>)
+ 
+  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
+    
+  /*
+  name = ?TypeDecl(<name>)
+  name = ?FunDecl(_, <id>, _, _)
+  name = ?Start(_, _); !"Global"
+  name = ?TypeDef(_, <id>)
+  name = ?Type(<id>)
+  name = ?StructDecl(<id>, _)
+  */
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Tue May  1 09:37:39 2012	(r24768)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Tue May  1 10:05:07 2012	(r24769)
@@ -25,7 +25,7 @@
     (ast, path, project-path) -> (ast'', errors, warnings, notes, filesToAnalyze')
     with
       ast'                    := <id> ast; // Optional AST desugaring
-      (ast'', filesToAnalyze) := <analyze-top-multiple(|path, project-path, Editor(), <language>)> <toplevel-split> ast';
+      (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
       index-start-transaction;
       errors                  := <collect-all(constraint-error, conc)> ast'';
       warnings                := <collect-all(constraint-warning, conc)> ast'';
@@ -138,7 +138,7 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      (ast', _)         := <analyze-top-multiple(|path, project-path, Editor(), <language>)> <toplevel-split> ast;
+      (ast', _)         := <analyze-top(|<language>)> (ast, path, project-path);
       x                 := <collect-one(?COMPLETION(_))> ast';
       COMPLETION(name)  := x;
       index-start-transaction;

Added: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Tue May  1 10:05:07 2012	(r24769)
@@ -0,0 +1,22 @@
+module splitter
+ 
+imports
+ 
+  include/CSharpPartialClassses
+  lib/analysis-library
+ 
+rules
+ 
+  index-split = fail
+ 
+  index-is-toplevel = ?Class(_, _)
+  index-is-toplevel = ?PartialClass(_, _)
+ 
+  index-is-qualifier = ?Namespace(_, _)
+  index-is-qualifier = ?Start(_, _)
+ 
+  index-qualifier-subelements = ?Namespace(_, <id>)
+  index-qualifier-subelements = ?Start(_, <id>)
+ 
+  index-create-qualifier(|qualifier) = !Namespace(<?Namespace(<id>, _)> qualifier, <id>)
+  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Tue May  1 09:37:39 2012	(r24768)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Tue May  1 10:05:07 2012	(r24769)
@@ -26,7 +26,7 @@
     (ast, path, project-path) -> (ast'', errors, warnings, notes, filesToAnalyze')
     with
       ast'                    := <id> ast; // Optional AST desugaring
-      (ast'', filesToAnalyze) := <analyze-top-multiple(|path, project-path, Editor(), <language>)> <toplevel-split> ast';
+      (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
       index-start-transaction;
       errors                  := <collect-all(constraint-error, conc)> ast'';
       warnings                := <collect-all(constraint-warning, conc)> ast'';
@@ -139,7 +139,7 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      (ast', _)         := <analyze-top-multiple(|path, project-path, Editor(), <language>)> <toplevel-split> ast;
+      (ast', _)         := <analyze-top(|<language>)> (ast, path, project-path);
       x                 := <collect-one(?COMPLETION(_))> ast';
       COMPLETION(name)  := x;
       index-start-transaction;

Added: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Tue May  1 10:05:07 2012	(r24769)
@@ -0,0 +1,25 @@
+module splitter
+ 
+imports
+ 
+  include/EntityWithAspects
+  lib/analysis-library
+ 
+rules
+  
+  index-split = fail
+ 
+  index-is-toplevel = ?Entity(_, _)
+  index-is-toplevel = ?Aspect(_, _)
+ 
+  index-is-qualifier = ?Module(_, _, _)
+ 
+  index-qualifier-subelements = ?Module(_, _, <id>)
+ 
+  index-create-qualifier(|qualifier) = !Module(<?Module(<id>, _, _)> qualifier, <?Module(_, <id>, _)> qualifier, <id>)
+  
+  /*  
+  name = ?Entity(<id>, _)
+  name = ?Aspect(<id>, _)
+  name = ?Module(<id>, _, _)
+  */
\ No newline at end of file

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  1 09:37:39 2012	(r24768)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  1 10:05:07 2012	(r24769)
@@ -77,7 +77,8 @@
    *
    * @see analyze-top(|phase, language)
    */
-  analyze-top(|language) = analyze-top(|Editor(), language)
+  analyze-top(|language):
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)>
    
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
@@ -89,20 +90,26 @@
    *
    * @see analyze-top-internal(|phase, language)
    */
-  analyze-top(|phase, language):
-    (ast, path, project-path) -> (ast', filesToAnalyze)
+  analyze-top(|phase, language, path, project-path):
+    ast -> (ast', filesToAnalyze)
     with
-      Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language)> (ast, path, project-path)
+      if index-split then
+        asts := <index-toplevel-split> ast;
+        (ast', filesToAnalyze) := <analyze-top-multiple(|phase, language, path, project-path)> asts
+      else
+        full-path := $[[project-path]/[path]];
+        Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> ast
+      end
       
-  analyze-top-multiple(|path, project-path, phase, language):
+  analyze-top-multiple(|phase, language, path, project-path):
     asts -> (ast', filesToAnalyze)
     with
       full-path := $[[project-path]/[path]];
-      results := <map(analyze-top-subfile(|path, project-path, full-path, phase, language))> asts;
+      results := <map(analyze-top-subfile(|phase, language, path, project-path, full-path))> asts;
       (ast', filesToAnalyzes) := <unzip> results;
       filesToAnalyze := <concat> filesToAnalyzes
   
-  analyze-top-subfile(|path, project-path, full-path, phase, language):
+  analyze-top-subfile(|phase, language, path, project-path, full-path):
     (ast, subfile) -> (ast', filesToAnalyze)
     with
       Results(ast', _, _, _, _, _, filesToAnalyze) := 
@@ -354,6 +361,42 @@
         complete-work-unit
       end
 
+rules // splitter
+  
+  index-split = fail
+  index-is-toplevel = fail
+  index-is-qualifier = fail
+  index-qualifier-subelements = fail
+  index-create-qualifier(|qualifier) = fail
+  
+  index-toplevel-split = index-toplevel-split(|[])
+  index-toplevel-split(|uri):
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split(|[<nam-get-definition-key> node|uri]))> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, [<nam-get-definition-key> node|uri])]
+        otherwise:
+          <warn(|"Unknown language element found during splitting: ")> node;
+          units := [((), [])]
+      end
+      
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      !elem;
+      switch id
+        case index-is-toplevel:
+          qualifier := <index-create-qualifier(|node)> elem
+        otherwise:
+          qualifier := ()
+      end
+
 rules // diffs
   
   /** @internal */

From gabrielkonat at gmail.com  Tue May  1 16:44:33 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 01 May 2012 14:44:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24770 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans
	spoofax-contrib/se...
Message-ID: <20120501144433.1FC0F2B8017@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  1 14:44:31 2012
New Revision: 24770
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24770&sc=1

Log:
Fixed duplicate definitions after saving.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/generate.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/generate.str	Tue May  1 10:05:07 2012	(r24769)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/generate.str	Tue May  1 14:44:31 2012	(r24770)
@@ -13,5 +13,5 @@
 
 rules // Incremental code generation of project
       
-  index-compile-ast(|file, subfile, project-path) = id
+  index-compile-ast(|file, subfile) = id
   
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str	Tue May  1 10:05:07 2012	(r24769)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str	Tue May  1 14:44:31 2012	(r24770)
@@ -13,5 +13,5 @@
 
 rules // Incremental code generation of project
       
-  index-compile-ast(|file, subfile, project-path) = id
+  index-compile-ast(|file, subfile) = id
   
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str	Tue May  1 10:05:07 2012	(r24769)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str	Tue May  1 14:44:31 2012	(r24770)
@@ -30,7 +30,7 @@
 
 rules // Incremental code generation of project
   		
-  index-compile-ast(|file, subfile, project-path):
+  index-compile-ast(|file, subfile):
     ast -> None()
     with
       java := <to-java> ast;
@@ -45,12 +45,13 @@
 	
   // Constructs
   to-java: 
-    Module(name, entities) ->
+    Module(name, imports, entities) ->
     $[package [name];
-
+      [imports']
       [entities']]
 		where 
-			entities' := <map(to-java)> entities
+			entities' := <map(to-java)> entities;
+			imports' := <map(to-java)> imports
 			
 	to-java: Aspect(_, _) -> "" // Aspects are ignored in simple code generation, they should already be handled.
 	

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  1 10:05:07 2012	(r24769)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  1 14:44:31 2012	(r24770)
@@ -12,7 +12,7 @@
   index-desugar-ast = fail
     
   // Should compile given analysed ast.
-  index-compile-ast(|file, subfile, project-path) = fail
+  index-compile-ast(|file, subfile) = fail
   
 rules // Compilation
   
@@ -51,17 +51,16 @@
     (path, subfile) -> None()
     with
       // Parse and analyze ast.
-      full-path                        := $[[project-path]/[path]];
       ast                              := <parse-file> path;
       ast'                             := <try(index-desugar-ast)> ast;
-      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, full-path, subfile)> ast'
+      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path, subfile)> ast'
     with
       {| Index-ReadSet:
         readSet := <new-iset>;
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <index-compile-ast(|path, subfile, project-path)> ast';
+        <index-compile-ast(|path, subfile)> ast';
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;

From gabrielkonat at gmail.com  Tue May  1 17:00:18 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 01 May 2012 15:00:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24771 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120501150018.70D017F8013@mx1.tudelft.nl>

Author: gkonat
Date: Tue May  1 15:00:17 2012
New Revision: 24771
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24771&sc=1

Log:
Fixed passing wrong ast for compilation.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/analysis-manual.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/analysis-manual.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/analysis-manual.str	Tue May  1 14:44:31 2012	(r24770)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/analysis-manual.str	Tue May  1 15:00:17 2012	(r24771)
@@ -27,10 +27,6 @@
 	    else
 	      p* := StopLookup()
 	    end
-
-  // Return both local variables and fields.
-  adjust-index-lookup(target |namespace, path, prefix):
-    VarRef(<target>) -> [[Var() | path], [Field() | path]]
     
   // Add typedefs from included files.
   adjust-index-lookup(target |namespace, path, prefix): 

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  1 14:44:31 2012	(r24770)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  1 15:00:17 2012	(r24771)
@@ -60,7 +60,7 @@
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <index-compile-ast(|path, subfile)> ast';
+        <index-compile-ast(|path, subfile)> ast'';
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;

From g.h.wachsmuth at tudelft.nl  Thu May  3 01:33:26 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 02 May 2012 23:33:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24772 -
	spoofax-imp/trunk/org.strategoxt.imp.names
Message-ID: <20120502233326.7D0762B8009@mx2.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed May  2 23:33:24 2012
New Revision: 24772
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24772&sc=1

Log:
Initial import.

Added:
   spoofax-imp/trunk/org.strategoxt.imp.names/

From g.h.wachsmuth at tudelft.nl  Thu May  3 01:35:16 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 02 May 2012 23:35:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24773 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: .
	.externalToolBuilders .settings META-INF editor editor/java
	editor/java/org editor/java/org/strategoxt editor/java...
Message-ID: <20120502233516.82B44CC110@mx4.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed May  2 23:35:15 2012
New Revision: 24773
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24773&sc=1

Log:
initial version of a declarative name declaration language (syntax-only so far)

Added:
   spoofax-imp/trunk/org.strategoxt.imp.names/.classpath
   spoofax-imp/trunk/org.strategoxt.imp.names/.externalToolBuilders/
   spoofax-imp/trunk/org.strategoxt.imp.names/.externalToolBuilders/NameDefinitionLanguage build.main.xml.launch
   spoofax-imp/trunk/org.strategoxt.imp.names/.project
   spoofax-imp/trunk/org.strategoxt.imp.names/.settings/
   spoofax-imp/trunk/org.strategoxt.imp.names/.settings/org.eclipse.jdt.core.prefs
   spoofax-imp/trunk/org.strategoxt.imp.names/META-INF/
   spoofax-imp/trunk/org.strategoxt.imp.names/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.names/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.names/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.names/build.properties
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Colorer.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Folding.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Outliner.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-References.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage.main.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/Activator.java
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageParseController.java
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageParseControllerGenerated.java
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageValidator.java
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/InteropRegisterer.java
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/Main.java
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/java_strategy_0_0.java
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/compilation-library.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/index-library.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/refactor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/plugin.xml
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/Common.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.pp
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Constants.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Identifiers.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Layout.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Signatures.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-StringQuotations.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Terms.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/test/
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.analyzed.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd
   spoofax-imp/trunk/org.strategoxt.imp.names/test/test-example.spt
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/refactor.str

Added: spoofax-imp/trunk/org.strategoxt.imp.names/.classpath
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/.classpath	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<classpath>
+	<classpathentry kind="src" excluding="trans/**" path="editor/java"/>
+	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/J2SE-1.5"/>
+	<classpathentry kind="con" path="org.eclipse.pde.core.requiredPlugins"/>
+	<classpathentry kind="con" path="org.eclipse.jdt.junit.JUNIT_CONTAINER/4"/>
+	<classpathentry kind="output" path="bin"/>
+</classpath>
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/.externalToolBuilders/NameDefinitionLanguage build.main.xml.launch
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/.externalToolBuilders/NameDefinitionLanguage build.main.xml.launch	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,23 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no"?>
+<launchConfiguration type="org.eclipse.ant.AntLaunchConfigurationType">
+<stringAttribute key="bad_container_name" value=".externalToolBuilders"/>
+<booleanAttribute key="org.eclipse.ant.ui.DEFAULT_VM_INSTALL" value="false"/>
+<listAttribute key="org.eclipse.debug.core.MAPPED_RESOURCE_PATHS"/>
+<listAttribute key="org.eclipse.debug.core.MAPPED_RESOURCE_TYPES"/>
+<booleanAttribute key="org.eclipse.debug.ui.ATTR_LAUNCH_IN_BACKGROUND" value="false"/>
+<listAttribute key="org.eclipse.jdt.launching.CLASSPATH">
+<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#10;&lt;runtimeClasspathEntry containerPath=&quot;org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/java-1.5.0-sun-1.5.0.18&quot; path=&quot;1&quot; type=&quot;4&quot;/&gt;&#10;"/>
+<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#10;&lt;runtimeClasspathEntry id=&quot;org.eclipse.ant.ui.classpathentry.antHome&quot;&gt;&#10;&lt;memento default=&quot;true&quot;/&gt;&#10;&lt;/runtimeClasspathEntry&gt;&#10;"/>
+<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#10;&lt;runtimeClasspathEntry id=&quot;org.eclipse.ant.ui.classpathentry.extraClasspathEntries&quot;&gt;&#10;&lt;memento/&gt;&#10;&lt;/runtimeClasspathEntry&gt;&#10;"/>
+</listAttribute>
+<stringAttribute key="org.eclipse.jdt.launching.CLASSPATH_PROVIDER" value="org.eclipse.ant.ui.AntClasspathProvider"/>
+<booleanAttribute key="org.eclipse.jdt.launching.DEFAULT_CLASSPATH" value="false"/>
+<stringAttribute key="org.eclipse.jdt.launching.PROJECT_ATTR" value=""/>
+<stringAttribute key="org.eclipse.jdt.launching.SOURCE_PATH_PROVIDER" value="org.eclipse.ant.ui.AntClasspathProvider"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_ANT_TARGETS" value="all,"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_LAUNCH_CONFIGURATION_BUILD_SCOPE" value="${none}"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_LOCATION" value="${workspace_loc:/org.strategoxt.imp.names/build.main.xml}"/>
+<booleanAttribute key="org.eclipse.ui.externaltools.ATTR_TRIGGERS_CONFIGURED" value="true"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_WORKING_DIRECTORY" value="${workspace_loc:/org.strategoxt.imp.names}"/>
+<stringAttribute key="process_factory_id" value="org.eclipse.ant.ui.remoteAntProcessFactory"/>
+</launchConfiguration>

Added: spoofax-imp/trunk/org.strategoxt.imp.names/.project
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/.project	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<projectDescription>
+      <name>org.strategoxt.imp.names</name>
+      <comment></comment>
+      <buildSpec>
+        <buildCommand>
+          <name>org.eclipse.jdt.core.javabuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+        <buildCommand>
+            <name>org.eclipse.ui.externaltools.ExternalToolBuilder</name>
+            <triggers>full,incremental,</triggers>
+            <arguments>
+                <dictionary>
+                    <key>LaunchConfigHandle</key>
+                    <value>&lt;project&gt;/.externalToolBuilders/NameDefinitionLanguage build.main.xml.launch</value>
+                </dictionary>
+            </arguments>
+        </buildCommand>
+        <buildCommand>
+          <name>org.eclipse.pde.ManifestBuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+        <buildCommand>
+          <name>org.eclipse.pde.SchemaBuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+      </buildSpec>
+      <natures>
+        <nature>org.eclipse.pde.PluginNature</nature>
+        <nature>org.eclipse.jdt.core.javanature</nature>
+      </natures>
+    </projectDescription>
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/.settings/org.eclipse.jdt.core.prefs
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/.settings/org.eclipse.jdt.core.prefs	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,11 @@
+eclipse.preferences.version=1
+org.eclipse.jdt.core.compiler.codegen.inlineJsrBytecode=enabled
+org.eclipse.jdt.core.compiler.codegen.targetPlatform=1.5
+org.eclipse.jdt.core.compiler.codegen.unusedLocal=preserve
+org.eclipse.jdt.core.compiler.compliance=1.5
+org.eclipse.jdt.core.compiler.debug.lineNumber=generate
+org.eclipse.jdt.core.compiler.debug.localVariable=generate
+org.eclipse.jdt.core.compiler.debug.sourceFile=generate
+org.eclipse.jdt.core.compiler.problem.assertIdentifier=error
+org.eclipse.jdt.core.compiler.problem.enumIdentifier=error
+org.eclipse.jdt.core.compiler.source=1.5

Added: spoofax-imp/trunk/org.strategoxt.imp.names/META-INF/MANIFEST.MF
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/META-INF/MANIFEST.MF	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,21 @@
+Manifest-Version: 1.0
+Bundle-ManifestVersion: 2
+Bundle-Name: NameDefinitionLanguage Plug-in
+Bundle-SymbolicName: org.strategoxt.imp.names; singleton:=true
+Bundle-Version: 1.0.0
+Bundle-Activator: org.strategoxt.imp.names.Activator
+Import-Package: org.osgi.framework;version="1.3.0"
+Require-Bundle: org.eclipse.core.runtime,
+  org.eclipse.core.resources,
+  org.eclipse.imp.runtime,
+  org.eclipse.ui,
+  lpg.runtime,
+  org.eclipse.jface.text,
+  org.eclipse.ui.editors,
+  org.eclipse.ui.workbench.texteditor,
+  org.strategoxt.imp.runtime,
+  org.spoofax.jsglr,
+  org.strategoxt.strj
+Bundle-RequiredExecutionEnvironment: J2SE-1.5
+Bundle-ActivationPolicy: lazy
+Export-Package: org.strategoxt.imp.names

Added: spoofax-imp/trunk/org.strategoxt.imp.names/build.generated.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/build.generated.xml	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,640 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<project name="build.generated">
+
+        <target name="spoofaximp.default" depends="spoofaximp.default.ctree"/>
+        <target name="spoofaximp.default.ctree" depends="check-classpath,init,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,java.jar,stratego.ctree,sdf2imp,refresh"/>
+        <target name="spoofaximp.default.jar" depends="check-classpath,init,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,java.jar,stratego.jar.helper,sdf2imp,refresh"/>
+    
+        <!-- Initialization -->
+        <available file="${src-gen}/org/strategoxt/imp/names/strategies/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.strategoxt.imp.names.strategies" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
+        <dirname property="externaldefdir" file="${externaldef}"/>
+        <condition property="externaldefimport" value="-I &quot;${externaldefdir}&quot;" else="">
+            <isset property="externaldef"/>
+        </condition>
+        <condition property="externaljarimport1" value=":${externaljar}" else="">
+            <isset property="externaljar"/>
+        </condition>
+        <condition property="externaljarimport2" value=":${externaljarx}" else="">
+            <isset property="externaljarx"/>
+        </condition>
+        <condition property="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter">
+            <isset property="eclipse.running"/>
+        </condition>
+        <condition property="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter">
+            <available classname="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+        </condition>
+        <condition property="externaljarflags" value="${externaljarflags}" else="">
+            <isset property="externaljarflags"/>
+        </condition>
+        <condition property="metasdfmodule.available" value="1">
+            <available file="${syntax}/${metasdfmodule}.sdf"/>
+        </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
+        <mkdir dir="${build}"/>
+        <mkdir dir="${src-gen}"/>
+        <mkdir dir="${dist}"/>
+        <mkdir dir="${include}"/>
+        <mkdir dir="${lib}"/>
+        <mkdir dir="${syntax}"/>
+
+        <target name="sdf2imp" depends="sdf2table,sdf2imp.eclipse,sdf2imp.standalone,sdf2parenthesize"/>
+        
+        <target name="sdf2imp.eclipse" if="eclipse.running" depends="sdf2rtg">
+            <java classname="org.strategoxt.imp.metatooling.building.AntDescriptorBuilder" failonerror="true">
+                <arg value="${include}/${esvmodule}.packed.esv"/>
+            </java>
+        </target>
+        
+        <target name="refresh" if="eclipse.running">
+            <eclipse.convertPath fileSystemPath="${basedir}" property="projectdir"/>
+            <eclipse.convertPath fileSystemPath="${syntax}" property="syntaxdir"/>
+            <eclipse.convertPath fileSystemPath="${lib}" property="libdir"/>
+            <eclipse.refreshLocal resource="${libdir}" depth="infinite"/>
+            <eclipse.refreshLocal resource="${syntaxdir}/${sdfmodule}.pp.generated" depth="infinite"/>
+            <eclipse.refreshLocal resource="${libdir}/editor-common.generated.str" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/build.generated.xml" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Builders.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Colorer.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Completions.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Folding.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-References.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Syntax.generated.esv" depth="infinite"/>
+            <eclipse.convertPath fileSystemPath="${src-gen}" property="eclipse.path.src-gen"/>
+            <eclipse.refreshLocal resource="${eclipse.path.src-gen}" depth="infinite"/>
+            <eclipse.convertPath fileSystemPath="${build}" property="eclipse.path.build"/>
+            <eclipse.refreshLocal resource="${eclipse.path.build}" depth="infinite"/>
+            <!-- Might cause the editor to be reloaded?
+            <eclipse.refreshLocal resource="${projectdir}/include" depth="infinite" />
+            -->
+        </target>
+        
+        <target name="sdf2imp.standalone" unless="eclipse.running" depends="sdf2rtg">
+            <java classname="org.strategoxt.imp.generator.sdf2imp" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${basedir}/editor/${esvmodule}.main.esv"/>
+                <arg value="-p"/>
+                <arg value="${include}/${sdfmodule}.tbl"/>
+            </java>
+        </target>
+        
+        <target name="check-classpath">
+            <available classname="org.strategoxt.imp.generator.sdf2imp" property="check-classpath.available"/>
+            <antcall target="check-classpath.helper"/>  
+        </target>
+        
+        <target name="init" if="eclipse.running">
+            <!-- refresh one file/dir in the project to trigger an Ant rebuild with the next build command -->
+            <java classname="org.strategoxt.imp.metatooling.building.AntForceRefreshScheduler" failonerror="false">
+                <arg value="${include}"/>
+            </java>
+        </target>
+  
+        <target name="check-classpath.helper" unless="check-classpath.available">
+            <echo level="error" message="Could not load the Spoofax plugin loading classes."/>
+            <echo level="error" message="Make sure it is on the class path."/>
+            <echo level="error" message=""/>               
+            <echo level="error" message="In Eclipse, make sure the Ant builder is configured properly:"/>
+            <echo level="error" message="right-click on build.main.xml, go to Run as, Ant build..., JRE tab,"/>
+            <echo level="error" message="and ensure Run in the same JRE as the workspace is selected"/>
+            <echo level="error" message="alternatively, build the project using Build Project in the Project menu"/>
+            <fail/>
+        </target>
+    
+        <target name="sdf2table" depends="make-permissive">
+            <apply executable="${build.strategoxt.sdf}sdf2table" dest="${include}" failonerror="true">
+                <arg value="-i"/>
+                <srcfile/>
+                <arg value="-o"/>
+                <targetfile/>
+                <arg value="-m"/>
+                <arg value="${sdfmodule}"/>
+                
+                <fileset file="${include}/${sdfmodule}-Permissive.def"/>
+                <mapper type="glob" from="*-Permissive.def" to="*.tbl"/>
+            </apply>
+        </target>
+        
+        <target name="meta-sdf2table" if="metasdfmodule.available">
+            <fail unless="eclipse.spoofaximp.jars" message="Property eclipse.spoofaximp.jars must point to the directory containing StrategoMix.def"/>
+            <antcall target="sdf2table">
+                <param name="sdfmodule" value="${metasdfmodule}"/>
+                <param name="build.sdf.imports" value="-Idef &quot;${eclipse.spoofaximp.jars}/StrategoMix.def&quot; ${build.sdf.imports}"/>
+            </antcall>
+            <antcall target="meta-sdf2table.helper"/>
+        </target>
+        
+        <target name="meta-sdf2table.helper" if="eclipse.running">
+           <eclipse.convertPath fileSystemPath="${include}" property="includeresource"/>
+           <eclipse.refreshLocal resource="${includeresource}/${metasdfmodule}.tbl" depth="infinite"/>
+        </target>
+        
+        <target name="make-permissive" depends="pack-sdf,copy-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${include}/${sdfmodule}-Permissive.def"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}-Permissive.def" property="permissive-grammar.available"/>
+            <antcall target="make-permissive.helper"/>
+        </target>
+    
+        <target name="make-permissive.helper" unless="permissive-grammar.available">
+            <java classname="org.strategoxt.permissivegrammars.make_permissive" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}-Permissive.def"/>
+                <arg line="--optimize on"/>
+            </java>
+        </target>
+
+        <target name="utils-files"> <!-- only useful for builds outside of Eclipse -->
+            <mkdir dir="utils"/>
+            <copy file="${eclipse.spoofaximp.jars}/make_permissive.jar" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.jars}/sdf2imp.jar" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.jars}/aster.jar" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.strategojar}" todir="utils" failonerror="false"/>
+        </target>
+    
+        <target name="pack-sdf" unless="externaldef">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.sdf"/>
+                </srcfileset>
+                <srcfileset dir="${lib}">
+                    <include name="**/*.def"/>
+                </srcfileset>
+                <targetfileset file="${include}/${sdfmodule}.def"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.def" property="pack-sdf.available"/>
+            <antcall target="pack-sdf.helper"/>
+        </target>
+    
+        <target name="pack-sdf.helper" unless="pack-sdf.available">
+            <condition property="utils-include" value="-I ${utils}" else="">
+                <available file="${utils}"/>
+            </condition>
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-pack-sdf"/>
+                <arg value="-i"/>
+                <arg value="${syntax}/${sdfmodule}.sdf"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-I"/>
+                <arg value="${syntax}"/>
+                <arg value="-I"/>
+                <arg value="${lib}"/>
+                <arg line="${utils-include}"/>
+                <arg line="${build.sdf.imports}"/>
+            </java>
+        </target>
+    
+        <target name="copy-sdf" if="externaldef">
+            <copy file="${externaldef}" tofile="${include}/${sdfmodule}.def" preservelastmodified="true"/>
+        </target>
+    
+        <target name="copy-jar" if="externaljar">
+            <copy file="${externaljar}" todir="${include}" preservelastmodified="true"/>
+        </target>
+    
+        <target name="rtg2sig" if="build.stratego.enabled" depends="sdf2rtg">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.rtg"/>
+                <targetfileset file="${include}/${sdfmodule}.str"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.str" property="rtg2sig.available"/>
+            <antcall target="rtg2sig.helper"/>
+        </target>
+    
+        <target name="rtg2sig.helper" unless="rtg2sig.available">
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-rtg2sig"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.rtg"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.str"/>
+                <arg value="--module"/>
+                <arg value="${sdfmodule}"/>
+            </java>
+        </target>
+        
+        <target name="sdf2rtg" depends="pack-sdf,copy-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${include}/${sdfmodule}.rtg"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.rtg" property="sdf2rtg.available"/>
+            <antcall target="sdf2rtg.helper"/>
+        </target>
+    
+        <target name="sdf2rtg.helper" unless="sdf2rtg.available">
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-sdf2rtg"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-m"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.rtg"/>
+                <arg value="--ignore-missing-cons"/>
+                <arg value="-Xnativepath"/>
+                <arg value="${build.strategoxt.sdf}"/>
+            </java>
+        </target>
+        
+        <target name="sdf2parenthesize" depends="pack-sdf,copy-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${include}/${sdfmodule}-parenthesize.str"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}-parenthesize.str" property="sdf2parenthesize.available"/>
+            <antcall target="sdf2parenthesize.helper"/>
+            <available file="${include}/${sdfmodule}-parenthesize.str" property="sdf2parenthesize.available"/>
+            <antcall target="sdf2parenthesize.helper.fallback"/>
+        </target>
+
+        <target name="sdf2parenthesize.helper" unless="sdf2parenthesize.available">
+            <java classname="run" failonerror="false">
+                <arg value="org.strategoxt.tools.main-sdf2parenthesize"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-m"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}-parenthesize.str"/>
+                <arg value="--omod"/>
+                <arg value="include/${sdfmodule}-parenthesize"/>
+                <arg value="--main-strategy"/>
+                <arg value="io-${sdfmodule}-parenthesize"/>
+                <arg value="--lang"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="--rule-prefix"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="--sig-module"/>
+                <arg value="include/${sdfmodule}"/>
+            </java>
+        </target>
+
+    	<target name="sdf2parenthesize.helper.fallback" unless="sdf2parenthesize.available">
+        	<echo file="${include}/${sdfmodule}-parenthesize.str" message="module include/${sdfmodule}-parenthesize rules parenthesize-${sdfmodule} = id"/>
+    	</target>
+        
+        <target name="ppgen" if="build.stratego.enabled" depends="pack-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${syntax}/${sdfmodule}.generated.pp"/>
+                <targetfileset file="${include}/${sdfmodule}.generated.pp.af"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.generated.pp.af" property="ppgen.available"/>
+            <antcall target="ppgen.helper"/>
+            <available file="${include}/${sdfmodule}.generated.pp.af" property="ppgen.available"/>
+            <antcall target="ppgen.helper.fallback"/>
+        </target>
+    
+        <target name="ppgen.helper" unless="ppgen.available">
+            <!-- Any failures here are ignored; they are only a problem when imported from Stratego -->
+            <java classname="run" failonerror="false">
+                <arg value="org.strategoxt.tools.main-ppgen"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-t"/>
+                <arg value="-b"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.generated.pp.af"/>
+            </java>
+            <java classname="run" failonerror="false">
+                <arg value="org.strategoxt.tools.main-pp-pp-table"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.generated.pp.af"/>
+                <arg value="-o"/>
+                <arg value="${syntax}/${sdfmodule}.generated.pp"/>
+            </java>
+        </target>
+    
+        <target name="ppgen.helper.fallback" unless="ppgen.available">
+            <echo file="${include}/${sdfmodule}.generated.pp.af" message="PP-Table([])"/>
+        </target>
+        
+        <target name="pppack" if="build.stratego.enabled" depends="pack-sdf">
+            <dependset>
+                <srcfileset file="${syntax}/${sdfmodule}.pp"/>
+                <targetfileset file="${include}/${sdfmodule}.pp.af"/>
+            </dependset>
+            <available file="${syntax}/${sdfmodule}.pp" property="pppack.source-available"/>
+            <available file="${include}/${sdfmodule}.pp.af" property="pppack.available"/>
+            <antcall target="pppack.helper"/>
+            <available file="${include}/${sdfmodule}.pp.af" property="pppack.available"/>
+            <antcall target="pppack.helper.fallback"/>
+        </target>
+    
+        <target name="pppack.helper" unless="pppack.available" if="pppack.source-available">
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-parse-pp-table"/>
+                <arg value="-i"/>
+                <arg value="${syntax}/${sdfmodule}.pp"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.pp.af"/>
+            </java>
+        </target>
+    
+        <target name="pppack.helper.fallback" unless="pppack.available">
+            <echo file="${include}/${sdfmodule}.pp.af" message="PP-Table([])"/>
+        </target>
+    
+        <!-- Aster to Stratego -->
+        <target name="stratego.aster">
+            <available file="${trans}/${strmodule}.rtree" property="aster-output.available"/>
+            <fileset dir="${basedir}" id="aster-input-set">
+              <include name="**/*.astr"/>
+            </fileset>
+            <pathconvert pathsep=" " setonempty="false" property="aster-input" refid="aster-input-set"/>
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.astr"/>
+                </srcfileset>
+                <targetfileset file="${trans}/${strmodule}.rtree"/>
+            </dependset>
+            <condition property="aster-output.uptodate">
+                <and>
+                    <isset property="aster-output.available"/>
+                    <available file="${trans}/${strmodule}.rtree"/>
+                </and>
+            </condition>
+            <available file="${trans}/${strmodule}.rtree" property="aster-output.uptodate"/>
+            <antcall target="stratego.aster.helper"/>
+        </target>
+    
+        <target name="stratego.aster.helper" if="aster-input" unless="aster-output.uptodate">
+            <java classname="org.strategoxt.aster.Main" failonerror="true">
+                <arg value="-i"/>
+                <arg line="${aster-input}"/>
+            </java>
+        </target>
+        
+        <target name="java.jar" if="java.jar.enabled">
+            <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
+        </target>
+    
+        <!-- Stratego to Java interpreter -->
+        <target name="stratego.ctree" depends="rtg2sig">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.str"/>
+                    <include name="**/*.astr"/>
+                    <exclude name="lib/*.generated.str"/>
+                </srcfileset>
+                <targetfileset file="${include}/${strmodule}.ctree"/>
+            </dependset>
+            <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
+            <antcall target="copy-jar"/>
+            <antcall target="stratego.jvm.helper">
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
+                <param name="build.stratego.extraargs" value="-F"/>
+            </antcall>
+        </target>
+    
+        <!-- Stratego to Java compiler -->
+        <target name="stratego.jar" depends="rtg2sig,utils-files">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.str"/>
+                    <include name="**/*.astr"/>
+                    <exclude name="lib/*.generated.str"/>
+                </srcfileset>
+                <targetfileset file="${src-gen}/trans/Main.java"/>
+            </dependset>
+            <available file="${src-gen}/trans/Main.java" property="strc-java.available"/>
+            <antcall target="copy-jar"/>
+            <antcall target="stratego.jar.deletehelper"/>
+            <antcall target="stratego.jvm.helper">
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
+            </antcall>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport1}${externaljarimport2}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <!-- copy imported terms -->
+            <copy todir="${build}/trans">
+                <fileset dir="${src-gen}/trans" excludes="**/*.java"/>
+            </copy>
+            <jar basedir="${build}" includes="trans/**" destfile="${include}/${strmodule}.tmp.jar"/>
+            <move file="${include}/${strmodule}.tmp.jar" tofile="${include}/${strmodule}.jar"/>
+            <delete><fileset dir="${build}" includes="trans/**"/></delete>
+        </target>
+        
+        <target name="stratego.jar.deletehelper" unless="strc-java.available">
+            <delete>
+                <fileset dir="${src-gen}" includes="trans/**"/>
+                <fileset dir="${build}" includes="trans/**"/>
+            </delete>
+        </target>
+            
+        <target name="stratego.jvm.helper" unless="strc-java.available" if="build.stratego.enabled">
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <java classname="org.strategoxt.strj.Main" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${trans}/${strmodule}.str"/>
+                <arg value="-o"/>
+                <arg value="${build.stratego.outputfile}"/>
+                <arg value="-p"/>
+                <arg value="trans"/>
+                <arg value="--library"/>
+                <arg value="--clean"/>
+                <arg line="${build.stratego.args}"/>
+                <arg line="${build.stratego.extraargs}"/>
+                <arg line="${externaljarflags}"/>
+                <arg line="${externaldefimport}"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+            </java>
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <mkdir dir="${build}/trans"/>
+        </target>
+                
+        <!-- begin: targets used for adding debugging instrumentation to stratego -->
+        
+        <!-- 
+            if "debug.the.debug.transformer" is set, debug the debug instrumentation, do not output rtree-files, but str-files
+            Only used by stratego.jvm.helper.debug 
+        -->
+        <condition property="transformer-output" value="" else="--output-rtree">
+            <isset property="debug.the.debug.transformer"/>
+        </condition>
+        
+        <!-- 
+            if debug.the.debug.transformer is set then the debug.transformer outputs str files, so the strj-compiler should accept a str-file.
+            if debug.the.debug.transformer is NOT set then the debug.transformer outputs rtree files (much faster generated), so the strj-compiler should accept a rtree-file
+            Only used by stratego.jvm.helper.debug
+        -->
+        <condition property="strj.input.file.type" value="str" else="rtree">
+            <isset property="debug.the.debug.transformer"/>
+        </condition>
+        
+        <!-- value determines which target will be executed.
+            If the file ".debugmode" can be found in the project root call stratego.jar.debug
+            else call stratego.jar
+        -->
+        <condition property="stratego.jar.target" value="call.stratego.jar.debug" else="call.stratego.jar">
+            <available file=".debugmode"/>
+        </condition>
+        
+        <!-- will save the stratego files with debug info in this folder -->
+        <property name="trans-debug" location="trans-debug"/>
+        
+        <!-- this helper target determines what target to call, based on debug.build.enabled -->
+        <target name="stratego.jar.helper">
+            <antcall target="${stratego.jar.target}"/>
+        </target>
+        
+        <!-- call stratego.jar unless debug.build.enabled property is set --> 
+        <target name="call.stratego.jar" depends="stratego.jar">
+            <echo message="call.stratego.jar - ${stratego.jar.target}"/>
+        </target>
+        
+        <!-- call stratego.jar.debug when debug.build.enabled property is set -->
+        <target name="call.stratego.jar.debug" depends="stratego.jar.debug">
+            <echo message="call.stratego.jar.debug - ${stratego.jar.target}"/>
+        </target>
+        
+        <!-- copy stratego runtime jars to utils folder -->
+        <target name="utils-files-debug" depends="utils-files">
+            <copy file="${eclipse.spoofaximp.stratego-debug-runtime-jar}" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.stratego-debug-runtime-java-jar}" todir="utils" failonerror="false"/>
+        </target>
+        
+        <!-- Stratego to Java compiler with debugging capabilities -->
+        <target name="stratego.jar.debug" depends="rtg2sig,utils-files-debug">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.str"/>
+                    <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
+                </srcfileset>
+                <targetfileset file="${src-gen}/trans/Main.java"/>
+            </dependset>
+            <available file="${src-gen}/trans/Main.java" property="strc-java.available"/>
+            <antcall target="copy-jar"/>
+            <antcall target="stratego.jar.deletehelper"/>
+            <!-- compile stratego to java -->
+            <antcall target="stratego.jvm.helper.debug">
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
+            </antcall>
+            <!-- compile java to class -->
+            <javac destdir="${build}" source="1.5" target="1.5" debug="on">
+                <!-- attribute in javac: srcdir="${src-gen}" -->
+                <src path="${src-gen}"/>
+                <!-- attribute in javac: classpath="utils/strategoxt.jar:${src-gen}${externaljarimport1}${externaljarimport2}${java.jar.classpath}"  -->
+                <classpath>
+                    <pathelement path="utils/strategoxt.jar:${src-gen}${externaljarimport1}${externaljarimport2}${java.jar.classpath}"/> <!-- the path attribute accepts colon- or semicolon-separated lists of locations -->
+                    <pathelement location="utils/stratego-debug-runtime.jar"/> <!-- The location attribute specifies a single file or directory relative to the project's base directory (or an absolute filename) -->
+                    <pathelement location="utils/stratego-debug-runtime-java.jar"/>
+                </classpath>
+                <!-- attribute in javac: includes="trans/**"  -->
+                <include name="trans/**"/>
+            </javac>
+            <!-- copy imported terms -->
+            <copy todir="${build}/trans">
+                <fileset dir="${src-gen}/trans" excludes="**/*.java"/>
+            </copy>
+            <!-- create a jar from the class files -->
+            <jar basedir="${build}" includes="trans/**" destfile="${include}/${strmodule}.tmp.jar"/>
+            <move file="${include}/${strmodule}.tmp.jar" tofile="${include}/${strmodule}.jar"/>
+            <delete><fileset dir="${build}" includes="trans/**"/></delete>
+        </target>
+        
+        <!-- instrument the stratego program and compile it to java -->
+        <target name="stratego.jvm.helper.debug" unless="strc-java.available" if="build.stratego.enabled">
+            <echo message="generate stratego with debug information"/>
+            <echo message="${basedir}"/>
+            <available classname="org.strategoxt.imp.debug.stratego.transformer.trans.Main" property="transformer.available"/>
+            <!-- add debug information -->
+              <java classname="org.strategoxt.imp.debug.stratego.transformer.trans.Main" failonerror="true" fork="true">
+                   <classpath>
+                    <pathelement location="${eclipse.spoofaximp.stratego-transformer-jar}"/>
+                       <pathelement location="${eclipse.spoofaximp.stratego-transformer-java-jar}"/>
+                       <pathelement location="${eclipse.spoofaximp.strategojar}"/>
+                   </classpath>
+                  <arg value="-i"/>
+                  <arg value="${trans}/${strmodule}.str"/>
+                  <arg value="--gen-dir"/>
+                  <arg value="${trans-debug}"/>
+                  <arg value="--base-dir"/> <!-- set the basedir to the project dir -->
+                  <arg value="${basedir}"/>
+                  <!-- "arg line='val'" val should contain space-separated arguments --> 
+                  <arg line="--charoffset-converter --fail-catch ${transformer-output}"/>
+                  
+                  <!-- arguments should start with two '-'-characters -->
+                  <!-- <arg value="-charoffset-converter"/> --> <!-- create charoffset table -->
+                  <!-- <arg value="-fail-catch"/>  --> <!-- catch failures in where/with-clauses in rules -->
+                  <!-- <arg value="-output-rtree"/> --> 
+            </java>
+            <!-- now compile instrumented stratego to java -->
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <java classname="org.strategoxt.strj.Main" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${trans-debug}/trans/${strmodule}.${strj.input.file.type}"/>
+                <arg value="-o"/>
+                <arg value="${build.stratego.outputfile}"/>
+                <arg value="-p"/>
+                <arg value="trans"/>
+                <arg value="--library"/>
+                <arg value="--clean"/>
+                <arg line="${build.stratego.args}"/>
+                <arg line="${build.stratego.extraargs}"/>
+                <arg line="${externaljarflags}"/>
+                <arg line="${externaldefimport}"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <!-- put strategodebuglib.rtree on the include path -->
+                <arg line="-I &quot;${eclipse.spoofaximp.strategodebuglib-folder}&quot;"/>
+                <arg line="-la org.strategoxt.imp.debug.stratego.runtime.trans"/>
+            </java>
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <mkdir dir="${build}/trans"/>
+        </target>
+        
+        
+        <!-- end: targets used for adding debugging instrumentation to stratego -->
+
+
+        <!-- Stratego to C-based native executable -->
+        <target name="stratego.c">
+            <antcall target="stratego.c.helper">
+                <param name="build.stratego.outputpath" value="${basedir}/include"/>
+                <param name="build.stratego.extraargs" value=""/>
+                <param name="build.stratego.extension" value=""/>
+                <param name="build.stratego.compiler" value="strc"/>
+            </antcall>
+        </target>
+        
+        <!-- Helper target for calling the stratego compiler -->
+        <target name="stratego.c.helper" depends="rtg2sig" if="build.stratego.enabled">
+            <apply executable="${build.strategoxt.stratego}/${build.stratego.compiler}" dest="${build.stratego.outputpath}" failonerror="true">
+                <arg value="-i"/>
+                <srcfile/>
+                <arg value="-o"/>
+                <targetfile/>
+                <arg line="${build.stratego.args}"/>
+                <arg line="${build.stratego.extraargs}"/>
+                <arg line="${externaldefimport}"/>
+                <arg line="-I &quot;${lib}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+                
+                <fileset file="${trans}/${strmodule}.str"/>
+                <mapper type="glob" from="*.str" to="*.${build.stratego.extension}"/>
+            </apply>
+        </target>
+        
+        <target name="clean" description="Selective clean up">
+            <delete dir="${build}"/>
+            <delete file="${include}/${sdfmodule}.def"/>
+            <delete file="${include}/${strmodule}.rtree"/>
+            <delete file="${include}/${strmodule}.ctree"/>
+            <delete file="${include}/${strmodule}.jar"/>
+            <delete dir="${src-gen}/trans"/>
+        </target>
+    </project>
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/build.main.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/build.main.xml	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,44 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<project name="NameDefinitionLanguage" default="all">
+        
+        <!-- Key input modules -->
+        <property name="sdfmodule" value="NameDefinitionLanguage"/>
+        <property name="metasdfmodule" value="Stratego-NameDefinitionLanguage"/>
+        <property name="esvmodule" value="NameDefinitionLanguage"/>
+        <property name="strmodule" value="namedefinitionlanguage"/>
+    
+        <!-- Project directories -->
+        <property name="trans" location="trans"/>
+        <property name="src-gen" location="editor/java"/>
+        <property name="syntax" location="syntax"/>
+        <property name="include" location="include"/>
+        <property name="lib" location="lib"/>
+        <property name="build" location="bin"/>
+        <property name="dist" location="bin/dist"/>
+        
+        <!-- Imports -->
+        <property name="build.sdf.imports" value=""/>
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
+        
+        <!-- Optional: external .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
+        <property name="externaljar" value="../lib.jar"/>
+        <property name="externaljarflags" value="-la org.lib"/>
+        -->
+    
+        <!-- Environment configuration for command-line builds -->
+        <condition property="build.strategoxt.sdf" value="${eclipse.spoofaximp.nativeprefix}" else="">
+            <isset property="eclipse.spoofaximp.nativeprefix"/>
+        </condition>
+        <property name="build.strategoxt.stratego" location="${user.home}/.nix-profile/bin"/>
+    
+        <import file="build.generated.xml"/>
+    
+        <!-- Main target -->
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/build.properties
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/build.properties	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,9 @@
+source.. = editor/java/
+output.. = bin/
+bin.includes = META-INF/,\
+               plugin.xml,\
+               include/,\
+               bin/,\
+               lib/,\
+               .
+bin.excludes = trans/

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,34 @@
+module NameDefinitionLanguage-Builders
+
+imports NameDefinitionLanguage-Builders.generated
+
+builders
+                                                                                   
+  // This file can be used for custom analysis, builder and refactoring rules.     
+  //                                                                               
+  // See the imported file for a brief introduction and examples.                  
+
+builders
+                                                                                                                          
+  provider : include/namedefinitionlanguage.ctree                                                                         
+  provider : include/namedefinitionlanguage-java.jar                                                                      
+                                                                                                                          
+  observer : editor-analyze                                                                                               
+                                                                                                                          
+  builder  : "Generate Java code (for selection)"            = generate-java (openeditor) (realtime)                      
+  builder  : "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (meta) (source)     
+  builder  : "Show analyzed abstract syntax (for selection)" = generate-analyzed (openeditor) (realtime) (meta) (source)  
+                                                                                                                          
+
+refactorings
+
+  pretty-print : pp-namedefinitionlanguage-string
+
+  refactoring ID : "Rename Entity" = rename-entity (source) (cursor)
+    shortcut : "org.eclipse.jdt.ui.edit.text.java.rename.element"
+    input
+      identifier : "new name" = ""
+
+  
+
+  on save : index-on-save
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Colorer.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Colorer.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,15 @@
+module NameDefinitionLanguage-Colorer
+
+imports NameDefinitionLanguage-Colorer.generated
+
+colorer
+                                                                      
+  // This file can be used for custom colorer rules.                  
+  //                                                                  
+  // See the imported file for a brief introduction and examples.     
+  
+  Namespace._ 		: namespace
+  NamespaceRef._ 	: namespace
+  
+  namespace = 0 64 128 italic
+  
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Completions.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Completions.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,31 @@
+module NameDefinitionLanguage-Completions
+
+imports NameDefinitionLanguage-Completions.generated
+
+completions
+                                                                   
+  // This file is used to define content completion.               
+  //                                                               
+  // See the imported file for a brief introduction and examples.  
+                                                                   
+
+completions
+                                             
+  // Syntax completion:                      
+                                             
+  completion template Start :
+    "module " <m> (blank)  
+                                             
+  completion template Definition :
+    "entity " <e> " {" (cursor) "}" (blank)  
+                                             
+  completion template Property : "property : Type" =
+    <x> " : " <T> (blank)  
+                                             
+
+completions
+  // Semantic (identifier) completion:   
+                                         
+  completion proposer                  : editor-complete
+                                         
+  completion trigger                   : ":"
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Folding.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Folding.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,9 @@
+module NameDefinitionLanguage-Folding
+
+imports NameDefinitionLanguage-Folding.generated
+
+folding
+  
+  // This file can be used for custom folding rules.
+  //
+  // See the imported file for a brief introduction and examples.
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Outliner.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Outliner.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,9 @@
+module NameDefinitionLanguage-Outliner
+
+imports NameDefinitionLanguage-Outliner.generated
+
+outliner
+  
+  // This file can be used for custom outliner rules.
+  //
+  // See the imported file for a brief introduction and examples.
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-References.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-References.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,15 @@
+module NameDefinitionLanguage-References
+
+imports NameDefinitionLanguage-References.generated
+
+references
+                                                                                                   
+  // This file can be used to specify reference resolving and hover help, and content completion.  
+  //                                                                                               
+  // See the imported file for a brief introduction and examples.                                  
+                                                                                                   
+
+references
+                
+  reference _ : editor-resolve
+  hover _     : editor-hover
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Syntax.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Syntax.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,9 @@
+module NameDefinitionLanguage-Syntax
+
+imports NameDefinitionLanguage-Syntax.generated
+
+language
+                                                                   
+  // This file can be used for custom syntax rules.                
+  //                                                               
+  // See the imported file for a brief introduction and examples.  
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage.main.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage.main.esv	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,17 @@
+
+module NameDefinitionLanguage.main
+
+imports NameDefinitionLanguage-Builders NameDefinitionLanguage-Colorer NameDefinitionLanguage-Completions NameDefinitionLanguage-Folding NameDefinitionLanguage-Outliner NameDefinitionLanguage-References NameDefinitionLanguage-Syntax
+
+language General properties
+                  
+  name          : NameDefinitionLanguage
+  id            : org.strategoxt.imp.names
+  extends       : Root
+                  
+  description   : "Spoofax/IMP-generated editor for the NameDefinitionLanguage language"
+  url           : http://strategoxt.org
+                  
+  extensions    : nd
+  table         : include/NameDefinitionLanguage.tbl
+  start symbols : Start
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/Activator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/Activator.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,44 @@
+package org.strategoxt.imp.names;
+
+import org.eclipse.imp.preferences.PreferencesService;
+import org.eclipse.imp.runtime.PluginBase;
+import org.osgi.framework.BundleContext;
+
+public class Activator extends PluginBase 
+{ 
+  public static final String kPluginID = "NameDefinitionLanguage";
+
+  public static final String kLanguageName = "NameDefinitionLanguage";
+
+  protected static Activator sPlugin;
+
+  public static Activator getInstance()
+  { 
+    if(sPlugin == null)
+      return new Activator();
+    return sPlugin;
+  }
+
+  public Activator () 
+  { 
+    super();
+    sPlugin = this;
+  }
+
+  @Override public void start(BundleContext context) throws Exception
+  { 
+    super.start(context);
+  }
+
+  @Override public String getID()
+  { 
+    return kPluginID;
+  }
+
+  @Override public String getLanguageID()
+  { 
+    return kLanguageName;
+  }
+
+  protected static PreferencesService preferencesService = null;
+}
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageParseController.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageParseController.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,4 @@
+package org.strategoxt.imp.names;
+
+public class NameDefinitionLanguageParseController extends NameDefinitionLanguageParseControllerGenerated 
+{ }
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageParseControllerGenerated.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageParseControllerGenerated.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,108 @@
+package org.strategoxt.imp.names;
+
+import java.io.InputStream;
+import java.io.IOException;
+import java.io.File;
+import java.io.FileInputStream;
+import org.eclipse.core.runtime.Path;
+import org.eclipse.imp.parser.IParseController;
+import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.imp.runtime.dynamicloading.BadDescriptorException;
+import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
+import org.strategoxt.imp.runtime.dynamicloading.DescriptorFactory;
+import org.strategoxt.imp.runtime.dynamicloading.DynamicParseController;
+
+public class NameDefinitionLanguageParseControllerGenerated extends DynamicParseController 
+{ 
+  public static final String LANGUAGE = new String("NameDefinitionLanguage");
+
+  private static final String TABLE = "/include/" + LANGUAGE + ".tbl";
+
+  private static final String DESCRIPTOR = "/include/" + LANGUAGE + ".packed.esv";
+
+  private static volatile Descriptor descriptor;
+
+  private static Throwable notLoadingCause;
+
+  public static synchronized Descriptor getDescriptor()
+  { 
+    if(notLoadingCause != null)
+      throw new RuntimeException(notLoadingCause);
+    if(descriptor == null)
+      createDescriptor();
+    return descriptor;
+  }
+
+  protected static synchronized void setDescriptor(Descriptor descriptor)
+  { 
+    NameDefinitionLanguageParseControllerGenerated.descriptor = descriptor;
+  }
+
+  protected static void createDescriptor()
+  { 
+    try
+    { 
+      InputStream descriptorStream = NameDefinitionLanguageParseControllerGenerated.class.getResourceAsStream(DESCRIPTOR);
+      InputStream table = NameDefinitionLanguageParseControllerGenerated.class.getResourceAsStream(TABLE);
+      boolean filesystem = false;
+      if(descriptorStream == null && new File("./" + DESCRIPTOR).exists())
+      { 
+        descriptorStream = new FileInputStream("./" + DESCRIPTOR);
+        filesystem = true;
+      }
+      if(table == null && new File("./" + TABLE).exists())
+      { 
+        table = new FileInputStream("./" + TABLE);
+        filesystem = true;
+      }
+      if(descriptorStream == null)
+        throw new BadDescriptorException("Could not load descriptor file from " + DESCRIPTOR + " (not found in plugin: " + getPluginLocation() + ")");
+      if(table == null)
+        throw new BadDescriptorException("Could not load parse table from " + TABLE + " (not found in plugin: " + getPluginLocation() + ")");
+      descriptor = DescriptorFactory.load(descriptorStream, table, filesystem ? Path.fromPortableString("./") : null);
+      descriptor.setAttachmentProvider(NameDefinitionLanguageParseControllerGenerated.class);
+    }
+    catch(BadDescriptorException exc)
+    { 
+      notLoadingCause = exc;
+      Environment.logException("Bad descriptor for " + LANGUAGE + " plugin", exc);
+      throw new RuntimeException("Bad descriptor for " + LANGUAGE + " plugin", exc);
+    }
+    catch(IOException exc)
+    { 
+      notLoadingCause = exc;
+      Environment.logException("I/O problem loading descriptor for " + LANGUAGE + " plugin", exc);
+      throw new RuntimeException("I/O problem loading descriptor for " + LANGUAGE + " plugin", exc);
+    }
+  }
+
+  private static String getPluginLocation()
+  { 
+    return NameDefinitionLanguageParseController.class.getProtectionDomain().getCodeSource().getLocation().getFile();
+  }
+
+  @Override public IParseController getWrapped()
+  { 
+    if(!isInitialized())
+    { 
+      if(notLoadingCause != null)
+        throw new RuntimeException(notLoadingCause);
+      try
+      { 
+        initialize(this, getDescriptor().getLanguage());
+      }
+      catch(BadDescriptorException exc)
+      { 
+        notLoadingCause = exc;
+        throw new RuntimeException(exc);
+      }
+    }
+    return super.getWrapped();
+  }
+
+  @Override protected void setNotLoadingCause(Throwable value)
+  { 
+    notLoadingCause = value;
+    super.setNotLoadingCause(value);
+  }
+}
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageValidator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/NameDefinitionLanguageValidator.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,12 @@
+package org.strategoxt.imp.names;
+
+import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
+import org.strategoxt.imp.runtime.services.MetaFileLanguageValidator;
+
+public class NameDefinitionLanguageValidator extends MetaFileLanguageValidator 
+{ 
+  @Override public Descriptor getDescriptor()
+  { 
+    return NameDefinitionLanguageParseController.getDescriptor();
+  }
+}
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/InteropRegisterer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/InteropRegisterer.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,14 @@
+package org.strategoxt.imp.names.strategies;
+
+import org.strategoxt.lang.JavaInteropRegisterer;
+import org.strategoxt.lang.Strategy;
+
+/**
+ * Helper class for {@link java_strategy_0_0}.
+ */
+public class InteropRegisterer extends JavaInteropRegisterer {
+
+  public InteropRegisterer() {
+    super(new Strategy[] { java_strategy_0_0.instance });
+  }
+}

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/Main.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/Main.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,11 @@
+package org.strategoxt.imp.names.strategies;
+
+import org.strategoxt.lang.Context;
+
+public class Main {
+  
+  public static void init(Context context) {
+    // Called when the editor is being initialized
+  }
+
+}

Added: spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/java_strategy_0_0.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/java/org/strategoxt/imp/names/strategies/java_strategy_0_0.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,32 @@
+package org.strategoxt.imp.names.strategies;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+/**
+ * Example Java strategy implementation.
+ *
+ * This strategy can be used by editor services and can be called
+ * in Stratego modules by declaring it as an external strategy
+ * as follows:
+ *
+ * <code>
+ *  external java-strategy(|)
+ * </code>
+ *
+ * @see InteropRegisterer  This class registers java_strategy_0_0 for use.
+ */
+public class java_strategy_0_0 extends Strategy {
+  
+  public static java_strategy_0_0 instance = new java_strategy_0_0();
+
+  @Override
+  public IStrategoTerm invoke(Context context, IStrategoTerm current) {
+    context.getIOAgent().printError("Input for java-strategy: " + current);
+    ITermFactory factory = context.getFactory();
+    return factory.makeString("Regards from java-strategy");
+  }
+
+}

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,94 @@
+module lib/analysis-auto.generated
+
+signature
+  constructors
+    Module    : Namespace
+    Namespace : Namespace
+    Module    : Namespace
+    Property  : Namespace
+    Type      : Namespace
+
+
+imports
+  include/NameDefinitionLanguage
+
+
+rules
+
+  nam-get-scope-types :
+    Naming(_, _, _, _) -> [Namespace()]
+
+  nam-get-definition-key :
+    Naming(x, _, _, _) -> x
+
+  nam-get-definition :
+    Naming(x, _, _, _) -> <nam-get-def(|Module())> x
+
+  nam-get-definition-key :
+    Namespace(x) -> x
+
+  nam-get-definition :
+    Namespace(x) -> <nam-get-def(|Namespace())> x
+
+  nam-annotate-names(|def-path):
+    Naming(i_37126, j_37126, k_37126, l_37126) -> Naming(i_37126{def-path}, j_37126, k_37126, l_37126)
+
+  nam-annotate-names(|def-path):
+    Import(h_37126) -> Import(<nam-annotate-use(|Module())> h_37126)
+
+  nam-annotate-names(|def-path):
+    Namespace(g_37126) -> Namespace(g_37126{def-path})
+
+  nam-annotate-names(|def-path):
+    NsRef(f_37126) -> NsRef(<nam-annotate-use(|Namespace())> f_37126)
+
+  nam-get-scope-types :
+    Naming(_, _, _, _) -> [Namespace()]
+
+  nam-get-scope-types :
+    Module(_, _) -> [Type()]
+
+  nam-get-scope-types :
+    Entity(_, _) -> [Property()]
+
+  nam-get-scope-types :
+    Module(_, _) -> [Type()]
+
+  nam-get-scope-types :
+    Entity(_, _) -> [Property()]
+
+  nam-get-definition-key :
+    Module(x, _) -> x
+
+  nam-get-definition :
+    Module(x, _) -> <nam-get-def(|Module())> x
+
+  nam-get-definition-key :
+    Entity(x, _) -> x
+
+  nam-get-definition :
+    Entity(x, _) -> <nam-get-def(|Type())> x
+
+  nam-get-definition-key :
+    Property(x, _) -> x
+
+  nam-get-definition :
+    Property(x, _) -> <nam-get-def(|Property())> x
+
+  nam-annotate-names(|def-path):
+    Module(j_25143, k_25143) -> Module(j_25143{def-path}, k_25143)
+
+  nam-annotate-names(|def-path):
+    Entity(h_25143, i_25143) -> Entity(h_25143{def-path}, i_25143)
+
+  nam-annotate-names(|def-path):
+    Property(f_25143, g_25143) -> Property(f_25143{def-path}, g_25143)
+
+  nam-annotate-names(|def-path):
+    Type(e_25143) -> Type(<nam-annotate-use(|Type())> e_25143)
+
+  nam-get-def(|n) =
+    fail
+
+  nam-annotate-use(|n) =
+    fail
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library.generated.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,874 @@
+module lib/analysis-library.generated
+ 
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  lib/index-library.generated
+ 
+signature constructors
+ 
+  // Analyze constructors
+  AnalysedResult : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) -> AnalysedResult
+  Editor      : AnalysisPhase
+  Compile     : AnalysisPhase
+ 
+  // Index elements
+  Def          : List(UriPart) -> Summary
+  Use          : List(UriPart) * List(UriPart) -> Summary
+  BadUse       : List(UriPart) -> Summary
+  Read         : List(UriPart) -> Summary
+  ReadWildcard : List(UriPart) * String -> Summary
+  Diff         : List(UriPart) * List(Summary) -> Summary
+    
+  // Namespaces
+  Diff         : Namespace
+  ASTDiff      : Namespace
+  
+  // Adjust lookup actions
+  StopLookup   : LookupAction
+  
+rules // extension points
+ 
+  // Should return list of Def(_) and/or [namespace | path] or StopLookup() to stop the lookup
+  adjust-index-lookup(is-use |namespace, path, prefix) = fail
+ 
+  // adjust-index-select(|namespace, path, use) = fail // (e.g., for imports)
+ 
+  // Should call <store-results> on a (list of) DefData
+  adjust-index-def-data(store-results |namespace, path) = fail
+ 
+  // Should return a path
+  adjust-index-path(is-def |namespace, path) = fail
+ 
+  // adjust-index-path-from-filesystem(|project-path, path)
+  
+  /**
+   * Should define constructors to check for difference during analysis. Defaults to Def constructs.
+   *
+   * Extension example:
+   *   index-diff-constructors = ?Type(_, _)
+   */
+  index-diff-constructors = ?Def(_)
+  
+  /**
+   * Should compare two index elements and fail if they are not equal.
+   *
+   * Extension example:
+     *   index-diff-compare:
+   *     (Type(u1, v1), Type(u2, v2)) -> <id>
+   *     where
+   *       <index-uri-eq> (u1, u2);
+   *       <eq> (v1, v2)
+   */
+  index-diff-compare:
+    (Def(u1), Def(u2)) -> <id>
+    where
+       <index-uri-eq> (u1, u2)
+       
+  post-analyze-top(|phase, language, full-path) = fail
+ 
+rules // analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Defaults to Editor() phase and tries to automatically determine language name.
+   *
+   * @see analyze-top(|phase, language)
+   */
+  analyze-top = analyze-top(|Editor())
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Tries to automatically determine language name.
+   *
+   * @see analyze-top(|phase, language)
+   */
+  analyze-top(|phase) = ?(ast, _, _); analyze-top(|phase, <index-origin-language> ast)
+   
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @param phase     The type of analysis phase. There are currently 2 phases to choose from:
+   *                  - Editor():   All information is stored into the index and dependent files
+   *                                are automatically scheduled for re-analysis.
+   *                  - Compile():  No information is stored and no re-analysis is done.
+   * @param language  The name of the language that is being analysed.
+   *
+   * @see analyze-top-internal(|phase, language)
+   */
+  analyze-top(|phase, language):
+    (ast, path, project-path) -> ast'
+    with
+      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|phase, language)> (ast, path, project-path)
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @internal
+   */
+  analyze-top-internal = 
+    analyze-top-internal(|Editor())
+  analyze-top-internal(|phase) = 
+    ?(ast, path, project-path); analyze-top-internal(|phase, <index-origin-language> ast)
+  analyze-top-internal(|phase, language) = 
+    ?(_, path, project-path); analyze-top-internal(|phase, language, $[[project-path]/[path]])
+  analyze-top-internal(|phase, language, full-path):
+    (ast, path, project-path) -> AnalysedResult(ast5, defs, uses, data', added, removed)
+    with
+      // Init
+      index-setup(|language, [project-path], full-path)
+    with
+      file := (full-path, ""); // TODO: Get subfile or add subfile param.
+        // Store copy of elements for diff and clear file
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> file;
+      <index-clear-file> file
+    with
+      {| Index-ReadSet, Index-UnresolvedSet:
+        readSet := <new-iset>;
+        unresolvedSet := <new-iset>;
+        
+        rules(Index-ReadSet: _ -> readSet);
+        rules(Index-UnresolvedSet: _ -> unresolvedSet);
+       
+        // Add Unresolved annotations, record globals
+        (Some(ast2), defs) := <analyze-defs(|Anon(), Anon())> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+        <index-add-all(|file)> defs;
+
+        // Find DefData
+        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2;
+        data := <origin-track-forced(analyze-tree-data)> ast3;
+        <index-add-all(|file)> data;
+
+        // Resolve an references in DefData (using what we just stored)
+        (data', data-uses) := <analyze-uses> data;
+        <index-remove-all(|file)> data;
+        <index-add-all(|file)> data';
+       
+        // Resolve all unresolved references in the tree
+        (ast4, uses) := <analyze-uses> ast3;
+        <index-add-all(|file)> uses;
+        
+        ast5 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast4;
+       
+        // Store reads into the index (if current language is not testing language)
+        if not(<is-test-input(|language)> (ast, path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+    with
+      // Schedule re-analysis of dependent files (if current file is not testing language file)
+      // HACK: Depends on file extension, could be other languages with .spt extension?
+      if Editor() := phase; not(<is-test-file> path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data');
+        
+          // Find added and removed definitions
+          (added, removed) := <analyze-diff> (oldElems, newElems);
+          changed := <conc> (added, removed);
+
+          // Schedule re-analysis of files that depend on added or removed elements
+          <reanalyze-all(|full-path)> changed;
+          
+          // TODO: Move diff stuff to compilation-library somehow.
+          // Store added and removed elements in the index
+          analyze-store-diff(|changed, file, ast)
+        else
+          (added, removed) := ([], [])
+      end
+    with
+      try(post-analyze-top(|phase, language, full-path))
+
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+  
+  reanalyze-all(|file) =
+    index-get-dependent-files; 
+    filter(not(analyze-changed-filter-file(|file)); reanalyze-file)
+    
+  analyze-changed-filter-file(|file) = 
+    ?files@(<id>, _); (is-test-file <+ index-is-fake-file <+ ?file); !files
+    
+  reanalyze-file = 
+    ?(<id>, _); debug(!"Re-analyzing "); prim("SSL_EXT_queue_analysis")
+    
+  analyze-store-diff(|changedEntries, file, ast): 
+    _ -> <id>
+    with
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      files := <conc> (changedFiles, dependentFiles);
+      
+      if not(<analyze-astdiff(|ast)> file) then
+        // Add current file if the AST has changed. Cannot use dependency tracking here because
+        // the originating file of a removed definition is not in the index any more.
+        files' := <make-set> [file|files] 
+        else
+            files' := <make-set> files
+        end;
+      
+      if not([] := files') then
+        storePath := <analyze-diff-path>;
+        <map(analyze-add-diff(|storePath))> files'
+      end
+      
+  analyze-add-diff(|storePath):
+    file -> <id>
+    with
+      <index-add-all(|storePath)> [Diff([Diff(), ".internal"], file)]
+      
+  analyze-get-diffs:
+    _ -> diffs
+    with
+        diffs := <make-set> <index-get-all-values> Diff([Diff(), ".internal"], ())
+        
+  // Fails if old ASTDiff is not found or if ASTDiff is different.
+  analyze-astdiff(|ast):
+    (file, subfile) -> <id>
+    where
+      storePath := <analyze-diff-path>;
+        newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-value> Diff([ASTDiff(), file, ".internal"], ()) then
+        <index-remove-all(|storePath)> [Diff([ASTDiff(), file, ".internal"], ())];
+          <index-add-all(|storePath)> [Diff([ASTDiff(), file, ".internal"], newChecksum)];
+        <eq> (oldChecksum, newChecksum)
+        else
+            <index-add-all(|storePath)> [Diff([ASTDiff(), file, ".internal"], newChecksum)];
+            fail
+        end
+      
+  analyze-clean-diff:
+    _ -> <id>
+    with
+        storePath := <analyze-diff-path>; 
+      <index-remove-all(|storePath)> [Diff([Diff(), ".internal"], ())]
+        
+  analyze-diff-path = 
+    !"/.internal/diff"
+ 
+  /**
+   * Identifies all definitions in the tree
+   * and annotates them with their URI.
+   * Also annotates uses with a preliminary "Unresolved(_)" URI.
+   */
+  analyze-defs(|head-scope, head-scope-ns):
+    ast -> (ast', defs')
+    with
+      if def := <nam-get-definition> ast then
+        Def(def-path)                     := def;
+        [head-scope-ns', head-scope' | _] := def-path
+      else
+        def-path       := INTERNAL_ERROR();
+        head-scope-ns' := head-scope-ns;
+        head-scope'    := head-scope
+      end;
+      if scope-types := <nam-get-scope-types> ast then
+        {| IndexPath:
+          <list-loop(update-index-path(|head-scope', head-scope-ns', ast))> scope-types;
+          // <balanced-update-path> head-scope';
+          (ast', defs) := <analyze-defs-recurse(|Anon(), Anon(), def-path)> ast
+        |}
+      else
+        (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
+      end;
+      defs' := <![def | defs] <+ !defs>
+ 
+  analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
+    ast -> (ast'', defs)
+    where
+      analyzed      := <all(analyze-defs(|head-scope, head-scope-ns))> ast;
+      (ast', defs)  := <unzip-analyzed> analyzed;
+      ast''         := <try(nam-annotate-names(|def-path))> ast'
+ 
+  update-index-path(|head-scope, head-scope-ns, ast):
+    scope-type -> scope-type
+    where
+      if !head-scope-ns => Anon() then
+        path  := <IndexPath <+ ![]> scope-type;
+        path' := <do-adjusted-index-path(|scope-type, path, Anon(<new>))> ast
+      else
+        path  := <IndexPath <+ ![]> head-scope-ns;
+        path' := <do-adjusted-index-path(|scope-type, path, head-scope)> ast
+      end;
+      rules(IndexPath: scope-type -> path')
+ 
+  /* TODO: consider using simple-update-def-path
+   *       which uses "balanced" path scopes
+   *       e.g. when Entity doesn't scope Function
+   *       then it's hard to access properties from a function
+  balanced-update-index-path:
+    head-scope -> head-scope
+    where
+      if !head-scope => Anon() then
+        head-scope' := Anon(<new>)
+      else
+        head-scope' := head-scope
+      end;
+      (something with do-adjust-path)
+      rules(IndexPath := [head-scope' | <IndexPath <+ ![]> ()])
+  */
+ 
+  /**
+   * Analyze all uses, changing their preliminary
+   * "Unresolve(_)" URI to a definite URI of their definition.
+   */
+  analyze-uses = analyze-uses(|None())
+  analyze-uses(|parent):
+    ast -> (ast'', uses')
+    with
+      analyzed     := <all(analyze-uses(|ast))> ast;
+      (ast', uses) := <unzip-analyzed> analyzed;
+      if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
+        if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
+          ast'' := ast{def-uri};
+          if key{keyUri} := <nam-get-definition-key> parent ; not(<eq>(key, ast')) then
+            uses' := [Use(def-uri, keyUri) | uses]
+          else
+            uses' := [Use(def-uri, [namespace | path]) | uses]
+          end
+        else
+          ast'' := ast';
+          uses' := [BadUse([namespace, x]) | uses]
+        end
+      else
+        ast'' := ast';
+        uses' := uses
+      end
+ 
+  /**
+   * Collects all index data (e.g., types of definitions).
+   */
+  analyze-tree-data:
+    tree -> data
+    where
+      set := <new-iset>;
+      <topdown(analyze-tree-data-part(|set))> tree;
+      data := <iset-elements> set
+ 
+  analyze-tree-data-part(|set):
+    tree -> tree
+    where
+      if def-term := <nam-get-definition-key> then
+        _{[namespace | path]} := def-term;
+        if result := <adjust-index-def-data(store-index-data-results(|set) |namespace, path)> tree then
+          <fatal-err(|"Unexpected result from adjust-index-def-data; should call <store-results>")> result
+        end
+      end
+ 
+  store-index-data-results(|set):
+    t -> <fail>
+    where
+      if is-list then
+        <iset-addlist(|t)> set
+      else
+        <iset-add(|t)> set
+      end
+ 
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) )
+   * to a tuple (C(a1, a2), [b1, b2, b3]).
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\(a, _) -> a\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
+ 
+rules // index API primitives
+ 
+  /**
+   * Gets all DefData entries that match the kind of data and URI in given definition.
+   *
+   * @param kind Only data of this kind is returned.
+   *
+   * Example:
+   *   <index-get-data(|Type())> Def([Entity(), "Bar"]) => [DefData([Entity(), "Bar"], Type(), TYPE("Bar")), ...]
+   */
+  index-get-data(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
+      
+    /**
+     * Gets all data entries that match the kind of data and URI in given definition.
+     *
+     * @param kind Only data of this kind is returned.
+     *
+     * Example:
+     *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
+     */
+  index-get-data-all(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
+     
+  /**
+   * Gets all Use entries that match the URI in given definition.
+   *
+   * Example:
+   *   <index-get-uses-all> Def([Entity(), "M", "Bar"]) => [Use([Entity(), "M", "Bar"], [Entity(), "M"]), ...]
+   */
+  index-get-uses-all:
+    <with(?Def(uri) | "Def expected")> -> <index-get-all> Use(uri, [])
+     
+  /**
+   * Gets all Read or ReadWildcard entries that match the given template.
+   *
+   * Example:
+   *   <index-get-reads-all> [Property(), "Bar", "p"] => [Read([Property(), "Bar", "p"]), ...]
+   */
+  index-get-reads-all:
+    template -> <conc> (reads, readwildcards')
+    where
+      uri   := <index-uri> template;
+      reads := <index-get-all> Read(uri);
+      if !uri => [namespace, prefix | path-parent] then
+        readwildcards  := <index-get-all> ReadWildcard([namespace | path-parent], ());
+        readwildcards' := <filter(index-readwildcard-substring(|prefix))> readwildcards
+      else
+        readwildcards' := []
+      end
+ 
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   */
+  index-get-all:
+    template -> <indexlib-get-all> template
+      with
+       if set := <Index-ReadSet> then
+         uri := <index-uri>;
+         <iset-add(|Read(uri))> set
+       end
+       
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * @see index-value
+   *
+   * Example:
+   *   <index-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   */
+  index-get-all-values:
+    template -> <map(index-value)> <index-get-all> template
+       
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   */
+  index-get:
+    template -> <?[<id>|_]> <index-get-all> template
+      
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * @see index-value
+   *
+   * Example:
+   *   <index-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   */
+  index-get-value:
+    template -> <index-value> <?[<id>|_]> <index-get-all> template
+   
+  /**
+   * Gets the namespace part of the URI for given term.
+   */
+  index-namespace:
+    x{[namespace | path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given term.
+   */
+  index-path:
+    x{[namespace | path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+    
+  /**
+   * Determines if a given AST node is a definition site,
+   * according to the syntax.
+   */
+  index-is-definition =
+    where(nam-get-definition-key)
+ 
+  /**
+   * Returns all children of a Def.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
+   *
+   */
+  index-get-children(|namespace, prefix):
+    <with(?Def([parent-ns | path]) | "Def expected")> -> children'
+    with
+      with(not(!namespace => Def(_)) | "index-get-children interface changed");
+      prefix'   := <strip-annos> prefix;
+      template  := Def([namespace | path]);
+      children  := <prim("LANG_index_get_children", template)>;
+      children' := <filter(index-is-name-substring(|prefix'))> children;
+      store     := [namespace, prefix' | path];
+      // Store read in index.
+      if set := <Index-ReadSet> then
+        if 1 := <length> children' then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace, prefix' | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix'))> set
+        end
+      end
+
+  /**
+   * Gets a set of all files that have a reference to the given index entries.
+   *
+   * @param construct-from-uri  Construction strategy that creates a list of reference constructs from all 
+   *                            given entries, such as \uri -> [Read(uri), Use(uri, [])]\
+   *
+   * Example:
+   *   <index-get-referenced-files(\uri -> [Read(uri), Use(uri, [])]\)> [Def([Entity(), "Bar"]), ...] => 
+   *     [("fullpath/otherfile.ext", "subfile"), ...]
+   */
+  index-get-referenced-files(construct-from-uri):
+    entries -> files
+    where
+      uris        := <filter(index-uri)> entries;
+      referenced  := <concat> <filter(construct-from-uri)> uris;
+      files       := <make-set> <mapconcat(index-get-files-of)> referenced
+ 
+  /**
+   * Convenience function for finding files with Read and Use dependencies to the given definitions.
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
+   *
+   * Example:
+   *   <index-get-dependent-files> [Def([Entity(), "Bar"]), ...] => [("fullpath/otherfile.ext", "subfile"), ...]
+   */
+  index-get-dependent-files = 
+    index-get-referenced-files(index-file-dependent-construct)
+     
+rules // index lookup rules (take into account adjust-index-lookup)
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning its Def.
+   */
+  index-lookup:
+    x{[namespace | path]} -> <index-lookup(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   */
+  index-lookup-all:
+    x{[namespace | path]} -> <index-lookup-all(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
+   *
+   * @internal
+   */
+  index-lookup(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> def
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      if <?StopLookup()> candidates then
+        fail
+      else
+        def        := <index-select(|namespace, path, x)>
+      <+
+          // TODO: optimize: try not to call do-adjust-index-lookup from here
+          [_ | path'] := path;
+          def         := <index-lookup(is-adjust-lookup-enabled |namespace, path', prefix)> x
+      end
+
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
+   *
+   * @internal
+   */
+  index-lookup-all(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> defs'
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      defs       := <index-select-all(|namespace, path, x)>;
+      // TODO: optimize: try not to call do-adjust-index-lookup from here
+      if [_ | path'] := path then
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled |namespace, path', prefix)> x;
+        defs' := <conc> (defs, defs2)
+      else
+        defs' := defs
+      end
+ 
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
+   */
+  index-lookup-outermost(|prefix):
+    x{[namespace | path]} -> <index-lookup-outermost(id |<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
+   *
+   * @internal
+   */
+  index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> def
+    where
+      // TODO: optimize: just like index-lookup
+      [_ | path'] := path;
+      def         := <index-lookup-outermost(is-adjust-lookup-enabled |namespace, path', prefix)> x
+    <+
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      def        := <index-select(|namespace, path, x)>
+ 
+  /**
+   * Given an annotated AST node, returns a Def that has the same parent URI.
+   *
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
+   */
+  index-lookup-one-level(|prefix):
+    x{[namespace | path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, and
+   * returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Indicates that only Defs with a name that starts with this
+   *                  string are demanded.
+   */
+  index-lookup-one-level(is-adjusted-lookup-enabled |namespace, path, prefix):
+    x{_} -> defs
+    with
+      is-adjusted-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        defs := StopLookup()
+      else
+        mapconcat(\d at Def(p) -> [d]\
+          <+ \[namespace' | path'] -> <index-lookup-one-level(fail |namespace', path', prefix)> x\
+          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?defs
+      end
+    <+
+      defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
+      
+  /**
+   * Given an annotated AST node, resolves it, and
+   * returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Indicates that only Defs with a name that starts with this
+   *                  string are demanded.
+   */
+  index-lookup-all-levels(|prefix):
+    x{[namespace | path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, and
+   * returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param prefix    Indicates that only Defs with a name that starts with this
+   *                  string are demanded.
+   */
+  index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
+    x{_} -> all-defs
+    with
+      is-adjust-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        all-defs := []
+      else
+          mapconcat(\d at Def(p) -> [d]\
+              <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
+              <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+          ?all-defs
+      end
+    <+
+      one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
+      if [_ | path'] := path then
+        all-defs := <concat> [one-level, <index-lookup-all-levels(fail |namespace, path', prefix)> x]
+      else
+        all-defs := one-level
+      end
+ 
+  /** @Deprecated */
+  index-lookup-contained(|namespace, prefix) =
+    obsolete(!"index-lookup-contained; use index-lookup-children");
+    index-lookup-children(|namespace, prefix)
+   
+  /** @Deprecated */
+  index-lookup-contained-all-levels(|namespace, name) =
+    obsolete(!"index-lookup-contained-all-levels; use index-lookup-descendants");
+    index-lookup-descendants(|namespace, name)
+ 
+  /**
+   * Given an annotated AST node, resolves it,
+   * and returns all child Defs of its definition.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only child Defs with a name that starts with this
+   *                  string are returned.
+   */
+  index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-one-level(id|namespace, def-path, prefix)> x
+      else
+        defs := <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      end
+    <+
+      defs := []
+ 
+  /**
+   * Given an annotated AST node, resolves it,
+   * and returns all descendant Defs of its definition.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only child Defs with a name that starts with this
+   *                  string are returned.
+   */
+  index-lookup-descendants(|namespace, name):
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-all-levels(id|namespace, def-path, name)> x
+      else
+        defs := <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, name)>
+      end
+    <+
+      defs := []
+       
+/** @internal */
+rules // URI and value projections
+       
+  index-uri-impl:
+    Def(uri) -> uri
+    
+  index-uri-impl:
+    Use(uri, _) -> uri
+    
+  index-uri-impl:
+    Read(uri) -> uri
+    
+  index-uri-impl:
+    x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
+ 
+  // TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+  index-uri-impl:
+    ReadWildcard(uri, _) -> uri
+
+  index-value-impl:
+    Def(value) -> value
+
+  index-value-impl:
+    Use(_, value) -> value
+
+  index-value-impl:
+    Read(value) -> value
+    
+  index-value-impl:
+    ReadWildcard(_, value) -> value
+       
+/** @internal */
+rules // Internal helpers
+       
+  index-origin-language = (origin-term <+ id); prim("SSL_EXT_origin_language", <id>)
+       
+  // Tests if the current file is just a testing language input
+  is-test-file = string-ends-with(|".spt")
+  is-test-input(|language):
+    (ast, path) -> (ast, path)
+    where
+      <is-test-file> path;
+      not(!language => "Spoofax-Testing")
+       
+  index-is-name-substring(|name):
+    template -> <id>
+    with
+      [_, uri-name | _] := <index-uri>
+    where
+      <is-substring(!name)> uri-name
+      
+  index-readwildcard-substring(|prefix):
+    ReadWildcard(_, name) -> <id>
+    where <is-substring(!prefix)> name
+      
+  index-is-unresolved(|x, uri) = Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  index-add-unresolved(|x, uri) = (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  index-file-dependent-construct: 
+    uri -> <conc> (uses, reads)
+    with
+        uses := <index-get-uses-all> Def(uri);
+        reads := <index-get-reads-all> Def(uri)
+    
+  index-file-dependency-filter = ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_, _)
+ 
+  do-adjust-index-lookup(|namespace, path, use, prefix) =
+    // UNDONE: try(origin-term);
+    repeat-until(
+      prim("SSL_EXT_get_parent", <id>)
+    , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
+    )
+ 
+  index-select(|namespace, path, use) =
+    getfirst(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  index-select-all(|namespace, path, use) =
+    filter(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  do-adjusted-index-path(|namespace, path, def) =
+    adjust-index-path(origin-equal(|def) |namespace, path)
+  <+
+    ![def | path]
+ 
+  index-eq(|namespace, expected) =
+    where(
+      ?Def([_, name | _]);
+      <SRTS-EXT-eq-ignore-annos(|expected)> name
+    )
+  
+  external SRTS-EXT-eq-ignore-annos(|t)
+ 
+rules // interface for generated code
+ 
+  nam-get-def(|namespace):
+    x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
+   
+  nam-annotate-use(|namespace):
+    t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
+   
+  nam-get-scope-types = fail
+  nam-get-definition = fail
+  nam-get-definition-key = fail
+  nam-annotate-names(|def-path) = fail

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/compilation-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/compilation-library.generated.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,143 @@
+module lib/compilation-library.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+  
+rules // Extension points
+    
+  // Should compile given analysed ast.
+  index-compile-ast(|file, subfile, project-path) = fail
+  
+rules // Compilation
+  
+  index-schedule-compilation:
+    <with(?(_, _, _) | "(ast, path, project-path) tuple expected")> -> None()
+    with
+      queue-strategy(|"index-compilation", "Compiling!")
+    
+  index-compilation:
+    (ast, path, project-path) -> <index-compilation(|path, project-path)> ast
+  
+  index-compilation(|path, project-path):
+    ast -> None()
+    with
+      // Init
+      full-path := $[[project-path]/[path]];
+      language  := <index-origin-language> ast;
+      index-setup(|language, [project-path], full-path)
+    with
+      // Determine the files to compile by looking at changed files.
+      diffs         := <analyze-get-diffs>;
+      files         := <map(index-compilation-restore-read-file)> diffs;
+      filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
+      
+      // Clean compile time reads.
+      <filter(index-compilation-clean-reads)> filteredFiles;
+      
+      <set-total-work-units> <length> filteredFiles;
+      
+      // Compile the files
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles;
+      
+      // Clean diffs
+      analyze-clean-diff
+
+  index-compilation-file(|language, project-path):
+    (file, subfile) -> None()
+    with
+      // Parse and analyze ast.
+      ast                                 := <parse-file> file;
+      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|Compile(), language, file)> (ast, file, project-path)
+    with
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Compile file
+        <index-compile-ast(|file, subfile, project-path)> ast';
+        
+        // Store compile-time reads.
+        reads := <iset-elements> readSet;
+        <index-add-all(|<index-compilation-file-tuple> (file, subfile))> reads
+      |}
+
+  index-compilation-filter-file = 
+    ?(<id>, _); (is-test-file <+ index-is-fake-file <+ not(file-exists))
+
+rules // Compile time reads
+
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
+    with
+      file' := <string-replace(|<index-compilation-read-path>, "")> file
+      
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+      
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  index-compilation-read-path =
+    !"/.internal/reads/compile"
+    
+signature constructors // On save handling
+
+  CommitAndCompile : List(UriPart) -> Summary
+  CommitAndCompile : Namespace
+    
+rules // On save handling
+  
+  commit-and-compile:
+    (_, path, project-path) -> <id>
+    with
+      index-commit
+    with
+      index-schedule-compilation
+  
+  index-on-save:
+    (ast, _, _, path, project-path) -> None()
+    with
+      if 0 := <analysis-count> then
+        disable-commit-and-compile;
+        <commit-and-compile> (ast, path, project-path)
+      else
+        enable-commit-and-compile
+      end
+      
+  post-analyze-top(|phase, language, full-path):
+    _ -> <id>
+    with
+      if Editor() := phase then 
+          scheduledAnalyses := <analysis-count>
+      else
+        scheduledAnalyses := -1
+      end
+    with
+      if 0 := scheduledAnalyses; check-commit-and-compile then
+        disable-commit-and-compile;
+        commit-and-compile
+      end
+      
+  analysis-count = 
+    prim("SSL_EXT_queue_analysis_count")
+      
+  enable-commit-and-compile:
+    _ -> <id>
+    with
+      <index-add-all(|<index-commit-and-compile-path>)> [CommitAndCompile([CommitAndCompile(), ".internal"])]
+      
+  disable-commit-and-compile:
+    _ -> <id>
+    with
+      <index-clear-file> <index-commit-and-compile-path>
+      
+  check-commit-and-compile:
+    _ -> <id>
+    where
+        <index-get> CommitAndCompile([CommitAndCompile(), ".internal"])
+      
+  index-commit-and-compile-path =
+    !"/.internal/commit-and-compile"

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/editor-common.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/editor-common.generated.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,264 @@
+module lib/editor-common.generated
+
+imports
+  libstratego-lib
+  libstratego-sglr
+  libstratego-gpp
+
+strategies
+
+  parse-file = parse-namedefinitionlanguage-file
+  parse-namedefinitionlanguage-file =
+    parse-file(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/NameDefinitionLanguage.tbl)>
+    )
+
+  parse-string = parse-namedefinitionlanguage-string
+  parse-namedefinitionlanguage-string =
+    parse-string(
+      strsglr-report-parse-error
+    | <import-term(include/NameDefinitionLanguage.tbl)>
+    )
+  
+  parse-stream = parse-namedefinitionlanguage-stream
+  parse-namedefinitionlanguage-stream =
+    parse-stream(
+      strsglr-report-parse-error
+    | <import-term(include/NameDefinitionLanguage.tbl)>
+    )
+
+  pp-namedefinitionlanguage-string =
+    ast2abox(|[<import-term(include/NameDefinitionLanguage.generated.pp.af)>,
+               <import-term(include/NameDefinitionLanguage.pp.af)>]);
+    box2text-string(|100)
+
+strategies
+  
+  /**
+   * Processes an import during semantic analysis.
+   * Ensures proper caching of files and prevents
+   * processing duplicate imports more than once.
+   *
+   * @param resolve-path  Resolves the filesystem path of this import
+   * @param parse-file    Parses a file (optionally removing definition bodies
+   *                      so only signatures are stored in the cache)
+   * @param record-declarations
+   *                      Performs semantic analysis on a tree
+   */
+  open-import(resolve-path, parse-file, record-declarations):
+    import -> import
+    where
+      if not(!import => COMPLETION(_)) then
+        path       := <resolve-path> import;
+        cache-path := <import-cache-path> path;
+        if not(<IsImported> path) then
+          rules(
+            IsImported: path
+          );
+          ( <is-newer> (cache-path, path);
+            file := <ReadFromFile> cache-path
+          <+
+            file := <parse-file> path;
+            if <file-exists> path then
+              // Only cache if on filesystem (e.g., ignore libstratego-lib)
+              <WriteToBinaryFile> (cache-path, file)
+            end        
+          );
+          {| CurrentFile:
+            rules(CurrentFile := path);
+            <record-declarations> file
+          |}
+        end
+      end
+
+  open-wildcard-import(resolve-path, parse-file, record-declarations, is-source-file):
+    import -> import
+    where
+      if not(!import => COMPLETION(_)) then
+        path := <resolve-path> import;
+        readdir;
+        list-loop(
+          if is-source-file then
+            <open-import(id, parse-file, record-declarations)>
+              $[[path]/[<id>]]
+          <+
+            try(?one-failed)
+          end
+        );
+        not(!one-failed)
+      end
+  
+  import-cache-path:
+    full-path -> cache-path
+    with
+      project-path := <project-path>;
+      cache-dir    := <file-exists <+ mkdir> $[[project-path]/.cache];
+      full-path'   := <string-replace(|"/", "+"); string-replace(|"\\", "+"); string-replace(|":", "+")> full-path;
+      cache-path   := $[[cache-dir]/[full-path'].sig]
+
+  project-path = prim("SSL_EXT_projectpath")
+  
+  plugin-path = prim("SSL_EXT_pluginpath")
+  
+  candidate-sorts = prim("SSL_EXT_candidatesorts")
+
+  is-newer:
+    (file1, file2) -> <id>
+    where
+      <gt> (<file-exists; modification-time> file1, <file-exists; modification-time> file2) 
+
+strategies
+  
+  editor-init =
+    // Ensure all dynamic rules are properly scoped
+    try(dr-scope-all-end);
+    dr-scope-all-start
+  
+  refresh-workspace-file:
+    path -> <prim("SSL_EXT_refreshresource", path)>
+  
+  string-starts-with-capital =
+    explode-string; Hd; is-upper
+
+strategies
+  
+  origin-term      = prim("SSL_EXT_origin_term", <id>)
+  origin-text      = prim("SSL_EXT_origin_text", <id>)
+  origin-offset    = prim("SSL_EXT_origin_offset", <id>)
+  origin-location  = prim("SSL_EXT_origin_location", <id>)
+  origin-line      = origin-location => (<id>, _, _, _)
+  origin-column    = origin-location => (_, <id>, _, _)
+  origin-file      = prim("SSL_EXT_origin_file", <id>)
+  origin-strip     = prim("SSL_EXT_origin_strip", <id>)
+  origin-equal(|t) = prim("SSL_EXT_origin_equal", <id>, t)
+
+  origin-language =
+    prim("SSL_EXT_origin_language", <id>)
+  
+  origin-surrounding-comments =
+    prim("SSL_EXT_origin_surrounding_comments", "NameDefinitionLanguage", <id>)
+    
+  origin-documentation-comment =
+    origin-surrounding-comments;
+    filter(string-as-chars(documentation-comment-chars));
+    concat-strings
+  
+  documentation-comment-chars:
+    ['*' | c*] -> <ltrim(' ' + '\t' + '\n' + '\r')> c*
+  
+  origin-track-forced(s) =
+    ![<id>]; all(s); ?[<id>]
+
+strategies
+
+  desugar-position(desugar|ast):
+    position -> position'
+    where
+      ast'  := <at-position(!<id>{MARKER()}|position)> ast;
+      ast'' := <topdown(repeat(preserve-annos({?x; desugar; not(?x)})))> ast';
+      position' := <position-of-term({?_{a*}; <one(?MARKER())> a*})> ast''
+   
+  at-position(s|position):
+    c#(t*) -> t'
+    where
+      !position => [i | position']
+    where
+      t' := c#(<at-index(at-position(s|position'))> (i, t*))
+
+  at-position(s|position):
+    t -> t'
+    where
+      !position => [];
+      t' := <s> t
+
+  position-of-term(is-term):
+    t -> []
+    where
+      is-term
+  
+  position-of-term(is-term):
+    _#(t*) -> <position-of-term(is-term|0)> t*
+  
+  position-of-term(is-term|start-index):
+    [t | t*] -> position
+    where
+      if i* := <position-of-term(is-term)> t then
+        position := [start-index | i*]
+      else
+        position := <position-of-term(is-term | <inc> start-index)> t*
+      end
+
+  term-at-position(|position):
+    t -> t'
+    where
+      at-position(?t'|position) 
+
+  parent-at-position(|position):
+    t -> t'
+    where
+      !position => [i, _];
+      t' := <subterm-at(|i)> t
+  
+  parent-at-position(|position):
+    t -> <parent-at-position(|position')> t'
+    where
+      !position => [i | position' @ [_, _ | _]];
+      t' := <subterm-at(|i)> t
+
+  subterm-at(|index):
+    _#(t*) -> <index(|<inc> index)> t*
+  
+signature constructors
+
+  COMPLETION : String -> Term
+  NOCONTEXT  : Term   -> Term
+  MARKER     : Term
+  True       : Term
+
+  // Below are copies of the signatures of the terms used in example
+  // trans/namedefinitionlanguage.str file. These definitions should also be automatically 
+  // generated in the imported include/NameDefinitionLanguage.str module. However,
+  // to ensure that the example transformation doesn't break when the
+  // syntax is changed, we also hard-coded them here.
+          
+  Module   : ID * List(Entity)   -> Module
+  Entity   : ID * List(Property) -> Entity
+  Property : ID * Type           -> Property
+  Type     : ID                  -> Type
+
+strategies
+  
+  // Set markers for a given file. Use when checking files from a queued strategy.
+  // Current term: (ast-desugared, errors, warnings, notes) tuple
+  // ast: the root node of the file to set markers on 
+  set-markers(|ast) = prim("SSL_EXT_set_markers", ast)
+
+  // Indicate that one or more files need analysis. 
+  // Current term: ss a list of absolute file paths, or a single absolute file path to analyze
+  queue-analysis = 
+       (is-list; list-loop(queue-analysis))
+    <+ prim("SSL_EXT_queue_analysis")
+    
+  // Gets the number of background analyses for currenct project and language.
+  // Current term: ignored
+  analysis-count = prim("SSL_EXT_queue_analysis_count")
+
+  // Set the total number of work units to complete. Can be called multiple times. 
+  // Current term: number of work units (int).
+  set-total-work-units = prim("SSL_EXT_set_total_work_units")
+  
+  // Complete one work unit and update progress monitors.
+  // Current term: ignored
+  complete-work-unit = prim("SSL_EXT_complete_work_unit")
+  
+  // Queue a strategy for background processing with a progress indicator.
+  // Current term: the term to pass to the background strategy
+  // s: the strategy, as string
+  // description: name of the task (will be shown in progress view)
+  queue-strategy(|s,description) = prim("SSL_EXT_queue_strategy", s, description)
+  
+  // Return the result of this strategy to indicate a non-completed (backgrounded) analysis.
+  // Editor services (hover, resolve) will be delayed until a complete analysis is performed. 
+  set-analysis-backgrounded = !"BACKGROUNDED"
+  

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/index-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/index-library.generated.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,280 @@
+module lib/index-library.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  
+signature constructors
+  
+  // Index elements
+  DefData      : List(UriPart) * DefDataType * Term -> Summary
+    
+  // URI header
+  Namespace      : UriPart
+  Unresolved     : Namespace -> UriPart
+  INTERNAL_ERROR : UriPart
+  Timestamp      : UriPart
+ 
+  // Remainder of URI
+  String : UriPart
+  Anon   : Int -> UriPart
+  Anon   : UriPart
+  
+  FileEntries : Term * Term -> Term
+  
+rules // Index management
+   
+  index-setup(|language, project-paths) =
+    obsolete(!"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)");
+    index-setup(|language, project-paths, ".")
+    
+  /**
+   * Sets up the index library for given language and project paths.
+   * Must be called once before doing anything with the library.
+   */
+  index-setup(|language, project-paths, current-file) =
+    prim("LANG_index_setup", language, project-paths, current-file)
+
+  /**
+   * Adds all given elements to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   */
+  index-add-all(|file) =
+    list-loop(with(prim("LANG_index_add", <id>, file)))
+    
+  /**
+   * Removes all given elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   */
+  index-remove-all(|files) =
+    list-loop(with(prim("LANG_index_remove", <id>, files)))
+    
+  /**
+   * Removes all elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-clear-file> "fullpath/file.ext"
+   *   <index-clear-file> ("fullpath/file.ext", "subfile")
+   */
+  index-clear-file = 
+    prim("LANG_index_clear_file", <id>)
+    
+  /**
+   * Clears all elements from the index.
+   */
+  index-clear = 
+    prim("LANG_index_clear_all")
+   
+  /**
+   * Commits index to a file on disk.
+   */
+  index-commit = 
+    if not(index-timestamp-get-updates(|"LANG_index_commit") => []) then
+      prim("LANG_index_commit");
+      index-timestamp-set-updated(|"LANG_index_commit")
+    end
+  
+rules // Index API
+  
+  /**
+   * Gets the file that the analysis is currently in.
+   */
+  index-get-current-file =
+    prim("LANG_index_get_current_file")
+  
+  /**
+   * Gets a list of all files and subfile for current project.
+   *
+   * Example:
+   *   <index-get-all-files> => ["fullpath/file.ext", ...]
+   */   
+  index-get-all-files =
+    prim("LANG_index_all_files")
+  
+  /**
+   * Gets all index entries for the given file path and optionally subfile.
+   *
+   * Examples:
+   *   <index-get-all-in-file> "fullpath/file.ext" => [Def([Entity(), "Bar"]), ...]
+   *   <index-get-all-in-file> ("fullpath/file.ext", "subfile") => [Def([Entity(), "Bar"]), ...]
+   */  
+  index-get-all-in-file:
+    filepath -> entries
+    with
+      entries := <prim("LANG_index_get_all_in_file", filepath)>
+   
+  /**
+   * Gets all index entries for the given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-get-all-in-file(|Import())> "fullpath/file.ext" => [Def([Import(), "Bar"]), ...]
+   */  
+  index-get-all-in-file(|namespace):
+    filepath -> entries
+    with
+      // TODO: Optimize -- add an argument to LANG_index_get_all_in_file to do this filtering
+      entries := <prim("LANG_index_get_all_in_file", filepath)>;
+      filter(where(index-uri => [namespace | _]))
+    
+  /**
+   * Gets the containing files and subfiles of index entry with given template.
+   *
+   * Example:
+   *   <index-get-files-of> Def([Entity(), "Bar"]) => [("fullpath/file.ext", "subfile"), ...]
+   */  
+  index-get-files-of:
+    template -> <prim("LANG_index_get_files_of", template)>
+    
+  /**
+   * Gets all index entries (of every file for current project).
+   *
+   * Example:
+   *   <indexlib-get-all-elements> => [Def([Entity(), "Bar"]), ...]
+   */
+  indexlib-get-all-elements =
+    // TODO: is there a use case for this? doing this is *expensive*
+    <mapconcat(index-get-all-in-file)> <index-get-all-files>
+    
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   */
+  indexlib-get-all:
+    template -> <prim("LANG_index_get", template)>
+    
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * @see index-value
+   *
+   * Example:
+   *   <indexlib-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   */
+  indexlib-get-all-values:
+    template -> <map(index-value)> <indexlib-get-all> template
+ 
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   */
+  indexlib-get:
+    template -> <?[<id>|_]> <indexlib-get-all> template
+   
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * @see index-value
+   *
+   * Example:
+   *   <indexlib-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   */
+  indexlib-get-value:
+    template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
+ 
+  /**
+   * Updates the "last updated" timestamp for the given service name.
+   *
+   * @see index-get-changes-since-timestamp(|service)
+   */
+  index-timestamp-set-updated(|service) =
+    file := $[/.internal/timestamps/[service]];
+    <index-clear-file> file;
+    prim("LANG_index_add", DefData([Timestamp(), "timestamps", ".internal"], Timestamp(), []), file)
+   
+  /**
+   * Gets all files with changes since the last time stamp update for the given service name.
+   */
+  index-timestamp-get-updates(|service):
+    _ -> files'
+    with
+      timestampName := $[/.internal/timestamps/[service]];
+      files := <prim("LANG_index_get_files_newer_than", timestampName)>;
+      files' := <remove-all(?(timestampName, _))> files
+
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   */
+  index-is-fake-file = string-starts-with(|"/.internal")
+    
+  /**
+   * Gets the URI part for given term.
+   */ 
+  index-uri = index-uri-impl <+ index-uri-generic
+  
+  /**
+   * Checks if given URI's are equal. Discards anonymous scopes if necessary.
+   *
+   * Example:
+   *   <index-uri-eq> ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"]) => 
+   *     ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"])
+   *   <index-uri-eq> ([Entity(), "Foo"], [Entity(), "Bar"]) => fail
+   */
+  index-uri-eq:
+    (u1, u2) -> <id>
+    where
+      u1' := <index-uri-unwrap> u1;
+      u2' := <index-uri-unwrap> u2;
+      (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
+
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
+   *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
+   *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
+  
+  /**
+   * Gets the value part for given term.
+   */  
+  index-value = index-value-impl <+ index-value-generic
+  
+  /**
+   * Finds the first key (term{uri} element) for given term, or fail. 
+   */
+  index-find-key:
+    x -> key
+    where
+      key := <collect-one(?_{_})> x
+      
+/** @internal */
+rules // URI and value projections
+    
+  index-uri-impl:
+    DefData(uri, _, _) -> uri
+
+  index-uri-generic:
+    term -> <?_#(<?[<id>|_]>)> term
+  
+  index-value-impl:
+    DefData(_, _, value) -> value
+    
+  index-value-generic:
+    term -> <?_#(<?[_, <id>|_]> )> term
+     
+/** @internal */ 
+rules // Internal helpers
+  
+  index-namespace-unwrap =
+    \Unresolved(n) -> n\ <+ id
+    
+  index-uri-unwrap =
+    \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id
+    
+  index-key-unwrap = 
+    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/refactor-common.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/refactor-common.generated.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,67 @@
+module lib/refactor-common.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  
+
+strategies //transformation
+
+/**
+ * Replaces elements in a list (once, starting from the right)
+ * @param match strategy for partial list
+ * @param new elements List(b)
+ * @type List(a) -> List(a,b)
+ */
+replace-sublist(match-sublist|new-elems): 
+  list -> <
+    at-suffix(match-sublist;!new-elems) <+
+    (
+      init; 
+      replace-sublist(match-sublist|new-elems);
+      at-end(![<last> list])
+    )
+  > list 
+
+/**
+ * Inserts an element at a given AST position
+ * @param List(Int), denoting an AST position
+ * @param inserted list element 
+ * @type Term -> Term
+ */
+insert-elem(|pos, elem)=
+  insert-sublist(|pos, [elem])
+
+/**
+ * Inserts a list of elements at a given AST position
+ * @param List(Int), denoting an AST position
+ * @param inserted list elements 
+ * @type Term -> Term
+ */	
+insert-sublist(|pos, elems)=
+  at-position(
+    split-at(|<last> pos);
+    ?(prefix, suffix);
+    <concat>[prefix, elems, suffix]
+    |<init> pos
+  )
+
+
+strategies //user-input
+
+/**
+ * Opens an input dialog for one string value that represents an identifier
+ * The language is used to check if the input value matches the identifier pattern
+ * @type (String, String, String, String) -> String
+ */
+input-dialog:
+  (language, title, label, default-value) -> <prim("SSL_EXT_newnamedialog", language, title, label, default-value)>
+  
+input-dialog:
+  (title, label, default-value) -> <input-dialog>("", title, label, default-value)
+
+strategies //pp-table
+	
+get-pp-table=
+  import-term(include/NameDefinitionLanguage.generated.pp.af)
+	

Added: spoofax-imp/trunk/org.strategoxt.imp.names/plugin.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/plugin.xml	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<?eclipse version="3.0"?>
+
+<plugin>
+       <extension point="org.eclipse.imp.runtime.languageDescription">
+          <language extensions="names" description="NameDefinitionLanguage" language="NameDefinitionLanguage" derivedFrom="DynamicRoot" validator="org.strategoxt.imp.names.NameDefinitionLanguageValidator" validatorClass="org.strategoxt.imp.names.NameDefinitionLanguageValidator"></language>
+       </extension>
+       <extension id="org.strategoxt.imp.names.parser" name="NameDefinitionLanguage Parser" point="org.eclipse.imp.runtime.parser">
+          <parser class="org.strategoxt.imp.names.NameDefinitionLanguageParseController" language="NameDefinitionLanguage">
+          </parser>
+       </extension>    
+    </plugin>
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/Common.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/Common.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,46 @@
+module Common
+
+exports
+
+  lexical syntax
+  
+    [a-zA-Z][a-zA-Z0-9]* -> ID
+    "-"? [0-9]+          -> INT
+    
+    "\"" StringChar* "\"" -> STRING
+    ~[\"\n]               -> StringChar
+    "\\\""                -> StringChar
+    BackSlashChar         -> StringChar
+    "\\"                  -> BackSlashChar
+    
+    [\ \t\n\r] -> LAYOUT
+    
+    [\*]                             -> CommentChar
+    "/*" (~[\*] | CommentChar)* "*/" -> LAYOUT
+    "//" ~[\n\r]* ([\n\r] | EOF)     -> LAYOUT
+    
+    -> EOF
+  
+  lexical restrictions
+  
+    %% Ensure greedy matching for lexicals
+  
+    CommentChar   -/- [\/]
+    INT           -/- [0-9]
+    ID            -/- [a-zA-Z0-9\_]
+    
+    %% EOF may not be followed by any char
+    
+    EOF           -/- ~[]
+
+    %% Backslash chars in strings may not be followed by " 
+    
+    BackSlashChar -/- [\"]
+
+  context-free restrictions
+  
+    %% Ensure greedy matching for comments
+
+    LAYOUT? -/- [\ \t\n\r]
+    LAYOUT? -/- [\/].[\/]
+    LAYOUT? -/- [\/].[\*]

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,46 @@
+[
+   Var                      -- _1,
+   Wld                      -- KW["_"],
+   Int                      -- _1,
+   Real                     -- _1,
+   Str                      -- _1,
+   Op                       -- _1 KW["("] _2 KW[")"],
+   Op.2:iter-star-sep       -- _1 KW[","],
+   OpQ                      -- _1 KW["("] _2 KW[")"],
+   OpQ.2:iter-star-sep      -- _1 KW[","],
+   NoAnnoList               -- _1,
+   ListVar                  -- _1,
+   Var                      -- _1,
+   Char                     -- _1,
+   List                     -- KW["["] _1 KW["]"],
+   List.1:iter-star-sep     -- _1 KW[","],
+   ListTail                 -- KW["["] _1 KW["|"] _2 KW["]"],
+   ListTail.1:iter-star-sep -- _1 KW[","],
+   Naming                   -- KW["module"] _1 _2 _3 _4,
+   Import                   -- _1,
+   Namespace                -- _1,
+   NsRef                    -- _1,
+   ND-Rule                  -- _1 KW[":"] _2,
+   ND-Rule.2:iter           -- _1,
+   ND-Def                   -- KW["defines"] _1 _2 _3 _4 _5,
+   ND-Ref                   -- KW["refers"] KW["to"] _1 _2 _3 _4,
+   ND-Scope                 -- _1 KW["scope"] KW["for"] _2 _3,
+   ND-Type                  -- KW["has"] KW["type"] _1,
+   ND-Condition             -- KW["where"] _1 _2,
+   TypeCheck                -- KW["has"] KW["type"] _1,
+   ReferenceCheck           -- KW["refers"] KW["to"] _1 _2 _3 _4,
+   Unique                   -- KW["unique"],
+   Nonunique                -- ,
+   TypeBinding              -- KW["of"] KW["type"] _1,
+   None                     -- ,
+   DefScope                 -- KW["in"] _1,
+   None                     -- ,
+   RefScope                 -- KW["in"] _1 _2,
+   None                     -- ,
+   Ordered                  -- KW["ordered"],
+   Unordered                -- KW["unordered"],
+   Unordered                -- ,
+   Including                -- KW["including"] _1 KW["in"] _2,
+   Overriding               -- KW["overriding"] _1 KW["in"] _2,
+   None                     -- 
+]
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.pp
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.pp	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,2 @@
+%% Pretty printing table (see also NameDefinitionLanguage.generated.pp)
+[]

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,60 @@
+%% Grammar for the NameDefinitionLanguage language
+module NameDefinitionLanguage
+
+imports
+	stratego/NDL-Layout
+	stratego/NDL-Identifiers
+	stratego/NDL-Terms
+	
+exports context-free start-symbols
+
+	Start
+
+context-free syntax
+
+	NamingDefinition -> Start
+	
+	"module" Module@=ModName Imports Namespaces NamingRules -> NamingDefinition {"Naming", scope(Namespace)}
+	
+	"imports" ModuleRef+	-> Imports   {bracket}
+							-> Imports   {ast("[]")}
+	Module at ModName 			-> ModuleRef {"Import"}
+	
+	"namespaces" Namespace* -> Namespaces   {bracket}
+							-> Namespaces   {ast("[]")}
+	Namespace@=Id			-> Namespace    {"Namespace"}
+	Namespace at Id 			-> NamespaceRef {"NsRef"}
+	
+	"rules" NamingRule* 	-> NamingRules {bracket}
+							-> NamingRules {ast("[]")}
+	Term ":" NamingPart+ 	-> NamingRule  {"ND-Rule"}
+	
+	"defines" UniquePart NamespaceRef Term TypePart DefScopePart	-> NamingPart {"ND-Def"}
+	"refers" "to" NamespaceRef Term TypePart RefScopePart			-> NamingPart {"ND-Ref"}
+	OrderedPart "scope" "for" NamespaceRef IncludingPart			-> NamingPart {"ND-Scope"}
+	"has" "type" Term												-> NamingPart {"ND-Type"}
+	"where" Term Condition											-> NamingPart {"ND-Condition"}
+	
+	"has" "type" Term 								 	 	-> Condition {"TypeCheck"}
+	"refers" "to" NamespaceRef Term TypePart RefScopePart 	-> Condition {"ReferenceCheck"}
+	
+	"unique"			-> UniquePart {"Unique"}
+						-> UniquePart {"Nonunique"}
+	
+	"of" "type" Term	-> TypePart {"TypeBinding"}
+						-> TypePart {"None"}
+	
+	"in" Term				-> DefScopePart {"DefScope"}
+						    -> DefScopePart {"None"}
+	"in" NamespaceRef Term	-> RefScopePart {"RefScope"}
+						    -> RefScopePart {"None"}
+						
+	"ordered"			-> OrderedPart {"Ordered"}
+	"unordered"			-> OrderedPart {"Unordered"}
+						-> OrderedPart {"Unordered"}
+						
+	"including" NamespaceRef "in" Term	-> IncludingPart {"Including"}
+	"overriding" NamespaceRef "in" Term	-> IncludingPart {"Overriding"}
+										-> IncludingPart {"None"}	
+	
+	
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Constants.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Constants.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,16 @@
+module stratego/NDL-Constants
+exports
+  sorts Int Real String StrChar
+  lexical syntax
+    [\-]? [0-9]+ 		-> Int
+    [\-]? [0-9]+ [\.] [0-9]+ 	-> Real
+    "\"" StrChar* "\"" 		-> String
+    ~[\"\\] 			-> StrChar
+    [\\] [\"tnr\\] 		-> StrChar
+
+  sorts Char CharChar
+  lexical syntax
+    "'" CharChar "'"		-> Char
+    ~[\']			-> CharChar
+    [\\] [\'ntr\ ]		-> CharChar
+    Char		 	-> Id {reject}

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Identifiers.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Identifiers.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,97 @@
+module stratego/NDL-Identifiers
+exports
+  sorts ModName ModNamePart
+  lexical syntax
+    {ModNamePart "/"}+ -> ModName
+    [a-zA-Z\.\_] [a-zA-Z0-9\'\.\-\_]* -> ModNamePart
+  lexical restrictions
+    ModName -/- [a-zA-Z0-9\'\.\-\_]
+  lexical syntax
+    "imports" 		-> ModName {reject}
+    "overlays" 		-> ModName {reject}
+    "rules" 		-> ModName {reject}
+    "signature" 	-> ModName {reject}
+    "strategies" 	-> ModName {reject}
+
+  sorts Id LId LCID UCID Wld
+  lexical syntax
+    [a-zA-Z\_] [a-zA-Z0-9\'\-\_]*     -> Id
+    [a-zA-Z\_] [a-zA-Z0-9\'\-\_]* "*" -> LId
+    [\'] [a-z]+                       -> Id
+
+    [a-z] [a-zA-Z0-9\'\-\_]*  -> LCID
+    [A-Z] [a-zA-Z0-9\'\-\_]*  -> UCID
+
+  lexical restrictions
+    Id   -/- [a-zA-Z0-9\'\_\*]
+    Id   -/- [\-].~[\>]
+    LId  -/- [a-zA-Z0-9\'\-\_]
+    LCID -/- [a-zA-Z0-9\'\-\_]
+    UCID -/- [a-zA-Z0-9\'\-\_]
+
+  lexical syntax
+    "_"     -> Id {reject}
+    "'"     -> Id {reject}
+
+    Keyword -> Id   {reject}
+    Keyword -> LId  {reject}
+    Keyword -> LCID {reject}
+    Keyword -> UCID {reject}
+
+  lexical restrictions
+    "all"
+    "case" %% not reserved kw
+    "constructors"
+    "else" %% not reserved kw
+    "end" %% not reserved kw
+    "external" %% not reserved kw
+    "fail"
+    "id"
+    "if" %% not reserved kw
+    "in"
+    "imports" %% not reserved kw
+    "let"
+    "module"
+    "not"
+    "one"
+    "overlays"
+    "otherwise" %% not reserved kw
+    "prim"
+    "rec" %% not reserved kw
+    "rules"
+    "script"
+    "signature"
+    "some"
+    "sorts"
+    "strategies"
+    "stratego"
+    "switch" %% not reserved kw
+    "test"
+    "then" %% not reserved kw
+    "where"
+    "import-term"
+      -/- [a-zA-Z0-9\'\-\_]
+  
+  sorts Keyword
+  lexical syntax
+    "all"               -> Keyword
+    "constructors" 	-> Keyword
+    "fail" 		-> Keyword
+    "id" 		-> Keyword
+    "in" 		-> Keyword
+    "let" 		-> Keyword
+    "module" 		-> Keyword
+    "not" 		-> Keyword
+    "one" 		-> Keyword
+    "overlays" 		-> Keyword
+    "prim" 		-> Keyword
+    "rules" 		-> Keyword
+    "script" 		-> Keyword
+    "signature" 	-> Keyword
+    "some" 		-> Keyword
+    "sorts" 		-> Keyword
+    "strategies" 	-> Keyword
+    "stratego" 		-> Keyword
+    "test" 		-> Keyword
+    "where" 		-> Keyword
+    "import-term"	-> Keyword

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Layout.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Layout.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,28 @@
+module stratego/NDL-Layout
+exports
+  sorts Ws ShortCom LongCom CommChar Asterisk Eof 
+  lexical syntax
+    [\t\ \n\r]			-> Ws
+
+    "//" ~[\n]* ([\n] | Eof)	-> ShortCom
+    "/*" CommChar* "*/"	-> LongCom
+				-> Eof  
+
+    ~[\*]     -> CommChar
+
+    "*"       -> Asterisk
+    Asterisk  -> CommChar
+
+  lexical restrictions
+    Asterisk -/- [\/]
+    Eof      -/- ~[]
+
+  lexical syntax
+    ShortCom 	-> LAYOUT
+    LongCom 	-> LAYOUT
+    Ws 		-> LAYOUT
+
+  context-free restrictions
+    LAYOUT? -/- [\ \t\n\r]
+    LAYOUT? -/- [\/].[\*]
+    LAYOUT? -/- [\/].[\/]

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Signatures.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Signatures.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,36 @@
+module stratego/NDL-Signatures
+imports
+	stratego/NDL-Identifiers
+	stratego/NDL-Constants
+	stratego/NDL-StringQuotations
+	
+exports
+
+	sorts Sort
+	context-free syntax
+		
+		LCID					-> Sort {cons("SortVar")}
+		UCID					-> Sort {cons("SortNoArgs")}
+		Id "(" {Sort ","}* ")"	-> Sort {cons("Sort")}
+
+	sorts TypeDecl PPTerm
+	context-free syntax
+
+		Id     TypeParams PPTerm	-> TypeDecl {cons("TypeDecl")}
+		String TypeParams PPTerm	-> TypeDecl {cons("TypeDeclQ")}
+
+		String			-> PPTerm {cons("Str")}
+		
+	sorts TypeParams TypeParam 
+	context-free syntax
+		
+									-> TypeParams {cons("NoTypeParams")}
+		"(" {TypeParam ","}+  ")"	-> TypeParams {cons("TypeParams")}
+		Id ":" Sort					-> TypeParam {cons("TypeParam")}
+
+	%%%
+	 %% Restriction is required for the Sort* in Sdecl: List(a) is
+	 %% ambiguous.
+	 %%%
+	context-free restrictions
+		Sort -/- [\(]

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-StringQuotations.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-StringQuotations.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,73 @@
+module stratego/NDL-StringQuotations
+
+imports stratego/NDL-Terms
+exports
+
+  sorts
+  	PPTerm
+    StringQuotation
+    StringQuotedPart1 StringQuotedChars1 DollarOpen1 DollarClose1 QuotedBracket1 Dollar1
+    StringQuotedPart2 StringQuotedChars2 DollarOpen2 DollarClose2 QuotedBracket2 Dollar2
+    StringQuotedPart3 StringQuotedChars3 DollarOpen3 DollarClose3 QuotedBracket3 Dollar3
+    StringQuotedPart4 StringQuotedChars4 DollarOpen4 DollarClose4 QuotedBracket4  Dollar4
+    Padding
+
+  context-free syntax
+
+    StringQuotation -> PPTerm
+
+  syntax
+
+    StringQuotation -> <PPTerm-CF>
+
+    "$" "[" Padding StringQuotedPart1*               "]"    -> StringQuotation {cons("StringQuotation1") }
+     Padding "[" <LAYOUT?-CF> <Term-CF> <LAYOUT?-CF> "]"    -> StringQuotedPart1 {cons("StringEscape1")}
+    <StringQuotedChars1-LEX>                                -> StringQuotedPart1 {cons("QStr")}
+    <Dollar1-LEX>                                           -> StringQuotedPart1 {cons("QDollar")}
+    "$" <QuotedBracket1-LEX> "$"                            -> StringQuotedPart1 {cons("QBr")}
+    ~[\[\]\$]+                                              -> <StringQuotedChars1-LEX>
+    [\[\]]                                                  -> <QuotedBracket1-LEX>
+    "$"                                                     -> <Dollar1-LEX>
+
+    "$" "{" Padding StringQuotedPart2*               "}"    -> StringQuotation {cons("StringQuotation2") }
+     Padding "{" <LAYOUT?-CF> <Term-CF> <LAYOUT?-CF> "}"    -> StringQuotedPart2 {cons("StringEscape2")}
+    <StringQuotedChars2-LEX>                                -> StringQuotedPart2 {cons("QStr")}
+    <Dollar2-LEX>                                           -> StringQuotedPart2 {cons("QDollar")}
+    "$" <QuotedBracket2-LEX> "$"                            -> StringQuotedPart2 {cons("QBr")}
+    ~[\{\}\$]+                                              -> <StringQuotedChars2-LEX>
+    [\{\}]                                                  -> <QuotedBracket2-LEX>
+    "$"                                                     -> <Dollar2-LEX>
+
+    "$" "(" Padding StringQuotedPart3*              ")"     -> StringQuotation {cons("StringQuotation3") }
+    Padding "(" <LAYOUT?-CF> <Term-CF> <LAYOUT?-CF> ")"     -> StringQuotedPart3 {cons("StringEscape3")}
+    <StringQuotedChars3-LEX>                                -> StringQuotedPart3 {cons("QStr")}
+    <Dollar3-LEX>                                           -> StringQuotedPart3 {cons("QDollar")}
+    "$" <QuotedBracket3-LEX> "$"                            -> StringQuotedPart3 {cons("QBr")}
+    ~[\(\)\$]+                                              -> <StringQuotedChars3-LEX>
+    [\(\)]                                                  -> <QuotedBracket3-LEX>
+    "$"                                                     -> <Dollar3-LEX>
+
+    "$" "<" Padding StringQuotedPart4*               ">"    -> StringQuotation {cons("StringQuotation4") }
+    Padding "<"  <LAYOUT?-CF> <Term-CF> <LAYOUT?-CF> ">"    -> StringQuotedPart4 {cons("StringEscape4")}
+    <StringQuotedChars4-LEX>                                -> StringQuotedPart4 {cons("QStr")}
+    <Dollar4-LEX>                                           -> StringQuotedPart4 {cons("QDollar")}
+    "$" <QuotedBracket4-LEX> "$"                            -> StringQuotedPart4 {cons("QBr")}
+    ~[\<\>\$]+                                              -> <StringQuotedChars4-LEX>
+    [\<\>]                                                  -> <QuotedBracket4-LEX>
+    "$"                                                     -> <Dollar4-LEX>
+   
+    %% Padding is a dummy lexical that will contain the indentation prefix of every quotation
+    <Padding-LEX>                                           -> Padding
+                                                            -> <Padding-LEX> {indentpadding}
+
+  lexical restrictions
+
+    StringQuotedChars1 -/- ~[\[\]\$]   
+    StringQuotedChars2 -/- ~[\{\}\$]    
+    StringQuotedChars3 -/- ~[\(\)\$]    
+    StringQuotedChars4 -/- ~[\<\>\$]
+    Dollar1            -/- [\[\]] . [\$]
+    Dollar2            -/- [\{\}] . [\$]
+    Dollar3            -/- [\(\)] . [\$]
+    Dollar4            -/- [\<\>] . [\$]
+

Added: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Terms.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/stratego/NDL-Terms.sdf	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,46 @@
+module stratego/NDL-Terms
+
+imports
+	stratego/NDL-Constants
+	stratego/NDL-Identifiers
+	
+exports
+  sorts ID Var Wld
+  context-free syntax
+    Id 				-> Var  {cons("Var")}
+    Id				-> ID
+
+  sorts Term
+  context-free syntax
+    Var 			 -> PreTerm 
+    Var 			 -> Term {prefer}
+	
+    "_" 			 -> Wld {cons("Wld")}
+    Wld 			 -> PreTerm 
+    Wld 			 -> Term {prefer}
+
+    Int 			 -> PreTerm {cons("Int")}
+    Real 			 -> PreTerm {cons("Real")}
+    String 			 -> PreTerm {cons("Str")}
+
+    Id "(" {Term ","}* ")" 	 	-> PreTerm {cons("Op")}
+    String "(" {Term ","}* ")"	-> PreTerm {cons("OpQ")}
+
+	PreTerm                     -> Term {cons("NoAnnoList")}
+
+  sorts LID
+  context-free syntax
+    LId 			-> LID  {cons("ListVar")}
+    LID				-> Var  {cons("Var")}
+    LID				-> ID
+
+  context-free syntax
+    Char 			 -> PreTerm {cons("Char")}
+
+    %%"(" {Term ","}* ")" 	 -> PreTerm {cons("Tuple")}
+    "[" {Term ","}* "]" 	 -> PreTerm {cons("List")}
+    "[" {Term ","}* "|" Term "]" -> PreTerm {cons("ListTail")}
+	
+  context-free restrictions
+    Wld -/- [a-zA-Z0-9\'\-\_]
+

Added: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.analyzed.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.analyzed.aterm	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,16 @@
+ND-Rule(
+  NoAnnoList(Op("Var", [Var("x")]))
+, [ ND-Ref(
+      NsRef("variable"{[Unresolved(Namespace()), "variable"]})
+    , Var("x")
+    , Type(Var("t"){[Unresolved(Type()), Var("t")]})
+    , None()
+    )
+  , ND-Ref(
+      NsRef("property"{[Unresolved(Namespace()), "property"]})
+    , Var("x")
+    , Type(Var("t"){[Unresolved(Type()), Var("t")]})
+    , None()
+    )
+  ]
+)
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,72 @@
+package example;
+
+class User {
+    
+    private String name;
+    
+    public String get_name {
+        return name;
+    }
+    
+    public void set_name (String name) {
+        this.name = name;    
+    }
+    
+    private String password;
+    
+    public String get_password {
+        return password;
+    }
+    
+    public void set_password (String password) {
+        this.password = password;    
+    }
+    
+    private URL homepage;
+    
+    public URL get_homepage {
+        return homepage;
+    }
+    
+    public void set_homepage (URL homepage) {
+        this.homepage = homepage;    
+    }
+    
+}
+class BlogPosting {
+    
+    private User poster;
+    
+    public User get_poster {
+        return poster;
+    }
+    
+    public void set_poster (User poster) {
+        this.poster = poster;    
+    }
+    
+    private String body;
+    
+    public String get_body {
+        return body;
+    }
+    
+    public void set_body (String body) {
+        this.body = body;    
+    }
+    
+}
+class URL {
+    
+    private String location;
+    
+    public String get_location {
+        return location;
+    }
+    
+    public void set_location (String location) {
+        this.location = location;    
+    }
+    
+}
+

Added: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,60 @@
+module example
+
+namespaces
+
+	entity
+	property
+	variable
+	method
+	
+rules
+
+	Entity(name, _) :
+		defines entity name of type name
+		scope for property overriding property in super
+		scope for method overriding method in super
+		
+	Entity(name, super, _) :
+		defines entity name
+		refers to entity super
+		scope for property overriding property in super
+		scope for method overriding method in super
+
+	Property(x, t) :
+		defines property x of type t
+	
+	PropertyAccess(exp, f) :
+		refers to property f in entity e
+		where exp has type e
+ 
+	For(x, t, e, f, elem*) : 
+  		defines variable x of type t in elem*
+		
+	VarDecl(x, t, e) :
+		defines variable x of type t 
+		
+	VarDecl(x, e) :
+		defines variable x of type t 
+		where e has type t
+
+	Var(x) :
+		refers to variable x // implies has type t where x has type e
+		refers to property x 
+		
+	Block(statement*) : 
+		ordered scope for variable
+		
+	Method(f, param*, t, _) :
+		defines method m(f, t*) of type t
+		ordered scope for variable
+		where param* has type t*
+
+	Param(x, t) :
+		defines variable x of type t
+
+	MethodCall(exp, f, e*) :
+		refers to method m(f, t*) in entity e
+		where exp has type e
+		where e* has type t*
+		
+		
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/test/test-example.spt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/test-example.spt	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,56 @@
+/**
+* Unit tests for the NameDefinitionLanguage language.
+*/
+module test-example
+
+language NameDefinitionLanguage
+
+setup Common [[
+  module test
+]]
+
+test Simple entity [[
+  entity User {
+    name  : String
+    other : User
+  }
+]] 0 errors
+
+test Resolve type fails [[
+  entity User {
+    name  : Strin
+    other : Use
+  }
+]] 2 errors
+
+test Duplicate entity fails [[
+  entity User {}
+  entity User {}
+]] 2 errors
+
+test Duplicate property fails [[
+  entity User {
+  	name : String
+  	name : String
+  }
+]] 2 errors
+
+test Resolve type [[
+  entity [[User]] {}
+  
+  entity Owner {
+    owns : [[User]]
+  }
+]] resolve #2 to #1
+
+test Complete primitive type [[
+  entity User {
+    name : [[Str]]
+  }
+]] complete to "String"
+
+test Complete user type [[
+  entity User {
+    owner : [[Us]]
+  }
+]] complete to "User"

Added: spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,13 @@
+module analysis-manual
+
+imports
+  include/NameDefinitionLanguage
+  lib/analysis-auto.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+
+rules // Adjust lookup
+
+  // Add primitive types to type lookup.
+  adjust-index-lookup(target |namespace, path, prefix): 
+    Type(<target>) ->  [Def([Type(), "Int"]), Def([Type(), "String"]), [Type() | path]]

Added: spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,38 @@
+module check
+
+imports
+  libstratego-lib
+  include/NameDefinitionLanguage
+  lib/editor-common.generated
+  lib/analysis-auto.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+
+rules // Resolving
+  
+  constraint-error:
+    x{[Unresolved(t) | _]} -> (x, $[Unable to resolve.])
+    
+rules // Duplicates
+    
+  is-unique-namespace = ?Type()
+  is-unique-namespace = ?Property()
+      
+  constraint-error:
+    definition -> (definition, $[Duplicate definition])
+    where
+      key{[ns|_]} := <nam-get-definition-key> definition;
+      <is-unique-namespace> ns;
+      definitions := <index-lookup-all> key;
+      <gt> (<length> definitions, 1)
+    
+rules // Other
+  
+  constraint-warning:
+    Entity(x, _) -> (x, $[Entity names must start with a capital])
+    where
+      not(<string-starts-with-capital> x)
+  
+  constraint-note:
+    Module(x @ "example", _) -> (x, $[This is just an example program in the "entities" language
+                                      (this note is defined in trans/check.str) ])

Added: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,62 @@
+module generate
+
+imports
+  libstratego-lib
+  libstratego-gpp
+  libstratego-aterm
+  include/NameDefinitionLanguage
+  lib/editor-common.generated
+  lib/compilation-library.generated
+
+rules // Incremental code generation of project using compilation library.
+      
+  index-compile-ast(|file, subfile, project-path):
+    ast -> None()
+    with
+      java := <to-java> ast;
+      full-path := <dirname> file;
+      filename := <guarantee-extension(|"java")> <base-filename> file;
+      writePath := $[[full-path]/];
+      writeFile :=  $[[writePath][filename]];
+      try(<mkdir> writePath);
+      <fclose> <fputs> (java, <fopen> (writeFile, "w"));
+      <debug> $[Compiling to [writeFile]]
+
+rules // Transformation to java strings.
+
+  to-java:
+    Module(x, d*) ->
+    $[ package [x];
+       
+       [d'*]
+     ]
+    with
+      d'* := <to-java> d*
+  
+  to-java:
+    Entity(x, p*) ->
+    $[ class [x] {
+           [p'*]
+       }
+     ]
+    with
+      p'* := <to-java> p*
+
+  to-java:
+    Property(x, Type(t)) -> $[
+      private [t] [x];
+      
+      public [t] get_[x] {
+          return [x];
+      }
+      
+      public void set_[x] ([t] [x]) {
+          this.[x] = [x];    
+      }
+  ]
+  
+  to-java:
+    Type(t) -> t
+
+  to-java:
+    t* -> <map(to-java)> t*

Added: spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,83 @@
+module namedefinitionlanguage
+
+imports
+  libstratego-lib
+  libstratego-gpp
+  libstratego-aterm
+  include/NameDefinitionLanguage
+  lib/editor-common.generated
+  lib/analysis-auto.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+  lib/compilation-library.generated
+  analysis-manual
+  check
+  generate
+  refactor
+
+rules // Main editor interface (defined by editor/NameDefinitionLanguage-Builders and -References.esv)
+  
+  // Analyzes the current program, returning a tuple with errors, warnings, and notes;
+  // each a list of (term, message) tuples or simply (message) terms.
+  editor-analyze:
+    (ast, path, project-path) -> (ast', errors, warnings, notes)
+    with
+      editor-init;
+      ast'     := <analyze-top>;
+      errors   := <collect-all(constraint-error, conc)> ast';
+      warnings := <collect-all(constraint-warning, conc)> ast';
+      notes    := <collect-all(constraint-note, conc)> ast'
+  
+  // Transforms a selection to Java
+  generate-java:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      filename := <guarantee-extension(|"java")> path;
+      result   := <to-java> selected
+  
+  // Prints the abstract syntax ATerm of a selection.
+  generate-aterm:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := selected // we just return the input term
+      
+  // Prints the analyzed abstract syntax ATerm of a selection.
+  generate-analyzed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      editor-init;
+      filename := <guarantee-extension(|"analyzed.aterm")> path;
+      result   := <analyze-top> (selected, path, project-path)
+  
+  // Resolves a reference when the user control-clicks or presses F3 in the editor.
+  editor-resolve:
+    (node, position, ast, path, project-path) -> target
+    where
+      language  := <index-origin-language> ast;
+      index-setup(|language, [project-path], $[[project-path]/[path]]);
+      target    := <index-lookup> node
+
+  // Returns "hover help" information for a particular node in the editor.
+  // For references, this rule is invoked using the resolved term.
+  editor-hover:
+    (target, position, ast, path, project-path) -> $[Hover help: [<write-to-string> target]]
+
+  // Completes an identifier when the user presses control-space
+  // (the completion identifier in the AST provides additional context information)
+  editor-complete:
+    (node, position, ast, path, project-path) -> proposals'
+    where
+      editor-init;
+      ast'              := <analyze-top> (ast, path, project-path);
+      x                 := <collect-one(?COMPLETION(_))> ast';
+      COMPLETION(name)  := x;
+      (
+        proposals       := <index-lookup-all-levels(|name)> x
+      <+ 
+        proposals       := []
+      );
+      proposals'        := <map(def-to-name)> proposals
+
+  def-to-name:
+    Def([namespace, name | _]) -> name

Added: spoofax-imp/trunk/org.strategoxt.imp.names/trans/refactor.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/refactor.str	Wed May  2 23:35:15 2012	(r24773)
@@ -0,0 +1,28 @@
+module refactor
+
+imports
+  lib/refactor-common.generated
+  include/NameDefinitionLanguage
+  lib/editor-common.generated  
+  namedefinitionlanguage
+
+rules
+ 
+  rename-entity:
+    (newname, selected-name, position, ast, path, project-path) -> ([(ast, new-ast)], fatal-errors, errors, warnings)
+    with
+      new-ast  := <topdown(try(rename-type(|selected-name, newname)))> ast; 
+      (errors, warnings) := <semantic-constraint-issues> (ast, new-ast);
+      fatal-errors := []
+
+  rename-type(|old-name, new-name):
+    Entity(old-name, y) -> Entity(new-name, y)
+
+  rename-type(|old-name, new-name):
+    Type(old-name) -> Type(new-name)
+    
+  semantic-constraint-issues:
+    (ast, new-ast) -> (<diff>(new-errors, errors), <diff>(new-warnings, warnings))
+    where
+    	(_, errors, warnings, _) := <editor-analyze> (ast, "", "");
+    	(_, new-errors, new-warnings, _) := <editor-analyze> (new-ast, "", "")

From gabrielkonat at gmail.com  Thu May  3 11:13:26 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 03 May 2012 09:13:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24774 - in
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main:
	java/org/spoofax/interpreter/library/language stratego/lib
Message-ID: <20120503091326.E1C8BCC149@mx4.tudelft.nl>

Author: gkonat
Date: Thu May  3 09:13:24 2012
New Revision: 24774
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24774&sc=1

Log:
Fixed index globals not showing up in 'get all files'.
Cleaned up some unused stuff from the index primitives.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_get_all_files.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java	Thu May  3 09:13:24 2012	(r24774)
@@ -54,7 +54,7 @@
 	 * 
 	 * @param template	The template to match entries against.
 	 */
-	public abstract void remove(IStrategoAppl template);
+	//public abstract void remove(IStrategoAppl template);
 	
 	/**
 	 * Removes all entries that match given template and are from given file.

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_get_all_files.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_get_all_files.java	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_get_all_files.java	Thu May  3 09:13:24 2012	(r24774)
@@ -24,6 +24,7 @@
 	public boolean call(IContext env, Strategy[] svars, IStrategoTerm[] tvars) {
 		ITermFactory factory = env.getFactory();
 		IStrategoList results = getAllFiles(index.getCurrent(), factory);
+		System.out.println(results.toString());
 		env.setCurrent(results);
 		return true;
 	}

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java	Thu May  3 09:13:24 2012	(r24774)
@@ -81,6 +81,8 @@
 	}
 
 	public void add(SemanticIndexEntry entry) {
+		addOrGetFile(entry.getFileDescriptor());
+		
 		entries.put(entry.getURI(), entry);
 		
 		// Add entry to childs.
@@ -98,10 +100,6 @@
 			entries = entries.tail();
 		}
 	}
-
-	public void remove(IStrategoAppl template) {
-		remove(factory.createURIFromTemplate(template));
-	}
 	
 	public void remove(IStrategoAppl template, SemanticIndexFileDescriptor fileDescriptor) {
 		SemanticIndexURI uri = factory.createURIFromTemplate(template);
@@ -119,17 +117,6 @@
 	}
 	
 	/**
-	 * Removes all entries with given URI.
-	 * 
-	 * @param uri	The URI to remove all entries for.
-	 */
-	private void remove(SemanticIndexURI uri) {
-		Collection<SemanticIndexEntry> removedEntries = entries.removeAll(uri);
-		
-		removeFinal(removedEntries);
-	}
-	
-	/**
 	 * Removes a single entry.
 	 * 
 	 * @param entry	The entry to remove.
@@ -195,6 +182,10 @@
 	}
 	
 	public SemanticIndexFile getFile(SemanticIndexFileDescriptor fileDescriptor) {
+		return addOrGetFile(fileDescriptor);
+	}
+	
+	private SemanticIndexFile addOrGetFile(SemanticIndexFileDescriptor fileDescriptor) {
 		SemanticIndexFile file = files.get(fileDescriptor);
 		if(file == null) {
 			file = new SemanticIndexFile(fileDescriptor, null);

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java	Thu May  3 09:13:24 2012	(r24774)
@@ -92,6 +92,9 @@
 			if(currentIndex.hasClearedCurrentFile())
 				index.removeFile(currentFile.get());
 			
+			for(TemplateWithFileDescriptor entry : currentIndex.getRemovedEntries())
+				index.remove(entry.getTemplate(), entry.getFileDescriptor());
+			
 			for(SemanticIndexEntry entry : transactionIndex.getAllEntries())
 				index.add(entry);
 		} finally {

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java	Thu May  3 09:13:24 2012	(r24774)
@@ -16,6 +16,7 @@
 	private ISemanticIndex transactionIndex;
 	private SemanticIndexFileDescriptor currentFile;
 	private boolean clearedCurrentFile = false;
+	private List<TemplateWithFileDescriptor> removedEntries = new ArrayList<TemplateWithFileDescriptor>();
 	
 	public TransactionSemanticIndex(ISemanticIndex index, ISemanticIndex transactionIndex, 
 			SemanticIndexFileDescriptor currentFile) {
@@ -36,6 +37,10 @@
 		return clearedCurrentFile;
 	}
 	
+	public Collection<TemplateWithFileDescriptor> getRemovedEntries() {
+		return removedEntries;
+	}
+	
 	public void initialize(ITermFactory factory, IOAgent agent) {
 		// Should not be called
 		assert false;
@@ -56,13 +61,10 @@
 	public void addAll(IStrategoList entries, SemanticIndexFileDescriptor fileDescriptor) {
 		transactionIndex.addAll(entries, fileDescriptor);
 	}
-
-	public void remove(IStrategoAppl template) {
-		transactionIndex.remove(template);
-	}
-
+	
 	public void remove(IStrategoAppl template, SemanticIndexFileDescriptor fileDescriptor) {
 		transactionIndex.remove(template, fileDescriptor);
+		removedEntries.add(new TemplateWithFileDescriptor(template, fileDescriptor));
 	}
 
 	public Collection<SemanticIndexEntry> getEntries(IStrategoAppl template) {

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May  3 09:13:24 2012	(r24774)
@@ -187,6 +187,13 @@
 	      (added, removed) := ([], []);
 	      filesToAnalyze := []
       end
+    with
+      if "" := subfile then
+        storePath := [full-path, "ast"]
+      else
+        storePath := [subfile, full-path, "ast"]
+      end;
+      <index-set-global(|storePath)> ast5
       
   /**
    * Identifies all definitions in the tree and annotates them with their URI.
@@ -446,13 +453,18 @@
   analyze-astdiff(|ast):
     (file, subfile) -> <id>
     where
-      name := [subfile, file, "ast-diff"];
+      if "" := subfile then
+        name := [file, "ast-diff"]
+      else
+        name := [subfile, file, "ast-diff"]
+      end;
+      
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
       	<index-set-global(|name)> newChecksum;
         <eq> (oldChecksum, newChecksum)
       else
-        <index-add-global(|name)> newChecksum;
+        <index-set-global(|name)> newChecksum;
         fail
       end
       
@@ -958,7 +970,6 @@
   index-file-dependency-filter = ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
  
   do-adjust-index-lookup(|namespace, path, use, prefix) =
-    // UNDONE: try(origin-term);
     repeat-until(
       prim("SSL_EXT_get_parent", <id>)
     , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Wed May  2 23:35:15 2012	(r24773)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Thu May  3 09:13:24 2012	(r24774)
@@ -68,8 +68,10 @@
       |}
 
   /** @internal */
-  index-compilation-filter-file = 
-    ?(<id>, _); (is-test-file <+ index-is-fake-file <+ not(file-exists))
+  index-compilation-filter-file:
+    (file, subfile) -> (file, subfile)
+    where
+      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
     
 rules // On save handling
   

From gabrielkonat at gmail.com  Thu May  3 13:17:12 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 03 May 2012 11:17:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24775 - in
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main:
	java/org/spoofax/interpreter/library/language stratego/lib
Message-ID: <20120503111712.0B0FF108C003@mx3.tudelft.nl>

Author: gkonat
Date: Thu May  3 11:17:11 2012
New Revision: 24775
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24775&sc=1

Log:
Fixed ast-checksum not being stored.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java	Thu May  3 09:13:24 2012	(r24774)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/ISemanticIndex.java	Thu May  3 11:17:11 2012	(r24775)
@@ -48,13 +48,6 @@
 	 * @param fileDescriptor	The file to associate the entries with.
 	 */
 	public abstract void addAll(IStrategoList entries, SemanticIndexFileDescriptor fileDescriptor);
-
-	/**
-	 * Removes all entries that match given template.
-	 * 
-	 * @param template	The template to match entries against.
-	 */
-	//public abstract void remove(IStrategoAppl template);
 	
 	/**
 	 * Removes all entries that match given template and are from given file.

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May  3 09:13:24 2012	(r24774)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May  3 11:17:11 2012	(r24775)
@@ -188,12 +188,7 @@
 	      filesToAnalyze := []
       end
     with
-      if "" := subfile then
-        storePath := [full-path, "ast"]
-      else
-        storePath := [subfile, full-path, "ast"]
-      end;
-      <index-set-global(|storePath)> ast5
+      <index-set-global(|[<filepair-to-string> file, "ast"])> ast5
       
   /**
    * Identifies all definitions in the tree and annotates them with their URI.
@@ -451,14 +446,9 @@
    * @internal
    */
   analyze-astdiff(|ast):
-    (file, subfile) -> <id>
+    file -> <id>
     where
-      if "" := subfile then
-        name := [file, "ast-diff"]
-      else
-        name := [subfile, file, "ast-diff"]
-      end;
-      
+    	name := [<filepair-to-string> file, "ast-checksum"];
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
       	<index-set-global(|name)> newChecksum;

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Thu May  3 09:13:24 2012	(r24774)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Thu May  3 11:17:11 2012	(r24775)
@@ -432,6 +432,14 @@
       key := <collect-one(?_{_})> x
       
   uri-to-string = take-until(?Anon(_)); reverse; separate-by(|"."); concat-strings
+  
+  filepair-to-string:
+    (file, "") -> file
+    
+  filepair-to-string:
+    (file, subfile) -> <concat-strings> [file, "@", subfile]
+    where
+      not("" := subfile)
       
 /** @internal */
 rules // URI and value projections

From g.h.wachsmuth at tudelft.nl  Thu May  3 13:18:59 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 03 May 2012 11:18:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24776 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: editor lib syntax
	test trans
Message-ID: <20120503111859.D82C72B800F@mx2.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May  3 11:18:59 2012
New Revision: 24776
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24776&sc=1

Log:
generator for signature
generator for nam-get-definition-key and nam-get-definition rules

Added:
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/editor/NameDefinitionLanguage-Builders.esv	Thu May  3 11:18:59 2012	(r24776)
@@ -15,20 +15,8 @@
                                                                                                                           
   observer : editor-analyze                                                                                               
                                                                                                                           
-  builder  : "Generate Java code (for selection)"            = generate-java (openeditor) (realtime)                      
+  builder  : "Generate name analysis"            			 = generate-name-analysis (openeditor) (realtime)                      
   builder  : "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (meta) (source)     
   builder  : "Show analyzed abstract syntax (for selection)" = generate-analyzed (openeditor) (realtime) (meta) (source)  
-                                                                                                                          
-
-refactorings
-
-  pretty-print : pp-namedefinitionlanguage-string
-
-  refactoring ID : "Rename Entity" = rename-entity (source) (cursor)
-    shortcut : "org.eclipse.jdt.ui.edit.text.java.rename.element"
-    input
-      identifier : "new name" = ""
-
-  
-
+                                                                                                                         
   on save : index-on-save
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 11:18:59 2012	(r24776)
@@ -4,9 +4,6 @@
   constructors
     Module    : Namespace
     Namespace : Namespace
-    Module    : Namespace
-    Property  : Namespace
-    Type      : Namespace
 
 
 imports
@@ -31,62 +28,20 @@
     Namespace(x) -> <nam-get-def(|Namespace())> x
 
   nam-annotate-names(|def-path):
-    Naming(i_37126, j_37126, k_37126, l_37126) -> Naming(i_37126{def-path}, j_37126, k_37126, l_37126)
+    Naming(p_83299, q_83299, r_83299, s_83299) -> Naming(p_83299{def-path}, q_83299, r_83299, s_83299)
 
   nam-annotate-names(|def-path):
-    Import(h_37126) -> Import(<nam-annotate-use(|Module())> h_37126)
+    Import(o_83299) -> Import(<nam-annotate-use(|Module())> o_83299)
 
   nam-annotate-names(|def-path):
-    Namespace(g_37126) -> Namespace(g_37126{def-path})
+    Namespace(n_83299) -> Namespace(n_83299{def-path})
 
   nam-annotate-names(|def-path):
-    NsRef(f_37126) -> NsRef(<nam-annotate-use(|Namespace())> f_37126)
+    NsRef(m_83299) -> NsRef(<nam-annotate-use(|Namespace())> m_83299)
 
   nam-get-scope-types :
     Naming(_, _, _, _) -> [Namespace()]
 
-  nam-get-scope-types :
-    Module(_, _) -> [Type()]
-
-  nam-get-scope-types :
-    Entity(_, _) -> [Property()]
-
-  nam-get-scope-types :
-    Module(_, _) -> [Type()]
-
-  nam-get-scope-types :
-    Entity(_, _) -> [Property()]
-
-  nam-get-definition-key :
-    Module(x, _) -> x
-
-  nam-get-definition :
-    Module(x, _) -> <nam-get-def(|Module())> x
-
-  nam-get-definition-key :
-    Entity(x, _) -> x
-
-  nam-get-definition :
-    Entity(x, _) -> <nam-get-def(|Type())> x
-
-  nam-get-definition-key :
-    Property(x, _) -> x
-
-  nam-get-definition :
-    Property(x, _) -> <nam-get-def(|Property())> x
-
-  nam-annotate-names(|def-path):
-    Module(j_25143, k_25143) -> Module(j_25143{def-path}, k_25143)
-
-  nam-annotate-names(|def-path):
-    Entity(h_25143, i_25143) -> Entity(h_25143{def-path}, i_25143)
-
-  nam-annotate-names(|def-path):
-    Property(f_25143, g_25143) -> Property(f_25143{def-path}, g_25143)
-
-  nam-annotate-names(|def-path):
-    Type(e_25143) -> Type(<nam-annotate-use(|Type())> e_25143)
-
   nam-get-def(|n) =
     fail
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Thu May  3 11:18:59 2012	(r24776)
@@ -22,7 +22,7 @@
    NsRef                    -- _1,
    ND-Rule                  -- _1 KW[":"] _2,
    ND-Rule.2:iter           -- _1,
-   ND-Def                   -- KW["defines"] _1 _2 _3 _4 _5,
+   ND-Def                   -- KW["defines"] _1 _2 _3 _4,
    ND-Ref                   -- KW["refers"] KW["to"] _1 _2 _3 _4,
    ND-Scope                 -- _1 KW["scope"] KW["for"] _2 _3,
    ND-Type                  -- KW["has"] KW["type"] _1,

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Thu May  3 11:18:59 2012	(r24776)
@@ -16,7 +16,7 @@
 	
 	"module" Module@=ModName Imports Namespaces NamingRules -> NamingDefinition {"Naming", scope(Namespace)}
 	
-	"imports" ModuleRef+	-> Imports   {bracket}
+	"imports" ModuleRef*	-> Imports   {bracket}
 							-> Imports   {ast("[]")}
 	Module at ModName 			-> ModuleRef {"Import"}
 	
@@ -29,11 +29,11 @@
 							-> NamingRules {ast("[]")}
 	Term ":" NamingPart+ 	-> NamingRule  {"ND-Rule"}
 	
-	"defines" UniquePart NamespaceRef Term TypePart DefScopePart	-> NamingPart {"ND-Def"}
-	"refers" "to" NamespaceRef Term TypePart RefScopePart			-> NamingPart {"ND-Ref"}
-	OrderedPart "scope" "for" NamespaceRef IncludingPart			-> NamingPart {"ND-Scope"}
-	"has" "type" Term												-> NamingPart {"ND-Type"}
-	"where" Term Condition											-> NamingPart {"ND-Condition"}
+	"defines" NamespaceRef Term TypePart DefScopePart		-> NamingPart {"ND-Def"}
+	"refers" "to" NamespaceRef Term TypePart RefScopePart	-> NamingPart {"ND-Ref"}
+	OrderedPart "scope" "for" NamespaceRef IncludingPart	-> NamingPart {"ND-Scope"}
+	"has" "type" Term										-> NamingPart {"ND-Type"}
+	"where" Term Condition									-> NamingPart {"ND-Condition"}
 	
 	"has" "type" Term 								 	 	-> Condition {"TypeCheck"}
 	"refers" "to" NamespaceRef Term TypePart RefScopePart 	-> Condition {"ReferenceCheck"}
@@ -57,4 +57,7 @@
 	"overriding" NamespaceRef "in" Term	-> IncludingPart {"Overriding"}
 										-> IncludingPart {"None"}	
 	
+lexical syntax
+	
+	"namespaces" -> ModName {reject}
 	
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm	Thu May  3 11:18:59 2012	(r24776)
@@ -0,0 +1,171 @@
+Naming(
+  "example"
+, [Import("include/Entity")]
+, [Namespace("entity"), Namespace("property"), Namespace("variable"), Namespace("method")]
+, [ ND-Rule(
+      NoAnnoList(Op("Entity", [Var("name"), Wld()]))
+    , [ ND-Def(
+          NsRef("entity")
+        , Var("name")
+        , TypeBinding(Var("name"))
+        , None()
+        )
+      , ND-Scope(
+          Unordered()
+        , NsRef("property")
+        , Overriding(NsRef("property"), Var("super"))
+        )
+      , ND-Scope(
+          Unordered()
+        , NsRef("method")
+        , Overriding(NsRef("method"), Var("super"))
+        )
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(
+        Op("Entity", [Var("name"), Var("super"), Wld()])
+      )
+    , [ ND-Def(
+          NsRef("entity")
+        , Var("name")
+        , TypeBinding(Var("name"))
+        , None()
+        )
+      , ND-Ref(NsRef("entity"), Var("super"), None(), None())
+      , ND-Scope(
+          Unordered()
+        , NsRef("property")
+        , Overriding(NsRef("property"), Var("super"))
+        )
+      , ND-Scope(
+          Unordered()
+        , NsRef("method")
+        , Overriding(NsRef("method"), Var("super"))
+        )
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(Op("Property", [Var("x"), Var("t")]))
+    , [ND-Def(
+         NsRef("property")
+       , Var("x")
+       , TypeBinding(Var("t"))
+       , None()
+       )]
+    )
+  , ND-Rule(
+      NoAnnoList(Op("PropertyAccess", [Var("exp"), Var("f")]))
+    , [ ND-Ref(
+          NsRef("property")
+        , Var("f")
+        , None()
+        , RefScope(NsRef("entity"), Var("e"))
+        )
+      , ND-Condition(Var("exp"), TypeCheck(Var("e")))
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(
+        Op(
+          "For"
+        , [ Var("x")
+          , Var("t")
+          , Var("e")
+          , Var("f")
+          , Var(ListVar("elem*"))
+          ]
+        )
+      )
+    , [ ND-Def(
+          NsRef("variable")
+        , Var("x")
+        , TypeBinding(Var("t"))
+        , DefScope(Var(ListVar("elem*")))
+        )
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(
+        Op(
+          "VarDecl"
+        , [Var("x"), Var("t"), Var("e")]
+        )
+      )
+    , [ND-Def(
+         NsRef("variable")
+       , Var("x")
+       , TypeBinding(Var("t"))
+       , None()
+       )]
+    )
+  , ND-Rule(
+      NoAnnoList(Op("VarDecl", [Var("x"), Var("e")]))
+    , [ ND-Def(
+          NsRef("variable")
+        , Var("x")
+        , TypeBinding(Var("t"))
+        , None()
+        )
+      , ND-Condition(Var("e"), TypeCheck(Var("t")))
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(Op("Var", [Var("x")]))
+    , [ ND-Ref(NsRef("variable"), Var("x"), None(), None())
+      , ND-Ref(NsRef("property"), Var("x"), None(), None())
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(Op("Block", [Var(ListVar("statement*"))]))
+    , [ND-Scope(Ordered(), NsRef("variable"), None())]
+    )
+  , ND-Rule(
+      NoAnnoList(
+        Op(
+          "Method"
+        , [Var("f"), Var(ListVar("param*")), Var("t"), Wld()]
+        )
+      )
+    , [ ND-Def(
+          NsRef("method")
+        , NoAnnoList(
+            Op("m", [Var("f"), Var(ListVar("t*"))])
+          )
+        , TypeBinding(Var("t"))
+        , None()
+        )
+      , ND-Scope(Ordered(), NsRef("variable"), None())
+      , ND-Condition(Var(ListVar("param*")), TypeCheck(Var(ListVar("t*"))))
+      ]
+    )
+  , ND-Rule(
+      NoAnnoList(Op("Param", [Var("x"), Var("t")]))
+    , [ND-Def(
+         NsRef("variable")
+       , Var("x")
+       , TypeBinding(Var("t"))
+       , None()
+       )]
+    )
+  , ND-Rule(
+      NoAnnoList(
+        Op(
+          "MethodCall"
+        , [Var("exp"), Var("f"), Var(ListVar("e*"))]
+        )
+      )
+    , [ ND-Ref(
+          NsRef("method")
+        , NoAnnoList(
+            Op("m", [Var("f"), Var(ListVar("t*"))])
+          )
+        , None()
+        , RefScope(NsRef("entity"), Var("e"))
+        )
+      , ND-Condition(Var("exp"), TypeCheck(Var("e")))
+      , ND-Condition(Var(ListVar("e*")), TypeCheck(Var(ListVar("t*"))))
+      ]
+    )
+  ]
+)
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java	Thu May  3 11:18:59 2012	(r24776)
@@ -1,72 +0,0 @@
-package example;
-
-class User {
-    
-    private String name;
-    
-    public String get_name {
-        return name;
-    }
-    
-    public void set_name (String name) {
-        this.name = name;    
-    }
-    
-    private String password;
-    
-    public String get_password {
-        return password;
-    }
-    
-    public void set_password (String password) {
-        this.password = password;    
-    }
-    
-    private URL homepage;
-    
-    public URL get_homepage {
-        return homepage;
-    }
-    
-    public void set_homepage (URL homepage) {
-        this.homepage = homepage;    
-    }
-    
-}
-class BlogPosting {
-    
-    private User poster;
-    
-    public User get_poster {
-        return poster;
-    }
-    
-    public void set_poster (User poster) {
-        this.poster = poster;    
-    }
-    
-    private String body;
-    
-    public String get_body {
-        return body;
-    }
-    
-    public void set_body (String body) {
-        this.body = body;    
-    }
-    
-}
-class URL {
-    
-    private String location;
-    
-    public String get_location {
-        return location;
-    }
-    
-    public void set_location (String location) {
-        this.location = location;    
-    }
-    
-}
-

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd	Thu May  3 11:18:59 2012	(r24776)
@@ -1,5 +1,8 @@
 module example
 
+imports
+	include/Entity
+	
 namespaces
 
 	entity
@@ -15,7 +18,7 @@
 		scope for method overriding method in super
 		
 	Entity(name, super, _) :
-		defines entity name
+		defines entity name of type name
 		refers to entity super
 		scope for property overriding property in super
 		scope for method overriding method in super

Added: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 11:18:59 2012	(r24776)
@@ -0,0 +1,76 @@
+module example
+
+imports
+  lib/analysis-library.generated
+  include/Entity
+
+
+signature
+  constructors
+    entity   : Namespace
+    property : Namespace
+    variable : Namespace
+    method   : Namespace
+
+
+rules
+
+  nam-get-definition-key :
+    Entity(name, _) -> name
+
+  nam-get-definition :
+    Entity(name, _) -> <nam-get-def(|entity())> name
+
+
+rules
+
+  nam-get-definition-key :
+    Entity(name, super, _) -> name
+
+  nam-get-definition :
+    Entity(name, super, _) -> <nam-get-def(|entity())> name
+
+
+rules
+
+  nam-get-definition-key :
+    Property(x, t) -> x
+
+  nam-get-definition :
+    Property(x, t) -> <nam-get-def(|property())> x
+
+
+rules
+
+  nam-get-definition-key :
+    VarDecl(x, t, e) -> x
+
+  nam-get-definition :
+    VarDecl(x, t, e) -> <nam-get-def(|variable())> x
+
+
+rules
+
+  nam-get-definition-key :
+    VarDecl(x, e) -> x
+
+  nam-get-definition :
+    VarDecl(x, e) -> <nam-get-def(|variable())> x
+
+
+rules
+
+  nam-get-definition-key :
+    Method(f, param*, t, _) -> m(f, t*)
+
+  nam-get-definition :
+    Method(f, param*, t, _) -> <nam-get-def(|method())> m(f, t*)
+
+
+rules
+
+  nam-get-definition-key :
+    Param(x, t) -> x
+
+  nam-get-definition :
+    Param(x, t) -> <nam-get-def(|variable())> x
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/analysis-manual.str	Thu May  3 11:18:59 2012	(r24776)
@@ -8,6 +8,4 @@
 
 rules // Adjust lookup
 
-  // Add primitive types to type lookup.
-  adjust-index-lookup(target |namespace, path, prefix): 
-    Type(<target>) ->  [Def([Type(), "Int"]), Def([Type(), "String"]), [Type() | path]]
+ 
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/check.str	Thu May  3 11:18:59 2012	(r24776)
@@ -15,9 +15,8 @@
     
 rules // Duplicates
     
-  is-unique-namespace = ?Type()
-  is-unique-namespace = ?Property()
-      
+  is-unique-namespace = fail
+  
   constraint-error:
     definition -> (definition, $[Duplicate definition])
     where
@@ -25,14 +24,3 @@
       <is-unique-namespace> ns;
       definitions := <index-lookup-all> key;
       <gt> (<length> definitions, 1)
-    
-rules // Other
-  
-  constraint-warning:
-    Entity(x, _) -> (x, $[Entity names must start with a capital])
-    where
-      not(<string-starts-with-capital> x)
-  
-  constraint-note:
-    Module(x @ "example", _) -> (x, $[This is just an example program in the "entities" language
-                                      (this note is defined in trans/check.str) ])

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 11:18:59 2012	(r24776)
@@ -1,6 +1,7 @@
 module generate
 
 imports
+	libstrc
   libstratego-lib
   libstratego-gpp
   libstratego-aterm
@@ -10,53 +11,43 @@
 
 rules // Incremental code generation of project using compilation library.
       
-  index-compile-ast(|file, subfile, project-path):
-    ast -> None()
-    with
-      java := <to-java> ast;
-      full-path := <dirname> file;
-      filename := <guarantee-extension(|"java")> <base-filename> file;
-      writePath := $[[full-path]/];
-      writeFile :=  $[[writePath][filename]];
-      try(<mkdir> writePath);
-      <fclose> <fputs> (java, <fopen> (writeFile, "w"));
-      <debug> $[Compiling to [writeFile]]
-
-rules // Transformation to java strings.
-
-  to-java:
-    Module(x, d*) ->
-    $[ package [x];
-       
-       [d'*]
-     ]
-    with
-      d'* := <to-java> d*
-  
-  to-java:
-    Entity(x, p*) ->
-    $[ class [x] {
-           [p'*]
-       }
-     ]
-    with
-      p'* := <to-java> p*
-
-  to-java:
-    Property(x, Type(t)) -> $[
-      private [t] [x];
-      
-      public [t] get_[x] {
-          return [x];
-      }
-      
-      public void set_[x] ([t] [x]) {
-          this.[x] = [x];    
-      }
-  ]
-  
-  to-java:
-    Type(t) -> t
-
-  to-java:
-    t* -> <map(to-java)> t*
+	generate-name-analysis:
+		(selected, position, ast at Naming(name, _, _, _), path, project-path) -> (filename, result)
+		with
+			filename   := <guarantee-extension(|"str")> path ;
+			str-module := <to-analysis> ast ;
+			result     := <pp-stratego-string> str-module
+
+rules
+	
+	to-analysis:
+		Naming(name, import*, namespace*, rule*) -> Module(name, [imports, sig | <filter(to-rules)> rule*])
+		where
+			imports := Imports([Import("lib/analysis-library.generated") | import*]) ;
+			sig     := Signature([Constructors(<map(to-opdecl)> namespace*)])
+			
+	to-opdecl:
+		Namespace(ns) -> OpDecl(ns, ConstType(SortNoArgs("Namespace")))
+		
+	to-rules:
+		ND-Rule(term, part*) -> Rules(<flatten-list ; not(?[])> [definition-rules])
+		where
+			definition-rules := <filter(to-definition-rules(|term))> part*
+			
+	to-definition-rules(|term):
+		ND-Def(NsRef(namespace), name, _, None()) ->
+		[ RDefNoArgs(
+			"nam-get-definition-key"
+			, RuleNoCond(term, name)
+			)
+		, RDefNoArgs(
+			"nam-get-definition"
+			, RuleNoCond(
+				term
+				, App(
+					CallT(SVar("nam-get-def"), [], [NoAnnoList(Op(namespace, []))])
+					, name
+					)
+				)
+			)
+		]
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str	Thu May  3 11:17:11 2012	(r24775)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/namedefinitionlanguage.str	Thu May  3 11:18:59 2012	(r24776)
@@ -25,16 +25,9 @@
       editor-init;
       ast'     := <analyze-top>;
       errors   := <collect-all(constraint-error, conc)> ast';
-      warnings := <collect-all(constraint-warning, conc)> ast';
-      notes    := <collect-all(constraint-note, conc)> ast'
-  
-  // Transforms a selection to Java
-  generate-java:
-    (selected, position, ast, path, project-path) -> (filename, result)
-    with
-      filename := <guarantee-extension(|"java")> path;
-      result   := <to-java> selected
-  
+      warnings := <collect-all(fail, conc)> ast';
+      notes    := <collect-all(fail, conc)> ast'
+    
   // Prints the abstract syntax ATerm of a selection.
   generate-aterm:
     (selected, position, ast, path, project-path) -> (filename, result)

From gabrielkonat at gmail.com  Thu May  3 14:19:32 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 03 May 2012 12:19:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24777 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans
	spoofax-contrib/se...
Message-ID: <20120503121932.4184D7F8055@mx1.tudelft.nl>

Author: gkonat
Date: Thu May  3 12:19:31 2012
New Revision: 24777
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24777&sc=1

Log:
Fixed wrong ast in analyze-top & some cleanup.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Thu May  3 11:18:59 2012	(r24776)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Thu May  3 12:19:31 2012	(r24777)
@@ -39,7 +39,7 @@
     (ast, path, project-path) -> (ast', errors, warnings, notes)
     with
       editor-init;
-      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
       <try(editor-queue-analysis)> filesToAnalyze
       
   // Main entry point for analyzes, called when multiple (changed) files have changed. 

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Thu May  3 11:18:59 2012	(r24776)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Thu May  3 12:19:31 2012	(r24777)
@@ -39,7 +39,7 @@
     with
       editor-init;
       (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
-      <editor-queue-analysis> filesToAnalyze
+      <try(editor-queue-analysis)> filesToAnalyze
       
   // Main entry point for analyzes, called when multiple (changed) files have changed. 
   editor-analyze:
@@ -63,7 +63,7 @@
       <trigger-commit-and-compile> <language>
       
   // Queue parallel analysis for given list of files.
-  editor-queue-analysis = queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+  editor-queue-analysis = not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
       
   // Executes parallel analysis using the index library.
   editor-parallel-analyze:

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Thu May  3 11:18:59 2012	(r24776)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Thu May  3 12:19:31 2012	(r24777)
@@ -39,8 +39,8 @@
     (ast, path, project-path) -> (ast', errors, warnings, notes)
     with
       editor-init;
-      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
-      <editor-queue-analysis> filesToAnalyze
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
+      <try(editor-queue-analysis)> filesToAnalyze
       
   // Main entry point for analyzes, called when multiple (changed) files have changed. 
   editor-analyze:
@@ -58,13 +58,13 @@
       
   // Called when current file is saved.
   editor-save:
-    (ast, _, _, _, _) -> None()
+    (_, _, _, _, _) -> None()
     with
       index-setup(|<language>, [<project-path>], ".");
       <trigger-commit-and-compile> <language>
       
   // Queue parallel analysis for given list of files.
-  editor-queue-analysis = queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+  editor-queue-analysis = not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
       
   // Executes parallel analysis using the index library.
   editor-parallel-analyze:

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str	Thu May  3 11:18:59 2012	(r24776)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str	Thu May  3 12:19:31 2012	(r24777)
@@ -15,7 +15,7 @@
   testgen-internal-file = !"/.internal/testgen"
   testgen-module-name = !"TestGen"
   
-  testgen-num-files = !250
+  testgen-num-files = !150
   
   testgen-min-entities = !1
   testgen-max-entities = !5

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May  3 11:18:59 2012	(r24776)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May  3 12:19:31 2012	(r24777)
@@ -78,7 +78,7 @@
    * @see analyze-top(|phase, language)
    */
   analyze-top(|language):
-    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)>
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
    
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Thu May  3 11:18:59 2012	(r24776)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Thu May  3 12:19:31 2012	(r24777)
@@ -106,11 +106,8 @@
    * Commits index to a file on disk.
    */
   index-commit = 
-    if not(index-timestamp-get-updates(|"LANG_index_commit") => []) then
-      prim("LANG_index_commit");
-      index-timestamp-set-updated(|"LANG_index_commit")
-    end
-    
+    prim("LANG_index_commit")
+
   /**
    * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
    * until index-end-transaction is called.
@@ -359,26 +356,6 @@
     _ -> <id>
     where
       <indexlib-get> Global(<index-boolean-globals-uri> name)
- 
-  /**
-   * Updates the "last updated" timestamp for the given service name.
-   *
-   * @see index-get-changes-since-timestamp(|service)
-   */
-  index-timestamp-set-updated(|service) =
-    file := $[/.internal/timestamps/[service]];
-    <index-clear-file> file;
-    prim("LANG_index_add", DefData([Timestamp(), "timestamps", ".internal"], Timestamp(), []), file)
-   
-  /**
-   * Gets all files with changes since the last time stamp update for the given service name.
-   */
-  index-timestamp-get-updates(|service):
-    _ -> files'
-    with
-      timestampName := $[/.internal/timestamps/[service]];
-      files := <prim("LANG_index_get_files_newer_than", timestampName)>;
-      files' := <remove-all(?(timestampName, _))> files
 
   /**
    * Queries if given index file is a 'fake' file for storing internal data.

From g.h.wachsmuth at tudelft.nl  Thu May  3 14:54:53 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 03 May 2012 12:54:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24778 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: lib syntax test trans
Message-ID: <20120503125453.C7778108C042@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May  3 12:54:52 2012
New Revision: 24778
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24778&sc=1

Log:
generator for adjust-def-data rules storing types of declarations

Added:
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 12:19:31 2012	(r24777)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 12:54:52 2012	(r24778)
@@ -28,16 +28,16 @@
     Namespace(x) -> <nam-get-def(|Namespace())> x
 
   nam-annotate-names(|def-path):
-    Naming(p_83299, q_83299, r_83299, s_83299) -> Naming(p_83299{def-path}, q_83299, r_83299, s_83299)
+    Naming(m_168113, n_168113, o_168113, p_168113) -> Naming(m_168113{def-path}, n_168113, o_168113, p_168113)
 
   nam-annotate-names(|def-path):
-    Import(o_83299) -> Import(<nam-annotate-use(|Module())> o_83299)
+    Import(l_168113) -> Import(<nam-annotate-use(|Module())> l_168113)
 
   nam-annotate-names(|def-path):
-    Namespace(n_83299) -> Namespace(n_83299{def-path})
+    Namespace(k_168113) -> Namespace(k_168113{def-path})
 
   nam-annotate-names(|def-path):
-    NsRef(m_83299) -> NsRef(<nam-annotate-use(|Namespace())> m_83299)
+    NsRef(j_168113) -> NsRef(<nam-annotate-use(|Namespace())> j_168113)
 
   nam-get-scope-types :
     Naming(_, _, _, _) -> [Namespace()]

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Thu May  3 12:19:31 2012	(r24777)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Thu May  3 12:54:52 2012	(r24778)
@@ -20,13 +20,14 @@
    Import                   -- _1,
    Namespace                -- _1,
    NsRef                    -- _1,
-   ND-Rule                  -- _1 KW[":"] _2,
+   ND-Rule                  -- _1 KW[":"] _2 _3,
    ND-Rule.2:iter           -- _1,
+   ND-Rule.3:iter-star      -- _1,
    ND-Def                   -- KW["defines"] _1 _2 _3 _4,
    ND-Ref                   -- KW["refers"] KW["to"] _1 _2 _3 _4,
    ND-Scope                 -- _1 KW["scope"] KW["for"] _2 _3,
    ND-Type                  -- KW["has"] KW["type"] _1,
-   ND-Condition             -- KW["where"] _1 _2,
+   Where                    -- KW["where"] _1 _2,
    TypeCheck                -- KW["has"] KW["type"] _1,
    ReferenceCheck           -- KW["refers"] KW["to"] _1 _2 _3 _4,
    Unique                   -- KW["unique"],

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Thu May  3 12:19:31 2012	(r24777)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Thu May  3 12:54:52 2012	(r24778)
@@ -25,16 +25,16 @@
 	Namespace@=Id			-> Namespace    {"Namespace"}
 	Namespace at Id 			-> NamespaceRef {"NsRef"}
 	
-	"rules" NamingRule* 	-> NamingRules {bracket}
-							-> NamingRules {ast("[]")}
-	Term ":" NamingPart+ 	-> NamingRule  {"ND-Rule"}
+	"rules" NamingRule* 				-> NamingRules {bracket}
+										-> NamingRules {ast("[]")}
+	Term ":" NamingPart+ WhereClause*	-> NamingRule  {"ND-Rule"}
 	
 	"defines" NamespaceRef Term TypePart DefScopePart		-> NamingPart {"ND-Def"}
 	"refers" "to" NamespaceRef Term TypePart RefScopePart	-> NamingPart {"ND-Ref"}
 	OrderedPart "scope" "for" NamespaceRef IncludingPart	-> NamingPart {"ND-Scope"}
 	"has" "type" Term										-> NamingPart {"ND-Type"}
-	"where" Term Condition									-> NamingPart {"ND-Condition"}
 	
+	"where" Term Condition 									-> WhereClause {"Where"}
 	"has" "type" Term 								 	 	-> Condition {"TypeCheck"}
 	"refers" "to" NamespaceRef Term TypePart RefScopePart 	-> Condition {"ReferenceCheck"}
 	

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm	Thu May  3 12:19:31 2012	(r24777)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm	Thu May  3 12:54:52 2012	(r24778)
@@ -1,171 +1,10 @@
-Naming(
-  "example"
-, [Import("include/Entity")]
-, [Namespace("entity"), Namespace("property"), Namespace("variable"), Namespace("method")]
-, [ ND-Rule(
-      NoAnnoList(Op("Entity", [Var("name"), Wld()]))
-    , [ ND-Def(
-          NsRef("entity")
-        , Var("name")
-        , TypeBinding(Var("name"))
-        , None()
-        )
-      , ND-Scope(
-          Unordered()
-        , NsRef("property")
-        , Overriding(NsRef("property"), Var("super"))
-        )
-      , ND-Scope(
-          Unordered()
-        , NsRef("method")
-        , Overriding(NsRef("method"), Var("super"))
-        )
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(
-        Op("Entity", [Var("name"), Var("super"), Wld()])
-      )
-    , [ ND-Def(
-          NsRef("entity")
-        , Var("name")
-        , TypeBinding(Var("name"))
-        , None()
-        )
-      , ND-Ref(NsRef("entity"), Var("super"), None(), None())
-      , ND-Scope(
-          Unordered()
-        , NsRef("property")
-        , Overriding(NsRef("property"), Var("super"))
-        )
-      , ND-Scope(
-          Unordered()
-        , NsRef("method")
-        , Overriding(NsRef("method"), Var("super"))
-        )
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(Op("Property", [Var("x"), Var("t")]))
-    , [ND-Def(
-         NsRef("property")
-       , Var("x")
-       , TypeBinding(Var("t"))
-       , None()
-       )]
-    )
-  , ND-Rule(
-      NoAnnoList(Op("PropertyAccess", [Var("exp"), Var("f")]))
-    , [ ND-Ref(
-          NsRef("property")
-        , Var("f")
-        , None()
-        , RefScope(NsRef("entity"), Var("e"))
-        )
-      , ND-Condition(Var("exp"), TypeCheck(Var("e")))
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(
-        Op(
-          "For"
-        , [ Var("x")
-          , Var("t")
-          , Var("e")
-          , Var("f")
-          , Var(ListVar("elem*"))
-          ]
-        )
-      )
-    , [ ND-Def(
-          NsRef("variable")
-        , Var("x")
-        , TypeBinding(Var("t"))
-        , DefScope(Var(ListVar("elem*")))
-        )
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(
-        Op(
-          "VarDecl"
-        , [Var("x"), Var("t"), Var("e")]
-        )
-      )
-    , [ND-Def(
-         NsRef("variable")
-       , Var("x")
-       , TypeBinding(Var("t"))
-       , None()
-       )]
-    )
-  , ND-Rule(
-      NoAnnoList(Op("VarDecl", [Var("x"), Var("e")]))
-    , [ ND-Def(
-          NsRef("variable")
-        , Var("x")
-        , TypeBinding(Var("t"))
-        , None()
-        )
-      , ND-Condition(Var("e"), TypeCheck(Var("t")))
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(Op("Var", [Var("x")]))
-    , [ ND-Ref(NsRef("variable"), Var("x"), None(), None())
-      , ND-Ref(NsRef("property"), Var("x"), None(), None())
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(Op("Block", [Var(ListVar("statement*"))]))
-    , [ND-Scope(Ordered(), NsRef("variable"), None())]
-    )
-  , ND-Rule(
-      NoAnnoList(
-        Op(
-          "Method"
-        , [Var("f"), Var(ListVar("param*")), Var("t"), Wld()]
-        )
-      )
-    , [ ND-Def(
-          NsRef("method")
-        , NoAnnoList(
-            Op("m", [Var("f"), Var(ListVar("t*"))])
-          )
-        , TypeBinding(Var("t"))
-        , None()
-        )
-      , ND-Scope(Ordered(), NsRef("variable"), None())
-      , ND-Condition(Var(ListVar("param*")), TypeCheck(Var(ListVar("t*"))))
-      ]
-    )
-  , ND-Rule(
-      NoAnnoList(Op("Param", [Var("x"), Var("t")]))
-    , [ND-Def(
-         NsRef("variable")
-       , Var("x")
-       , TypeBinding(Var("t"))
-       , None()
-       )]
-    )
-  , ND-Rule(
-      NoAnnoList(
-        Op(
-          "MethodCall"
-        , [Var("exp"), Var("f"), Var(ListVar("e*"))]
-        )
-      )
-    , [ ND-Ref(
-          NsRef("method")
-        , NoAnnoList(
-            Op("m", [Var("f"), Var(ListVar("t*"))])
-          )
-        , None()
-        , RefScope(NsRef("entity"), Var("e"))
-        )
-      , ND-Condition(Var("exp"), TypeCheck(Var("e")))
-      , ND-Condition(Var(ListVar("e*")), TypeCheck(Var(ListVar("t*"))))
-      ]
-    )
-  ]
+ND-Rule(
+  NoAnnoList(Op("VarDecl", [Var("x"), Var("e")]))
+, [ND-Def(
+     NsRef("variable")
+   , Var("x")
+   , TypeBinding(Var("t"))
+   , None()
+   )]
+, [Where(Var("e"), TypeCheck(Var("t")))]
 )
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 12:19:31 2012	(r24777)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 12:54:52 2012	(r24778)
@@ -21,6 +21,9 @@
   nam-get-definition :
     Entity(name, _) -> <nam-get-def(|entity())> name
 
+  adjust-index-def-data(store|namespace, path):
+    Entity(name, _) -> <store> DefData(path, Type(), name)
+
 
 rules
 
@@ -30,6 +33,9 @@
   nam-get-definition :
     Entity(name, super, _) -> <nam-get-def(|entity())> name
 
+  adjust-index-def-data(store|namespace, path):
+    Entity(name, super, _) -> <store> DefData(path, Type(), name)
+
 
 rules
 
@@ -39,6 +45,15 @@
   nam-get-definition :
     Property(x, t) -> <nam-get-def(|property())> x
 
+  adjust-index-def-data(store|namespace, path):
+    Property(x, t) -> <store> DefData(path, Type(), t)
+
+
+rules
+
+  adjust-index-def-data(store|namespace, path):
+    For(x, t, e, f, elem*) -> <store> DefData(path, Type(), t)
+
 
 rules
 
@@ -48,23 +63,38 @@
   nam-get-definition :
     VarDecl(x, t, e) -> <nam-get-def(|variable())> x
 
+  adjust-index-def-data(store|namespace, path):
+    VarDecl(x, t, e) -> <store> DefData(path, Type(), t)
+
 
 rules
 
   nam-get-definition-key :
     VarDecl(x, e) -> x
+    where t := <type-of> e
 
   nam-get-definition :
     VarDecl(x, e) -> <nam-get-def(|variable())> x
+    where t := <type-of> e
+
+  adjust-index-def-data(store|namespace, path):
+    VarDecl(x, e) -> <store> DefData(path, Type(), t)
+    where t := <type-of> e
 
 
 rules
 
   nam-get-definition-key :
     Method(f, param*, t, _) -> m(f, t*)
+    where t* := <type-of> param*
 
   nam-get-definition :
     Method(f, param*, t, _) -> <nam-get-def(|method())> m(f, t*)
+    where t* := <type-of> param*
+
+  adjust-index-def-data(store|namespace, path):
+    Method(f, param*, t, _) -> <store> DefData(path, Type(), t)
+    where t* := <type-of> param*
 
 
 rules
@@ -73,4 +103,7 @@
     Param(x, t) -> x
 
   nam-get-definition :
-    Param(x, t) -> <nam-get-def(|variable())> x
\ No newline at end of file
+    Param(x, t) -> <nam-get-def(|variable())> x
+
+  adjust-index-def-data(store|namespace, path):
+    Param(x, t) -> <store> DefData(path, Type(), t)
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm	Thu May  3 12:54:52 2012	(r24778)
@@ -0,0 +1 @@
+WhereClause(Assign(Var("a"), Var("b")))
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 12:19:31 2012	(r24777)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 12:54:52 2012	(r24778)
@@ -18,36 +18,65 @@
 			str-module := <to-analysis> ast ;
 			result     := <pp-stratego-string> str-module
 
+overlays
+	
+	TYPE_OP_DECL = OpDecl("Type", ConstType(SortNoArgs("DefDataKind")))
+	
 rules
 	
 	to-analysis:
 		Naming(name, import*, namespace*, rule*) -> Module(name, [imports, sig | <filter(to-rules)> rule*])
 		where
 			imports := Imports([Import("lib/analysis-library.generated") | import*]) ;
-			sig     := Signature([Constructors(<map(to-opdecl)> namespace*)])
+			sig     := Signature([Constructors([TYPE_OP_DECL|<map(to-opdecl)> namespace*])])
 			
 	to-opdecl:
 		Namespace(ns) -> OpDecl(ns, ConstType(SortNoArgs("Namespace")))
 		
 	to-rules:
-		ND-Rule(term, part*) -> Rules(<flatten-list ; not(?[])> [definition-rules])
+		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [definition-rule*, type-rule*])
 		where
-			definition-rules := <filter(to-definition-rules(|term))> part*
-			
-	to-definition-rules(|term):
+			clause*          := <filter(to-clauses)> cond* ; 
+			definition-rule* := <filter(to-definition-rules(|term, clause*))> part* ;
+			type-rule*		 := <filter(to-type-rules(|term, clause*))> part*
+	
+	to-clauses:
+		Where(term, TypeCheck(type)) -> WhereClause(Assign(type, App(CallT(SVar("type-of"), [], []), term)))
+		
+	to-definition-rules(|term, clause*):
 		ND-Def(NsRef(namespace), name, _, None()) ->
 		[ RDefNoArgs(
-			"nam-get-definition-key"
-			, RuleNoCond(term, name)
+			  "nam-get-definition-key"
+			, Rule(term, name, clause*)
 			)
 		, RDefNoArgs(
-			"nam-get-definition"
-			, RuleNoCond(
+			  "nam-get-definition"
+			, Rule(
 				term
 				, App(
 					CallT(SVar("nam-get-def"), [], [NoAnnoList(Op(namespace, []))])
 					, name
 					)
+				, clause*
 				)
 			)
-		]
\ No newline at end of file
+		]
+		
+	to-type-rules(|term, clause*):
+		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> 
+		RDefT(
+			  "adjust-index-def-data"
+			, [DefaultVarDec("store")]
+			, [DefaultVarDec("namespace"), DefaultVarDec("path")]
+			, Rule(
+			  	  term
+			  	, App(
+					  CallNoArgs(SVar("store"))
+					, NoAnnoList(Op("DefData", [Var("path"), NoAnnoList(Op("Type", [])), type]))
+					)
+				, clause*
+				)
+      		)
+
+		
+	
\ No newline at end of file

From gabrielkonat at gmail.com  Thu May  3 16:35:21 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 03 May 2012 14:35:21 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24779 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language
Message-ID: <20120503143521.6F11D108C003@mx3.tudelft.nl>

Author: gkonat
Date: Thu May  3 14:35:19 2012
New Revision: 24779
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24779&sc=1

Log:


Added:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TemplateWithFileDescriptor.java

Added: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TemplateWithFileDescriptor.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TemplateWithFileDescriptor.java	Thu May  3 14:35:19 2012	(r24779)
@@ -0,0 +1,21 @@
+package org.spoofax.interpreter.library.language;
+
+import org.spoofax.interpreter.terms.IStrategoAppl;
+
+public class TemplateWithFileDescriptor {
+	private final IStrategoAppl template;
+	private final SemanticIndexFileDescriptor fileDescriptor;
+	
+	public TemplateWithFileDescriptor(IStrategoAppl template, SemanticIndexFileDescriptor fileDescriptor) {
+		this.template = template;
+		this.fileDescriptor = fileDescriptor;
+	}
+	
+	public IStrategoAppl getTemplate() {
+		return template;
+	}
+	
+	public SemanticIndexFileDescriptor getFileDescriptor() {
+		return fileDescriptor;
+	}
+}

From g.h.wachsmuth at tudelft.nl  Thu May  3 17:48:36 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 03 May 2012 15:48:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24780 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: lib test trans
Message-ID: <20120503154836.DDCDB108C004@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May  3 15:48:36 2012
New Revision: 24780
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24780&sc=1

Log:
generator for nam-annotate-names rules

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 14:35:19 2012	(r24779)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 15:48:36 2012	(r24780)
@@ -28,16 +28,16 @@
     Namespace(x) -> <nam-get-def(|Namespace())> x
 
   nam-annotate-names(|def-path):
-    Naming(m_168113, n_168113, o_168113, p_168113) -> Naming(m_168113{def-path}, n_168113, o_168113, p_168113)
+    Naming(f_338569, g_338569, h_338569, i_338569) -> Naming(f_338569{def-path}, g_338569, h_338569, i_338569)
 
   nam-annotate-names(|def-path):
-    Import(l_168113) -> Import(<nam-annotate-use(|Module())> l_168113)
+    Import(e_338569) -> Import(<nam-annotate-use(|Module())> e_338569)
 
   nam-annotate-names(|def-path):
-    Namespace(k_168113) -> Namespace(k_168113{def-path})
+    Namespace(d_338569) -> Namespace(d_338569{def-path})
 
   nam-annotate-names(|def-path):
-    NsRef(j_168113) -> NsRef(<nam-annotate-use(|Namespace())> j_168113)
+    NsRef(c_338569) -> NsRef(<nam-annotate-use(|Namespace())> c_338569)
 
   nam-get-scope-types :
     Naming(_, _, _, _) -> [Namespace()]

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm	Thu May  3 14:35:19 2012	(r24779)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm	Thu May  3 15:48:36 2012	(r24780)
@@ -1,10 +1,21 @@
 ND-Rule(
-  NoAnnoList(Op("VarDecl", [Var("x"), Var("e")]))
-, [ND-Def(
-     NsRef("variable")
-   , Var("x")
-   , TypeBinding(Var("t"))
-   , None()
-   )]
-, [Where(Var("e"), TypeCheck(Var("t")))]
+  NoAnnoList(Op("Entity", [Var("name"), Wld()]))
+, [ ND-Def(
+      NsRef("entity")
+    , Var("name")
+    , TypeBinding(Var("name"))
+    , None()
+    )
+  , ND-Scope(
+      Unordered()
+    , NsRef("property")
+    , Overriding(NsRef("property"), Var("super"))
+    )
+  , ND-Scope(
+      Unordered()
+    , NsRef("method")
+    , Overriding(NsRef("method"), Var("super"))
+    )
+  ]
+, []
 )
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 14:35:19 2012	(r24779)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 15:48:36 2012	(r24780)
@@ -1,12 +1,14 @@
 module example
 
 imports
+  lib/index-library.generated
   lib/analysis-library.generated
   include/Entity
 
 
 signature
   constructors
+    Type     : DefDataKind
     entity   : Namespace
     property : Namespace
     variable : Namespace
@@ -21,6 +23,9 @@
   nam-get-definition :
     Entity(name, _) -> <nam-get-def(|entity())> name
 
+  nam-annotate-names(|path) =
+    Entity(nam-annotate-def(|path), id)
+
   adjust-index-def-data(store|namespace, path):
     Entity(name, _) -> <store> DefData(path, Type(), name)
 
@@ -33,6 +38,13 @@
   nam-get-definition :
     Entity(name, super, _) -> <nam-get-def(|entity())> name
 
+  nam-annotate-names(|path) =
+    Entity(
+      nam-annotate-def(|path)
+    , nam-annotate-use(|entity())
+    , id
+    )
+
   adjust-index-def-data(store|namespace, path):
     Entity(name, super, _) -> <store> DefData(path, Type(), name)
 
@@ -45,6 +57,9 @@
   nam-get-definition :
     Property(x, t) -> <nam-get-def(|property())> x
 
+  nam-annotate-names(|path) =
+    Property(nam-annotate-def(|path), id)
+
   adjust-index-def-data(store|namespace, path):
     Property(x, t) -> <store> DefData(path, Type(), t)
 
@@ -63,6 +78,9 @@
   nam-get-definition :
     VarDecl(x, t, e) -> <nam-get-def(|variable())> x
 
+  nam-annotate-names(|path) =
+    VarDecl(nam-annotate-def(|path), id, id)
+
   adjust-index-def-data(store|namespace, path):
     VarDecl(x, t, e) -> <store> DefData(path, Type(), t)
 
@@ -77,6 +95,9 @@
     VarDecl(x, e) -> <nam-get-def(|variable())> x
     where t := <type-of> e
 
+  nam-annotate-names(|path) =
+    VarDecl(nam-annotate-def(|path), id)
+
   adjust-index-def-data(store|namespace, path):
     VarDecl(x, e) -> <store> DefData(path, Type(), t)
     where t := <type-of> e
@@ -84,6 +105,12 @@
 
 rules
 
+  nam-annotate-names(|path) =
+    Var(nam-annotate-use(|variable()))
+
+
+rules
+
   nam-get-definition-key :
     Method(f, param*, t, _) -> m(f, t*)
     where t* := <type-of> param*
@@ -92,6 +119,9 @@
     Method(f, param*, t, _) -> <nam-get-def(|method())> m(f, t*)
     where t* := <type-of> param*
 
+  nam-annotate-names(|path) =
+    Method(id, id, id, id)
+
   adjust-index-def-data(store|namespace, path):
     Method(f, param*, t, _) -> <store> DefData(path, Type(), t)
     where t* := <type-of> param*
@@ -105,5 +135,8 @@
   nam-get-definition :
     Param(x, t) -> <nam-get-def(|variable())> x
 
+  nam-annotate-names(|path) =
+    Param(nam-annotate-def(|path), id)
+
   adjust-index-def-data(store|namespace, path):
     Param(x, t) -> <store> DefData(path, Type(), t)
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm	Thu May  3 14:35:19 2012	(r24779)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm	Thu May  3 15:48:36 2012	(r24780)
@@ -1 +1,9 @@
-WhereClause(Assign(Var("a"), Var("b")))
\ No newline at end of file
+SDefT(
+  "foo"
+, []
+, [DefaultVarDec("path")]
+, Call(
+    SVar("Module")
+  , [Id(), CallT(SVar("nam-annotate-def"), [], [Var("path")])]
+  )
+)
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 14:35:19 2012	(r24779)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 15:48:36 2012	(r24780)
@@ -20,25 +20,43 @@
 
 overlays
 	
+	ANALYSIS_LIB = Import("lib/analysis-library.generated")
+	INDEX_LIB    = Import("lib/index-library.generated")
+	
 	TYPE_OP_DECL = OpDecl("Type", ConstType(SortNoArgs("DefDataKind")))
 	
+	ADJUST_DATA(term, kind, data, clauses) = 
+		RDefT(
+			  "adjust-index-def-data"
+			, [DefaultVarDec("store")]
+			, [DefaultVarDec("namespace"), DefaultVarDec("path")]
+			, Rule(
+			  	  term
+			  	, App(
+					  CallNoArgs(SVar("store"))
+					, NoAnnoList(Op("DefData", [Var("path"), NoAnnoList(Op(kind, [])), data]))
+					)
+				, clauses
+				)
+      		)
 rules
 	
 	to-analysis:
 		Naming(name, import*, namespace*, rule*) -> Module(name, [imports, sig | <filter(to-rules)> rule*])
 		where
-			imports := Imports([Import("lib/analysis-library.generated") | import*]) ;
+			imports := Imports([ INDEX_LIB, ANALYSIS_LIB | import*]) ;
 			sig     := Signature([Constructors([TYPE_OP_DECL|<map(to-opdecl)> namespace*])])
 			
 	to-opdecl:
 		Namespace(ns) -> OpDecl(ns, ConstType(SortNoArgs("Namespace")))
 		
 	to-rules:
-		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [definition-rule*, type-rule*])
+		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [definition-rule*, annotate-rule*, type-rule*])
 		where
 			clause*          := <filter(to-clauses)> cond* ; 
 			definition-rule* := <filter(to-definition-rules(|term, clause*))> part* ;
-			type-rule*		 := <filter(to-type-rules(|term, clause*))> part*
+			annotate-rule*   := <to-annotate-rules(|term, clause*) <+ ![]> part* ;
+			type-rule*       := <filter(to-type-rules(|term, clause*))> part*
 	
 	to-clauses:
 		Where(term, TypeCheck(type)) -> WhereClause(Assign(type, App(CallT(SVar("type-of"), [], []), term)))
@@ -61,22 +79,31 @@
 				)
 			)
 		]
+
+	to-annotate-rules(|term, clause*):
+		part* -> result
+		where
+			replacement* := <filter(to-annotate-replacement)> part* ;
+			if <?[]> replacement* then
+				result := [] 
+			else
+				result := [SDefT("nam-annotate-names", [], [DefaultVarDec("path")], <alltd(replace(|replacement*) <+ introduce-id)> term)]
+			end
 		
+	to-annotate-replacement:
+		ND-Def(_, name, _, None())-> (name, CallT(SVar("nam-annotate-def"), [], [Var("path")]))
+			
+	to-annotate-replacement:
+		ND-Ref(NsRef(namespace), name, _, None()) -> (name, CallT(SVar("nam-annotate-use"), [], [NoAnnoList(Op(namespace, []))]))
+			
+	replace(|replacement*): t1 -> t2 where <fetch-elem(?(t1, t2))> replacement*
+	
+	introduce-id: Wld()  -> Id()
+	introduce-id: Var(_) -> Id()
+	
 	to-type-rules(|term, clause*):
-		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> 
-		RDefT(
-			  "adjust-index-def-data"
-			, [DefaultVarDec("store")]
-			, [DefaultVarDec("namespace"), DefaultVarDec("path")]
-			, Rule(
-			  	  term
-			  	, App(
-					  CallNoArgs(SVar("store"))
-					, NoAnnoList(Op("DefData", [Var("path"), NoAnnoList(Op("Type", [])), type]))
-					)
-				, clause*
-				)
-      		)
+		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> ADJUST_DATA(term, "Type", type, clause*)
+		
 
 		
 	
\ No newline at end of file

From g.h.wachsmuth at tudelft.nl  Thu May  3 18:40:33 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 03 May 2012 16:40:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24781 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: lib test trans
Message-ID: <20120503164033.86271CC17C@mx4.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May  3 16:40:31 2012
New Revision: 24781
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24781&sc=1

Log:
generator for type-of rules

Deleted:
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.analyzed.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.aterm
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.java
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.aterm
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 15:48:36 2012	(r24780)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 16:40:31 2012	(r24781)
@@ -28,16 +28,16 @@
     Namespace(x) -> <nam-get-def(|Namespace())> x
 
   nam-annotate-names(|def-path):
-    Naming(f_338569, g_338569, h_338569, i_338569) -> Naming(f_338569{def-path}, g_338569, h_338569, i_338569)
+    Naming(m_384168, n_384168, o_384168, p_384168) -> Naming(m_384168{def-path}, n_384168, o_384168, p_384168)
 
   nam-annotate-names(|def-path):
-    Import(e_338569) -> Import(<nam-annotate-use(|Module())> e_338569)
+    Import(l_384168) -> Import(<nam-annotate-use(|Module())> l_384168)
 
   nam-annotate-names(|def-path):
-    Namespace(d_338569) -> Namespace(d_338569{def-path})
+    Namespace(k_384168) -> Namespace(k_384168{def-path})
 
   nam-annotate-names(|def-path):
-    NsRef(c_338569) -> NsRef(<nam-annotate-use(|Namespace())> c_338569)
+    NsRef(j_384168) -> NsRef(<nam-annotate-use(|Namespace())> j_384168)
 
   nam-get-scope-types :
     Naming(_, _, _, _) -> [Namespace()]

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd	Thu May  3 15:48:36 2012	(r24780)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.nd	Thu May  3 16:40:31 2012	(r24781)
@@ -41,8 +41,8 @@
 		where e has type t
 
 	Var(x) :
-		refers to variable x // implies has type t where x has type e
-		refers to property x 
+		refers to variable x of type t
+		has type t
 		
 	Block(statement*) : 
 		ordered scope for variable

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 15:48:36 2012	(r24780)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 16:40:31 2012	(r24781)
@@ -29,6 +29,9 @@
   adjust-index-def-data(store|namespace, path):
     Entity(name, _) -> <store> DefData(path, Type(), name)
 
+  type-of :
+    Entity(name, _) -> name
+
 
 rules
 
@@ -48,6 +51,9 @@
   adjust-index-def-data(store|namespace, path):
     Entity(name, super, _) -> <store> DefData(path, Type(), name)
 
+  type-of :
+    Entity(name, super, _) -> name
+
 
 rules
 
@@ -63,12 +69,18 @@
   adjust-index-def-data(store|namespace, path):
     Property(x, t) -> <store> DefData(path, Type(), t)
 
+  type-of :
+    Property(x, t) -> t
+
 
 rules
 
   adjust-index-def-data(store|namespace, path):
     For(x, t, e, f, elem*) -> <store> DefData(path, Type(), t)
 
+  type-of :
+    For(x, t, e, f, elem*) -> t
+
 
 rules
 
@@ -84,6 +96,9 @@
   adjust-index-def-data(store|namespace, path):
     VarDecl(x, t, e) -> <store> DefData(path, Type(), t)
 
+  type-of :
+    VarDecl(x, t, e) -> t
+
 
 rules
 
@@ -102,12 +117,20 @@
     VarDecl(x, e) -> <store> DefData(path, Type(), t)
     where t := <type-of> e
 
+  type-of :
+    VarDecl(x, e) -> t
+    where t := <type-of> e
+
 
 rules
 
   nam-annotate-names(|path) =
     Var(nam-annotate-use(|variable()))
 
+  type-of :
+    Var(x) -> t
+    where [t] := <index-lookup ; index-get-data-all(|Type())> x
+
 
 rules
 
@@ -126,6 +149,10 @@
     Method(f, param*, t, _) -> <store> DefData(path, Type(), t)
     where t* := <type-of> param*
 
+  type-of :
+    Method(f, param*, t, _) -> t
+    where t* := <type-of> param*
+
 
 rules
 
@@ -139,4 +166,7 @@
     Param(nam-annotate-def(|path), id)
 
   adjust-index-def-data(store|namespace, path):
-    Param(x, t) -> <store> DefData(path, Type(), t)
\ No newline at end of file
+    Param(x, t) -> <store> DefData(path, Type(), t)
+
+  type-of :
+    Param(x, t) -> t
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 15:48:36 2012	(r24780)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 16:40:31 2012	(r24781)
@@ -53,14 +53,31 @@
 	to-rules:
 		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [definition-rule*, annotate-rule*, type-rule*])
 		where
-			clause*          := <filter(to-clauses)> cond* ; 
+			clause1*         := <filter(to-clauses)> part* ;
+			clause2*         := <filter(to-clauses)> cond* ; 
+			clause*          := <conc> (clause1*, clause2*) ;
 			definition-rule* := <filter(to-definition-rules(|term, clause*))> part* ;
 			annotate-rule*   := <to-annotate-rules(|term, clause*) <+ ![]> part* ;
 			type-rule*       := <filter(to-type-rules(|term, clause*))> part*
 	
 	to-clauses:
+		ND-Ref(_, name, TypeBinding(type), _) -> 
+		WhereClause(
+			Assign(
+				  NoAnnoList(List([type]))
+				, App(
+				  	  Seq(
+				  	  	  CallNoArgs(SVar("index-lookup"))
+				  		, CallT(SVar("index-get-data-all"), [], [NoAnnoList(Op("Type", []))])
+				  		)
+				  	, name)
+				)
+			)
+		
+	to-clauses:
 		Where(term, TypeCheck(type)) -> WhereClause(Assign(type, App(CallT(SVar("type-of"), [], []), term)))
 		
+		
 	to-definition-rules(|term, clause*):
 		ND-Def(NsRef(namespace), name, _, None()) ->
 		[ RDefNoArgs(
@@ -102,8 +119,12 @@
 	introduce-id: Var(_) -> Id()
 	
 	to-type-rules(|term, clause*):
-		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> ADJUST_DATA(term, "Type", type, clause*)
+		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> 
+		[ ADJUST_DATA(term, "Type", type, clause*)
+		, RDefNoArgs("type-of", Rule(term, type, clause*)) ]
 		
-
+	to-type-rules(|term, clause*):
+		ND-Type(type) -> RDefNoArgs("type-of", Rule(term, type, clause*))
+	
 		
 	
\ No newline at end of file

From g.h.wachsmuth at tudelft.nl  Thu May  3 18:59:00 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 03 May 2012 16:59:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24782 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: test trans
Message-ID: <20120503165900.407FDCC16F@mx4.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May  3 16:58:58 2012
New Revision: 24782
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24782&sc=1

Log:
generator for nam-get-scope-types rules

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 16:40:31 2012	(r24781)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 16:58:58 2012	(r24782)
@@ -134,6 +134,12 @@
 
 rules
 
+  nam-get-scope-types :
+    Block(statement*) -> [variable()]
+
+
+rules
+
   nam-get-definition-key :
     Method(f, param*, t, _) -> m(f, t*)
     where t* := <type-of> param*
@@ -145,6 +151,10 @@
   nam-annotate-names(|path) =
     Method(id, id, id, id)
 
+  nam-get-scope-types :
+    Method(f, param*, t, _) -> [variable()]
+    where t* := <type-of> param*
+
   adjust-index-def-data(store|namespace, path):
     Method(f, param*, t, _) -> <store> DefData(path, Type(), t)
     where t* := <type-of> param*

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 16:40:31 2012	(r24781)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 16:58:58 2012	(r24782)
@@ -51,15 +51,18 @@
 		Namespace(ns) -> OpDecl(ns, ConstType(SortNoArgs("Namespace")))
 		
 	to-rules:
-		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [definition-rule*, annotate-rule*, type-rule*])
+		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [scope-rule*, definition-rule*, annotate-rule*, type-rule*])
 		where
 			clause1*         := <filter(to-clauses)> part* ;
 			clause2*         := <filter(to-clauses)> cond* ; 
 			clause*          := <conc> (clause1*, clause2*) ;
+			scope-rule*      := <to-scope-rules(|term, clause*)> part* ;
 			definition-rule* := <filter(to-definition-rules(|term, clause*))> part* ;
-			annotate-rule*   := <to-annotate-rules(|term, clause*) <+ ![]> part* ;
+			annotate-rule*   := <to-annotate-rules(|term, clause*)> part* ;
 			type-rule*       := <filter(to-type-rules(|term, clause*))> part*
-	
+
+rules
+				
 	to-clauses:
 		ND-Ref(_, name, TypeBinding(type), _) -> 
 		WhereClause(
@@ -76,8 +79,24 @@
 		
 	to-clauses:
 		Where(term, TypeCheck(type)) -> WhereClause(Assign(type, App(CallT(SVar("type-of"), [], []), term)))
-		
-		
+
+rules
+	
+	to-scope-rules(|term, clause*):
+		part* -> result
+			where
+			scope* := <filter(to-scope)> part* ;
+			if <?[]> scope* then
+				result := [] 
+			else
+				result := [RDefNoArgs("nam-get-scope-types", Rule(term, List(scope*), clause*))]
+			end
+	
+	to-scope:
+		ND-Scope(_, NsRef(namespace), None()) -> NoAnnoList(Op(namespace, []))
+			
+rules
+			
 	to-definition-rules(|term, clause*):
 		ND-Def(NsRef(namespace), name, _, None()) ->
 		[ RDefNoArgs(
@@ -97,6 +116,8 @@
 			)
 		]
 
+rules
+	
 	to-annotate-rules(|term, clause*):
 		part* -> result
 		where
@@ -117,7 +138,9 @@
 	
 	introduce-id: Wld()  -> Id()
 	introduce-id: Var(_) -> Id()
-	
+
+rules
+		
 	to-type-rules(|term, clause*):
 		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> 
 		[ ADJUST_DATA(term, "Type", type, clause*)

From richard at vogelij.nl  Thu May  3 22:39:16 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Thu, 03 May 2012 20:39:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24783 - in
	spoofax-ace/src/spoofax/ace: . generate/java generate/javascript
Message-ID: <20120503203916.0D645108C044@mx3.tudelft.nl>

Author: rvogelij
Date: Thu May  3 20:39:14 2012
New Revision: 24783
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24783&sc=1

Log:
- created multiple target profiles for building a web-editor
- added a websocket javascript client implementation which communicates with an s2aserver(jetty websocket servlet)

Added:
   spoofax-ace/src/spoofax/ace/generate/javascript/IS2AJSEntryPoint.java
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointMeasure.java
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfile.java
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfileOnlySyntax.java
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointRelease.java
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointReleaseOnlySyntax.java
Deleted:
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPoint.java
Modified:
   spoofax-ace/src/spoofax/ace/SpoofaxToAce.java
   spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java
   spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java

Modified: spoofax-ace/src/spoofax/ace/SpoofaxToAce.java
==============================================================================
--- spoofax-ace/src/spoofax/ace/SpoofaxToAce.java	Thu May  3 16:58:58 2012	(r24782)
+++ spoofax-ace/src/spoofax/ace/SpoofaxToAce.java	Thu May  3 20:39:14 2012	(r24783)
@@ -25,7 +25,7 @@
  */
 public class SpoofaxToAce {
 
-	final static String _version 		= "0.23";
+	final static String _version 		= "0.24";
 	final static String P_SPOOFAXDIR 	= "--i";
 	final static String P_JSSGLRJSFILE 	= "--jssglr";
 	final static String P_STR2JSDIR 	= "--s2js";

Modified: spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java
==============================================================================
--- spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java	Thu May  3 16:58:58 2012	(r24782)
+++ spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java	Thu May  3 20:39:14 2012	(r24783)
@@ -20,55 +20,55 @@
 	        "libstratego-gpp\n" +
 	        "  rules\n" +
 	        "    main: \n" +
-	        "      [x, sourcecode] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
-	        "      where <debug>$[main running. Src=[sourcecode]] \n" +
+	        "      [x, sourcecode] -> <real-main>sourcecode \n" +
+	        //"      where <debug>$[main running. Src=[sourcecode]] \n" +
 	        "\n" +
-	        "    real-main: sourcecode -> <print-elapsed(<debug>(ast, [errors, warnings, notes]) | \"Tokenized\")>    \n" +
+	        "    real-main: sourcecode -> (ast, [errors, warnings, notes])    \n" +
 	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
 	        
 	        //Do everything without stats colecting first so jvm can "warm up" and stratego optimizations such as caches have effect.
 	        
-	        "      where print-elapsed(preparse := <parse-string(|table)>sourcecode|\"Pre parsed source (pre-stats collecting)\")\n" +
-	        "      where print-elapsed(<"+esvParser.GetSemanticObserverStrategy()+">(preparse, \"\", \"\")|\"Pre analyzed source (pre-stats collecting)\") \n" +
-	        "      where print-elapsed(preparse := <parse-string(|table)>sourcecode|\"Pre parsed source (pre-stats collecting)\")\n" +
-	        "      where print-elapsed(<"+esvParser.GetSemanticObserverStrategy()+">(preparse, \"\", \"\")|\"Pre analyzed source (pre-stats collecting)\") \n" +
+	        //"      where print-elapsed(preparse := <parse-string(|table)>sourcecode|\"Pre parsed source (pre-stats collecting)\")\n" +
+	        //"      where print-elapsed(<"+esvParser.GetSemanticObserverStrategy()+">(preparse, \"\", \"\")|\"Pre analyzed source (pre-stats collecting)\") \n" +
+	        //"      where print-elapsed(preparse := <parse-string(|table)>sourcecode|\"Pre parsed source (pre-stats collecting)\")\n" +
+	        //"      where print-elapsed(<"+esvParser.GetSemanticObserverStrategy()+">(preparse, \"\", \"\")|\"Pre analyzed source (pre-stats collecting)\") \n" +
 	        
 	        
-	        "      where start-task(|$[java_parse]) "+
+	        //"      where start-task(|$[java_parse]) "+
 	        "      where print-elapsed(ast := <parse-string(|table)>sourcecode|\"Parsed source\")\n" +
-	        "      where finished-task(|$[java_parse]) "+
-	        "      where max-depth := <max-depth>ast \n" +
-	        "      where max-depths-summed := <max-depths-summed>ast \n"+
-	        
-	        "      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[CharsOfCode], <strlen>sourcecode) "+
-	        "      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+
-	        "      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[TermSize], <term-size>ast) "+
-	        "      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepth], max-depth) "+
-	        "      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+	        //"      where finished-task(|$[java_parse]) "+
+	        //"      where max-depth := <max-depth>ast \n" +
+	        //"      where max-depths-summed := <max-depths-summed>ast \n"+
+	        
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[CharsOfCode], <strlen>sourcecode) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[TermSize], <term-size>ast) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepth], max-depth) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
 
-	        "      where record-current-heap-size(|$[memsize_after_java_parse], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+	        
-	        "      where record-current-heap-size(|$[memsize_after_java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+	        //"      where record-current-heap-size(|$[memsize_after_java_parse], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+	        
+	        //"      where record-current-heap-size(|$[memsize_after_java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
 	        
 
-	        "      where start-task(|$[java_analyze]) "+
+	        //"      where start-task(|$[java_analyze]) "+
 	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
-	        "      where finished-task(|$[java_analyze]) "+
-	        "      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[CharsOfCode], <strlen>sourcecode) "+
-	        "      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+
-	        "      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[TermSize], <term-size>ast) "+
-	        "      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepth], max-depth) "+
-	        "      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+	        //"      where finished-task(|$[java_analyze]) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[CharsOfCode], <strlen>sourcecode) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[TermSize], <term-size>ast) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepth], max-depth) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
 	        
-	        "      where record-current-heap-size(|$[memsize_after_java_analyze], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+	        
-	        "      where record-current-heap-size(|$[memsize_after_java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+			//"      where record-current-heap-size(|$[memsize_after_java_analyze], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+	        
+	        //"      where record-current-heap-size(|$[memsize_after_java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
 	        
 	        
 	        
 	        "external " + esvParser.GetSemanticObserverStrategy() + "(|) \n" +
-	        "external start-task(|task) \n" +
-	        "external finished-task(|task) \n" +
-	        "external record-task(|task, langname, metricname, metricvalue) \n" +
-	        "external record-current-heap-size(|task, langname, metricname, metricvalue) \n" +
+	        //"external start-task(|task) \n" +
+	        //"external finished-task(|task) \n" +
+	        //"external record-task(|task, langname, metricname, metricvalue) \n" +
+	        //"external record-current-heap-size(|task, langname, metricname, metricvalue) \n" +
 	        ""
 			;
 			FileOutputStream fstream = new FileOutputStream(entryFile);

Added: spoofax-ace/src/spoofax/ace/generate/javascript/IS2AJSEntryPoint.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/IS2AJSEntryPoint.java	Thu May  3 20:39:14 2012	(r24783)
@@ -0,0 +1,8 @@
+package spoofax.ace.generate.javascript;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+
+public interface IS2AJSEntryPoint {
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException;
+}
\ No newline at end of file

Added: spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointMeasure.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointMeasure.java	Thu May  3 20:39:14 2012	(r24783)
@@ -0,0 +1,79 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entry point with profiler start/stop statement targetted for Chrome. 
+ */
+public class S2AJSEntryPointMeasure implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+	        
+	        /*
+	        "      where print-elapsed(testast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source (PRE RUN)\")\n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(testast, \"\", \"\")|\"PRE CACHE RUN Analyzed source\") \n" +
+	        "      where print-elapsed(testast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source (PRE RUN)\")\n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(testast, \"\", \"\")|\"PRE CACHE RUN Analyzed source\") \n" +
+	        */
+	        
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.StartWork('js_parse'); ] \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.FinishedWork('js_parse'); ] \n" +
+	        "      where max-depth := <max-depth>ast \n" +
+	        "      where max-depths-summed := <max-depths-summed>ast \n"+
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'CharsOfCode', [ <strlen>sourcecode ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +	        
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'TermSize', [ <term-size>ast ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'MaxDepth', [ max-depth ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_parse', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_parse', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.StartWork('js_analyze'); ] \n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.FinishedWork('js_analyze'); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'CharsOfCode', [ <strlen>sourcecode ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'TermSize', [ <term-size>ast ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'MaxDepth', [ max-depth ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_analyze', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_analyze', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfile.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfile.java	Thu May  3 20:39:14 2012	(r24783)
@@ -0,0 +1,55 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint with measurements 
+ */
+public class S2AJSEntryPointProfile implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ console.profile('Parsing'); ] \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profileEnd();  ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profile('Analyze'); ] \n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profileEnd();  ] \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfileOnlySyntax.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfileOnlySyntax.java	Thu May  3 20:39:14 2012	(r24783)
@@ -0,0 +1,52 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint with measurements 
+ */
+public class S2AJSEntryPointProfileOnlySyntax implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ console.profile('Parsing'); ] \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profileEnd();  ] \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [[], [], []]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointRelease.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointRelease.java	Thu May  3 20:39:14 2012	(r24783)
@@ -0,0 +1,51 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint without measurements 
+ */
+public class S2AJSEntryPointRelease implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointReleaseOnlySyntax.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointReleaseOnlySyntax.java	Thu May  3 20:39:14 2012	(r24783)
@@ -0,0 +1,50 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint without measurements 
+ */
+public class S2AJSEntryPointReleaseOnlySyntax implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [[], [], []]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Modified: spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java
==============================================================================
--- spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java	Thu May  3 16:58:58 2012	(r24782)
+++ spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java	Thu May  3 20:39:14 2012	(r24783)
@@ -26,6 +26,7 @@
 	protected final String strategoEntry;
 	protected final String esvFile;
 	protected final S2AEsvParser esvParser;
+	protected final IS2AJSEntryPoint entryPointGenerator;
 	 
 	
 	protected S2AJSGenerator(S2ASettings pSettings) throws IOException, S2ASpoofaxSetupException
@@ -39,6 +40,11 @@
 		esvParser = new S2AEsvParser(esvFile);
 		new File(tmpDir.substring(0,tmpDir.lastIndexOf(File.separator))).mkdirs();
 		S2AUtils.EmptyDir(tmpDir);
+		
+		entryPointGenerator = new S2AJSEntryPointRelease();
+		//entryPointGenerator = new S2AJSEntryPointProfile();
+		//entryPointGenerator = new S2AJSEntryPointReleaseOnlySyntax();
+		//entryPointGenerator = new S2AJSEntryPointProfileOnlySyntax();
 	}
 	
 	
@@ -49,7 +55,7 @@
 	protected void BuildStrProgram() throws S2ASpoofaxSetupException, S2AWrapperException, S2ACompilerException, S2AValidatorException, IOException
 	{
 		CacheRequiredFiles(tmpDir, esvParser);
-		S2AJSEntryPoint.GenerateS2AEntry(getClass(), strategoEntry, esvParser);
+		entryPointGenerator.GenerateS2AEntry(getClass(), strategoEntry, esvParser);
 		CompileStratego2JS(tmpDir, strategoEntry, jsbin);
 	}
 	
@@ -91,7 +97,9 @@
 			S2AUtils.WriteResourceToFile(getClass(), "/ace/static.py", wwwroot+"/static.py");
 			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/ace-uncompressed.js", wwwroot+"/src/ace-uncompressed.js");
 			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/mode-spoofax2ace.js", wwwroot+"/src/mode-spoofax2ace.js");
-			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-dawn.js", wwwroot+"/src/theme-dawn.js");
+			//S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-dawn.js", wwwroot+"/src/theme-dawn.js");
+			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-dawn-original.js", wwwroot+"/src/theme-dawn.js");
+			//S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-eclipse.js", wwwroot+"/src/theme-eclipse.js");
 			S2AUtils.WriteFileToFile(wrappedAceWorker, wwwroot+"/src/worker-spoofax2ace.js");
 			new File(wwwroot+"/static.py").setExecutable(true, false);
 		} catch (IOException e) {
@@ -117,6 +125,7 @@
 				S2AUtils.WriteResourceToStream(getClass(), "/html/editor_append.html", editorFrontend);
 				editorFrontend.flush();
 				editorFrontend.close();
+				S2AUtils.WriteResourceToFile(getClass(), "/html/underline.gif", wwwroot+"/underline.gif");				
 			}
 			
 			//Also output a simple html file which does not rely on requireJS (requireJS is an issue for JS profilers)
@@ -145,7 +154,11 @@
 		FileOutputStream wrappedAceWorkerStrm;
 		try {
 			wrappedAceWorkerStrm = new FileOutputStream(wrappedAceWorker, true);
-			S2AUtils.WriteResourceToStream(getClass(), "/javascript/aceworker/worker-spoofax2ace-prepend.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/aceworker/worker-spoofax2ace-prepend-new.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/partitioner.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/s2aclient.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/s2alocal.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/stats.js", wrappedAceWorkerStrm);
 			S2AUtils.WriteFileToStream(wrappedStrprog, wrappedAceWorkerStrm);
 			S2AUtils.WriteResourceToStream(getClass(), "/javascript/aceworker/worker-spoofax2ace-append.js", wrappedAceWorkerStrm);
 			wrappedAceWorkerStrm.flush();

From richard at vogelij.nl  Thu May  3 22:57:53 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Thu, 03 May 2012 20:57:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24784 - in
	spoofax-ace/resources: ace/src cloud9 cloud9/client
	cloud9/client/ext cloud9/client/ext/code cloud9/support
	cloud9/support/ace cloud9/support/ace/lib cloud9/sup...
Message-ID: <20120503205753.37083CC18C@mx4.tudelft.nl>

Author: rvogelij
Date: Thu May  3 20:57:51 2012
New Revision: 24784
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24784&sc=1

Log:
updated resources

- added cloud9 mode generating function (does not update cloud9's UI menu yet but creates the js worker required)
- red curly underline theme (like in eclipse) for ace at error markers
- added actual implementation of the websocket client 
- started on a client-server partitioning framework which will decide whether to analyze locally or send a work packet to an s2a server

Added:
   spoofax-ace/resources/ace/src/theme-dawn-original.js
   spoofax-ace/resources/ace/src/theme-eclipse.js
   spoofax-ace/resources/cloud9/
   spoofax-ace/resources/cloud9/client/
   spoofax-ace/resources/cloud9/client/ext/
   spoofax-ace/resources/cloud9/client/ext/code/
   spoofax-ace/resources/cloud9/client/ext/code/code.js
   spoofax-ace/resources/cloud9/client/ext/code/code.xml
   spoofax-ace/resources/cloud9/support/
   spoofax-ace/resources/cloud9/support/ace/
   spoofax-ace/resources/cloud9/support/ace/lib/
   spoofax-ace/resources/cloud9/support/ace/lib/ace/
   spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/
   spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace.js
   spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_tokenizer.js
   spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_worker.js
   spoofax-ace/resources/html/underline.gif   (contents, props changed)
   spoofax-ace/resources/java/record_current_heap_size_0_4.java
   spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js
   spoofax-ace/resources/javascript/partitioner.js
   spoofax-ace/resources/javascript/s2aclient.js
   spoofax-ace/resources/javascript/s2alocal.js
   spoofax-ace/resources/javascript/stats.js
Modified:
   spoofax-ace/resources/ace/src/theme-dawn.js
   spoofax-ace/resources/html/editor_prepend.html
   spoofax-ace/resources/html/test_append.html
   spoofax-ace/resources/html/test_prepend.html
   spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js

Added: spoofax-ace/resources/ace/src/theme-dawn-original.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/ace/src/theme-dawn-original.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1 @@
+define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",b.cssText=".ace-dawn .ace_editor {  border: 2px solid rgb(159, 159, 159);}.ace-dawn .ace_editor.ace_focus {  border: 2px solid #327fbd;}.ace-dawn .ace_gutter {  width: 50px;  background: #e8e8e8;  color: #333;  overflow : hidden;}.ace-dawn .ace_gutter-layer {  width: 100%;  text-align: right;}.ace-dawn .ace_gutter-layer .ace_gutter-cell {  padding-right: 6px;}.ace-dawn .ace_print_margin {  width: 1px;  background: #e8e8e8;}.ace-dawn .ace_scroller {  background-color: #F9F9F9;}.ace-dawn .ace_text-layer {  cursor: text;  color: #080808;}.ace-dawn .ace_cursor {  border-left: 2px solid #000000;}.ace-dawn .ace_cursor.ace_overwrite {  border-left: 0px;  border-bottom: 1px solid #000000;} .ace-dawn .ace_marker-layer .ace_selection {  background: rgba(39, 95, 255, 0.30);}.ace-dawn .ace_marker-layer .ace_step {  background: rgb(198, 219, 174);}.ace-dawn .ace_marker-layer .ace_brac
 ket {  margin: -1px 0 0 -1px;  border: 1px solid rgba(75, 75, 126, 0.50);}.ace-dawn .ace_marker-layer .ace_active_line {  background: rgba(36, 99, 180, 0.12);}.ace-dawn .ace_marker-layer .ace_selected_word {  border: 1px solid rgba(39, 95, 255, 0.30);}       .ace-dawn .ace_invisible {  color: rgba(75, 75, 126, 0.50);}.ace-dawn .ace_keyword {  color:#794938;}.ace-dawn .ace_constant {  color:#811F24;}.ace-dawn .ace_invalid.ace_illegal {  text-decoration:underline;font-style:italic;color:#F8F8F8;background-color:#B52A1D;}.ace-dawn .ace_invalid.ace_deprecated {  text-decoration:underline;font-style:italic;color:#B52A1D;}.ace-dawn .ace_support {  color:#691C97;}.ace-dawn .ace_fold {}.ace-dawn .ace_support.ace_function {  color:#693A17;}.ace-dawn .ace_string {  color:#0B6125;}.ace-dawn .ace_string.ace_regexp {  color:#CF5628;}.ace-dawn .ace_comment {  font-style:italic;color:#5A525F;}.ace-dawn .ace_variable {  color:#234A97;}.ace-dawn .ace_markup.ace_underline {    text-decoration
 :underline;}.ace-dawn .ace_markup.ace_heading {  color:#19356D;}.ace-\ No newline at end of file

Modified: spoofax-ace/resources/ace/src/theme-dawn.js
==============================================================================
--- spoofax-ace/resources/ace/src/theme-dawn.js	Thu May  3 20:39:14 2012	(r24783)
+++ spoofax-ace/resources/ace/src/theme-dawn.js	Thu May  3 20:57:51 2012	(r24784)
@@ -1 +1,104 @@
-define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",b.cssText=".ace-dawn .ace_editor {  border: 2px solid rgb(159, 159, 159);}.ace-dawn .ace_editor.ace_focus {  border: 2px solid #327fbd;}.ace-dawn .ace_gutter {  width: 50px;  background: #e8e8e8;  color: #333;  overflow : hidden;}.ace-dawn .ace_gutter-layer {  width: 100%;  text-align: right;}.ace-dawn .ace_gutter-layer .ace_gutter-cell {  padding-right: 6px;}.ace-dawn .ace_print_margin {  width: 1px;  background: #e8e8e8;}.ace-dawn .ace_scroller {  background-color: #F9F9F9;}.ace-dawn .ace_text-layer {  cursor: text;  color: #080808;}.ace-dawn .ace_cursor {  border-left: 2px solid #000000;}.ace-dawn .ace_cursor.ace_overwrite {  border-left: 0px;  border-bottom: 1px solid #000000;} .ace-dawn .ace_marker-layer .ace_selection {  background: rgba(39, 95, 255, 0.30);}.ace-dawn .ace_marker-layer .ace_step {  background: rgb(198, 219, 174);}.ace-dawn .ace_marker-layer .ace_brac
 ket {  margin: -1px 0 0 -1px;  border: 1px solid rgba(75, 75, 126, 0.50);}.ace-dawn .ace_marker-layer .ace_active_line {  background: rgba(36, 99, 180, 0.12);}.ace-dawn .ace_marker-layer .ace_selected_word {  border: 1px solid rgba(39, 95, 255, 0.30);}       .ace-dawn .ace_invisible {  color: rgba(75, 75, 126, 0.50);}.ace-dawn .ace_keyword {  color:#794938;}.ace-dawn .ace_constant {  color:#811F24;}.ace-dawn .ace_invalid.ace_illegal {  text-decoration:underline;font-style:italic;color:#F8F8F8;background-color:#B52A1D;}.ace-dawn .ace_invalid.ace_deprecated {  text-decoration:underline;font-style:italic;color:#B52A1D;}.ace-dawn .ace_support {  color:#691C97;}.ace-dawn .ace_fold {}.ace-dawn .ace_support.ace_function {  color:#693A17;}.ace-dawn .ace_string {  color:#0B6125;}.ace-dawn .ace_string.ace_regexp {  color:#CF5628;}.ace-dawn .ace_comment {  font-style:italic;color:#5A525F;}.ace-dawn .ace_variable {  color:#234A97;}.ace-dawn .ace_markup.ace_underline {    text-decoration
 :underline;}.ace-dawn .ace_markup.ace_heading {  color:#19356D;}.ace-\ No newline at end of file
+define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",
+	b.cssText=".ace-dawn .ace_editor {\
+		  border: 2px solid rgb(159, 159, 159);\
+		}\
+		\
+		.ace-dawn .ace_editor.ace_focus {\
+		  border: 2px solid #327fbd;\
+		}\
+		\
+		.ace-dawn .ace_gutter {\
+		  width: 50px;\
+		  background: rgb(227, 227, 227);\
+		  border-right: 1px solid rgb(159, 159, 159);	 \
+		  color: rgb(136, 136, 136);\
+		}\
+		\
+		.ace-dawn .ace_gutter-layer {\
+		  width: 100%;\
+		  text-align: right;\
+		}\
+		\
+		.ace-dawn .ace_gutter-layer .ace_gutter-cell {\
+		  padding-right: 6px;\
+		}\
+		\
+		.ace-dawn .ace_text-layer {\
+		  cursor: text;\
+		}\
+		\
+		.ace-dawn .ace_cursor {\
+		  border-left: 1px solid black;\
+		}\
+		\
+		.ace-dawn .ace_line .ace_keyword, .ace-dawn .ace_line .ace_variable {\
+		  color: rgb(127, 0, 85);\
+		  font-weight:bold;\
+		}\
+		\
+		.ace-dawn .ace_line .ace_constant.ace_buildin {\
+		  color: rgb(88, 72, 246);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_constant.ace_library {\
+		  color: rgb(6, 150, 14);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_function {\
+		  color: rgb(60, 76, 114);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_string {\
+		  color: rgb(42, 0, 255);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_comment {\
+		  color: rgb(63, 127, 95);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_comment.ace_doc {\
+		  color: rgb(63, 95, 191);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_comment.ace_doc.ace_tag {\
+		  color: rgb(127, 159, 191);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_constant.ace_numeric {\
+		}\
+		\
+		.ace-dawn .ace_line .ace_tag {\
+			color: rgb(63, 127, 127);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_xml_pe {\
+		  color: rgb(104, 104, 91);\
+		}\
+		\
+		.ace-dawn .ace_marker-layer .ace_selection {\
+		  background: rgb(181, 213, 255);\
+		}\
+		\
+		.ace-dawn .ace_marker-layer .ace_bracket {\
+		  margin: -1px 0 0 -1px;\
+		  border: 1px solid rgb(192, 192, 192);\
+		}\
+		\
+		\
+		.ace-dawn .ace_invalid.ace_illegal {\
+		  //text-decoration:underline;\
+		  font-style:italic;\
+		  background-image: url(underline.gif);\
+		  background-position: bottom;\
+		  background-repeat: repeat-x;\
+		  //color:#F8F8F8;\
+		  //background-color:#B52A1D;\
+		}\
+		\
+		\
+		.ace-dawn .ace_marker-layer .ace_active_line {\
+		  background: rgb(232, 242, 254);\
+		}";
+
+
+var d=a("../lib/dom");d.importCssString(b.cssText)})
\ No newline at end of file

Added: spoofax-ace/resources/ace/src/theme-eclipse.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/ace/src/theme-eclipse.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,134 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define(function(require, exports, module) {
+
+    var dom = require("pilot/dom");
+
+    var cssText = ".ace-eclipse .ace_editor {\
+  border: 2px solid rgb(159, 159, 159);\
+}\
+\
+.ace-eclipse .ace_editor.ace_focus {\
+  border: 2px solid #327fbd;\
+}\
+\
+.ace-eclipse .ace_gutter {\
+  width: 50px;\
+  background: rgb(227, 227, 227);\
+  border-right: 1px solid rgb(159, 159, 159);	 \
+  color: rgb(136, 136, 136);\
+}\
+\
+.ace-eclipse .ace_gutter-layer {\
+  width: 100%;\
+  text-align: right;\
+}\
+\
+.ace-eclipse .ace_gutter-layer .ace_gutter-cell {\
+  padding-right: 6px;\
+}\
+\
+.ace-eclipse .ace_text-layer {\
+  cursor: text;\
+}\
+\
+.ace-eclipse .ace_cursor {\
+  border-left: 1px solid black;\
+}\
+\
+.ace-eclipse .ace_line .ace_keyword, .ace-eclipse .ace_line .ace_variable {\
+  color: rgb(127, 0, 85);\
+}\
+\
+.ace-eclipse .ace_line .ace_constant.ace_buildin {\
+  color: rgb(88, 72, 246);\
+}\
+\
+.ace-eclipse .ace_line .ace_constant.ace_library {\
+  color: rgb(6, 150, 14);\
+}\
+\
+.ace-eclipse .ace_line .ace_function {\
+  color: rgb(60, 76, 114);\
+}\
+\
+.ace-eclipse .ace_line .ace_string {\
+  color: rgb(42, 0, 255);\
+}\
+\
+.ace-eclipse .ace_line .ace_comment {\
+  color: rgb(63, 127, 95);\
+}\
+\
+.ace-eclipse .ace_line .ace_comment.ace_doc {\
+  color: rgb(63, 95, 191);\
+}\
+\
+.ace-eclipse .ace_line .ace_comment.ace_doc.ace_tag {\
+  color: rgb(127, 159, 191);\
+}\
+\
+.ace-eclipse .ace_line .ace_constant.ace_numeric {\
+}\
+\
+.ace-eclipse .ace_line .ace_tag {\
+	color: rgb(63, 127, 127);\
+}\
+\
+.ace-eclipse .ace_line .ace_xml_pe {\
+  color: rgb(104, 104, 91);\
+}\
+\
+.ace-eclipse .ace_marker-layer .ace_selection {\
+  background: rgb(181, 213, 255);\
+}\
+\
+.ace-eclipse .ace_marker-layer .ace_bracket {\
+  margin: -1px 0 0 -1px;\
+  border: 1px solid rgb(192, 192, 192);\
+}\
+\
+.ace-eclipse .ace_marker-layer .ace_active_line {\
+  background: rgb(232, 242, 254);\
+}";
+
+    // import CSS once
+    dom.importCssString(cssText);
+
+    exports.cssClass = "ace-eclipse";
+});

Added: spoofax-ace/resources/cloud9/client/ext/code/code.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/cloud9/client/ext/code/code.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,531 @@
+/**
+ * Code Editor for the Cloud9 IDE
+ *
+ * @copyright 2010, Ajax.org B.V.
+ * @license GPLv3 <http://www.gnu.org/licenses/gpl.txt>
+ */
+
+define(function(require, exports, module) {
+
+require("apf/elements/codeeditor");
+
+var ide = require("core/ide");
+var ext = require("core/ext");
+var EditSession = require("ace/edit_session").EditSession;
+var HashHandler = require("ace/keyboard/hash_handler").HashHandler;
+var useragent = require("ace/lib/useragent");
+var Document = require("ace/document").Document;
+var Range = require("ace/range").Range;
+var ProxyDocument = require("ext/code/proxydocument");
+var CommandManager = require("ace/commands/command_manager").CommandManager;
+var defaultCommands = require("ace/commands/default_commands").commands;
+var markup = require("text!ext/code/code.xml");
+var settings = require("ext/settings/settings");
+var markupSettings = require("text!ext/code/settings.xml");
+var editors = require("ext/editors/editors");
+
+apf.actiontracker.actions.aceupdate = function(undoObj, undo){
+    var q = undoObj.args;
+
+    if (!undoObj.initial) {
+        undoObj.initial = true;
+        return;
+    }
+
+    if (undo)
+        q[1].undoChanges(q[0]);
+    else
+        q[1].redoChanges(q[0]);
+};
+
+var SupportedModes = {
+    "text/x-tiger": "spoofax2ace",
+    "application/javascript": "javascript",
+    "application/json": "json",
+    "text/css": "css",
+    "text/x-scss": "scss",
+    "text/html": "html",
+    "application/xhtml+xml": "html",
+    "application/xml": "xml",
+    "application/rdf+xml": "xml",
+    "application/rss+xml": "xml",
+    "image/svg+xml": "svg",
+    "application/wsdl+xml": "xml",
+    "application/xslt+xml": "xml",
+    "application/atom+xml": "xml",
+    "application/mathml+xml": "xml",
+    "application/x-httpd-php": "php",
+    "text/x-script.python": "python",
+    "text/x-script.ruby": "ruby",
+    "text/x-script.perl": "perl",
+    "text/x-script.perl-module": "perl",
+    "text/x-c": "c_cpp",
+    "text/x-java-source": "java",
+    "text/x-groovy": "groovy",
+    "text/x-csharp": "csharp",
+    "text/x-script.coffeescript": "coffee",
+    "text/x-markdown": "markdown",
+    "text/x-web-textile": "textile",
+    "text/x-script.ocaml": "ocaml",
+    "text/x-script.clojure": "clojure",
+    "application/x-latex": "latex",
+    "text/x-lua": "lua",
+    "text/x-script.powershell": "powershell",
+    "text/x-scala": "scala",
+    "text/x-coldfusion": "coldfusion",
+    "text/x-sql": "sql"
+};
+
+var contentTypes = {
+    "tig": "text/x-tiger",
+    "js": "application/javascript",
+    "json": "application/json",
+    "css": "text/css",
+    "less": "text/css",
+    "scss": "text/x-scss",
+    "sass": "text/x-sass",
+
+    "xml": "application/xml",
+    "rdf": "application/rdf+xml",
+    "rss": "application/rss+xml",
+    "svg": "image/svg+xml",
+    "wsdl": "application/wsdl+xml",
+    "xslt": "application/xslt+xml",
+    "atom": "application/atom+xml",
+    "mathml": "application/mathml+xml",
+    "mml": "application/mathml+xml",
+
+    "php": "application/x-httpd-php",
+    "phtml": "application/x-httpd-php",
+    "html": "text/html",
+    "xhtml": "application/xhtml+xml",
+    "coffee": "text/x-script.coffeescript",
+    "*Cakefile": "text/x-script.coffeescript",
+    "py": "text/x-script.python",
+
+    "ru": "text/x-script.ruby",
+    "gemspec": "text/x-script.ruby",
+    "rake": "text/x-script.ruby",
+    "rb": "text/x-script.ruby",
+
+    "c": "text/x-c",
+    "cc": "text/x-c",
+    "cpp": "text/x-c",
+    "cxx": "text/x-c",
+    "h": "text/x-c",
+    "hh": "text/x-c",
+
+    "cs": "text/x-csharp",
+
+    "java": "text/x-java-source",
+    "clj": "text/x-script.clojure",
+    "groovy": "text/x-groovy",
+    "scala": "text/x-scala",
+
+    "ml": "text/x-script.ocaml",
+    "mli": "text/x-script.ocaml",
+
+    "md": "text/x-markdown",
+    "markdown": "text/x-markdown",
+    "textile": "text/x-web-textile",
+    "latex": "application/x-latex",
+    "tex": "application/x-latex",
+    "ltx": "application/x-latex",
+
+    "lua": "text/x-lua",
+
+    "pl": "text/x-script.perl",
+    "pm": "text/x-script.perl-module",
+
+    "ps1": "text/x-script.powershell",
+    "cfm": "text/x-coldfusion",
+    "sql": "text/x-sql"
+};
+
+module.exports = ext.register("ext/code/code", {
+    name    : "Code Editor",
+    dev     : "Ajax.org",
+    type    : ext.EDITOR,
+    markup  : markup,
+    deps    : [editors],
+
+    nodes : [],
+
+    fileExtensions : Object.keys(contentTypes),
+    supportedModes: Object.keys(SupportedModes),
+    commandManager : new CommandManager(useragent.isMac ? "mac" : "win", defaultCommands),
+
+    getState : function(doc) {
+        doc = doc ? doc.acesession : this.getDocument();
+        if (!doc || typeof doc.getSelection != "function")
+            return;
+
+        var folds = doc.getAllFolds().map(function(fold) {
+            return {
+                start: fold.start,
+                end: fold.end,
+                placeholder: fold.placeholder
+            };
+        });
+
+        var sel = doc.getSelection();
+        return {
+            scrolltop  : doc.getScrollTop(),
+            scrollleft : doc.getScrollLeft(),
+            selection  : sel.getRange(),
+            folds      : folds
+        };
+    },
+
+    setState : function(doc, state){
+        var aceDoc = doc ? doc.acesession : this.getDocument();
+        if (!aceDoc || !state || typeof aceDoc.getSelection != "function")
+            return;
+
+        var sel = aceDoc.getSelection();
+
+        //are those 3 lines set the values in per document base or are global for editor
+        sel.setSelectionRange(state.selection, false);
+
+        aceDoc.setScrollTop(state.scrolltop);
+        aceDoc.setScrollLeft(state.scrollleft);
+
+        if (state.folds) {
+            for (var i = 0, l=state.folds.length; i < l; i++) {
+                var fold = state.folds[i];
+                aceDoc.addFold(fold.placeholder, Range.fromPoints(fold.start, fold.end));
+            }
+        }
+
+        // if newfile == 1 and there is text cached, restore it
+        var node = doc.getNode && doc.getNode();
+        if (node && parseInt(node.getAttribute("newfile") || 0, 10) === 1 && node.childNodes.length) {
+            // the text is cached within a CDATA block as first childNode of the <file>
+            if (doc.getNode().childNodes[0] instanceof CDATASection) {
+                aceDoc.setValue(doc.getNode().childNodes[0].nodeValue);
+            }
+        }
+    },
+
+    getSyntax : function(node) {
+        if (!node)
+            return "";
+
+        var mime = node.getAttribute("customtype");
+
+        if (!mime) {
+            var fileName = node.getAttribute("name");
+
+            if (fileName.lastIndexOf(".") != -1)
+                mime = contentTypes[fileName.split(".").pop()];
+            else
+                mime = contentTypes["*" + fileName];
+        }
+
+        if (mime) {
+            mime = mime.split(";")[0];
+            return (SupportedModes[mime] || "text");
+        }
+
+        return "text";
+    },
+
+    getSelection : function(){
+        if (typeof ceEditor == "undefined")
+            return null;
+        return ceEditor.getSelection();
+    },
+
+    getDocument : function(){
+        if (typeof ceEditor == "undefined")
+            return null;
+        return ceEditor.getSession();
+    },
+
+    setDocument : function(doc, actiontracker){
+        var _self = this;
+
+        if (!doc.acesession) {
+            doc.isInited = doc.hasValue();
+            doc.acedoc = doc.acedoc || new ProxyDocument(new Document(doc.getValue() || ""));
+            doc.acesession = new EditSession(doc.acedoc);
+            doc.acedoc = doc.acesession.getDocument();
+
+            doc.acesession.setUndoManager(actiontracker);
+
+            if (doc.isInited && doc.state)
+                 _self.setState(doc, doc.state);
+
+            doc.addEventListener("prop.value", function(e) {
+                if (this.editor != _self)
+                    return;
+
+                doc.acesession.setValue(e.value || "");
+                if (doc.state)
+                    _self.setState(doc, doc.state);
+                doc.isInited = true;
+            });
+
+            doc.addEventListener("retrievevalue", function(e) {
+                if (this.editor != _self)
+                    return;
+
+                if (!doc.isInited)
+                    return e.value;
+                else
+                    return doc.acesession.getValue();
+            });
+
+            doc.addEventListener("close", function(){
+                if (this.editor != _self)
+                    return;
+
+                //??? destroy doc.acesession
+            });
+        }
+        ceEditor.setProperty("value", doc.acesession);
+
+        if (doc.editor && doc.editor != this) {
+            var value = doc.getValue();
+            if (doc.acesession.getValue() !== value) {
+                doc.editor = this;
+                doc.dispatchEvent("prop.value", {value : value});
+            }
+        }
+
+        doc.editor = this;
+    },
+
+    hook: function() {
+        var _self      = this;
+
+        //Settings Support
+        ide.addEventListener("init.ext/settings/settings", function(e) {
+            var heading = e.ext.getHeading("Code Editor");
+            heading.insertMarkup(markupSettings);
+        });
+
+        ide.addEventListener("loadsettings", function(e) {
+            var model = e.model;
+            if (!model.queryNode("editors/code")) {
+                var node = apf.n("<code />")
+                  .attr("overwrite", "false")
+                  .attr("selectstyle", "line")
+                  .attr("activeline", "true")
+                  .attr("showinvisibles", "false")
+                  .attr("showprintmargin", "true")
+                  .attr("printmargincolumn", "80")
+                  .attr("softtabs", "true")
+                  .attr("tabsize", "4")
+                  .attr("scrollspeed", "2")
+                  .attr("fontsize", "12")
+                  .attr("wrapmode", "false")
+                  .attr("wraplimitmin", "")
+                  .attr("wraplimitmax", "")
+                  .attr("gutter", "true")
+                  .attr("highlightselectedword", "true")
+                  .attr("autohidehorscrollbar", "true").node();
+
+                var editors = apf.createNodeFromXpath(model.data, "editors");
+                apf.xmldb.appendChild(editors, node);
+            }
+
+            // pre load theme
+            var theme = e.model.queryValue("editors/code/@theme");
+            if (theme)
+                require([theme], function() {});
+            // pre load custom mime types
+            _self.getCustomTypes(e.model);
+        });
+
+        ide.addEventListener("afteropenfile", function(e) {
+            if (_self.setState)
+                _self.setState(e.doc, e.doc.state);
+
+            if (e.doc && e.doc.editor && e.doc.editor.ceEditor) {
+                // check if there is a scriptid, if not check if the file is somewhere in the stack
+                if (typeof mdlDbgStack != "undefined" && mdlDbgStack.data && e.node
+                  && (!e.node.hasAttribute("scriptid") || !e.node.getAttribute("scriptid"))
+                  && e.node.hasAttribute("scriptname") && e.node.getAttribute("scriptname")) {
+                    var nodes = mdlDbgStack.data.selectNodes("//frame[@script='" + e.node.getAttribute("scriptname").replace(ide.workspaceDir + "/", "") + "']");
+                    if (nodes.length) {
+                        e.node.setAttribute("scriptid", nodes[0].getAttribute("scriptid"));
+                    }
+                }
+                e.doc.editor.ceEditor.afterOpenFile(e.doc.editor.ceEditor.getSession());
+            }
+        });
+
+        tabEditors.addEventListener("afterswitch", function(e) {
+            ceEditor.afterOpenFile(ceEditor.getSession());
+        });
+
+        // preload common language modes
+        require(["ace/mode/javascript", "ace/mode/html", "ace/mode/css"], function() {});
+    },
+
+    init: function(amlPage) {
+        amlPage.appendChild(ceEditor);
+        ceEditor.show();
+
+        this.ceEditor = this.amlEditor = ceEditor;
+        ceEditor.$editor.commands = this.commandManager;
+
+        var _self = this;
+
+        this.nodes.push(
+            //Add a panel to the statusbar showing whether the insert button is pressed
+            sbMain.appendChild(new apf.section({
+                caption : "{ceEditor.insert}"
+            })),
+
+            //Add a panel to the statusbar showing the length of the document
+            sbMain.appendChild(new apf.section({
+                caption : "Length: {ceEditor.value.length}"
+            })),
+
+            mnuView.appendChild(new apf.item({
+                caption : "Syntax Highlighting",
+                submenu : "mnuSyntax"
+            })),
+
+            mnuView.appendChild(new apf.divider()),
+
+            mnuView.appendChild(new apf.item({
+                type    : "check",
+                caption : "Show Invisibles",
+                checked : "[{require('ext/settings/settings').model}::editors/code/@showinvisibles]"
+            })),
+
+            mnuView.appendChild(new apf.item({
+                type    : "check",
+                caption : "Wrap Lines",
+                checked : "{ceEditor.wrapmode}"
+            }))
+        );
+
+        mnuSyntax.onitemclick = function(e) {
+            var file = ide.getActivePageModel();
+            if (file) {
+                var value = e.relatedNode.value;
+
+                if (value == "auto")
+                    apf.xmldb.removeAttribute(file, "customtype", "");
+                else
+                    apf.xmldb.setAttribute(file, "customtype", value);
+
+                if (file.getAttribute("customtype")) {
+                    var fileName = file.getAttribute("name");
+
+                    if (contentTypes["*" + fileName])
+                        delete contentTypes["*" + fileName];
+
+                    var mime = value.split(";")[0];
+                    var fileExt = (fileName.lastIndexOf(".") != -1) ?
+                        fileName.split(".").pop() : null;
+
+                    if (fileExt && contentTypes[fileExt] !== mime)
+                        delete contentTypes[fileExt];
+
+                    var customType = fileExt ?
+                        contentTypes[fileExt] : contentTypes["*" + fileName];
+
+                    if (!customType)
+                        _self.setCustomType(fileExt ? fileExt : file, mime);
+                    ide.dispatchEvent("track_action", {
+                        type: "syntax highlighting",
+                        fileType: fileExt,
+                        fileName: fileName,
+                        mime: mime,
+                        customType: customType
+                    });
+                }
+            }
+        };
+
+        ide.addEventListener("keybindingschange", function(e) {
+            if (typeof ceEditor == "undefined")
+                return;
+
+            var bindings = e.keybindings.code;
+            ceEditor.$editor.setKeyboardHandler(new HashHandler(bindings));
+            // In case the `keybindingschange` event gets fired after other
+            // plugins that change keybindings have already changed them (i.e.
+            // the vim plugin), we fire an event so these plugins can react to it.
+            ide.dispatchEvent("code.ext:defaultbindingsrestored", {});
+        });
+    },
+
+    /**
+     * Saves custom syntax for extension type in settings.xml
+     *
+     * @param {String|xmlNode} ext Contains the extension type shorthand
+     * @param {String} mime Mime type string the extension will be related to
+     */
+    setCustomType: function(ext, mime) {
+        var node;
+
+        if (typeof ext === "string") {
+            node = settings.model.queryNode('auto/customtypes/mime[@ext="' + ext + '"]');
+            if (!node)
+                settings.model.appendXml('<mime name="' + mime + '" ext="' + ext + '" />', "auto/customtypes");
+        } else {
+            var name = ext.getAttribute("name") || "";
+            node = settings.model.queryNode('auto/customtypes/mime[@filename="' + name + '"]');
+            if (node)
+                apf.xmldb.removeAttribute(node, "ext");
+            else
+                settings.model.appendXml('<mime name="' + mime + '" filename="' + name + '" />', "auto/customtypes");
+        }
+
+        apf.xmldb.setAttribute(node, "name", mime);
+        settings.save();
+    },
+
+    /**
+     * Retrieves custom syntax for extensions saved in settings.xml
+     *
+     * @param {Object} model Settings' model
+     */
+    getCustomTypes: function(model) {
+        var customTypes = model.queryNode("auto/customtypes");
+        if (!customTypes)
+            customTypes = apf.createNodeFromXpath(model.data, "auto/customtypes");
+
+        var mimes = customTypes.selectNodes("mime");
+        mimes.forEach(function(n) {
+            if (n.getAttribute("filename"))
+                contentTypes["*" + n.getAttribute("filename")] = n.getAttribute("name");
+            else
+                contentTypes[n.getAttribute("ext")] = n.getAttribute("name");
+        });
+    },
+
+
+    enable : function() {
+        this.nodes.each(function(item){
+            item.show();
+        });
+    },
+
+    disable : function() {
+        this.nodes.each(function(item){
+            item.hide();
+        });
+    },
+
+    destroy : function(){
+        this.nodes.each(function(item){
+            item.destroy(true, true);
+        });
+
+        if (self.ceEditor) {
+            ceEditor.destroy(true, true);
+            mnuSyntax.destroy(true, true);
+        }
+
+        this.nodes = [];
+    }
+});
+
+});

Added: spoofax-ace/resources/cloud9/client/ext/code/code.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/cloud9/client/ext/code/code.xml	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,76 @@
+<a:application xmlns:a="http://ajax.org/2005/aml">
+    <a:codeeditor id="ceEditor"
+      flex              = "1"
+      anchors           = "2 0 0 0"
+      visible           = "false"
+      syntax            = "{require('ext/code/code').getSyntax(%[.])}"
+      theme             = "[{require('ext/settings/settings').model}::editors/code/@theme]"
+      overwrite         = "[{require('ext/settings/settings').model}::editors/code/@overwrite]"
+      folding           = "[{require('ext/settings/settings').model}::editors/code/@folding]"
+      behaviors         = "[{require('ext/settings/settings').model}::editors/code/@behaviors]"
+      selectstyle       = "[{require('ext/settings/settings').model}::editors/code/@selectstyle]"
+      activeline        = "[{require('ext/settings/settings').model}::editors/code/@activeline]"
+      showinvisibles    = "[{require('ext/settings/settings').model}::editors/code/@showinvisibles]"
+      showprintmargin   = "[{require('ext/settings/settings').model}::editors/code/@showprintmargin]"
+      printmargincolumn = "[{require('ext/settings/settings').model}::editors/code/@printmargincolumn]"
+      softtabs          = "[{require('ext/settings/settings').model}::editors/code/@softtabs]"
+      tabsize           = "[{require('ext/settings/settings').model}::editors/code/@tabsize]"
+      scrollspeed       = "[{require('ext/settings/settings').model}::editors/code/@scrollspeed]"
+      
+      fontsize          = "[{require('ext/settings/settings').model}::editors/code/@fontsize]"
+      wrapmode          = "[@wrapmode]"
+      wraplimitmin      = "80"
+      wraplimitmax      = "80"
+      gutter            = "[{require('ext/settings/settings').model}::editors/code/@gutter]"
+      highlightselectedword = "[{require('ext/settings/settings').model}::editors/code/@highlightselectedword]"
+      autohidehorscrollbar  = "[{require('ext/settings/settings').model}::editors/code/@autohidehorscrollbar]"
+      
+      contextmenu       = "mnuCtxEditor"
+      debugger          = "{this.syntax == 'javascript' ? dbg : null}"
+      readonly          = "{[@loading] or cloud9config.readonly or (location.host and window.stDebugProcessRunning and stDebugProcessRunning.active and [@scriptid])}"
+    />
+    
+    <a:menu id="mnuCtxEditor" render="runtime">
+        <a:item onclick="tabEditors.getPage().$at.undo()">Undo</a:item>
+        <a:item onclick="tabEditors.getPage().$at.redo()">Redo</a:item>
+        <a:divider />
+        <a:item 
+          visible="{stDebugProcessRunning.active and !stRunning.active}"
+          onclick="
+            require('ext/quickwatch/quickwatch').toggleDialog(1, true);
+          ">Quick Watch</a:item>
+        <a:divider visible="{stDebugProcessRunning.active and !stRunning.active}" />
+        <a:item onclick="ceEditor.$editor.getSelection().selectAll()">Select All</a:item>
+    </a:menu>
+    
+    <a:menu id="mnuSyntax">
+        <a:item type="radio" value="auto">Auto-Select</a:item>
+        <a:item type="radio" value="text/plain">Plain Text</a:item>
+        <a:divider />
+        <a:item type="radio" value="text/x-tiger">Tiger</a:item>
+        <a:item type="radio" value="text/x-csharp">C#</a:item>
+        <a:item type="radio" value="text/x-c">C/C++</a:item>
+        <a:item type="radio" value="text/x-script.clojure">Clojure</a:item>
+        <a:item type="radio" value="text/x-script.coffeescript">CoffeeScript</a:item>
+        <a:item type="radio" value="text/x-coldfusion">Coldfusion</a:item>
+        <a:item type="radio" value="text/css">CSS</a:item>
+        <a:item type="radio" value="text/x-groovy">Groovy</a:item>
+        <a:item type="radio" value="text/x-java-source">Java</a:item>
+        <a:item type="radio" value="application/javascript">JavaScript</a:item>
+        <a:item type="radio" value="application/x-latex">Latex</a:item>
+        <a:item type="radio" value="text/x-lua">Lua</a:item>
+        <a:item type="radio" value="text/x-markdown">Markdown</a:item>
+        <a:item type="radio" value="text/x-script.ocaml">OCaml</a:item>
+        <a:item type="radio" value="application/x-httpd-php">PHP</a:item>
+        <a:item type="radio" value="text/x-script.perl">Perl</a:item>
+        <a:item type="radio" value="text/x-script.powershell">Powershell</a:item>
+        <a:item type="radio" value="text/x-script.python">Python</a:item>
+        <a:item type="radio" value="text/x-script.ruby">Ruby</a:item>
+        <a:item type="radio" value="text/x-scala">Scala</a:item>
+        <a:item type="radio" value="text/x-scss">SCSS</a:item>
+        <a:item type="radio" value="text/x-sql">SQL</a:item>
+        <a:item type="radio" value="text/x-web-textile">Textile</a:item>
+        <a:item type="radio" value="text/html">(X)HTML</a:item>
+        <a:item type="radio" value="application/xml">XML</a:item>
+    </a:menu>
+</a:application>

Added: spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,121 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define(function(require, exports, module) {
+
+var oop = require("ace/lib/oop");
+var TextMode = require("ace/mode/text").Mode;
+var Spoofax2AceTokenizer = require("ace/mode/spoofax2ace_tokenizer").Spoofax2AceTokenizer;
+var MatchingBraceOutdent = require("ace/mode/matching_brace_outdent").MatchingBraceOutdent;
+var Range = require("ace/range").Range;
+var WorkerClient = require("ace/worker/worker_client").WorkerClient;
+
+var Spoofax2AceMode = function() {
+    this.$tokenizer = new Spoofax2AceTokenizer();
+    this.$outdent = new MatchingBraceOutdent();
+    this.$worker = null;
+    this.debugWorker = true;
+};
+oop.inherits(Spoofax2AceMode, TextMode);
+
+var before;
+var after;
+
+(function() {
+    this.createWorker = function(session) {
+        console.log("Creating worker");
+        before = new Date().getTime();
+        var tokenizer = this.$tokenizer;
+        var doc = session.getDocument();
+        var worker = new WorkerClient(["ace", "pilot"], "worker-spoofax2ace.js", "ace/mode/spoofax2ace_worker", "SpoofaxToAceWorker");
+        worker.call("setValue", [doc.getValue()]);
+
+        var onChange = function(e) {
+            var d = e.data;
+            var r = e.data.range;
+            if(d.action === "insertText" && d.text === '\n') {
+                tokenizer.shiftTokens(r.start.row, 1);
+            }
+            if(d.action === "insertLines") {
+                tokenizer.shiftTokens(r.start.row, d.lines.length);
+            }
+            if(d.action === "removeText" && d.text === '\n') {
+                tokenizer.unshiftTokens(r.start.row, 1);
+            }
+            if(d.action === "removeLines"){
+                tokenizer.unshiftTokens(r.start.row, d.lines.length);
+            }
+
+            worker.emit("change", e);
+        };
+        doc.on("change", onChange);
+
+        if(this.debugWorker) {
+            worker.on("log", function(e) {
+                console.log("worker:" + e.data);
+            });
+
+            worker.on("debug", function(e) {
+                console.log(e.data);
+            });
+        }
+
+        worker.on("loaded", function(e) {
+            after = new Date().getTime();
+            console.log("Loading completed in " + (after-before) + " ms.");
+            worker.call("setValue", [doc.getValue()]);
+        });
+
+        worker.on("jsglr", function(e) {
+            tokenizer.setTokens(e.data.parsed);
+            session.setAnnotations(e.data.errors);
+        });
+
+        worker.on("terminate", function() {
+            doc.removeListener("change", onChange);
+            session.clearAnnotations();
+        });
+
+        this.$worker = worker;
+
+        return worker;
+    };
+
+}).call(Spoofax2AceMode.prototype);
+
+exports.Mode = Spoofax2AceMode;
+});

Added: spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_tokenizer.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_tokenizer.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,111 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define(function(require, exports, module) {
+
+var oop = require("ace/lib/oop");
+var EventEmitter = require("ace/lib/event_emitter").EventEmitter;
+
+var Spoofax2AceTokenizer = function() {
+    this.parsed = [];
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.fireUpdateEvent = function(firstRow, lastRow) {
+        var data = {
+            first: firstRow,
+            last: lastRow
+        };
+        this._dispatchEvent("update", {data: data});
+    };
+
+    this.setTokens = function(tokens) {
+        this.parsed = tokens;
+        this.fireUpdateEvent(0, undefined);
+    }
+
+    this.shiftTokens = function(start, amount) {
+        var args = [start, 0];
+        for(var i = 0; i < amount; i++) {
+            args.push({});
+        }
+        Array.prototype.splice.apply(this.parsed, args);
+    }
+
+    this.unshiftTokens = function(start, amount) {
+        this.parsed.splice(start, amount);
+    }
+
+    this.unknownLine = function(text) {
+        tokens = [];
+
+        var token = {
+            type: "plain",
+            value: text
+        };
+
+        tokens.push(token);
+        return tokens;
+    }
+
+    this.getLineTokens = function(text, line) {
+        var tokens = [];
+        if(line === 'start') {
+            line = 0;
+        }
+
+        var p = this.parsed[line];
+
+        if(p === undefined || p.text !== text || p.tokens.length === 0) {
+            tokens = this.unknownLine(text);
+        } else {
+            tokens = p.tokens;
+        }
+
+        return {
+            tokens : tokens,
+            state : line + 1
+        };
+    };
+
+}).call(Spoofax2AceTokenizer.prototype);
+
+exports.Spoofax2AceTokenizer = Spoofax2AceTokenizer;
+});

Added: spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_worker.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_worker.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,149 @@
+define(function(require, exports, module) {
+
+var oop = require("ace/lib/oop"); 
+var Mirror = require("ace/worker/mirror").Mirror; 
+var SpoofaxToAceWorker = exports.SpoofaxToAceWorker = function(sender) {
+//    $self.sender = sender;
+    this.setTimeout(100);
+    this.analyzer = null;
+    this.loaded = false;
+    this.loading = false;
+    this.load();
+    Mirror.call(this, sender);
+};
+
+
+var strategoProg = require("ace/strategoprog");
+
+
+var working = false;
+var goAgain = false;
+
+
+/*
+ *  Statistics collecting start
+ */
+
+var lastLineCount = 0;
+var analyzeCount = 0;
+var totalAnalyzeTime = 0;
+
+
+var doneAnalyzing = function(lineCount, timeTaken)
+{
+	if (lastLineCount !== lineCount)
+	{
+		lastLineCount = lineCount;
+		analyzeCount = 1;
+		totalAnalyzeTime = timeTaken;
+	} else
+	{
+        	totalAnalyzeTime = totalAnalyzeTime + timeTaken;
+	        analyzeCount = analyzeCount + 1;
+		sender.emit("log", "Analyzed " + lastLineCount +" lines " + analyzeCount + " times. cur:" + timeTaken + " avg: " + averageAnalyzeTime());
+	}
+}
+
+var averageAnalyzeTime = function() 
+{
+  return parseInt(totalAnalyzeTime/analyzeCount);
+}
+
+/*
+ *  Statistics collecting end
+ */
+
+oop.inherits(SpoofaxToAceWorker, Mirror); (function() {
+    this.log = function(value) {
+        if(typeof(console) !== 'undefined' && console.log !== undefined) {
+            console.log(value);
+        } else {
+            sender.emit("log", value);
+        }
+    }
+	
+    this.load = function() {
+    }	
+
+
+    this.onUpdate = function() {
+	if (!this.loaded)
+	{
+		sender.emit("log", "Not yet loaded...");
+		if (!this.loading)
+		{
+			this.loading = true;
+			var start = new Date().getTime();
+			this.analyzer = StrategoJS.init();
+
+			this.loaded = true;
+			this.loading = false;
+			var elapsed = (new Date().getTime() - start);
+		        sender.emit("log", "loaded. (" +  elapsed + ")");
+			this.onUpdate();
+		}
+		return;
+	}
+    	if (working)
+    	{
+                sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+    	goAgain = false;
+	
+	sender.emit("log", "spoofax2ace_worker.onUpdate enter");
+//        sender.emit("log", "Analyze start");
+	var analyze_start = new Date().getTime();
+
+    
+        var value = this.doc.getValue();
+        value = value.replace(/^#!.*\n/, "\n");
+	var result = null;
+	try
+	{
+		result = this.analyzer.main(["aap", value]);
+	}
+	catch (exception)
+	{
+		sender.emit("log", "Error while analyzing: " + exception.message);
+		sender.emit("log", "Stack: " + exception.stack);
+		debugger;
+	}
+
+
+        if (result === null)
+        {
+		sender.emit("log", "Error while analyzing");
+        	working = false;
+        	return;
+        }
+        var splitlines = value.split('\n');
+        var length = result.tokens.length;
+        var parsed = [];
+        for(var i = 0; i < length; i++) {
+            var line = splitlines[i];
+            var tokens = result.tokens[i];
+            parsed[i] = {text: line, tokens: tokens};
+        }
+
+
+        sender.emit("jsglr", {
+            parsed: parsed,
+            errors: result.errors
+        });
+
+	var analyze_elapsed = (new Date().getTime() - analyze_start);
+
+	doneAnalyzing(length, analyze_elapsed);
+
+        sender.emit("log", "spoofax2ace_worker.onUpdate exit");
+        working = false;
+        if (goAgain)
+        	onUpdate();
+    }
+
+}).call(SpoofaxToAceWorker.prototype);
+
+});

Modified: spoofax-ace/resources/html/editor_prepend.html
==============================================================================
--- spoofax-ace/resources/html/editor_prepend.html	Thu May  3 20:39:14 2012	(r24783)
+++ spoofax-ace/resources/html/editor_prepend.html	Thu May  3 20:57:51 2012	(r24784)
@@ -20,4 +20,5 @@
   </style>
 </head>
 <body>
+<input type=checkbox id='local'>
 <pre id="editor">

Modified: spoofax-ace/resources/html/test_append.html
==============================================================================
--- spoofax-ace/resources/html/test_append.html	Thu May  3 20:39:14 2012	(r24783)
+++ spoofax-ace/resources/html/test_append.html	Thu May  3 20:57:51 2012	(r24784)
@@ -6,10 +6,9 @@
 
 var analyzer = undefined;
 
-go = function()
+go = function(sourcecode)
 {
-var editor = document.getElementById('editor');
-analyzer.main(["aap", editor.innerHTML]);
+	analyzer.main(["aap", sourcecode]);
 };
 
 window.onload = function() 

Modified: spoofax-ace/resources/html/test_prepend.html
==============================================================================
--- spoofax-ace/resources/html/test_prepend.html	Thu May  3 20:39:14 2012	(r24783)
+++ spoofax-ace/resources/html/test_prepend.html	Thu May  3 20:57:51 2012	(r24784)
@@ -22,7 +22,7 @@
   </style>
 </head>
 <body>
-<a href='#' onclick='go(); return false;'>[Re Run]</a>
+<a href='#' onclick="go(document.getElementById('editor').innerHTML); return false;">[Re Run]</a>
 <br />
 
 <textarea id="editor">
\ No newline at end of file

Added: spoofax-ace/resources/html/underline.gif
==============================================================================
Binary file. No diff available.

Added: spoofax-ace/resources/java/record_current_heap_size_0_4.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/java/record_current_heap_size_0_4.java	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,16 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+public class record_current_heap_size_0_4 extends Strategy {
+
+	public static record_current_heap_size_0_4 instance = new record_current_heap_size_0_4();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current,	IStrategoTerm task, IStrategoTerm langname, IStrategoTerm metricname, IStrategoTerm metricvalue) {
+		StatsCollector.RecordMemorySize(task.toString(), langname.toString(), metricname.toString(), metricvalue.toString());
+		ITermFactory factory = context.getFactory();
+		return factory.makeString("ok");
+	}
+}

Modified: spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js
==============================================================================
--- spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js	Thu May  3 20:39:14 2012	(r24783)
+++ spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js	Thu May  3 20:57:51 2012	(r24784)
@@ -1,4 +1,6 @@
-}).call(SpoofaxToAceWorker.prototype);
+
+}
+).call(SpoofaxToAceWorker.prototype);
 });
 
 define('ace/worker/mirror', ['require', 'exports', 'module' , 'ace/document', 'ace/lib/lang'], function(require, exports, module) {

Added: spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,1535 @@
+var console = {
+    log: function(msg) {
+        postMessage({type: "log", data: msg});
+    }
+};
+var window = {
+    console: console
+};
+
+$self = {};
+
+var normalizeModule = function(parentId, moduleName) {
+    // normalize plugin requires
+    if (moduleName.indexOf("!") !== -1) {
+        var chunks = moduleName.split("!");
+        return normalizeModule(parentId, chunks[0]) + "!" + normalizeModule(parentId, chunks[1]);
+    }
+    // normalize relative requires
+    if (moduleName.charAt(0) == ".") {
+        var base = parentId.split("/").slice(0, -1).join("/");
+        var moduleName = base + "/" + moduleName;
+        
+        while(moduleName.indexOf(".") !== -1 && previous != moduleName) {
+            var previous = moduleName;
+            var moduleName = moduleName.replace(/\/\.\//, "/").replace(/[^\/]+\/\.\.\//, "");
+        }
+    }
+    
+    return moduleName;
+};
+
+var require = function(parentId, id) {
+    var id = normalizeModule(parentId, id);
+    
+    var module = require.modules[id];
+    if (module) {
+        if (!module.initialized) {
+            module.exports = module.factory().exports;
+            module.initialized = true;
+        }
+        return module.exports;
+    }
+    
+    var chunks = id.split("/");
+    chunks[0] = require.tlns[chunks[0]] || chunks[0];
+    path = chunks.join("/") + ".js";
+    
+    require.id = id;
+    importScripts(path);
+    return require(parentId, id);    
+};
+
+require.modules = {};
+require.tlns = {};
+
+var define = function(id, deps, factory) {
+    if (arguments.length == 2) {
+        factory = deps;
+    } else if (arguments.length == 1) {
+        factory = id;
+        id = require.id;
+    }
+
+    if (id.indexOf("text!") === 0) 
+        return;
+    
+    var req = function(deps, factory) {
+        return require(id, deps, factory);
+    }
+
+    require.modules[id] = {
+        factory: function() {
+            var module = {
+                exports: {}
+            };
+            var returnExports = factory(req, module.exports, module);
+            if (returnExports)
+                module.exports = returnExports;
+            return module;
+        }
+    };
+};
+
+function initBaseUrls(topLevelNamespaces) {
+    require.tlns = topLevelNamespaces;
+}
+
+function initSender() {
+
+    var EventEmitter = require(null, "ace/lib/event_emitter").EventEmitter;
+    var oop = require(null, "ace/lib/oop");
+    
+    var Sender = function() {};
+    
+    (function() {
+        
+        oop.implement(this, EventEmitter);
+                
+        this.callback = function(data, callbackId) {
+            postMessage({
+                type: "call",
+                id: callbackId,
+                data: data
+            });
+        };
+    
+        this.emit = function(name, data) {
+            postMessage({
+                type: "event",
+                name: name,
+                data: data
+            });
+        };
+        
+    }).call(Sender.prototype);
+    
+    return new Sender();
+}
+
+var main;
+var sender;
+
+onmessage = function(e) {
+    var msg = e.data;
+    if (msg.command) {
+        main[msg.command].apply(main, msg.args);
+    }
+    else if (msg.init) {        
+        initBaseUrls(msg.tlns);
+        require(null, "ace/lib/fixoldbrowsers");
+        sender = initSender();
+        var clazz = require(null, msg.module)[msg.classname];
+        main = new clazz(sender);
+    } 
+    else if (msg.event && sender) {
+        sender._dispatchEvent(msg.event, msg.data);
+    }
+};
+// vim:set ts=4 sts=4 sw=4 st:
+// -- kriskowal Kris Kowal Copyright (C) 2009-2010 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright(C) 2010 XXX No License Specified
+// -- fschaefer Florian Sch?fer Copyright (C) 2010 MIT License
+// -- Irakli Gozalishvili Copyright (C) 2010 MIT License
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/fixoldbrowsers', ['require', 'exports', 'module' , 'ace/lib/regexp', 'ace/lib/es5-shim'], function(require, exports, module) {
+
+require("./regexp");
+require("./es5-shim");
+
+});define('ace/lib/regexp', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+// Based on code from:
+//
+// XRegExp 1.5.0
+// (c) 2007-2010 Steven Levithan
+// MIT License
+// <http://xregexp.com>
+// Provides an augmented, extensible, cross-browser implementation of regular expressions,
+// including support for additional syntax, flags, and methods
+
+    //---------------------------------
+    //  Private variables
+    //---------------------------------
+
+    var real = {
+            exec: RegExp.prototype.exec,
+            test: RegExp.prototype.test,
+            match: String.prototype.match,
+            replace: String.prototype.replace,
+            split: String.prototype.split
+        },
+        compliantExecNpcg = real.exec.call(/()??/, "")[1] === undefined, // check `exec` handling of nonparticipating capturing groups
+        compliantLastIndexIncrement = function () {
+            var x = /^/g;
+            real.test.call(x, "");
+            return !x.lastIndex;
+        }();
+
+    //---------------------------------
+    //  Overriden native methods
+    //---------------------------------
+
+    // Adds named capture support (with backreferences returned as `result.name`), and fixes two
+    // cross-browser issues per ES3:
+    // - Captured values for nonparticipating capturing groups should be returned as `undefined`,
+    //   rather than the empty string.
+    // - `lastIndex` should not be incremented after zero-length matches.
+    RegExp.prototype.exec = function (str) {
+        var match = real.exec.apply(this, arguments),
+            name, r2;
+        if (match) {
+            // Fix browsers whose `exec` methods don't consistently return `undefined` for
+            // nonparticipating capturing groups
+            if (!compliantExecNpcg && match.length > 1 && indexOf(match, "") > -1) {
+                r2 = RegExp(this.source, real.replace.call(getNativeFlags(this), "g", ""));
+                // Using `str.slice(match.index)` rather than `match[0]` in case lookahead allowed
+                // matching due to characters outside the match
+                real.replace.call(str.slice(match.index), r2, function () {
+                    for (var i = 1; i < arguments.length - 2; i++) {
+                        if (arguments[i] === undefined)
+                            match[i] = undefined;
+                    }
+                });
+            }
+            // Attach named capture properties
+            if (this._xregexp && this._xregexp.captureNames) {
+                for (var i = 1; i < match.length; i++) {
+                    name = this._xregexp.captureNames[i - 1];
+                    if (name)
+                       match[name] = match[i];
+                }
+            }
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (!compliantLastIndexIncrement && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+        }
+        return match;
+    };
+
+    // Don't override `test` if it won't change anything
+    if (!compliantLastIndexIncrement) {
+        // Fix browser bug in native method
+        RegExp.prototype.test = function (str) {
+            // Use the native `exec` to skip some processing overhead, even though the overriden
+            // `exec` would take care of the `lastIndex` fix
+            var match = real.exec.call(this, str);
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (match && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+            return !!match;
+        };
+    }
+
+    //---------------------------------
+    //  Private helper functions
+    //---------------------------------
+
+    function getNativeFlags (regex) {
+        return (regex.global     ? "g" : "") +
+               (regex.ignoreCase ? "i" : "") +
+               (regex.multiline  ? "m" : "") +
+               (regex.extended   ? "x" : "") + // Proposed for ES4; included in AS3
+               (regex.sticky     ? "y" : "");
+    };
+
+    function indexOf (array, item, from) {
+        if (Array.prototype.indexOf) // Use the native array method if available
+            return array.indexOf(item, from);
+        for (var i = from || 0; i < array.length; i++) {
+            if (array[i] === item)
+                return i;
+        }
+        return -1;
+    };
+
+});// vim: ts=4 sts=4 sw=4 expandtab
+// -- kriskowal Kris Kowal Copyright (C) 2009-2011 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright (C) 2010 XXX TODO License or CLA
+// -- fschaefer Florian Sch?fer Copyright (C) 2010 MIT License
+// -- Gozala Irakli Gozalishvili Copyright (C) 2010 MIT License
+// -- kitcambridge Kit Cambridge Copyright (C) 2011 MIT License
+// -- kossnocorp Sasha Koss XXX TODO License or CLA
+// -- bryanforbes Bryan Forbes XXX TODO License or CLA
+// -- killdream Quildreen Motta Copyright (C) 2011 MIT Licence
+// -- michaelficarra Michael Ficarra Copyright (C) 2011 3-clause BSD License
+// -- sharkbrainguy Gerard Paapu Copyright (C) 2011 MIT License
+// -- bbqsrc Brendan Molloy (C) 2011 Creative Commons Zero (public domain)
+// -- iwyg XXX TODO License or CLA
+// -- DomenicDenicola Domenic Denicola Copyright (C) 2011 MIT License
+// -- xavierm02 Montillet Xavier XXX TODO License or CLA
+// -- Raynos Raynos XXX TODO License or CLA
+// -- samsonjs Sami Samhuri Copyright (C) 2010 MIT License
+// -- rwldrn Rick Waldron Copyright (C) 2011 MIT License
+// -- lexer Alexey Zakharov XXX TODO License or CLA
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/es5-shim', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+/**
+ * Brings an environment as close to ECMAScript 5 compliance
+ * as is possible with the facilities of erstwhile engines.
+ *
+ * Annotated ES5: http://es5.github.com/ (specific links below)
+ * ES5 Spec: http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf
+ *
+ * @module
+ */
+
+/*whatsupdoc*/
+
+//
+// Function
+// ========
+//
+
+// ES-5 15.3.4.5
+// http://es5.github.com/#x15.3.4.5
+
+if (!Function.prototype.bind) {
+    Function.prototype.bind = function bind(that) { // .length is 1
+        // 1. Let Target be the this value.
+        var target = this;
+        // 2. If IsCallable(Target) is false, throw a TypeError exception.
+        if (typeof target != "function")
+            throw new TypeError(); // TODO message
+        // 3. Let A be a new (possibly empty) internal list of all of the
+        //   argument values provided after thisArg (arg1, arg2 etc), in order.
+        // XXX slicedArgs will stand in for "A" if used
+        var args = slice.call(arguments, 1); // for normal call
+        // 4. Let F be a new native ECMAScript object.
+        // 11. Set the [[Prototype]] internal property of F to the standard
+        //   built-in Function prototype object as specified in 15.3.3.1.
+        // 12. Set the [[Call]] internal property of F as described in
+        //   15.3.4.5.1.
+        // 13. Set the [[Construct]] internal property of F as described in
+        //   15.3.4.5.2.
+        // 14. Set the [[HasInstance]] internal property of F as described in
+        //   15.3.4.5.3.
+        var bound = function () {
+
+            if (this instanceof bound) {
+                // 15.3.4.5.2 [[Construct]]
+                // When the [[Construct]] internal method of a function object,
+                // F that was created using the bind function is called with a
+                // list of arguments ExtraArgs, the following steps are taken:
+                // 1. Let target be the value of F's [[TargetFunction]]
+                //   internal property.
+                // 2. If target has no [[Construct]] internal method, a
+                //   TypeError exception is thrown.
+                // 3. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the
+                //   list boundArgs in the same order followed by the same
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Construct]] internal 
+                //   method of target providing args as the arguments.
+
+                var F = function(){};
+                F.prototype = target.prototype;
+                var self = new F;
+
+                var result = target.apply(
+                    self,
+                    args.concat(slice.call(arguments))
+                );
+                if (result !== null && Object(result) === result)
+                    return result;
+                return self;
+
+            } else {
+                // 15.3.4.5.1 [[Call]]
+                // When the [[Call]] internal method of a function object, F,
+                // which was created using the bind function is called with a
+                // this value and a list of arguments ExtraArgs, the following
+                // steps are taken:
+                // 1. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 2. Let boundThis be the value of F's [[BoundThis]] internal
+                //   property.
+                // 3. Let target be the value of F's [[TargetFunction]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the 
+                //   list boundArgs in the same order followed by the same 
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Call]] internal method 
+                //   of target providing boundThis as the this value and 
+                //   providing args as the arguments.
+
+                // equiv: target.call(this, ...boundArgs, ...args)
+                return target.apply(
+                    that,
+                    args.concat(slice.call(arguments))
+                );
+
+            }
+
+        };
+        // XXX bound.length is never writable, so don't even try
+        //
+        // 15. If the [[Class]] internal property of Target is "Function", then
+        //     a. Let L be the length property of Target minus the length of A.
+        //     b. Set the length own property of F to either 0 or L, whichever is 
+        //       larger.
+        // 16. Else set the length own property of F to 0.
+        // 17. Set the attributes of the length own property of F to the values
+        //   specified in 15.3.5.1.
+
+        // TODO
+        // 18. Set the [[Extensible]] internal property of F to true.
+        
+        // TODO
+        // 19. Let thrower be the [[ThrowTypeError]] function Object (13.2.3).
+        // 20. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "caller", PropertyDescriptor {[[Get]]: thrower, [[Set]]:
+        //   thrower, [[Enumerable]]: false, [[Configurable]]: false}, and 
+        //   false.
+        // 21. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "arguments", PropertyDescriptor {[[Get]]: thrower, 
+        //   [[Set]]: thrower, [[Enumerable]]: false, [[Configurable]]: false},
+        //   and false.
+
+        // TODO
+        // NOTE Function objects created using Function.prototype.bind do not 
+        // have a prototype property or the [[Code]], [[FormalParameters]], and
+        // [[Scope]] internal properties.
+        // XXX can't delete prototype in pure-js.
+
+        // 22. Return F.
+        return bound;
+    };
+}
+
+// Shortcut to an often accessed properties, in order to avoid multiple
+// dereference that costs universally.
+// _Please note: Shortcuts are defined after `Function.prototype.bind` as we
+// us it in defining shortcuts.
+var call = Function.prototype.call;
+var prototypeOfArray = Array.prototype;
+var prototypeOfObject = Object.prototype;
+var slice = prototypeOfArray.slice;
+var toString = call.bind(prototypeOfObject.toString);
+var owns = call.bind(prototypeOfObject.hasOwnProperty);
+
+// If JS engine supports accessors creating shortcuts.
+var defineGetter;
+var defineSetter;
+var lookupGetter;
+var lookupSetter;
+var supportsAccessors;
+if ((supportsAccessors = owns(prototypeOfObject, "__defineGetter__"))) {
+    defineGetter = call.bind(prototypeOfObject.__defineGetter__);
+    defineSetter = call.bind(prototypeOfObject.__defineSetter__);
+    lookupGetter = call.bind(prototypeOfObject.__lookupGetter__);
+    lookupSetter = call.bind(prototypeOfObject.__lookupSetter__);
+}
+
+//
+// Array
+// =====
+//
+
+// ES5 15.4.3.2
+// http://es5.github.com/#x15.4.3.2
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/isArray
+if (!Array.isArray) {
+    Array.isArray = function isArray(obj) {
+        return toString(obj) == "[object Array]";
+    };
+}
+
+// The IsCallable() check in the Array functions
+// has been replaced with a strict check on the
+// internal class of the object to trap cases where
+// the provided function was actually a regular
+// expression literal, which in V8 and
+// JavaScriptCore is a typeof "function".  Only in
+// V8 are regular expression literals permitted as
+// reduce parameters, so it is desirable in the
+// general case for the shim to match the more
+// strict and common behavior of rejecting regular
+// expressions.
+
+// ES5 15.4.4.18
+// http://es5.github.com/#x15.4.4.18
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/forEach
+if (!Array.prototype.forEach) {
+    Array.prototype.forEach = function forEach(fun /*, thisp*/) {
+        var self = toObject(this),
+            thisp = arguments[1],
+            i = 0,
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        while (i < length) {
+            if (i in self) {
+                // Invoke the callback function with call, passing arguments:
+                // context, property value, property key, thisArg object context
+                fun.call(thisp, self[i], i, self);
+            }
+            i++;
+        }
+    };
+}
+
+// ES5 15.4.4.19
+// http://es5.github.com/#x15.4.4.19
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/map
+if (!Array.prototype.map) {
+    Array.prototype.map = function map(fun /*, thisp*/) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = Array(length),
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self)
+                result[i] = fun.call(thisp, self[i], i, self);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.20
+// http://es5.github.com/#x15.4.4.20
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/filter
+if (!Array.prototype.filter) {
+    Array.prototype.filter = function filter(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = [],
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                result.push(self[i]);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.16
+// http://es5.github.com/#x15.4.4.16
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every
+if (!Array.prototype.every) {
+    Array.prototype.every = function every(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && !fun.call(thisp, self[i], i, self))
+                return false;
+        }
+        return true;
+    };
+}
+
+// ES5 15.4.4.17
+// http://es5.github.com/#x15.4.4.17
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/some
+if (!Array.prototype.some) {
+    Array.prototype.some = function some(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                return true;
+        }
+        return false;
+    };
+}
+
+// ES5 15.4.4.21
+// http://es5.github.com/#x15.4.4.21
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduce
+if (!Array.prototype.reduce) {
+    Array.prototype.reduce = function reduce(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value and an empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var i = 0;
+        var result;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i++];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (++i >= length)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        for (; i < length; i++) {
+            if (i in self)
+                result = fun.call(void 0, result, self[i], i, self);
+        }
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.22
+// http://es5.github.com/#x15.4.4.22
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduceRight
+if (!Array.prototype.reduceRight) {
+    Array.prototype.reduceRight = function reduceRight(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value, empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var result, i = length - 1;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i--];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (--i < 0)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        do {
+            if (i in this)
+                result = fun.call(void 0, result, self[i], i, self);
+        } while (i--);
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.14
+// http://es5.github.com/#x15.4.4.14
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/indexOf
+if (!Array.prototype.indexOf) {
+    Array.prototype.indexOf = function indexOf(sought /*, fromIndex */ ) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+
+        var i = 0;
+        if (arguments.length > 1)
+            i = toInteger(arguments[1]);
+
+        // handle negative indices
+        i = i >= 0 ? i : Math.max(0, length + i);
+        for (; i < length; i++) {
+            if (i in self && self[i] === sought) {
+                return i;
+            }
+        }
+        return -1;
+    };
+}
+
+// ES5 15.4.4.15
+// http://es5.github.com/#x15.4.4.15
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/lastIndexOf
+if (!Array.prototype.lastIndexOf) {
+    Array.prototype.lastIndexOf = function lastIndexOf(sought /*, fromIndex */) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+        var i = length - 1;
+        if (arguments.length > 1)
+            i = Math.min(i, toInteger(arguments[1]));
+        // handle negative indices
+        i = i >= 0 ? i : length - Math.abs(i);
+        for (; i >= 0; i--) {
+            if (i in self && sought === self[i])
+                return i;
+        }
+        return -1;
+    };
+}
+
+//
+// Object
+// ======
+//
+
+// ES5 15.2.3.2
+// http://es5.github.com/#x15.2.3.2
+if (!Object.getPrototypeOf) {
+    // https://github.com/kriskowal/es5-shim/issues#issue/2
+    // http://ejohn.org/blog/objectgetprototypeof/
+    // recommended by fschaefer on github
+    Object.getPrototypeOf = function getPrototypeOf(object) {
+        return object.__proto__ || (
+            object.constructor ?
+            object.constructor.prototype :
+            prototypeOfObject
+        );
+    };
+}
+
+// ES5 15.2.3.3
+// http://es5.github.com/#x15.2.3.3
+if (!Object.getOwnPropertyDescriptor) {
+    var ERR_NON_OBJECT = "Object.getOwnPropertyDescriptor called on a " +
+                         "non-object: ";
+    Object.getOwnPropertyDescriptor = function getOwnPropertyDescriptor(object, property) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT + object);
+        // If object does not owns property return undefined immediately.
+        if (!owns(object, property))
+            return;
+
+        var descriptor, getter, setter;
+
+        // If object has a property then it's for sure both `enumerable` and
+        // `configurable`.
+        descriptor =  { enumerable: true, configurable: true };
+
+        // If JS engine supports accessor properties then property may be a
+        // getter or setter.
+        if (supportsAccessors) {
+            // Unfortunately `__lookupGetter__` will return a getter even
+            // if object has own non getter property along with a same named
+            // inherited getter. To avoid misbehavior we temporary remove
+            // `__proto__` so that `__lookupGetter__` will return getter only
+            // if it's owned by an object.
+            var prototype = object.__proto__;
+            object.__proto__ = prototypeOfObject;
+
+            var getter = lookupGetter(object, property);
+            var setter = lookupSetter(object, property);
+
+            // Once we have getter and setter we can put values back.
+            object.__proto__ = prototype;
+
+            if (getter || setter) {
+                if (getter) descriptor.get = getter;
+                if (setter) descriptor.set = setter;
+
+                // If it was accessor property we're done and return here
+                // in order to avoid adding `value` to the descriptor.
+                return descriptor;
+            }
+        }
+
+        // If we got this far we know that object has an own property that is
+        // not an accessor so we set it as a value and return descriptor.
+        descriptor.value = object[property];
+        return descriptor;
+    };
+}
+
+// ES5 15.2.3.4
+// http://es5.github.com/#x15.2.3.4
+if (!Object.getOwnPropertyNames) {
+    Object.getOwnPropertyNames = function getOwnPropertyNames(object) {
+        return Object.keys(object);
+    };
+}
+
+// ES5 15.2.3.5
+// http://es5.github.com/#x15.2.3.5
+if (!Object.create) {
+    Object.create = function create(prototype, properties) {
+        var object;
+        if (prototype === null) {
+            object = { "__proto__": null };
+        } else {
+            if (typeof prototype != "object")
+                throw new TypeError("typeof prototype["+(typeof prototype)+"] != 'object'");
+            var Type = function () {};
+            Type.prototype = prototype;
+            object = new Type();
+            // IE has no built-in implementation of `Object.getPrototypeOf`
+            // neither `__proto__`, but this manually setting `__proto__` will
+            // guarantee that `Object.getPrototypeOf` will work as expected with
+            // objects created using `Object.create`
+            object.__proto__ = prototype;
+        }
+        if (properties !== void 0)
+            Object.defineProperties(object, properties);
+        return object;
+    };
+}
+
+// ES5 15.2.3.6
+// http://es5.github.com/#x15.2.3.6
+
+// Patch for WebKit and IE8 standard mode
+// Designed by hax <hax.github.com>
+// related issue: https://github.com/kriskowal/es5-shim/issues#issue/5
+// IE8 Reference:
+//     http://msdn.microsoft.com/en-us/library/dd282900.aspx
+//     http://msdn.microsoft.com/en-us/library/dd229916.aspx
+// WebKit Bugs:
+//     https://bugs.webkit.org/show_bug.cgi?id=36423
+
+function doesDefinePropertyWork(object) {
+    try {
+        Object.defineProperty(object, "sentinel", {});
+        return "sentinel" in object;
+    } catch (exception) {
+        // returns falsy
+    }
+}
+
+// check whether defineProperty works if it's given. Otherwise,
+// shim partially.
+if (Object.defineProperty) {
+    var definePropertyWorksOnObject = doesDefinePropertyWork({});
+    var definePropertyWorksOnDom = typeof document == "undefined" ||
+        doesDefinePropertyWork(document.createElement("div"));
+    if (!definePropertyWorksOnObject || !definePropertyWorksOnDom) {
+        var definePropertyFallback = Object.defineProperty;
+    }
+}
+
+if (!Object.defineProperty || definePropertyFallback) {
+    var ERR_NON_OBJECT_DESCRIPTOR = "Property description must be an object: ";
+    var ERR_NON_OBJECT_TARGET = "Object.defineProperty called on non-object: "
+    var ERR_ACCESSORS_NOT_SUPPORTED = "getters & setters can not be defined " +
+                                      "on this javascript engine";
+
+    Object.defineProperty = function defineProperty(object, property, descriptor) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT_TARGET + object);
+        if ((typeof descriptor != "object" && typeof descriptor != "function") || descriptor === null)
+            throw new TypeError(ERR_NON_OBJECT_DESCRIPTOR + descriptor);
+
+        // make a valiant attempt to use the real defineProperty
+        // for I8's DOM elements.
+        if (definePropertyFallback) {
+            try {
+                return definePropertyFallback.call(Object, object, property, descriptor);
+            } catch (exception) {
+                // try the shim if the real one doesn't work
+            }
+        }
+
+        // If it's a data property.
+        if (owns(descriptor, "value")) {
+            // fail silently if "writable", "enumerable", or "configurable"
+            // are requested but not supported
+            /*
+            // alternate approach:
+            if ( // can't implement these features; allow false but not true
+                !(owns(descriptor, "writable") ? descriptor.writable : true) ||
+                !(owns(descriptor, "enumerable") ? descriptor.enumerable : true) ||
+                !(owns(descriptor, "configurable") ? descriptor.configurable : true)
+            )
+                throw new RangeError(
+                    "This implementation of Object.defineProperty does not " +
+                    "support configurable, enumerable, or writable."
+                );
+            */
+
+            if (supportsAccessors && (lookupGetter(object, property) ||
+                                      lookupSetter(object, property)))
+            {
+                // As accessors are supported only on engines implementing
+                // `__proto__` we can safely override `__proto__` while defining
+                // a property to make sure that we don't hit an inherited
+                // accessor.
+                var prototype = object.__proto__;
+                object.__proto__ = prototypeOfObject;
+                // Deleting a property anyway since getter / setter may be
+                // defined on object itself.
+                delete object[property];
+                object[property] = descriptor.value;
+                // Setting original `__proto__` back now.
+                object.__proto__ = prototype;
+            } else {
+                object[property] = descriptor.value;
+            }
+        } else {
+            if (!supportsAccessors)
+                throw new TypeError(ERR_ACCESSORS_NOT_SUPPORTED);
+            // If we got that far then getters and setters can be defined !!
+            if (owns(descriptor, "get"))
+                defineGetter(object, property, descriptor.get);
+            if (owns(descriptor, "set"))
+                defineSetter(object, property, descriptor.set);
+        }
+
+        return object;
+    };
+}
+
+// ES5 15.2.3.7
+// http://es5.github.com/#x15.2.3.7
+if (!Object.defineProperties) {
+    Object.defineProperties = function defineProperties(object, properties) {
+        for (var property in properties) {
+            if (owns(properties, property))
+                Object.defineProperty(object, property, properties[property]);
+        }
+        return object;
+    };
+}
+
+// ES5 15.2.3.8
+// http://es5.github.com/#x15.2.3.8
+if (!Object.seal) {
+    Object.seal = function seal(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.9
+// http://es5.github.com/#x15.2.3.9
+if (!Object.freeze) {
+    Object.freeze = function freeze(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// detect a Rhino bug and patch it
+try {
+    Object.freeze(function () {});
+} catch (exception) {
+    Object.freeze = (function freeze(freezeObject) {
+        return function freeze(object) {
+            if (typeof object == "function") {
+                return object;
+            } else {
+                return freezeObject(object);
+            }
+        };
+    })(Object.freeze);
+}
+
+// ES5 15.2.3.10
+// http://es5.github.com/#x15.2.3.10
+if (!Object.preventExtensions) {
+    Object.preventExtensions = function preventExtensions(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.11
+// http://es5.github.com/#x15.2.3.11
+if (!Object.isSealed) {
+    Object.isSealed = function isSealed(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.12
+// http://es5.github.com/#x15.2.3.12
+if (!Object.isFrozen) {
+    Object.isFrozen = function isFrozen(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.13
+// http://es5.github.com/#x15.2.3.13
+if (!Object.isExtensible) {
+    Object.isExtensible = function isExtensible(object) {
+        // 1. If Type(O) is not Object throw a TypeError exception.
+        if (Object(object) === object) {
+            throw new TypeError(); // TODO message
+        }
+        // 2. Return the Boolean value of the [[Extensible]] internal property of O.
+        var name = '';
+        while (owns(object, name)) {
+            name += '?';
+        }
+        object[name] = true;
+        var returnValue = owns(object, name);
+        delete object[name];
+        return returnValue;
+    };
+}
+
+// ES5 15.2.3.14
+// http://es5.github.com/#x15.2.3.14
+if (!Object.keys) {
+    // http://whattheheadsaid.com/2010/10/a-safer-object-keys-compatibility-implementation
+    var hasDontEnumBug = true,
+        dontEnums = [
+            "toString",
+            "toLocaleString",
+            "valueOf",
+            "hasOwnProperty",
+            "isPrototypeOf",
+            "propertyIsEnumerable",
+            "constructor"
+        ],
+        dontEnumsLength = dontEnums.length;
+
+    for (var key in {"toString": null})
+        hasDontEnumBug = false;
+
+    Object.keys = function keys(object) {
+
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError("Object.keys called on a non-object");
+
+        var keys = [];
+        for (var name in object) {
+            if (owns(object, name)) {
+                keys.push(name);
+            }
+        }
+
+        if (hasDontEnumBug) {
+            for (var i = 0, ii = dontEnumsLength; i < ii; i++) {
+                var dontEnum = dontEnums[i];
+                if (owns(object, dontEnum)) {
+                    keys.push(dontEnum);
+                }
+            }
+        }
+
+        return keys;
+    };
+
+}
+
+//
+// Date
+// ====
+//
+
+// ES5 15.9.5.43
+// http://es5.github.com/#x15.9.5.43
+// This function returns a String value represent the instance in time 
+// represented by this Date object. The format of the String is the Date Time 
+// string format defined in 15.9.1.15. All fields are present in the String. 
+// The time zone is always UTC, denoted by the suffix Z. If the time value of 
+// this object is not a finite Number a RangeError exception is thrown.
+if (!Date.prototype.toISOString || (new Date(-62198755200000).toISOString().indexOf('-000001') === -1)) {
+    Date.prototype.toISOString = function toISOString() {
+        var result, length, value, year;
+        if (!isFinite(this))
+            throw new RangeError;
+
+        // the date time string format is specified in 15.9.1.15.
+        result = [this.getUTCMonth() + 1, this.getUTCDate(),
+            this.getUTCHours(), this.getUTCMinutes(), this.getUTCSeconds()];
+        year = this.getUTCFullYear();
+        year = (year < 0 ? '-' : (year > 9999 ? '+' : '')) + ('00000' + Math.abs(year)).slice(0 <= year && year <= 9999 ? -4 : -6);
+
+        length = result.length;
+        while (length--) {
+            value = result[length];
+            // pad months, days, hours, minutes, and seconds to have two digits.
+            if (value < 10)
+                result[length] = "0" + value;
+        }
+        // pad milliseconds to have three digits.
+        return year + "-" + result.slice(0, 2).join("-") + "T" + result.slice(2).join(":") + "." +
+            ("000" + this.getUTCMilliseconds()).slice(-3) + "Z";
+    }
+}
+
+// ES5 15.9.4.4
+// http://es5.github.com/#x15.9.4.4
+if (!Date.now) {
+    Date.now = function now() {
+        return new Date().getTime();
+    };
+}
+
+// ES5 15.9.5.44
+// http://es5.github.com/#x15.9.5.44
+// This function provides a String representation of a Date object for use by 
+// JSON.stringify (15.12.3).
+if (!Date.prototype.toJSON) {
+    Date.prototype.toJSON = function toJSON(key) {
+        // When the toJSON method is called with argument key, the following 
+        // steps are taken:
+
+        // 1.  Let O be the result of calling ToObject, giving it the this
+        // value as its argument.
+        // 2. Let tv be ToPrimitive(O, hint Number).
+        // 3. If tv is a Number and is not finite, return null.
+        // XXX
+        // 4. Let toISO be the result of calling the [[Get]] internal method of
+        // O with argument "toISOString".
+        // 5. If IsCallable(toISO) is false, throw a TypeError exception.
+        if (typeof this.toISOString != "function")
+            throw new TypeError(); // TODO message
+        // 6. Return the result of calling the [[Call]] internal method of
+        //  toISO with O as the this value and an empty argument list.
+        return this.toISOString();
+
+        // NOTE 1 The argument is ignored.
+
+        // NOTE 2 The toJSON function is intentionally generic; it does not
+        // require that its this value be a Date object. Therefore, it can be
+        // transferred to other kinds of objects for use as a method. However,
+        // it does require that any such object have a toISOString method. An
+        // object is free to use the argument key to filter its
+        // stringification.
+    };
+}
+
+// ES5 15.9.4.2
+// http://es5.github.com/#x15.9.4.2
+// based on work shared by Daniel Friesen (dantman)
+// http://gist.github.com/303249
+if (Date.parse("+275760-09-13T00:00:00.000Z") !== 8.64e15) {
+    // XXX global assignment won't work in embeddings that use
+    // an alternate object for the context.
+    Date = (function(NativeDate) {
+
+        // Date.length === 7
+        var Date = function Date(Y, M, D, h, m, s, ms) {
+            var length = arguments.length;
+            if (this instanceof NativeDate) {
+                var date = length == 1 && String(Y) === Y ? // isString(Y)
+                    // We explicitly pass it through parse:
+                    new NativeDate(Date.parse(Y)) :
+                    // We have to manually make calls depending on argument
+                    // length here
+                    length >= 7 ? new NativeDate(Y, M, D, h, m, s, ms) :
+                    length >= 6 ? new NativeDate(Y, M, D, h, m, s) :
+                    length >= 5 ? new NativeDate(Y, M, D, h, m) :
+                    length >= 4 ? new NativeDate(Y, M, D, h) :
+                    length >= 3 ? new NativeDate(Y, M, D) :
+                    length >= 2 ? new NativeDate(Y, M) :
+                    length >= 1 ? new NativeDate(Y) :
+                                  new NativeDate();
+                // Prevent mixups with unfixed Date object
+                date.constructor = Date;
+                return date;
+            }
+            return NativeDate.apply(this, arguments);
+        };
+
+        // 15.9.1.15 Date Time String Format.
+        var isoDateExpression = new RegExp("^" +
+            "(\\d{4}|[\+\-]\\d{6})" + // four-digit year capture or sign + 6-digit extended year
+            "(?:-(\\d{2})" + // optional month capture
+            "(?:-(\\d{2})" + // optional day capture
+            "(?:" + // capture hours:minutes:seconds.milliseconds
+                "T(\\d{2})" + // hours capture
+                ":(\\d{2})" + // minutes capture
+                "(?:" + // optional :seconds.milliseconds
+                    ":(\\d{2})" + // seconds capture
+                    "(?:\\.(\\d{3}))?" + // milliseconds capture
+                ")?" +
+            "(?:" + // capture UTC offset component
+                "Z|" + // UTC capture
+                "(?:" + // offset specifier +/-hours:minutes
+                    "([-+])" + // sign capture
+                    "(\\d{2})" + // hours offset capture
+                    ":(\\d{2})" + // minutes offset capture
+                ")" +
+            ")?)?)?)?" +
+        "$");
+
+        // Copy any custom methods a 3rd party library may have added
+        for (var key in NativeDate)
+            Date[key] = NativeDate[key];
+
+        // Copy "native" methods explicitly; they may be non-enumerable
+        Date.now = NativeDate.now;
+        Date.UTC = NativeDate.UTC;
+        Date.prototype = NativeDate.prototype;
+        Date.prototype.constructor = Date;
+
+        // Upgrade Date.parse to handle simplified ISO 8601 strings
+        Date.parse = function parse(string) {
+            var match = isoDateExpression.exec(string);
+            if (match) {
+                match.shift(); // kill match[0], the full match
+                // parse months, days, hours, minutes, seconds, and milliseconds
+                for (var i = 1; i < 7; i++) {
+                    // provide default values if necessary
+                    match[i] = +(match[i] || (i < 3 ? 1 : 0));
+                    // match[1] is the month. Months are 0-11 in JavaScript
+                    // `Date` objects, but 1-12 in ISO notation, so we
+                    // decrement.
+                    if (i == 1)
+                        match[i]--;
+                }
+
+                // parse the UTC offset component
+                var minuteOffset = +match.pop(), hourOffset = +match.pop(), sign = match.pop();
+
+                // compute the explicit time zone offset if specified
+                var offset = 0;
+                if (sign) {
+                    // detect invalid offsets and return early
+                    if (hourOffset > 23 || minuteOffset > 59)
+                        return NaN;
+
+                    // express the provided time zone offset in minutes. The offset is
+                    // negative for time zones west of UTC; positive otherwise.
+                    offset = (hourOffset * 60 + minuteOffset) * 6e4 * (sign == "+" ? -1 : 1);
+                }
+
+                // Date.UTC for years between 0 and 99 converts year to 1900 + year
+                // The Gregorian calendar has a 400-year cycle, so 
+                // to Date.UTC(year + 400, .... ) - 12622780800000 == Date.UTC(year, ...),
+                // where 12622780800000 - number of milliseconds in Gregorian calendar 400 years
+                var year = +match[0];
+                if (0 <= year && year <= 99) {
+                    match[0] = year + 400;
+                    return NativeDate.UTC.apply(this, match) + offset - 12622780800000;
+                }
+
+                // compute a new UTC date value, accounting for the optional offset
+                return NativeDate.UTC.apply(this, match) + offset;
+            }
+            return NativeDate.parse.apply(this, arguments);
+        };
+
+        return Date;
+    })(Date);
+}
+
+//
+// String
+// ======
+//
+
+// ES5 15.5.4.20
+// http://es5.github.com/#x15.5.4.20
+var ws = "\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003" +
+    "\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028" +
+    "\u2029\uFEFF";
+if (!String.prototype.trim || ws.trim()) {
+    // http://blog.stevenlevithan.com/archives/faster-trim-javascript
+    // http://perfectionkills.com/whitespace-deviations/
+    ws = "[" + ws + "]";
+    var trimBeginRegexp = new RegExp("^" + ws + ws + "*"),
+        trimEndRegexp = new RegExp(ws + ws + "*$");
+    String.prototype.trim = function trim() {
+        return String(this).replace(trimBeginRegexp, "").replace(trimEndRegexp, "");
+    };
+}
+
+//
+// Util
+// ======
+//
+
+// ES5 9.4
+// http://es5.github.com/#x9.4
+// http://jsperf.com/to-integer
+var toInteger = function (n) {
+    n = +n;
+    if (n !== n) // isNaN
+        n = 0;
+    else if (n !== 0 && n !== (1/0) && n !== -(1/0))
+        n = (n > 0 || -1) * Math.floor(Math.abs(n));
+    return n;
+};
+
+var prepareString = "a"[0] != "a",
+    // ES5 9.9
+    // http://es5.github.com/#x9.9
+    toObject = function (o) {
+        if (o == null) { // this matches both null and undefined
+            throw new TypeError(); // TODO message
+        }
+        // If the implementation doesn't support by-index access of
+        // string characters (ex. IE < 7), split the string
+        if (prepareString && typeof o == "string" && o) {
+            return o.split("");
+        }
+        return Object(o);
+    };
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Mike de Boer <mike AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/event_emitter', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var EventEmitter = {};
+
+EventEmitter._emit =
+EventEmitter._dispatchEvent = function(eventName, e) {
+    this._eventRegistry = this._eventRegistry || {};
+    this._defaultHandlers = this._defaultHandlers || {};
+
+    var listeners = this._eventRegistry[eventName] || [];
+    var defaultHandler = this._defaultHandlers[eventName];
+    if (!listeners.length && !defaultHandler)
+        return;
+
+    e = e || {};
+    e.type = eventName;
+    
+    if (!e.stopPropagation) {
+        e.stopPropagation = function() {
+            this.propagationStopped = true;
+        };
+    }
+    
+    if (!e.preventDefault) {
+        e.preventDefault = function() {
+            this.defaultPrevented = true;
+        };
+    }
+
+    for (var i=0; i<listeners.length; i++) {
+        listeners[i](e);
+        if (e.propagationStopped)
+            break;
+    }
+    
+    if (defaultHandler && !e.defaultPrevented)
+        defaultHandler(e);
+};
+
+EventEmitter.setDefaultHandler = function(eventName, callback) {
+    this._defaultHandlers = this._defaultHandlers || {};
+    
+    if (this._defaultHandlers[eventName])
+        throw new Error("The default handler for '" + eventName + "' is already set");
+        
+    this._defaultHandlers[eventName] = callback;
+};
+
+EventEmitter.on =
+EventEmitter.addEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        var listeners = this._eventRegistry[eventName] = [];
+
+    if (listeners.indexOf(callback) == -1)
+        listeners.push(callback);
+};
+
+EventEmitter.removeListener =
+EventEmitter.removeEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        return;
+
+    var index = listeners.indexOf(callback);
+    if (index !== -1)
+        listeners.splice(index, 1);
+};
+
+EventEmitter.removeAllListeners = function(eventName) {
+    if (this._eventRegistry) this._eventRegistry[eventName] = [];
+};
+
+exports.EventEmitter = EventEmitter;
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/oop', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+exports.inherits = (function() {
+    var tempCtor = function() {};
+    return function(ctor, superCtor) {
+        tempCtor.prototype = superCtor.prototype;
+        ctor.super_ = superCtor.prototype;
+        ctor.prototype = new tempCtor();
+        ctor.prototype.constructor = ctor;
+    }
+}());
+
+exports.mixin = function(obj, mixin) {
+    for (var key in mixin) {
+        obj[key] = mixin[key];
+    }
+};
+
+exports.implement = function(proto, mixin) {
+    exports.mixin(proto, mixin);
+};
+
+});
+
+
+define('ace/mode/spoofax2ace_worker', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/worker/mirror'], 
+function(require, exports, module) { 
+	var oop = require("ace/lib/oop"); 
+	var Mirror = require("ace/worker/mirror").Mirror; 
+
+	var working = false;
+	var goAgain = false;
+	var SpoofaxToAceWorker = exports.SpoofaxToAceWorker = function(sender) {
+	    $self.sender = sender;
+	    this.setTimeout(100);
+	    Mirror.call(this, sender);
+	};
+
+
+oop.inherits(SpoofaxToAceWorker, Mirror); (function() {
+
+
+        this.log = function(value) {
+            if(typeof(console) !== 'undefined' && console.log !== undefined) {
+                console.log(value);
+            } else {
+                sender.emit("log", value);
+            }
+        }
+	
+        this.load = function() {
+        }
+        
+		this.onUpdate = function()
+		{
+			this.delegateWork();
+		}
+
+
+        
\ No newline at end of file

Added: spoofax-ace/resources/javascript/partitioner.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/javascript/partitioner.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,11 @@
+/*
+ * This contains logic to decide whether to calc stuff locally or remotely.
+ */
+
+this.delegateWork = function()
+{
+	if (false)
+		this.s2alocal();
+	else
+		this.s2aclient();
+}
\ No newline at end of file

Added: spoofax-ace/resources/javascript/s2aclient.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/javascript/s2aclient.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,132 @@
+
+var s2aclient_loading=false;
+var s2aclient_loaded=false;
+var s2aclient_start;
+
+this.s2aclient = function() {
+	console.log("s2aclient");
+	if (!s2aclient_loaded)
+	{
+		sender.emit("log", "Not yet loaded...");
+		if (!s2aclient_loading)
+		{
+			s2aclient_loading = true;
+			s2awebsocket.connect();
+			s2aclient_loaded = true;
+			s2aclient_loading = false;
+		}
+		return;
+	}
+    	if (working)
+    	{
+	        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+	var value = this.doc.getValue();
+	s2aclient_start = new Date().getTime();
+	
+	s2awebsocket.send(value);
+
+	working = false;
+	if (goAgain)
+		onUpdate();
+}
+
+var updateTokens = function(x)
+{
+  sender.emit("jsglr", x);
+  var elapsed = (new Date().getTime() - s2aclient_start);
+  sender.emit("log", "Full client-server cycle took: " +  elapsed + "ms");
+
+}
+
+
+
+var s2awebsocket = {
+	msgIdx : 0,
+	s2aserverurl : 'ws://richard.vogelij.nl:8080/s2aserver',
+	measuretimetoanswer : function() {
+		time = new Date().getTime();
+	},
+	connect : function() {
+		var location = s2awebsocket.s2aserverurl;
+		this._ws = new WebSocket(location);
+		this._ws.onopen = this._onopen;
+		this._ws.onmessage = this._onmessage;
+		this._ws.onclose = this._onclose;
+	},
+	_onopen : function() {
+		s2awebsocket._send('websockets are open for communications!');
+	},
+	_send : function(message) {
+		this.msgIdx++;
+		if (this.msgIdx >= 9999)
+			this.msgIdx = 0;
+		var MAXLEN = 16385 - 4 - 4 - 4; //prepending fragments with three 4-digit based numbers -> MSGID+FRAGMENTIDX+TOTALFRAGMENTS
+		var length = message.length;
+		var fragmentcount = Math.ceil(length / MAXLEN);
+		var curfragment = 1;
+		
+		if (fragmentcount > 9999)
+		{
+			alert('data too large for protocol');
+			return;
+		}
+		for (curfragment=1; curfragment < fragmentcount+1; curfragment++)
+		{
+			fragment = 
+				s2awebsocket.lz(this.msgIdx,4)+
+				s2awebsocket.lz(curfragment,4)+
+				s2awebsocket.lz(fragmentcount,4)+
+				message.substring((curfragment-1)*MAXLEN, (curfragment)*MAXLEN);
+			if (this._ws)
+			{
+				this._ws.send(fragment);
+			}
+		}
+	},
+
+	send : function(text) {
+		
+		if (text != null && text.length > 0)
+		{
+			s2awebsocket._send(text);
+		}
+	},
+
+	_onmessage : function(m) {
+		if (m.data) {
+			console.log('Size of recieved message: ' + m.data.length);
+			//process recieved data
+			if (m.data == "Parse Error")
+			{
+				console.log("Parse error");
+				return;
+			}
+				
+			var obj;
+			try
+			{
+				obj = JSON.parse(m.data);
+			} catch (exception)
+			{
+				console.log("json parse error");
+				console.log(m.data);
+				console.log(exception);
+			}
+			updateTokens(obj);
+		}
+	},
+	_onclose : function(m) {
+		this._ws = null;
+	},
+	lz : function(number, length) {
+			var str = '' + number;
+			while (str.length < length) {
+				str = '0' + str;
+			}
+			return str;
+	}			
+};

Added: spoofax-ace/resources/javascript/s2alocal.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/javascript/s2alocal.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,78 @@
+
+var s2alocal_loading=false;
+var s2alocal_loaded=false;
+var s2alocal_analyzer=null;
+
+this.s2alocal = function() {
+	console.log("s2alocal");
+    if (!s2alocal_loaded)
+    {
+		sender.emit("log", "Not yet loaded...");
+		if (!s2alocal_loading)
+		{
+			s2alocal_loading = true;
+			var start = new Date().getTime();
+			s2alocal_analyzer = StrategoJS.init();
+			s2alocal_loaded = true;
+			s2alocal_loading = false;
+			var elapsed = (new Date().getTime() - start);
+		    sender.emit("log", "loaded. (" +  elapsed + ")");
+		    this.s2alocal();
+		}
+		return;
+	}
+    	if (working)
+    	{
+	        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+    	goAgain = false;
+	sender.emit("log", "spoofax2ace_worker.onUpdate enter");
+	var analyze_start = new Date().getTime();
+	var value = this.doc.getValue();
+	value = value.replace(/^#!.*\n/, "\n");
+	var result = null;
+	try
+	{
+		result = s2alocal_analyzer.main(["aap", value]);
+	}
+	catch (exception)
+	{
+		sender.emit("log", "Error while analyzing: " + exception.message);
+		sender.emit("log", "Stack: " + exception.stack);
+		debugger;
+	}
+
+
+	if (result === null)
+	{
+		sender.emit("log", "Error while analyzing");
+		working = false;
+		return;
+	}
+	var splitlines = value.split('\n');
+	var length = result.tokens.length;
+	var parsed = [];
+	for(var i = 0; i < length; i++) {
+	    var line = splitlines[i];
+	    var tokens = result.tokens[i];
+	    parsed[i] = {text: line, tokens: tokens};
+	}
+
+
+	sender.emit("jsglr", {
+	    parsed: parsed,
+	    errors: result.errors
+	});
+
+	var analyze_elapsed = (new Date().getTime() - analyze_start);
+
+	doneAnalyzing(length, analyze_elapsed);
+
+	sender.emit("log", "spoofax2ace_worker.onUpdate exit");
+	working = false;
+	if (goAgain)
+		this.s2alocal();
+}

Added: spoofax-ace/resources/javascript/stats.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/resources/javascript/stats.js	Thu May  3 20:57:51 2012	(r24784)
@@ -0,0 +1,31 @@
+	/*
+	 *  Statistics collecting start
+	 */
+	var lastLineCount = 0;
+	var analyzeCount = 0;
+	var totalAnalyzeTime = 0;
+
+
+	var doneAnalyzing = function(lineCount, timeTaken)
+	{
+		if (lastLineCount !== lineCount)
+		{
+			lastLineCount = lineCount;
+			analyzeCount = 1;
+			totalAnalyzeTime = timeTaken;
+		} else
+		{
+			totalAnalyzeTime = totalAnalyzeTime + timeTaken;
+			analyzeCount = analyzeCount + 1;
+			sender.emit("log", "Analyzed " + lastLineCount +" lines " + analyzeCount + " times. cur:" + 
+				timeTaken + " avg: " + averageAnalyzeTime());
+		}
+	}
+
+	var averageAnalyzeTime = function() 
+	{
+	  return parseInt(totalAnalyzeTime/analyzeCount);
+	}
+	/*
+	 *  Statistics collecting end
+	 */
\ No newline at end of file

From richard at vogelij.nl  Thu May  3 23:00:07 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Thu, 03 May 2012 21:00:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24785 - in
	strategoxt-javascript-backend/trunk/src/javascript: . jssglr
Message-ID: <20120503210007.589A62B8035@mx2.tudelft.nl>

Author: rvogelij
Date: Thu May  3 21:00:07 2012
New Revision: 24785
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24785&sc=1

Log:
fixed bug in optimized termtype system

Modified:
   strategoxt-javascript-backend/trunk/src/javascript/jssglr/jssglr_prepend.js
   strategoxt-javascript-backend/trunk/src/javascript/ssl.js
   strategoxt-javascript-backend/trunk/src/javascript/strategojs.js

Modified: strategoxt-javascript-backend/trunk/src/javascript/jssglr/jssglr_prepend.js
==============================================================================
--- strategoxt-javascript-backend/trunk/src/javascript/jssglr/jssglr_prepend.js	Thu May  3 20:57:51 2012	(r24784)
+++ strategoxt-javascript-backend/trunk/src/javascript/jssglr/jssglr_prepend.js	Thu May  3 21:00:07 2012	(r24785)
@@ -7,7 +7,7 @@
 try
 {
 	
-	//if (navigator === undefined)
+	if (navigator === undefined)
 	{
 		navigator = {};
 		navigator.userAgent = 'node-js';

Modified: strategoxt-javascript-backend/trunk/src/javascript/ssl.js
==============================================================================
--- strategoxt-javascript-backend/trunk/src/javascript/ssl.js	Thu May  3 20:57:51 2012	(r24784)
+++ strategoxt-javascript-backend/trunk/src/javascript/ssl.js	Thu May  3 21:00:07 2012	(r24785)
@@ -707,6 +707,7 @@
 	}
 
 	StrategoJS.SSL.SSL_exit = function(ctx, currentTerm) {
+		debugger;
 		throw "Exit called";
 	}	
 
@@ -863,8 +864,8 @@
 					
 					if (editortoken !== undefined)
 					{
-						parser.addTokenToTable(editortoken.tokenLeft, errorType[i], error.head[1], errterm);
-						parser.addTokenToTable(editortoken.tokenRight, errorType[i], error.head[1], errterm);
+						parser.addTokenToTable(editortoken.tokenLeft, errorType[i], ctx.factory.stringValue(error.head[1]), errterm);
+						parser.addTokenToTable(editortoken.tokenRight, errorType[i], ctx.factory.stringValue(error.head[1]), errterm);
 					} else
 					{
 						//error without a token:( 

Modified: strategoxt-javascript-backend/trunk/src/javascript/strategojs.js
==============================================================================
--- strategoxt-javascript-backend/trunk/src/javascript/strategojs.js	Thu May  3 20:57:51 2012	(r24784)
+++ strategoxt-javascript-backend/trunk/src/javascript/strategojs.js	Thu May  3 21:00:07 2012	(r24785)
@@ -65,16 +65,16 @@
 	StrategoJS.trace = function(value) {
 		if (DEBUGMODE)
 		{
-			//StrategoJS.log(wrap(value, 'TRACE'));
+			StrategoJS.log(wrap(value, 'TRACE'));
 			//console.error(wrap(value, 'TRACE'));
 		}
 	};
 	StrategoJS.error = function(value) {
-		//StrategoJS.log(wrap(value, 'ERROR'));
+		StrategoJS.log(wrap(value, 'ERROR'));
 		//console.error(wrap(value, 'ERROR'));
 	};
 	StrategoJS.info = function(value) {
-		//StrategoJS.log(wrap(value, 'INFO'));
+		StrategoJS.log(wrap(value, 'INFO'));
 		//console.error(wrap(value, 'INFO'));
 	};
 	

From richard at vogelij.nl  Thu May  3 23:06:04 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Thu, 03 May 2012 21:06:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24786 - in
	spoofax/trunk/spoofax/org.spoofax.jssglr: .settings
	src/org/spoofax/jssglr/client src/org/spoofax/jssglr/client/services
	src/org/spoofax/jssglr/gwt/org/spoofax/...
Message-ID: <20120503210604.B43C8CC189@mx4.tudelft.nl>

Author: rvogelij
Date: Thu May  3 21:06:04 2012
New Revision: 24786
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24786&sc=1

Log:
Added a cli entry point in order to be able to take measurements

Modified:
   spoofax/trunk/spoofax/org.spoofax.jssglr/.settings/com.google.gwt.eclipse.core.prefs
   spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/File2String.java
   spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/JSMain.java
   spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/services/Parser.java
   spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/gwt/org/spoofax/terms/io/binary/TermReader.java

Modified: spoofax/trunk/spoofax/org.spoofax.jssglr/.settings/com.google.gwt.eclipse.core.prefs
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.jssglr/.settings/com.google.gwt.eclipse.core.prefs	Thu May  3 21:00:07 2012	(r24785)
+++ spoofax/trunk/spoofax/org.spoofax.jssglr/.settings/com.google.gwt.eclipse.core.prefs	Thu May  3 21:06:04 2012	(r24786)
@@ -1,5 +1,5 @@
-#Tue Mar 27 04:22:02 CEST 2012
+#Wed Apr 18 01:27:05 CEST 2012
 eclipse.preferences.version=1
 entryPointModules=
 filesCopiedToWebInfLib=gwt-servlet.jar
-gwtCompileSettings=PGd3dC1jb21waWxlLXNldHRpbmdzPjxsb2ctbGV2ZWw+SU5GTzwvbG9nLWxldmVsPjxvdXRwdXQtc3R5bGU+UFJFVFRZPC9vdXRwdXQtc3R5bGU+PGV4dHJhLWFyZ3M+PCFbQ0RBVEFbLVhkaXNhYmxlQ2xhc3NNZXRhZGF0YSAtWGRpc2FibGVDYXN0Q2hlY2tpbmcgLW9wdGltaXplIDldXT48L2V4dHJhLWFyZ3M+PHZtLWFyZ3M+PCFbQ0RBVEFbLVhteDUxMm1dXT48L3ZtLWFyZ3M+PGVudHJ5LXBvaW50LW1vZHVsZT5vcmcuc3Bvb2ZheC5qc3NnbHIuV29ya2VyPC9lbnRyeS1wb2ludC1tb2R1bGU+PC9nd3QtY29tcGlsZS1zZXR0aW5ncz4\=
+gwtCompileSettings=PGd3dC1jb21waWxlLXNldHRpbmdzPjxsb2ctbGV2ZWw+SU5GTzwvbG9nLWxldmVsPjxvdXRwdXQtc3R5bGU+T0JGVVNDQVRFRDwvb3V0cHV0LXN0eWxlPjxleHRyYS1hcmdzPjwhW0NEQVRBWy1YZGlzYWJsZUNsYXNzTWV0YWRhdGEgLVhkaXNhYmxlQ2FzdENoZWNraW5nIC1vcHRpbWl6ZSA5XV0+PC9leHRyYS1hcmdzPjx2bS1hcmdzPjwhW0NEQVRBWy1YbXg1MTJtXV0+PC92bS1hcmdzPjxlbnRyeS1wb2ludC1tb2R1bGU+b3JnLnNwb29mYXguanNzZ2xyLldvcmtlcjwvZW50cnktcG9pbnQtbW9kdWxlPjwvZ3d0LWNvbXBpbGUtc2V0dGluZ3M+

Modified: spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/File2String.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/File2String.java	Thu May  3 21:00:07 2012	(r24785)
+++ spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/File2String.java	Thu May  3 21:06:04 2012	(r24786)
@@ -14,7 +14,7 @@
 			int ch;
 			while ((ch = fis.read()) != -1) 
 				strContent.append((char)ch);
-			
+			 
 		} catch (FileNotFoundException e) {
 			e.printStackTrace();
 		} catch (IOException e) {

Modified: spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/JSMain.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/JSMain.java	Thu May  3 21:00:07 2012	(r24785)
+++ spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/JSMain.java	Thu May  3 21:06:04 2012	(r24786)
@@ -1,19 +1,12 @@
 package org.spoofax.jssglr.client;
 
-//import java.io.BufferedReader;
-import java.io.BufferedWriter;
 import java.io.FileNotFoundException;
-//import java.io.FileReader;
 import java.io.IOException;
-import java.io.OutputStreamWriter;
-import java.io.Writer;
-
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.ITermFactory;
 import org.spoofax.jsglr.client.Asfix2TreeBuilder;
 import org.spoofax.jsglr.client.ITreeBuilder;
 import org.spoofax.jsglr.client.InvalidParseTableException;
-import org.spoofax.jsglr.client.NullTreeBuilder;
 import org.spoofax.jsglr.client.ParseTable;
 import org.spoofax.jsglr.client.SGLR;
 import org.spoofax.jsglr.client.imploder.MemoryRecordingTreeBuilder;
@@ -75,9 +68,12 @@
 				warmup = Integer.parseInt(args[++i]);
 			} else if(args[i].equals("-s")) {
 				startSymbol = args[++i];
+			} else if(args[i].equals("-o")) {
+				output = args[++i];				
 			} else if(args[i].equals("--implode")) {
 				implode = true;
 			}
+			
 		}
 		
 		
@@ -155,11 +151,11 @@
 				JsPrintErr("Parsing failed: " + e.getMessage());
 				//System.exit(1);
 			} catch(final SGLRException e) {
-				// Detailed message for other exceptions
+				// Detailed message for other exceptions dfef``
 				JsPrintErr("Parsing failed: " + e);
 				//System.exit(1);
 			}
-			if (!NO_OUTPUT.equals(output))
+			if (!NO_OUTPUT.equals(output) && !output.equals("/dev/null"))
 				JsPrintln(t.toString());
 			return parsingTime;
 		}

Modified: spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/services/Parser.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/services/Parser.java	Thu May  3 21:00:07 2012	(r24785)
+++ spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/client/services/Parser.java	Thu May  3 21:06:04 2012	(r24786)
@@ -12,14 +12,14 @@
 import org.spoofax.interpreter.terms.ISimpleTerm;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.ITermFactory;
-import org.spoofax.jsglr.client.Asfix2TreeBuilder;
+//import org.spoofax.jsglr.client.Asfix2TreeBuilder;
 import org.spoofax.jsglr.client.ITreeBuilder;
 import org.spoofax.jsglr.client.InvalidParseTableException;
 import org.spoofax.jsglr.client.ParseException;
 import org.spoofax.jsglr.client.ParseTable;
 import org.spoofax.jsglr.client.RegionRecovery;
 import org.spoofax.jsglr.client.SGLR;
-import org.spoofax.jsglr.client.imploder.MemoryRecordingTreeBuilder;
+//import org.spoofax.jsglr.client.imploder.MemoryRecordingTreeBuilder;
 import org.spoofax.jsglr.client.imploder.Token;
 import org.spoofax.jsglr.client.imploder.IToken;
 import org.spoofax.jsglr.client.imploder.ITokenizer;
@@ -133,10 +133,12 @@
 			sglr.setUseStructureRecovery(true);
 		}
 		//Measure mode:
+		/*
 		{
 			treeBuilder = new MemoryRecordingTreeBuilder(new Asfix2TreeBuilder());
 			sglr = new SGLR(treeBuilder, parseTable);
 		}
+		*/
 	}
 
 	public boolean isReady() {

Modified: spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/gwt/org/spoofax/terms/io/binary/TermReader.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/gwt/org/spoofax/terms/io/binary/TermReader.java	Thu May  3 21:00:07 2012	(r24785)
+++ spoofax/trunk/spoofax/org.spoofax.jssglr/src/org/spoofax/jssglr/gwt/org/spoofax/terms/io/binary/TermReader.java	Thu May  3 21:06:04 2012	(r24786)
@@ -23,10 +23,8 @@
     
     @Override
 	public IStrategoTerm parseFromStream(InputStream inputStream) throws IOException, ParseError {
-    	System.err.println("public IStrategoTerm parseFromStream(InputStream inputStream) throws IOException, ParseError {");
     	try {
         	return SAFReader.readTermFromSAFStream(factory, inputStream);
-        	
     	} finally {
     	}
     }

From g.h.wachsmuth at tudelft.nl  Thu May  3 23:13:06 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 03 May 2012 21:13:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24787 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: . lib test trans
Message-ID: <20120503211306.89F35108C044@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May  3 21:13:06 2012
New Revision: 24787
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24787&sc=1

Log:
restructured code, added some overlays

Added:
   spoofax-imp/trunk/org.strategoxt.imp.names/x.aterm
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 21:06:04 2012	(r24786)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May  3 21:13:06 2012	(r24787)
@@ -28,16 +28,16 @@
     Namespace(x) -> <nam-get-def(|Namespace())> x
 
   nam-annotate-names(|def-path):
-    Naming(m_384168, n_384168, o_384168, p_384168) -> Naming(m_384168{def-path}, n_384168, o_384168, p_384168)
+    Naming(t_488116, u_488116, v_488116, w_488116) -> Naming(t_488116{def-path}, u_488116, v_488116, w_488116)
 
   nam-annotate-names(|def-path):
-    Import(l_384168) -> Import(<nam-annotate-use(|Module())> l_384168)
+    Import(s_488116) -> Import(<nam-annotate-use(|Module())> s_488116)
 
   nam-annotate-names(|def-path):
-    Namespace(k_384168) -> Namespace(k_384168{def-path})
+    Namespace(r_488116) -> Namespace(r_488116{def-path})
 
   nam-annotate-names(|def-path):
-    NsRef(j_384168) -> NsRef(<nam-annotate-use(|Namespace())> j_384168)
+    NsRef(q_488116) -> NsRef(<nam-annotate-use(|Namespace())> q_488116)
 
   nam-get-scope-types :
     Naming(_, _, _, _) -> [Namespace()]

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 21:06:04 2012	(r24786)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/test/example.str	Thu May  3 21:13:06 2012	(r24787)
@@ -1,14 +1,19 @@
 module example
 
 imports
-  lib/index-library.generated
   lib/analysis-library.generated
+  lib/index-library.generated
+
+
+imports
   include/Entity
 
 
 signature
   constructors
-    Type     : DefDataKind
+    Type : DefDataKind
+
+  constructors
     entity   : Namespace
     property : Namespace
     variable : Namespace
@@ -17,6 +22,9 @@
 
 rules
 
+  nam-get-scope-types :
+    Entity(name, _) -> [property(), method()]
+
   nam-get-definition-key :
     Entity(name, _) -> name
 
@@ -35,6 +43,9 @@
 
 rules
 
+  nam-get-scope-types :
+    Entity(name, super, _) -> [property(), method()]
+
   nam-get-definition-key :
     Entity(name, super, _) -> name
 
@@ -140,6 +151,10 @@
 
 rules
 
+  nam-get-scope-types :
+    Method(f, param*, t, _) -> [variable()]
+    where t* := <type-of> param*
+
   nam-get-definition-key :
     Method(f, param*, t, _) -> m(f, t*)
     where t* := <type-of> param*
@@ -151,10 +166,6 @@
   nam-annotate-names(|path) =
     Method(id, id, id, id)
 
-  nam-get-scope-types :
-    Method(f, param*, t, _) -> [variable()]
-    where t* := <type-of> param*
-
   adjust-index-def-data(store|namespace, path):
     Method(f, param*, t, _) -> <store> DefData(path, Type(), t)
     where t* := <type-of> param*

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 21:06:04 2012	(r24786)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May  3 21:13:06 2012	(r24787)
@@ -20,10 +20,19 @@
 
 overlays
 	
-	ANALYSIS_LIB = Import("lib/analysis-library.generated")
-	INDEX_LIB    = Import("lib/index-library.generated")
+	TERM(o, args) = NoAnnoList(Op(o, args))
+	TERM(o)       = NoAnnoList(Op(o, []))
+	CALL(c)       = CallNoArgs(SVar(c))
+	CALL(c, t)    = CallT(SVar(c), [], [t])
+
+	RULE(n, lhs, rhs, clauses) = RDefNoArgs(n, Rule(lhs, rhs, clauses))
+		
+overlays
 	
-	TYPE_OP_DECL = OpDecl("Type", ConstType(SortNoArgs("DefDataKind")))
+	GEN_IMPORTS      = Imports([Import("lib/analysis-library.generated"), Import("lib/index-library.generated")])
+	GEN_CONSTRUCTORS = Constructors([CONS_DECL("Type", "DefDataKind")])
+		
+	CONS_DECL(c, t) = OpDecl(c, ConstType(SortNoArgs(t)))
 	
 	ADJUST_DATA(term, kind, data, clauses) = 
 		RDefT(
@@ -32,34 +41,39 @@
 			, [DefaultVarDec("namespace"), DefaultVarDec("path")]
 			, Rule(
 			  	  term
-			  	, App(
-					  CallNoArgs(SVar("store"))
-					, NoAnnoList(Op("DefData", [Var("path"), NoAnnoList(Op(kind, [])), data]))
-					)
+			  	, App(CALL("store"), TERM("DefData", [Var("path"), TERM(kind), data]))
 				, clauses
 				)
       		)
+
 rules
 	
 	to-analysis:
-		Naming(name, import*, namespace*, rule*) -> Module(name, [imports, sig | <filter(to-rules)> rule*])
-		where
-			imports := Imports([ INDEX_LIB, ANALYSIS_LIB | import*]) ;
-			sig     := Signature([Constructors([TYPE_OP_DECL|<map(to-opdecl)> namespace*])])
+		Naming(name, import*, namespace*, rule*) -> 
+		Module(
+			  name
+			, [ GEN_IMPORTS
+			  , Imports(import*)
+			  , Signature([GEN_CONSTRUCTORS, Constructors(<map(to-opdecl)> namespace*)])
+			  | <filter(to-rules)> rule*
+			  ]
+			)
 			
 	to-opdecl:
-		Namespace(ns) -> OpDecl(ns, ConstType(SortNoArgs("Namespace")))
+		Namespace(ns) -> CONS_DECL(ns, "Namespace")
 		
 	to-rules:
-		ND-Rule(term, part*, cond*) -> Rules(<flatten-list ; not(?[])> [scope-rule*, definition-rule*, annotate-rule*, type-rule*])
+		ND-Rule(term, part*, cond*) -> Rules(<not(?[])> [scope-rule*, definition-rule*, annotate-rule*, type-rule*])
+		where
+			<debug> term 
 		where
 			clause1*         := <filter(to-clauses)> part* ;
 			clause2*         := <filter(to-clauses)> cond* ; 
 			clause*          := <conc> (clause1*, clause2*) ;
 			scope-rule*      := <to-scope-rules(|term, clause*)> part* ;
-			definition-rule* := <filter(to-definition-rules(|term, clause*))> part* ;
+			definition-rule* := <filter(to-definition-rules(|term, clause*)) ; concat> part* ;
 			annotate-rule*   := <to-annotate-rules(|term, clause*)> part* ;
-			type-rule*       := <filter(to-type-rules(|term, clause*))> part*
+			type-rule*       := <filter(to-type-rules(|term, clause*)) ; concat> part*
 
 rules
 				
@@ -68,17 +82,12 @@
 		WhereClause(
 			Assign(
 				  NoAnnoList(List([type]))
-				, App(
-				  	  Seq(
-				  	  	  CallNoArgs(SVar("index-lookup"))
-				  		, CallT(SVar("index-get-data-all"), [], [NoAnnoList(Op("Type", []))])
-				  		)
-				  	, name)
+				, App(Seq(CALL("index-lookup"), CALL("index-get-data-all", TERM("Type"))), name)
 				)
 			)
 		
 	to-clauses:
-		Where(term, TypeCheck(type)) -> WhereClause(Assign(type, App(CallT(SVar("type-of"), [], []), term)))
+		Where(term, TypeCheck(type)) -> WhereClause(Assign(type, App(CALL("type-of"), term)))
 
 rules
 	
@@ -89,32 +98,18 @@
 			if <?[]> scope* then
 				result := [] 
 			else
-				result := [RDefNoArgs("nam-get-scope-types", Rule(term, List(scope*), clause*))]
+				result := [RULE("nam-get-scope-types", term, List(scope*), clause*)]
 			end
 	
 	to-scope:
-		ND-Scope(_, NsRef(namespace), None()) -> NoAnnoList(Op(namespace, []))
+		ND-Scope(_, NsRef(namespace), _) -> TERM(namespace)
 			
 rules
 			
 	to-definition-rules(|term, clause*):
 		ND-Def(NsRef(namespace), name, _, None()) ->
-		[ RDefNoArgs(
-			  "nam-get-definition-key"
-			, Rule(term, name, clause*)
-			)
-		, RDefNoArgs(
-			  "nam-get-definition"
-			, Rule(
-				term
-				, App(
-					CallT(SVar("nam-get-def"), [], [NoAnnoList(Op(namespace, []))])
-					, name
-					)
-				, clause*
-				)
-			)
-		]
+		[ RULE("nam-get-definition-key", term, name, clause*)
+		, RULE("nam-get-definition", term, App(CALL("nam-get-def", TERM(namespace)), name), clause*) ]
 
 rules
 	
@@ -129,10 +124,10 @@
 			end
 		
 	to-annotate-replacement:
-		ND-Def(_, name, _, None())-> (name, CallT(SVar("nam-annotate-def"), [], [Var("path")]))
+		ND-Def(_, name, _, None())-> (name, CALL("nam-annotate-def", Var("path")))
 			
 	to-annotate-replacement:
-		ND-Ref(NsRef(namespace), name, _, None()) -> (name, CallT(SVar("nam-annotate-use"), [], [NoAnnoList(Op(namespace, []))]))
+		ND-Ref(NsRef(namespace), name, _, None()) -> (name, CALL("nam-annotate-use", TERM(namespace)))
 			
 	replace(|replacement*): t1 -> t2 where <fetch-elem(?(t1, t2))> replacement*
 	
@@ -144,10 +139,10 @@
 	to-type-rules(|term, clause*):
 		ND-Def(NsRef(namespace), name, TypeBinding(type), _) -> 
 		[ ADJUST_DATA(term, "Type", type, clause*)
-		, RDefNoArgs("type-of", Rule(term, type, clause*)) ]
+		, RULE("type-of", term, type, clause*) ]
 		
 	to-type-rules(|term, clause*):
-		ND-Type(type) -> RDefNoArgs("type-of", Rule(term, type, clause*))
+		ND-Type(type) -> [RULE("type-of", term, type, clause*)]
 	
 		
 	
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/x.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/x.aterm	Thu May  3 21:13:06 2012	(r24787)
@@ -0,0 +1,956 @@
+Module(
+  "generate"
+, [ Imports(
+      [ Import("libstrc")
+      , Import("libstratego-lib")
+      , Import("libstratego-gpp")
+      , Import("libstratego-aterm")
+      , Import("include/NameDefinitionLanguage")
+      , Import("lib/editor-common.generated")
+      , Import("lib/compilation-library.generated")
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "NEWNAME"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Tuple(
+                  [ Var("selected")
+                  , Var("position")
+                  , As(
+                      Var("ast")
+                    , NoAnnoList(
+                        Op("Naming", [Var("name"), Wld(), Wld(), Wld()])
+                      )
+                    )
+                  , Var("path")
+                  , Var("project-path")
+                  ]
+                )
+              )
+            , NoAnnoList(Tuple([Var("filename"), Var("result")]))
+            , [ WithClause(
+                  Seq(
+                    Assign(
+                      Var("filename")
+                    , App(
+                        CallT(SVar("guarantee-extension"), [], [NoAnnoList(Str("\"str\""))])
+                      , Var("path")
+                      )
+                    )
+                  , Seq(
+                      Assign(
+                        Var("str-module")
+                      , App(CallT(SVar("to-analysis"), [], []), Var("ast"))
+                      )
+                    , Assign(
+                        Var("result")
+                      , App(CallT(SVar("pp-stratego-string"), [], []), Var("str-module"))
+                      )
+                    )
+                  )
+                )
+              ]
+            )
+          )
+        )
+      ]
+    )
+  , Overlays(
+      [ Overlay(
+          "TERM"
+        , ["o", "args"]
+        , NoAnnoList(
+            Op(
+              "NoAnnoList"
+            , [NoAnnoList(Op("Op", [Var("o"), Var("args")]))]
+            )
+          )
+        )
+      , Overlay(
+          "TERM"
+        , ["o"]
+        , NoAnnoList(
+            Op(
+              "NoAnnoList"
+            , [NoAnnoList(
+                 Op("Op", [Var("o"), NoAnnoList(List([]))])
+               )]
+            )
+          )
+        )
+      , Overlay(
+          "CALL"
+        , ["c"]
+        , NoAnnoList(
+            Op(
+              "CallNoArgs"
+            , [NoAnnoList(Op("SVar", [Var("c")]))]
+            )
+          )
+        )
+      , Overlay(
+          "CALL"
+        , ["c", "t"]
+        , NoAnnoList(
+            Op(
+              "CallT"
+            , [ NoAnnoList(Op("SVar", [Var("c")]))
+              , NoAnnoList(List([]))
+              , NoAnnoList(List([Var("t")]))
+              ]
+            )
+          )
+        )
+      , Overlay(
+          "RULE"
+        , ["n", "lhs", "rhs", "clauses"]
+        , NoAnnoList(
+            Op(
+              "RDefNoArgs"
+            , [ Var("n")
+              , NoAnnoList(
+                  Op(
+                    "Rule"
+                  , [Var("lhs"), Var("rhs"), Var("clauses")]
+                  )
+                )
+              ]
+            )
+          )
+        )
+      ]
+    )
+  , Overlays(
+      [ Overlay(
+          "GEN_IMPORTS"
+        , []
+        , NoAnnoList(
+            Op(
+              "Imports"
+            , [ NoAnnoList(
+                  List(
+                    [ NoAnnoList(Op("Import", [NoAnnoList(Str("\"lib/analysis-library.generated\""))]))
+                    , NoAnnoList(Op("Import", [NoAnnoList(Str("\"lib/index-library.generated\""))]))
+                    ]
+                  )
+                )
+              ]
+            )
+          )
+        )
+      , Overlay(
+          "GEN_CONSTRUCTORS"
+        , []
+        , NoAnnoList(
+            Op(
+              "Constructors"
+            , [ NoAnnoList(
+                  List(
+                    [ NoAnnoList(
+                        Op(
+                          "CONS_DECL"
+                        , [NoAnnoList(Str("\"Type\"")), NoAnnoList(Str("\"DefDataKind\""))]
+                        )
+                      )
+                    ]
+                  )
+                )
+              ]
+            )
+          )
+        )
+      , Overlay(
+          "CONS_DECL"
+        , ["c", "t"]
+        , NoAnnoList(
+            Op(
+              "OpDecl"
+            , [ Var("c")
+              , NoAnnoList(
+                  Op(
+                    "ConstType"
+                  , [NoAnnoList(Op("SortNoArgs", [Var("t")]))]
+                  )
+                )
+              ]
+            )
+          )
+        )
+      , Overlay(
+          "ADJUST_DATA"
+        , ["term", "kind", "data", "clauses"]
+        , NoAnnoList(
+            Op(
+              "RDefT"
+            , [ NoAnnoList(Str("\"adjust-index-def-data\""))
+              , NoAnnoList(
+                  List(
+                    [NoAnnoList(Op("DefaultVarDec", [NoAnnoList(Str("\"store\""))]))]
+                  )
+                )
+              , NoAnnoList(
+                  List(
+                    [ NoAnnoList(Op("DefaultVarDec", [NoAnnoList(Str("\"namespace\""))]))
+                    , NoAnnoList(Op("DefaultVarDec", [NoAnnoList(Str("\"path\""))]))
+                    ]
+                  )
+                )
+              , NoAnnoList(
+                  Op(
+                    "Rule"
+                  , [ Var("term")
+                    , NoAnnoList(
+                        Op(
+                          "App"
+                        , [ NoAnnoList(Op("CALL", [NoAnnoList(Str("\"store\""))]))
+                          , NoAnnoList(
+                              Op(
+                                "TERM"
+                              , [ NoAnnoList(Str("\"DefData\""))
+                                , NoAnnoList(
+                                    List(
+                                      [ NoAnnoList(Op("Var", [NoAnnoList(Str("\"path\""))]))
+                                      , NoAnnoList(Op("TERM", [Var("kind")]))
+                                      , Var("data")
+                                      ]
+                                    )
+                                  )
+                                ]
+                              )
+                            )
+                          ]
+                        )
+                      )
+                    , Var("clauses")
+                    ]
+                  )
+                )
+              ]
+            )
+          )
+        )
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "to-analysis"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "Naming"
+                , [Var("name"), Var("import*"), Var("namespace*"), Var("rule*")]
+                )
+              )
+            , NoAnnoList(
+                Op(
+                  "Module"
+                , [ Var("name")
+                  , NoAnnoList(
+                      ListTail(
+                        [ Var("GEN_IMPORTS")
+                        , NoAnnoList(Op("Imports", [Var("import*")]))
+                        , NoAnnoList(
+                            Op(
+                              "Signature"
+                            , [ NoAnnoList(
+                                  List(
+                                    [ Var("GEN_CONSTRUCTORS")
+                                    , NoAnnoList(
+                                        Op(
+                                          "Constructors"
+                                        , [ App(
+                                              CallT(
+                                                SVar("map")
+                                              , [CallT(SVar("to-opdecl"), [], [])]
+                                              , []
+                                              )
+                                            , Var("namespace*")
+                                            )
+                                          ]
+                                        )
+                                      )
+                                    ]
+                                  )
+                                )
+                              ]
+                            )
+                          )
+                        ]
+                      , App(
+                          CallT(
+                            SVar("filter")
+                          , [CallT(SVar("to-rules"), [], [])]
+                          , []
+                          )
+                        , Var("rule*")
+                        )
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "to-opdecl"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(Op("Namespace", [Var("ns")]))
+            , NoAnnoList(
+                Op("CONS_DECL", [Var("ns"), NoAnnoList(Str("\"Namespace\""))])
+              )
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "to-rules"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Rule"
+                , [Var("term"), Var("part*"), Var("cond*")]
+                )
+              )
+            , NoAnnoList(
+                Op(
+                  "Rules"
+                , [ App(
+                      CallT(SVar("concat"), [], [])
+                    , NoAnnoList(
+                        List(
+                          [Var("scope-rule*"), Var("definition-rule*"), Var("annotate-rule*"), Var("type-rule*")]
+                        )
+                      )
+                    )
+                  ]
+                )
+              )
+            , [ WhereClause(
+                  BA(CallT(SVar("debug"), [], []), Var("term"))
+                )
+              , WhereClause(
+                  Seq(
+                    Assign(
+                      Var("clause1*")
+                    , App(
+                        CallT(
+                          SVar("filter")
+                        , [CallT(SVar("to-clauses"), [], [])]
+                        , []
+                        )
+                      , Var("part*")
+                      )
+                    )
+                  , Seq(
+                      Assign(
+                        Var("clause2*")
+                      , App(
+                          CallT(
+                            SVar("filter")
+                          , [CallT(SVar("to-clauses"), [], [])]
+                          , []
+                          )
+                        , Var("cond*")
+                        )
+                      )
+                    , Seq(
+                        Assign(
+                          Var("clause*")
+                        , App(
+                            CallT(SVar("conc"), [], [])
+                          , NoAnnoList(Tuple([Var("clause1*"), Var("clause2*")]))
+                          )
+                        )
+                      , Seq(
+                          Assign(
+                            Var("scope-rule*")
+                          , App(
+                              Seq(
+                                CallT(
+                                  SVar("to-scope-rules")
+                                , []
+                                , [Var("term"), Var("clause*")]
+                                )
+                              , CallT(
+                                  SVar("debug")
+                                , [Build(NoAnnoList(Str("\"scope \"")))]
+                                , []
+                                )
+                              )
+                            , Var("part*")
+                            )
+                          )
+                        , Seq(
+                            Assign(
+                              Var("definition-rule*")
+                            , App(
+                                Seq(
+                                  CallT(
+                                    SVar("filter")
+                                  , [CallT(
+                                       SVar("to-definition-rules")
+                                     , []
+                                     , [Var("term"), Var("clause*")]
+                                     )]
+                                  , []
+                                  )
+                                , Seq(
+                                    CallT(SVar("concat"), [], [])
+                                  , CallT(
+                                      SVar("debug")
+                                    , [Build(NoAnnoList(Str("\"def \"")))]
+                                    , []
+                                    )
+                                  )
+                                )
+                              , Var("part*")
+                              )
+                            )
+                          , Seq(
+                              Assign(
+                                Var("annotate-rule*")
+                              , App(
+                                  Seq(
+                                    CallT(
+                                      SVar("to-annotate-rules")
+                                    , []
+                                    , [Var("term"), Var("clause*")]
+                                    )
+                                  , CallT(
+                                      SVar("debug")
+                                    , [Build(NoAnnoList(Str("\"anno \"")))]
+                                    , []
+                                    )
+                                  )
+                                , Var("part*")
+                                )
+                              )
+                            , Assign(
+                                Var("type-rule*")
+                              , App(
+                                  Seq(
+                                    CallT(
+                                      SVar("filter")
+                                    , [CallT(
+                                         SVar("to-type-rules")
+                                       , []
+                                       , [Var("term"), Var("clause*")]
+                                       )]
+                                    , []
+                                    )
+                                  , Seq(
+                                      CallT(SVar("concat"), [], [])
+                                    , CallT(
+                                        SVar("debug")
+                                      , [Build(NoAnnoList(Str("\"type \"")))]
+                                      , []
+                                      )
+                                    )
+                                  )
+                                , Var("part*")
+                                )
+                              )
+                            )
+                          )
+                        )
+                      )
+                    )
+                  )
+                )
+              ]
+            )
+          )
+        )
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "to-clauses"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Ref"
+                , [ Wld()
+                  , Var("name")
+                  , NoAnnoList(Op("TypeBinding", [Var("type")]))
+                  , Wld()
+                  ]
+                )
+              )
+            , NoAnnoList(
+                Op(
+                  "WhereClause"
+                , [ NoAnnoList(
+                      Op(
+                        "Assign"
+                      , [ NoAnnoList(
+                            Op(
+                              "NoAnnoList"
+                            , [NoAnnoList(
+                                 Op("List", [NoAnnoList(List([Var("type")]))])
+                               )]
+                            )
+                          )
+                        , NoAnnoList(
+                            Op(
+                              "App"
+                            , [ NoAnnoList(
+                                  Op(
+                                    "Seq"
+                                  , [ NoAnnoList(Op("CALL", [NoAnnoList(Str("\"index-lookup\""))]))
+                                    , NoAnnoList(
+                                        Op(
+                                          "CALL"
+                                        , [ NoAnnoList(Str("\"index-get-data-all\""))
+                                          , NoAnnoList(Op("TERM", [NoAnnoList(Str("\"Type\""))]))
+                                          ]
+                                        )
+                                      )
+                                    ]
+                                  )
+                                )
+                              , Var("name")
+                              ]
+                            )
+                          )
+                        ]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "to-clauses"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "Where"
+                , [Var("term"), NoAnnoList(Op("TypeCheck", [Var("type")]))]
+                )
+              )
+            , NoAnnoList(
+                Op(
+                  "WhereClause"
+                , [ NoAnnoList(
+                      Op(
+                        "Assign"
+                      , [ Var("type")
+                        , NoAnnoList(
+                            Op(
+                              "App"
+                            , [NoAnnoList(Op("CALL", [NoAnnoList(Str("\"type-of\""))])), Var("term")]
+                            )
+                          )
+                        ]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "to-scope-rules"
+        , []
+        , [ VarDec("term", ConstType(SortNoArgs("ATerm")))
+          , VarDec("clause*", ConstType(SortNoArgs("ATerm")))
+          ]
+        , SRule(
+            Rule(
+              Var("part*")
+            , Var("result")
+            , [ WhereClause(
+                  Seq(
+                    Assign(
+                      Var("scope*")
+                    , App(
+                        CallT(
+                          SVar("filter")
+                        , [CallT(SVar("to-scope"), [], [])]
+                        , []
+                        )
+                      , Var("part*")
+                      )
+                    )
+                  , GuardedLChoice(
+                      Where(BA(Match(NoAnnoList(List([]))), Var("scope*")))
+                    , Assign(Var("result"), NoAnnoList(List([])))
+                    , Assign(
+                        Var("result")
+                      , NoAnnoList(
+                          List(
+                            [ NoAnnoList(
+                                Op(
+                                  "RULE"
+                                , [ NoAnnoList(Str("\"nam-get-scope-types\""))
+                                  , Var("term")
+                                  , NoAnnoList(Op("List", [Var("scope*")]))
+                                  , Var("clause*")
+                                  ]
+                                )
+                              )
+                            ]
+                          )
+                        )
+                      )
+                    )
+                  )
+                )
+              ]
+            )
+          )
+        )
+      , SDefT(
+          "to-scope"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Scope"
+                , [Wld(), NoAnnoList(Op("NsRef", [Var("namespace")])), Wld()]
+                )
+              )
+            , NoAnnoList(Op("TERM", [Var("namespace")]))
+            , []
+            )
+          )
+        )
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "to-definition-rules"
+        , []
+        , [ VarDec("term", ConstType(SortNoArgs("ATerm")))
+          , VarDec("clause*", ConstType(SortNoArgs("ATerm")))
+          ]
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Def"
+                , [ NoAnnoList(Op("NsRef", [Var("namespace")]))
+                  , Var("name")
+                  , Wld()
+                  , NoAnnoList(Op("None", []))
+                  ]
+                )
+              )
+            , NoAnnoList(
+                List(
+                  [ NoAnnoList(
+                      Op(
+                        "RULE"
+                      , [NoAnnoList(Str("\"nam-get-definition-key\"")), Var("term"), Var("name"), Var("clause*")]
+                      )
+                    )
+                  , NoAnnoList(
+                      Op(
+                        "RULE"
+                      , [ NoAnnoList(Str("\"nam-get-definition\""))
+                        , Var("term")
+                        , NoAnnoList(
+                            Op(
+                              "App"
+                            , [ NoAnnoList(
+                                  Op(
+                                    "CALL"
+                                  , [NoAnnoList(Str("\"nam-get-def\"")), NoAnnoList(Op("TERM", [Var("namespace")]))]
+                                  )
+                                )
+                              , Var("name")
+                              ]
+                            )
+                          )
+                        , Var("clause*")
+                        ]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "to-annotate-rules"
+        , []
+        , [ VarDec("term", ConstType(SortNoArgs("ATerm")))
+          , VarDec("clause*", ConstType(SortNoArgs("ATerm")))
+          ]
+        , SRule(
+            Rule(
+              Var("part*")
+            , Var("result")
+            , [ WhereClause(
+                  Seq(
+                    Assign(
+                      Var("replacement*")
+                    , App(
+                        CallT(
+                          SVar("filter")
+                        , [CallT(SVar("to-annotate-replacement"), [], [])]
+                        , []
+                        )
+                      , Var("part*")
+                      )
+                    )
+                  , GuardedLChoice(
+                      Where(BA(Match(NoAnnoList(List([]))), Var("replacement*")))
+                    , Assign(Var("result"), NoAnnoList(List([])))
+                    , Assign(
+                        Var("result")
+                      , NoAnnoList(
+                          List(
+                            [ NoAnnoList(
+                                Op(
+                                  "SDefT"
+                                , [ NoAnnoList(Str("\"nam-annotate-names\""))
+                                  , NoAnnoList(List([]))
+                                  , NoAnnoList(
+                                      List(
+                                        [NoAnnoList(Op("DefaultVarDec", [NoAnnoList(Str("\"path\""))]))]
+                                      )
+                                    )
+                                  , App(
+                                      CallT(
+                                        SVar("alltd")
+                                      , [ GuardedLChoice(
+                                            CallT(SVar("replace"), [], [Var("replacement*")])
+                                          , Id()
+                                          , CallT(SVar("introduce-id"), [], [])
+                                          )
+                                        ]
+                                      , []
+                                      )
+                                    , Var("term")
+                                    )
+                                  ]
+                                )
+                              )
+                            ]
+                          )
+                        )
+                      )
+                    )
+                  )
+                )
+              ]
+            )
+          )
+        )
+      , SDefT(
+          "to-annotate-replacement"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Def"
+                , [Wld(), Var("name"), Wld(), NoAnnoList(Op("None", []))]
+                )
+              )
+            , NoAnnoList(
+                Tuple(
+                  [ Var("name")
+                  , NoAnnoList(
+                      Op(
+                        "CALL"
+                      , [ NoAnnoList(Str("\"nam-annotate-def\""))
+                        , NoAnnoList(Op("Var", [NoAnnoList(Str("\"path\""))]))
+                        ]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "to-annotate-replacement"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Ref"
+                , [ NoAnnoList(Op("NsRef", [Var("namespace")]))
+                  , Var("name")
+                  , Wld()
+                  , NoAnnoList(Op("None", []))
+                  ]
+                )
+              )
+            , NoAnnoList(
+                Tuple(
+                  [ Var("name")
+                  , NoAnnoList(
+                      Op(
+                        "CALL"
+                      , [NoAnnoList(Str("\"nam-annotate-use\"")), NoAnnoList(Op("TERM", [Var("namespace")]))]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "replace"
+        , []
+        , [VarDec("replacement*", ConstType(SortNoArgs("ATerm")))]
+        , SRule(
+            Rule(
+              Var("t1")
+            , Var("t2")
+            , [ WhereClause(
+                  BA(
+                    CallT(
+                      SVar("fetch-elem")
+                    , [Match(NoAnnoList(Tuple([Var("t1"), Var("t2")])))]
+                    , []
+                    )
+                  , Var("replacement*")
+                  )
+                )
+              ]
+            )
+          )
+        )
+      , SDefT(
+          "introduce-id"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(Op("Wld", []))
+            , NoAnnoList(Op("Id", []))
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "introduce-id"
+        , []
+        , []
+        , SRule(
+            Rule(
+              NoAnnoList(Op("Var", [Wld()]))
+            , NoAnnoList(Op("Id", []))
+            , []
+            )
+          )
+        )
+      ]
+    )
+  , Rules(
+      [ SDefT(
+          "to-type-rules"
+        , []
+        , [ VarDec("term", ConstType(SortNoArgs("ATerm")))
+          , VarDec("clause*", ConstType(SortNoArgs("ATerm")))
+          ]
+        , SRule(
+            Rule(
+              NoAnnoList(
+                Op(
+                  "ND-Def"
+                , [ NoAnnoList(Op("NsRef", [Var("namespace")]))
+                  , Var("name")
+                  , NoAnnoList(Op("TypeBinding", [Var("type")]))
+                  , Wld()
+                  ]
+                )
+              )
+            , NoAnnoList(
+                List(
+                  [ NoAnnoList(
+                      Op(
+                        "ADJUST_DATA"
+                      , [Var("term"), NoAnnoList(Str("\"Type\"")), Var("type"), Var("clause*")]
+                      )
+                    )
+                  , NoAnnoList(
+                      Op(
+                        "RULE"
+                      , [NoAnnoList(Str("\"type-of\"")), Var("term"), Var("type"), Var("clause*")]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      , SDefT(
+          "to-type-rules"
+        , []
+        , [ VarDec("term", ConstType(SortNoArgs("ATerm")))
+          , VarDec("clause*", ConstType(SortNoArgs("ATerm")))
+          ]
+        , SRule(
+            Rule(
+              NoAnnoList(Op("ND-Type", [Var("type")]))
+            , NoAnnoList(
+                List(
+                  [ NoAnnoList(
+                      Op(
+                        "RULE"
+                      , [NoAnnoList(Str("\"type-of\"")), Var("term"), Var("type"), Var("clause*")]
+                      )
+                    )
+                  ]
+                )
+              )
+            , []
+            )
+          )
+        )
+      ]
+    )
+  ]
+)
\ No newline at end of file

From richard at vogelij.nl  Fri May  4 00:08:56 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Thu, 03 May 2012 22:08:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24788 -
	spoofax/trunk/spoofax/org.spoofax.terms/src/org/spoofax
Message-ID: <20120503220856.A77762B8026@mx2.tudelft.nl>

Author: rvogelij
Date: Thu May  3 22:08:54 2012
New Revision: 24788
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24788&sc=1

Log:
reparing hydra build for jssglr (GWT)

Modified:
   spoofax/trunk/spoofax/org.spoofax.terms/src/org/spoofax/termsGWT.gwt.xml

Modified: spoofax/trunk/spoofax/org.spoofax.terms/src/org/spoofax/termsGWT.gwt.xml
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.terms/src/org/spoofax/termsGWT.gwt.xml	Thu May  3 21:13:06 2012	(r24787)
+++ spoofax/trunk/spoofax/org.spoofax.terms/src/org/spoofax/termsGWT.gwt.xml	Thu May  3 22:08:54 2012	(r24788)
@@ -11,8 +11,10 @@
 	<exclude name="**/io/**"/>
   </source>
   <source path='terms'>
-    <exclude name="**/io/**"/>
-    <exclude name="**/TermFactory.java"/>
+    <exclude name="**/1io/**"/>
+    <exclude name="**/SAFReader.java"/>
+    <exclude name="**/TermReader.java"/>
+    <exclude name="**/BAFReader.java"/>
 	<exclude name="**/UniqueValueTerm.java"/>
   </source>
 </module>

From richard at vogelij.nl  Fri May  4 02:34:07 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Fri, 04 May 2012 00:34:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24789 - in
	spoofax-ace: . graph resources src tests trunk
	trunk/spoofax-ace trunk/spoofax-ace-server
	trunk/spoofax-ace-server/src
	trunk/spoofax-ace-server/src/spoofax trun...
Message-ID: <20120504003407.839E97F8089@mx1.tudelft.nl>

Author: rvogelij
Date: Fri May  4 00:34:05 2012
New Revision: 24789
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24789&sc=1

Log:
spoofax-ace is now a repo on its own containing the spoofax-ace and spoofax-ace-server projects

Added:
   spoofax-ace/trunk/
   spoofax-ace/trunk/spoofax-ace/
   spoofax-ace/trunk/spoofax-ace-server/
   spoofax-ace/trunk/spoofax-ace-server/.classpath
   spoofax-ace/trunk/spoofax-ace-server/.project
   spoofax-ace/trunk/spoofax-ace-server/src/
   spoofax-ace/trunk/spoofax-ace-server/src/AceServer.java
   spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java
   spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java
   spoofax-ace/trunk/spoofax-ace-server/src/WebSocketTest.java
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java
   spoofax-ace/trunk/spoofax-ace/.classpath
   spoofax-ace/trunk/spoofax-ace/.project
   spoofax-ace/trunk/spoofax-ace/build.xml
   spoofax-ace/trunk/spoofax-ace/graph/
   spoofax-ace/trunk/spoofax-ace/graph/Makefile
   spoofax-ace/trunk/spoofax-ace/graph/data/
   spoofax-ace/trunk/spoofax-ace/graph/scripts/
   spoofax-ace/trunk/spoofax-ace/graph/scripts/build.sh
   spoofax-ace/trunk/spoofax-ace/graph/scripts/gnuplot.script
   spoofax-ace/trunk/spoofax-ace/graph/server.js
   spoofax-ace/trunk/spoofax-ace/resources/
   spoofax-ace/trunk/spoofax-ace/resources/ace/
   spoofax-ace/trunk/spoofax-ace/resources/ace/require.js
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/ace-uncompressed.js
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn.js
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-eclipse.js
   spoofax-ace/trunk/spoofax-ace/resources/ace/static.py
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/code.js
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/code.xml
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace.js
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_tokenizer.js
   spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_worker.js
   spoofax-ace/trunk/spoofax-ace/resources/html/
   spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html
   spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html
   spoofax-ace/trunk/spoofax-ace/resources/html/test_append.html
   spoofax-ace/trunk/spoofax-ace/resources/html/test_prepend.html
   spoofax-ace/trunk/spoofax-ace/resources/html/underline.gif   (contents, props changed)
   spoofax-ace/trunk/spoofax-ace/resources/java/
   spoofax-ace/trunk/spoofax-ace/resources/java/StatsCollector.java
   spoofax-ace/trunk/spoofax-ace/resources/java/finished_task_0_1.java
   spoofax-ace/trunk/spoofax-ace/resources/java/record_current_heap_size_0_4.java
   spoofax-ace/trunk/spoofax-ace/resources/java/record_task_0_4.java
   spoofax-ace/trunk/spoofax-ace/resources/java/start_task_0_1.java
   spoofax-ace/trunk/spoofax-ace/resources/javascript/
   spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/
   spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/measurements.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/stats.js
   spoofax-ace/trunk/spoofax-ace/resources/stratego/
   spoofax-ace/trunk/spoofax-ace/resources/stratego/S2Alib.str
   spoofax-ace/trunk/spoofax-ace/src/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/S2ASettings.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/SpoofaxToAce.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2ACompilerException.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2ASpoofaxSetupException.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2AValidatorException.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2AWrapperException.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/S2AGenerator.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaCompiler.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaGenerator.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/IS2AJSEntryPoint.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AAceEditorGenerator.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2ACloud9PluginGenerator.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointMeasure.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfile.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfileOnlySyntax.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointRelease.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointReleaseOnlySyntax.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2ANodeJSExecutableGenerator.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/S2AEsvParser.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/S2ASpoofaxInfo.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/utils/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/utils/S2AUtils.java
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/validator/
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/validator/S2AValidator.java
   spoofax-ace/trunk/spoofax-ace/tests/
   spoofax-ace/trunk/spoofax-ace/tests/Makefile
   spoofax-ace/trunk/spoofax-ace/tests/XMLHttpRequest.js
   spoofax-ace/trunk/spoofax-ace/tests/entlang/
   spoofax-ace/trunk/spoofax-ace/tests/entlang/example.tes
   spoofax-ace/trunk/spoofax-ace/tests/entlang/simple.tes
   spoofax-ace/trunk/spoofax-ace/tests/moblgen/
   spoofax-ace/trunk/spoofax-ace/tests/moblgen/append
   spoofax-ace/trunk/spoofax-ace/tests/moblgen/body
   spoofax-ace/trunk/spoofax-ace/tests/moblgen/generate.sh
   spoofax-ace/trunk/spoofax-ace/tests/moblgen/prepend
   spoofax-ace/trunk/spoofax-ace/tests/runnative.sh
   spoofax-ace/trunk/spoofax-ace/tests/runnode.sh
   spoofax-ace/trunk/spoofax-ace/tests/tiger/
   spoofax-ace/trunk/spoofax-ace/tests/tiger/.node-xmlhttprequest-sync-9994
   spoofax-ace/trunk/spoofax-ace/tests/tiger/arrays.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/aterm.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/break.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test1.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test2.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test2t.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/example.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/extract.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/fac.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/for.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/lecture.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/merge.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/multi-arg.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest4.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest5.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest51.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest52.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest5542.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/nestedfunctions.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/prettyprint.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/queens.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test1.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test12.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test16.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test17.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test2.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test27.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test3.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test30.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test37.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test38.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test39.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test3gfg9.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test4.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test41.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test42.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test44.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test47.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test48.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test5.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test6.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test7.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test8.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/test9.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest1.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest2.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest3.tig
   spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest4.tig
Deleted:
   spoofax-ace/build.xml
   spoofax-ace/graph/
   spoofax-ace/resources/
   spoofax-ace/src/
   spoofax-ace/tests/

Added: spoofax-ace/trunk/spoofax-ace-server/.classpath
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/.classpath	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<classpath>
+	<classpathentry kind="src" path="src"/>
+	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/J2SE-1.5"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/jetty-websocket-7.6.3.v20120416.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/servlet-api-2.5.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/jetty-util-7.6.3.v20120416.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/jetty-all-7.6.3.v20120416.jar"/>
+	<classpathentry kind="output" path="bin"/>
+</classpath>

Added: spoofax-ace/trunk/spoofax-ace-server/.project
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/.project	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<projectDescription>
+	<name>spoofax-ace-server</name>
+	<comment></comment>
+	<projects>
+		<project>mobl-gwt</project>
+	</projects>
+	<buildSpec>
+		<buildCommand>
+			<name>org.eclipse.jdt.core.javabuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+	</buildSpec>
+	<natures>
+		<nature>org.eclipse.jdt.core.javanature</nature>
+	</natures>
+</projectDescription>

Added: spoofax-ace/trunk/spoofax-ace-server/src/AceServer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/AceServer.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,23 @@
+import org.eclipse.jetty.server.Server;
+import org.eclipse.jetty.servlet.ServletContextHandler;
+import org.eclipse.jetty.servlet.ServletHolder;
+
+
+
+public class AceServer {
+
+	/**
+	 * @param args
+	 * @throws Exception 
+	 */
+	public static void main(String[] args) throws Exception {
+		Server server = new Server(8080);
+		ServletContextHandler contextHandler = new ServletContextHandler(ServletContextHandler.SESSIONS);
+		contextHandler.setContextPath(".");
+		server.setHandler(contextHandler);
+		contextHandler.addServlet(new ServletHolder(new AceWebSocketServlet()), "/s2aserver");
+		server.start();
+		server.join();
+	}
+
+}

Added: spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,129 @@
+
+
+import java.io.IOException;
+import java.util.Date;
+import java.util.Set;
+import java.util.concurrent.CopyOnWriteArraySet;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import org.eclipse.jetty.websocket.WebSocket;
+import org.eclipse.jetty.websocket.WebSocketServlet;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+
+
+import spoofax.ace.tokenize.Tokenizer;
+
+public class AceWebSocketServlet extends WebSocketServlet{
+	private static final long serialVersionUID = 1075580262818559087L;
+	private final Set<Editor> _editorInstances = new CopyOnWriteArraySet<Editor>();
+
+	
+	@Override
+	public void init() throws ServletException
+	{
+		super.init();
+	}
+	
+	
+	@Override
+	public WebSocket doWebSocketConnect(HttpServletRequest arg0, String arg1) {
+		return new Editor();
+	}
+	
+	class Editor implements WebSocket.OnTextMessage {
+		private Connection _connection;
+		private StringBuilder _message;
+		
+		private int _curmessage = -1;
+		private int _lastFrameIdx;
+		private int _msgFrameCount;
+		
+
+		@Override
+		public void onClose(int msgCode, String msg) {
+			_editorInstances.remove(this);			
+		}
+
+		@Override
+		public void onOpen(Connection connection) {
+			_connection = connection;
+			_editorInstances.add(this);
+			_connection = connection;
+			try {
+				connection.sendMessage("");
+			} catch (IOException e) {
+				e.printStackTrace();
+			}
+		}
+
+		@Override
+		public void onMessage(String data) {
+			try
+			{
+				String header = data.substring(0,4*3);
+				String payload = data.substring(4*3);
+				int msg 		= Integer.parseInt(header.substring(0,4));
+				int frame 		= Integer.parseInt(header.substring(4,8));
+				int totalframes = Integer.parseInt(header.substring(8,12));
+					
+				
+				if ((msg > _curmessage) || (_curmessage == 9999))
+				{
+					_message = new StringBuilder(payload);
+					_curmessage = msg;
+					if (frame != 1)
+						System.out.println("ERROR - new message idx recieved with a frame of " + frame);
+					_lastFrameIdx = frame;
+					_msgFrameCount = totalframes;
+				} else
+				{
+					if (_msgFrameCount != totalframes)
+						System.out.println("ERROR - frame count changed?");
+					if (msg != _curmessage)
+						System.out.println("ERROR - Unexpected message idx recieved (too old)");
+					_message.append(payload);
+					_lastFrameIdx = frame;
+				}
+				System.out.println("Bufsize: " + _message.length() + " Frame: (" + _lastFrameIdx + "/" + _msgFrameCount + ")");
+				AfterMsgRecieved();
+			} catch (Exception e)
+			{
+				e.printStackTrace();
+			}
+		}
+		
+		private void AfterMsgRecieved()
+		{
+			if (_lastFrameIdx == _msgFrameCount)
+			{
+				ProcessPayload(_message.toString());
+			}
+		}
+		
+		private void ProcessPayload(String data)
+		{
+			System.out.println("################################");
+			//System.out.println(data.replace('\n', ' ').replace('\r', ' '));
+			long start = new Date().getTime();
+			IStrategoTerm term = StrategoWorker.RunAnalysis(data);
+			//System.out.println(term.toString());
+			System.out.println("Analyzed: " + (new Date().getTime() - start));
+			start = new Date().getTime();
+			String response = Tokenizer.Tokenize(term, data);
+			System.out.println("Tokenized: " + (new Date().getTime() - start));
+			start = new Date().getTime();
+			try {
+				_connection.sendMessage(response);
+			} catch (IOException e) {
+				e.printStackTrace();
+			}
+			System.out.println("Sent response: " + (new Date().getTime() - start));
+			System.out.println("################################");
+		}
+		
+		public boolean isOpen() {
+			return _connection.isOpen();
+		}
+	}	
+
+}

Added: spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,17 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.lang.Context;
+
+
+public class StrategoWorker {
+	//TODO: Cache parser instance
+	public static IStrategoTerm RunAnalysis(String sourcecode) {
+	      String[] param = new String[1];
+		  param[0] = sourcecode;
+		  Context context = jbuild.init();
+		  context.setStandAlone(true);
+		  IStrategoTerm result;
+		  result = context.invokeStrategyCLI(jbuild.main_0_0.instance, "jbuild", param);
+		  return result;
+	}
+}
+

Added: spoofax-ace/trunk/spoofax-ace-server/src/WebSocketTest.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/WebSocketTest.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,95 @@
+import java.io.IOException;
+import java.util.Date;
+import java.util.Set;
+import java.util.concurrent.CopyOnWriteArraySet;
+import java.util.concurrent.Executors;
+import java.util.concurrent.ScheduledExecutorService;
+import java.util.concurrent.TimeUnit;
+import javax.servlet.ServletException;
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+
+import org.eclipse.jetty.websocket.WebSocket;
+import org.eclipse.jetty.websocket.WebSocketServlet;
+ 
+
+public class WebSocketTest extends WebSocketServlet 
+{
+	private static final long serialVersionUID = -5501649070661778561L;
+	private ScheduledExecutorService executor = Executors.newSingleThreadScheduledExecutor();
+	private final Set<TailorSocket> _members = new CopyOnWriteArraySet<TailorSocket>();
+	
+	@Override
+	public void init() throws ServletException
+	{
+		super.init();
+		executor.scheduleAtFixedRate(
+				new Runnable() {
+					@Override
+					public void run() {
+						System.out.println("Bla");
+						for (TailorSocket member : _members) {
+							System.out.println("Trying to send to Member!");
+							if (member.isOpen()) {
+								System.out.println("Sending!");
+								try {
+									member.sendMessage("Sending a Message to you Guys! " + new Date() + "\n");
+								} catch (IOException e) {
+									e.printStackTrace();
+								}
+							}
+						}					
+						
+					}
+				}
+				, 2, 2, TimeUnit.SECONDS);
+		
+	}
+	
+	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
+		
+		getServletContext().getNamedDispatcher("default").forward(request, response);
+		
+	}
+
+	public WebSocket doWebSocketConnect(HttpServletRequest request,
+			String protocol) {
+		return new TailorSocket();
+	}
+	
+
+	class TailorSocket implements WebSocket.OnTextMessage {
+		private Connection _connection;
+
+		@Override
+		public void onClose(int closeCode, String message) {
+			_members.remove(this);
+		}
+
+		public void sendMessage(String data) throws IOException {
+			_connection.sendMessage(data);
+		}
+
+		@Override
+		public void onMessage(String data) {
+			System.out.println("Received: " + data);
+		}
+
+		public boolean isOpen() {
+			return _connection.isOpen();
+		}
+
+		@Override
+		public void onOpen(Connection connection) {
+			_members.add(this);
+			_connection = connection;
+			try {
+				connection
+						.sendMessage("Server received Web Socket upgrade and added it to Receiver List.");
+			} catch (IOException e) {
+				e.printStackTrace();
+			}
+		}
+	}
+	
+}
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,199 @@
+package spoofax.ace.tokenize;
+
+import java.util.Hashtable;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.jsglr.client.imploder.IToken;
+import org.spoofax.jsglr.client.imploder.ITokenizer;
+import org.spoofax.jsglr.client.imploder.ImploderAttachment;
+
+public class Tokenizer {
+	
+	
+	private static boolean AddTermInfoToEditorTokensHash(Hashtable<IToken,String> list, IStrategoTerm term, String msg)
+	{
+		//System.out.println(term.toString());
+		ImploderAttachment ia = term.getAttachment(ImploderAttachment.TYPE);
+		if (ia != null)
+		{
+			list.put(ia.getLeftToken(), msg);
+			list.put(ia.getRightToken(), msg);
+			return true;
+		} else {
+			if (term.getSubtermCount() > 0)
+				for (IStrategoTerm x : term.getAllSubterms())
+					if (AddTermInfoToEditorTokensHash(list, x, msg))
+						return true;
+		}
+		return false;
+	}
+	
+	public static String Tokenize(IStrategoTerm result, String sourcecode)
+	{
+		if (result == null)
+			return "Parse Error";
+		  String[] sourceLines = sourcecode.split("\r\n|\r|\n"); 
+		  int sourceLength = sourceLines.length+1;
+		  
+		  IStrategoTerm ast = result.getSubterm(0);
+		  IStrategoTerm list = result.getSubterm(1);
+		  IStrategoTerm err = list.getSubterm(0);
+		  IStrategoTerm warn = list.getSubterm(1);
+		  IStrategoTerm note = list.getSubterm(2);
+		  
+		  Hashtable<IToken,String> errorTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< err.getSubtermCount(); i++)
+			  if (err.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(errorTokens, err.getSubterm(i).getSubterm(0), err.getSubterm(i).getSubterm(1).toString());
+		  
+		  Hashtable<IToken,String> warningTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< warn.getSubtermCount(); i++)
+			  if (warn.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(warningTokens, warn.getSubterm(i).getSubterm(0), warn.getSubterm(i).getSubterm(1).toString());
+
+		  
+		  Hashtable<IToken,String> noteTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< note.getSubtermCount(); i++)
+			  if (note.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(noteTokens, note.getSubterm(i).getSubterm(0), note.getSubterm(i).getSubterm(1).toString());
+
+		  
+		  
+		  
+		  IToken lefttoken = ImploderAttachment.getLeftToken(ast);
+		  ITokenizer tokenizer = lefttoken.getTokenizer();
+		  
+		  
+		  
+		  StringBuilder errors = new StringBuilder();
+		  errors.append("");
+		  
+		  
+		  StringBuilder[] tokens = new StringBuilder[sourceLength+1];
+		  //System.out.println("Src length: "+ sourceLength);
+		  for (int i = 0; i < sourceLength; i++)
+			  tokens[i] = new StringBuilder();
+		  
+		  
+		  
+		  //bespintokens in an array per LOC
+		  for(int i = 0; i < tokenizer.getTokenCount(); i++) {
+				final IToken x = tokenizer.getTokenAt(i);
+				final int start = x.getColumn();
+				final int end = x.getEndOffset() - x.getStartOffset() + start + 1;
+				
+				String bespinType = convertTokenType(x.getKind());
+				//System.out.println(x.getKind() + "  -  " + x.toString());
+				if (noteTokens.containsKey(x))
+				{
+					errors.append(createInfoToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.deprecated";
+				} 				
+				if (warningTokens.containsKey(x))
+				{
+					errors.append(createWarningToken(x.getLine()-1, x.getColumn(), warningTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.deprecated";
+				} 	
+				if (errorTokens.containsKey(x))
+				{
+					errors.append(createErrorToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.illegal";
+				} 
+				tokens[x.getLine()-1].append("  " + createBespinToken(x.toString(), bespinType, start, end, x.getLine()) + "\n,");
+				//System.out.println(createBespinToken(x.toString(), convertTokenType(x.getKind()), start, end, x.getLine()));
+		  }
+		  
+		  StringBuilder json = new StringBuilder();
+		  json.append("{\"parsed\": [\n");
+		  for (int i = 0; i < sourceLines.length; i++)
+		  {
+			  //String safeJson = sourceLines[i].replaceAll("\"", "\\\\\"");
+			  String safeJson = sourceLines[i].replaceAll("\"", "");
+			  safeJson = safeJson.replaceAll("	", "\\\\\\t");
+					  
+			  json.append("{\"text\":\""+safeJson+"\",\"tokens\":[\n");
+			  if (tokens[i].length() > 0)
+				  json.append("  "+tokens[i].substring(0, tokens[i].length() -1 ) + "\n");
+			  json.append("]},\n");
+		  }
+		  
+		  json.deleteCharAt(json.length()-2);
+		  if (errors.length() > 0)
+			  errors.deleteCharAt(errors.length()-2);
+		  
+		  json.append("], \"errors\": [");
+		  json.append(errors);
+		  json.append("] }\n");
+		  
+		  
+	  
+		  
+		  
+		  return json.toString();
+	}
+	
+	
+	private static String createBespinToken(String value, String tokentype, int startColumn, int endColumn, int lineNumber) {
+		String safeJson = value.replace('\n', ' ').replace('"', ' ');
+		safeJson = safeJson.replaceAll("	", "\\\\\\t");
+		String x = ""; 
+	     x += " {";
+         x += "   \"type\": \""+tokentype+"\",";
+         x += "	  \"value\": \""+safeJson+"\"," ;
+		 x += "   \"start\": \""+startColumn+"\"," ;
+		 x += "   \"end\": \""+endColumn+"\"," ;
+		 x += "   \"line\": \""+lineNumber+"\"" ;
+		 x += "  }";
+	      return x;
+	}
+	private static String createErrorToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"error\"" ;
+		 x += "  }";
+	      return x;
+	}
+	
+	private static String createWarningToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"warning\"" ;
+		 x += "  }";
+	      return x;
+	}
+	
+	private static String createInfoToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"info\"" ;
+		 x += "  }";
+	      return x;
+	}		
+	
+	
+	private static String convertTokenType(int kind) {
+		switch(kind) {
+		case IToken.TK_LAYOUT: return "comment";
+		case IToken.TK_NUMBER: return "constant";
+		case IToken.TK_OPERATOR: return "keyword.operator";
+		case IToken.TK_KEYWORD: return "keyword";
+		case IToken.TK_STRING: return "string";
+		case IToken.TK_IDENTIFIER: return "variable";
+		case IToken.TK_ERROR_KEYWORD: return "invalid.illegal";
+		
+		default: return "plain";
+		}
+	}
+
+
+}
+

Added: spoofax-ace/trunk/spoofax-ace/.classpath
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/.classpath	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<classpath>
+	<classpathentry kind="src" path="src"/>
+	<classpathentry kind="src" path="resources/java"/>
+	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER"/>
+	<classpathentry kind="lib" path="s2js.jar"/>
+	<classpathentry kind="lib" path="strategoxt.jar"/>
+	<classpathentry kind="output" path="bin"/>
+</classpath>

Added: spoofax-ace/trunk/spoofax-ace/.project
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/.project	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,39 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<projectDescription>
+	<name>spoofax-ace</name>
+	<comment></comment>
+	<projects>
+	</projects>
+	<buildSpec>
+		<buildCommand>
+			<name>org.eclipse.jdt.core.javabuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+		<buildCommand>
+			<name>org.eclipse.pde.ManifestBuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+		<buildCommand>
+			<name>org.eclipse.pde.SchemaBuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+		<buildCommand>
+			<name>com.google.gdt.eclipse.core.webAppProjectValidator</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+		<buildCommand>
+			<name>com.google.gwt.eclipse.core.gwtProjectValidator</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+	</buildSpec>
+	<natures>
+		<nature>org.eclipse.pde.PluginNature</nature>
+		<nature>org.eclipse.jdt.core.javanature</nature>
+		<nature>com.google.gwt.eclipse.core.gwtNature</nature>
+	</natures>
+</projectDescription>

Added: spoofax-ace/trunk/spoofax-ace/build.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/build.xml	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,121 @@
+<project default="jar">
+	<property file="build.properties" />
+	<property name="spoofaxproj" value=""/>
+	<property name="strentry" value=""/>
+
+
+	<target name="buildcloud9plugin" depends="jar">
+		<java fork="true" classname="spoofax.ace.SpoofaxToAce" failonerror="true">
+			<jvmarg line="-Xmx1536m -ss8m -XX:MaxPermSize=256m"/>
+			<classpath>
+				<pathelement location="s2a.jar"/>
+				<pathelement location="${strxt}"/>
+				<pathelement location="${s2js}/s2js.jar"/>
+			</classpath>
+			<arg value="--i"/>
+				<arg value="${spoofaxproj}"/>
+			<arg value="--jssglr"/>
+				<arg value="${jssglr}"/>
+			<arg value="--s2js"/>
+				<arg value="${s2js}"/>
+                        <arg value="--strlib"/>
+                                <arg value="${strlib}"/>
+                        <arg value="--strctrees"/>
+                                <arg value="${strctrees}"/>
+			<arg value="--cloud9plugin"/>
+				<arg value="${cloud9installationdir}"/>
+		</java>
+	</target>
+
+
+	<target name="buildaceditor" depends="jar">
+		<java fork="true" classname="spoofax.ace.SpoofaxToAce" failonerror="true">
+			<jvmarg line="-Xmx1536m -ss8m -XX:MaxPermSize=256m"/>
+			<classpath>
+				<pathelement location="s2a.jar"/>
+				<pathelement location="${strxt}"/>
+				<pathelement location="${s2js}/s2js.jar"/>
+			</classpath>
+			<arg value="--i"/>
+				<arg value="${spoofaxproj}"/>
+			<arg value="--jssglr"/>
+				<arg value="${jssglr}"/>
+			<arg value="--s2js"/>
+				<arg value="${s2js}"/>
+                        <arg value="--strlib"/>
+                                <arg value="${strlib}"/>
+                        <arg value="--strctrees"/>
+                                <arg value="${strctrees}"/>
+			<arg value="--wwwout"/>
+				<arg value="${wwwroot}"/>
+			<arg value="--testsrc"/>
+				<arg value="${testsrc}"/>
+		</java>
+	</target>
+
+
+        <target name="build" depends="jar">
+                <java fork="true" classname="spoofax.ace.SpoofaxToAce" failonerror="true">
+                        <jvmarg line="-Xmx1536m -ss8m -XX:MaxPermSize=256m"/>
+                        <classpath>
+                                <pathelement location="s2a.jar"/>
+                                <pathelement location="${strxt}"/>
+                                <pathelement location="${s2js}/s2js.jar"/>
+                        </classpath>
+                        <arg value="--i"/>
+                                <arg value="${spoofaxproj}"/>
+                        <arg value="--jssglr"/>
+                                <arg value="${jssglr}"/>
+                        <arg value="--s2js"/>
+                                <arg value="${s2js}"/>
+                        <arg value="--strlib"/>
+                                <arg value="${strlib}"/>
+                        <arg value="--strctrees"/>
+                                <arg value="${strctrees}"/>
+                        <arg value="--testsrc"/>
+                                <arg value="${testsrc}"/>
+			<arg value="--cliexecutable"/>
+				<arg value="prog.js"/>
+			<arg value="--withserver"/>
+				<arg value="s2aserver/"/>
+                </java>
+        </target>
+
+	<target name="clean">
+		<delete dir="bin"/>
+		<delete dir="out"/>
+		<delete dir="wwwroot"/>
+		<delete dir="tmp"/>
+		<delete file="s2a.jar"/>
+		<delete file="prog.jar"/>
+		<delete>
+			<fileset dir="." includes="*.js" excludes="XMLHttpRequest.js"/>
+		</delete>
+	</target>
+
+	<target name="compile">
+		<mkdir dir="bin"/>
+		<javac srcdir="src" destdir="bin">
+			<classpath>
+				<pathelement location="${s2js}/s2js.jar"/>
+				<pathelement location="${strxt}"/>
+			</classpath>
+		</javac>
+
+		<copy todir="bin">
+			<fileset dir="src">
+				<exclude name="**/*.java" />
+			</fileset>
+		</copy>
+	</target>
+
+
+	<target name="jar" depends="compile">
+		<jar destfile="s2a.jar" basedir="bin">
+			<fileset dir="${resourcesDir}" />
+			<manifest>
+				<attribute name="Main-Class" value="spoofax.ace.SpoofaxToAce"/>
+			</manifest>
+		</jar>
+	</target>
+</project>

Added: spoofax-ace/trunk/spoofax-ace/graph/Makefile
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/graph/Makefile	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,15 @@
+DATAFILESWITHPATH  	:= $(wildcard data/*_js_parse.data) #note a $name.parse.data must also exist
+DATAFILESWITHOUTPATH   	:= $(subst data/, ,$(DATAFILESWITHPATH))
+
+all: 	$(DATAFILESWITHOUTPATH)
+
+%_js_parse.data:
+	@mkdir -p output
+	@$(eval fn:=$(subst _analyze.data, ,$*))
+	@scripts/build.sh $(fn)
+	@rm -f output/$(fn).png
+	@mv $(fn).png output/$(fn).png
+	@echo Created output/$(fn).png
+
+clean:
+	rm -rf output/*.png

Added: spoofax-ace/trunk/spoofax-ace/graph/scripts/build.sh
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/graph/scripts/build.sh	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,2 @@
+#!/bin/sh
+sed "s/testname/$1/g" "scripts/gnuplot.script" | gnuplot

Added: spoofax-ace/trunk/spoofax-ace/graph/scripts/gnuplot.script
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/graph/scripts/gnuplot.script	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,18 @@
+set terminal png
+set output "testname.png"
+set title "testname"
+set style line 1 lt 1 lw 3 pt 3 linecolor rgb "red"
+set style line 2 lt 2 lw 3 pt 3 linecolor rgb "green"
+set style line 3 lt 3 lw 3 pt 3 linecolor rgb "blue"
+set style line 4 lt 4 lw 3 pt 3 linecolor rgb "orange"
+
+plot \
+	"<sort -n data/testname_js_parse.data" using 1:2 smooth sbezier with lines title "JavaScript Parse time" linetype 1, \
+	"<sort -n data/testname_js_analyze.data" using 1:2 smooth sbezier with lines  title "JavaScript Analyze time" linetype 2, \
+	"<sort -n data/testname_js_parse.data" using 1:2 notitle linetype 1, \
+	"<sort -n data/testname_js_analyze.data" using 1:2 notitle linetype 2, \
+        "<sort -n data/testname_java_parse.data" using 1:2 smooth sbezier with lines title "Java Parse time" linetype 3, \
+        "<sort -n data/testname_java_analyze.data" using 1:2 smooth sbezier with lines  title "Java Analyze time" linetype 4, \
+        "<sort -n data/testname_java_parse.data" using 1:2 notitle linetype 3, \
+        "<sort -n data/testname_java_analyze.data" using 1:2 notitle linetype 4
+

Added: spoofax-ace/trunk/spoofax-ace/graph/server.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/graph/server.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,53 @@
+#!/usr/local/bin/node
+var net = require('net');
+var fs = require('fs');
+var server = net.createServer(function (socket) {
+	socket.setEncoding('ascii');
+	socket.on('data', function(data) {
+		dataReciever(data);
+		socket.end("x");
+	});
+});
+console.log("Starting server");
+server.listen(8889, "127.0.0.1");
+
+//Parse
+/* 
+ * Protocol:
+ *  #type#langname#x#y
+ * e.g.:
+ *
+ *  #analyze#language#20#123#
+ * Would append data/language.analyze.data with "20\t123\r\n" 
+ *
+ *  parse#language#20#123#
+ * Would append data/language.parse.data with "20\t123\r\n"  
+*/
+var dataReciever = function(data)
+{
+	var spl = data.split("#");
+	if (spl.length === 6)
+	{
+		var fn = "data/"+spl[2]+"."+spl[1]+".data";
+		var data = spl[3] + "\t" + spl[4];
+		appendFile(fn, data);
+		console.log("written \""+data+"\" to:" + fn);
+	} else
+	{
+		console.log("Ignored data: " + spl + ". length=" + spl.length);
+	}
+	
+};
+
+var appendFile = function(filename, data)
+{
+	fs.open(filename, 'a', undefined, function(err, fd) {
+		if(err) throw err;
+		fs.write(fd, data+"\r\n", undefined, undefined, function(err, written) {
+			if(err) throw err;
+			fs.close(fd, function(err) {
+				if(err) throw err;
+			});
+		});
+	});
+};

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/require.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/require.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,1998 @@
+/** vim: et:ts=4:sw=4:sts=4
+ * @license RequireJS 0.25.0 Copyright (c) 2010-2011, The Dojo Foundation All Rights Reserved.
+ * Available via the MIT or new BSD license.
+ * see: http://github.com/jrburke/requirejs for details
+ */
+/*jslint strict: false, plusplus: false */
+/*global window: false, navigator: false, document: false, importScripts: false,
+  jQuery: false, clearInterval: false, setInterval: false, self: false,
+  setTimeout: false, opera: false */
+
+var requirejs, require, define;
+(function () {
+    //Change this version number for each release.
+    var version = "0.25.0",
+        commentRegExp = /(\/\*([\s\S]*?)\*\/|\/\/(.*)$)/mg,
+        cjsRequireRegExp = /require\(["']([^'"\s]+)["']\)/g,
+        currDirRegExp = /^\.\//,
+        jsSuffixRegExp = /\.js$/,
+        ostring = Object.prototype.toString,
+        ap = Array.prototype,
+        aps = ap.slice,
+        apsp = ap.splice,
+        isBrowser = !!(typeof window !== "undefined" && navigator && document),
+        isWebWorker = !isBrowser && typeof importScripts !== "undefined",
+        //PS3 indicates loaded and complete, but need to wait for complete
+        //specifically. Sequence is "loading", "loaded", execution,
+        // then "complete". The UA check is unfortunate, but not sure how
+        //to feature test w/o causing perf issues.
+        readyRegExp = isBrowser && navigator.platform === 'PLAYSTATION 3' ?
+                      /^complete$/ : /^(complete|loaded)$/,
+        defContextName = "_",
+        //Oh the tragedy, detecting opera. See the usage of isOpera for reason.
+        isOpera = typeof opera !== "undefined" && opera.toString() === "[object Opera]",
+        reqWaitIdPrefix = "_r@@",
+        empty = {},
+        contexts = {},
+        globalDefQueue = [],
+        interactiveScript = null,
+        isDone = false,
+        checkLoadedDepth = 0,
+        useInteractive = false,
+        req, cfg = {}, currentlyAddingScript, s, head, baseElement, scripts, script,
+        src, subPath, mainScript, dataMain, i, scrollIntervalId, setReadyState, ctx,
+        jQueryCheck, checkLoadedTimeoutId;
+
+    function isFunction(it) {
+        return ostring.call(it) === "[object Function]";
+    }
+
+    function isArray(it) {
+        return ostring.call(it) === "[object Array]";
+    }
+
+    /**
+     * Simple function to mix in properties from source into target,
+     * but only if target does not already have a property of the same name.
+     * This is not robust in IE for transferring methods that match
+     * Object.prototype names, but the uses of mixin here seem unlikely to
+     * trigger a problem related to that.
+     */
+    function mixin(target, source, force) {
+        for (var prop in source) {
+            if (!(prop in empty) && (!(prop in target) || force)) {
+                target[prop] = source[prop];
+            }
+        }
+        return req;
+    }
+
+    /**
+     * Constructs an error with a pointer to an URL with more information.
+     * @param {String} id the error ID that maps to an ID on a web page.
+     * @param {String} message human readable error.
+     * @param {Error} [err] the original error, if there is one.
+     *
+     * @returns {Error}
+     */
+    function makeError(id, msg, err) {
+        var e = new Error(msg + '\nhttp://requirejs.org/docs/errors.html#' + id);
+        if (err) {
+            e.originalError = err;
+        }
+        return e;
+    }
+
+    /**
+     * Used to set up package paths from a packagePaths or packages config object.
+     * @param {Object} pkgs the object to store the new package config
+     * @param {Array} currentPackages an array of packages to configure
+     * @param {String} [dir] a prefix dir to use.
+     */
+    function configurePackageDir(pkgs, currentPackages, dir) {
+        var i, location, pkgObj;
+
+        for (i = 0; (pkgObj = currentPackages[i]); i++) {
+            pkgObj = typeof pkgObj === "string" ? { name: pkgObj } : pkgObj;
+            location = pkgObj.location;
+
+            //Add dir to the path, but avoid paths that start with a slash
+            //or have a colon (indicates a protocol)
+            if (dir && (!location || (location.indexOf("/") !== 0 && location.indexOf(":") === -1))) {
+                location = dir + "/" + (location || pkgObj.name);
+            }
+
+            //Create a brand new object on pkgs, since currentPackages can
+            //be passed in again, and config.pkgs is the internal transformed
+            //state for all package configs.
+            pkgs[pkgObj.name] = {
+                name: pkgObj.name,
+                location: location || pkgObj.name,
+                //Remove leading dot in main, so main paths are normalized,
+                //and remove any trailing .js, since different package
+                //envs have different conventions: some use a module name,
+                //some use a file name.
+                main: (pkgObj.main || "main")
+                      .replace(currDirRegExp, '')
+                      .replace(jsSuffixRegExp, '')
+            };
+        }
+    }
+
+    /**
+     * jQuery 1.4.3-1.5.x use a readyWait/ready() pairing to hold DOM
+     * ready callbacks, but jQuery 1.6 supports a holdReady() API instead.
+     * At some point remove the readyWait/ready() support and just stick
+     * with using holdReady.
+     */
+    function jQueryHoldReady($, shouldHold) {
+        if ($.holdReady) {
+            $.holdReady(shouldHold);
+        } else if (shouldHold) {
+            $.readyWait += 1;
+        } else {
+            $.ready(true);
+        }
+    }
+
+    if (typeof define !== "undefined") {
+        //If a define is already in play via another AMD loader,
+        //do not overwrite.
+        return;
+    }
+
+    if (typeof requirejs !== "undefined") {
+        if (isFunction(requirejs)) {
+            //Do not overwrite and existing requirejs instance.
+            return;
+        } else {
+            cfg = requirejs;
+            requirejs = undefined;
+        }
+    }
+
+    //Allow for a require config object
+    if (typeof require !== "undefined" && !isFunction(require)) {
+        //assume it is a config object.
+        cfg = require;
+        require = undefined;
+    }
+
+    /**
+     * Creates a new context for use in require and define calls.
+     * Handle most of the heavy lifting. Do not want to use an object
+     * with prototype here to avoid using "this" in require, in case it
+     * needs to be used in more super secure envs that do not want this.
+     * Also there should not be that many contexts in the page. Usually just
+     * one for the default context, but could be extra for multiversion cases
+     * or if a package needs a special context for a dependency that conflicts
+     * with the standard context.
+     */
+    function newContext(contextName) {
+        var context, resume,
+            config = {
+                waitSeconds: 7,
+                baseUrl: s.baseUrl || "./",
+                paths: {},
+                pkgs: {}
+            },
+            defQueue = [],
+            specified = {
+                "require": true,
+                "exports": true,
+                "module": true
+            },
+            urlMap = {},
+            defined = {},
+            loaded = {},
+            waiting = {},
+            waitAry = [],
+            waitIdCounter = 0,
+            managerCallbacks = {},
+            plugins = {},
+            pluginsQueue = {},
+            resumeDepth = 0,
+            normalizedWaiting = {};
+
+        /**
+         * Trims the . and .. from an array of path segments.
+         * It will keep a leading path segment if a .. will become
+         * the first path segment, to help with module name lookups,
+         * which act like paths, but can be remapped. But the end result,
+         * all paths that use this function should look normalized.
+         * NOTE: this method MODIFIES the input array.
+         * @param {Array} ary the array of path segments.
+         */
+        function trimDots(ary) {
+            var i, part;
+            for (i = 0; (part = ary[i]); i++) {
+                if (part === ".") {
+                    ary.splice(i, 1);
+                    i -= 1;
+                } else if (part === "..") {
+                    if (i === 1 && (ary[2] === '..' || ary[0] === '..')) {
+                        //End of the line. Keep at least one non-dot
+                        //path segment at the front so it can be mapped
+                        //correctly to disk. Otherwise, there is likely
+                        //no path mapping for a path starting with '..'.
+                        //This can still fail, but catches the most reasonable
+                        //uses of ..
+                        break;
+                    } else if (i > 0) {
+                        ary.splice(i - 1, 2);
+                        i -= 2;
+                    }
+                }
+            }
+        }
+
+        /**
+         * Given a relative module name, like ./something, normalize it to
+         * a real name that can be mapped to a path.
+         * @param {String} name the relative name
+         * @param {String} baseName a real name that the name arg is relative
+         * to.
+         * @returns {String} normalized name
+         */
+        function normalize(name, baseName) {
+            var pkgName, pkgConfig;
+
+            //Adjust any relative paths.
+            if (name.charAt(0) === ".") {
+                //If have a base name, try to normalize against it,
+                //otherwise, assume it is a top-level require that will
+                //be relative to baseUrl in the end.
+                if (baseName) {
+                    if (config.pkgs[baseName]) {
+                        //If the baseName is a package name, then just treat it as one
+                        //name to concat the name with.
+                        baseName = [baseName];
+                    } else {
+                        //Convert baseName to array, and lop off the last part,
+                        //so that . matches that "directory" and not name of the baseName's
+                        //module. For instance, baseName of "one/two/three", maps to
+                        //"one/two/three.js", but we want the directory, "one/two" for
+                        //this normalization.
+                        baseName = baseName.split("/");
+                        baseName = baseName.slice(0, baseName.length - 1);
+                    }
+
+                    name = baseName.concat(name.split("/"));
+                    trimDots(name);
+
+                    //Some use of packages may use a . path to reference the
+                    //"main" module name, so normalize for that.
+                    pkgConfig = config.pkgs[(pkgName = name[0])];
+                    name = name.join("/");
+                    if (pkgConfig && name === pkgName + '/' + pkgConfig.main) {
+                        name = pkgName;
+                    }
+                }
+            }
+            return name;
+        }
+
+        /**
+         * Creates a module mapping that includes plugin prefix, module
+         * name, and path. If parentModuleMap is provided it will
+         * also normalize the name via require.normalize()
+         *
+         * @param {String} name the module name
+         * @param {String} [parentModuleMap] parent module map
+         * for the module name, used to resolve relative names.
+         *
+         * @returns {Object}
+         */
+        function makeModuleMap(name, parentModuleMap) {
+            var index = name ? name.indexOf("!") : -1,
+                prefix = null,
+                parentName = parentModuleMap ? parentModuleMap.name : null,
+                originalName = name,
+                normalizedName, url, pluginModule;
+
+            if (index !== -1) {
+                prefix = name.substring(0, index);
+                name = name.substring(index + 1, name.length);
+            }
+
+            if (prefix) {
+                prefix = normalize(prefix, parentName);
+            }
+
+            //Account for relative paths if there is a base name.
+            if (name) {
+                if (prefix) {
+                    pluginModule = defined[prefix];
+                    if (pluginModule) {
+                        //Plugin is loaded, use its normalize method, otherwise,
+                        //normalize name as usual.
+                        if (pluginModule.normalize) {
+                            normalizedName = pluginModule.normalize(name, function (name) {
+                                return normalize(name, parentName);
+                            });
+                        } else {
+                            normalizedName = normalize(name, parentName);
+                        }
+                    } else {
+                        //Plugin is not loaded yet, so do not normalize
+                        //the name, wait for plugin to load to see if
+                        //it has a normalize method. To avoid possible
+                        //ambiguity with relative names loaded from another
+                        //plugin, use the parent's name as part of this name.
+                        normalizedName = '__$p' + parentName + '@' + name;
+                    }
+                } else {
+                    normalizedName = normalize(name, parentName);
+                }
+
+                url = urlMap[normalizedName];
+                if (!url) {
+                    //Calculate url for the module, if it has a name.
+                    if (req.toModuleUrl) {
+                        //Special logic required for a particular engine,
+                        //like Node.
+                        url = req.toModuleUrl(context, normalizedName, parentModuleMap);
+                    } else {
+                        url = context.nameToUrl(normalizedName, null, parentModuleMap);
+                    }
+
+                    //Store the URL mapping for later.
+                    urlMap[normalizedName] = url;
+                }
+            }
+
+            return {
+                prefix: prefix,
+                name: normalizedName,
+                parentMap: parentModuleMap,
+                url: url,
+                originalName: originalName,
+                fullName: prefix ? prefix + "!" + normalizedName : normalizedName
+            };
+        }
+
+        /**
+         * Determine if priority loading is done. If so clear the priorityWait
+         */
+        function isPriorityDone() {
+            var priorityDone = true,
+                priorityWait = config.priorityWait,
+                priorityName, i;
+            if (priorityWait) {
+                for (i = 0; (priorityName = priorityWait[i]); i++) {
+                    if (!loaded[priorityName]) {
+                        priorityDone = false;
+                        break;
+                    }
+                }
+                if (priorityDone) {
+                    delete config.priorityWait;
+                }
+            }
+            return priorityDone;
+        }
+
+        /**
+         * Helper function that creates a setExports function for a "module"
+         * CommonJS dependency. Do this here to avoid creating a closure that
+         * is part of a loop.
+         */
+        function makeSetExports(moduleObj) {
+            return function (exports) {
+                moduleObj.exports = exports;
+            };
+        }
+
+        function makeContextModuleFunc(func, relModuleMap, enableBuildCallback) {
+            return function () {
+                //A version of a require function that passes a moduleName
+                //value for items that may need to
+                //look up paths relative to the moduleName
+                var args = [].concat(aps.call(arguments, 0)), lastArg;
+                if (enableBuildCallback &&
+                    isFunction((lastArg = args[args.length - 1]))) {
+                    lastArg.__requireJsBuild = true;
+                }
+                args.push(relModuleMap);
+                return func.apply(null, args);
+            };
+        }
+
+        /**
+         * Helper function that creates a require function object to give to
+         * modules that ask for it as a dependency. It needs to be specific
+         * per module because of the implication of path mappings that may
+         * need to be relative to the module name.
+         */
+        function makeRequire(relModuleMap, enableBuildCallback) {
+            var modRequire = makeContextModuleFunc(context.require, relModuleMap, enableBuildCallback);
+
+            mixin(modRequire, {
+                nameToUrl: makeContextModuleFunc(context.nameToUrl, relModuleMap),
+                toUrl: makeContextModuleFunc(context.toUrl, relModuleMap),
+                defined: makeContextModuleFunc(context.requireDefined, relModuleMap),
+                specified: makeContextModuleFunc(context.requireSpecified, relModuleMap),
+                ready: req.ready,
+                isBrowser: req.isBrowser
+            });
+            //Something used by node.
+            if (req.paths) {
+                modRequire.paths = req.paths;
+            }
+            return modRequire;
+        }
+
+        /**
+         * Used to update the normalized name for plugin-based dependencies
+         * after a plugin loads, since it can have its own normalization structure.
+         * @param {String} pluginName the normalized plugin module name.
+         */
+        function updateNormalizedNames(pluginName) {
+
+            var oldFullName, oldModuleMap, moduleMap, fullName, callbacks,
+                i, j, k, depArray, existingCallbacks,
+                maps = normalizedWaiting[pluginName];
+
+            if (maps) {
+                for (i = 0; (oldModuleMap = maps[i]); i++) {
+                    oldFullName = oldModuleMap.fullName;
+                    moduleMap = makeModuleMap(oldModuleMap.originalName, oldModuleMap.parentMap);
+                    fullName = moduleMap.fullName;
+                    //Callbacks could be undefined if the same plugin!name was
+                    //required twice in a row, so use empty array in that case.
+                    callbacks = managerCallbacks[oldFullName] || [];
+                    existingCallbacks = managerCallbacks[fullName];
+
+                    if (fullName !== oldFullName) {
+                        //Update the specified object, but only if it is already
+                        //in there. In sync environments, it may not be yet.
+                        if (oldFullName in specified) {
+                            delete specified[oldFullName];
+                            specified[fullName] = true;
+                        }
+
+                        //Update managerCallbacks to use the correct normalized name.
+                        //If there are already callbacks for the normalized name,
+                        //just add to them.
+                        if (existingCallbacks) {
+                            managerCallbacks[fullName] = existingCallbacks.concat(callbacks);
+                        } else {
+                            managerCallbacks[fullName] = callbacks;
+                        }
+                        delete managerCallbacks[oldFullName];
+
+                        //In each manager callback, update the normalized name in the depArray.
+                        for (j = 0; j < callbacks.length; j++) {
+                            depArray = callbacks[j].depArray;
+                            for (k = 0; k < depArray.length; k++) {
+                                if (depArray[k] === oldFullName) {
+                                    depArray[k] = fullName;
+                                }
+                            }
+                        }
+                    }
+                }
+            }
+
+            delete normalizedWaiting[pluginName];
+        }
+
+        /*
+         * Queues a dependency for checking after the loader is out of a
+         * "paused" state, for example while a script file is being loaded
+         * in the browser, where it may have many modules defined in it.
+         *
+         * depName will be fully qualified, no relative . or .. path.
+         */
+        function queueDependency(dep) {
+            //Make sure to load any plugin and associate the dependency
+            //with that plugin.
+            var prefix = dep.prefix,
+                fullName = dep.fullName;
+
+            //Do not bother if the depName is already in transit
+            if (specified[fullName] || fullName in defined) {
+                return;
+            }
+
+            if (prefix && !plugins[prefix]) {
+                //Queue up loading of the dependency, track it
+                //via context.plugins. Mark it as a plugin so
+                //that the build system will know to treat it
+                //special.
+                plugins[prefix] = undefined;
+
+                //Remember this dep that needs to have normaliztion done
+                //after the plugin loads.
+                (normalizedWaiting[prefix] || (normalizedWaiting[prefix] = []))
+                    .push(dep);
+
+                //Register an action to do once the plugin loads, to update
+                //all managerCallbacks to use a properly normalized module
+                //name.
+                (managerCallbacks[prefix] ||
+                (managerCallbacks[prefix] = [])).push({
+                    onDep: function (name, value) {
+                        if (name === prefix) {
+                            updateNormalizedNames(prefix);
+                        }
+                    }
+                });
+
+                queueDependency(makeModuleMap(prefix));
+            }
+
+            context.paused.push(dep);
+        }
+
+        function execManager(manager) {
+            var i, ret, waitingCallbacks, err,
+                cb = manager.callback,
+                fullName = manager.fullName,
+                args = [],
+                ary = manager.depArray;
+
+            //Call the callback to define the module, if necessary.
+            if (cb && isFunction(cb)) {
+                //Pull out the defined dependencies and pass the ordered
+                //values to the callback.
+                if (ary) {
+                    for (i = 0; i < ary.length; i++) {
+                        args.push(manager.deps[ary[i]]);
+                    }
+                }
+
+                try {
+                    ret = req.execCb(fullName, manager.callback, args, defined[fullName]);
+                } catch (e) {
+                    err = e;
+                }
+
+                if (fullName) {
+                    //If setting exports via "module" is in play,
+                    //favor that over return value and exports. After that,
+                    //favor a non-undefined return value over exports use.
+                    if (manager.cjsModule && manager.cjsModule.exports !== undefined) {
+                        ret = defined[fullName] = manager.cjsModule.exports;
+                    } else if (ret === undefined && manager.usingExports) {
+                        //exports already set the defined value.
+                        ret = defined[fullName];
+                    } else {
+                        //Use the return value from the function.
+                        defined[fullName] = ret;
+                    }
+                }
+            } else if (fullName) {
+                //May just be an object definition for the module. Only
+                //worry about defining if have a module name.
+                ret = defined[fullName] = cb;
+            }
+
+            //Clean up waiting. Do this before error calls, and before
+            //calling back waitingCallbacks, so that bookkeeping is correct
+            //in the event of an error and error is reported in correct order,
+            //since the waitingCallbacks will likely have errors if the
+            //onError function does not throw.
+            if (waiting[manager.waitId]) {
+                delete waiting[manager.waitId];
+                manager.isDone = true;
+                context.waitCount -= 1;
+                if (context.waitCount === 0) {
+                    //Clear the wait array used for cycles.
+                    waitAry = [];
+                }
+            }
+
+            if (err) {
+                err = makeError('defineerror', 'Error evaluating ' +
+                                'module "' + fullName + '" at location "' +
+                                (fullName ? makeModuleMap(fullName).url : '') + '":\n' +
+                                err + '\nfileName:' + (err.fileName || err.sourceURL) +
+                                '\nlineNumber: ' + (err.lineNumber || err.line), err);
+                err.moduleName = fullName;
+                return req.onError(err);
+            }
+
+            if (fullName) {
+                //If anything was waiting for this module to be defined,
+                //notify them now.
+                waitingCallbacks = managerCallbacks[fullName];
+                if (waitingCallbacks) {
+                    for (i = 0; i < waitingCallbacks.length; i++) {
+                        waitingCallbacks[i].onDep(fullName, ret);
+                    }
+                    delete managerCallbacks[fullName];
+                }
+            }
+
+            return undefined;
+        }
+
+        function main(inName, depArray, callback, relModuleMap) {
+            var moduleMap = makeModuleMap(inName, relModuleMap),
+                name = moduleMap.name,
+                fullName = moduleMap.fullName,
+                uniques = {},
+                manager = {
+                    //Use a wait ID because some entries are anon
+                    //async require calls.
+                    waitId: name || reqWaitIdPrefix + (waitIdCounter++),
+                    depCount: 0,
+                    depMax: 0,
+                    prefix: moduleMap.prefix,
+                    name: name,
+                    fullName: fullName,
+                    deps: {},
+                    depArray: depArray,
+                    callback: callback,
+                    onDep: function (depName, value) {
+                        if (!(depName in manager.deps)) {
+                            manager.deps[depName] = value;
+                            manager.depCount += 1;
+                            if (manager.depCount === manager.depMax) {
+                                //All done, execute!
+                                execManager(manager);
+                            }
+                        }
+                    }
+                },
+                i, depArg, depName, cjsMod;
+
+            if (fullName) {
+                //If module already defined for context, or already loaded,
+                //then leave. Also leave if jQuery is registering but it does
+                //not match the desired version number in the config.
+                if (fullName in defined || loaded[fullName] === true ||
+                    (fullName === "jquery" && config.jQuery &&
+                     config.jQuery !== callback().fn.jquery)) {
+                    return;
+                }
+
+                //Set specified/loaded here for modules that are also loaded
+                //as part of a layer, where onScriptLoad is not fired
+                //for those cases. Do this after the inline define and
+                //dependency tracing is done.
+                specified[fullName] = true;
+                loaded[fullName] = true;
+
+                //If module is jQuery set up delaying its dom ready listeners.
+                if (fullName === "jquery" && callback) {
+                    jQueryCheck(callback());
+                }
+            }
+
+            //Add the dependencies to the deps field, and register for callbacks
+            //on the dependencies.
+            for (i = 0; i < depArray.length; i++) {
+                depArg = depArray[i];
+                //There could be cases like in IE, where a trailing comma will
+                //introduce a null dependency, so only treat a real dependency
+                //value as a dependency.
+                if (depArg) {
+                    //Split the dependency name into plugin and name parts
+                    depArg = makeModuleMap(depArg, (name ? moduleMap : relModuleMap));
+                    depName = depArg.fullName;
+
+                    //Fix the name in depArray to be just the name, since
+                    //that is how it will be called back later.
+                    depArray[i] = depName;
+
+                    //Fast path CommonJS standard dependencies.
+                    if (depName === "require") {
+                        manager.deps[depName] = makeRequire(moduleMap);
+                    } else if (depName === "exports") {
+                        //CommonJS module spec 1.1
+                        manager.deps[depName] = defined[fullName] = {};
+                        manager.usingExports = true;
+                    } else if (depName === "module") {
+                        //CommonJS module spec 1.1
+                        manager.cjsModule = cjsMod = manager.deps[depName] = {
+                            id: name,
+                            uri: name ? context.nameToUrl(name, null, relModuleMap) : undefined,
+                            exports: defined[fullName]
+                        };
+                        cjsMod.setExports = makeSetExports(cjsMod);
+                    } else if (depName in defined && !(depName in waiting)) {
+                        //Module already defined, no need to wait for it.
+                        manager.deps[depName] = defined[depName];
+                    } else if (!uniques[depName]) {
+
+                        //A dynamic dependency.
+                        manager.depMax += 1;
+
+                        queueDependency(depArg);
+
+                        //Register to get notification when dependency loads.
+                        (managerCallbacks[depName] ||
+                        (managerCallbacks[depName] = [])).push(manager);
+
+                        uniques[depName] = true;
+                    }
+                }
+            }
+
+            //Do not bother tracking the manager if it is all done.
+            if (manager.depCount === manager.depMax) {
+                //All done, execute!
+                execManager(manager);
+            } else {
+                waiting[manager.waitId] = manager;
+                waitAry.push(manager);
+                context.waitCount += 1;
+            }
+        }
+
+        /**
+         * Convenience method to call main for a define call that was put on
+         * hold in the defQueue.
+         */
+        function callDefMain(args) {
+            main.apply(null, args);
+            //Mark the module loaded. Must do it here in addition
+            //to doing it in define in case a script does
+            //not call define
+            loaded[args[0]] = true;
+        }
+
+        /**
+         * jQuery 1.4.3+ supports ways to hold off calling
+         * calling jQuery ready callbacks until all scripts are loaded. Be sure
+         * to track it if the capability exists.. Also, since jQuery 1.4.3 does
+         * not register as a module, need to do some global inference checking.
+         * Even if it does register as a module, not guaranteed to be the precise
+         * name of the global. If a jQuery is tracked for this context, then go
+         * ahead and register it as a module too, if not already in process.
+         */
+        jQueryCheck = function (jqCandidate) {
+            if (!context.jQuery) {
+                var $ = jqCandidate || (typeof jQuery !== "undefined" ? jQuery : null);
+
+                if ($) {
+                    //If a specific version of jQuery is wanted, make sure to only
+                    //use this jQuery if it matches.
+                    if (config.jQuery && $.fn.jquery !== config.jQuery) {
+                        return;
+                    }
+
+                    if ("holdReady" in $ || "readyWait" in $) {
+                        context.jQuery = $;
+
+                        //Manually create a "jquery" module entry if not one already
+                        //or in process. Note this could trigger an attempt at
+                        //a second jQuery registration, but does no harm since
+                        //the first one wins, and it is the same value anyway.
+                        callDefMain(["jquery", [], function () {
+                            return jQuery;
+                        }]);
+
+                        //Ask jQuery to hold DOM ready callbacks.
+                        if (context.scriptCount) {
+                            jQueryHoldReady($, true);
+                            context.jQueryIncremented = true;
+                        }
+                    }
+                }
+            }
+        };
+
+        function forceExec(manager, traced) {
+            if (manager.isDone) {
+                return undefined;
+            }
+
+            var fullName = manager.fullName,
+                depArray = manager.depArray,
+                depName, i;
+            if (fullName) {
+                if (traced[fullName]) {
+                    return defined[fullName];
+                }
+
+                traced[fullName] = true;
+            }
+
+            //forceExec all of its dependencies.
+            for (i = 0; i < depArray.length; i++) {
+                //Some array members may be null, like if a trailing comma
+                //IE, so do the explicit [i] access and check if it has a value.
+                depName = depArray[i];
+                if (depName) {
+                    if (!manager.deps[depName] && waiting[depName]) {
+                        manager.onDep(depName, forceExec(waiting[depName], traced));
+                    }
+                }
+            }
+
+            return fullName ? defined[fullName] : undefined;
+        }
+
+        /**
+         * Checks if all modules for a context are loaded, and if so, evaluates the
+         * new ones in right dependency order.
+         *
+         * @private
+         */
+        function checkLoaded() {
+            var waitInterval = config.waitSeconds * 1000,
+                //It is possible to disable the wait interval by using waitSeconds of 0.
+                expired = waitInterval && (context.startTime + waitInterval) < new Date().getTime(),
+                noLoads = "", hasLoadedProp = false, stillLoading = false, prop,
+                err, manager;
+
+            //If there are items still in the paused queue processing wait.
+            //This is particularly important in the sync case where each paused
+            //item is processed right away but there may be more waiting.
+            if (context.pausedCount > 0) {
+                return undefined;
+            }
+
+            //Determine if priority loading is done. If so clear the priority. If
+            //not, then do not check
+            if (config.priorityWait) {
+                if (isPriorityDone()) {
+                    //Call resume, since it could have
+                    //some waiting dependencies to trace.
+                    resume();
+                } else {
+                    return undefined;
+                }
+            }
+
+            //See if anything is still in flight.
+            for (prop in loaded) {
+                if (!(prop in empty)) {
+                    hasLoadedProp = true;
+                    if (!loaded[prop]) {
+                        if (expired) {
+                            noLoads += prop + " ";
+                        } else {
+                            stillLoading = true;
+                            break;
+                        }
+                    }
+                }
+            }
+
+            //Check for exit conditions.
+            if (!hasLoadedProp && !context.waitCount) {
+                //If the loaded object had no items, then the rest of
+                //the work below does not need to be done.
+                return undefined;
+            }
+            if (expired && noLoads) {
+                //If wait time expired, throw error of unloaded modules.
+                err = makeError("timeout", "Load timeout for modules: " + noLoads);
+                err.requireType = "timeout";
+                err.requireModules = noLoads;
+                return req.onError(err);
+            }
+            if (stillLoading || context.scriptCount) {
+                //Something is still waiting to load. Wait for it, but only
+                //if a timeout is not already in effect.
+                if ((isBrowser || isWebWorker) && !checkLoadedTimeoutId) {
+                    checkLoadedTimeoutId = setTimeout(function () {
+                        checkLoadedTimeoutId = 0;
+                        checkLoaded();
+                    }, 50);
+                }
+                return undefined;
+            }
+
+            //If still have items in the waiting cue, but all modules have
+            //been loaded, then it means there are some circular dependencies
+            //that need to be broken.
+            //However, as a waiting thing is fired, then it can add items to
+            //the waiting cue, and those items should not be fired yet, so
+            //make sure to redo the checkLoaded call after breaking a single
+            //cycle, if nothing else loaded then this logic will pick it up
+            //again.
+            if (context.waitCount) {
+                //Cycle through the waitAry, and call items in sequence.
+                for (i = 0; (manager = waitAry[i]); i++) {
+                    forceExec(manager, {});
+                }
+
+                //Only allow this recursion to a certain depth. Only
+                //triggered by errors in calling a module in which its
+                //modules waiting on it cannot finish loading, or some circular
+                //dependencies that then may add more dependencies.
+                //The value of 5 is a bit arbitrary. Hopefully just one extra
+                //pass, or two for the case of circular dependencies generating
+                //more work that gets resolved in the sync node case.
+                if (checkLoadedDepth < 5) {
+                    checkLoadedDepth += 1;
+                    checkLoaded();
+                }
+            }
+
+            checkLoadedDepth = 0;
+
+            //Check for DOM ready, and nothing is waiting across contexts.
+            req.checkReadyState();
+
+            return undefined;
+        }
+
+        function callPlugin(pluginName, dep) {
+            var name = dep.name,
+                fullName = dep.fullName,
+                load;
+
+            //Do not bother if plugin is already defined or being loaded.
+            if (fullName in defined || fullName in loaded) {
+                return;
+            }
+
+            if (!plugins[pluginName]) {
+                plugins[pluginName] = defined[pluginName];
+            }
+
+            //Only set loaded to false for tracking if it has not already been set.
+            if (!loaded[fullName]) {
+                loaded[fullName] = false;
+            }
+
+            load = function (ret) {
+                //Allow the build process to register plugin-loaded dependencies.
+                if (req.onPluginLoad) {
+                    req.onPluginLoad(context, pluginName, name, ret);
+                }
+
+                execManager({
+                    prefix: dep.prefix,
+                    name: dep.name,
+                    fullName: dep.fullName,
+                    callback: function () {
+                        return ret;
+                    }
+                });
+                loaded[fullName] = true;
+            };
+
+            //Allow plugins to load other code without having to know the
+            //context or how to "complete" the load.
+            load.fromText = function (moduleName, text) {
+                /*jslint evil: true */
+                var hasInteractive = useInteractive;
+
+                //Indicate a the module is in process of loading.
+                context.loaded[moduleName] = false;
+                context.scriptCount += 1;
+
+                //Turn off interactive script matching for IE for any define
+                //calls in the text, then turn it back on at the end.
+                if (hasInteractive) {
+                    useInteractive = false;
+                }
+
+                req.exec(text);
+
+                if (hasInteractive) {
+                    useInteractive = true;
+                }
+
+                //Support anonymous modules.
+                context.completeLoad(moduleName);
+            };
+
+            //Use parentName here since the plugin's name is not reliable,
+            //could be some weird string with no path that actually wants to
+            //reference the parentName's path.
+            plugins[pluginName].load(name, makeRequire(dep.parentMap, true), load, config);
+        }
+
+        function loadPaused(dep) {
+            //Renormalize dependency if its name was waiting on a plugin
+            //to load, which as since loaded.
+            if (dep.prefix && dep.name.indexOf('__$p') === 0 && defined[dep.prefix]) {
+                dep = makeModuleMap(dep.originalName, dep.parentMap);
+            }
+
+            var pluginName = dep.prefix,
+                fullName = dep.fullName,
+                urlFetched = context.urlFetched;
+
+            //Do not bother if the dependency has already been specified.
+            if (specified[fullName] || loaded[fullName]) {
+                return;
+            } else {
+                specified[fullName] = true;
+            }
+
+            if (pluginName) {
+                //If plugin not loaded, wait for it.
+                //set up callback list. if no list, then register
+                //managerCallback for that plugin.
+                if (defined[pluginName]) {
+                    callPlugin(pluginName, dep);
+                } else {
+                    if (!pluginsQueue[pluginName]) {
+                        pluginsQueue[pluginName] = [];
+                        (managerCallbacks[pluginName] ||
+                        (managerCallbacks[pluginName] = [])).push({
+                            onDep: function (name, value) {
+                                if (name === pluginName) {
+                                    var i, oldModuleMap, ary = pluginsQueue[pluginName];
+
+                                    //Now update all queued plugin actions.
+                                    for (i = 0; i < ary.length; i++) {
+                                        oldModuleMap = ary[i];
+                                        //Update the moduleMap since the
+                                        //module name may be normalized
+                                        //differently now.
+                                        callPlugin(pluginName,
+                                                   makeModuleMap(oldModuleMap.originalName, oldModuleMap.parentMap));
+                                    }
+                                    delete pluginsQueue[pluginName];
+                                }
+                            }
+                        });
+                    }
+                    pluginsQueue[pluginName].push(dep);
+                }
+            } else {
+                if (!urlFetched[dep.url]) {
+                    req.load(context, fullName, dep.url);
+                    urlFetched[dep.url] = true;
+                }
+            }
+        }
+
+        /**
+         * Resumes tracing of dependencies and then checks if everything is loaded.
+         */
+        resume = function () {
+            var args, i, p;
+
+            resumeDepth += 1;
+
+            if (context.scriptCount <= 0) {
+                //Synchronous envs will push the number below zero with the
+                //decrement above, be sure to set it back to zero for good measure.
+                //require() calls that also do not end up loading scripts could
+                //push the number negative too.
+                context.scriptCount = 0;
+            }
+
+            //Make sure any remaining defQueue items get properly processed.
+            while (defQueue.length) {
+                args = defQueue.shift();
+                if (args[0] === null) {
+                    return req.onError(makeError('mismatch', 'Mismatched anonymous define() module: ' + args[args.length - 1]));
+                } else {
+                    callDefMain(args);
+                }
+            }
+
+            //Skip the resume of paused dependencies
+            //if current context is in priority wait.
+            if (!config.priorityWait || isPriorityDone()) {
+                while (context.paused.length) {
+                    p = context.paused;
+                    context.pausedCount += p.length;
+                    //Reset paused list
+                    context.paused = [];
+
+                    for (i = 0; (args = p[i]); i++) {
+                        loadPaused(args);
+                    }
+                    //Move the start time for timeout forward.
+                    context.startTime = (new Date()).getTime();
+                    context.pausedCount -= p.length;
+                }
+            }
+
+            //Only check if loaded when resume depth is 1. It is likely that
+            //it is only greater than 1 in sync environments where a factory
+            //function also then calls the callback-style require. In those
+            //cases, the checkLoaded should not occur until the resume
+            //depth is back at the top level.
+            if (resumeDepth === 1) {
+                checkLoaded();
+            }
+
+            resumeDepth -= 1;
+
+            return undefined;
+        };
+
+        //Define the context object. Many of these fields are on here
+        //just to make debugging easier.
+        context = {
+            contextName: contextName,
+            config: config,
+            defQueue: defQueue,
+            waiting: waiting,
+            waitCount: 0,
+            specified: specified,
+            loaded: loaded,
+            urlMap: urlMap,
+            scriptCount: 0,
+            urlFetched: {},
+            defined: defined,
+            paused: [],
+            pausedCount: 0,
+            plugins: plugins,
+            managerCallbacks: managerCallbacks,
+            makeModuleMap: makeModuleMap,
+            normalize: normalize,
+            /**
+             * Set a configuration for the context.
+             * @param {Object} cfg config object to integrate.
+             */
+            configure: function (cfg) {
+                var paths, prop, packages, pkgs, packagePaths, requireWait;
+
+                //Make sure the baseUrl ends in a slash.
+                if (cfg.baseUrl) {
+                    if (cfg.baseUrl.charAt(cfg.baseUrl.length - 1) !== "/") {
+                        cfg.baseUrl += "/";
+                    }
+                }
+
+                //Save off the paths and packages since they require special processing,
+                //they are additive.
+                paths = config.paths;
+                packages = config.packages;
+                pkgs = config.pkgs;
+
+                //Mix in the config values, favoring the new values over
+                //existing ones in context.config.
+                mixin(config, cfg, true);
+
+                //Adjust paths if necessary.
+                if (cfg.paths) {
+                    for (prop in cfg.paths) {
+                        if (!(prop in empty)) {
+                            paths[prop] = cfg.paths[prop];
+                        }
+                    }
+                    config.paths = paths;
+                }
+
+                packagePaths = cfg.packagePaths;
+                if (packagePaths || cfg.packages) {
+                    //Convert packagePaths into a packages config.
+                    if (packagePaths) {
+                        for (prop in packagePaths) {
+                            if (!(prop in empty)) {
+                                configurePackageDir(pkgs, packagePaths[prop], prop);
+                            }
+                        }
+                    }
+
+                    //Adjust packages if necessary.
+                    if (cfg.packages) {
+                        configurePackageDir(pkgs, cfg.packages);
+                    }
+
+                    //Done with modifications, assing packages back to context config
+                    config.pkgs = pkgs;
+                }
+
+                //If priority loading is in effect, trigger the loads now
+                if (cfg.priority) {
+                    //Hold on to requireWait value, and reset it after done
+                    requireWait = context.requireWait;
+
+                    //Allow tracing some require calls to allow the fetching
+                    //of the priority config.
+                    context.requireWait = false;
+
+                    //But first, call resume to register any defined modules that may
+                    //be in a data-main built file before the priority config
+                    //call. Also grab any waiting define calls for this context.
+                    context.takeGlobalQueue();
+                    resume();
+
+                    context.require(cfg.priority);
+
+                    //Trigger a resume right away, for the case when
+                    //the script with the priority load is done as part
+                    //of a data-main call. In that case the normal resume
+                    //call will not happen because the scriptCount will be
+                    //at 1, since the script for data-main is being processed.
+                    resume();
+
+                    //Restore previous state.
+                    context.requireWait = requireWait;
+                    config.priorityWait = cfg.priority;
+                }
+
+                //If a deps array or a config callback is specified, then call
+                //require with those args. This is useful when require is defined as a
+                //config object before require.js is loaded.
+                if (cfg.deps || cfg.callback) {
+                    context.require(cfg.deps || [], cfg.callback);
+                }
+
+                //Set up ready callback, if asked. Useful when require is defined as a
+                //config object before require.js is loaded.
+                if (cfg.ready) {
+                    req.ready(cfg.ready);
+                }
+            },
+
+            requireDefined: function (moduleName, relModuleMap) {
+                return makeModuleMap(moduleName, relModuleMap).fullName in defined;
+            },
+
+            requireSpecified: function (moduleName, relModuleMap) {
+                return makeModuleMap(moduleName, relModuleMap).fullName in specified;
+            },
+
+            require: function (deps, callback, relModuleMap) {
+                var moduleName, fullName, moduleMap;
+                if (typeof deps === "string") {
+                    //Synchronous access to one module. If require.get is
+                    //available (as in the Node adapter), prefer that.
+                    //In this case deps is the moduleName and callback is
+                    //the relModuleMap
+                    if (req.get) {
+                        return req.get(context, deps, callback);
+                    }
+
+                    //Just return the module wanted. In this scenario, the
+                    //second arg (if passed) is just the relModuleMap.
+                    moduleName = deps;
+                    relModuleMap = callback;
+
+                    //Normalize module name, if it contains . or ..
+                    moduleMap = makeModuleMap(moduleName, relModuleMap);
+                    fullName = moduleMap.fullName;
+
+                    if (!(fullName in defined)) {
+                        return req.onError(makeError("notloaded", "Module name '" +
+                                    moduleMap.fullName +
+                                    "' has not been loaded yet for context: " +
+                                    contextName));
+                    }
+                    return defined[fullName];
+                }
+
+                main(null, deps, callback, relModuleMap);
+
+                //If the require call does not trigger anything new to load,
+                //then resume the dependency processing.
+                if (!context.requireWait) {
+                    while (!context.scriptCount && context.paused.length) {
+                        //For built layers, there can be some defined
+                        //modules waiting for intake into the context,
+                        //in particular module plugins. Take them.
+                        context.takeGlobalQueue();
+                        resume();
+                    }
+                }
+                return undefined;
+            },
+
+            /**
+             * Internal method to transfer globalQueue items to this context's
+             * defQueue.
+             */
+            takeGlobalQueue: function () {
+                //Push all the globalDefQueue items into the context's defQueue
+                if (globalDefQueue.length) {
+                    //Array splice in the values since the context code has a
+                    //local var ref to defQueue, so cannot just reassign the one
+                    //on context.
+                    apsp.apply(context.defQueue,
+                               [context.defQueue.length - 1, 0].concat(globalDefQueue));
+                    globalDefQueue = [];
+                }
+            },
+
+            /**
+             * Internal method used by environment adapters to complete a load event.
+             * A load event could be a script load or just a load pass from a synchronous
+             * load call.
+             * @param {String} moduleName the name of the module to potentially complete.
+             */
+            completeLoad: function (moduleName) {
+                var args;
+
+                context.takeGlobalQueue();
+
+                while (defQueue.length) {
+                    args = defQueue.shift();
+
+                    if (args[0] === null) {
+                        args[0] = moduleName;
+                        break;
+                    } else if (args[0] === moduleName) {
+                        //Found matching define call for this script!
+                        break;
+                    } else {
+                        //Some other named define call, most likely the result
+                        //of a build layer that included many define calls.
+                        callDefMain(args);
+                        args = null;
+                    }
+                }
+                if (args) {
+                    callDefMain(args);
+                } else {
+                    //A script that does not call define(), so just simulate
+                    //the call for it. Special exception for jQuery dynamic load.
+                    callDefMain([moduleName, [],
+                                moduleName === "jquery" && typeof jQuery !== "undefined" ?
+                                function () {
+                                    return jQuery;
+                                } : null]);
+                }
+
+                //Mark the script as loaded. Note that this can be different from a
+                //moduleName that maps to a define call. This line is important
+                //for traditional browser scripts.
+                loaded[moduleName] = true;
+
+                //If a global jQuery is defined, check for it. Need to do it here
+                //instead of main() since stock jQuery does not register as
+                //a module via define.
+                jQueryCheck();
+
+                //Doing this scriptCount decrement branching because sync envs
+                //need to decrement after resume, otherwise it looks like
+                //loading is complete after the first dependency is fetched.
+                //For browsers, it works fine to decrement after, but it means
+                //the checkLoaded setTimeout 50 ms cost is taken. To avoid
+                //that cost, decrement beforehand.
+                if (req.isAsync) {
+                    context.scriptCount -= 1;
+                }
+                resume();
+                if (!req.isAsync) {
+                    context.scriptCount -= 1;
+                }
+            },
+
+            /**
+             * Converts a module name + .extension into an URL path.
+             * *Requires* the use of a module name. It does not support using
+             * plain URLs like nameToUrl.
+             */
+            toUrl: function (moduleNamePlusExt, relModuleMap) {
+                var index = moduleNamePlusExt.lastIndexOf("."),
+                    ext = null;
+
+                if (index !== -1) {
+                    ext = moduleNamePlusExt.substring(index, moduleNamePlusExt.length);
+                    moduleNamePlusExt = moduleNamePlusExt.substring(0, index);
+                }
+
+                return context.nameToUrl(moduleNamePlusExt, ext, relModuleMap);
+            },
+
+            /**
+             * Converts a module name to a file path. Supports cases where
+             * moduleName may actually be just an URL.
+             */
+            nameToUrl: function (moduleName, ext, relModuleMap) {
+                var paths, pkgs, pkg, pkgPath, syms, i, parentModule, url,
+                    config = context.config;
+
+                //Normalize module name if have a base relative module name to work from.
+                moduleName = normalize(moduleName, relModuleMap && relModuleMap.fullName);
+
+                //If a colon is in the URL, it indicates a protocol is used and it is just
+                //an URL to a file, or if it starts with a slash or ends with .js, it is just a plain file.
+                //The slash is important for protocol-less URLs as well as full paths.
+                if (req.jsExtRegExp.test(moduleName)) {
+                    //Just a plain path, not module name lookup, so just return it.
+                    //Add extension if it is included. This is a bit wonky, only non-.js things pass
+                    //an extension, this method probably needs to be reworked.
+                    url = moduleName + (ext ? ext : "");
+                } else {
+                    //A module that needs to be converted to a path.
+                    paths = config.paths;
+                    pkgs = config.pkgs;
+
+                    syms = moduleName.split("/");
+                    //For each module name segment, see if there is a path
+                    //registered for it. Start with most specific name
+                    //and work up from it.
+                    for (i = syms.length; i > 0; i--) {
+                        parentModule = syms.slice(0, i).join("/");
+                        if (paths[parentModule]) {
+                            syms.splice(0, i, paths[parentModule]);
+                            break;
+                        } else if ((pkg = pkgs[parentModule])) {
+                            //If module name is just the package name, then looking
+                            //for the main module.
+                            if (moduleName === pkg.name) {
+                                pkgPath = pkg.location + '/' + pkg.main;
+                            } else {
+                                pkgPath = pkg.location;
+                            }
+                            syms.splice(0, i, pkgPath);
+                            break;
+                        }
+                    }
+
+                    //Join the path parts together, then figure out if baseUrl is needed.
+                    url = syms.join("/") + (ext || ".js");
+                    url = (url.charAt(0) === '/' || url.match(/^\w+:/) ? "" : config.baseUrl) + url;
+                }
+
+                return config.urlArgs ? url +
+                                        ((url.indexOf('?') === -1 ? '?' : '&') +
+                                         config.urlArgs) : url;
+            }
+        };
+
+        //Make these visible on the context so can be called at the very
+        //end of the file to bootstrap
+        context.jQueryCheck = jQueryCheck;
+        context.resume = resume;
+
+        return context;
+    }
+
+    /**
+     * Main entry point.
+     *
+     * If the only argument to require is a string, then the module that
+     * is represented by that string is fetched for the appropriate context.
+     *
+     * If the first argument is an array, then it will be treated as an array
+     * of dependency string names to fetch. An optional function callback can
+     * be specified to execute when all of those dependencies are available.
+     *
+     * Make a local req variable to help Caja compliance (it assumes things
+     * on a require that are not standardized), and to give a short
+     * name for minification/local scope use.
+     */
+    req = requirejs = function (deps, callback) {
+
+        //Find the right context, use default
+        var contextName = defContextName,
+            context, config;
+
+        // Determine if have config object in the call.
+        if (!isArray(deps) && typeof deps !== "string") {
+            // deps is a config object
+            config = deps;
+            if (isArray(callback)) {
+                // Adjust args if there are dependencies
+                deps = callback;
+                callback = arguments[2];
+            } else {
+                deps = [];
+            }
+        }
+
+        if (config && config.context) {
+            contextName = config.context;
+        }
+
+        context = contexts[contextName] ||
+                  (contexts[contextName] = newContext(contextName));
+
+        if (config) {
+            context.configure(config);
+        }
+
+        return context.require(deps, callback);
+    };
+
+    /**
+     * Export require as a global, but only if it does not already exist.
+     */
+    if (typeof require === "undefined") {
+        require = req;
+    }
+
+    /**
+     * Global require.toUrl(), to match global require, mostly useful
+     * for debugging/work in the global space.
+     */
+    req.toUrl = function (moduleNamePlusExt) {
+        return contexts[defContextName].toUrl(moduleNamePlusExt);
+    };
+
+    req.version = version;
+    req.isArray = isArray;
+    req.isFunction = isFunction;
+    req.mixin = mixin;
+    //Used to filter out dependencies that are already paths.
+    req.jsExtRegExp = /^\/|:|\?|\.js$/;
+    s = req.s = {
+        contexts: contexts,
+        //Stores a list of URLs that should not get async script tag treatment.
+        skipAsync: {},
+        isPageLoaded: !isBrowser,
+        readyCalls: []
+    };
+
+    req.isAsync = req.isBrowser = isBrowser;
+    if (isBrowser) {
+        head = s.head = document.getElementsByTagName("head")[0];
+        //If BASE tag is in play, using appendChild is a problem for IE6.
+        //When that browser dies, this can be removed. Details in this jQuery bug:
+        //http://dev.jquery.com/ticket/2709
+        baseElement = document.getElementsByTagName("base")[0];
+        if (baseElement) {
+            head = s.head = baseElement.parentNode;
+        }
+    }
+
+    /**
+     * Any errors that require explicitly generates will be passed to this
+     * function. Intercept/override it if you want custom error handling.
+     * @param {Error} err the error object.
+     */
+    req.onError = function (err) {
+        throw err;
+    };
+
+    /**
+     * Does the request to load a module for the browser case.
+     * Make this a separate function to allow other environments
+     * to override it.
+     *
+     * @param {Object} context the require context to find state.
+     * @param {String} moduleName the name of the module.
+     * @param {Object} url the URL to the module.
+     */
+    req.load = function (context, moduleName, url) {
+        var loaded = context.loaded;
+
+        isDone = false;
+
+        //Only set loaded to false for tracking if it has not already been set.
+        if (!loaded[moduleName]) {
+            loaded[moduleName] = false;
+        }
+
+        context.scriptCount += 1;
+        req.attach(url, context, moduleName);
+
+        //If tracking a jQuery, then make sure its ready callbacks
+        //are put on hold to prevent its ready callbacks from
+        //triggering too soon.
+        if (context.jQuery && !context.jQueryIncremented) {
+            jQueryHoldReady(context.jQuery, true);
+            context.jQueryIncremented = true;
+        }
+    };
+
+    function getInteractiveScript() {
+        var scripts, i, script;
+        if (interactiveScript && interactiveScript.readyState === 'interactive') {
+            return interactiveScript;
+        }
+
+        scripts = document.getElementsByTagName('script');
+        for (i = scripts.length - 1; i > -1 && (script = scripts[i]); i--) {
+            if (script.readyState === 'interactive') {
+                return (interactiveScript = script);
+            }
+        }
+
+        return null;
+    }
+
+    /**
+     * The function that handles definitions of modules. Differs from
+     * require() in that a string for the module should be the first argument,
+     * and the function to execute after dependencies are loaded should
+     * return a value to define the module corresponding to the first argument's
+     * name.
+     */
+    define = req.def = function (name, deps, callback) {
+        var node, context;
+
+        //Allow for anonymous functions
+        if (typeof name !== 'string') {
+            //Adjust args appropriately
+            callback = deps;
+            deps = name;
+            name = null;
+        }
+
+        //This module may not have dependencies
+        if (!req.isArray(deps)) {
+            callback = deps;
+            deps = [];
+        }
+
+        //If no name, and callback is a function, then figure out if it a
+        //CommonJS thing with dependencies.
+        if (!name && !deps.length && req.isFunction(callback)) {
+            //Remove comments from the callback string,
+            //look for require calls, and pull them into the dependencies,
+            //but only if there are function args.
+            if (callback.length) {
+                callback
+                    .toString()
+                    .replace(commentRegExp, "")
+                    .replace(cjsRequireRegExp, function (match, dep) {
+                        deps.push(dep);
+                    });
+
+                //May be a CommonJS thing even without require calls, but still
+                //could use exports, and module. Avoid doing exports and module
+                //work though if it just needs require.
+                //REQUIRES the function to expect the CommonJS variables in the
+                //order listed below.
+                deps = (callback.length === 1 ? ["require"] : ["require", "exports", "module"]).concat(deps);
+            }
+        }
+
+        //If in IE 6-8 and hit an anonymous define() call, do the interactive
+        //work.
+        if (useInteractive) {
+            node = currentlyAddingScript || getInteractiveScript();
+            if (!node) {
+                return req.onError(makeError("interactive", "No matching script interactive for " + callback));
+            }
+            if (!name) {
+                name = node.getAttribute("data-requiremodule");
+            }
+            context = contexts[node.getAttribute("data-requirecontext")];
+        }
+
+        //Always save off evaluating the def call until the script onload handler.
+        //This allows multiple modules to be in a file without prematurely
+        //tracing dependencies, and allows for anonymous module support,
+        //where the module name is not known until the script onload event
+        //occurs. If no context, use the global queue, and get it processed
+        //in the onscript load callback.
+        (context ? context.defQueue : globalDefQueue).push([name, deps, callback]);
+
+        return undefined;
+    };
+
+    define.amd = {
+        multiversion: true,
+        plugins: true,
+        jQuery: true
+    };
+
+    /**
+     * Executes the text. Normally just uses eval, but can be modified
+     * to use a more environment specific call.
+     * @param {String} text the text to execute/evaluate.
+     */
+    req.exec = function (text) {
+        return eval(text);
+    };
+
+    /**
+     * Executes a module callack function. Broken out as a separate function
+     * solely to allow the build system to sequence the files in the built
+     * layer in the right sequence.
+     *
+     * @private
+     */
+    req.execCb = function (name, callback, args, exports) {
+        return callback.apply(exports, args);
+    };
+
+    /**
+     * callback for script loads, used to check status of loading.
+     *
+     * @param {Event} evt the event from the browser for the script
+     * that was loaded.
+     *
+     * @private
+     */
+    req.onScriptLoad = function (evt) {
+        //Using currentTarget instead of target for Firefox 2.0's sake. Not
+        //all old browsers will be supported, but this one was easy enough
+        //to support and still makes sense.
+        var node = evt.currentTarget || evt.srcElement, contextName, moduleName,
+            context;
+
+        if (evt.type === "load" || readyRegExp.test(node.readyState)) {
+            //Reset interactive script so a script node is not held onto for
+            //to long.
+            interactiveScript = null;
+
+            //Pull out the name of the module and the context.
+            contextName = node.getAttribute("data-requirecontext");
+            moduleName = node.getAttribute("data-requiremodule");
+            context = contexts[contextName];
+
+            contexts[contextName].completeLoad(moduleName);
+
+            //Clean up script binding. Favor detachEvent because of IE9
+            //issue, see attachEvent/addEventListener comment elsewhere
+            //in this file.
+            if (node.detachEvent && !isOpera) {
+                //Probably IE. If not it will throw an error, which will be
+                //useful to know.
+                node.detachEvent("onreadystatechange", req.onScriptLoad);
+            } else {
+                node.removeEventListener("load", req.onScriptLoad, false);
+            }
+        }
+    };
+
+    /**
+     * Attaches the script represented by the URL to the current
+     * environment. Right now only supports browser loading,
+     * but can be redefined in other environments to do the right thing.
+     * @param {String} url the url of the script to attach.
+     * @param {Object} context the context that wants the script.
+     * @param {moduleName} the name of the module that is associated with the script.
+     * @param {Function} [callback] optional callback, defaults to require.onScriptLoad
+     * @param {String} [type] optional type, defaults to text/javascript
+     */
+    req.attach = function (url, context, moduleName, callback, type) {
+        var node, loaded;
+        if (isBrowser) {
+            //In the browser so use a script tag
+            callback = callback || req.onScriptLoad;
+            node = context && context.config && context.config.xhtml ?
+                    document.createElementNS("http://www.w3.org/1999/xhtml", "html:script") :
+                    document.createElement("script");
+            node.type = type || "text/javascript";
+            node.charset = "utf-8";
+            //Use async so Gecko does not block on executing the script if something
+            //like a long-polling comet tag is being run first. Gecko likes
+            //to evaluate scripts in DOM order, even for dynamic scripts.
+            //It will fetch them async, but only evaluate the contents in DOM
+            //order, so a long-polling script tag can delay execution of scripts
+            //after it. But telling Gecko we expect async gets us the behavior
+            //we want -- execute it whenever it is finished downloading. Only
+            //Helps Firefox 3.6+
+            //Allow some URLs to not be fetched async. Mostly helps the order!
+            //plugin
+            node.async = !s.skipAsync[url];
+
+            if (context) {
+                node.setAttribute("data-requirecontext", context.contextName);
+            }
+            node.setAttribute("data-requiremodule", moduleName);
+
+            //Set up load listener. Test attachEvent first because IE9 has
+            //a subtle issue in its addEventListener and script onload firings
+            //that do not match the behavior of all other browsers with
+            //addEventListener support, which fire the onload event for a
+            //script right after the script execution. See:
+            //https://connect.microsoft.com/IE/feedback/details/648057/script-onload-event-is-not-fired-immediately-after-script-execution
+            //UNFORTUNATELY Opera implements attachEvent but does not follow the script
+            //script execution mode.
+            if (node.attachEvent && !isOpera) {
+                //Probably IE. IE (at least 6-8) do not fire
+                //script onload right after executing the script, so
+                //we cannot tie the anonymous define call to a name.
+                //However, IE reports the script as being in "interactive"
+                //readyState at the time of the define call.
+                useInteractive = true;
+                node.attachEvent("onreadystatechange", callback);
+            } else {
+                node.addEventListener("load", callback, false);
+            }
+            node.src = url;
+
+            //For some cache cases in IE 6-8, the script executes before the end
+            //of the appendChild execution, so to tie an anonymous define
+            //call to the module name (which is stored on the node), hold on
+            //to a reference to this node, but clear after the DOM insertion.
+            currentlyAddingScript = node;
+            if (baseElement) {
+                head.insertBefore(node, baseElement);
+            } else {
+                head.appendChild(node);
+            }
+            currentlyAddingScript = null;
+            return node;
+        } else if (isWebWorker) {
+            //In a web worker, use importScripts. This is not a very
+            //efficient use of importScripts, importScripts will block until
+            //its script is downloaded and evaluated. However, if web workers
+            //are in play, the expectation that a build has been done so that
+            //only one script needs to be loaded anyway. This may need to be
+            //reevaluated if other use cases become common.
+            loaded = context.loaded;
+            loaded[moduleName] = false;
+
+            importScripts(url);
+
+            //Account for anonymous modules
+            context.completeLoad(moduleName);
+        }
+        return null;
+    };
+
+    //Look for a data-main script attribute, which could also adjust the baseUrl.
+    if (isBrowser) {
+        //Figure out baseUrl. Get it from the script tag with require.js in it.
+        scripts = document.getElementsByTagName("script");
+
+        for (i = scripts.length - 1; i > -1 && (script = scripts[i]); i--) {
+            //Set the "head" where we can append children by
+            //using the script's parent.
+            if (!head) {
+                head = script.parentNode;
+            }
+
+            //Look for a data-main attribute to set main script for the page
+            //to load. If it is there, the path to data main becomes the
+            //baseUrl, if it is not already set.
+            if ((dataMain = script.getAttribute('data-main'))) {
+                if (!cfg.baseUrl) {
+                    //Pull off the directory of data-main for use as the
+                    //baseUrl.
+                    src = dataMain.split('/');
+                    mainScript = src.pop();
+                    subPath = src.length ? src.join('/')  + '/' : './';
+
+                    //Set final config.
+                    cfg.baseUrl = subPath;
+                    //Strip off any trailing .js since dataMain is now
+                    //like a module name.
+                    dataMain = mainScript.replace(jsSuffixRegExp, '');
+                }
+
+                //Put the data-main script in the files to load.
+                cfg.deps = cfg.deps ? cfg.deps.concat(dataMain) : [dataMain];
+
+                break;
+            }
+        }
+    }
+
+    //Set baseUrl based on config.
+    s.baseUrl = cfg.baseUrl;
+
+    //****** START page load functionality ****************
+    /**
+     * Sets the page as loaded and triggers check for all modules loaded.
+     */
+    req.pageLoaded = function () {
+        if (!s.isPageLoaded) {
+            s.isPageLoaded = true;
+            if (scrollIntervalId) {
+                clearInterval(scrollIntervalId);
+            }
+
+            //Part of a fix for FF < 3.6 where readyState was not set to
+            //complete so libraries like jQuery that check for readyState
+            //after page load where not getting initialized correctly.
+            //Original approach suggested by Andrea Giammarchi:
+            //http://webreflection.blogspot.com/2009/11/195-chars-to-help-lazy-loading.html
+            //see other setReadyState reference for the rest of the fix.
+            if (setReadyState) {
+                document.readyState = "complete";
+            }
+
+            req.callReady();
+        }
+    };
+
+    //See if there is nothing waiting across contexts, and if not, trigger
+    //callReady.
+    req.checkReadyState = function () {
+        var contexts = s.contexts, prop;
+        for (prop in contexts) {
+            if (!(prop in empty)) {
+                if (contexts[prop].waitCount) {
+                    return;
+                }
+            }
+        }
+        s.isDone = true;
+        req.callReady();
+    };
+
+    /**
+     * Internal function that calls back any ready functions. If you are
+     * integrating RequireJS with another library without require.ready support,
+     * you can define this method to call your page ready code instead.
+     */
+    req.callReady = function () {
+        var callbacks = s.readyCalls, i, callback, contexts, context, prop;
+
+        if (s.isPageLoaded && s.isDone) {
+            if (callbacks.length) {
+                s.readyCalls = [];
+                for (i = 0; (callback = callbacks[i]); i++) {
+                    callback();
+                }
+            }
+
+            //If jQuery with DOM ready delayed, release it now.
+            contexts = s.contexts;
+            for (prop in contexts) {
+                if (!(prop in empty)) {
+                    context = contexts[prop];
+                    if (context.jQueryIncremented) {
+                        jQueryHoldReady(context.jQuery, false);
+                        context.jQueryIncremented = false;
+                    }
+                }
+            }
+        }
+    };
+
+    /**
+     * Registers functions to call when the page is loaded
+     */
+    req.ready = function (callback) {
+        if (s.isPageLoaded && s.isDone) {
+            callback();
+        } else {
+            s.readyCalls.push(callback);
+        }
+        return req;
+    };
+
+    if (isBrowser) {
+        if (document.addEventListener) {
+            //Standards. Hooray! Assumption here that if standards based,
+            //it knows about DOMContentLoaded.
+            document.addEventListener("DOMContentLoaded", req.pageLoaded, false);
+            window.addEventListener("load", req.pageLoaded, false);
+            //Part of FF < 3.6 readystate fix (see setReadyState refs for more info)
+            if (!document.readyState) {
+                setReadyState = true;
+                document.readyState = "loading";
+            }
+        } else if (window.attachEvent) {
+            window.attachEvent("onload", req.pageLoaded);
+
+            //DOMContentLoaded approximation, as found by Diego Perini:
+            //http://javascript.nwbox.com/IEContentLoaded/
+            if (self === self.top) {
+                scrollIntervalId = setInterval(function () {
+                    try {
+                        //From this ticket:
+                        //http://bugs.dojotoolkit.org/ticket/11106,
+                        //In IE HTML Application (HTA), such as in a selenium test,
+                        //javascript in the iframe can't see anything outside
+                        //of it, so self===self.top is true, but the iframe is
+                        //not the top window and doScroll will be available
+                        //before document.body is set. Test document.body
+                        //before trying the doScroll trick.
+                        if (document.body) {
+                            document.documentElement.doScroll("left");
+                            req.pageLoaded();
+                        }
+                    } catch (e) {}
+                }, 30);
+            }
+        }
+
+        //Check if document already complete, and if so, just trigger page load
+        //listeners. NOTE: does not work with Firefox before 3.6. To support
+        //those browsers, manually call require.pageLoaded().
+        if (document.readyState === "complete") {
+            req.pageLoaded();
+        }
+    }
+    //****** END page load functionality ****************
+
+    //Set up default context. If require was a configuration object, use that as base config.
+    req(cfg);
+
+    //If modules are built into require.js, then need to make sure dependencies are
+    //traced. Use a setTimeout in the browser world, to allow all the modules to register
+    //themselves. In a non-browser env, assume that modules are not built into require.js,
+    //which seems odd to do on the server.
+    if (req.isAsync && typeof setTimeout !== "undefined") {
+        ctx = s.contexts[(cfg.context || defContextName)];
+        //Indicate that the script that includes require() is still loading,
+        //so that require()'d dependencies are not traced until the end of the
+        //file is parsed (approximated via the setTimeout call).
+        ctx.requireWait = true;
+        setTimeout(function () {
+            ctx.requireWait = false;
+
+            //Any modules included with the require.js file will be in the
+            //global queue, assign them to this context.
+            ctx.takeGlobalQueue();
+
+            //Allow for jQuery to be loaded/already in the page, and if jQuery 1.4.3,
+            //make sure to hold onto it for readyWait triggering.
+            ctx.jQueryCheck();
+
+            if (!ctx.scriptCount) {
+                ctx.resume();
+            }
+            req.checkReadyState();
+        }, 0);
+    }
+}());
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/src/ace-uncompressed.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/ace-uncompressed.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,14366 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+/**
+ * Define a module along with a payload
+ * @param module a name for the payload
+ * @param payload a function to call with (require, exports, module) params
+ */
+ 
+(function() {
+    
+var global = (function() {
+    return this;
+})();
+
+if (typeof requirejs !== "undefined")
+    return;
+
+var _define = function(module, deps, payload) {
+    if (typeof module !== 'string') {
+        if (_define.original)
+            _define.original.apply(window, arguments);
+        else {
+            console.error('dropping module because define wasn\'t a string.');
+            console.trace();
+        }
+        return;
+    }
+
+    if (arguments.length == 2)
+        payload = deps;
+
+    if (!_define.modules)
+        _define.modules = {};
+        
+    _define.modules[module] = payload;
+};
+if (global.define)
+    _define.original = global.define;
+    
+global.define = _define;
+
+
+/**
+ * Get at functionality define()ed using the function above
+ */
+var _require = function(parentId, module, callback) {
+    if (Object.prototype.toString.call(module) === "[object Array]") {
+        var params = [];
+        for (var i = 0, l = module.length; i < l; ++i) {
+            var dep = lookup(parentId, module[i]);
+            if (!dep && _require.original)
+                return _require.original.apply(window, arguments);
+            params.push(dep);
+        }
+        if (callback) {
+            callback.apply(null, params);
+        }
+    }
+    else if (typeof module === 'string') {
+        var payload = lookup(parentId, module);
+        if (!payload && _require.original)
+            return _require.original.apply(window, arguments);
+        
+        if (callback) {
+            callback();
+        }
+    
+        return payload;
+    }
+    else {
+        if (_require.original)
+            return _require.original.apply(window, arguments);
+    }
+};
+
+if (global.require)
+    _require.original = global.require;
+    
+global.require = function(module, callback) {
+    return _require("", module, callback);
+};
+
+global.require.packaged = true;
+
+var normalizeModule = function(parentId, moduleName) {
+    // normalize plugin requires
+    if (moduleName.indexOf("!") !== -1) {
+        var chunks = moduleName.split("!");
+        return normalizeModule(parentId, chunks[0]) + "!" + normalizeModule(parentId, chunks[1]);
+    }
+    // normalize relative requires
+    if (moduleName.charAt(0) == ".") {
+        var base = parentId.split("/").slice(0, -1).join("/");
+        moduleName = base + "/" + moduleName;
+        
+        while(moduleName.indexOf(".") !== -1 && previous != moduleName) {
+            var previous = moduleName;
+            moduleName = moduleName.replace(/\/\.\//, "/").replace(/[^\/]+\/\.\.\//, "");
+        }
+    }
+    
+    return moduleName;
+};
+
+
+/**
+ * Internal function to lookup moduleNames and resolve them by calling the
+ * definition function if needed.
+ */
+var lookup = function(parentId, moduleName) {
+
+    moduleName = normalizeModule(parentId, moduleName);
+
+    var module = _define.modules[moduleName];
+    if (!module) {
+        return null;
+    }
+
+    if (typeof module === 'function') {
+        var exports = {};
+        var mod = {
+            id: moduleName, 
+            uri: '',
+            exports: exports
+        };
+        
+        var req = function(module, callback) {
+            return _require(moduleName, module, callback);
+        };
+        
+        var returnValue = module(req, exports, mod);
+        exports = returnValue || mod.exports;
+            
+        // cache the resulting module object for next time
+        _define.modules[moduleName] = exports;
+        return exports;
+    }
+
+    return module;
+};
+
+})();// vim:set ts=4 sts=4 sw=4 st:
+// -- kriskowal Kris Kowal Copyright (C) 2009-2010 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright(C) 2010 XXX No License Specified
+// -- fschaefer Florian Sch??fer Copyright (C) 2010 MIT License
+// -- Irakli Gozalishvili Copyright (C) 2010 MIT License
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/fixoldbrowsers', ['require', 'exports', 'module' , 'ace/lib/regexp', 'ace/lib/es5-shim'], function(require, exports, module) {
+
+require("./regexp");
+require("./es5-shim");
+
+});define('ace/lib/regexp', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+// Based on code from:
+//
+// XRegExp 1.5.0
+// (c) 2007-2010 Steven Levithan
+// MIT License
+// <http://xregexp.com>
+// Provides an augmented, extensible, cross-browser implementation of regular expressions,
+// including support for additional syntax, flags, and methods
+
+    //---------------------------------
+    //  Private variables
+    //---------------------------------
+
+    var real = {
+            exec: RegExp.prototype.exec,
+            test: RegExp.prototype.test,
+            match: String.prototype.match,
+            replace: String.prototype.replace,
+            split: String.prototype.split
+        },
+        compliantExecNpcg = real.exec.call(/()??/, "")[1] === undefined, // check `exec` handling of nonparticipating capturing groups
+        compliantLastIndexIncrement = function () {
+            var x = /^/g;
+            real.test.call(x, "");
+            return !x.lastIndex;
+        }();
+
+    //---------------------------------
+    //  Overriden native methods
+    //---------------------------------
+
+    // Adds named capture support (with backreferences returned as `result.name`), and fixes two
+    // cross-browser issues per ES3:
+    // - Captured values for nonparticipating capturing groups should be returned as `undefined`,
+    //   rather than the empty string.
+    // - `lastIndex` should not be incremented after zero-length matches.
+    RegExp.prototype.exec = function (str) {
+        var match = real.exec.apply(this, arguments),
+            name, r2;
+        if (match) {
+            // Fix browsers whose `exec` methods don't consistently return `undefined` for
+            // nonparticipating capturing groups
+            if (!compliantExecNpcg && match.length > 1 && indexOf(match, "") > -1) {
+                r2 = RegExp(this.source, real.replace.call(getNativeFlags(this), "g", ""));
+                // Using `str.slice(match.index)` rather than `match[0]` in case lookahead allowed
+                // matching due to characters outside the match
+                real.replace.call(str.slice(match.index), r2, function () {
+                    for (var i = 1; i < arguments.length - 2; i++) {
+                        if (arguments[i] === undefined)
+                            match[i] = undefined;
+                    }
+                });
+            }
+            // Attach named capture properties
+            if (this._xregexp && this._xregexp.captureNames) {
+                for (var i = 1; i < match.length; i++) {
+                    name = this._xregexp.captureNames[i - 1];
+                    if (name)
+                       match[name] = match[i];
+                }
+            }
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (!compliantLastIndexIncrement && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+        }
+        return match;
+    };
+
+    // Don't override `test` if it won't change anything
+    if (!compliantLastIndexIncrement) {
+        // Fix browser bug in native method
+        RegExp.prototype.test = function (str) {
+            // Use the native `exec` to skip some processing overhead, even though the overriden
+            // `exec` would take care of the `lastIndex` fix
+            var match = real.exec.call(this, str);
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (match && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+            return !!match;
+        };
+    }
+
+    //---------------------------------
+    //  Private helper functions
+    //---------------------------------
+
+    function getNativeFlags (regex) {
+        return (regex.global     ? "g" : "") +
+               (regex.ignoreCase ? "i" : "") +
+               (regex.multiline  ? "m" : "") +
+               (regex.extended   ? "x" : "") + // Proposed for ES4; included in AS3
+               (regex.sticky     ? "y" : "");
+    };
+
+    function indexOf (array, item, from) {
+        if (Array.prototype.indexOf) // Use the native array method if available
+            return array.indexOf(item, from);
+        for (var i = from || 0; i < array.length; i++) {
+            if (array[i] === item)
+                return i;
+        }
+        return -1;
+    };
+
+});// vim: ts=4 sts=4 sw=4 expandtab
+// -- kriskowal Kris Kowal Copyright (C) 2009-2011 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright (C) 2010 XXX TODO License or CLA
+// -- fschaefer Florian Sch??fer Copyright (C) 2010 MIT License
+// -- Gozala Irakli Gozalishvili Copyright (C) 2010 MIT License
+// -- kitcambridge Kit Cambridge Copyright (C) 2011 MIT License
+// -- kossnocorp Sasha Koss XXX TODO License or CLA
+// -- bryanforbes Bryan Forbes XXX TODO License or CLA
+// -- killdream Quildreen Motta Copyright (C) 2011 MIT Licence
+// -- michaelficarra Michael Ficarra Copyright (C) 2011 3-clause BSD License
+// -- sharkbrainguy Gerard Paapu Copyright (C) 2011 MIT License
+// -- bbqsrc Brendan Molloy (C) 2011 Creative Commons Zero (public domain)
+// -- iwyg XXX TODO License or CLA
+// -- DomenicDenicola Domenic Denicola Copyright (C) 2011 MIT License
+// -- xavierm02 Montillet Xavier XXX TODO License or CLA
+// -- Raynos Raynos XXX TODO License or CLA
+// -- samsonjs Sami Samhuri Copyright (C) 2010 MIT License
+// -- rwldrn Rick Waldron Copyright (C) 2011 MIT License
+// -- lexer Alexey Zakharov XXX TODO License or CLA
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/es5-shim', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+/**
+ * Brings an environment as close to ECMAScript 5 compliance
+ * as is possible with the facilities of erstwhile engines.
+ *
+ * Annotated ES5: http://es5.github.com/ (specific links below)
+ * ES5 Spec: http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf
+ *
+ * @module
+ */
+
+/*whatsupdoc*/
+
+//
+// Function
+// ========
+//
+
+// ES-5 15.3.4.5
+// http://es5.github.com/#x15.3.4.5
+
+if (!Function.prototype.bind) {
+    Function.prototype.bind = function bind(that) { // .length is 1
+        // 1. Let Target be the this value.
+        var target = this;
+        // 2. If IsCallable(Target) is false, throw a TypeError exception.
+        if (typeof target != "function")
+            throw new TypeError(); // TODO message
+        // 3. Let A be a new (possibly empty) internal list of all of the
+        //   argument values provided after thisArg (arg1, arg2 etc), in order.
+        // XXX slicedArgs will stand in for "A" if used
+        var args = slice.call(arguments, 1); // for normal call
+        // 4. Let F be a new native ECMAScript object.
+        // 11. Set the [[Prototype]] internal property of F to the standard
+        //   built-in Function prototype object as specified in 15.3.3.1.
+        // 12. Set the [[Call]] internal property of F as described in
+        //   15.3.4.5.1.
+        // 13. Set the [[Construct]] internal property of F as described in
+        //   15.3.4.5.2.
+        // 14. Set the [[HasInstance]] internal property of F as described in
+        //   15.3.4.5.3.
+        var bound = function () {
+
+            if (this instanceof bound) {
+                // 15.3.4.5.2 [[Construct]]
+                // When the [[Construct]] internal method of a function object,
+                // F that was created using the bind function is called with a
+                // list of arguments ExtraArgs, the following steps are taken:
+                // 1. Let target be the value of F's [[TargetFunction]]
+                //   internal property.
+                // 2. If target has no [[Construct]] internal method, a
+                //   TypeError exception is thrown.
+                // 3. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the
+                //   list boundArgs in the same order followed by the same
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Construct]] internal 
+                //   method of target providing args as the arguments.
+
+                var F = function(){};
+                F.prototype = target.prototype;
+                var self = new F;
+
+                var result = target.apply(
+                    self,
+                    args.concat(slice.call(arguments))
+                );
+                if (result !== null && Object(result) === result)
+                    return result;
+                return self;
+
+            } else {
+                // 15.3.4.5.1 [[Call]]
+                // When the [[Call]] internal method of a function object, F,
+                // which was created using the bind function is called with a
+                // this value and a list of arguments ExtraArgs, the following
+                // steps are taken:
+                // 1. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 2. Let boundThis be the value of F's [[BoundThis]] internal
+                //   property.
+                // 3. Let target be the value of F's [[TargetFunction]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the 
+                //   list boundArgs in the same order followed by the same 
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Call]] internal method 
+                //   of target providing boundThis as the this value and 
+                //   providing args as the arguments.
+
+                // equiv: target.call(this, ...boundArgs, ...args)
+                return target.apply(
+                    that,
+                    args.concat(slice.call(arguments))
+                );
+
+            }
+
+        };
+        // XXX bound.length is never writable, so don't even try
+        //
+        // 15. If the [[Class]] internal property of Target is "Function", then
+        //     a. Let L be the length property of Target minus the length of A.
+        //     b. Set the length own property of F to either 0 or L, whichever is 
+        //       larger.
+        // 16. Else set the length own property of F to 0.
+        // 17. Set the attributes of the length own property of F to the values
+        //   specified in 15.3.5.1.
+
+        // TODO
+        // 18. Set the [[Extensible]] internal property of F to true.
+        
+        // TODO
+        // 19. Let thrower be the [[ThrowTypeError]] function Object (13.2.3).
+        // 20. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "caller", PropertyDescriptor {[[Get]]: thrower, [[Set]]:
+        //   thrower, [[Enumerable]]: false, [[Configurable]]: false}, and 
+        //   false.
+        // 21. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "arguments", PropertyDescriptor {[[Get]]: thrower, 
+        //   [[Set]]: thrower, [[Enumerable]]: false, [[Configurable]]: false},
+        //   and false.
+
+        // TODO
+        // NOTE Function objects created using Function.prototype.bind do not 
+        // have a prototype property or the [[Code]], [[FormalParameters]], and
+        // [[Scope]] internal properties.
+        // XXX can't delete prototype in pure-js.
+
+        // 22. Return F.
+        return bound;
+    };
+}
+
+// Shortcut to an often accessed properties, in order to avoid multiple
+// dereference that costs universally.
+// _Please note: Shortcuts are defined after `Function.prototype.bind` as we
+// us it in defining shortcuts.
+var call = Function.prototype.call;
+var prototypeOfArray = Array.prototype;
+var prototypeOfObject = Object.prototype;
+var slice = prototypeOfArray.slice;
+var toString = call.bind(prototypeOfObject.toString);
+var owns = call.bind(prototypeOfObject.hasOwnProperty);
+
+// If JS engine supports accessors creating shortcuts.
+var defineGetter;
+var defineSetter;
+var lookupGetter;
+var lookupSetter;
+var supportsAccessors;
+if ((supportsAccessors = owns(prototypeOfObject, "__defineGetter__"))) {
+    defineGetter = call.bind(prototypeOfObject.__defineGetter__);
+    defineSetter = call.bind(prototypeOfObject.__defineSetter__);
+    lookupGetter = call.bind(prototypeOfObject.__lookupGetter__);
+    lookupSetter = call.bind(prototypeOfObject.__lookupSetter__);
+}
+
+//
+// Array
+// =====
+//
+
+// ES5 15.4.3.2
+// http://es5.github.com/#x15.4.3.2
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/isArray
+if (!Array.isArray) {
+    Array.isArray = function isArray(obj) {
+        return toString(obj) == "[object Array]";
+    };
+}
+
+// The IsCallable() check in the Array functions
+// has been replaced with a strict check on the
+// internal class of the object to trap cases where
+// the provided function was actually a regular
+// expression literal, which in V8 and
+// JavaScriptCore is a typeof "function".  Only in
+// V8 are regular expression literals permitted as
+// reduce parameters, so it is desirable in the
+// general case for the shim to match the more
+// strict and common behavior of rejecting regular
+// expressions.
+
+// ES5 15.4.4.18
+// http://es5.github.com/#x15.4.4.18
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/forEach
+if (!Array.prototype.forEach) {
+    Array.prototype.forEach = function forEach(fun /*, thisp*/) {
+        var self = toObject(this),
+            thisp = arguments[1],
+            i = 0,
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        while (i < length) {
+            if (i in self) {
+                // Invoke the callback function with call, passing arguments:
+                // context, property value, property key, thisArg object context
+                fun.call(thisp, self[i], i, self);
+            }
+            i++;
+        }
+    };
+}
+
+// ES5 15.4.4.19
+// http://es5.github.com/#x15.4.4.19
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/map
+if (!Array.prototype.map) {
+    Array.prototype.map = function map(fun /*, thisp*/) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = Array(length),
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self)
+                result[i] = fun.call(thisp, self[i], i, self);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.20
+// http://es5.github.com/#x15.4.4.20
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/filter
+if (!Array.prototype.filter) {
+    Array.prototype.filter = function filter(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = [],
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                result.push(self[i]);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.16
+// http://es5.github.com/#x15.4.4.16
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every
+if (!Array.prototype.every) {
+    Array.prototype.every = function every(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && !fun.call(thisp, self[i], i, self))
+                return false;
+        }
+        return true;
+    };
+}
+
+// ES5 15.4.4.17
+// http://es5.github.com/#x15.4.4.17
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/some
+if (!Array.prototype.some) {
+    Array.prototype.some = function some(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                return true;
+        }
+        return false;
+    };
+}
+
+// ES5 15.4.4.21
+// http://es5.github.com/#x15.4.4.21
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduce
+if (!Array.prototype.reduce) {
+    Array.prototype.reduce = function reduce(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value and an empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var i = 0;
+        var result;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i++];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (++i >= length)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        for (; i < length; i++) {
+            if (i in self)
+                result = fun.call(void 0, result, self[i], i, self);
+        }
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.22
+// http://es5.github.com/#x15.4.4.22
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduceRight
+if (!Array.prototype.reduceRight) {
+    Array.prototype.reduceRight = function reduceRight(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value, empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var result, i = length - 1;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i--];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (--i < 0)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        do {
+            if (i in this)
+                result = fun.call(void 0, result, self[i], i, self);
+        } while (i--);
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.14
+// http://es5.github.com/#x15.4.4.14
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/indexOf
+if (!Array.prototype.indexOf) {
+    Array.prototype.indexOf = function indexOf(sought /*, fromIndex */ ) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+
+        var i = 0;
+        if (arguments.length > 1)
+            i = toInteger(arguments[1]);
+
+        // handle negative indices
+        i = i >= 0 ? i : Math.max(0, length + i);
+        for (; i < length; i++) {
+            if (i in self && self[i] === sought) {
+                return i;
+            }
+        }
+        return -1;
+    };
+}
+
+// ES5 15.4.4.15
+// http://es5.github.com/#x15.4.4.15
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/lastIndexOf
+if (!Array.prototype.lastIndexOf) {
+    Array.prototype.lastIndexOf = function lastIndexOf(sought /*, fromIndex */) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+        var i = length - 1;
+        if (arguments.length > 1)
+            i = Math.min(i, toInteger(arguments[1]));
+        // handle negative indices
+        i = i >= 0 ? i : length - Math.abs(i);
+        for (; i >= 0; i--) {
+            if (i in self && sought === self[i])
+                return i;
+        }
+        return -1;
+    };
+}
+
+//
+// Object
+// ======
+//
+
+// ES5 15.2.3.2
+// http://es5.github.com/#x15.2.3.2
+if (!Object.getPrototypeOf) {
+    // https://github.com/kriskowal/es5-shim/issues#issue/2
+    // http://ejohn.org/blog/objectgetprototypeof/
+    // recommended by fschaefer on github
+    Object.getPrototypeOf = function getPrototypeOf(object) {
+        return object.__proto__ || (
+            object.constructor ?
+            object.constructor.prototype :
+            prototypeOfObject
+        );
+    };
+}
+
+// ES5 15.2.3.3
+// http://es5.github.com/#x15.2.3.3
+if (!Object.getOwnPropertyDescriptor) {
+    var ERR_NON_OBJECT = "Object.getOwnPropertyDescriptor called on a " +
+                         "non-object: ";
+    Object.getOwnPropertyDescriptor = function getOwnPropertyDescriptor(object, property) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT + object);
+        // If object does not owns property return undefined immediately.
+        if (!owns(object, property))
+            return;
+
+        var descriptor, getter, setter;
+
+        // If object has a property then it's for sure both `enumerable` and
+        // `configurable`.
+        descriptor =  { enumerable: true, configurable: true };
+
+        // If JS engine supports accessor properties then property may be a
+        // getter or setter.
+        if (supportsAccessors) {
+            // Unfortunately `__lookupGetter__` will return a getter even
+            // if object has own non getter property along with a same named
+            // inherited getter. To avoid misbehavior we temporary remove
+            // `__proto__` so that `__lookupGetter__` will return getter only
+            // if it's owned by an object.
+            var prototype = object.__proto__;
+            object.__proto__ = prototypeOfObject;
+
+            var getter = lookupGetter(object, property);
+            var setter = lookupSetter(object, property);
+
+            // Once we have getter and setter we can put values back.
+            object.__proto__ = prototype;
+
+            if (getter || setter) {
+                if (getter) descriptor.get = getter;
+                if (setter) descriptor.set = setter;
+
+                // If it was accessor property we're done and return here
+                // in order to avoid adding `value` to the descriptor.
+                return descriptor;
+            }
+        }
+
+        // If we got this far we know that object has an own property that is
+        // not an accessor so we set it as a value and return descriptor.
+        descriptor.value = object[property];
+        return descriptor;
+    };
+}
+
+// ES5 15.2.3.4
+// http://es5.github.com/#x15.2.3.4
+if (!Object.getOwnPropertyNames) {
+    Object.getOwnPropertyNames = function getOwnPropertyNames(object) {
+        return Object.keys(object);
+    };
+}
+
+// ES5 15.2.3.5
+// http://es5.github.com/#x15.2.3.5
+if (!Object.create) {
+    Object.create = function create(prototype, properties) {
+        var object;
+        if (prototype === null) {
+            object = { "__proto__": null };
+        } else {
+            if (typeof prototype != "object")
+                throw new TypeError("typeof prototype["+(typeof prototype)+"] != 'object'");
+            var Type = function () {};
+            Type.prototype = prototype;
+            object = new Type();
+            // IE has no built-in implementation of `Object.getPrototypeOf`
+            // neither `__proto__`, but this manually setting `__proto__` will
+            // guarantee that `Object.getPrototypeOf` will work as expected with
+            // objects created using `Object.create`
+            object.__proto__ = prototype;
+        }
+        if (properties !== void 0)
+            Object.defineProperties(object, properties);
+        return object;
+    };
+}
+
+// ES5 15.2.3.6
+// http://es5.github.com/#x15.2.3.6
+
+// Patch for WebKit and IE8 standard mode
+// Designed by hax <hax.github.com>
+// related issue: https://github.com/kriskowal/es5-shim/issues#issue/5
+// IE8 Reference:
+//     http://msdn.microsoft.com/en-us/library/dd282900.aspx
+//     http://msdn.microsoft.com/en-us/library/dd229916.aspx
+// WebKit Bugs:
+//     https://bugs.webkit.org/show_bug.cgi?id=36423
+
+function doesDefinePropertyWork(object) {
+    try {
+        Object.defineProperty(object, "sentinel", {});
+        return "sentinel" in object;
+    } catch (exception) {
+        // returns falsy
+    }
+}
+
+// check whether defineProperty works if it's given. Otherwise,
+// shim partially.
+if (Object.defineProperty) {
+    var definePropertyWorksOnObject = doesDefinePropertyWork({});
+    var definePropertyWorksOnDom = typeof document == "undefined" ||
+        doesDefinePropertyWork(document.createElement("div"));
+    if (!definePropertyWorksOnObject || !definePropertyWorksOnDom) {
+        var definePropertyFallback = Object.defineProperty;
+    }
+}
+
+if (!Object.defineProperty || definePropertyFallback) {
+    var ERR_NON_OBJECT_DESCRIPTOR = "Property description must be an object: ";
+    var ERR_NON_OBJECT_TARGET = "Object.defineProperty called on non-object: "
+    var ERR_ACCESSORS_NOT_SUPPORTED = "getters & setters can not be defined " +
+                                      "on this javascript engine";
+
+    Object.defineProperty = function defineProperty(object, property, descriptor) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT_TARGET + object);
+        if ((typeof descriptor != "object" && typeof descriptor != "function") || descriptor === null)
+            throw new TypeError(ERR_NON_OBJECT_DESCRIPTOR + descriptor);
+
+        // make a valiant attempt to use the real defineProperty
+        // for I8's DOM elements.
+        if (definePropertyFallback) {
+            try {
+                return definePropertyFallback.call(Object, object, property, descriptor);
+            } catch (exception) {
+                // try the shim if the real one doesn't work
+            }
+        }
+
+        // If it's a data property.
+        if (owns(descriptor, "value")) {
+            // fail silently if "writable", "enumerable", or "configurable"
+            // are requested but not supported
+            /*
+            // alternate approach:
+            if ( // can't implement these features; allow false but not true
+                !(owns(descriptor, "writable") ? descriptor.writable : true) ||
+                !(owns(descriptor, "enumerable") ? descriptor.enumerable : true) ||
+                !(owns(descriptor, "configurable") ? descriptor.configurable : true)
+            )
+                throw new RangeError(
+                    "This implementation of Object.defineProperty does not " +
+                    "support configurable, enumerable, or writable."
+                );
+            */
+
+            if (supportsAccessors && (lookupGetter(object, property) ||
+                                      lookupSetter(object, property)))
+            {
+                // As accessors are supported only on engines implementing
+                // `__proto__` we can safely override `__proto__` while defining
+                // a property to make sure that we don't hit an inherited
+                // accessor.
+                var prototype = object.__proto__;
+                object.__proto__ = prototypeOfObject;
+                // Deleting a property anyway since getter / setter may be
+                // defined on object itself.
+                delete object[property];
+                object[property] = descriptor.value;
+                // Setting original `__proto__` back now.
+                object.__proto__ = prototype;
+            } else {
+                object[property] = descriptor.value;
+            }
+        } else {
+            if (!supportsAccessors)
+                throw new TypeError(ERR_ACCESSORS_NOT_SUPPORTED);
+            // If we got that far then getters and setters can be defined !!
+            if (owns(descriptor, "get"))
+                defineGetter(object, property, descriptor.get);
+            if (owns(descriptor, "set"))
+                defineSetter(object, property, descriptor.set);
+        }
+
+        return object;
+    };
+}
+
+// ES5 15.2.3.7
+// http://es5.github.com/#x15.2.3.7
+if (!Object.defineProperties) {
+    Object.defineProperties = function defineProperties(object, properties) {
+        for (var property in properties) {
+            if (owns(properties, property))
+                Object.defineProperty(object, property, properties[property]);
+        }
+        return object;
+    };
+}
+
+// ES5 15.2.3.8
+// http://es5.github.com/#x15.2.3.8
+if (!Object.seal) {
+    Object.seal = function seal(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.9
+// http://es5.github.com/#x15.2.3.9
+if (!Object.freeze) {
+    Object.freeze = function freeze(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// detect a Rhino bug and patch it
+try {
+    Object.freeze(function () {});
+} catch (exception) {
+    Object.freeze = (function freeze(freezeObject) {
+        return function freeze(object) {
+            if (typeof object == "function") {
+                return object;
+            } else {
+                return freezeObject(object);
+            }
+        };
+    })(Object.freeze);
+}
+
+// ES5 15.2.3.10
+// http://es5.github.com/#x15.2.3.10
+if (!Object.preventExtensions) {
+    Object.preventExtensions = function preventExtensions(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.11
+// http://es5.github.com/#x15.2.3.11
+if (!Object.isSealed) {
+    Object.isSealed = function isSealed(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.12
+// http://es5.github.com/#x15.2.3.12
+if (!Object.isFrozen) {
+    Object.isFrozen = function isFrozen(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.13
+// http://es5.github.com/#x15.2.3.13
+if (!Object.isExtensible) {
+    Object.isExtensible = function isExtensible(object) {
+        // 1. If Type(O) is not Object throw a TypeError exception.
+        if (Object(object) === object) {
+            throw new TypeError(); // TODO message
+        }
+        // 2. Return the Boolean value of the [[Extensible]] internal property of O.
+        var name = '';
+        while (owns(object, name)) {
+            name += '?';
+        }
+        object[name] = true;
+        var returnValue = owns(object, name);
+        delete object[name];
+        return returnValue;
+    };
+}
+
+// ES5 15.2.3.14
+// http://es5.github.com/#x15.2.3.14
+if (!Object.keys) {
+    // http://whattheheadsaid.com/2010/10/a-safer-object-keys-compatibility-implementation
+    var hasDontEnumBug = true,
+        dontEnums = [
+            "toString",
+            "toLocaleString",
+            "valueOf",
+            "hasOwnProperty",
+            "isPrototypeOf",
+            "propertyIsEnumerable",
+            "constructor"
+        ],
+        dontEnumsLength = dontEnums.length;
+
+    for (var key in {"toString": null})
+        hasDontEnumBug = false;
+
+    Object.keys = function keys(object) {
+
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError("Object.keys called on a non-object");
+
+        var keys = [];
+        for (var name in object) {
+            if (owns(object, name)) {
+                keys.push(name);
+            }
+        }
+
+        if (hasDontEnumBug) {
+            for (var i = 0, ii = dontEnumsLength; i < ii; i++) {
+                var dontEnum = dontEnums[i];
+                if (owns(object, dontEnum)) {
+                    keys.push(dontEnum);
+                }
+            }
+        }
+
+        return keys;
+    };
+
+}
+
+//
+// Date
+// ====
+//
+
+// ES5 15.9.5.43
+// http://es5.github.com/#x15.9.5.43
+// This function returns a String value represent the instance in time 
+// represented by this Date object. The format of the String is the Date Time 
+// string format defined in 15.9.1.15. All fields are present in the String. 
+// The time zone is always UTC, denoted by the suffix Z. If the time value of 
+// this object is not a finite Number a RangeError exception is thrown.
+if (!Date.prototype.toISOString || (new Date(-62198755200000).toISOString().indexOf('-000001') === -1)) {
+    Date.prototype.toISOString = function toISOString() {
+        var result, length, value, year;
+        if (!isFinite(this))
+            throw new RangeError;
+
+        // the date time string format is specified in 15.9.1.15.
+        result = [this.getUTCMonth() + 1, this.getUTCDate(),
+            this.getUTCHours(), this.getUTCMinutes(), this.getUTCSeconds()];
+        year = this.getUTCFullYear();
+        year = (year < 0 ? '-' : (year > 9999 ? '+' : '')) + ('00000' + Math.abs(year)).slice(0 <= year && year <= 9999 ? -4 : -6);
+
+        length = result.length;
+        while (length--) {
+            value = result[length];
+            // pad months, days, hours, minutes, and seconds to have two digits.
+            if (value < 10)
+                result[length] = "0" + value;
+        }
+        // pad milliseconds to have three digits.
+        return year + "-" + result.slice(0, 2).join("-") + "T" + result.slice(2).join(":") + "." +
+            ("000" + this.getUTCMilliseconds()).slice(-3) + "Z";
+    }
+}
+
+// ES5 15.9.4.4
+// http://es5.github.com/#x15.9.4.4
+if (!Date.now) {
+    Date.now = function now() {
+        return new Date().getTime();
+    };
+}
+
+// ES5 15.9.5.44
+// http://es5.github.com/#x15.9.5.44
+// This function provides a String representation of a Date object for use by 
+// JSON.stringify (15.12.3).
+if (!Date.prototype.toJSON) {
+    Date.prototype.toJSON = function toJSON(key) {
+        // When the toJSON method is called with argument key, the following 
+        // steps are taken:
+
+        // 1.  Let O be the result of calling ToObject, giving it the this
+        // value as its argument.
+        // 2. Let tv be ToPrimitive(O, hint Number).
+        // 3. If tv is a Number and is not finite, return null.
+        // XXX
+        // 4. Let toISO be the result of calling the [[Get]] internal method of
+        // O with argument "toISOString".
+        // 5. If IsCallable(toISO) is false, throw a TypeError exception.
+        if (typeof this.toISOString != "function")
+            throw new TypeError(); // TODO message
+        // 6. Return the result of calling the [[Call]] internal method of
+        //  toISO with O as the this value and an empty argument list.
+        return this.toISOString();
+
+        // NOTE 1 The argument is ignored.
+
+        // NOTE 2 The toJSON function is intentionally generic; it does not
+        // require that its this value be a Date object. Therefore, it can be
+        // transferred to other kinds of objects for use as a method. However,
+        // it does require that any such object have a toISOString method. An
+        // object is free to use the argument key to filter its
+        // stringification.
+    };
+}
+
+// ES5 15.9.4.2
+// http://es5.github.com/#x15.9.4.2
+// based on work shared by Daniel Friesen (dantman)
+// http://gist.github.com/303249
+if (Date.parse("+275760-09-13T00:00:00.000Z") !== 8.64e15) {
+    // XXX global assignment won't work in embeddings that use
+    // an alternate object for the context.
+    Date = (function(NativeDate) {
+
+        // Date.length === 7
+        var Date = function Date(Y, M, D, h, m, s, ms) {
+            var length = arguments.length;
+            if (this instanceof NativeDate) {
+                var date = length == 1 && String(Y) === Y ? // isString(Y)
+                    // We explicitly pass it through parse:
+                    new NativeDate(Date.parse(Y)) :
+                    // We have to manually make calls depending on argument
+                    // length here
+                    length >= 7 ? new NativeDate(Y, M, D, h, m, s, ms) :
+                    length >= 6 ? new NativeDate(Y, M, D, h, m, s) :
+                    length >= 5 ? new NativeDate(Y, M, D, h, m) :
+                    length >= 4 ? new NativeDate(Y, M, D, h) :
+                    length >= 3 ? new NativeDate(Y, M, D) :
+                    length >= 2 ? new NativeDate(Y, M) :
+                    length >= 1 ? new NativeDate(Y) :
+                                  new NativeDate();
+                // Prevent mixups with unfixed Date object
+                date.constructor = Date;
+                return date;
+            }
+            return NativeDate.apply(this, arguments);
+        };
+
+        // 15.9.1.15 Date Time String Format.
+        var isoDateExpression = new RegExp("^" +
+            "(\\d{4}|[\+\-]\\d{6})" + // four-digit year capture or sign + 6-digit extended year
+            "(?:-(\\d{2})" + // optional month capture
+            "(?:-(\\d{2})" + // optional day capture
+            "(?:" + // capture hours:minutes:seconds.milliseconds
+                "T(\\d{2})" + // hours capture
+                ":(\\d{2})" + // minutes capture
+                "(?:" + // optional :seconds.milliseconds
+                    ":(\\d{2})" + // seconds capture
+                    "(?:\\.(\\d{3}))?" + // milliseconds capture
+                ")?" +
+            "(?:" + // capture UTC offset component
+                "Z|" + // UTC capture
+                "(?:" + // offset specifier +/-hours:minutes
+                    "([-+])" + // sign capture
+                    "(\\d{2})" + // hours offset capture
+                    ":(\\d{2})" + // minutes offset capture
+                ")" +
+            ")?)?)?)?" +
+        "$");
+
+        // Copy any custom methods a 3rd party library may have added
+        for (var key in NativeDate)
+            Date[key] = NativeDate[key];
+
+        // Copy "native" methods explicitly; they may be non-enumerable
+        Date.now = NativeDate.now;
+        Date.UTC = NativeDate.UTC;
+        Date.prototype = NativeDate.prototype;
+        Date.prototype.constructor = Date;
+
+        // Upgrade Date.parse to handle simplified ISO 8601 strings
+        Date.parse = function parse(string) {
+            var match = isoDateExpression.exec(string);
+            if (match) {
+                match.shift(); // kill match[0], the full match
+                // parse months, days, hours, minutes, seconds, and milliseconds
+                for (var i = 1; i < 7; i++) {
+                    // provide default values if necessary
+                    match[i] = +(match[i] || (i < 3 ? 1 : 0));
+                    // match[1] is the month. Months are 0-11 in JavaScript
+                    // `Date` objects, but 1-12 in ISO notation, so we
+                    // decrement.
+                    if (i == 1)
+                        match[i]--;
+                }
+
+                // parse the UTC offset component
+                var minuteOffset = +match.pop(), hourOffset = +match.pop(), sign = match.pop();
+
+                // compute the explicit time zone offset if specified
+                var offset = 0;
+                if (sign) {
+                    // detect invalid offsets and return early
+                    if (hourOffset > 23 || minuteOffset > 59)
+                        return NaN;
+
+                    // express the provided time zone offset in minutes. The offset is
+                    // negative for time zones west of UTC; positive otherwise.
+                    offset = (hourOffset * 60 + minuteOffset) * 6e4 * (sign == "+" ? -1 : 1);
+                }
+
+                // Date.UTC for years between 0 and 99 converts year to 1900 + year
+                // The Gregorian calendar has a 400-year cycle, so 
+                // to Date.UTC(year + 400, .... ) - 12622780800000 == Date.UTC(year, ...),
+                // where 12622780800000 - number of milliseconds in Gregorian calendar 400 years
+                var year = +match[0];
+                if (0 <= year && year <= 99) {
+                    match[0] = year + 400;
+                    return NativeDate.UTC.apply(this, match) + offset - 12622780800000;
+                }
+
+                // compute a new UTC date value, accounting for the optional offset
+                return NativeDate.UTC.apply(this, match) + offset;
+            }
+            return NativeDate.parse.apply(this, arguments);
+        };
+
+        return Date;
+    })(Date);
+}
+
+//
+// String
+// ======
+//
+
+// ES5 15.5.4.20
+// http://es5.github.com/#x15.5.4.20
+var ws = "\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003" +
+    "\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028" +
+    "\u2029\uFEFF";
+if (!String.prototype.trim || ws.trim()) {
+    // http://blog.stevenlevithan.com/archives/faster-trim-javascript
+    // http://perfectionkills.com/whitespace-deviations/
+    ws = "[" + ws + "]";
+    var trimBeginRegexp = new RegExp("^" + ws + ws + "*"),
+        trimEndRegexp = new RegExp(ws + ws + "*$");
+    String.prototype.trim = function trim() {
+        return String(this).replace(trimBeginRegexp, "").replace(trimEndRegexp, "");
+    };
+}
+
+//
+// Util
+// ======
+//
+
+// ES5 9.4
+// http://es5.github.com/#x9.4
+// http://jsperf.com/to-integer
+var toInteger = function (n) {
+    n = +n;
+    if (n !== n) // isNaN
+        n = 0;
+    else if (n !== 0 && n !== (1/0) && n !== -(1/0))
+        n = (n > 0 || -1) * Math.floor(Math.abs(n));
+    return n;
+};
+
+var prepareString = "a"[0] != "a",
+    // ES5 9.9
+    // http://es5.github.com/#x9.9
+    toObject = function (o) {
+        if (o == null) { // this matches both null and undefined
+            throw new TypeError(); // TODO message
+        }
+        // If the implementation doesn't support by-index access of
+        // string characters (ex. IE < 7), split the string
+        if (prepareString && typeof o == "string" && o) {
+            return o.split("");
+        }
+        return Object(o);
+    };
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla Skywriter.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla.
+ * Portions created by the Initial Developer are Copyright (C) 2009
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Kevin Dangoor (kdangoor at mozilla.com)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/ace', ['require', 'exports', 'module' , 'ace/lib/fixoldbrowsers', 'ace/lib/dom', 'ace/lib/event', 'ace/editor', 'ace/edit_session', 'ace/undomanager', 'ace/virtual_renderer', 'ace/theme/textmate'], function(require, exports, module) {
+
+    require("./lib/fixoldbrowsers");
+
+    var Dom = require("./lib/dom");
+    var Event = require("./lib/event");
+
+    var Editor = require("./editor").Editor;
+    var EditSession = require("./edit_session").EditSession;
+    var UndoManager = require("./undomanager").UndoManager;
+    var Renderer = require("./virtual_renderer").VirtualRenderer;
+
+    exports.edit = function(el) {
+        if (typeof(el) == "string") {
+            el = document.getElementById(el);
+        }
+
+        var doc = new EditSession(Dom.getInnerText(el));
+        doc.setUndoManager(new UndoManager());
+        el.innerHTML = '';
+
+        var editor = new Editor(new Renderer(el, require("./theme/textmate")));
+        editor.setSession(doc);
+
+        var env = {};
+        env.document = doc;
+        env.editor = editor;
+        editor.resize();
+        Event.addListener(window, "resize", function() {
+            editor.resize();
+        });
+        el.env = env;
+        // Store env on editor such that it can be accessed later on from
+        // the returned object.
+        editor.env = env;
+        return editor;
+    };
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai AT sucan AT gmail ODT com>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/dom', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var XHTML_NS = "http://www.w3.org/1999/xhtml";
+
+exports.createElement = function(tag, ns) {
+    return document.createElementNS ?
+           document.createElementNS(ns || XHTML_NS, tag) :
+           document.createElement(tag);
+};
+
+exports.setText = function(elem, text) {
+    if (elem.innerText !== undefined) {
+        elem.innerText = text;
+    }
+    if (elem.textContent !== undefined) {
+        elem.textContent = text;
+    }
+};
+
+exports.hasCssClass = function(el, name) {
+    var classes = el.className.split(/\s+/g);
+    return classes.indexOf(name) !== -1;
+};
+
+/**
+* Add a CSS class to the list of classes on the given node
+*/
+exports.addCssClass = function(el, name) {
+    if (!exports.hasCssClass(el, name)) {
+        el.className += " " + name;
+    }
+};
+
+/**
+* Remove a CSS class from the list of classes on the given node
+*/
+exports.removeCssClass = function(el, name) {
+    var classes = el.className.split(/\s+/g);
+    while (true) {
+        var index = classes.indexOf(name);
+        if (index == -1) {
+            break;
+        }
+        classes.splice(index, 1);
+    }
+    el.className = classes.join(" ");
+};
+
+exports.toggleCssClass = function(el, name) {
+    var classes = el.className.split(/\s+/g), add = true;
+    while (true) {
+        var index = classes.indexOf(name);
+        if (index == -1) {
+            break;
+        }
+        add = false;
+        classes.splice(index, 1);
+    }
+    if(add)
+        classes.push(name);
+
+    el.className = classes.join(" ");
+    return add;
+};
+
+/**
+ * Add or remove a CSS class from the list of classes on the given node
+ * depending on the value of <tt>include</tt>
+ */
+exports.setCssClass = function(node, className, include) {
+    if (include) {
+        exports.addCssClass(node, className);
+    } else {
+        exports.removeCssClass(node, className);
+    }
+};
+
+exports.hasCssString = function(id, doc) {
+    var index = 0, sheets;
+    doc = doc || document;
+
+    if (doc.createStyleSheet && (sheets = doc.styleSheets)) {
+        while (index < sheets.length)
+            if (sheets[index++].title === id) return true;
+    } else if ((sheets = doc.getElementsByTagName("style"))) {
+        while (index < sheets.length)
+            if (sheets[index++].id === id) return true;
+    }
+
+    return false;
+};
+
+exports.importCssString = function importCssString(cssText, id, doc) {
+    doc = doc || document;
+    // If style is already imported return immediately.
+    if (id && exports.hasCssString(id, doc))
+        return null;
+    
+    var style;
+    
+    if (doc.createStyleSheet) {
+        style = doc.createStyleSheet();
+        style.cssText = cssText;
+        if (id)
+            style.title = id;
+    } else {
+        style = doc.createElementNS ?
+                    doc.createElementNS(XHTML_NS, "style") :
+                    doc.createElement("style");
+
+        style.appendChild(doc.createTextNode(cssText));
+        if (id)
+            style.id = id;
+
+        var head = doc.getElementsByTagName("head")[0] || doc.documentElement;
+        head.appendChild(style);
+    }
+};
+
+exports.importCssStylsheet = function(uri, doc) {
+    if (doc.createStyleSheet) {
+        doc.createStyleSheet(uri);
+    } else {
+        var link = exports.createElement('link');
+        link.rel = 'stylesheet';
+        link.href = uri;
+
+        var head = doc.getElementsByTagName("head")[0] || doc.documentElement;
+        head.appendChild(link);
+    }
+};
+
+exports.getInnerWidth = function(element) {
+    return (
+        parseInt(exports.computedStyle(element, "paddingLeft"), 10) +
+        parseInt(exports.computedStyle(element, "paddingRight"), 10) + 
+        element.clientWidth
+    );
+};
+
+exports.getInnerHeight = function(element) {
+    return (
+        parseInt(exports.computedStyle(element, "paddingTop"), 10) +
+        parseInt(exports.computedStyle(element, "paddingBottom"), 10) +
+        element.clientHeight
+    );
+};
+
+if (window.pageYOffset !== undefined) {
+    exports.getPageScrollTop = function() {
+        return window.pageYOffset;
+    };
+
+    exports.getPageScrollLeft = function() {
+        return window.pageXOffset;
+    };
+}
+else {
+    exports.getPageScrollTop = function() {
+        return document.body.scrollTop;
+    };
+
+    exports.getPageScrollLeft = function() {
+        return document.body.scrollLeft;
+    };
+}
+
+if (window.getComputedStyle)
+    exports.computedStyle = function(element, style) {
+        if (style)
+            return (window.getComputedStyle(element, "") || {})[style] || "";
+        return window.getComputedStyle(element, "") || {};
+    };
+else
+    exports.computedStyle = function(element, style) {
+        if (style)
+            return element.currentStyle[style];
+        return element.currentStyle;
+    };
+
+exports.scrollbarWidth = function(document) {
+
+    var inner = exports.createElement("p");
+    inner.style.width = "100%";
+    inner.style.minWidth = "0px";
+    inner.style.height = "200px";
+
+    var outer = exports.createElement("div");
+    var style = outer.style;
+
+    style.position = "absolute";
+    style.left = "-10000px";
+    style.overflow = "hidden";
+    style.width = "200px";
+    style.minWidth = "0px";
+    style.height = "150px";
+
+    outer.appendChild(inner);
+
+    var body = document.body || document.documentElement;
+    body.appendChild(outer);
+
+    var noScrollbar = inner.offsetWidth;
+
+    style.overflow = "scroll";
+    var withScrollbar = inner.offsetWidth;
+
+    if (noScrollbar == withScrollbar) {
+        withScrollbar = outer.clientWidth;
+    }
+
+    body.removeChild(outer);
+
+    return noScrollbar-withScrollbar;
+};
+
+/**
+ * Optimized set innerHTML. This is faster than plain innerHTML if the element
+ * already contains a lot of child elements.
+ *
+ * See http://blog.stevenlevithan.com/archives/faster-than-innerhtml for details
+ */
+exports.setInnerHtml = function(el, innerHtml) {
+    var element = el.cloneNode(false);//document.createElement("div");
+    element.innerHTML = innerHtml;
+    el.parentNode.replaceChild(element, el);
+    return element;
+};
+
+exports.setInnerText = function(el, innerText) {
+    var document = el.ownerDocument;
+    if (document.body && "textContent" in document.body)
+        el.textContent = innerText;
+    else
+        el.innerText = innerText;
+
+};
+
+exports.getInnerText = function(el) {
+    var document = el.ownerDocument;
+    if (document.body && "textContent" in document.body)
+        return el.textContent;
+    else
+         return el.innerText || el.textContent || "";
+};
+
+exports.getParentWindow = function(document) {
+    return document.defaultView || document.parentWindow;
+};
+
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/event', ['require', 'exports', 'module' , 'ace/lib/keys', 'ace/lib/useragent', 'ace/lib/dom'], function(require, exports, module) {
+
+var keys = require("./keys");
+var useragent = require("./useragent");
+var dom = require("./dom");
+
+exports.addListener = function(elem, type, callback) {
+    if (elem.addEventListener) {
+        return elem.addEventListener(type, callback, false);
+    }
+    if (elem.attachEvent) {
+        var wrapper = function() {
+            callback(window.event);
+        };
+        callback._wrapper = wrapper;
+        elem.attachEvent("on" + type, wrapper);
+    }
+};
+
+exports.removeListener = function(elem, type, callback) {
+    if (elem.removeEventListener) {
+        return elem.removeEventListener(type, callback, false);
+    }
+    if (elem.detachEvent) {
+        elem.detachEvent("on" + type, callback._wrapper || callback);
+    }
+};
+
+/**
+* Prevents propagation and clobbers the default action of the passed event
+*/
+exports.stopEvent = function(e) {
+    exports.stopPropagation(e);
+    exports.preventDefault(e);
+    return false;
+};
+
+exports.stopPropagation = function(e) {
+    if (e.stopPropagation)
+        e.stopPropagation();
+    else
+        e.cancelBubble = true;
+};
+
+exports.preventDefault = function(e) {
+    if (e.preventDefault)
+        e.preventDefault();
+    else
+        e.returnValue = false;
+};
+
+exports.getDocumentX = function(e) {
+    if (e.clientX) {
+        return e.clientX + dom.getPageScrollLeft();
+    } else {
+        return e.pageX;
+    }
+};
+
+exports.getDocumentY = function(e) {
+    if (e.clientY) {
+        return e.clientY + dom.getPageScrollTop();
+    } else {
+        return e.pageY;
+    }
+};
+
+/**
+ * @return {Number} 0 for left button, 1 for middle button, 2 for right button
+ */
+exports.getButton = function(e) {
+    if (e.type == "dblclick")
+        return 0;
+    else if (e.type == "contextmenu")
+        return 2;
+
+    // DOM Event
+    if (e.preventDefault) {
+        return e.button;
+    }
+    // old IE
+    else {
+        return {1:0, 2:2, 4:1}[e.button];
+    }
+};
+
+if (document.documentElement.setCapture) {
+    exports.capture = function(el, eventHandler, releaseCaptureHandler) {
+        function onMouseMove(e) {
+            eventHandler(e);
+            return exports.stopPropagation(e);
+        }
+
+        var called = false;
+        function onReleaseCapture(e) {
+            eventHandler(e);
+
+            if (!called) {
+                called = true;
+                releaseCaptureHandler(e);
+            }
+
+            exports.removeListener(el, "mousemove", eventHandler);
+            exports.removeListener(el, "mouseup", onReleaseCapture);
+            exports.removeListener(el, "losecapture", onReleaseCapture);
+
+            el.releaseCapture();
+        }
+
+        exports.addListener(el, "mousemove", eventHandler);
+        exports.addListener(el, "mouseup", onReleaseCapture);
+        exports.addListener(el, "losecapture", onReleaseCapture);
+        el.setCapture();
+    };
+}
+else {
+    exports.capture = function(el, eventHandler, releaseCaptureHandler) {
+        function onMouseMove(e) {
+            eventHandler(e);
+            e.stopPropagation();
+        }
+
+        function onMouseUp(e) {
+            eventHandler && eventHandler(e);
+            releaseCaptureHandler && releaseCaptureHandler(e);
+
+            document.removeEventListener("mousemove", onMouseMove, true);
+            document.removeEventListener("mouseup", onMouseUp, true);
+
+            e.stopPropagation();
+        }
+
+        document.addEventListener("mousemove", onMouseMove, true);
+        document.addEventListener("mouseup", onMouseUp, true);
+    };
+}
+
+exports.addMouseWheelListener = function(el, callback) {
+    var max = 0;
+    var listener = function(e) {
+        if (e.wheelDelta !== undefined) {
+
+            // some versions of Safari (e.g. 5.0.5) report insanely high
+            // scroll values. These browsers require a higher factor
+            if (Math.abs(e.wheelDeltaY) > max)
+                max = Math.abs(e.wheelDeltaY);
+
+            if (max > 5000)
+                var factor = 400;
+            else
+                var factor = 8;
+
+            if (e.wheelDeltaX !== undefined) {
+                e.wheelX = -e.wheelDeltaX / factor;
+                e.wheelY = -e.wheelDeltaY / factor;
+            } else {
+                e.wheelX = 0;
+                e.wheelY = -e.wheelDelta / factor;
+            }
+        }
+        else {
+            if (e.axis && e.axis == e.HORIZONTAL_AXIS) {
+                e.wheelX = (e.detail || 0) * 5;
+                e.wheelY = 0;
+            } else {
+                e.wheelX = 0;
+                e.wheelY = (e.detail || 0) * 5;
+            }
+        }
+        callback(e);
+    };
+    exports.addListener(el, "DOMMouseScroll", listener);
+    exports.addListener(el, "mousewheel", listener);
+};
+
+exports.addMultiMouseDownListener = function(el, button, count, timeout, callback) {
+    var clicks = 0;
+    var startX, startY;
+
+    var listener = function(e) {
+        clicks += 1;
+        if (clicks == 1) {
+            startX = e.clientX;
+            startY = e.clientY;
+
+            setTimeout(function() {
+                clicks = 0;
+            }, timeout || 600);
+        }
+
+        var isButton = exports.getButton(e) == button;
+        if (!isButton || Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5)
+            clicks = 0;
+
+        if (clicks == count) {
+            clicks = 0;
+            callback(e);
+        }
+
+        if (isButton)
+            return exports.preventDefault(e);
+    };
+
+    exports.addListener(el, "mousedown", listener);
+    useragent.isOldIE && exports.addListener(el, "dblclick", listener);
+};
+
+function normalizeCommandKeys(callback, e, keyCode) {
+    var hashId = 0;
+    if (useragent.isOpera && useragent.isMac) {
+        hashId = 0 | (e.metaKey ? 1 : 0) | (e.altKey ? 2 : 0)
+            | (e.shiftKey ? 4 : 0) | (e.ctrlKey ? 8 : 0);
+    } else {
+        hashId = 0 | (e.ctrlKey ? 1 : 0) | (e.altKey ? 2 : 0)
+            | (e.shiftKey ? 4 : 0) | (e.metaKey ? 8 : 0);
+    }
+
+    if (keyCode in keys.MODIFIER_KEYS) {
+        switch (keys.MODIFIER_KEYS[keyCode]) {
+            case "Alt":
+                hashId = 2;
+                break;
+            case "Shift":
+                hashId = 4;
+                break;
+            case "Ctrl":
+                hashId = 1;
+                break;
+            default:
+                hashId = 8;
+                break;
+        }
+        keyCode = 0;
+    }
+
+    if (hashId & 8 && (keyCode == 91 || keyCode == 93)) {
+        keyCode = 0;
+    }
+
+    // If there is no hashID and the keyCode is not a function key, then
+    // we don't call the callback as we don't handle a command key here
+    // (it's a normal key/character input).
+    if (!hashId && !(keyCode in keys.FUNCTION_KEYS) && !(keyCode in keys.PRINTABLE_KEYS)) {
+        return false;
+    }
+    return callback(e, hashId, keyCode);
+}
+
+exports.addCommandKeyListener = function(el, callback) {
+    var addListener = exports.addListener;
+    if (useragent.isOldGecko) {
+        // Old versions of Gecko aka. Firefox < 4.0 didn't repeat the keydown
+        // event if the user pressed the key for a longer time. Instead, the
+        // keydown event was fired once and later on only the keypress event.
+        // To emulate the 'right' keydown behavior, the keyCode of the initial
+        // keyDown event is stored and in the following keypress events the
+        // stores keyCode is used to emulate a keyDown event.
+        var lastKeyDownKeyCode = null;
+        addListener(el, "keydown", function(e) {
+            lastKeyDownKeyCode = e.keyCode;
+        });
+        addListener(el, "keypress", function(e) {
+            return normalizeCommandKeys(callback, e, lastKeyDownKeyCode);
+        });
+    } else {
+        var lastDown = null;
+
+        addListener(el, "keydown", function(e) {
+            lastDown = e.keyIdentifier || e.keyCode;
+            return normalizeCommandKeys(callback, e, e.keyCode);
+        });
+
+        // repeated keys are fired as keypress and not keydown events
+        if (useragent.isMac && useragent.isOpera) {
+            addListener(el, "keypress", function(e) {
+                var keyId = e.keyIdentifier || e.keyCode;
+                if (lastDown !== keyId) {
+                    return normalizeCommandKeys(callback, e, lastDown);
+                } else {
+                    lastDown = null;
+                }
+            });
+        }
+    }
+};
+
+if (window.postMessage) {
+    var postMessageId = 1;
+    exports.nextTick = function(callback, win) {
+        win = win || window;
+        var messageName = "zero-timeout-message-" + postMessageId;            
+        exports.addListener(win, "message", function listener(e) {
+            if (e.data == messageName) {
+                exports.stopPropagation(e);
+                exports.removeListener(win, "message", listener);
+                callback();
+            }
+        });
+        win.postMessage(messageName, "*");
+    };
+}
+else {
+    exports.nextTick = function(callback, win) {
+        win = win || window;
+        window.setTimeout(callback, 0);
+    };
+}
+
+});
+/*! @license
+==========================================================================
+SproutCore -- JavaScript Application Framework
+copyright 2006-2009, Sprout Systems Inc., Apple Inc. and contributors.
+
+Permission is hereby granted, free of charge, to any person obtaining a
+copy of this software and associated documentation files (the "Software"),
+to deal in the Software without restriction, including without limitation
+the rights to use, copy, modify, merge, publish, distribute, sublicense,
+and/or sell copies of the Software, and to permit persons to whom the
+Software is furnished to do so, subject to the following conditions:
+
+The above copyright notice and this permission notice shall be included in
+all copies or substantial portions of the Software.
+
+THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
+DEALINGS IN THE SOFTWARE.
+
+SproutCore and the SproutCore logo are trademarks of Sprout Systems, Inc.
+
+For more information about SproutCore, visit http://www.sproutcore.com
+
+
+==========================================================================
+ at license */
+
+// Most of the following code is taken from SproutCore with a few changes.
+
+define('ace/lib/keys', ['require', 'exports', 'module' , 'ace/lib/oop'], function(require, exports, module) {
+
+var oop = require("./oop");
+
+/**
+ * Helper functions and hashes for key handling.
+ */
+var Keys = (function() {
+    var ret = {
+        MODIFIER_KEYS: {
+            16: 'Shift', 17: 'Ctrl', 18: 'Alt', 224: 'Meta'
+        },
+
+        KEY_MODS: {
+            "ctrl": 1, "alt": 2, "option" : 2,
+            "shift": 4, "meta": 8, "command": 8
+        },
+
+        FUNCTION_KEYS : {
+            8  : "Backspace",
+            9  : "Tab",
+            13 : "Return",
+            19 : "Pause",
+            27 : "Esc",
+            32 : "Space",
+            33 : "PageUp",
+            34 : "PageDown",
+            35 : "End",
+            36 : "Home",
+            37 : "Left",
+            38 : "Up",
+            39 : "Right",
+            40 : "Down",
+            44 : "Print",
+            45 : "Insert",
+            46 : "Delete",
+            96 : "Numpad0",
+            97 : "Numpad1",
+            98 : "Numpad2",
+            99 : "Numpad3",
+            100: "Numpad4",
+            101: "Numpad5",
+            102: "Numpad6",
+            103: "Numpad7",
+            104: "Numpad8",
+            105: "Numpad9",
+            112: "F1",
+            113: "F2",
+            114: "F3",
+            115: "F4",
+            116: "F5",
+            117: "F6",
+            118: "F7",
+            119: "F8",
+            120: "F9",
+            121: "F10",
+            122: "F11",
+            123: "F12",
+            144: "Numlock",
+            145: "Scrolllock"
+        },
+
+        PRINTABLE_KEYS: {
+           32: ' ',  48: '0',  49: '1',  50: '2',  51: '3',  52: '4', 53:  '5',
+           54: '6',  55: '7',  56: '8',  57: '9',  59: ';',  61: '=', 65:  'a',
+           66: 'b',  67: 'c',  68: 'd',  69: 'e',  70: 'f',  71: 'g', 72:  'h',
+           73: 'i',  74: 'j',  75: 'k',  76: 'l',  77: 'm',  78: 'n', 79:  'o',
+           80: 'p',  81: 'q',  82: 'r',  83: 's',  84: 't',  85: 'u', 86:  'v',
+           87: 'w',  88: 'x',  89: 'y',  90: 'z', 107: '+', 109: '-', 110: '.',
+          188: ',', 190: '.', 191: '/', 192: '`', 219: '[', 220: '\\',
+          221: ']', 222: '\"'
+        }
+    };
+
+    // A reverse map of FUNCTION_KEYS
+    for (var i in ret.FUNCTION_KEYS) {
+        var name = ret.FUNCTION_KEYS[i].toUpperCase();
+        ret[name] = parseInt(i, 10);
+    }
+
+    // Add the MODIFIER_KEYS, FUNCTION_KEYS and PRINTABLE_KEYS to the KEY
+    // variables as well.
+    oop.mixin(ret, ret.MODIFIER_KEYS);
+    oop.mixin(ret, ret.PRINTABLE_KEYS);
+    oop.mixin(ret, ret.FUNCTION_KEYS);
+
+    return ret;
+})();
+oop.mixin(exports, Keys);
+
+exports.keyCodeToString = function(keyCode) {
+    return (Keys[keyCode] || String.fromCharCode(keyCode)).toLowerCase();
+}
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/oop', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+exports.inherits = (function() {
+    var tempCtor = function() {};
+    return function(ctor, superCtor) {
+        tempCtor.prototype = superCtor.prototype;
+        ctor.super_ = superCtor.prototype;
+        ctor.prototype = new tempCtor();
+        ctor.prototype.constructor = ctor;
+    }
+}());
+
+exports.mixin = function(obj, mixin) {
+    for (var key in mixin) {
+        obj[key] = mixin[key];
+    }
+};
+
+exports.implement = function(proto, mixin) {
+    exports.mixin(proto, mixin);
+};
+
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/useragent', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var os = (navigator.platform.match(/mac|win|linux/i) || ["other"])[0].toLowerCase();
+var ua = navigator.userAgent;
+var av = navigator.appVersion;
+
+/** Is the user using a browser that identifies itself as Windows */
+exports.isWin = (os == "win");
+
+/** Is the user using a browser that identifies itself as Mac OS */
+exports.isMac = (os == "mac");
+
+/** Is the user using a browser that identifies itself as Linux */
+exports.isLinux = (os == "linux");
+
+exports.isIE = 
+    navigator.appName == "Microsoft Internet Explorer"
+    && parseFloat(navigator.userAgent.match(/MSIE ([0-9]+[\.0-9]+)/)[1]);
+    
+exports.isOldIE = exports.isIE && exports.isIE < 9;
+
+/** Is this Firefox or related? */
+exports.isGecko = exports.isMozilla = window.controllers && window.navigator.product === "Gecko";
+
+/** oldGecko == rev < 2.0 **/
+exports.isOldGecko = exports.isGecko && parseInt((navigator.userAgent.match(/rv\:(\d+)/)||[])[1]) < 4;
+
+/** Is this Opera */
+exports.isOpera = window.opera && Object.prototype.toString.call(window.opera) == "[object Opera]";
+
+/** Is the user using a browser that identifies itself as WebKit */
+exports.isWebKit = parseFloat(ua.split("WebKit/")[1]) || undefined;
+
+exports.isChrome = parseFloat(ua.split(" Chrome/")[1]) || undefined;
+
+exports.isAIR = ua.indexOf("AdobeAIR") >= 0;
+
+exports.isIPad = ua.indexOf("iPad") >= 0;
+
+exports.isTouchPad = ua.indexOf("TouchPad") >= 0;
+
+/**
+ * I hate doing this, but we need some way to determine if the user is on a Mac
+ * The reason is that users have different expectations of their key combinations.
+ *
+ * Take copy as an example, Mac people expect to use CMD or APPLE + C
+ * Windows folks expect to use CTRL + C
+ */
+exports.OS = {
+    LINUX: 'LINUX',
+    MAC: 'MAC',
+    WINDOWS: 'WINDOWS'
+};
+
+/**
+ * Return an exports.OS constant
+ */
+exports.getOS = function() {
+    if (exports.isMac) {
+        return exports.OS['MAC'];
+    } else if (exports.isLinux) {
+        return exports.OS['LINUX'];
+    } else {
+        return exports.OS['WINDOWS'];
+    }
+};
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/editor', ['require', 'exports', 'module' , 'ace/lib/fixoldbrowsers', 'ace/lib/oop', 'ace/lib/lang', 'ace/lib/useragent', 'ace/keyboard/textinput', 'ace/mouse/mouse_handler', 'ace/mouse/fold_handler', 'ace/keyboard/keybinding', 'ace/edit_session', 'ace/search', 'ace/range', 'ace/lib/event_emitter', 'ace/commands/command_manager', 'ace/commands/default_commands'], function(require, exports, module) {
+
+require("./lib/fixoldbrowsers");
+
+var oop = require("./lib/oop");
+var lang = require("./lib/lang");
+var useragent = require("./lib/useragent");
+var TextInput = require("./keyboard/textinput").TextInput;
+var MouseHandler = require("./mouse/mouse_handler").MouseHandler;
+var FoldHandler = require("./mouse/fold_handler").FoldHandler;
+//var TouchHandler = require("./touch_handler").TouchHandler;
+var KeyBinding = require("./keyboard/keybinding").KeyBinding;
+var EditSession = require("./edit_session").EditSession;
+var Search = require("./search").Search;
+var Range = require("./range").Range;
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+var CommandManager = require("./commands/command_manager").CommandManager;
+var defaultCommands = require("./commands/default_commands").commands;
+
+var Editor = function(renderer, session) {
+    var container = renderer.getContainerElement();
+    this.container = container;
+    this.renderer = renderer;
+
+    this.textInput  = new TextInput(renderer.getTextAreaContainer(), this);
+    this.keyBinding = new KeyBinding(this);
+
+    // TODO detect touch event support
+    if (useragent.isIPad) {
+        //this.$mouseHandler = new TouchHandler(this);
+    } else {
+        this.$mouseHandler = new MouseHandler(this);
+        new FoldHandler(this);
+    }
+
+    this.$blockScrolling = 0;
+    this.$search = new Search().set({
+        wrap: true
+    });
+
+    this.commands = new CommandManager(useragent.isMac ? "mac" : "win", defaultCommands);
+    this.setSession(session || new EditSession(""));
+};
+
+(function(){
+
+    oop.implement(this, EventEmitter);
+
+    this.setKeyboardHandler = function(keyboardHandler) {
+        this.keyBinding.setKeyboardHandler(keyboardHandler);
+    };
+
+    this.getKeyboardHandler = function() {
+        return this.keyBinding.getKeyboardHandler();
+    };
+
+    this.setSession = function(session) {
+        if (this.session == session)
+            return;
+
+        if (this.session) {
+            var oldSession = this.session;
+            this.session.removeEventListener("change", this.$onDocumentChange);
+            this.session.removeEventListener("changeMode", this.$onChangeMode);
+            this.session.removeEventListener("tokenizerUpdate", this.$onTokenizerUpdate);
+            this.session.removeEventListener("changeTabSize", this.$onChangeTabSize);
+            this.session.removeEventListener("changeWrapLimit", this.$onChangeWrapLimit);
+            this.session.removeEventListener("changeWrapMode", this.$onChangeWrapMode);
+            this.session.removeEventListener("onChangeFold", this.$onChangeFold);
+            this.session.removeEventListener("changeFrontMarker", this.$onChangeFrontMarker);
+            this.session.removeEventListener("changeBackMarker", this.$onChangeBackMarker);
+            this.session.removeEventListener("changeBreakpoint", this.$onChangeBreakpoint);
+            this.session.removeEventListener("changeAnnotation", this.$onChangeAnnotation);
+            this.session.removeEventListener("changeOverwrite", this.$onCursorChange);
+
+            var selection = this.session.getSelection();
+            selection.removeEventListener("changeCursor", this.$onCursorChange);
+            selection.removeEventListener("changeSelection", this.$onSelectionChange);
+
+            this.session.setScrollTopRow(this.renderer.getScrollTopRow());
+        }
+
+        this.session = session;
+
+        this.$onDocumentChange = this.onDocumentChange.bind(this);
+        session.addEventListener("change", this.$onDocumentChange);
+        this.renderer.setSession(session);
+
+        this.$onChangeMode = this.onChangeMode.bind(this);
+        session.addEventListener("changeMode", this.$onChangeMode);
+
+        this.$onTokenizerUpdate = this.onTokenizerUpdate.bind(this);
+        session.addEventListener("tokenizerUpdate", this.$onTokenizerUpdate);
+
+        this.$onChangeTabSize = this.renderer.updateText.bind(this.renderer);
+        session.addEventListener("changeTabSize", this.$onChangeTabSize);
+
+        this.$onChangeWrapLimit = this.onChangeWrapLimit.bind(this);
+        session.addEventListener("changeWrapLimit", this.$onChangeWrapLimit);
+
+        this.$onChangeWrapMode = this.onChangeWrapMode.bind(this);
+        session.addEventListener("changeWrapMode", this.$onChangeWrapMode);
+
+        this.$onChangeFold = this.onChangeFold.bind(this);
+        session.addEventListener("changeFold", this.$onChangeFold);
+
+        this.$onChangeFrontMarker = this.onChangeFrontMarker.bind(this);
+        this.session.addEventListener("changeFrontMarker", this.$onChangeFrontMarker);
+
+        this.$onChangeBackMarker = this.onChangeBackMarker.bind(this);
+        this.session.addEventListener("changeBackMarker", this.$onChangeBackMarker);
+
+        this.$onChangeBreakpoint = this.onChangeBreakpoint.bind(this);
+        this.session.addEventListener("changeBreakpoint", this.$onChangeBreakpoint);
+
+        this.$onChangeAnnotation = this.onChangeAnnotation.bind(this);
+        this.session.addEventListener("changeAnnotation", this.$onChangeAnnotation);
+
+        this.$onCursorChange = this.onCursorChange.bind(this);
+        this.session.addEventListener("changeOverwrite", this.$onCursorChange);
+
+        this.selection = session.getSelection();
+        this.selection.addEventListener("changeCursor", this.$onCursorChange);
+
+        this.$onSelectionChange = this.onSelectionChange.bind(this);
+        this.selection.addEventListener("changeSelection", this.$onSelectionChange);
+
+        this.onChangeMode();
+
+        this.onCursorChange();
+        this.onSelectionChange();
+        this.onChangeFrontMarker();
+        this.onChangeBackMarker();
+        this.onChangeBreakpoint();
+        this.onChangeAnnotation();
+        this.session.getUseWrapMode() && this.renderer.adjustWrapLimit();
+        this.renderer.scrollToRow(session.getScrollTopRow());
+        this.renderer.updateFull();
+
+        this._dispatchEvent("changeSession", {
+            session: session,
+            oldSession: oldSession
+        });
+    };
+
+    this.getSession = function() {
+        return this.session;
+    };
+
+    this.getSelection = function() {
+        return this.selection;
+    };
+
+    this.resize = function() {
+        this.renderer.onResize();
+    };
+
+    this.setTheme = function(theme) {
+        this.renderer.setTheme(theme);
+    };
+
+    this.getTheme = function() {
+        return this.renderer.getTheme();
+    };
+
+    this.setStyle = function(style) {
+        this.renderer.setStyle(style);
+    };
+
+    this.unsetStyle = function(style) {
+        this.renderer.unsetStyle(style);
+    };
+
+    this.setFontSize = function(size) {
+        this.container.style.fontSize = size;
+    };
+
+    this.$highlightBrackets = function() {
+        if (this.session.$bracketHighlight) {
+            this.session.removeMarker(this.session.$bracketHighlight);
+            this.session.$bracketHighlight = null;
+        }
+
+        if (this.$highlightPending) {
+            return;
+        }
+
+        // perform highlight async to not block the browser during navigation
+        var self = this;
+        this.$highlightPending = true;
+        setTimeout(function() {
+            self.$highlightPending = false;
+
+            var pos = self.session.findMatchingBracket(self.getCursorPosition());
+            if (pos) {
+                var range = new Range(pos.row, pos.column, pos.row, pos.column+1);
+                self.session.$bracketHighlight = self.session.addMarker(range, "ace_bracket", "text");
+            }
+        }, 10);
+    };
+
+    this.focus = function() {
+        // Safari needs the timeout
+        // iOS and Firefox need it called immediately
+        // to be on the save side we do both
+        var _self = this;
+        setTimeout(function() {
+            _self.textInput.focus();
+        });
+        this.textInput.focus();
+    };
+
+    this.isFocused = function() {
+        return this.textInput.isFocused();
+    };
+
+    this.blur = function() {
+        this.textInput.blur();
+    };
+
+    this.onFocus = function() {
+        this.renderer.showCursor();
+        this.renderer.visualizeFocus();
+        this._dispatchEvent("focus");
+    };
+
+    this.onBlur = function() {
+        this.renderer.hideCursor();
+        this.renderer.visualizeBlur();
+        this._dispatchEvent("blur");
+    };
+
+    this.onDocumentChange = function(e) {
+        var delta = e.data;
+        var range = delta.range;
+        var lastRow;
+
+        if (range.start.row == range.end.row && delta.action != "insertLines" && delta.action != "removeLines")
+            lastRow = range.end.row;
+        else
+            lastRow = Infinity;
+        this.renderer.updateLines(range.start.row, lastRow);
+
+        this._dispatchEvent("change", e);
+
+        // update cursor because tab characters can influence the cursor position
+        this.onCursorChange();
+    };
+
+    this.onTokenizerUpdate = function(e) {
+        var rows = e.data;
+        this.renderer.updateLines(rows.first, rows.last);
+    };
+
+    this.onCursorChange = function() {
+        this.renderer.updateCursor();
+
+        if (!this.$blockScrolling) {
+            this.renderer.scrollCursorIntoView();
+        }
+
+        // move text input over the cursor
+        // this is required for iOS and IME
+        this.renderer.moveTextAreaToCursor(this.textInput.getElement());
+
+        this.$highlightBrackets();
+        this.$updateHighlightActiveLine();
+    };
+
+    this.$updateHighlightActiveLine = function() {
+        var session = this.getSession();
+
+        if (session.$highlightLineMarker) {
+            session.removeMarker(session.$highlightLineMarker);
+        }
+        session.$highlightLineMarker = null;
+
+        if (this.getHighlightActiveLine() && (this.getSelectionStyle() != "line" || !this.selection.isMultiLine())) {
+            var cursor = this.getCursorPosition(),
+                foldLine = this.session.getFoldLine(cursor.row);
+            var range;
+            if (foldLine) {
+                range = new Range(foldLine.start.row, 0, foldLine.end.row + 1, 0);
+            } else {
+                range = new Range(cursor.row, 0, cursor.row+1, 0);
+            }
+            session.$highlightLineMarker = session.addMarker(range, "ace_active_line", "background");
+        }
+    };
+
+    this.onSelectionChange = function(e) {
+        var session = this.getSession();
+
+        if (session.$selectionMarker) {
+            session.removeMarker(session.$selectionMarker);
+        }
+        session.$selectionMarker = null;
+
+        if (!this.selection.isEmpty()) {
+            var range = this.selection.getRange();
+            var style = this.getSelectionStyle();
+            session.$selectionMarker = session.addMarker(range, "ace_selection", style);
+        } else {
+            this.$updateHighlightActiveLine();
+        }
+
+        if (this.$highlightSelectedWord)
+            this.session.getMode().highlightSelection(this);
+    };
+
+    this.onChangeFrontMarker = function() {
+        this.renderer.updateFrontMarkers();
+    };
+
+    this.onChangeBackMarker = function() {
+        this.renderer.updateBackMarkers();
+    };
+
+    this.onChangeBreakpoint = function() {
+        this.renderer.setBreakpoints(this.session.getBreakpoints());
+    };
+
+    this.onChangeAnnotation = function() {
+        this.renderer.setAnnotations(this.session.getAnnotations());
+    };
+
+    this.onChangeMode = function() {
+        this.renderer.updateText();
+    };
+
+    this.onChangeWrapLimit = function() {
+        this.renderer.updateFull();
+    };
+
+    this.onChangeWrapMode = function() {
+        this.renderer.onResize(true);
+    };
+
+    this.onChangeFold = function() {
+        // Update the active line marker as due to folding changes the current
+        // line range on the screen might have changed.
+        this.$updateHighlightActiveLine();
+        // TODO: This might be too much updating. Okay for now.
+        this.renderer.updateFull();
+    };
+
+    this.getCopyText = function() {
+        var text = "";
+        if (!this.selection.isEmpty())
+            text = this.session.getTextRange(this.getSelectionRange());
+
+        this._emit("copy", text);
+        return text;
+    };
+
+    this.onCut = function() {
+        if (this.$readOnly)
+            return;
+
+        var range = this.getSelectionRange();
+        this._emit("cut", range);
+
+        if (!this.selection.isEmpty()) {
+            this.session.remove(range);
+            this.clearSelection();
+        }
+    };
+
+    this.insert = function(text) {
+        var session = this.session;
+        var mode = session.getMode();
+
+        var cursor = this.getCursorPosition();
+
+        if (this.getBehavioursEnabled()) {
+            // Get a transform if the current mode wants one.
+            var transform = mode.transformAction(session.getState(cursor.row), 'insertion', this, session, text);
+            if (transform)
+                text = transform.text;
+        }
+
+        text = text.replace("\t", this.session.getTabString());
+
+        // remove selected text
+        if (!this.selection.isEmpty()) {
+            cursor = this.session.remove(this.getSelectionRange());
+            this.clearSelection();
+        }
+        else if (this.session.getOverwrite()) {
+            var range = new Range.fromPoints(cursor, cursor);
+            range.end.column += text.length;
+            this.session.remove(range);
+        }
+
+        this.clearSelection();
+
+        var start = cursor.column;
+        var lineState = session.getState(cursor.row);
+        var shouldOutdent = mode.checkOutdent(lineState, session.getLine(cursor.row), text);
+        var line = session.getLine(cursor.row);
+        var lineIndent = mode.getNextLineIndent(lineState, line.slice(0, cursor.column), session.getTabString());
+        var end = session.insert(cursor, text);
+
+        if (transform && transform.selection) {
+            if (transform.selection.length == 2) { // Transform relative to the current column
+                this.selection.setSelectionRange(
+                    new Range(cursor.row, start + transform.selection[0],
+                              cursor.row, start + transform.selection[1]));
+            } else { // Transform relative to the current row.
+                this.selection.setSelectionRange(
+                    new Range(cursor.row + transform.selection[0],
+                              transform.selection[1],
+                              cursor.row + transform.selection[2],
+                              transform.selection[3]));
+            }
+        }
+
+        var lineState = session.getState(cursor.row);
+
+        // TODO disabled multiline auto indent
+        // possibly doing the indent before inserting the text
+        // if (cursor.row !== end.row) {
+        if (session.getDocument().isNewLine(text)) {
+            this.moveCursorTo(cursor.row+1, 0);
+
+            var size = session.getTabSize();
+            var minIndent = Number.MAX_VALUE;
+
+            for (var row = cursor.row + 1; row <= end.row; ++row) {
+                var indent = 0;
+
+                line = session.getLine(row);
+                for (var i = 0; i < line.length; ++i)
+                    if (line.charAt(i) == '\t')
+                        indent += size;
+                    else if (line.charAt(i) == ' ')
+                        indent += 1;
+                    else
+                        break;
+                if (/[^\s]/.test(line))
+                    minIndent = Math.min(indent, minIndent);
+            }
+
+            for (var row = cursor.row + 1; row <= end.row; ++row) {
+                var outdent = minIndent;
+
+                line = session.getLine(row);
+                for (var i = 0; i < line.length && outdent > 0; ++i)
+                    if (line.charAt(i) == '\t')
+                        outdent -= size;
+                    else if (line.charAt(i) == ' ')
+                        outdent -= 1;
+                session.remove(new Range(row, 0, row, i));
+            }
+            session.indentRows(cursor.row + 1, end.row, lineIndent);
+        }
+        if (shouldOutdent)
+            mode.autoOutdent(lineState, session, cursor.row);
+    };
+
+    this.onTextInput = function(text, pasted) {
+        if (pasted)
+            this._emit("paste", text);
+
+        this.keyBinding.onTextInput(text, pasted);
+    };
+
+    this.onCommandKey = function(e, hashId, keyCode) {
+        this.keyBinding.onCommandKey(e, hashId, keyCode);
+    };
+
+    this.setOverwrite = function(overwrite) {
+        this.session.setOverwrite(overwrite);
+    };
+
+    this.getOverwrite = function() {
+        return this.session.getOverwrite();
+    };
+
+    this.toggleOverwrite = function() {
+        this.session.toggleOverwrite();
+    };
+
+    this.setScrollSpeed = function(speed) {
+        this.$mouseHandler.setScrollSpeed(speed);
+    };
+
+    this.getScrollSpeed = function() {
+        return this.$mouseHandler.getScrollSpeed();
+    };
+
+    this.$selectionStyle = "line";
+    this.setSelectionStyle = function(style) {
+        if (this.$selectionStyle == style) return;
+
+        this.$selectionStyle = style;
+        this.onSelectionChange();
+        this._dispatchEvent("changeSelectionStyle", {data: style});
+    };
+
+    this.getSelectionStyle = function() {
+        return this.$selectionStyle;
+    };
+
+    this.$highlightActiveLine = true;
+    this.setHighlightActiveLine = function(shouldHighlight) {
+        if (this.$highlightActiveLine == shouldHighlight) return;
+
+        this.$highlightActiveLine = shouldHighlight;
+        this.$updateHighlightActiveLine();
+    };
+
+    this.getHighlightActiveLine = function() {
+        return this.$highlightActiveLine;
+    };
+
+    this.$highlightSelectedWord = true;
+    this.setHighlightSelectedWord = function(shouldHighlight) {
+        if (this.$highlightSelectedWord == shouldHighlight)
+            return;
+
+        this.$highlightSelectedWord = shouldHighlight;
+        if (shouldHighlight)
+            this.session.getMode().highlightSelection(this);
+        else
+            this.session.getMode().clearSelectionHighlight(this);
+    };
+
+    this.getHighlightSelectedWord = function() {
+        return this.$highlightSelectedWord;
+    };
+
+    this.setShowInvisibles = function(showInvisibles) {
+        if (this.getShowInvisibles() == showInvisibles)
+            return;
+
+        this.renderer.setShowInvisibles(showInvisibles);
+    };
+
+    this.getShowInvisibles = function() {
+        return this.renderer.getShowInvisibles();
+    };
+
+    this.setShowPrintMargin = function(showPrintMargin) {
+        this.renderer.setShowPrintMargin(showPrintMargin);
+    };
+
+    this.getShowPrintMargin = function() {
+        return this.renderer.getShowPrintMargin();
+    };
+
+    this.setPrintMarginColumn = function(showPrintMargin) {
+        this.renderer.setPrintMarginColumn(showPrintMargin);
+    };
+
+    this.getPrintMarginColumn = function() {
+        return this.renderer.getPrintMarginColumn();
+    };
+
+    this.$readOnly = false;
+    this.setReadOnly = function(readOnly) {
+        this.$readOnly = readOnly;
+    };
+
+    this.getReadOnly = function() {
+        return this.$readOnly;
+    };
+
+    this.$modeBehaviours = true;
+    this.setBehavioursEnabled = function (enabled) {
+        this.$modeBehaviours = enabled;
+    };
+
+    this.getBehavioursEnabled = function () {
+        return this.$modeBehaviours;
+    };
+
+    this.setShowFoldWidgets = function(show) {
+        var gutter = this.renderer.$gutterLayer;
+        if (gutter.getShowFoldWidgets() == show)
+            return;
+
+        this.renderer.$gutterLayer.setShowFoldWidgets(show);
+        this.$showFoldWidgets = show;
+        this.renderer.updateFull();
+    };
+    this.getShowFoldWidgets = function() {
+        return this.renderer.$gutterLayer.getShowFoldWidgets();
+    };
+
+    this.remove = function(dir) {
+        if (this.selection.isEmpty()){
+            if(dir == "left")
+                this.selection.selectLeft();
+            else
+                this.selection.selectRight();
+        }
+
+        var range = this.getSelectionRange();
+        if (this.getBehavioursEnabled()) {
+            var session = this.session;
+            var state = session.getState(range.start.row);
+            var new_range = session.getMode().transformAction(state, 'deletion', this, session, range);
+            if (new_range)
+                range = new_range;
+        }
+
+        this.session.remove(range);
+        this.clearSelection();
+    };
+
+    this.removeWordRight = function() {
+        if (this.selection.isEmpty())
+            this.selection.selectWordRight();
+
+        this.session.remove(this.getSelectionRange());
+        this.clearSelection();
+    };
+
+    this.removeWordLeft = function() {
+        if (this.selection.isEmpty())
+            this.selection.selectWordLeft();
+
+        this.session.remove(this.getSelectionRange());
+        this.clearSelection();
+    };
+
+    this.removeToLineStart = function() {
+        if (this.selection.isEmpty())
+            this.selection.selectLineStart();
+
+        this.session.remove(this.getSelectionRange());
+        this.clearSelection();
+    };
+
+    this.removeToLineEnd = function() {
+        if (this.selection.isEmpty())
+            this.selection.selectLineEnd();
+
+        var range = this.getSelectionRange();
+        if (range.start.column == range.end.column && range.start.row == range.end.row) {
+            range.end.column = 0;
+            range.end.row++;
+        }
+
+        this.session.remove(range);
+        this.clearSelection();
+    };
+
+    this.splitLine = function() {
+        if (!this.selection.isEmpty()) {
+            this.session.remove(this.getSelectionRange());
+            this.clearSelection();
+        }
+
+        var cursor = this.getCursorPosition();
+        this.insert("\n");
+        this.moveCursorToPosition(cursor);
+    };
+
+    this.transposeLetters = function() {
+        if (!this.selection.isEmpty()) {
+            return;
+        }
+
+        var cursor = this.getCursorPosition();
+        var column = cursor.column;
+        if (column === 0)
+            return;
+
+        var line = this.session.getLine(cursor.row);
+        var swap, range;
+        if (column < line.length) {
+            swap = line.charAt(column) + line.charAt(column-1);
+            range = new Range(cursor.row, column-1, cursor.row, column+1);
+        }
+        else {
+            swap = line.charAt(column-1) + line.charAt(column-2);
+            range = new Range(cursor.row, column-2, cursor.row, column);
+        }
+        this.session.replace(range, swap);
+    };
+
+    this.toLowerCase = function() {
+        var originalRange = this.getSelectionRange();
+        if (this.selection.isEmpty()) {
+            this.selection.selectWord();
+        }
+
+        var range = this.getSelectionRange();
+        var text = this.session.getTextRange(range);
+        this.session.replace(range, text.toLowerCase());
+        this.selection.setSelectionRange(originalRange);
+    };
+
+    this.toUpperCase = function() {
+        var originalRange = this.getSelectionRange();
+        if (this.selection.isEmpty()) {
+            this.selection.selectWord();
+        }
+
+        var range = this.getSelectionRange();
+        var text = this.session.getTextRange(range);
+        this.session.replace(range, text.toUpperCase());
+        this.selection.setSelectionRange(originalRange);
+    };
+
+    this.indent = function() {
+        var session = this.session;
+        var range = this.getSelectionRange();
+
+        if (range.start.row < range.end.row || range.start.column < range.end.column) {
+            var rows = this.$getSelectedRows();
+            session.indentRows(rows.first, rows.last, "\t");
+        } else {
+            var indentString;
+
+            if (this.session.getUseSoftTabs()) {
+                var size        = session.getTabSize(),
+                    position    = this.getCursorPosition(),
+                    column      = session.documentToScreenColumn(position.row, position.column),
+                    count       = (size - column % size);
+
+                indentString = lang.stringRepeat(" ", count);
+            } else
+                indentString = "\t";
+            return this.insert(indentString);
+        }
+    };
+
+    this.blockOutdent = function() {
+        var selection = this.session.getSelection();
+        this.session.outdentRows(selection.getRange());
+    };
+
+    this.toggleCommentLines = function() {
+        var state = this.session.getState(this.getCursorPosition().row);
+        var rows = this.$getSelectedRows();
+        this.session.getMode().toggleCommentLines(state, this.session, rows.first, rows.last);
+    };
+
+    this.removeLines = function() {
+        var rows = this.$getSelectedRows();
+        var range;
+        if (rows.first === 0 || rows.last+1 < this.session.getLength())
+            range = new Range(rows.first, 0, rows.last+1, 0);
+        else
+            range = new Range(
+                rows.first-1, this.session.getLine(rows.first-1).length,
+                rows.last, this.session.getLine(rows.last).length
+            );
+        this.session.remove(range);
+        this.clearSelection();
+    };
+
+    this.moveLinesDown = function() {
+        this.$moveLines(function(firstRow, lastRow) {
+            return this.session.moveLinesDown(firstRow, lastRow);
+        });
+    };
+
+    this.moveLinesUp = function() {
+        this.$moveLines(function(firstRow, lastRow) {
+            return this.session.moveLinesUp(firstRow, lastRow);
+        });
+    };
+
+    this.moveText = function(range, toPosition) {
+        if (this.$readOnly)
+            return null;
+
+        return this.session.moveText(range, toPosition);
+    };
+
+    this.copyLinesUp = function() {
+        this.$moveLines(function(firstRow, lastRow) {
+            this.session.duplicateLines(firstRow, lastRow);
+            return 0;
+        });
+    };
+
+    this.copyLinesDown = function() {
+        this.$moveLines(function(firstRow, lastRow) {
+            return this.session.duplicateLines(firstRow, lastRow);
+        });
+    };
+
+
+    this.$moveLines = function(mover) {
+        var rows = this.$getSelectedRows();
+        var selection = this.selection;
+        if (!selection.isMultiLine()) {
+            var range = selection.getRange();
+            var reverse = selection.isBackwards();
+        }
+
+        var linesMoved = mover.call(this, rows.first, rows.last);
+
+        if (range) {
+            range.start.row += linesMoved;
+            range.end.row += linesMoved;
+            selection.setSelectionRange(range, reverse);
+        } 
+        else {
+            selection.setSelectionAnchor(rows.last+linesMoved+1, 0);
+            selection.$moveSelection(function() {
+                selection.moveCursorTo(rows.first+linesMoved, 0);
+            });
+        }
+    };
+
+    this.$getSelectedRows = function() {
+        var range = this.getSelectionRange().collapseRows();
+
+        return {
+            first: range.start.row,
+            last: range.end.row
+        };
+    };
+
+    this.onCompositionStart = function(text) {
+        this.renderer.showComposition(this.getCursorPosition());
+    };
+
+    this.onCompositionUpdate = function(text) {
+        this.renderer.setCompositionText(text);
+    };
+
+    this.onCompositionEnd = function() {
+        this.renderer.hideComposition();
+    };
+
+    this.getFirstVisibleRow = function() {
+        return this.renderer.getFirstVisibleRow();
+    };
+
+    this.getLastVisibleRow = function() {
+        return this.renderer.getLastVisibleRow();
+    };
+
+    this.isRowVisible = function(row) {
+        return (row >= this.getFirstVisibleRow() && row <= this.getLastVisibleRow());
+    };
+
+    this.isRowFullyVisible = function(row) {
+        return (row >= this.renderer.getFirstFullyVisibleRow() && row <= this.renderer.getLastFullyVisibleRow());
+    };
+
+    this.$getVisibleRowCount = function() {
+        return this.renderer.getScrollBottomRow() - this.renderer.getScrollTopRow() + 1;
+    };
+
+    this.$getPageDownRow = function() {
+        return this.renderer.getScrollBottomRow();
+    };
+
+    this.$getPageUpRow = function() {
+        var firstRow = this.renderer.getScrollTopRow();
+        var lastRow = this.renderer.getScrollBottomRow();
+
+        return firstRow - (lastRow - firstRow);
+    };
+
+    this.selectPageDown = function() {
+        var row = this.$getPageDownRow() + Math.floor(this.$getVisibleRowCount() / 2);
+
+        this.scrollPageDown();
+
+        var selection = this.getSelection();
+        var leadScreenPos = this.session.documentToScreenPosition(selection.getSelectionLead());
+        var dest = this.session.screenToDocumentPosition(row, leadScreenPos.column);
+        selection.selectTo(dest.row, dest.column);
+    };
+
+    this.selectPageUp = function() {
+        var visibleRows = this.renderer.getScrollTopRow() - this.renderer.getScrollBottomRow();
+        var row = this.$getPageUpRow() + Math.round(visibleRows / 2);
+
+        this.scrollPageUp();
+
+        var selection = this.getSelection();
+        var leadScreenPos = this.session.documentToScreenPosition(selection.getSelectionLead());
+        var dest = this.session.screenToDocumentPosition(row, leadScreenPos.column);
+        selection.selectTo(dest.row, dest.column);
+    };
+
+    this.gotoPageDown = function() {
+        var row = this.$getPageDownRow();
+        var column = this.getCursorPositionScreen().column;
+
+        this.scrollToRow(row);
+        this.getSelection().moveCursorToScreen(row, column);
+    };
+
+    this.gotoPageUp = function() {
+        var row = this.$getPageUpRow();
+        var column = this.getCursorPositionScreen().column;
+
+       this.scrollToRow(row);
+       this.getSelection().moveCursorToScreen(row, column);
+    };
+
+    this.scrollPageDown = function() {
+        this.scrollToRow(this.$getPageDownRow());
+    };
+
+    this.scrollPageUp = function() {
+        this.renderer.scrollToRow(this.$getPageUpRow());
+    };
+
+    this.scrollToRow = function(row) {
+        this.renderer.scrollToRow(row);
+    };
+
+    this.scrollToLine = function(line, center) {
+        this.renderer.scrollToLine(line, center);
+    };
+
+    this.centerSelection = function() {
+        var range = this.getSelectionRange();
+        var line = Math.floor(range.start.row + (range.end.row - range.start.row) / 2);
+        this.renderer.scrollToLine(line, true);
+    };
+
+    this.getCursorPosition = function() {
+        return this.selection.getCursor();
+    };
+
+    this.getCursorPositionScreen = function() {
+        return this.session.documentToScreenPosition(this.getCursorPosition());
+    };
+
+    this.getSelectionRange = function() {
+        return this.selection.getRange();
+    };
+
+
+    this.selectAll = function() {
+        this.$blockScrolling += 1;
+        this.selection.selectAll();
+        this.$blockScrolling -= 1;
+    };
+
+    this.clearSelection = function() {
+        this.selection.clearSelection();
+    };
+
+    this.moveCursorTo = function(row, column) {
+        this.selection.moveCursorTo(row, column);
+    };
+
+    this.moveCursorToPosition = function(pos) {
+        this.selection.moveCursorToPosition(pos);
+    };
+
+
+    this.gotoLine = function(lineNumber, column) {
+        this.selection.clearSelection();
+        this.session.unfold({row: lineNumber - 1, column: column || 0});
+
+        this.$blockScrolling += 1;
+        this.moveCursorTo(lineNumber-1, column || 0);
+        this.$blockScrolling -= 1;
+        if (!this.isRowFullyVisible(this.getCursorPosition().row))
+            this.scrollToLine(lineNumber, true);
+    };
+
+    this.navigateTo = function(row, column) {
+        this.clearSelection();
+        this.moveCursorTo(row, column);
+    };
+
+    this.navigateUp = function(times) {
+        this.selection.clearSelection();
+        times = times || 1;
+        this.selection.moveCursorBy(-times, 0);
+    };
+
+    this.navigateDown = function(times) {
+        this.selection.clearSelection();
+        times = times || 1;
+        this.selection.moveCursorBy(times, 0);
+    };
+
+    this.navigateLeft = function(times) {
+        if (!this.selection.isEmpty()) {
+            var selectionStart = this.getSelectionRange().start;
+            this.moveCursorToPosition(selectionStart);
+        }
+        else {
+            times = times || 1;
+            while (times--) {
+                this.selection.moveCursorLeft();
+            }
+        }
+        this.clearSelection();
+    };
+
+    this.navigateRight = function(times) {
+        if (!this.selection.isEmpty()) {
+            var selectionEnd = this.getSelectionRange().end;
+            this.moveCursorToPosition(selectionEnd);
+        }
+        else {
+            times = times || 1;
+            while (times--) {
+                this.selection.moveCursorRight();
+            }
+        }
+        this.clearSelection();
+    };
+
+    this.navigateLineStart = function() {
+        this.selection.moveCursorLineStart();
+        this.clearSelection();
+    };
+
+    this.navigateLineEnd = function() {
+        this.selection.moveCursorLineEnd();
+        this.clearSelection();
+    };
+
+    this.navigateFileEnd = function() {
+        this.selection.moveCursorFileEnd();
+        this.clearSelection();
+    };
+
+    this.navigateFileStart = function() {
+        this.selection.moveCursorFileStart();
+        this.clearSelection();
+    };
+
+    this.navigateWordRight = function() {
+        this.selection.moveCursorWordRight();
+        this.clearSelection();
+    };
+
+    this.navigateWordLeft = function() {
+        this.selection.moveCursorWordLeft();
+        this.clearSelection();
+    };
+
+    this.replace = function(replacement, options) {
+        if (options)
+            this.$search.set(options);
+
+        var range = this.$search.find(this.session);
+        if (!range)
+            return;
+
+        this.$tryReplace(range, replacement);
+        if (range !== null)
+            this.selection.setSelectionRange(range);
+    };
+
+    this.replaceAll = function(replacement, options) {
+        if (options) {
+            this.$search.set(options);
+        }
+
+        var ranges = this.$search.findAll(this.session);
+        if (!ranges.length)
+            return;
+
+        var selection = this.getSelectionRange();
+        this.clearSelection();
+        this.selection.moveCursorTo(0, 0);
+
+        this.$blockScrolling += 1;
+        for (var i = ranges.length - 1; i >= 0; --i)
+            this.$tryReplace(ranges[i], replacement);
+
+        this.selection.setSelectionRange(selection);
+        this.$blockScrolling -= 1;
+    };
+
+    this.$tryReplace = function(range, replacement) {
+        var input = this.session.getTextRange(range);
+        replacement = this.$search.replace(input, replacement);
+        if (replacement !== null) {
+            range.end = this.session.replace(range, replacement);
+            return range;
+        } else {
+            return null;
+        }
+    };
+
+    this.getLastSearchOptions = function() {
+        return this.$search.getOptions();
+    };
+
+    this.find = function(needle, options) {
+        this.clearSelection();
+        options = options || {};
+        options.needle = needle;
+        this.$search.set(options);
+        this.$find();
+    };
+
+    this.findNext = function(options) {
+        options = options || {};
+        if (typeof options.backwards == "undefined")
+            options.backwards = false;
+        this.$search.set(options);
+        this.$find();
+    };
+
+    this.findPrevious = function(options) {
+        options = options || {};
+        if (typeof options.backwards == "undefined")
+            options.backwards = true;
+        this.$search.set(options);
+        this.$find();
+    };
+
+    this.$find = function(backwards) {
+        if (!this.selection.isEmpty())
+            this.$search.set({needle: this.session.getTextRange(this.getSelectionRange())});
+
+        if (typeof backwards != "undefined")
+            this.$search.set({backwards: backwards});
+
+        var range = this.$search.find(this.session);
+        if (range) {
+            this.session.unfold(range);
+            this.gotoLine(range.end.row+1, range.end.column);
+            this.selection.setSelectionRange(range);
+        }
+    };
+
+    this.undo = function() {
+        this.session.getUndoManager().undo();
+    };
+
+    this.redo = function() {
+        this.session.getUndoManager().redo();
+    };
+
+    this.destroy = function() {
+        this.renderer.destroy();
+    };
+
+}).call(Editor.prototype);
+
+
+exports.Editor = Editor;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/lang', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+exports.stringReverse = function(string) {
+    return string.split("").reverse().join("");
+};
+
+exports.stringRepeat = function (string, count) {
+     return new Array(count + 1).join(string);
+};
+
+var trimBeginRegexp = /^\s\s*/;
+var trimEndRegexp = /\s\s*$/;
+
+exports.stringTrimLeft = function (string) {
+    return string.replace(trimBeginRegexp, '');
+};
+
+exports.stringTrimRight = function (string) {
+    return string.replace(trimEndRegexp, '');
+};
+
+exports.copyObject = function(obj) {
+    var copy = {};
+    for (var key in obj) {
+        copy[key] = obj[key];
+    }
+    return copy;
+};
+
+exports.copyArray = function(array){
+    var copy = [];
+    for (var i=0, l=array.length; i<l; i++) {
+        if (array[i] && typeof array[i] == "object")
+            copy[i] = this.copyObject( array[i] );
+        else 
+            copy[i] = array[i];
+    }
+    return copy;
+};
+
+exports.deepCopy = function (obj) {
+    if (typeof obj != "object") {
+        return obj;
+    }
+    
+    var copy = obj.constructor();
+    for (var key in obj) {
+        if (typeof obj[key] == "object") {
+            copy[key] = this.deepCopy(obj[key]);
+        } else {
+            copy[key] = obj[key];
+        }
+    }
+    return copy;
+};
+
+exports.arrayToMap = function(arr) {
+    var map = {};
+    for (var i=0; i<arr.length; i++) {
+        map[arr[i]] = 1;
+    }
+    return map;
+
+};
+
+/**
+ * splice out of 'array' anything that === 'value'
+ */
+exports.arrayRemove = function(array, value) {
+  for (var i = 0; i <= array.length; i++) {
+    if (value === array[i]) {
+      array.splice(i, 1);
+    }
+  }
+};
+
+exports.escapeRegExp = function(str) {
+    return str.replace(/([.*+?^${}()|[\]\/\\])/g, '\\$1');
+};
+
+exports.deferredCall = function(fcn) {
+
+    var timer = null;
+    var callback = function() {
+        timer = null;
+        fcn();
+    };
+
+    var deferred = function(timeout) {
+        deferred.cancel();
+        timer = setTimeout(callback, timeout || 0);
+        return deferred;
+    };
+
+    deferred.schedule = deferred;
+
+    deferred.call = function() {
+        this.cancel();
+        fcn();
+        return deferred;
+    };
+
+    deferred.cancel = function() {
+        clearTimeout(timer);
+        timer = null;
+        return deferred;
+    };
+
+    return deferred;
+};
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai DOT sucan AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/keyboard/textinput', ['require', 'exports', 'module' , 'ace/lib/event', 'ace/lib/useragent', 'ace/lib/dom'], function(require, exports, module) {
+
+var event = require("../lib/event");
+var useragent = require("../lib/useragent");
+var dom = require("../lib/dom");
+
+var TextInput = function(parentNode, host) {
+
+    var text = dom.createElement("textarea");
+    if (useragent.isTouchPad)
+        text.setAttribute("x-palm-disable-auto-cap", true);
+        
+    text.style.left = "-10000px";
+    parentNode.appendChild(text);
+
+    var PLACEHOLDER = String.fromCharCode(0);
+    sendText();
+
+    var inCompostion = false;
+    var copied = false;
+    var pasted = false;
+    var tempStyle = '';
+
+    function select() {
+        try {
+            text.select();
+        } catch (e) {}
+    }
+
+    function sendText(valueToSend) {
+        if (!copied) {
+            var value = valueToSend || text.value;
+            if (value) {
+                if (value.charCodeAt(value.length-1) == PLACEHOLDER.charCodeAt(0)) {
+                    value = value.slice(0, -1);
+                    if (value)
+                        host.onTextInput(value, pasted);
+                }
+                else {
+                    host.onTextInput(value, pasted);
+                }
+
+                // If editor is no longer focused we quit immediately, since
+                // it means that something else is in charge now.
+                if (!isFocused())
+                    return false;
+            }
+        }
+
+        copied = false;
+        pasted = false;
+
+        // Safari doesn't fire copy events if no text is selected
+        text.value = PLACEHOLDER;
+        select();
+    }
+
+    var onTextInput = function(e) {
+        setTimeout(function () {
+            if (!inCompostion)
+                sendText(e.data);                
+        }, 0);
+    };
+    
+    var onPropertyChange = function(e) {
+        if (useragent.isOldIE && text.value.charCodeAt(0) > 128) return;
+        setTimeout(function() {
+            if (!inCompostion)
+                sendText();
+        }, 0);
+    };
+
+    var onCompositionStart = function(e) {
+        inCompostion = true;
+        host.onCompositionStart();
+        if (!useragent.isGecko) setTimeout(onCompositionUpdate, 0);
+    };
+
+    var onCompositionUpdate = function() {
+        if (!inCompostion) return;
+        host.onCompositionUpdate(text.value);
+    };
+
+    var onCompositionEnd = function(e) {
+        inCompostion = false;
+        host.onCompositionEnd();
+    };
+
+    var onCopy = function(e) {
+        copied = true;
+        var copyText = host.getCopyText();
+        if(copyText)
+            text.value = copyText;
+        else
+            e.preventDefault();
+        select();
+        setTimeout(function () {
+            sendText();
+        }, 0);
+    };
+    
+    var onCut = function(e) {
+        copied = true;
+        var copyText = host.getCopyText();
+        if(copyText) {
+            text.value = copyText;
+            host.onCut();
+        } else
+            e.preventDefault();
+        select();
+        setTimeout(function () {
+            sendText();
+        }, 0);
+    };
+
+    event.addCommandKeyListener(text, host.onCommandKey.bind(host));
+    if (useragent.isOldIE) {
+        var keytable = { 13:1, 27:1 };
+        event.addListener(text, "keyup", function (e) {
+            if (inCompostion && (!text.value || keytable[e.keyCode]))
+                setTimeout(onCompositionEnd, 0);
+            if ((text.value.charCodeAt(0)|0) < 129) {
+                return;
+            }
+            inCompostion ? onCompositionUpdate() : onCompositionStart();
+        });
+    }
+    
+    if ("onpropertychange" in text && !("oninput" in text))
+        event.addListener(text, "propertychange", onPropertyChange);
+    else
+        event.addListener(text, "input", onTextInput);
+    
+    event.addListener(text, "paste", function(e) {
+        // Mark that the next input text comes from past.
+        pasted = true;
+        // Some browsers support the event.clipboardData API. Use this to get
+        // the pasted content which increases speed if pasting a lot of lines.
+        if (e.clipboardData && e.clipboardData.getData) {
+            sendText(e.clipboardData.getData("text/plain"));
+            e.preventDefault();
+        } 
+        else {
+            // If a browser doesn't support any of the things above, use the regular
+            // method to detect the pasted input.
+            onPropertyChange();
+        }
+    });
+
+    if ("onbeforecopy" in text && typeof clipboardData !== "undefined") {
+        event.addListener(text, "beforecopy", function(e) {
+            var copyText = host.getCopyText();
+            if(copyText)
+                clipboardData.setData("Text", copyText);
+            else
+                e.preventDefault();
+        });
+        event.addListener(parentNode, "keydown", function(e) {
+            if (e.ctrlKey && e.keyCode == 88) {
+                var copyText = host.getCopyText();
+                if (copyText) {
+                    clipboardData.setData("Text", copyText);
+                    host.onCut();
+                }
+                event.preventDefault(e);
+            }
+        });
+    }
+    else {
+        event.addListener(text, "copy", onCopy);
+        event.addListener(text, "cut", onCut);
+    }
+
+    event.addListener(text, "compositionstart", onCompositionStart);
+    if (useragent.isGecko) {
+        event.addListener(text, "text", onCompositionUpdate);
+    }
+    if (useragent.isWebKit) {
+        event.addListener(text, "keyup", onCompositionUpdate);
+    }
+    event.addListener(text, "compositionend", onCompositionEnd);
+
+    event.addListener(text, "blur", function() {
+        host.onBlur();
+    });
+
+    event.addListener(text, "focus", function() {
+        host.onFocus();
+        select();
+    });
+
+    this.focus = function() {
+        host.onFocus();
+        select();
+        text.focus();
+    };
+
+    this.blur = function() {
+        text.blur();
+    };
+
+    function isFocused() {
+        return document.activeElement === text;
+    }
+    this.isFocused = isFocused;
+
+    this.getElement = function() {
+        return text;
+    };
+
+    this.onContextMenu = function(mousePos, isEmpty){
+        if (mousePos) {
+            if (!tempStyle)
+                tempStyle = text.style.cssText;
+                
+            text.style.cssText = 
+                'position:fixed; z-index:1000;' +
+                'left:' + (mousePos.x - 2) + 'px; top:' + (mousePos.y - 2) + 'px;';
+
+        }
+        if (isEmpty)
+            text.value='';
+    };
+
+    this.onContextMenuClose = function(){
+        setTimeout(function () {
+            if (tempStyle) {
+                text.style.cssText = tempStyle;
+                tempStyle = '';
+            }
+            sendText();
+        }, 0);
+    };
+};
+
+exports.TextInput = TextInput;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai DOT sucan AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mouse/mouse_handler', ['require', 'exports', 'module' , 'ace/lib/event', 'ace/mouse/default_handlers', 'ace/mouse/default_gutter_handler', 'ace/mouse/mouse_event'], function(require, exports, module) {
+
+var event = require("../lib/event");
+var DefaultHandlers = require("./default_handlers").DefaultHandlers;
+var DefaultGutterHandler = require("./default_gutter_handler").GutterHandler;
+var MouseEvent = require("./mouse_event").MouseEvent;
+
+var MouseHandler = function(editor) {
+    this.editor = editor;
+    
+    new DefaultHandlers(editor);
+    new DefaultGutterHandler(editor);
+    
+    event.addListener(editor.container, "mousedown", function(e) {
+        editor.focus();
+        return event.preventDefault(e);
+    });
+    event.addListener(editor.container, "selectstart", function(e) {
+        return event.preventDefault(e);
+    });
+
+    var mouseTarget = editor.renderer.getMouseEventTarget();
+    event.addListener(mouseTarget, "mousedown", this.onMouseEvent.bind(this, "mousedown"));
+    event.addListener(mouseTarget, "click", this.onMouseEvent.bind(this, "click"));
+    event.addListener(mouseTarget, "mousemove", this.onMouseMove.bind(this, "mousemove"));
+    event.addMultiMouseDownListener(mouseTarget, 0, 2, 500, this.onMouseEvent.bind(this, "dblclick"));
+    event.addMultiMouseDownListener(mouseTarget, 0, 3, 600, this.onMouseEvent.bind(this, "tripleclick"));
+    event.addMultiMouseDownListener(mouseTarget, 0, 4, 600, this.onMouseEvent.bind(this, "quadclick"));
+    event.addMouseWheelListener(editor.container, this.onMouseWheel.bind(this, "mousewheel"));
+    
+    var gutterEl = editor.renderer.$gutter;
+    event.addListener(gutterEl, "mousedown", this.onMouseEvent.bind(this, "guttermousedown"));
+    event.addListener(gutterEl, "click", this.onMouseEvent.bind(this, "gutterclick"));
+    event.addListener(gutterEl, "dblclick", this.onMouseEvent.bind(this, "gutterdblclick"));
+    event.addListener(gutterEl, "mousemove", this.onMouseMove.bind(this, "gutter"));
+};
+
+(function() {
+
+    this.$scrollSpeed = 1;
+    this.setScrollSpeed = function(speed) {
+        this.$scrollSpeed = speed;
+    };
+
+    this.getScrollSpeed = function() {
+        return this.$scrollSpeed;
+    };
+
+    this.onMouseEvent = function(name, e) {
+        this.editor._dispatchEvent(name, new MouseEvent(e, this.editor));
+    };
+
+    this.onMouseMove = function(name, e) {
+        // optimization, because mousemove doesn't have a default handler.
+        var listeners = this.editor._eventRegistry && this.editor._eventRegistry.mousemove;
+        if (!listeners || !listeners.length)
+            return;
+
+        this.editor._dispatchEvent(name, new MouseEvent(e, this.editor));
+    };
+
+    this.onMouseWheel = function(name, e) {
+        var mouseEvent = new MouseEvent(e, this.editor);
+        mouseEvent.speed = this.$scrollSpeed * 2;
+        mouseEvent.wheelX = e.wheelX;
+        mouseEvent.wheelY = e.wheelY;
+        
+        this.editor._dispatchEvent(name, mouseEvent);
+    };
+
+}).call(MouseHandler.prototype);
+
+exports.MouseHandler = MouseHandler;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mike de Boer <mike AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mouse/default_handlers', ['require', 'exports', 'module' , 'ace/lib/event', 'ace/lib/dom', 'ace/lib/browser_focus'], function(require, exports, module) {
+
+var event = require("../lib/event");
+var dom = require("../lib/dom");
+var BrowserFocus = require("../lib/browser_focus").BrowserFocus;
+
+var STATE_UNKNOWN = 0;
+var STATE_SELECT = 1;
+var STATE_DRAG = 2;
+
+var DRAG_TIMER = 250; // milliseconds
+var DRAG_OFFSET = 5; // pixels
+
+function DefaultHandlers(editor) {
+    this.editor = editor;
+    this.$clickSelection = null;
+    this.browserFocus = new BrowserFocus();
+
+    editor.setDefaultHandler("mousedown", this.onMouseDown.bind(this));
+    editor.setDefaultHandler("dblclick", this.onDoubleClick.bind(this));
+    editor.setDefaultHandler("tripleclick", this.onTripleClick.bind(this));
+    editor.setDefaultHandler("quadclick", this.onQuadClick.bind(this));
+    editor.setDefaultHandler("mousewheel", this.onScroll.bind(this));
+}
+
+(function() {
+    
+    this.onMouseDown = function(ev) {
+        var inSelection = ev.inSelection();
+        var pageX = ev.pageX;
+        var pageY = ev.pageY;
+        var pos = ev.getDocumentPosition();
+        var editor = this.editor;
+        var _self = this;
+        
+        var selectionRange = editor.getSelectionRange();
+        var selectionEmpty = selectionRange.isEmpty();
+        var state = STATE_UNKNOWN;
+        
+        // if this click caused the editor to be focused should not clear the
+        // selection
+        if (
+            inSelection && (
+                !this.browserFocus.isFocused()
+                || new Date().getTime() - this.browserFocus.lastFocus < 20
+                || !editor.isFocused()
+            )
+        ) {
+            editor.focus();
+            return;
+        }
+
+        var button = ev.getButton();
+        if (button !== 0) {
+            if (selectionEmpty) {
+                editor.moveCursorToPosition(pos);
+            }
+            if (button == 2) {
+                editor.textInput.onContextMenu({x: ev.clientX, y: ev.clientY}, selectionEmpty);
+                event.capture(editor.container, function(){}, editor.textInput.onContextMenuClose);
+            }
+            return;
+        }
+
+        if (!inSelection) {
+            // Directly pick STATE_SELECT, since the user is not clicking inside
+            // a selection.
+            onStartSelect(pos);
+        }
+
+        var mousePageX = pageX, mousePageY = pageY;
+        var mousedownTime = (new Date()).getTime();
+        var dragCursor, dragRange;
+
+        var onMouseSelection = function(e) {
+            mousePageX = event.getDocumentX(e);
+            mousePageY = event.getDocumentY(e);
+        };
+
+        var onMouseSelectionEnd = function(e) {
+            clearInterval(timerId);
+            if (state == STATE_UNKNOWN)
+                onStartSelect(pos);
+            else if (state == STATE_DRAG)
+                onMouseDragSelectionEnd(e);
+
+            _self.$clickSelection = null;
+            state = STATE_UNKNOWN;
+        };
+
+        var onMouseDragSelectionEnd = function(e) {
+            dom.removeCssClass(editor.container, "ace_dragging");
+            editor.session.removeMarker(dragSelectionMarker);
+
+            if (!editor.$mouseHandler.$clickSelection) {
+                if (!dragCursor) {
+                    editor.moveCursorToPosition(pos);
+                    editor.selection.clearSelection(pos.row, pos.column);
+                }
+            }
+
+            if (!dragCursor)
+                return;
+
+            if (dragRange.contains(dragCursor.row, dragCursor.column)) {
+                dragCursor = null;
+                return;
+            }
+
+            editor.clearSelection();
+            if (e && (e.ctrlKey || e.altKey)) {
+                var session = editor.session;
+                var newRange = session.insert(dragCursor, session.getTextRange(dragRange));
+            } else {
+                var newRange = editor.moveText(dragRange, dragCursor);
+            }
+            if (!newRange) {
+                dragCursor = null;
+                return;
+            }
+
+            editor.selection.setSelectionRange(newRange);
+        };
+
+        var onSelectionInterval = function() {
+            if (state == STATE_UNKNOWN) {
+                var distance = calcDistance(pageX, pageY, mousePageX, mousePageY);
+                var time = (new Date()).getTime();
+
+                if (distance > DRAG_OFFSET) {
+                    state = STATE_SELECT;
+                    var cursor = editor.renderer.screenToTextCoordinates(mousePageX, mousePageY);
+                    cursor.row = Math.max(0, Math.min(cursor.row, editor.session.getLength()-1));
+                    onStartSelect(cursor);
+                }
+                else if ((time - mousedownTime) > DRAG_TIMER) {
+                    state = STATE_DRAG;
+                    dragRange = editor.getSelectionRange();
+                    var style = editor.getSelectionStyle();
+                    editor.session.addMarker(dragRange, "ace_selection", style);
+                    editor.clearSelection();
+                    dom.addCssClass(editor.container, "ace_dragging");
+                }
+
+            }
+
+            if (state == STATE_DRAG)
+                onDragSelectionInterval();
+            else if (state == STATE_SELECT)
+                onUpdateSelectionInterval();
+        };
+
+        function onStartSelect(pos) {
+            if (ev.getShiftKey()) {
+                editor.selection.selectToPosition(pos);
+            }
+            else {
+                if (!_self.$clickSelection) {
+                    editor.moveCursorToPosition(pos);
+                    editor.selection.clearSelection(pos.row, pos.column);
+                }
+            }
+            state = STATE_SELECT;
+        }
+
+        var onUpdateSelectionInterval = function() {
+            var anchor;
+            var cursor = editor.renderer.screenToTextCoordinates(mousePageX, mousePageY);
+            cursor.row = Math.max(0, Math.min(cursor.row, editor.session.getLength()-1));
+
+            if (_self.$clickSelection) {
+                if (_self.$clickSelection.contains(cursor.row, cursor.column)) {
+                    editor.selection.setSelectionRange(_self.$clickSelection);
+                }
+                else {
+                    if (_self.$clickSelection.compare(cursor.row, cursor.column) == -1) {
+                        anchor = _self.$clickSelection.end;
+                    }
+                    else {
+                        anchor = _self.$clickSelection.start;
+                    }
+                    editor.selection.setSelectionAnchor(anchor.row, anchor.column);
+                    editor.selection.selectToPosition(cursor);
+                }
+            }
+            else {
+                editor.selection.selectToPosition(cursor);
+            }
+
+            editor.renderer.scrollCursorIntoView();
+        };
+
+        var onDragSelectionInterval = function() {
+            dragCursor = editor.renderer.screenToTextCoordinates(mousePageX, mousePageY);
+            dragCursor.row = Math.max(0, Math.min(dragCursor.row, editor.session.getLength() - 1));
+
+            editor.moveCursorToPosition(dragCursor);
+        };
+
+        event.capture(editor.container, onMouseSelection, onMouseSelectionEnd);
+        var timerId = setInterval(onSelectionInterval, 20);
+
+        return ev.preventDefault();
+    };
+    
+    this.onDoubleClick = function(ev) {
+        var pos = ev.getDocumentPosition();
+        var editor = this.editor;
+        
+        editor.moveCursorToPosition(pos);
+        editor.selection.selectWord();
+        this.$clickSelection = editor.getSelectionRange();
+    };
+    
+    this.onTripleClick = function(ev) {
+        var pos = ev.getDocumentPosition();
+        var editor = this.editor;
+        
+        editor.moveCursorToPosition(pos);
+        editor.selection.selectLine();
+        this.$clickSelection = editor.getSelectionRange();
+    };
+    
+    this.onQuadClick = function(ev) {
+        var editor = this.editor;
+        
+        editor.selectAll();
+        this.$clickSelection = editor.getSelectionRange();
+    };
+    
+    this.onScroll = function(ev) {
+        var editor = this.editor;
+        
+        editor.renderer.scrollBy(ev.wheelX * ev.speed, ev.wheelY * ev.speed);
+        if (editor.renderer.isScrollableBy(ev.wheelX * ev.speed, ev.wheelY * ev.speed))
+            return ev.preventDefault();
+    };
+    
+}).call(DefaultHandlers.prototype);
+
+exports.DefaultHandlers = DefaultHandlers;
+
+function calcDistance(ax, ay, bx, by) {
+    return Math.sqrt(Math.pow(bx - ax, 2) + Math.pow(by - ay, 2));
+}
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/browser_focus', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/event', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var oop = require("./oop");
+var event = require("./event");
+var EventEmitter = require("./event_emitter").EventEmitter;
+
+/**
+ * This class keeps track of the focus state of the given window.
+ * Focus changes for example when the user switches a browser tab,
+ * goes to the location bar or switches to another application.
+ */ 
+var BrowserFocus = function(win) {
+    win = win || window;
+    
+    this.lastFocus = new Date().getTime();
+    this._isFocused = true;
+    
+    var _self = this;
+
+    // IE < 9 supports focusin and focusout events
+    if ("onfocusin" in win.document) {
+        event.addListener(win.document, "focusin", function(e) {
+            _self._setFocused(true);
+        });
+
+        event.addListener(win.document, "focusout", function(e) {
+            _self._setFocused(!!e.toElement);
+        });
+    }
+    else {
+        event.addListener(win, "blur", function(e) {
+            _self._setFocused(false);
+        });
+
+        event.addListener(win, "focus", function(e) {
+            _self._setFocused(true);
+        });
+    }
+};
+
+(function(){
+
+    oop.implement(this, EventEmitter);
+    
+    this.isFocused = function() {
+        return this._isFocused;
+    };
+    
+    this._setFocused = function(isFocused) {
+        if (this._isFocused == isFocused)
+            return;
+            
+        if (isFocused)
+            this.lastFocus = new Date().getTime();
+            
+        this._isFocused = isFocused;
+        this._emit("changeFocus");
+    };
+
+}).call(BrowserFocus.prototype);
+
+
+exports.BrowserFocus = BrowserFocus;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Mike de Boer <mike AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/event_emitter', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var EventEmitter = {};
+
+EventEmitter._emit =
+EventEmitter._dispatchEvent = function(eventName, e) {
+    this._eventRegistry = this._eventRegistry || {};
+    this._defaultHandlers = this._defaultHandlers || {};
+
+    var listeners = this._eventRegistry[eventName] || [];
+    var defaultHandler = this._defaultHandlers[eventName];
+    if (!listeners.length && !defaultHandler)
+        return;
+
+    e = e || {};
+    e.type = eventName;
+    
+    if (!e.stopPropagation) {
+        e.stopPropagation = function() {
+            this.propagationStopped = true;
+        };
+    }
+    
+    if (!e.preventDefault) {
+        e.preventDefault = function() {
+            this.defaultPrevented = true;
+        };
+    }
+
+    for (var i=0; i<listeners.length; i++) {
+        listeners[i](e);
+        if (e.propagationStopped)
+            break;
+    }
+    
+    if (defaultHandler && !e.defaultPrevented)
+        defaultHandler(e);
+};
+
+EventEmitter.setDefaultHandler = function(eventName, callback) {
+    this._defaultHandlers = this._defaultHandlers || {};
+    
+    if (this._defaultHandlers[eventName])
+        throw new Error("The default handler for '" + eventName + "' is already set");
+        
+    this._defaultHandlers[eventName] = callback;
+};
+
+EventEmitter.on =
+EventEmitter.addEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        var listeners = this._eventRegistry[eventName] = [];
+
+    if (listeners.indexOf(callback) == -1)
+        listeners.push(callback);
+};
+
+EventEmitter.removeListener =
+EventEmitter.removeEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        return;
+
+    var index = listeners.indexOf(callback);
+    if (index !== -1)
+        listeners.splice(index, 1);
+};
+
+EventEmitter.removeAllListeners = function(eventName) {
+    if (this._eventRegistry) this._eventRegistry[eventName] = [];
+};
+
+exports.EventEmitter = EventEmitter;
+
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mouse/default_gutter_handler', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+function GutterHandler(editor) {
+    editor.setDefaultHandler("gutterclick", function(e) {
+        var row = e.getDocumentPosition().row;
+        var selection = editor.session.selection;
+        
+        selection.moveCursorTo(row, 0);
+        selection.selectLine();
+    });
+}
+
+exports.GutterHandler = GutterHandler;
+
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mouse/mouse_event', ['require', 'exports', 'module' , 'ace/lib/event'], function(require, exports, module) {
+
+var event = require("../lib/event");
+
+/**
+ * Custom Ace mouse event
+ */
+var MouseEvent = exports.MouseEvent = function(domEvent, editor) {
+    this.domEvent = domEvent;
+    this.editor = editor;
+    
+    this.pageX = event.getDocumentX(domEvent);
+    this.pageY = event.getDocumentY(domEvent);
+    
+    this.clientX = domEvent.clientX;
+    this.clientY = domEvent.clientY;
+
+    this.$pos = null;
+    this.$inSelection = null;
+    
+    this.propagationStopped = false;
+    this.defaultPrevented = false;
+};
+
+(function() {  
+    
+    this.stopPropagation = function() {
+        event.stopPropagation(this.domEvent);
+        this.propagationStopped = true;
+    };
+    
+    this.preventDefault = function() {
+        event.preventDefault(this.domEvent);
+        this.defaultPrevented = true;
+    };
+    
+    this.stop = function() {
+        this.stopPropagation();
+        this.preventDefault();
+    };
+
+    /**
+     * Get the document position below the mouse cursor
+     * 
+     * @return {Object} 'row' and 'column' of the document position
+     */
+    this.getDocumentPosition = function() {
+        if (this.$pos)
+            return this.$pos;
+            
+        var pageX = event.getDocumentX(this.domEvent);
+        var pageY = event.getDocumentY(this.domEvent);
+        this.$pos = this.editor.renderer.screenToTextCoordinates(pageX, pageY);
+        this.$pos.row = Math.max(0, Math.min(this.$pos.row, this.editor.session.getLength()-1));
+        return this.$pos;
+    };
+    
+    /**
+     * Check if the mouse cursor is inside of the text selection
+     * 
+     * @return {Boolean} whether the mouse cursor is inside of the selection
+     */
+    this.inSelection = function() {
+        if (this.$inSelection !== null)
+            return this.$inSelection;
+            
+        var editor = this.editor;
+        
+        if (editor.getReadOnly()) {
+            this.$inSelection = false;
+        }
+        else {
+            var selectionRange = editor.getSelectionRange();
+            if (selectionRange.isEmpty())
+                this.$inSelection = false;
+            else {
+                var pos = this.getDocumentPosition();
+                this.$inSelection = selectionRange.contains(pos.row, pos.column);
+            }
+        }
+        return this.$inSelection;
+    };
+    
+    /**
+     * Get the clicked mouse button
+     * 
+     * @return {Number} 0 for left button, 1 for middle button, 2 for right button
+     */
+    this.getButton = function() {
+        return event.getButton(this.domEvent);
+    };
+    
+    /**
+     * @return {Boolean} whether the shift key was pressed when the event was emitted
+     */
+    this.getShiftKey = function() {
+        return this.domEvent.shiftKey;
+    };
+    
+    this.getAccelKey = function() {
+        return this.domEvent.ctrlKey || this.domEvent.metaKey ;
+    };
+    
+}).call(MouseEvent.prototype);
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mouse/fold_handler', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+function FoldHandler(editor) {
+    
+    editor.on("click", function(e) {
+        var position = e.getDocumentPosition();
+        var session = editor.session;
+        
+        // If the user dclicked on a fold, then expand it.
+        var fold = session.getFoldAt(position.row, position.column, 1);
+        if (fold) {
+            if (e.getAccelKey())
+                session.removeFold(fold);
+            else
+                session.expandFold(fold);
+                
+            e.stop();
+        }
+    });
+    
+    editor.on("gutterclick", function(e) {
+        if (e.domEvent.target.className.indexOf("ace_fold-widget") != -1) {
+            var row = e.getDocumentPosition().row;
+            editor.session.onFoldWidgetClick(row, e.domEvent);
+            e.stop();
+        }
+    });
+}
+
+exports.FoldHandler = FoldHandler;
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *      Harutyun Amirjanyan <amirjanyan at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/keyboard/keybinding', ['require', 'exports', 'module' , 'ace/lib/keys', 'ace/lib/event', 'ace/commands/default_commands'], function(require, exports, module) {
+
+var keyUtil  = require("../lib/keys");
+var event = require("../lib/event");
+require("../commands/default_commands");
+
+var KeyBinding = function(editor) {
+    this.$editor = editor;
+    this.$data = { };
+    this.$handlers = [this];
+};
+
+(function() {
+    this.setKeyboardHandler = function(keyboardHandler) {
+        if (this.$handlers[this.$handlers.length - 1] == keyboardHandler)
+            return;
+        this.$data = { };
+        this.$handlers = keyboardHandler ? [this, keyboardHandler] : [this];
+    };
+
+    this.addKeyboardHandler = function(keyboardHandler) {
+        this.removeKeyboardHandler(keyboardHandler);
+        this.$handlers.push(keyboardHandler);
+    };
+
+    this.removeKeyboardHandler = function(keyboardHandler) {
+        var i = this.$handlers.indexOf(keyboardHandler);
+        if (i == -1)
+            return false;
+        this.$handlers.splice(i, 1);
+        return true;
+    };
+
+    this.getKeyboardHandler = function() {
+        return this.$handlers[this.$handlers.length - 1];
+    };
+
+    this.$callKeyboardHandlers = function (hashId, keyString, keyCode, e) {
+        var toExecute;
+        for (var i = this.$handlers.length; i--;) {
+            toExecute = this.$handlers[i].handleKeyboard(
+                this.$data, hashId, keyString, keyCode, e
+            );
+            if (toExecute && toExecute.command)
+                break;
+        }
+
+        if (!toExecute || !toExecute.command)
+            return false;
+
+        var success = false;
+        var commands = this.$editor.commands;
+
+        // allow keyboardHandler to consume keys
+        if (toExecute.command != "null")
+            success = commands.exec(toExecute.command, this.$editor, toExecute.args);
+        else
+            success = true;
+
+        if (success && e)
+            event.stopEvent(e);
+
+        return success;
+    };
+
+    this.handleKeyboard = function(data, hashId, keyString) {
+        return {
+            command: this.$editor.commands.findKeyCommand(hashId, keyString)
+        };
+    };
+
+    this.onCommandKey = function(e, hashId, keyCode) {
+        var keyString = keyUtil.keyCodeToString(keyCode);
+        this.$callKeyboardHandlers(hashId, keyString, keyCode, e);
+    };
+
+    this.onTextInput = function(text, pasted) {
+        var success = false;
+        if (!pasted && text.length == 1)
+            success = this.$callKeyboardHandlers(0, text);
+        if (!success)
+            this.$editor.commands.exec("insertstring", this.$editor, text);
+    };
+
+}).call(KeyBinding.prototype);
+
+exports.KeyBinding = KeyBinding;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *      Mihai Sucan <mihai.sucan at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/commands/default_commands', ['require', 'exports', 'module' , 'ace/lib/lang'], function(require, exports, module) {
+
+var lang = require("../lib/lang");
+
+function bindKey(win, mac) {
+    return {
+        win: win,
+        mac: mac
+    };
+}
+
+exports.commands = [{
+    name: "selectall",
+    bindKey: bindKey("Ctrl-A", "Command-A"),
+    exec: function(editor) { editor.selectAll(); },
+    readOnly: true
+}, {
+    name: "centerselection",
+    bindKey: bindKey(null, "Ctrl-L"),
+    exec: function(editor) { editor.centerSelection(); },
+    readOnly: true
+}, {
+    name: "gotoline",
+    bindKey: bindKey("Ctrl-L", "Command-L"),
+    exec: function(editor) {
+        var line = parseInt(prompt("Enter line number:"), 10);
+        if (!isNaN(line)) {
+            editor.gotoLine(line);
+        }
+    },
+    readOnly: true
+}, {
+    name: "fold",
+    bindKey: bindKey("Alt-L", "Alt-L"),
+    exec: function(editor) { editor.session.toggleFold(false); },
+    readOnly: true
+}, {
+    name: "unfold",
+    bindKey: bindKey("Alt-Shift-L", "Alt-Shift-L"),
+    exec: function(editor) { editor.session.toggleFold(true); },
+    readOnly: true
+}, {
+    name: "foldall",
+    bindKey: bindKey("Alt-0", "Alt-0"),
+    exec: function(editor) { editor.session.foldAll(); },
+    readOnly: true
+}, {
+    name: "unfoldall",
+    bindKey: bindKey("Alt-Shift-0", "Alt-Shift-0"),
+    exec: function(editor) { editor.session.unfold(); },
+    readOnly: true
+}, {
+    name: "findnext",
+    bindKey: bindKey("Ctrl-K", "Command-G"),
+    exec: function(editor) { editor.findNext(); },
+    readOnly: true
+}, {
+    name: "findprevious",
+    bindKey: bindKey("Ctrl-Shift-K", "Command-Shift-G"),
+    exec: function(editor) { editor.findPrevious(); },
+    readOnly: true
+}, {
+    name: "find",
+    bindKey: bindKey("Ctrl-F", "Command-F"),
+    exec: function(editor) {
+        var needle = prompt("Find:", editor.getCopyText());
+        editor.find(needle);
+    },
+    readOnly: true
+}, {
+    name: "overwrite",
+    bindKey: bindKey("Insert", "Insert"),
+    exec: function(editor) { editor.toggleOverwrite(); },
+    readOnly: true
+}, {
+    name: "selecttostart",
+    bindKey: bindKey("Ctrl-Shift-Home|Alt-Shift-Up", "Command-Shift-Up"),
+    exec: function(editor) { editor.getSelection().selectFileStart(); },
+    readOnly: true
+}, {
+    name: "gotostart",
+    bindKey: bindKey("Ctrl-Home|Ctrl-Up", "Command-Home|Command-Up"),
+    exec: function(editor) { editor.navigateFileStart(); },
+    readOnly: true
+}, {
+    name: "selectup",
+    bindKey: bindKey("Shift-Up", "Shift-Up"),
+    exec: function(editor) { editor.getSelection().selectUp(); },
+    readOnly: true
+}, {
+    name: "golineup",
+    bindKey: bindKey("Up", "Up|Ctrl-P"),
+    exec: function(editor, args) { editor.navigateUp(args.times); },
+    readOnly: true
+}, {
+    name: "selecttoend",
+    bindKey: bindKey("Ctrl-Shift-End|Alt-Shift-Down", "Command-Shift-Down"),
+    exec: function(editor) { editor.getSelection().selectFileEnd(); },
+    readOnly: true
+}, {
+    name: "gotoend",
+    bindKey: bindKey("Ctrl-End|Ctrl-Down", "Command-End|Command-Down"),
+    exec: function(editor) { editor.navigateFileEnd(); },
+    readOnly: true
+}, {
+    name: "selectdown",
+    bindKey: bindKey("Shift-Down", "Shift-Down"),
+    exec: function(editor) { editor.getSelection().selectDown(); },
+    readOnly: true
+}, {
+    name: "golinedown",
+    bindKey: bindKey("Down", "Down|Ctrl-N"),
+    exec: function(editor, args) { editor.navigateDown(args.times); },
+    readOnly: true
+}, {
+    name: "selectwordleft",
+    bindKey: bindKey("Ctrl-Shift-Left", "Option-Shift-Left"),
+    exec: function(editor) { editor.getSelection().selectWordLeft(); },
+    readOnly: true
+}, {
+    name: "gotowordleft",
+    bindKey: bindKey("Ctrl-Left", "Option-Left"),
+    exec: function(editor) { editor.navigateWordLeft(); },
+    readOnly: true
+}, {
+    name: "selecttolinestart",
+    bindKey: bindKey("Alt-Shift-Left", "Command-Shift-Left"),
+    exec: function(editor) { editor.getSelection().selectLineStart(); },
+    readOnly: true
+}, {
+    name: "gotolinestart",
+    bindKey: bindKey("Alt-Left|Home", "Command-Left|Home|Ctrl-A"),
+    exec: function(editor) { editor.navigateLineStart(); },
+    readOnly: true
+}, {
+    name: "selectleft",
+    bindKey: bindKey("Shift-Left", "Shift-Left"),
+    exec: function(editor) { editor.getSelection().selectLeft(); },
+    readOnly: true
+}, {
+    name: "gotoleft",
+    bindKey: bindKey("Left", "Left|Ctrl-B"),
+    exec: function(editor, args) { editor.navigateLeft(args.times); },
+    readOnly: true
+}, {
+    name: "selectwordright",
+    bindKey: bindKey("Ctrl-Shift-Right", "Option-Shift-Right"),
+    exec: function(editor) { editor.getSelection().selectWordRight(); },
+    readOnly: true
+}, {
+    name: "gotowordright",
+    bindKey: bindKey("Ctrl-Right", "Option-Right"),
+    exec: function(editor) { editor.navigateWordRight(); },
+    readOnly: true
+}, {
+    name: "selecttolineend",
+    bindKey: bindKey("Alt-Shift-Right", "Command-Shift-Right"),
+    exec: function(editor) { editor.getSelection().selectLineEnd(); },
+    readOnly: true
+}, {
+    name: "gotolineend",
+    bindKey: bindKey("Alt-Right|End", "Command-Right|End|Ctrl-E"),
+    exec: function(editor) { editor.navigateLineEnd(); },
+    readOnly: true
+}, {
+    name: "selectright",
+    bindKey: bindKey("Shift-Right", "Shift-Right"),
+    exec: function(editor) { editor.getSelection().selectRight(); },
+    readOnly: true
+}, {
+    name: "gotoright",
+    bindKey: bindKey("Right", "Right|Ctrl-F"),
+    exec: function(editor, args) { editor.navigateRight(args.times); },
+    readOnly: true
+}, {
+    name: "selectpagedown",
+    bindKey: bindKey("Shift-PageDown", "Shift-PageDown"),
+    exec: function(editor) { editor.selectPageDown(); },
+    readOnly: true
+}, {
+    name: "pagedown",
+    bindKey: bindKey(null, "PageDown"),
+    exec: function(editor) { editor.scrollPageDown(); },
+    readOnly: true
+}, {
+    name: "gotopagedown",
+    bindKey: bindKey("PageDown", "Option-PageDown|Ctrl-V"),
+    exec: function(editor) { editor.gotoPageDown(); },
+    readOnly: true
+}, {
+    name: "selectpageup",
+    bindKey: bindKey("Shift-PageUp", "Shift-PageUp"),
+    exec: function(editor) { editor.selectPageUp(); },
+    readOnly: true
+}, {
+    name: "pageup",
+    bindKey: bindKey(null, "PageUp"),
+    exec: function(editor) { editor.scrollPageUp(); },
+    readOnly: true
+}, {
+    name: "gotopageup",
+    bindKey: bindKey("PageUp", "Option-PageUp"),
+    exec: function(editor) { editor.gotoPageUp(); },
+    readOnly: true
+}, {
+    name: "selectlinestart",
+    bindKey: bindKey("Shift-Home", "Shift-Home"),
+    exec: function(editor) { editor.getSelection().selectLineStart(); },
+    readOnly: true
+}, {
+    name: "selectlineend",
+    bindKey: bindKey("Shift-End", "Shift-End"),
+    exec: function(editor) { editor.getSelection().selectLineEnd(); },
+    readOnly: true
+}, {
+    name: "togglerecording",
+    bindKey: bindKey("Ctrl-Alt-E", "Command-Option-E"),
+    exec: function(editor) { editor.commands.toggleRecording(); },
+    readOnly: true
+}, {
+    name: "replaymacro",
+    bindKey: bindKey("Ctrl-Shift-E", "Command-Shift-E"),
+    exec: function(editor) { editor.commands.replay(editor); },
+    readOnly: true
+}, 
+
+// commands disabled in readOnly mode
+{
+    name: "removeline",
+    bindKey: bindKey("Ctrl-D", "Command-D"),
+    exec: function(editor) { editor.removeLines(); }
+}, {
+    name: "togglecomment",
+    bindKey: bindKey("Ctrl-7", "Command-7"),
+    exec: function(editor) { editor.toggleCommentLines(); }
+}, {
+    name: "replace",
+    bindKey: bindKey("Ctrl-R", "Command-Option-F"),
+    exec: function(editor) {
+        var needle = prompt("Find:", editor.getCopyText());
+        if (!needle)
+            return;
+        var replacement = prompt("Replacement:");
+        if (!replacement)
+            return;
+        editor.replace(replacement, {needle: needle});
+    }
+}, {
+    name: "replaceall",
+    bindKey: bindKey("Ctrl-Shift-R", "Command-Shift-Option-F"),
+    exec: function(editor) {
+        var needle = prompt("Find:");
+        if (!needle)
+            return;
+        var replacement = prompt("Replacement:");
+        if (!replacement)
+            return;
+        editor.replaceAll(replacement, {needle: needle});
+    }
+}, {
+    name: "undo",
+    bindKey: bindKey("Ctrl-Z", "Command-Z"),
+    exec: function(editor) { editor.undo(); }
+}, {
+    name: "redo",
+    bindKey: bindKey("Ctrl-Shift-Z|Ctrl-Y", "Command-Shift-Z|Command-Y"),
+    exec: function(editor) { editor.redo(); }
+}, {
+    name: "copylinesup",
+    bindKey: bindKey("Ctrl-Alt-Up", "Command-Option-Up"),
+    exec: function(editor) { editor.copyLinesUp(); }
+}, {
+    name: "movelinesup",
+    bindKey: bindKey("Alt-Up", "Option-Up"),
+    exec: function(editor) { editor.moveLinesUp(); }
+}, {
+    name: "copylinesdown",
+    bindKey: bindKey("Ctrl-Alt-Down", "Command-Option-Down"),
+    exec: function(editor) { editor.copyLinesDown(); }
+}, {
+    name: "movelinesdown",
+    bindKey: bindKey("Alt-Down", "Option-Down"),
+    exec: function(editor) { editor.moveLinesDown(); }
+}, {
+    name: "del",
+    bindKey: bindKey("Delete", "Delete|Ctrl-D"),
+    exec: function(editor) { editor.remove("right"); }
+}, {
+    name: "backspace",
+    bindKey: bindKey(
+        "Ctrl-Backspace|Command-Backspace|Option-Backspace|Shift-Backspace|Backspace",
+        "Ctrl-Backspace|Command-Backspace|Shift-Backspace|Backspace|Ctrl-H"
+    ),
+    exec: function(editor) { editor.remove("left"); }
+}, {
+    name: "removetolinestart",
+    bindKey: bindKey("Alt-Backspace", "Option-Backspace"),
+    exec: function(editor) { editor.removeToLineStart(); }
+}, {
+    name: "removetolineend",
+    bindKey: bindKey("Alt-Delete", "Ctrl-K"),
+    exec: function(editor) { editor.removeToLineEnd(); }
+}, {
+    name: "removewordleft",
+    bindKey: bindKey("Ctrl-Backspace", "Alt-Backspace|Ctrl-Alt-Backspace"),
+    exec: function(editor) { editor.removeWordLeft(); }
+}, {
+    name: "removewordright",
+    bindKey: bindKey("Ctrl-Delete", "Alt-Delete"),
+    exec: function(editor) { editor.removeWordRight(); }
+}, {
+    name: "outdent",
+    bindKey: bindKey("Shift-Tab", "Shift-Tab"),
+    exec: function(editor) { editor.blockOutdent(); }
+}, {
+    name: "indent",
+    bindKey: bindKey("Tab", "Tab"),
+    exec: function(editor) { editor.indent(); }
+}, {
+    name: "insertstring",
+    exec: function(editor, str) { editor.insert(str); }
+}, {
+    name: "inserttext",
+    exec: function(editor, args) {
+        editor.insert(lang.stringRepeat(args.text  || "", args.times || 1));
+    }
+}, {
+    name: "splitline",
+    bindKey: bindKey(null, "Ctrl-O"),
+    exec: function(editor) { editor.splitLine(); }
+}, {
+    name: "transposeletters",
+    bindKey: bindKey("Ctrl-T", "Ctrl-T"),
+    exec: function(editor) { editor.transposeLetters(); }
+}, {
+    name: "touppercase",
+    bindKey: bindKey("Ctrl-U", "Ctrl-U"),
+    exec: function(editor) { editor.toUpperCase(); }
+}, {
+    name: "tolowercase",
+    bindKey: bindKey("Ctrl-Shift-U", "Ctrl-Shift-U"),
+    exec: function(editor) { editor.toLowerCase(); }
+}];
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai DOT sucan AT gmail DOT com>
+ *      Julian Viereck <julian DOT viereck AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/edit_session', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/lang', 'ace/lib/event_emitter', 'ace/selection', 'ace/mode/text', 'ace/range', 'ace/document', 'ace/background_tokenizer', 'ace/edit_session/folding', 'ace/edit_session/bracket_match'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var lang = require("./lib/lang");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+var Selection = require("./selection").Selection;
+var TextMode = require("./mode/text").Mode;
+var Range = require("./range").Range;
+var Document = require("./document").Document;
+var BackgroundTokenizer = require("./background_tokenizer").BackgroundTokenizer;
+
+var EditSession = function(text, mode) {
+    this.$modified = true;
+    this.$breakpoints = [];
+    this.$frontMarkers = {};
+    this.$backMarkers = {};
+    this.$markerId = 1;
+    this.$rowCache = [];
+    this.$wrapData = [];
+    this.$foldData = [];
+    this.$undoSelect = true;
+    this.$foldData.toString = function() {
+        var str = "";
+        this.forEach(function(foldLine) {
+            str += "\n" + foldLine.toString();
+        });
+        return str;
+    }
+
+    if (text instanceof Document) {
+        this.setDocument(text);
+    } else {
+        this.setDocument(new Document(text));
+    }
+
+    this.selection = new Selection(this);
+    if (mode)
+        this.setMode(mode);
+    else
+        this.setMode(new TextMode());
+};
+
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.setDocument = function(doc) {
+        if (this.doc)
+            throw new Error("Document is already set");
+
+        this.doc = doc;
+        doc.on("change", this.onChange.bind(this));
+        this.on("changeFold", this.onChangeFold.bind(this));
+
+        if (this.bgTokenizer) {
+            this.bgTokenizer.setDocument(this.getDocument());
+            this.bgTokenizer.start(0);
+        }
+    };
+
+    this.getDocument = function() {
+        return this.doc;
+    };
+
+    this.$resetRowCache = function(row) {
+        if (row == 0) {
+            this.$rowCache = [];
+            return;
+        }
+        var rowCache = this.$rowCache;
+        for (var i = 0; i < rowCache.length; i++) {
+            if (rowCache[i].docRow >= row) {
+                rowCache.splice(i, rowCache.length);
+                return;
+            }
+        }
+    };
+
+    this.onChangeFold = function(e) {
+        var fold = e.data;
+        this.$resetRowCache(fold.start.row);
+    };
+
+    this.onChange = function(e) {
+        var delta = e.data;
+        this.$modified = true;
+
+        this.$resetRowCache(delta.range.start.row);
+
+        var removedFolds = this.$updateInternalDataOnChange(e);
+        if (!this.$fromUndo && this.$undoManager && !delta.ignore) {
+            this.$deltasDoc.push(delta);
+            if (removedFolds && removedFolds.length != 0) {
+                this.$deltasFold.push({
+                    action: "removeFolds",
+                    folds:  removedFolds
+                });
+            }
+
+            this.$informUndoManager.schedule();
+        }
+
+        this.bgTokenizer.start(delta.range.start.row);
+        this._dispatchEvent("change", e);
+    };
+
+    this.setValue = function(text) {
+        this.doc.setValue(text);
+        this.selection.moveCursorTo(0, 0);
+        this.selection.clearSelection();
+
+        this.$resetRowCache(0);
+        this.$deltas = [];
+        this.$deltasDoc = [];
+        this.$deltasFold = [];
+        this.getUndoManager().reset();
+    };
+
+    this.getValue =
+    this.toString = function() {
+        return this.doc.getValue();
+    };
+
+    this.getSelection = function() {
+        return this.selection;
+    };
+
+    this.getState = function(row) {
+        return this.bgTokenizer.getState(row);
+    };
+
+    this.getTokens = function(firstRow, lastRow) {
+        return this.bgTokenizer.getTokens(firstRow, lastRow);
+    };
+
+    this.getTokenAt = function(row, column) {
+        var tokens = this.bgTokenizer.getTokens(row, row)[0].tokens;
+        var token, c = 0;
+        if (column == null) {
+            i = tokens.length - 1;
+            c = this.getLine(row).length;
+        } else {
+            for (var i = 0; i < tokens.length; i++) {
+                c += tokens[i].value.length;
+                if (c >= column)
+                    break;
+            }
+        }
+        token = tokens[i];
+        if (!token)
+            return null;
+        token.index = i;
+        token.start = c - token.value.length;
+        return token;
+    };
+
+    this.setUndoManager = function(undoManager) {
+        this.$undoManager = undoManager;
+        this.$resetRowCache(0);
+        this.$deltas = [];
+        this.$deltasDoc = [];
+        this.$deltasFold = [];
+
+        if (this.$informUndoManager)
+            this.$informUndoManager.cancel();
+
+        if (undoManager) {
+            var self = this;
+            this.$syncInformUndoManager = function() {
+                self.$informUndoManager.cancel();
+
+                if (self.$deltasFold.length) {
+                    self.$deltas.push({
+                        group: "fold",
+                        deltas: self.$deltasFold
+                    });
+                    self.$deltasFold = [];
+                }
+
+                if (self.$deltasDoc.length) {
+                    self.$deltas.push({
+                        group: "doc",
+                        deltas: self.$deltasDoc
+                    });
+                    self.$deltasDoc = [];
+                }
+
+                if (self.$deltas.length > 0) {
+                    undoManager.execute({
+                        action: "aceupdate",
+                        args: [self.$deltas, self]
+                    });
+                }
+
+                self.$deltas = [];
+            }
+            this.$informUndoManager =
+                lang.deferredCall(this.$syncInformUndoManager);
+        }
+    };
+
+    this.$defaultUndoManager = {
+        undo: function() {},
+        redo: function() {},
+        reset: function() {}
+    };
+
+    this.getUndoManager = function() {
+        return this.$undoManager || this.$defaultUndoManager;
+    },
+
+    this.getTabString = function() {
+        if (this.getUseSoftTabs()) {
+            return lang.stringRepeat(" ", this.getTabSize());
+        } else {
+            return "\t";
+        }
+    };
+
+    this.$useSoftTabs = true;
+    this.setUseSoftTabs = function(useSoftTabs) {
+        if (this.$useSoftTabs === useSoftTabs) return;
+
+        this.$useSoftTabs = useSoftTabs;
+    };
+
+    this.getUseSoftTabs = function() {
+        return this.$useSoftTabs;
+    };
+
+    this.$tabSize = 4;
+    this.setTabSize = function(tabSize) {
+        if (isNaN(tabSize) || this.$tabSize === tabSize) return;
+
+        this.$modified = true;
+        this.$tabSize = tabSize;
+        this._dispatchEvent("changeTabSize");
+    };
+
+    this.getTabSize = function() {
+        return this.$tabSize;
+    };
+
+    this.isTabStop = function(position) {
+        return this.$useSoftTabs && (position.column % this.$tabSize == 0);
+    };
+
+    this.$overwrite = false;
+    this.setOverwrite = function(overwrite) {
+        if (this.$overwrite == overwrite) return;
+
+        this.$overwrite = overwrite;
+        this._dispatchEvent("changeOverwrite");
+    };
+
+    this.getOverwrite = function() {
+        return this.$overwrite;
+    };
+
+    this.toggleOverwrite = function() {
+        this.setOverwrite(!this.$overwrite);
+    };
+
+    this.getBreakpoints = function() {
+        return this.$breakpoints;
+    };
+
+    this.setBreakpoints = function(rows) {
+        this.$breakpoints = [];
+        for (var i=0; i<rows.length; i++) {
+            this.$breakpoints[rows[i]] = true;
+        }
+        this._dispatchEvent("changeBreakpoint", {});
+    };
+
+    this.clearBreakpoints = function() {
+        this.$breakpoints = [];
+        this._dispatchEvent("changeBreakpoint", {});
+    };
+
+    this.setBreakpoint = function(row) {
+        this.$breakpoints[row] = true;
+        this._dispatchEvent("changeBreakpoint", {});
+    };
+
+    this.clearBreakpoint = function(row) {
+        delete this.$breakpoints[row];
+        this._dispatchEvent("changeBreakpoint", {});
+    };
+
+    this.getBreakpoints = function() {
+        return this.$breakpoints;
+    };
+
+    this.addMarker = function(range, clazz, type, inFront) {
+        var id = this.$markerId++;
+
+        var marker = {
+            range : range,
+            type : type || "line",
+            renderer: typeof type == "function" ? type : null,
+            clazz : clazz,
+            inFront: !!inFront
+        }
+
+        if (inFront) {
+            this.$frontMarkers[id] = marker;
+            this._dispatchEvent("changeFrontMarker")
+        } else {
+            this.$backMarkers[id] = marker;
+            this._dispatchEvent("changeBackMarker")
+        }
+
+        return id;
+    };
+
+    this.removeMarker = function(markerId) {
+        var marker = this.$frontMarkers[markerId] || this.$backMarkers[markerId];
+        if (!marker)
+            return;
+
+        var markers = marker.inFront ? this.$frontMarkers : this.$backMarkers;
+        if (marker) {
+            delete (markers[markerId]);
+            this._dispatchEvent(marker.inFront ? "changeFrontMarker" : "changeBackMarker");
+        }
+    };
+
+    this.getMarkers = function(inFront) {
+        return inFront ? this.$frontMarkers : this.$backMarkers;
+    };
+
+    /**
+     * Error:
+     *  {
+     *    row: 12,
+     *    column: 2, //can be undefined
+     *    text: "Missing argument",
+     *    type: "error" // or "warning" or "info"
+     *  }
+     */
+    this.setAnnotations = function(annotations) {
+        this.$annotations = {};
+        for (var i=0; i<annotations.length; i++) {
+            var annotation = annotations[i];
+            var row = annotation.row;
+            if (this.$annotations[row])
+                this.$annotations[row].push(annotation);
+            else
+                this.$annotations[row] = [annotation];
+        }
+        this._dispatchEvent("changeAnnotation", {});
+    };
+
+    this.getAnnotations = function() {
+        return this.$annotations || {};
+    };
+
+    this.clearAnnotations = function() {
+        this.$annotations = {};
+        this._dispatchEvent("changeAnnotation", {});
+    };
+
+    this.$detectNewLine = function(text) {
+        var match = text.match(/^.*?(\r?\n)/m);
+        if (match) {
+            this.$autoNewLine = match[1];
+        } else {
+            this.$autoNewLine = "\n";
+        }
+    };
+
+    this.getWordRange = function(row, column) {
+        var line = this.getLine(row);
+
+        var inToken = false;
+        if (column > 0) {
+            inToken = !!line.charAt(column - 1).match(this.tokenRe);
+        }
+
+        if (!inToken) {
+            inToken = !!line.charAt(column).match(this.tokenRe);
+        }
+
+        var re = inToken ? this.tokenRe : this.nonTokenRe;
+
+        var start = column;
+        if (start > 0) {
+            do {
+                start--;
+            }
+            while (start >= 0 && line.charAt(start).match(re));
+            start++;
+        }
+
+        var end = column;
+        while (end < line.length && line.charAt(end).match(re)) {
+            end++;
+        }
+
+        return new Range(row, start, row, end);
+    };
+
+    // Gets the range of a word including its right whitespace
+    this.getAWordRange = function(row, column) {
+        var wordRange = this.getWordRange(row, column);
+        var line = this.getLine(wordRange.end.row);
+
+        while (line.charAt(wordRange.end.column).match(/[ \t]/)) {
+            wordRange.end.column += 1;
+        }
+        return wordRange;
+    };
+
+    this.setNewLineMode = function(newLineMode) {
+        this.doc.setNewLineMode(newLineMode);
+    };
+
+    this.getNewLineMode = function() {
+        return this.doc.getNewLineMode();
+    };
+
+    this.$useWorker = true;
+    this.setUseWorker = function(useWorker) {
+        if (this.$useWorker == useWorker)
+            return;
+
+        this.$useWorker = useWorker;
+
+        this.$stopWorker();
+        if (useWorker)
+            this.$startWorker();
+    };
+
+    this.getUseWorker = function() {
+        return this.$useWorker;
+    };
+
+    this.onReloadTokenizer = function(e) {
+        var rows = e.data;
+        this.bgTokenizer.start(rows.first);
+        this._dispatchEvent("tokenizerUpdate", e);
+    };
+
+    this.$mode = null;
+    this.setMode = function(mode) {
+        if (this.$mode === mode) return;
+        this.$mode = mode;
+
+        this.$stopWorker();
+
+        if (this.$useWorker)
+            this.$startWorker();
+
+        var tokenizer = mode.getTokenizer();
+
+        if(tokenizer.addEventListener !== undefined) {
+            var onReloadTokenizer = this.onReloadTokenizer.bind(this);
+            tokenizer.addEventListener("update", onReloadTokenizer);
+        }
+
+        if (!this.bgTokenizer) {
+            this.bgTokenizer = new BackgroundTokenizer(tokenizer);
+            var _self = this;
+            this.bgTokenizer.addEventListener("update", function(e) {
+                _self._dispatchEvent("tokenizerUpdate", e);
+            });
+        } else {
+            this.bgTokenizer.setTokenizer(tokenizer);
+        }
+
+        this.bgTokenizer.setDocument(this.getDocument());
+        this.bgTokenizer.start(0);
+
+        this.tokenRe = mode.tokenRe;
+        this.nonTokenRe = mode.nonTokenRe;
+
+        this.$setFolding(mode.foldingRules);
+
+        this._dispatchEvent("changeMode");
+    };
+
+    this.$stopWorker = function() {
+        if (this.$worker)
+            this.$worker.terminate();
+
+        this.$worker = null;
+    };
+
+    this.$startWorker = function() {
+        if (typeof Worker !== "undefined" && !require.noWorker) {
+            try {
+                this.$worker = this.$mode.createWorker(this);
+            } catch (e) {
+                console.log("Could not load worker");
+                console.log(e);
+                this.$worker = null;
+            }
+        }
+        else
+            this.$worker = null;
+    };
+
+    this.getMode = function() {
+        return this.$mode;
+    };
+
+    this.$scrollTop = 0;
+    this.setScrollTopRow = function(scrollTopRow) {
+        if (this.$scrollTop === scrollTopRow) return;
+
+        this.$scrollTop = scrollTopRow;
+        this._dispatchEvent("changeScrollTop");
+    };
+
+    this.getScrollTopRow = function() {
+        return this.$scrollTop;
+    };
+
+    this.getWidth = function() {
+        this.$computeWidth();
+        return this.width;
+    };
+
+    this.getScreenWidth = function() {
+        this.$computeWidth();
+        return this.screenWidth;
+    };
+
+    this.$computeWidth = function(force) {
+        if (this.$modified || force) {
+            this.$modified = false;
+
+            var lines = this.doc.getAllLines();
+            var longestLine = 0;
+            var longestScreenLine = 0;
+
+            for ( var i = 0; i < lines.length; i++) {
+                var foldLine = this.getFoldLine(i),
+                    line, len;
+
+                line = lines[i];
+                if (foldLine) {
+                    var end = foldLine.range.end;
+                    line = this.getFoldDisplayLine(foldLine);
+                    // Continue after the foldLine.end.row. All the lines in
+                    // between are folded.
+                    i = end.row;
+                }
+                len = line.length;
+                longestLine = Math.max(longestLine, len);
+                if (!this.$useWrapMode) {
+                    longestScreenLine = Math.max(
+                        longestScreenLine,
+                        this.$getStringScreenWidth(line)[0]
+                    );
+                }
+            }
+            this.width = longestLine;
+
+            if (this.$useWrapMode) {
+                this.screenWidth = this.$wrapLimit;
+            } else {
+                this.screenWidth = longestScreenLine;
+            }
+        }
+    };
+
+    /**
+     * Get a verbatim copy of the given line as it is in the document
+     */
+    this.getLine = function(row) {
+        return this.doc.getLine(row);
+    };
+
+    this.getLines = function(firstRow, lastRow) {
+        return this.doc.getLines(firstRow, lastRow);
+    };
+
+    this.getLength = function() {
+        return this.doc.getLength();
+    };
+
+    this.getTextRange = function(range) {
+        return this.doc.getTextRange(range);
+    };
+
+    this.insert = function(position, text) {
+        return this.doc.insert(position, text);
+    };
+
+    this.remove = function(range) {
+        return this.doc.remove(range);
+    };
+
+    this.undoChanges = function(deltas, dontSelect) {
+        if (!deltas.length)
+            return;
+
+        this.$fromUndo = true;
+        var lastUndoRange = null;
+        for (var i = deltas.length - 1; i != -1; i--) {
+            var delta = deltas[i];
+            if (delta.group == "doc") {
+                this.doc.revertDeltas(delta.deltas);
+                lastUndoRange =
+                    this.$getUndoSelection(delta.deltas, true, lastUndoRange);
+            } else {
+                delta.deltas.forEach(function(foldDelta) {
+                    this.addFolds(foldDelta.folds);
+                }, this);
+            }
+        }
+        this.$fromUndo = false;
+        lastUndoRange &&
+            this.$undoSelect &&
+            !dontSelect &&
+            this.selection.setSelectionRange(lastUndoRange);
+        return lastUndoRange;
+    };
+
+    this.redoChanges = function(deltas, dontSelect) {
+        if (!deltas.length)
+            return;
+
+        this.$fromUndo = true;
+        var lastUndoRange = null;
+        for (var i = 0; i < deltas.length; i++) {
+            var delta = deltas[i];
+            if (delta.group == "doc") {
+                this.doc.applyDeltas(delta.deltas);
+                lastUndoRange =
+                    this.$getUndoSelection(delta.deltas, false, lastUndoRange);
+            }
+        }
+        this.$fromUndo = false;
+        lastUndoRange &&
+            this.$undoSelect &&
+            !dontSelect &&
+            this.selection.setSelectionRange(lastUndoRange);
+        return lastUndoRange;
+    };
+    
+    this.setUndoSelect = function(enable) {
+        this.$undoSelect = enable;
+    };
+
+    this.$getUndoSelection = function(deltas, isUndo, lastUndoRange) {
+        function isInsert(delta) {
+            var insert =
+                delta.action == "insertText" || delta.action == "insertLines";
+            return isUndo ? !insert : insert;
+        }
+
+        var delta = deltas[0];
+        var range, point;
+        var lastDeltaIsInsert = false;
+        if (isInsert(delta)) {
+            range = delta.range.clone();
+            lastDeltaIsInsert = true;
+        } else {
+            range = Range.fromPoints(delta.range.start, delta.range.start);
+            lastDeltaIsInsert = false;
+        }
+
+        for (var i = 1; i < deltas.length; i++) {
+            delta = deltas[i];
+            if (isInsert(delta)) {
+                point = delta.range.start;
+                if (range.compare(point.row, point.column) == -1) {
+                    range.setStart(delta.range.start);
+                }
+                point = delta.range.end;
+                if (range.compare(point.row, point.column) == 1) {
+                    range.setEnd(delta.range.end);
+                }
+                lastDeltaIsInsert = true;
+            } else {
+                point = delta.range.start;
+                if (range.compare(point.row, point.column) == -1) {
+                    range =
+                        Range.fromPoints(delta.range.start, delta.range.start);
+                }
+                lastDeltaIsInsert = false;
+            }
+        }
+
+        // Check if this range and the last undo range has something in common.
+        // If true, merge the ranges.
+        if (lastUndoRange != null) {
+            var cmp = lastUndoRange.compareRange(range);
+            if (cmp == 1) {
+                range.setStart(lastUndoRange.start);
+            } else if (cmp == -1) {
+                range.setEnd(lastUndoRange.end);
+            }
+        }
+
+        return range;
+    },
+
+    this.replace = function(range, text) {
+        return this.doc.replace(range, text);
+    };
+
+    /**
+     * Move a range of text from the given range to the given position.
+     *
+     * @param fromRange {Range} The range of text you want moved within the
+     * document.
+     * @param toPosition {Object} The location (row and column) where you want
+     * to move the text to.
+     * @return {Range} The new range where the text was moved to.
+     */
+    this.moveText = function(fromRange, toPosition) {
+        var text = this.getTextRange(fromRange);
+        this.remove(fromRange);
+
+        var toRow = toPosition.row;
+        var toColumn = toPosition.column;
+
+        // Make sure to update the insert location, when text is removed in
+        // front of the chosen point of insertion.
+        if (!fromRange.isMultiLine() && fromRange.start.row == toRow &&
+            fromRange.end.column < toColumn)
+            toColumn -= text.length;
+
+        if (fromRange.isMultiLine() && fromRange.end.row < toRow) {
+            var lines = this.doc.$split(text);
+            toRow -= lines.length - 1;
+        }
+
+        var endRow = toRow + fromRange.end.row - fromRange.start.row;
+        var endColumn = fromRange.isMultiLine() ?
+                        fromRange.end.column :
+                        toColumn + fromRange.end.column - fromRange.start.column;
+
+        var toRange = new Range(toRow, toColumn, endRow, endColumn);
+
+        this.insert(toRange.start, text);
+
+        return toRange;
+    };
+
+    this.indentRows = function(startRow, endRow, indentString) {
+        indentString = indentString.replace(/\t/g, this.getTabString());
+        for (var row=startRow; row<=endRow; row++)
+            this.insert({row: row, column:0}, indentString);
+    };
+
+    this.outdentRows = function (range) {
+        var rowRange = range.collapseRows();
+        var deleteRange = new Range(0, 0, 0, 0);
+        var size = this.getTabSize();
+
+        for (var i = rowRange.start.row; i <= rowRange.end.row; ++i) {
+            var line = this.getLine(i);
+
+            deleteRange.start.row = i;
+            deleteRange.end.row = i;
+            for (var j = 0; j < size; ++j)
+                if (line.charAt(j) != ' ')
+                    break;
+            if (j < size && line.charAt(j) == '\t') {
+                deleteRange.start.column = j;
+                deleteRange.end.column = j + 1;
+            } else {
+                deleteRange.start.column = 0;
+                deleteRange.end.column = j;
+            }
+            this.remove(deleteRange);
+        }
+    };
+
+    this.moveLinesUp = function(firstRow, lastRow) {
+        if (firstRow <= 0) return 0;
+
+        var removed = this.doc.removeLines(firstRow, lastRow);
+        this.doc.insertLines(firstRow - 1, removed);
+        return -1;
+    };
+
+    this.moveLinesDown = function(firstRow, lastRow) {
+        if (lastRow >= this.doc.getLength()-1) return 0;
+
+        var removed = this.doc.removeLines(firstRow, lastRow);
+        this.doc.insertLines(firstRow+1, removed);
+        return 1;
+    };
+
+    this.duplicateLines = function(firstRow, lastRow) {
+        var firstRow = this.$clipRowToDocument(firstRow);
+        var lastRow = this.$clipRowToDocument(lastRow);
+
+        var lines = this.getLines(firstRow, lastRow);
+        this.doc.insertLines(firstRow, lines);
+
+        var addedRows = lastRow - firstRow + 1;
+        return addedRows;
+    };
+
+    this.$clipRowToDocument = function(row) {
+        return Math.max(0, Math.min(row, this.doc.getLength()-1));
+    };
+
+    this.$clipColumnToRow = function(row, column) {
+        if (column < 0)
+            return 0;
+        return Math.min(this.doc.getLine(row).length, column);
+    };
+
+    this.$clipPositionToDocument = function(row, column) {
+        column = Math.max(0, column);
+
+        if (row < 0) {
+            row = 0;
+            column = 0;
+        } else {
+            var len = this.doc.getLength();
+            if (row >= len) {
+                row = len - 1;
+                column = this.doc.getLine(len-1).length;
+            } else {
+                column = Math.min(this.doc.getLine(row).length, column);
+            }
+        }
+
+        return {
+            row: row,
+            column: column
+        };
+    };
+
+    this.$clipRangeToDocument = function(range) {
+        if (range.start.row < 0) {
+            range.start.row = 0;
+            range.start.column = 0
+        } else {
+            range.start.column = this.$clipColumnToRow(
+                range.start.row,
+                range.start.column
+            );
+        }
+        
+        var len = this.doc.getLength() - 1;
+        if (range.end.row > len) {
+            range.end.row = len;
+            range.end.column = this.doc.getLine(len).length;
+        } else {
+            range.end.column = this.$clipColumnToRow(
+                range.end.row,
+                range.end.column
+            );
+        }
+        return range;
+    };
+
+    // WRAPMODE
+    this.$wrapLimit = 80;
+    this.$useWrapMode = false;
+    this.$wrapLimitRange = {
+        min : null,
+        max : null
+    };
+
+    this.setUseWrapMode = function(useWrapMode) {
+        if (useWrapMode != this.$useWrapMode) {
+            this.$useWrapMode = useWrapMode;
+            this.$modified = true;
+            this.$resetRowCache(0);
+
+            // If wrapMode is activaed, the wrapData array has to be initialized.
+            if (useWrapMode) {
+                var len = this.getLength();
+                this.$wrapData = [];
+                for (var i = 0; i < len; i++) {
+                    this.$wrapData.push([]);
+                }
+                this.$updateWrapData(0, len - 1);
+            }
+
+            this._dispatchEvent("changeWrapMode");
+        }
+    };
+
+    this.getUseWrapMode = function() {
+        return this.$useWrapMode;
+    };
+
+    // Allow the wrap limit to move freely between min and max. Either
+    // parameter can be null to allow the wrap limit to be unconstrained
+    // in that direction. Or set both parameters to the same number to pin
+    // the limit to that value.
+    this.setWrapLimitRange = function(min, max) {
+        if (this.$wrapLimitRange.min !== min || this.$wrapLimitRange.max !== max) {
+            this.$wrapLimitRange.min = min;
+            this.$wrapLimitRange.max = max;
+            this.$modified = true;
+            // This will force a recalculation of the wrap limit
+            this._dispatchEvent("changeWrapMode");
+        }
+    };
+
+    // This should generally only be called by the renderer when a resize
+    // is detected.
+    this.adjustWrapLimit = function(desiredLimit) {
+        var wrapLimit = this.$constrainWrapLimit(desiredLimit);
+        if (wrapLimit != this.$wrapLimit && wrapLimit > 0) {
+            this.$wrapLimit = wrapLimit;
+            this.$modified = true;
+            if (this.$useWrapMode) {
+                this.$updateWrapData(0, this.getLength() - 1);
+                this.$resetRowCache(0)
+                this._dispatchEvent("changeWrapLimit");
+            }
+            return true;
+        }
+        return false;
+    };
+
+    this.$constrainWrapLimit = function(wrapLimit) {
+        var min = this.$wrapLimitRange.min;
+        if (min)
+            wrapLimit = Math.max(min, wrapLimit);
+
+        var max = this.$wrapLimitRange.max;
+        if (max)
+            wrapLimit = Math.min(max, wrapLimit);
+
+        // What would a limit of 0 even mean?
+        return Math.max(1, wrapLimit);
+    };
+
+    this.getWrapLimit = function() {
+        return this.$wrapLimit;
+    };
+
+    this.getWrapLimitRange = function() {
+        // Avoid unexpected mutation by returning a copy
+        return {
+            min : this.$wrapLimitRange.min,
+            max : this.$wrapLimitRange.max
+        };
+    };
+
+    this.$updateInternalDataOnChange = function(e) {
+        var useWrapMode = this.$useWrapMode;
+        var len;
+        var action = e.data.action;
+        var firstRow = e.data.range.start.row;
+        var lastRow = e.data.range.end.row;
+        var start = e.data.range.start;
+        var end = e.data.range.end;
+        var removedFolds = null;
+
+        if (action.indexOf("Lines") != -1) {
+            if (action == "insertLines") {
+                lastRow = firstRow + (e.data.lines.length);
+            } else {
+                lastRow = firstRow;
+            }
+            len = e.data.lines ? e.data.lines.length : lastRow - firstRow;
+        } else {
+            len = lastRow - firstRow;
+        }
+
+        if (len != 0) {
+            if (action.indexOf("remove") != -1) {
+                useWrapMode && this.$wrapData.splice(firstRow, len);
+
+                var foldLines = this.$foldData;
+                removedFolds = this.getFoldsInRange(e.data.range);
+                this.removeFolds(removedFolds);
+
+                var foldLine = this.getFoldLine(end.row);
+                var idx = 0;
+                if (foldLine) {
+                    foldLine.addRemoveChars(end.row, end.column, start.column - end.column);
+                    foldLine.shiftRow(-len);
+
+                    var foldLineBefore = this.getFoldLine(firstRow);
+                    if (foldLineBefore && foldLineBefore !== foldLine) {
+                        foldLineBefore.merge(foldLine);
+                        foldLine = foldLineBefore;
+                    }
+                    idx = foldLines.indexOf(foldLine) + 1;
+                }
+
+                for (idx; idx < foldLines.length; idx++) {
+                    var foldLine = foldLines[idx];
+                    if (foldLine.start.row >= end.row) {
+                        foldLine.shiftRow(-len);
+                    }
+                }
+
+                lastRow = firstRow;
+            } else {
+                var args;
+                if (useWrapMode) {
+                    args = [firstRow, 0];
+                    for (var i = 0; i < len; i++) args.push([]);
+                    this.$wrapData.splice.apply(this.$wrapData, args);
+                }
+
+                // If some new line is added inside of a foldLine, then split
+                // the fold line up.
+                var foldLines = this.$foldData;
+                var foldLine = this.getFoldLine(firstRow);
+                var idx = 0;
+                if (foldLine) {
+                    var cmp = foldLine.range.compareInside(start.row, start.column)
+                    // Inside of the foldLine range. Need to split stuff up.
+                    if (cmp == 0) {
+                        foldLine = foldLine.split(start.row, start.column);
+                        foldLine.shiftRow(len);
+                        foldLine.addRemoveChars(
+                            lastRow, 0, end.column - start.column);
+                    } else
+                    // Infront of the foldLine but same row. Need to shift column.
+                    if (cmp == -1) {
+                        foldLine.addRemoveChars(firstRow, 0, end.column - start.column);
+                        foldLine.shiftRow(len);
+                    }
+                    // Nothing to do if the insert is after the foldLine.
+                    idx = foldLines.indexOf(foldLine) + 1;
+                }
+
+                for (idx; idx < foldLines.length; idx++) {
+                    var foldLine = foldLines[idx];
+                    if (foldLine.start.row >= firstRow) {
+                        foldLine.shiftRow(len);
+                    }
+                }
+            }
+        } else {
+            // Realign folds. E.g. if you add some new chars before a fold, the
+            // fold should "move" to the right.
+            len = Math.abs(e.data.range.start.column - e.data.range.end.column);
+            if (action.indexOf("remove") != -1) {
+                // Get all the folds in the change range and remove them.
+                removedFolds = this.getFoldsInRange(e.data.range);
+                this.removeFolds(removedFolds);
+
+                len = -len;
+            }
+            var foldLine = this.getFoldLine(firstRow);
+            if (foldLine) {
+                foldLine.addRemoveChars(firstRow, start.column, len);
+            }
+        }
+
+        if (useWrapMode && this.$wrapData.length != this.doc.getLength()) {
+            console.error("doc.getLength() and $wrapData.length have to be the same!");
+        }
+
+        useWrapMode && this.$updateWrapData(firstRow, lastRow);
+
+        return removedFolds;
+    };
+
+    this.$updateWrapData = function(firstRow, lastRow) {
+        var lines = this.doc.getAllLines();
+        var tabSize = this.getTabSize();
+        var wrapData = this.$wrapData;
+        var wrapLimit = this.$wrapLimit;
+        var tokens;
+        var foldLine;
+
+        var row = firstRow;
+        lastRow = Math.min(lastRow, lines.length - 1);
+        while (row <= lastRow) {
+            foldLine = this.getFoldLine(row, foldLine);
+            if (!foldLine) {
+                tokens = this.$getDisplayTokens(lang.stringTrimRight(lines[row]));
+                wrapData[row] = this.$computeWrapSplits(tokens, wrapLimit, tabSize);
+                row ++;
+            } else {
+                tokens = [];
+                foldLine.walk(
+                    function(placeholder, row, column, lastColumn) {
+                        var walkTokens;
+                        if (placeholder) {
+                            walkTokens = this.$getDisplayTokens(
+                                            placeholder, tokens.length);
+                            walkTokens[0] = PLACEHOLDER_START;
+                            for (var i = 1; i < walkTokens.length; i++) {
+                                walkTokens[i] = PLACEHOLDER_BODY;
+                            }
+                        } else {
+                            walkTokens = this.$getDisplayTokens(
+                                lines[row].substring(lastColumn, column),
+                                tokens.length);
+                        }
+                        tokens = tokens.concat(walkTokens);
+                    }.bind(this),
+                    foldLine.end.row,
+                    lines[foldLine.end.row].length + 1
+                );
+                // Remove spaces/tabs from the back of the token array.
+                while (tokens.length != 0 && tokens[tokens.length - 1] >= SPACE)
+                    tokens.pop();
+
+                wrapData[foldLine.start.row]
+                    = this.$computeWrapSplits(tokens, wrapLimit, tabSize);
+                row = foldLine.end.row + 1;
+            }
+        }
+    };
+
+    // "Tokens"
+    var CHAR = 1,
+        CHAR_EXT = 2,
+        PLACEHOLDER_START = 3,
+        PLACEHOLDER_BODY =  4,
+        PUNCTUATION = 9,
+        SPACE = 10,
+        TAB = 11,
+        TAB_SPACE = 12;
+
+    this.$computeWrapSplits = function(tokens, wrapLimit) {
+        if (tokens.length == 0) {
+            return [];
+        }
+
+        var splits = [];
+        var displayLength = tokens.length;
+        var lastSplit = 0, lastDocSplit = 0;
+
+        function addSplit(screenPos) {
+            var displayed = tokens.slice(lastSplit, screenPos);
+
+            // The document size is the current size - the extra width for tabs
+            // and multipleWidth characters.
+            var len = displayed.length;
+            displayed.join("").
+                // Get all the TAB_SPACEs.
+                replace(/12/g, function() {
+                    len -= 1;
+                }).
+                // Get all the CHAR_EXT/multipleWidth characters.
+                replace(/2/g, function() {
+                    len -= 1;
+                });
+
+            lastDocSplit += len;
+            splits.push(lastDocSplit);
+            lastSplit = screenPos;
+        }
+
+        while (displayLength - lastSplit > wrapLimit) {
+            // This is, where the split should be.
+            var split = lastSplit + wrapLimit;
+
+            // If there is a space or tab at this split position, then making
+            // a split is simple.
+            if (tokens[split] >= SPACE) {
+                // Include all following spaces + tabs in this split as well.
+                while (tokens[split] >= SPACE) {
+                    split ++;
+                }
+                addSplit(split);
+                continue;
+            }
+
+            // === ELSE ===
+            // Check if split is inside of a placeholder. Placeholder are
+            // not splitable. Therefore, seek the beginning of the placeholder
+            // and try to place the split beofre the placeholder's start.
+            if (tokens[split] == PLACEHOLDER_START
+                || tokens[split] == PLACEHOLDER_BODY)
+            {
+                // Seek the start of the placeholder and do the split
+                // before the placeholder. By definition there always
+                // a PLACEHOLDER_START between split and lastSplit.
+                for (split; split != lastSplit - 1; split--) {
+                    if (tokens[split] == PLACEHOLDER_START) {
+                        // split++; << No incremental here as we want to
+                        //  have the position before the Placeholder.
+                        break;
+                    }
+                }
+
+                // If the PLACEHOLDER_START is not the index of the
+                // last split, then we can do the split
+                if (split > lastSplit) {
+                    addSplit(split);
+                    continue;
+                }
+
+                // If the PLACEHOLDER_START IS the index of the last
+                // split, then we have to place the split after the
+                // placeholder. So, let's seek for the end of the placeholder.
+                split = lastSplit + wrapLimit;
+                for (split; split < tokens.length; split++) {
+                    if (tokens[split] != PLACEHOLDER_BODY)
+                    {
+                        break;
+                    }
+                }
+
+                // If spilt == tokens.length, then the placeholder is the last
+                // thing in the line and adding a new split doesn't make sense.
+                if (split == tokens.length) {
+                    break;  // Breaks the while-loop.
+                }
+
+                // Finally, add the split...
+                addSplit(split);
+                continue;
+            }
+
+            // === ELSE ===
+            // Search for the first non space/tab/placeholder/punctuation token backwards.
+            var minSplit = Math.max(split - 10, lastSplit - 1);
+            while (split > minSplit && tokens[split] < PLACEHOLDER_START) {
+                split --;
+            }
+            while (split > minSplit && tokens[split] == PUNCTUATION) {
+                split --;
+            }
+            // If we found one, then add the split.
+            if (split > minSplit) {
+                addSplit(++split);
+                continue;
+            }
+
+            // === ELSE ===
+            split = lastSplit + wrapLimit;
+            // The split is inside of a CHAR or CHAR_EXT token and no space
+            // around -> force a split.
+            addSplit(split);
+        }
+        return splits;
+    }
+
+    /**
+     * @param
+     *   offset: The offset in screenColumn at which position str starts.
+     *           Important for calculating the realTabSize.
+     */
+    this.$getDisplayTokens = function(str, offset) {
+        var arr = [];
+        var tabSize;
+        offset = offset || 0;
+
+        for (var i = 0; i < str.length; i++) {
+            var c = str.charCodeAt(i);
+            // Tab
+            if (c == 9) {
+                tabSize = this.getScreenTabSize(arr.length + offset);
+                arr.push(TAB);
+                for (var n = 1; n < tabSize; n++) {
+                    arr.push(TAB_SPACE);
+                }
+            }
+            // Space
+            else if (c == 32) {
+                arr.push(SPACE);
+            } else if((c > 39 && c < 48) || (c > 57 && c < 64)) {
+                arr.push(PUNCTUATION);
+            }
+            // full width characters
+            else if (c >= 0x1100 && isFullWidth(c)) {
+                arr.push(CHAR, CHAR_EXT);
+            } else {
+                arr.push(CHAR);
+            }
+        }
+        return arr;
+    }
+
+    /**
+     * Calculates the width of the a string on the screen while assuming that
+     * the string starts at the first column on the screen.
+     *
+     * @param string str String to calculate the screen width of
+     * @return array
+     *      [0]: number of columns for str on screen.
+     *      [1]: docColumn position that was read until (useful with screenColumn)
+     */
+    this.$getStringScreenWidth = function(str, maxScreenColumn, screenColumn) {
+        if (maxScreenColumn == 0) {
+            return [0, 0];
+        }
+        if (maxScreenColumn == null) {
+            maxScreenColumn = screenColumn +
+                str.length * Math.max(this.getTabSize(), 2);
+        }
+        screenColumn = screenColumn || 0;
+
+        var c, column;
+        for (column = 0; column < str.length; column++) {
+            c = str.charCodeAt(column);
+            // tab
+            if (c == 9) {
+                screenColumn += this.getScreenTabSize(screenColumn);
+            }
+            // full width characters
+            else if (c >= 0x1100 && isFullWidth(c)) {
+                screenColumn += 2;
+            } else {
+                screenColumn += 1;
+            }
+            if (screenColumn > maxScreenColumn) {
+                break
+            }
+        }
+
+        return [screenColumn, column];
+    }
+
+    /**
+     * Returns the number of rows required to render this row on the screen
+     */
+    this.getRowLength = function(row) {
+        if (!this.$useWrapMode || !this.$wrapData[row]) {
+            return 1;
+        } else {
+            return this.$wrapData[row].length + 1;
+        }
+    }
+
+    /**
+     * Returns the height in pixels required to render this row on the screen
+     **/
+    this.getRowHeight = function(config, row) {
+        return this.getRowLength(row) * config.lineHeight;
+    }
+
+    this.getScreenLastRowColumn = function(screenRow) {
+        //return this.screenToDocumentColumn(screenRow, Number.MAX_VALUE / 10)
+        return this.documentToScreenColumn(screenRow, this.doc.getLine(screenRow).length);
+    };
+
+    this.getDocumentLastRowColumn = function(docRow, docColumn) {
+        var screenRow = this.documentToScreenRow(docRow, docColumn);
+        return this.getScreenLastRowColumn(screenRow);
+    };
+
+    this.getDocumentLastRowColumnPosition = function(docRow, docColumn) {
+        var screenRow = this.documentToScreenRow(docRow, docColumn);
+        return this.screenToDocumentPosition(screenRow, Number.MAX_VALUE / 10);
+    };
+
+    this.getRowSplitData = function(row) {
+        if (!this.$useWrapMode) {
+            return undefined;
+        } else {
+            return this.$wrapData[row];
+        }
+    };
+
+    /**
+     * Returns the width of a tab character at screenColumn.
+     */
+    this.getScreenTabSize = function(screenColumn) {
+        return this.$tabSize - screenColumn % this.$tabSize;
+    };
+
+    this.screenToDocumentRow = function(screenRow, screenColumn) {
+        return this.screenToDocumentPosition(screenRow, screenColumn).row;
+    };
+
+    this.screenToDocumentColumn = function(screenRow, screenColumn) {
+        return this.screenToDocumentPosition(screenRow, screenColumn).column;
+    };
+
+    this.screenToDocumentPosition = function(screenRow, screenColumn) {
+        if (screenRow < 0) {
+            return {
+                row: 0,
+                column: 0
+            }
+        }
+
+        var line;
+        var docRow = 0;
+        var docColumn = 0;
+        var column;
+        var row = 0;
+        var rowLength = 0;
+
+        var rowCache = this.$rowCache;
+        for (var i = 0; i < rowCache.length; i++) {
+            if (rowCache[i].screenRow < screenRow) {
+                row = rowCache[i].screenRow;
+                docRow = rowCache[i].docRow;
+            }
+            else {
+                break;
+            }
+        }
+        var doCache = !rowCache.length || i == rowCache.length;
+
+        var maxRow = this.getLength() - 1;
+        var foldLine = this.getNextFoldLine(docRow);
+        var foldStart = foldLine ? foldLine.start.row : Infinity;
+
+        while (row <= screenRow) {
+            rowLength = this.getRowLength(docRow);
+            if (row + rowLength - 1 >= screenRow || docRow >= maxRow) {
+                break;
+            } else {
+                row += rowLength;
+                docRow++;
+                if (docRow > foldStart) {
+                    docRow = foldLine.end.row+1;
+                    foldLine = this.getNextFoldLine(docRow, foldLine);
+                    foldStart = foldLine ? foldLine.start.row : Infinity;
+                }
+            }
+            if (doCache) {
+                rowCache.push({
+                    docRow: docRow,
+                    screenRow: row
+                });
+            }
+        }
+
+        if (foldLine && foldLine.start.row <= docRow) {
+            line = this.getFoldDisplayLine(foldLine);
+            docRow = foldLine.start.row;
+        } else if (row + rowLength <= screenRow || docRow > maxRow) {
+            // clip at the end of the document
+            return {
+                row: maxRow,
+                column: this.getLine(maxRow).length
+            }
+        } else {
+            line = this.getLine(docRow);
+            foldLine = null;
+        }
+
+        if (this.$useWrapMode) {
+            var splits = this.$wrapData[docRow];
+            if (splits) {
+                column = splits[screenRow - row];
+                if(screenRow > row && splits.length) {
+                    docColumn = splits[screenRow - row - 1] || splits[splits.length - 1];
+                    line = line.substring(docColumn);
+                }
+            }
+        }
+
+        docColumn += this.$getStringScreenWidth(line, screenColumn)[1];
+
+        // Need to do some clamping action here.
+        if (this.$useWrapMode) {
+            if (docColumn >= column) {
+                // We remove one character at the end such that the docColumn
+                // position returned is not associated to the next row on the
+                // screen.
+                docColumn = column - 1;
+            }
+        } else {
+            docColumn = Math.min(docColumn, line.length);
+        }
+
+        if (foldLine) {
+            return foldLine.idxToPosition(docColumn);
+        }
+
+        return {
+            row: docRow,
+            column: docColumn
+        }
+    };
+
+    this.documentToScreenPosition = function(docRow, docColumn) {
+        // Normalize the passed in arguments.
+        if (typeof docColumn === "undefined")
+            var pos = this.$clipPositionToDocument(docRow.row, docRow.column);
+        else
+            pos = this.$clipPositionToDocument(docRow, docColumn);
+
+        docRow = pos.row;
+        docColumn = pos.column;
+
+        var wrapData;
+        // Special case in wrapMode if the doc is at the end of the document.
+        if (this.$useWrapMode) {
+            wrapData = this.$wrapData;
+            if (docRow > wrapData.length - 1) {
+                return {
+                    row: this.getScreenLength(),
+                    column: wrapData.length == 0
+                        ? 0
+                        : (wrapData[wrapData.length - 1].length - 1)
+                };
+            }
+        }
+
+        var screenRow = 0;
+        var foldStartRow = null;
+        var fold = null;
+
+        // Clamp the docRow position in case it's inside of a folded block.
+        fold = this.getFoldAt(docRow, docColumn, 1);
+        if (fold) {
+            docRow = fold.start.row;
+            docColumn = fold.start.column;
+        }
+
+        var rowEnd, row = 0;
+        var rowCache = this.$rowCache;
+
+        for (var i = 0; i < rowCache.length; i++) {
+            if (rowCache[i].docRow < docRow) {
+                screenRow = rowCache[i].screenRow;
+                row = rowCache[i].docRow;
+            } else {
+                break;
+            }
+        }
+        var doCache = !rowCache.length || i == rowCache.length;
+
+        var foldLine = this.getNextFoldLine(row);
+        var foldStart = foldLine ?foldLine.start.row :Infinity;
+
+        while (row < docRow) {
+            if (row >= foldStart) {
+                rowEnd = foldLine.end.row + 1;
+                if (rowEnd > docRow)
+                    break;
+                foldLine = this.getNextFoldLine(rowEnd, foldLine);
+                foldStart = foldLine ?foldLine.start.row :Infinity;
+            }
+            else {
+                rowEnd = row + 1;
+            }
+
+            screenRow += this.getRowLength(row);
+            row = rowEnd;
+
+            if (doCache) {
+                rowCache.push({
+                    docRow: row,
+                    screenRow: screenRow
+                });
+            }
+        }
+
+        // Calculate the text line that is displayed in docRow on the screen.
+        var textLine = "";
+        // Check if the final row we want to reach is inside of a fold.
+        if (foldLine && row >= foldStart) {
+            textLine = this.getFoldDisplayLine(foldLine, docRow, docColumn);
+            foldStartRow = foldLine.start.row;
+        } else {
+            textLine = this.getLine(docRow).substring(0, docColumn);
+            foldStartRow = docRow;
+        }
+        // Clamp textLine if in wrapMode.
+        if (this.$useWrapMode) {
+            var wrapRow = wrapData[foldStartRow];
+            var screenRowOffset = 0;
+            while (textLine.length >= wrapRow[screenRowOffset]) {
+                screenRow ++;
+                screenRowOffset++;
+            }
+            textLine = textLine.substring(
+                wrapRow[screenRowOffset - 1] || 0, textLine.length
+            );
+        }
+
+        return {
+            row: screenRow,
+            column: this.$getStringScreenWidth(textLine)[0]
+        };
+    };
+
+    this.documentToScreenColumn = function(row, docColumn) {
+        return this.documentToScreenPosition(row, docColumn).column;
+    };
+
+    this.documentToScreenRow = function(docRow, docColumn) {
+        return this.documentToScreenPosition(docRow, docColumn).row;
+    };
+
+    this.getScreenLength = function() {
+        var screenRows = 0;
+        var fold = null;
+        if (!this.$useWrapMode) {
+            screenRows = this.getLength();
+
+            // Remove the folded lines again.
+            var foldData = this.$foldData;
+            for (var i = 0; i < foldData.length; i++) {
+                fold = foldData[i];
+                screenRows -= fold.end.row - fold.start.row;
+            }
+        } else {
+            var lastRow = this.$wrapData.length;
+            var row = 0, i = 0;
+            var fold = this.$foldData[i++];
+            var foldStart = fold ? fold.start.row :Infinity;
+
+            while (row < lastRow) {
+                screenRows += this.$wrapData[row].length + 1;
+                row ++;
+                if (row > foldStart) {
+                    row = fold.end.row+1;
+                    fold = this.$foldData[i++];
+                    foldStart = fold ?fold.start.row :Infinity;
+                }
+            }
+        }
+
+        return screenRows;
+    }
+
+    // For every keystroke this gets called once per char in the whole doc!!
+    // Wouldn't hurt to make it a bit faster for c >= 0x1100
+    function isFullWidth(c) {
+        if (c < 0x1100)
+            return false;
+        return c >= 0x1100 && c <= 0x115F ||
+               c >= 0x11A3 && c <= 0x11A7 ||
+               c >= 0x11FA && c <= 0x11FF ||
+               c >= 0x2329 && c <= 0x232A ||
+               c >= 0x2E80 && c <= 0x2E99 ||
+               c >= 0x2E9B && c <= 0x2EF3 ||
+               c >= 0x2F00 && c <= 0x2FD5 ||
+               c >= 0x2FF0 && c <= 0x2FFB ||
+               c >= 0x3000 && c <= 0x303E ||
+               c >= 0x3041 && c <= 0x3096 ||
+               c >= 0x3099 && c <= 0x30FF ||
+               c >= 0x3105 && c <= 0x312D ||
+               c >= 0x3131 && c <= 0x318E ||
+               c >= 0x3190 && c <= 0x31BA ||
+               c >= 0x31C0 && c <= 0x31E3 ||
+               c >= 0x31F0 && c <= 0x321E ||
+               c >= 0x3220 && c <= 0x3247 ||
+               c >= 0x3250 && c <= 0x32FE ||
+               c >= 0x3300 && c <= 0x4DBF ||
+               c >= 0x4E00 && c <= 0xA48C ||
+               c >= 0xA490 && c <= 0xA4C6 ||
+               c >= 0xA960 && c <= 0xA97C ||
+               c >= 0xAC00 && c <= 0xD7A3 ||
+               c >= 0xD7B0 && c <= 0xD7C6 ||
+               c >= 0xD7CB && c <= 0xD7FB ||
+               c >= 0xF900 && c <= 0xFAFF ||
+               c >= 0xFE10 && c <= 0xFE19 ||
+               c >= 0xFE30 && c <= 0xFE52 ||
+               c >= 0xFE54 && c <= 0xFE66 ||
+               c >= 0xFE68 && c <= 0xFE6B ||
+               c >= 0xFF01 && c <= 0xFF60 ||
+               c >= 0xFFE0 && c <= 0xFFE6;
+    };
+
+}).call(EditSession.prototype);
+
+require("./edit_session/folding").Folding.call(EditSession.prototype);
+require("./edit_session/bracket_match").BracketMatch.call(EditSession.prototype);
+
+exports.EditSession = EditSession;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/selection', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/lang', 'ace/lib/event_emitter', 'ace/range'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var lang = require("./lib/lang");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+var Range = require("./range").Range;
+
+/**
+ * Keeps cursor position and the text selection of an edit session.
+ *
+ * The row/columns used in the selection are in document coordinates
+ * representing ths coordinates as thez appear in the document
+ * before applying soft wrap and folding.
+ */
+var Selection = function(session) {
+    this.session = session;
+    this.doc = session.getDocument();
+
+    this.clearSelection();
+    this.selectionLead = this.doc.createAnchor(0, 0);
+    this.selectionAnchor = this.doc.createAnchor(0, 0);
+
+    var _self = this;
+    this.selectionLead.on("change", function(e) {
+        _self._dispatchEvent("changeCursor");
+        if (!_self.$isEmpty)
+            _self._dispatchEvent("changeSelection");
+        if (!_self.$preventUpdateDesiredColumnOnChange && e.old.column != e.value.column)
+            _self.$updateDesiredColumn();
+    });
+
+    this.selectionAnchor.on("change", function() {
+        if (!_self.$isEmpty)
+            _self._dispatchEvent("changeSelection");
+    });
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.isEmpty = function() {
+        return (this.$isEmpty || (
+            this.selectionAnchor.row == this.selectionLead.row &&
+            this.selectionAnchor.column == this.selectionLead.column
+        ));
+    };
+
+    this.isMultiLine = function() {
+        if (this.isEmpty()) {
+            return false;
+        }
+
+        return this.getRange().isMultiLine();
+    };
+
+    this.getCursor = function() {
+        return this.selectionLead.getPosition();
+    };
+
+    this.setSelectionAnchor = function(row, column) {
+        this.selectionAnchor.setPosition(row, column);
+
+        if (this.$isEmpty) {
+            this.$isEmpty = false;
+            this._dispatchEvent("changeSelection");
+        }
+    };
+
+    this.getSelectionAnchor = function() {
+        if (this.$isEmpty)
+            return this.getSelectionLead()
+        else
+            return this.selectionAnchor.getPosition();
+    };
+
+    this.getSelectionLead = function() {
+        return this.selectionLead.getPosition();
+    };
+
+    this.shiftSelection = function(columns) {
+        if (this.$isEmpty) {
+            this.moveCursorTo(this.selectionLead.row, this.selectionLead.column + columns);
+            return;
+        };
+
+        var anchor = this.getSelectionAnchor();
+        var lead = this.getSelectionLead();
+
+        var isBackwards = this.isBackwards();
+
+        if (!isBackwards || anchor.column !== 0)
+            this.setSelectionAnchor(anchor.row, anchor.column + columns);
+
+        if (isBackwards || lead.column !== 0) {
+            this.$moveSelection(function() {
+                this.moveCursorTo(lead.row, lead.column + columns);
+            });
+        }
+    };
+
+    this.isBackwards = function() {
+        var anchor = this.selectionAnchor;
+        var lead = this.selectionLead;
+        return (anchor.row > lead.row || (anchor.row == lead.row && anchor.column > lead.column));
+    };
+
+    this.getRange = function() {
+        var anchor = this.selectionAnchor;
+        var lead = this.selectionLead;
+
+        if (this.isEmpty())
+            return Range.fromPoints(lead, lead);
+
+        if (this.isBackwards()) {
+            return Range.fromPoints(lead, anchor);
+        }
+        else {
+            return Range.fromPoints(anchor, lead);
+        }
+    };
+
+    this.clearSelection = function() {
+        if (!this.$isEmpty) {
+            this.$isEmpty = true;
+            this._dispatchEvent("changeSelection");
+        }
+    };
+
+    this.selectAll = function() {
+        var lastRow = this.doc.getLength() - 1;
+        this.setSelectionAnchor(lastRow, this.doc.getLine(lastRow).length);
+        this.moveCursorTo(0, 0);
+    };
+
+    this.setSelectionRange = function(range, reverse) {
+        if (reverse) {
+            this.setSelectionAnchor(range.end.row, range.end.column);
+            this.selectTo(range.start.row, range.start.column);
+        } else {
+            this.setSelectionAnchor(range.start.row, range.start.column);
+            this.selectTo(range.end.row, range.end.column);
+        }
+        this.$updateDesiredColumn();
+    };
+
+    this.$updateDesiredColumn = function() {
+        var cursor = this.getCursor();
+        this.$desiredColumn = this.session.documentToScreenColumn(cursor.row, cursor.column);
+    };
+
+    this.$moveSelection = function(mover) {
+        var lead = this.selectionLead;
+        if (this.$isEmpty)
+            this.setSelectionAnchor(lead.row, lead.column);
+
+        mover.call(this);
+    };
+
+    this.selectTo = function(row, column) {
+        this.$moveSelection(function() {
+            this.moveCursorTo(row, column);
+        });
+    };
+
+    this.selectToPosition = function(pos) {
+        this.$moveSelection(function() {
+            this.moveCursorToPosition(pos);
+        });
+    };
+
+    this.selectUp = function() {
+        this.$moveSelection(this.moveCursorUp);
+    };
+
+    this.selectDown = function() {
+        this.$moveSelection(this.moveCursorDown);
+    };
+
+    this.selectRight = function() {
+        this.$moveSelection(this.moveCursorRight);
+    };
+
+    this.selectLeft = function() {
+        this.$moveSelection(this.moveCursorLeft);
+    };
+
+    this.selectLineStart = function() {
+        this.$moveSelection(this.moveCursorLineStart);
+    };
+
+    this.selectLineEnd = function() {
+        this.$moveSelection(this.moveCursorLineEnd);
+    };
+
+    this.selectFileEnd = function() {
+        this.$moveSelection(this.moveCursorFileEnd);
+    };
+
+    this.selectFileStart = function() {
+        this.$moveSelection(this.moveCursorFileStart);
+    };
+
+    this.selectWordRight = function() {
+        this.$moveSelection(this.moveCursorWordRight);
+    };
+
+    this.selectWordLeft = function() {
+        this.$moveSelection(this.moveCursorWordLeft);
+    };
+
+    this.selectWord = function() {
+        var cursor = this.getCursor();
+        var range  = this.session.getWordRange(cursor.row, cursor.column);
+        this.setSelectionRange(range);
+    };
+
+    // Selects a word including its right whitespace
+    this.selectAWord = function() {
+        var cursor = this.getCursor();
+        var range = this.session.getAWordRange(cursor.row, cursor.column);
+        this.setSelectionRange(range);
+    };
+
+    this.selectLine = function() {
+        var rowStart = this.selectionLead.row;
+        var rowEnd;
+
+        var foldLine = this.session.getFoldLine(rowStart);
+        if (foldLine) {
+            rowStart = foldLine.start.row;
+            rowEnd = foldLine.end.row;
+        } else {
+            rowEnd = rowStart;
+        }
+        this.setSelectionAnchor(rowStart, 0);
+        this.$moveSelection(function() {
+            this.moveCursorTo(rowEnd + 1, 0);
+        });
+    };
+
+    this.moveCursorUp = function() {
+        this.moveCursorBy(-1, 0);
+    };
+
+    this.moveCursorDown = function() {
+        this.moveCursorBy(1, 0);
+    };
+
+    this.moveCursorLeft = function() {
+        var cursor = this.selectionLead.getPosition(),
+            fold;
+
+        if (fold = this.session.getFoldAt(cursor.row, cursor.column, -1)) {
+            this.moveCursorTo(fold.start.row, fold.start.column);
+        } else if (cursor.column == 0) {
+            // cursor is a line (start
+            if (cursor.row > 0) {
+                this.moveCursorTo(cursor.row - 1, this.doc.getLine(cursor.row - 1).length);
+            }
+        }
+        else {
+            var tabSize = this.session.getTabSize();
+            if (this.session.isTabStop(cursor) && this.doc.getLine(cursor.row).slice(cursor.column-tabSize, cursor.column).split(" ").length-1 == tabSize)
+                this.moveCursorBy(0, -tabSize);
+            else
+                this.moveCursorBy(0, -1);
+        }
+    };
+
+    this.moveCursorRight = function() {
+        var cursor = this.selectionLead.getPosition(),
+            fold;
+        if (fold = this.session.getFoldAt(cursor.row, cursor.column, 1)) {
+            this.moveCursorTo(fold.end.row, fold.end.column);
+        }
+        else if (this.selectionLead.column == this.doc.getLine(this.selectionLead.row).length) {
+            if (this.selectionLead.row < this.doc.getLength() - 1) {
+                this.moveCursorTo(this.selectionLead.row + 1, 0);
+            }
+        }
+        else {
+            var tabSize = this.session.getTabSize();
+            var cursor = this.selectionLead;
+            if (this.session.isTabStop(cursor) && this.doc.getLine(cursor.row).slice(cursor.column, cursor.column+tabSize).split(" ").length-1 == tabSize)
+                this.moveCursorBy(0, tabSize);
+            else
+                this.moveCursorBy(0, 1);
+        }
+    };
+
+    this.moveCursorLineStart = function() {
+        var row = this.selectionLead.row;
+        var column = this.selectionLead.column;
+        var screenRow = this.session.documentToScreenRow(row, column);
+
+        // Determ the doc-position of the first character at the screen line.
+        var firstColumnPosition = this.session.screenToDocumentPosition(screenRow, 0);
+
+        // Determ the line
+        var beforeCursor = this.session.getDisplayLine(
+            row, null,
+            firstColumnPosition.row, firstColumnPosition.column
+        );
+
+        var leadingSpace = beforeCursor.match(/^\s*/);
+        if (leadingSpace[0].length == column) {
+            this.moveCursorTo(
+                firstColumnPosition.row, firstColumnPosition.column
+            );
+        }
+        else {
+            this.moveCursorTo(
+                firstColumnPosition.row,
+                firstColumnPosition.column + leadingSpace[0].length
+            );
+        }
+    };
+
+    this.moveCursorLineEnd = function() {
+        var lead = this.selectionLead;
+        var lastRowColumnPosition =
+            this.session.getDocumentLastRowColumnPosition(lead.row, lead.column);
+        this.moveCursorTo(
+            lastRowColumnPosition.row,
+            lastRowColumnPosition.column
+        );
+    };
+
+    this.moveCursorFileEnd = function() {
+        var row = this.doc.getLength() - 1;
+        var column = this.doc.getLine(row).length;
+        this.moveCursorTo(row, column);
+    };
+
+    this.moveCursorFileStart = function() {
+        this.moveCursorTo(0, 0);
+    };
+
+    this.moveCursorWordRight = function() {
+        var row = this.selectionLead.row;
+        var column = this.selectionLead.column;
+        var line = this.doc.getLine(row);
+        var rightOfCursor = line.substring(column);
+
+        var match;
+        this.session.nonTokenRe.lastIndex = 0;
+        this.session.tokenRe.lastIndex = 0;
+
+        // skip folds
+        var fold = this.session.getFoldAt(row, column, 1);
+        if (fold) {
+            this.moveCursorTo(fold.end.row, fold.end.column);
+            return;
+        }
+        
+        // first skip space
+        if (match = this.session.nonTokenRe.exec(rightOfCursor)) {
+            column += this.session.nonTokenRe.lastIndex;
+            this.session.nonTokenRe.lastIndex = 0;
+            rightOfCursor = line.substring(column);
+        }
+        
+        // if at line end proceed with next line
+        if (column >= line.length) {
+            this.moveCursorTo(row, line.length);
+            this.moveCursorRight();
+            if (row < this.doc.getLength() - 1)
+                this.moveCursorWordRight();
+            return;
+        }
+        
+        // advance to the end of the next token
+        if (match = this.session.tokenRe.exec(rightOfCursor)) {
+            column += this.session.tokenRe.lastIndex;
+            this.session.tokenRe.lastIndex = 0;
+        }
+
+        this.moveCursorTo(row, column);
+    };
+
+    this.moveCursorWordLeft = function() {
+        var row = this.selectionLead.row;
+        var column = this.selectionLead.column;
+
+        // skip folds
+        var fold;
+        if (fold = this.session.getFoldAt(row, column, -1)) {
+            this.moveCursorTo(fold.start.row, fold.start.column);
+            return;
+        }
+
+        var str = this.session.getFoldStringAt(row, column, -1);
+        if (str == null) {
+            str = this.doc.getLine(row).substring(0, column)
+        }
+        
+        var leftOfCursor = lang.stringReverse(str);
+        var match;
+        this.session.nonTokenRe.lastIndex = 0;
+        this.session.tokenRe.lastIndex = 0;
+        
+        // skip whitespace
+        if (match = this.session.nonTokenRe.exec(leftOfCursor)) {
+            column -= this.session.nonTokenRe.lastIndex;
+            leftOfCursor = leftOfCursor.slice(this.session.nonTokenRe.lastIndex);
+            this.session.nonTokenRe.lastIndex = 0;
+        }
+        
+        // if at begin of the line proceed in line above
+        if (column <= 0) {
+            this.moveCursorTo(row, 0);
+            this.moveCursorLeft();
+            if (row > 0)
+                this.moveCursorWordLeft();
+            return;
+        }
+
+        // move to the begin of the word
+        if (match = this.session.tokenRe.exec(leftOfCursor)) {
+            column -= this.session.tokenRe.lastIndex;
+            this.session.tokenRe.lastIndex = 0;
+        }
+
+        this.moveCursorTo(row, column);
+    };
+
+    this.moveCursorBy = function(rows, chars) {
+        var screenPos = this.session.documentToScreenPosition(
+            this.selectionLead.row,
+            this.selectionLead.column
+        );
+
+        var screenCol = (chars === 0 && this.$desiredColumn) || screenPos.column;
+        var docPos = this.session.screenToDocumentPosition(screenPos.row + rows, screenCol);
+
+        // move the cursor and update the desired column
+        this.moveCursorTo(docPos.row, docPos.column + chars, chars === 0);
+    };
+
+    this.moveCursorToPosition = function(position) {
+        this.moveCursorTo(position.row, position.column);
+    };
+
+    this.moveCursorTo = function(row, column, preventUpdateDesiredColumn) {
+        // Ensure the row/column is not inside of a fold.
+        var fold = this.session.getFoldAt(row, column, 1);
+        if (fold) {
+            row = fold.start.row;
+            column = fold.start.column;
+        }
+
+        this.$preventUpdateDesiredColumnOnChange = true;
+        this.selectionLead.setPosition(row, column);
+        this.$preventUpdateDesiredColumnOnChange = false;
+
+        if (!preventUpdateDesiredColumn)
+            this.$updateDesiredColumn(this.selectionLead.column);
+    };
+
+    this.moveCursorToScreen = function(row, column, preventUpdateDesiredColumn) {
+        var pos = this.session.screenToDocumentPosition(row, column);
+        row = pos.row;
+        column = pos.column;
+        this.moveCursorTo(row, column, preventUpdateDesiredColumn);
+    };
+
+}).call(Selection.prototype);
+
+exports.Selection = Selection;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/range', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var Range = function(startRow, startColumn, endRow, endColumn) {
+    this.start = {
+        row: startRow,
+        column: startColumn
+    };
+
+    this.end = {
+        row: endRow,
+        column: endColumn
+    };
+};
+
+(function() {
+    this.isEequal = function(range) {
+        return this.start.row == range.start.row &&
+            this.end.row == range.end.row &&
+            this.start.column == range.start.column &&
+            this.end.column == range.end.column
+    };
+
+    this.toString = function() {
+        return ("Range: [" + this.start.row + "/" + this.start.column +
+            "] -> [" + this.end.row + "/" + this.end.column + "]");
+    };
+
+    this.contains = function(row, column) {
+        return this.compare(row, column) == 0;
+    };
+
+    /**
+     * Compares this range (A) with another range (B), where B is the passed in
+     * range.
+     *
+     * Return values:
+     *  -2: (B) is infront of (A) and doesn't intersect with (A)
+     *  -1: (B) begins before (A) but ends inside of (A)
+     *   0: (B) is completly inside of (A) OR (A) is complety inside of (B)
+     *  +1: (B) begins inside of (A) but ends outside of (A)
+     *  +2: (B) is after (A) and doesn't intersect with (A)
+     *
+     *  42: FTW state: (B) ends in (A) but starts outside of (A)
+     */
+    this.compareRange = function(range) {
+        var cmp,
+            end = range.end,
+            start = range.start;
+
+        cmp = this.compare(end.row, end.column);
+        if (cmp == 1) {
+            cmp = this.compare(start.row, start.column);
+            if (cmp == 1) {
+                return 2;
+            } else if (cmp == 0) {
+                return 1;
+            } else {
+                return 0;
+            }
+        } else if (cmp == -1) {
+            return -2;
+        } else {
+            cmp = this.compare(start.row, start.column);
+            if (cmp == -1) {
+                return -1;
+            } else if (cmp == 1) {
+                return 42;
+            } else {
+                return 0;
+            }
+        }
+    }
+
+    this.comparePoint = function(p) {
+        return this.compare(p.row, p.column);
+    }
+
+    this.containsRange = function(range) {
+        return this.comparePoint(range.start) == 0 && this.comparePoint(range.end) == 0;
+    }
+
+    this.isEnd = function(row, column) {
+        return this.end.row == row && this.end.column == column;
+    }
+
+    this.isStart = function(row, column) {
+        return this.start.row == row && this.start.column == column;
+    }
+
+    this.setStart = function(row, column) {
+        if (typeof row == "object") {
+            this.start.column = row.column;
+            this.start.row = row.row;
+        } else {
+            this.start.row = row;
+            this.start.column = column;
+        }
+    }
+
+    this.setEnd = function(row, column) {
+        if (typeof row == "object") {
+            this.end.column = row.column;
+            this.end.row = row.row;
+        } else {
+            this.end.row = row;
+            this.end.column = column;
+        }
+    }
+
+    this.inside = function(row, column) {
+        if (this.compare(row, column) == 0) {
+            if (this.isEnd(row, column) || this.isStart(row, column)) {
+                return false;
+            } else {
+                return true;
+            }
+        }
+        return false;
+    }
+
+    this.insideStart = function(row, column) {
+        if (this.compare(row, column) == 0) {
+            if (this.isEnd(row, column)) {
+                return false;
+            } else {
+                return true;
+            }
+        }
+        return false;
+    }
+
+    this.insideEnd = function(row, column) {
+        if (this.compare(row, column) == 0) {
+            if (this.isStart(row, column)) {
+                return false;
+            } else {
+                return true;
+            }
+        }
+        return false;
+    }
+
+    this.compare = function(row, column) {
+        if (!this.isMultiLine()) {
+            if (row === this.start.row) {
+                return column < this.start.column ? -1 : (column > this.end.column ? 1 : 0);
+            };
+        }
+
+        if (row < this.start.row)
+            return -1;
+
+        if (row > this.end.row)
+            return 1;
+
+        if (this.start.row === row)
+            return column >= this.start.column ? 0 : -1;
+
+        if (this.end.row === row)
+            return column <= this.end.column ? 0 : 1;
+
+        return 0;
+    };
+
+    /**
+     * Like .compare(), but if isStart is true, return -1;
+     */
+    this.compareStart = function(row, column) {
+        if (this.start.row == row && this.start.column == column) {
+            return -1;
+        } else {
+            return this.compare(row, column);
+        }
+    }
+
+    /**
+     * Like .compare(), but if isEnd is true, return 1;
+     */
+    this.compareEnd = function(row, column) {
+        if (this.end.row == row && this.end.column == column) {
+            return 1;
+        } else {
+            return this.compare(row, column);
+        }
+    }
+
+    this.compareInside = function(row, column) {
+        if (this.end.row == row && this.end.column == column) {
+            return 1;
+        } else if (this.start.row == row && this.start.column == column) {
+            return -1;
+        } else {
+            return this.compare(row, column);
+        }
+    }
+
+    this.clipRows = function(firstRow, lastRow) {
+        if (this.end.row > lastRow) {
+            var end = {
+                row: lastRow+1,
+                column: 0
+            };
+        }
+
+        if (this.start.row > lastRow) {
+            var start = {
+                row: lastRow+1,
+                column: 0
+            };
+        }
+
+        if (this.start.row < firstRow) {
+            var start = {
+                row: firstRow,
+                column: 0
+            };
+        }
+
+        if (this.end.row < firstRow) {
+            var end = {
+                row: firstRow,
+                column: 0
+            };
+        }
+        return Range.fromPoints(start || this.start, end || this.end);
+    };
+
+    this.extend = function(row, column) {
+        var cmp = this.compare(row, column);
+
+        if (cmp == 0)
+            return this;
+        else if (cmp == -1)
+            var start = {row: row, column: column};
+        else
+            var end = {row: row, column: column};
+
+        return Range.fromPoints(start || this.start, end || this.end);
+    };
+
+    this.isEmpty = function() {
+        return (this.start.row == this.end.row && this.start.column == this.end.column);
+    };
+
+    this.isMultiLine = function() {
+        return (this.start.row !== this.end.row);
+    };
+
+    this.clone = function() {
+        return Range.fromPoints(this.start, this.end);
+    };
+
+    this.collapseRows = function() {
+        if (this.end.column == 0)
+            return new Range(this.start.row, 0, Math.max(this.start.row, this.end.row-1), 0)
+        else
+            return new Range(this.start.row, 0, this.end.row, 0)
+    };
+
+    this.toScreenRange = function(session) {
+        var screenPosStart =
+            session.documentToScreenPosition(this.start);
+        var screenPosEnd =
+            session.documentToScreenPosition(this.end);
+
+        return new Range(
+            screenPosStart.row, screenPosStart.column,
+            screenPosEnd.row, screenPosEnd.column
+        );
+    };
+
+}).call(Range.prototype);
+
+
+Range.fromPoints = function(start, end) {
+    return new Range(start.row, start.column, end.row, end.column);
+};
+
+exports.Range = Range;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai DOT sucan AT gmail DOT com>
+ *      Chris Spencer <chris.ag.spencer AT googlemail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mode/text', ['require', 'exports', 'module' , 'ace/tokenizer', 'ace/mode/text_highlight_rules', 'ace/mode/behaviour', 'ace/unicode'], function(require, exports, module) {
+
+var Tokenizer = require("../tokenizer").Tokenizer;
+var TextHighlightRules = require("./text_highlight_rules").TextHighlightRules;
+var Behaviour = require("./behaviour").Behaviour;
+var unicode = require("../unicode");
+
+var Mode = function() {
+    this.$tokenizer = new Tokenizer(new TextHighlightRules().getRules());
+    this.$behaviour = new Behaviour();
+};
+
+(function() {
+
+    this.tokenRe = new RegExp("^["
+        + unicode.packages.L
+        + unicode.packages.Mn + unicode.packages.Mc
+        + unicode.packages.Nd
+        + unicode.packages.Pc + "\\$_]+", "g"
+    );
+    
+    this.nonTokenRe = new RegExp("^(?:[^"
+        + unicode.packages.L
+        + unicode.packages.Mn + unicode.packages.Mc
+        + unicode.packages.Nd
+        + unicode.packages.Pc + "\\$_]|\s])+", "g"
+    );
+
+    this.getTokenizer = function() {
+        return this.$tokenizer;
+    };
+
+    this.toggleCommentLines = function(state, doc, startRow, endRow) {
+    };
+
+    this.getNextLineIndent = function(state, line, tab) {
+        return "";
+    };
+
+    this.checkOutdent = function(state, line, input) {
+        return false;
+    };
+
+    this.autoOutdent = function(state, doc, row) {
+    };
+
+    this.$getIndent = function(line) {
+        var match = line.match(/^(\s+)/);
+        if (match) {
+            return match[1];
+        }
+
+        return "";
+    };
+    
+    this.createWorker = function(session) {
+        return null;
+    };
+
+    this.highlightSelection = function(editor) {
+        var session = editor.session;
+        if (!session.$selectionOccurrences)
+            session.$selectionOccurrences = [];
+
+        if (session.$selectionOccurrences.length)
+            this.clearSelectionHighlight(editor);
+
+        var selection = editor.getSelectionRange();
+        if (selection.isEmpty() || selection.isMultiLine())
+            return;
+
+        var startOuter = selection.start.column - 1;
+        var endOuter = selection.end.column + 1;
+        var line = session.getLine(selection.start.row);
+        var lineCols = line.length;
+        var needle = line.substring(Math.max(startOuter, 0),
+                                    Math.min(endOuter, lineCols));
+
+        // Make sure the outer characters are not part of the word.
+        if ((startOuter >= 0 && /^[\w\d]/.test(needle)) ||
+            (endOuter <= lineCols && /[\w\d]$/.test(needle)))
+            return;
+
+        needle = line.substring(selection.start.column, selection.end.column);
+        if (!/^[\w\d]+$/.test(needle))
+            return;
+
+        var cursor = editor.getCursorPosition();
+
+        var newOptions = {
+            wrap: true,
+            wholeWord: true,
+            caseSensitive: true,
+            needle: needle
+        };
+
+        var currentOptions = editor.$search.getOptions();
+        editor.$search.set(newOptions);
+
+        var ranges = editor.$search.findAll(session);
+        ranges.forEach(function(range) {
+            if (!range.contains(cursor.row, cursor.column)) {
+                var marker = session.addMarker(range, "ace_selected_word", "text");
+                session.$selectionOccurrences.push(marker);
+            }
+        });
+
+        editor.$search.set(currentOptions);
+    };
+
+    this.clearSelectionHighlight = function(editor) {
+        if (!editor.session.$selectionOccurrences)
+            return;
+
+        editor.session.$selectionOccurrences.forEach(function(marker) {
+            editor.session.removeMarker(marker);
+        });
+
+        editor.session.$selectionOccurrences = [];
+    };
+    
+    this.createModeDelegates = function (mapping) {
+        if (!this.$embeds) {
+            return;
+        }
+        this.$modes = {};
+        for (var i = 0; i < this.$embeds.length; i++) {
+            if (mapping[this.$embeds[i]]) {
+                this.$modes[this.$embeds[i]] = new mapping[this.$embeds[i]]();
+            }
+        }
+        
+        var delegations = ['toggleCommentLines', 'getNextLineIndent', 'checkOutdent', 'autoOutdent', 'transformAction'];
+
+        for (var i = 0; i < delegations.length; i++) {
+            (function(scope) {
+              var functionName = delegations[i];
+              var defaultHandler = scope[functionName];
+              scope[delegations[i]] = function() {
+                  return this.$delegator(functionName, arguments, defaultHandler);
+              }
+            } (this));
+        }
+    }
+    
+    this.$delegator = function(method, args, defaultHandler) {
+        var state = args[0];
+        
+        for (var i = 0; i < this.$embeds.length; i++) {
+            if (!this.$modes[this.$embeds[i]]) continue;
+            
+            var split = state.split(this.$embeds[i]);
+            if (!split[0] && split[1]) {
+                args[0] = split[1];
+                var mode = this.$modes[this.$embeds[i]];
+                return mode[method].apply(mode, args);
+            }
+        }
+        var ret = defaultHandler.apply(this, args);
+        return defaultHandler ? ret : undefined;
+    };
+    
+    this.transformAction = function(state, action, editor, session, param) {
+        if (this.$behaviour) {
+            var behaviours = this.$behaviour.getBehaviours();
+            for (var key in behaviours) {
+                if (behaviours[key][action]) {
+                    var ret = behaviours[key][action].apply(this, arguments);
+                    if (ret) {
+                        return ret;
+                    }
+                }
+            }
+        }
+    }
+    
+}).call(Mode.prototype);
+
+exports.Mode = Mode;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/tokenizer', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var Tokenizer = function(rules, flag) {
+    flag = flag ? "g" + flag : "g";
+    this.rules = rules;
+
+    this.regExps = {};
+    this.matchMappings = {};
+    for ( var key in this.rules) {
+        var rule = this.rules[key];
+        var state = rule;
+        var ruleRegExps = [];
+        var matchTotal = 0;
+        var mapping = this.matchMappings[key] = {};
+        
+        for ( var i = 0; i < state.length; i++) {
+            // Count number of matching groups. 2 extra groups from the full match
+            // And the catch-all on the end (used to force a match);
+            var matchcount = new RegExp("(?:(" + state[i].regex + ")|(.))").exec("a").length - 2;
+        
+            // Replace any backreferences and offset appropriately.
+            var adjustedregex = state[i].regex.replace(/\\([0-9]+)/g, function (match, digit) {
+                return "\\" + (parseInt(digit, 10) + matchTotal + 1);
+            });
+            
+            mapping[matchTotal] = {
+                rule: i,
+                len: matchcount
+            };
+            matchTotal += matchcount;
+            
+            ruleRegExps.push(adjustedregex);
+        }
+
+        this.regExps[key] = new RegExp("(?:(" + ruleRegExps.join(")|(") + ")|(.))", flag);
+    }
+};
+
+(function() {
+
+    this.getLineTokens = function(line, startState) {
+        var currentState = startState;
+        var state = this.rules[currentState];
+        var mapping = this.matchMappings[currentState];
+        var re = this.regExps[currentState];
+        re.lastIndex = 0;
+        
+        var match, tokens = [];
+        
+        var lastIndex = 0;
+        
+        var token = {
+            type: null,
+            value: ""
+        };
+        
+        while (match = re.exec(line)) {
+            var type = "text";
+            var rule = null;
+            var value = [match[0]];
+
+            for (var i = 0; i < match.length-2; i++) {
+                if (match[i + 1] !== undefined) {
+                    rule = state[mapping[i].rule];
+                    
+                    if (mapping[i].len > 1) {
+                        value = match.slice(i+2, i+1+mapping[i].len);
+                    }
+                    
+                    // compute token type
+                    if (typeof rule.token == "function")
+                        type = rule.token.apply(this, value);
+                    else
+                        type = rule.token;
+
+                    var next = rule.next;                    
+                    if (next && next !== currentState) {
+                        currentState = next;
+                        state = this.rules[currentState];
+                        mapping = this.matchMappings[currentState];
+                        lastIndex = re.lastIndex;
+
+                        re = this.regExps[currentState];
+                        re.lastIndex = lastIndex;
+                    }
+                    break;
+                }
+            }
+
+            if (value[0]) {
+                if (typeof type == "string") {
+                    value = [value.join("")];
+                    type = [type];
+                }
+                for (var i = 0; i < value.length; i++) {
+                    if ((!rule || rule.merge || type[i] === "text") && token.type === type[i]) {
+                        token.value += value[i];
+                    } else {
+                        if (token.type) {
+                            tokens.push(token);
+                        }
+                    
+                        token = {
+                            type: type[i],
+                            value: value[i]
+                        };
+                    }
+                }
+            }
+            
+            if (lastIndex == line.length)
+                break;
+            
+            lastIndex = re.lastIndex;
+        }
+
+        if (token.type)
+            tokens.push(token);
+
+        return {
+            tokens : tokens,
+            state : currentState
+        };
+    };
+
+}).call(Tokenizer.prototype);
+
+exports.Tokenizer = Tokenizer;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mode/text_highlight_rules', ['require', 'exports', 'module' , 'ace/lib/lang'], function(require, exports, module) {
+
+var lang = require("../lib/lang");
+
+var TextHighlightRules = function() {
+
+    // regexp must not have capturing parentheses
+    // regexps are ordered -> the first match is used
+
+    this.$rules = {
+        "start" : [{
+            token : "empty_line",
+            regex : '^$'
+        }, {
+            token : "text",
+            regex : ".+"
+        }]
+    };
+};
+
+(function() {
+
+    this.addRules = function(rules, prefix) {
+        for (var key in rules) {
+            var state = rules[key];
+            for (var i=0; i<state.length; i++) {
+                var rule = state[i];
+                if (rule.next) {
+                    rule.next = prefix + rule.next;
+                } else {
+                    rule.next = prefix + key;
+                }
+            }
+            this.$rules[prefix + key] = state;
+        }
+    };
+
+    this.getRules = function() {
+        return this.$rules;
+    };
+    
+    this.embedRules = function (HighlightRules, prefix, escapeRules, states) {
+        var embedRules = new HighlightRules().getRules();
+        if (states) {
+            for (var i = 0; i < states.length; i++) {
+                states[i] = prefix + states[i];
+            }
+        } else {
+            states = [];
+            for (var key in embedRules) {
+                states.push(prefix + key);
+            }
+        }
+        this.addRules(embedRules, prefix);
+        
+        for (var i = 0; i < states.length; i++) {
+            Array.prototype.unshift.apply(this.$rules[states[i]], lang.deepCopy(escapeRules));
+        }
+        
+        if (!this.$embeds) {
+            this.$embeds = [];
+        }
+        this.$embeds.push(prefix);
+    }
+    
+    this.getEmbeds = function() {
+        return this.$embeds;
+    }
+
+}).call(TextHighlightRules.prototype);
+
+exports.TextHighlightRules = TextHighlightRules;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Chris Spencer <chris.ag.spencer AT googlemail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/mode/behaviour', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var Behaviour = function() {
+   this.$behaviours = {};
+};
+
+(function () {
+
+    this.add = function (name, action, callback) {
+        switch (undefined) {
+          case this.$behaviours:
+              this.$behaviours = {};
+          case this.$behaviours[name]:
+              this.$behaviours[name] = {};
+        }
+        this.$behaviours[name][action] = callback;
+    }
+    
+    this.addBehaviours = function (behaviours) {
+        for (var key in behaviours) {
+            for (var action in behaviours[key]) {
+                this.add(key, action, behaviours[key][action]);
+            }
+        }
+    }
+    
+    this.remove = function (name) {
+        if (this.$behaviours && this.$behaviours[name]) {
+            delete this.$behaviours[name];
+        }
+    }
+    
+    this.inherit = function (mode, filter) {
+        if (typeof mode === "function") {
+            var behaviours = new mode().getBehaviours(filter);
+        } else {
+            var behaviours = mode.getBehaviours(filter);
+        }
+        this.addBehaviours(behaviours);
+    }
+    
+    this.getBehaviours = function (filter) {
+        if (!filter) {
+            return this.$behaviours;
+        } else {
+            var ret = {}
+            for (var i = 0; i < filter.length; i++) {
+                if (this.$behaviours[filter[i]]) {
+                    ret[filter[i]] = this.$behaviours[filter[i]];
+                }
+            }
+            return ret;
+        }
+    }
+
+}).call(Behaviour.prototype);
+
+exports.Behaviour = Behaviour;
+});define('ace/unicode', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+/*
+XRegExp Unicode plugin pack: Categories 1.0
+(c) 2010 Steven Levithan
+MIT License
+<http://xregexp.com>
+Uses the Unicode 5.2 character database
+
+This package for the XRegExp Unicode plugin enables the following Unicode categories (aka properties):
+
+L - Letter (the top-level Letter category is included in the Unicode plugin base script)
+    Ll - Lowercase letter
+    Lu - Uppercase letter
+    Lt - Titlecase letter
+    Lm - Modifier letter
+    Lo - Letter without case
+M - Mark
+    Mn - Non-spacing mark
+    Mc - Spacing combining mark
+    Me - Enclosing mark
+N - Number
+    Nd - Decimal digit
+    Nl - Letter number
+    No -  Other number
+P - Punctuation
+    Pd - Dash punctuation
+    Ps - Open punctuation
+    Pe - Close punctuation
+    Pi - Initial punctuation
+    Pf - Final punctuation
+    Pc - Connector punctuation
+    Po - Other punctuation
+S - Symbol
+    Sm - Math symbol
+    Sc - Currency symbol
+    Sk - Modifier symbol
+    So - Other symbol
+Z - Separator
+    Zs - Space separator
+    Zl - Line separator
+    Zp - Paragraph separator
+C - Other
+    Cc - Control
+    Cf - Format
+    Co - Private use
+    Cs - Surrogate
+    Cn - Unassigned
+
+Example usage:
+
+    \p{N}
+    \p{Cn}
+*/
+
+
+// will be populated by addUnicodePackage
+exports.packages = {};
+
+addUnicodePackage({
+    L:  "0041-005A0061-007A00AA00B500BA00C0-00D600D8-00F600F8-02C102C6-02D102E0-02E402EC02EE0370-037403760377037A-037D03860388-038A038C038E-03A103A3-03F503F7-0481048A-05250531-055605590561-058705D0-05EA05F0-05F20621-064A066E066F0671-06D306D506E506E606EE06EF06FA-06FC06FF07100712-072F074D-07A507B107CA-07EA07F407F507FA0800-0815081A082408280904-0939093D09500958-0961097109720979-097F0985-098C098F09900993-09A809AA-09B009B209B6-09B909BD09CE09DC09DD09DF-09E109F009F10A05-0A0A0A0F0A100A13-0A280A2A-0A300A320A330A350A360A380A390A59-0A5C0A5E0A72-0A740A85-0A8D0A8F-0A910A93-0AA80AAA-0AB00AB20AB30AB5-0AB90ABD0AD00AE00AE10B05-0B0C0B0F0B100B13-0B280B2A-0B300B320B330B35-0B390B3D0B5C0B5D0B5F-0B610B710B830B85-0B8A0B8E-0B900B92-0B950B990B9A0B9C0B9E0B9F0BA30BA40BA8-0BAA0BAE-0BB90BD00C05-0C0C0C0E-0C100C12-0C280C2A-0C330C35-0C390C3D0C580C590C600C610C85-0C8C0C8E-0C900C92-0CA80CAA-0CB30CB5-0CB90CBD0CDE0CE00CE10D05-0D0C0D0E-0D100D12-0D280D2A-0D390D3D0D600D610D7A-0D7F0D85-0D960D9A-0DB10DB3-0DBB0DBD0DC0-
 0DC60E01-0E300E320E330E40-0E460E810E820E840E870E880E8A0E8D0E94-0E970E99-0E9F0EA1-0EA30EA50EA70EAA0EAB0EAD-0EB00EB20EB30EBD0EC0-0EC40EC60EDC0EDD0F000F40-0F470F49-0F6C0F88-0F8B1000-102A103F1050-1055105A-105D106110651066106E-10701075-1081108E10A0-10C510D0-10FA10FC1100-1248124A-124D1250-12561258125A-125D1260-1288128A-128D1290-12B012B2-12B512B8-12BE12C012C2-12C512C8-12D612D8-13101312-13151318-135A1380-138F13A0-13F41401-166C166F-167F1681-169A16A0-16EA1700-170C170E-17111720-17311740-17511760-176C176E-17701780-17B317D717DC1820-18771880-18A818AA18B0-18F51900-191C1950-196D1970-19741980-19AB19C1-19C71A00-1A161A20-1A541AA71B05-1B331B45-1B4B1B83-1BA01BAE1BAF1C00-1C231C4D-1C4F1C5A-1C7D1CE9-1CEC1CEE-1CF11D00-1DBF1E00-1F151F18-1F1D1F20-1F451F48-1F4D1F50-1F571F591F5B1F5D1F5F-1F7D1F80-1FB41FB6-1FBC1FBE1FC2-1FC41FC6-1FCC1FD0-1FD31FD6-1FDB1FE0-1FEC1FF2-1FF41FF6-1FFC2071207F2090-209421022107210A-211321152119-211D212421262128212A-212D212F-2139213C-213F2145-2149214E218321842C00-2C2E2C30-2C5E2C60-2
 CE42CEB-2CEE2D00-2D252D30-2D652D6F2D80-2D962DA0-2DA62DA8-2DAE2DB0-2DB+    Ll: "0061-007A00AA00B500BA00DF-00F600F8-00FF01010103010501070109010B010D010F01110113011501170119011B011D011F01210123012501270129012B012D012F01310133013501370138013A013C013E014001420144014601480149014B014D014F01510153015501570159015B015D015F01610163016501670169016B016D016F0171017301750177017A017C017E-0180018301850188018C018D019201950199-019B019E01A101A301A501A801AA01AB01AD01B001B401B601B901BA01BD-01BF01C601C901CC01CE01D001D201D401D601D801DA01DC01DD01DF01E101E301E501E701E901EB01ED01EF01F001F301F501F901FB01FD01FF02010203020502070209020B020D020F02110213021502170219021B021D021F02210223022502270229022B022D022F02310233-0239023C023F0240024202470249024B024D024F-02930295-02AF037103730377037B-037D039003AC-03CE03D003D103D5-03D703D903DB03DD03DF03E103E303E503E703E903EB03ED03EF-03F303F503F803FB03FC0430-045F04610463046504670469046B046D046F04710473047504770479047B047D047F0481048B048D048F04910493049504970499049B049D049F04A104A304A504A704A904AB04AD04AF04B104B304B504B704B904BB04BD04BF04C204
 C404C604C804CA04CC04CE04CF04D104D304D504D704D904DB04DD04DF04E104E304E504E704E904EB04ED04EF04F104F304F504F704F904FB04FD04FF05010503050505070509050B050D050F05110513051505170519051B051D051F0521052305250561-05871D00-1D2B1D62-1D771D79-1D9A1E011E031E051E071E091E0B1E0D1E0F1E111E131E151E171E191E1B1E1D1E1F1E211E231E251E271E291E2B1E2D1E2F1E311E331E351E371E391E3B1E3D1E3F1E411E431E451E471E491E4B1E4D1E4F1E511E531E551E571E591E5B1E5D1E5F1E611E631E651E671E691E6B1E6D1E6F1E711E731E751E771E791E7B1E7D1E7F1E811E831E851E871E891E8B1E8D1E8F1E911E931E95-1E9D1E9F1EA11EA31EA51EA71EA91EAB1EAD1EAF1EB11EB31EB51EB71EB91EBB1EBD1EBF1EC11EC31EC51EC71EC91ECB1ECD1ECF1ED11ED31ED51ED71ED91EDB1EDD1EDF1EE11EE31EE51EE71EE91EEB1EED1EEF1EF11EF31EF51EF71EF91EFB1EFD1EFF-1F071F10-1F151F20-1F271F30-1F371F40-1F451F50-1F571F60-1F671F70-1F7D1F80-1F871F90-1F971FA0-1FA71FB0-1FB41FB61FB71FBE1FC2-1FC41FC61FC71FD0-1FD31FD61FD71FE0-1FE71FF2-1FF41FF61FF7210A210E210F2113212F21342139213C213D2146-2149214E21842C30-2C5E2C612C652C662C68
 2C6A2C6C2C712C732C742C76-2C7C2C812C832C852C872C892C8B2C8D2C8F2C912C93+    Lu: "0041-005A00C0-00D600D8-00DE01000102010401060108010A010C010E01100112011401160118011A011C011E01200122012401260128012A012C012E01300132013401360139013B013D013F0141014301450147014A014C014E01500152015401560158015A015C015E01600162016401660168016A016C016E017001720174017601780179017B017D018101820184018601870189-018B018E-0191019301940196-0198019C019D019F01A001A201A401A601A701A901AC01AE01AF01B1-01B301B501B701B801BC01C401C701CA01CD01CF01D101D301D501D701D901DB01DE01E001E201E401E601E801EA01EC01EE01F101F401F6-01F801FA01FC01FE02000202020402060208020A020C020E02100212021402160218021A021C021E02200222022402260228022A022C022E02300232023A023B023D023E02410243-02460248024A024C024E03700372037603860388-038A038C038E038F0391-03A103A3-03AB03CF03D2-03D403D803DA03DC03DE03E003E203E403E603E803EA03EC03EE03F403F703F903FA03FD-042F04600462046404660468046A046C046E04700472047404760478047A047C047E0480048A048C048E04900492049404960498049A049C049E04A004A204A404A604A804AA04AC04AE04B004B204B404B604B804BA04BC04
 BE04C004C104C304C504C704C904CB04CD04D004D204D404D604D804DA04DC04DE04E004E204E404E604E804EA04EC04EE04F004F204F404F604F804FA04FC04FE05000502050405060508050A050C050E05100512051405160518051A051C051E0520052205240531-055610A0-10C51E001E021E041E061E081E0A1E0C1E0E1E101E121E141E161E181E1A1E1C1E1E1E201E221E241E261E281E2A1E2C1E2E1E301E321E341E361E381E3A1E3C1E3E1E401E421E441E461E481E4A1E4C1E4E1E501E521E541E561E581E5A1E5C1E5E1E601E621E641E661E681E6A1E6C1E6E1E701E721E741E761E781E7A1E7C1E7E1E801E821E841E861E881E8A1E8C1E8E1E901E921E941E9E1EA01EA21EA41EA61EA81EAA1EAC1EAE1EB01EB21EB41EB61EB81EBA1EBC1EBE1EC01EC21EC41EC61EC81ECA1ECC1ECE1ED01ED21ED41ED61ED81EDA1EDC1EDE1EE01EE21EE41EE61EE81EEA1EEC1EEE1EF01EF21EF41EF61EF81EFA1EFC1EFE1F08-1F0F1F18-1F1D1F28-1F2F1F38-1F3F1F48-1F4D1F591F5B1F5D1F5F1F68-1F6F1FB8-1FBB1FC8-1FCB1FD8-1FDB1FE8-1FEC1FF8-1FFB21022107210B-210D2110-211221152119-211D212421262128212A-212D2130-2133213E213F214521832C00-2C2E2C602C62-2C642C672C692C6B2C6D-2C702C722C752C7E-2C802C822C842
 C862C882C8A2C8C2C8E2C902C922C942C962C982C9A2C9C2C9E2CA02CA22CA42CA62C+    Lt: "01C501C801CB01F21F88-1F8F1F98-1F9F1FA8-1FAF1FBC1FCC1FFC",
+    Lm: "02B0-02C102C6-02D102E0-02E402EC02EE0374037A0559064006E506E607F407F507FA081A0824082809710E460EC610FC17D718431AA71C78-1C7D1D2C-1D611D781D9B-1DBF2071207F2090-20942C7D2D6F2E2F30053031-3035303B309D309E30FC-30FEA015A4F8-A4FDA60CA67FA717-A71FA770A788A9CFAA70AADDFF70FF9EFF9F",
+    Lo: "01BB01C0-01C3029405D0-05EA05F0-05F20621-063F0641-064A066E066F0671-06D306D506EE06EF06FA-06FC06FF07100712-072F074D-07A507B107CA-07EA0800-08150904-0939093D09500958-096109720979-097F0985-098C098F09900993-09A809AA-09B009B209B6-09B909BD09CE09DC09DD09DF-09E109F009F10A05-0A0A0A0F0A100A13-0A280A2A-0A300A320A330A350A360A380A390A59-0A5C0A5E0A72-0A740A85-0A8D0A8F-0A910A93-0AA80AAA-0AB00AB20AB30AB5-0AB90ABD0AD00AE00AE10B05-0B0C0B0F0B100B13-0B280B2A-0B300B320B330B35-0B390B3D0B5C0B5D0B5F-0B610B710B830B85-0B8A0B8E-0B900B92-0B950B990B9A0B9C0B9E0B9F0BA30BA40BA8-0BAA0BAE-0BB90BD00C05-0C0C0C0E-0C100C12-0C280C2A-0C330C35-0C390C3D0C580C590C600C610C85-0C8C0C8E-0C900C92-0CA80CAA-0CB30CB5-0CB90CBD0CDE0CE00CE10D05-0D0C0D0E-0D100D12-0D280D2A-0D390D3D0D600D610D7A-0D7F0D85-0D960D9A-0DB10DB3-0DBB0DBD0DC0-0DC60E01-0E300E320E330E40-0E450E810E820E840E870E880E8A0E8D0E94-0E970E99-0E9F0EA1-0EA30EA50EA70EAA0EAB0EAD-0EB00EB20EB30EBD0EC0-0EC40EDC0EDD0F000F40-0F470F49-0F6C0F88-0F8B1000-102A103F1050-105510
 5A-105D106110651066106E-10701075-1081108E10D0-10FA1100-1248124A-124D1250-12561258125A-125D1260-1288128A-128D1290-12B012B2-12B512B8-12BE12C012C2-12C512C8-12D612D8-13101312-13151318-135A1380-138F13A0-13F41401-166C166F-167F1681-169A16A0-16EA1700-170C170E-17111720-17311740-17511760-176C176E-17701780-17B317DC1820-18421844-18771880-18A818AA18B0-18F51900-191C1950-196D1970-19741980-19AB19C1-19C71A00-1A161A20-1A541B05-1B331B45-1B4B1B83-1BA01BAE1BAF1C00-1C231C4D-1C4F1C5A-1C771CE9-1CEC1CEE-1CF12135-21382D30-2D652D80-2D962DA0-2DA62DA8-2DAE2DB0-2DB62DB8-2DBE2DC0-2DC62DC8-2DCE2DD0-2DD62DD8-2DDE3006303C3041-3096309F30A1-30FA30FF3105-312D3131-318E31A0-31B731F0-31FF3400-4DB54E00-9FCBA000-A014A016-A48CA4D0-A4F7A500-A60BA610-A61FA62AA62BA66EA6A0-A6E5A7FB-A801A803-A805A807-A80AA80C-A822A840-A873A882-A8B3A8F2-A8F7A8FBA90A-A925A930-A946A960-A97CA984-A9B2AA00-AA28AA40-AA42AA44-AA4BAA60-AA6FAA71-AA76AA7AAA80-AAAFAAB1AAB5AAB6AAB9-AABDAAC0AAC2AADBAADCABC0-ABE2AC00-D7A3D7B0-D7C6D7CB-D7FBF900-FA2DFA30-
 FA6DFA70-FAD9FB1DFB1F-FB28FB2A-FB36FB38-FB3CFB3EFB40FB41FB43FB44FB46-+    M:  "0300-036F0483-04890591-05BD05BF05C105C205C405C505C70610-061A064B-065E067006D6-06DC06DE-06E406E706E806EA-06ED07110730-074A07A6-07B007EB-07F30816-0819081B-08230825-08270829-082D0900-0903093C093E-094E0951-0955096209630981-098309BC09BE-09C409C709C809CB-09CD09D709E209E30A01-0A030A3C0A3E-0A420A470A480A4B-0A4D0A510A700A710A750A81-0A830ABC0ABE-0AC50AC7-0AC90ACB-0ACD0AE20AE30B01-0B030B3C0B3E-0B440B470B480B4B-0B4D0B560B570B620B630B820BBE-0BC20BC6-0BC80BCA-0BCD0BD70C01-0C030C3E-0C440C46-0C480C4A-0C4D0C550C560C620C630C820C830CBC0CBE-0CC40CC6-0CC80CCA-0CCD0CD50CD60CE20CE30D020D030D3E-0D440D46-0D480D4A-0D4D0D570D620D630D820D830DCA0DCF-0DD40DD60DD8-0DDF0DF20DF30E310E34-0E3A0E47-0E4E0EB10EB4-0EB90EBB0EBC0EC8-0ECD0F180F190F350F370F390F3E0F3F0F71-0F840F860F870F90-0F970F99-0FBC0FC6102B-103E1056-1059105E-10601062-10641067-106D1071-10741082-108D108F109A-109D135F1712-17141732-1734175217531772177317B6-17D317DD180B-180D18A91920-192B1930-193B19B0-19C019C819C91A17-1A1B1A55-1A5E1A60-1A7C1A7F1
 B00-1B041B34-1B441B6B-1B731B80-1B821BA1-1BAA1C24-1C371CD0-1CD21CD4-1CE81CED1CF21DC0-1DE61DFD-1DFF20D0-20F02CEF-2CF12DE0-2DFF302A-302F3099309AA66F-A672A67CA67DA6F0A6F1A802A806A80BA823-A827A880A881A8B4-A8C4A8E0-A8F1A926-A92DA947-A953A980-A983A9B3-A9C0AA29-AA36AA43AA4CAA4DAA7BAAB0AAB2-AAB4AAB7AAB8AABEAABFAAC1ABE3-ABEAABECABEDFB1EFE00-FE0FFE20-FE26",
+    Mn: "0300-036F0483-04870591-05BD05BF05C105C205C405C505C70610-061A064B-065E067006D6-06DC06DF-06E406E706E806EA-06ED07110730-074A07A6-07B007EB-07F30816-0819081B-08230825-08270829-082D0900-0902093C0941-0948094D0951-095509620963098109BC09C1-09C409CD09E209E30A010A020A3C0A410A420A470A480A4B-0A4D0A510A700A710A750A810A820ABC0AC1-0AC50AC70AC80ACD0AE20AE30B010B3C0B3F0B41-0B440B4D0B560B620B630B820BC00BCD0C3E-0C400C46-0C480C4A-0C4D0C550C560C620C630CBC0CBF0CC60CCC0CCD0CE20CE30D41-0D440D4D0D620D630DCA0DD2-0DD40DD60E310E34-0E3A0E47-0E4E0EB10EB4-0EB90EBB0EBC0EC8-0ECD0F180F190F350F370F390F71-0F7E0F80-0F840F860F870F90-0F970F99-0FBC0FC6102D-10301032-10371039103A103D103E10581059105E-10601071-1074108210851086108D109D135F1712-17141732-1734175217531772177317B7-17BD17C617C9-17D317DD180B-180D18A91920-19221927192819321939-193B1A171A181A561A58-1A5E1A601A621A65-1A6C1A73-1A7C1A7F1B00-1B031B341B36-1B3A1B3C1B421B6B-1B731B801B811BA2-1BA51BA81BA91C2C-1C331C361C371CD0-1CD21CD4-1CE01CE2-1CE81CED1DC0-1DE61D
 FD-1DFF20D0-20DC20E120E5-20F02CEF-2CF12DE0-2DFF302A-302F3099309AA66FA67CA67DA6F0A6F1A802A806A80BA825A826A8C4A8E0-A8F1A926-A92DA947-A951A980-A982A9B3A9B6-A9B9A9BCAA29-AA2EAA31AA32AA35AA36AA43AA4CAAB0AAB2-AAB4AAB7AAB8AABEAABFAAC1ABE5ABE8ABEDFB1EFE00-FE0FFE20-FE26",
+    Mc: "0903093E-09400949-094C094E0982098309BE-09C009C709C809CB09CC09D70A030A3E-0A400A830ABE-0AC00AC90ACB0ACC0B020B030B3E0B400B470B480B4B0B4C0B570BBE0BBF0BC10BC20BC6-0BC80BCA-0BCC0BD70C01-0C030C41-0C440C820C830CBE0CC0-0CC40CC70CC80CCA0CCB0CD50CD60D020D030D3E-0D400D46-0D480D4A-0D4C0D570D820D830DCF-0DD10DD8-0DDF0DF20DF30F3E0F3F0F7F102B102C10311038103B103C105610571062-10641067-106D108310841087-108C108F109A-109C17B617BE-17C517C717C81923-19261929-192B193019311933-193819B0-19C019C819C91A19-1A1B1A551A571A611A631A641A6D-1A721B041B351B3B1B3D-1B411B431B441B821BA11BA61BA71BAA1C24-1C2B1C341C351CE11CF2A823A824A827A880A881A8B4-A8C3A952A953A983A9B4A9B5A9BAA9BBA9BD-A9C0AA2FAA30AA33AA34AA4DAA7BABE3ABE4ABE6ABE7ABE9ABEAABEC",
+    Me: "0488048906DE20DD-20E020E2-20E4A670-A672",
+    N:  "0030-003900B200B300B900BC-00BE0660-066906F0-06F907C0-07C90966-096F09E6-09EF09F4-09F90A66-0A6F0AE6-0AEF0B66-0B6F0BE6-0BF20C66-0C6F0C78-0C7E0CE6-0CEF0D66-0D750E50-0E590ED0-0ED90F20-0F331040-10491090-10991369-137C16EE-16F017E0-17E917F0-17F91810-18191946-194F19D0-19DA1A80-1A891A90-1A991B50-1B591BB0-1BB91C40-1C491C50-1C5920702074-20792080-20892150-21822185-21892460-249B24EA-24FF2776-27932CFD30073021-30293038-303A3192-31953220-32293251-325F3280-328932B1-32BFA620-A629A6E6-A6EFA830-A835A8D0-A8D9A900-A909A9D0-A9D9AA50-AA59ABF0-ABF9FF10-FF19",
+    Nd: "0030-00390660-066906F0-06F907C0-07C90966-096F09E6-09EF0A66-0A6F0AE6-0AEF0B66-0B6F0BE6-0BEF0C66-0C6F0CE6-0CEF0D66-0D6F0E50-0E590ED0-0ED90F20-0F291040-10491090-109917E0-17E91810-18191946-194F19D0-19DA1A80-1A891A90-1A991B50-1B591BB0-1BB91C40-1C491C50-1C59A620-A629A8D0-A8D9A900-A909A9D0-A9D9AA50-AA59ABF0-ABF9FF10-FF19",
+    Nl: "16EE-16F02160-21822185-218830073021-30293038-303AA6E6-A6EF",
+    No: "00B200B300B900BC-00BE09F4-09F90BF0-0BF20C78-0C7E0D70-0D750F2A-0F331369-137C17F0-17F920702074-20792080-20892150-215F21892460-249B24EA-24FF2776-27932CFD3192-31953220-32293251-325F3280-328932B1-32BFA830-A835",
+    P:  "0021-00230025-002A002C-002F003A003B003F0040005B-005D005F007B007D00A100AB00B700BB00BF037E0387055A-055F0589058A05BE05C005C305C605F305F40609060A060C060D061B061E061F066A-066D06D40700-070D07F7-07F90830-083E0964096509700DF40E4F0E5A0E5B0F04-0F120F3A-0F3D0F850FD0-0FD4104A-104F10FB1361-13681400166D166E169B169C16EB-16ED1735173617D4-17D617D8-17DA1800-180A1944194519DE19DF1A1E1A1F1AA0-1AA61AA8-1AAD1B5A-1B601C3B-1C3F1C7E1C7F1CD32010-20272030-20432045-20512053-205E207D207E208D208E2329232A2768-277527C527C627E6-27EF2983-299829D8-29DB29FC29FD2CF9-2CFC2CFE2CFF2E00-2E2E2E302E313001-30033008-30113014-301F3030303D30A030FBA4FEA4FFA60D-A60FA673A67EA6F2-A6F7A874-A877A8CEA8CFA8F8-A8FAA92EA92FA95FA9C1-A9CDA9DEA9DFAA5C-AA5FAADEAADFABEBFD3EFD3FFE10-FE19FE30-FE52FE54-FE61FE63FE68FE6AFE6BFF01-FF03FF05-FF0AFF0C-FF0FFF1AFF1BFF1FFF20FF3B-FF3DFF3FFF5BFF5DFF5F-FF65",
+    Pd: "002D058A05BE140018062010-20152E172E1A301C303030A0FE31FE32FE58FE63FF0D",
+    Ps: "0028005B007B0F3A0F3C169B201A201E2045207D208D23292768276A276C276E27702772277427C527E627E827EA27EC27EE2983298529872989298B298D298F299129932995299729D829DA29FC2E222E242E262E283008300A300C300E3010301430163018301A301DFD3EFE17FE35FE37FE39FE3BFE3DFE3FFE41FE43FE47FE59FE5BFE5DFF08FF3BFF5BFF5FFF62",
+    Pe: "0029005D007D0F3B0F3D169C2046207E208E232A2769276B276D276F27712773277527C627E727E927EB27ED27EF298429862988298A298C298E2990299229942996299829D929DB29FD2E232E252E272E293009300B300D300F3011301530173019301B301E301FFD3FFE18FE36FE38FE3AFE3CFE3EFE40FE42FE44FE48FE5AFE5CFE5EFF09FF3DFF5DFF60FF63",
+    Pi: "00AB2018201B201C201F20392E022E042E092E0C2E1C2E20",
+    Pf: "00BB2019201D203A2E032E052E0A2E0D2E1D2E21",
+    Pc: "005F203F20402054FE33FE34FE4D-FE4FFF3F",
+    Po: "0021-00230025-0027002A002C002E002F003A003B003F0040005C00A100B700BF037E0387055A-055F058905C005C305C605F305F40609060A060C060D061B061E061F066A-066D06D40700-070D07F7-07F90830-083E0964096509700DF40E4F0E5A0E5B0F04-0F120F850FD0-0FD4104A-104F10FB1361-1368166D166E16EB-16ED1735173617D4-17D617D8-17DA1800-18051807-180A1944194519DE19DF1A1E1A1F1AA0-1AA61AA8-1AAD1B5A-1B601C3B-1C3F1C7E1C7F1CD3201620172020-20272030-2038203B-203E2041-20432047-205120532055-205E2CF9-2CFC2CFE2CFF2E002E012E06-2E082E0B2E0E-2E162E182E192E1B2E1E2E1F2E2A-2E2E2E302E313001-3003303D30FBA4FEA4FFA60D-A60FA673A67EA6F2-A6F7A874-A877A8CEA8CFA8F8-A8FAA92EA92FA95FA9C1-A9CDA9DEA9DFAA5C-AA5FAADEAADFABEBFE10-FE16FE19FE30FE45FE46FE49-FE4CFE50-FE52FE54-FE57FE5F-FE61FE68FE6AFE6BFF01-FF03FF05-FF07FF0AFF0CFF0EFF0FFF1AFF1BFF1FFF20FF3CFF61FF64FF65",
+    S:  "0024002B003C-003E005E0060007C007E00A2-00A900AC00AE-00B100B400B600B800D700F702C2-02C502D2-02DF02E5-02EB02ED02EF-02FF03750384038503F604820606-0608060B060E060F06E906FD06FE07F609F209F309FA09FB0AF10B700BF3-0BFA0C7F0CF10CF20D790E3F0F01-0F030F13-0F170F1A-0F1F0F340F360F380FBE-0FC50FC7-0FCC0FCE0FCF0FD5-0FD8109E109F13601390-139917DB194019E0-19FF1B61-1B6A1B74-1B7C1FBD1FBF-1FC11FCD-1FCF1FDD-1FDF1FED-1FEF1FFD1FFE20442052207A-207C208A-208C20A0-20B8210021012103-21062108210921142116-2118211E-2123212521272129212E213A213B2140-2144214A-214D214F2190-2328232B-23E82400-24262440-244A249C-24E92500-26CD26CF-26E126E326E8-26FF2701-27042706-2709270C-27272729-274B274D274F-27522756-275E2761-276727942798-27AF27B1-27BE27C0-27C427C7-27CA27CC27D0-27E527F0-29822999-29D729DC-29FB29FE-2B4C2B50-2B592CE5-2CEA2E80-2E992E9B-2EF32F00-2FD52FF0-2FFB300430123013302030363037303E303F309B309C319031913196-319F31C0-31E33200-321E322A-32503260-327F328A-32B032C0-32FE3300-33FF4DC0-4DFFA490-A4C6A700-A716A720A721A789A78A
 A828-A82BA836-A839AA77-AA79FB29FDFCFDFDFE62FE64-FE66FE69FF04FF0BFF1C-FF1EFF3EFF40FF5CFF5EFFE0-FFE6FFE8-FFEEFFFCFFFD",
+    Sm: "002B003C-003E007C007E00AC00B100D700F703F60606-060820442052207A-207C208A-208C2140-2144214B2190-2194219A219B21A021A321A621AE21CE21CF21D221D421F4-22FF2308-230B23202321237C239B-23B323DC-23E125B725C125F8-25FF266F27C0-27C427C7-27CA27CC27D0-27E527F0-27FF2900-29822999-29D729DC-29FB29FE-2AFF2B30-2B442B47-2B4CFB29FE62FE64-FE66FF0BFF1C-FF1EFF5CFF5EFFE2FFE9-FFEC",
+    Sc: "002400A2-00A5060B09F209F309FB0AF10BF90E3F17DB20A0-20B8A838FDFCFE69FF04FFE0FFE1FFE5FFE6",
+    Sk: "005E006000A800AF00B400B802C2-02C502D2-02DF02E5-02EB02ED02EF-02FF0375038403851FBD1FBF-1FC11FCD-1FCF1FDD-1FDF1FED-1FEF1FFD1FFE309B309CA700-A716A720A721A789A78AFF3EFF40FFE3",
+    So: "00A600A700A900AE00B000B60482060E060F06E906FD06FE07F609FA0B700BF3-0BF80BFA0C7F0CF10CF20D790F01-0F030F13-0F170F1A-0F1F0F340F360F380FBE-0FC50FC7-0FCC0FCE0FCF0FD5-0FD8109E109F13601390-1399194019E0-19FF1B61-1B6A1B74-1B7C210021012103-21062108210921142116-2118211E-2123212521272129212E213A213B214A214C214D214F2195-2199219C-219F21A121A221A421A521A7-21AD21AF-21CD21D021D121D321D5-21F32300-2307230C-231F2322-2328232B-237B237D-239A23B4-23DB23E2-23E82400-24262440-244A249C-24E92500-25B625B8-25C025C2-25F72600-266E2670-26CD26CF-26E126E326E8-26FF2701-27042706-2709270C-27272729-274B274D274F-27522756-275E2761-276727942798-27AF27B1-27BE2800-28FF2B00-2B2F2B452B462B50-2B592CE5-2CEA2E80-2E992E9B-2EF32F00-2FD52FF0-2FFB300430123013302030363037303E303F319031913196-319F31C0-31E33200-321E322A-32503260-327F328A-32B032C0-32FE3300-33FF4DC0-4DFFA490-A4C6A828-A82BA836A837A839AA77-AA79FDFDFFE4FFE8FFEDFFEEFFFCFFFD",
+    Z:  "002000A01680180E2000-200A20282029202F205F3000",
+    Zs: "002000A01680180E2000-200A202F205F3000",
+    Zl: "2028",
+    Zp: "2029",
+    C:  "0000-001F007F-009F00AD03780379037F-0383038B038D03A20526-05300557055805600588058B-059005C8-05CF05EB-05EF05F5-0605061C061D0620065F06DD070E070F074B074C07B2-07BF07FB-07FF082E082F083F-08FF093A093B094F095609570973-097809800984098D098E0991099209A909B109B3-09B509BA09BB09C509C609C909CA09CF-09D609D8-09DB09DE09E409E509FC-0A000A040A0B-0A0E0A110A120A290A310A340A370A3A0A3B0A3D0A43-0A460A490A4A0A4E-0A500A52-0A580A5D0A5F-0A650A76-0A800A840A8E0A920AA90AB10AB40ABA0ABB0AC60ACA0ACE0ACF0AD1-0ADF0AE40AE50AF00AF2-0B000B040B0D0B0E0B110B120B290B310B340B3A0B3B0B450B460B490B4A0B4E-0B550B58-0B5B0B5E0B640B650B72-0B810B840B8B-0B8D0B910B96-0B980B9B0B9D0BA0-0BA20BA5-0BA70BAB-0BAD0BBA-0BBD0BC3-0BC50BC90BCE0BCF0BD1-0BD60BD8-0BE50BFB-0C000C040C0D0C110C290C340C3A-0C3C0C450C490C4E-0C540C570C5A-0C5F0C640C650C70-0C770C800C810C840C8D0C910CA90CB40CBA0CBB0CC50CC90CCE-0CD40CD7-0CDD0CDF0CE40CE50CF00CF3-0D010D040D0D0D110D290D3A-0D3C0D450D490D4E-0D560D58-0D5F0D640D650D76-0D780D800D810D840D97-0D990DB20DBC0DBE0DB
 F0DC7-0DC90DCB-0DCE0DD50DD70DE0-0DF10DF5-0E000E3B-0E3E0E5C-0E800E830E850E860E890E8B0E8C0E8E-0E930E980EA00EA40EA60EA80EA90EAC0EBA0EBE0EBF0EC50EC70ECE0ECF0EDA0EDB0EDE-0EFF0F480F6D-0F700F8C-0F8F0F980FBD0FCD0FD9-0FFF10C6-10CF10FD-10FF1249124E124F12571259125E125F1289128E128F12B112B612B712BF12C112C612C712D7131113161317135B-135E137D-137F139A-139F13F5-13FF169D-169F16F1-16FF170D1715-171F1737-173F1754-175F176D17711774-177F17B417B517DE17DF17EA-17EF17FA-17FF180F181A-181F1878-187F18AB-18AF18F6-18FF191D-191F192C-192F193C-193F1941-1943196E196F1975-197F19AC-19AF19CA-19CF19DB-19DD1A1C1A1D1A5F1A7D1A7E1A8A-1A8F1A9A-1A9F1AAE-1AFF1B4C-1B4F1B7D-1B7F1BAB-1BAD1BBA-1BFF1C38-1C3A1C4A-1C4C1C80-1CCF1CF3-1CFF1DE7-1DFC1F161F171F1E1F1F1F461F471F4E1F4F1F581F5A1F5C1F5E1F7E1F7F1FB51FC51FD41FD51FDC1FF01FF11FF51FFF200B-200F202A-202E2060-206F20722073208F2095-209F20B9-20CF20F1-20FF218A-218F23E9-23FF2427-243F244B-245F26CE26E226E4-26E727002705270A270B2728274C274E2753-2755275F27602795-279727B027BF27CB27CD-27CF2B4D-
 2B4F2B5A-2BFF2C2F2C5F2CF2-2CF82D26-2D2F2D66-2D6E2D70-2D7F2D97-2D9F2DA+    Cc: "0000-001F007F-009F",
+    Cf: "00AD0600-060306DD070F17B417B5200B-200F202A-202E2060-2064206A-206FFEFFFFF9-FFFB",
+    Co: "E000-F8FF",
+    Cs: "D800-DFFF",
+    Cn: "03780379037F-0383038B038D03A20526-05300557055805600588058B-059005C8-05CF05EB-05EF05F5-05FF06040605061C061D0620065F070E074B074C07B2-07BF07FB-07FF082E082F083F-08FF093A093B094F095609570973-097809800984098D098E0991099209A909B109B3-09B509BA09BB09C509C609C909CA09CF-09D609D8-09DB09DE09E409E509FC-0A000A040A0B-0A0E0A110A120A290A310A340A370A3A0A3B0A3D0A43-0A460A490A4A0A4E-0A500A52-0A580A5D0A5F-0A650A76-0A800A840A8E0A920AA90AB10AB40ABA0ABB0AC60ACA0ACE0ACF0AD1-0ADF0AE40AE50AF00AF2-0B000B040B0D0B0E0B110B120B290B310B340B3A0B3B0B450B460B490B4A0B4E-0B550B58-0B5B0B5E0B640B650B72-0B810B840B8B-0B8D0B910B96-0B980B9B0B9D0BA0-0BA20BA5-0BA70BAB-0BAD0BBA-0BBD0BC3-0BC50BC90BCE0BCF0BD1-0BD60BD8-0BE50BFB-0C000C040C0D0C110C290C340C3A-0C3C0C450C490C4E-0C540C570C5A-0C5F0C640C650C70-0C770C800C810C840C8D0C910CA90CB40CBA0CBB0CC50CC90CCE-0CD40CD7-0CDD0CDF0CE40CE50CF00CF3-0D010D040D0D0D110D290D3A-0D3C0D450D490D4E-0D560D58-0D5F0D640D650D76-0D780D800D810D840D97-0D990DB20DBC0DBE0DBF0DC7-0DC90DCB-0DCE0DD
 50DD70DE0-0DF10DF5-0E000E3B-0E3E0E5C-0E800E830E850E860E890E8B0E8C0E8E-0E930E980EA00EA40EA60EA80EA90EAC0EBA0EBE0EBF0EC50EC70ECE0ECF0EDA0EDB0EDE-0EFF0F480F6D-0F700F8C-0F8F0F980FBD0FCD0FD9-0FFF10C6-10CF10FD-10FF1249124E124F12571259125E125F1289128E128F12B112B612B712BF12C112C612C712D7131113161317135B-135E137D-137F139A-139F13F5-13FF169D-169F16F1-16FF170D1715-171F1737-173F1754-175F176D17711774-177F17DE17DF17EA-17EF17FA-17FF180F181A-181F1878-187F18AB-18AF18F6-18FF191D-191F192C-192F193C-193F1941-1943196E196F1975-197F19AC-19AF19CA-19CF19DB-19DD1A1C1A1D1A5F1A7D1A7E1A8A-1A8F1A9A-1A9F1AAE-1AFF1B4C-1B4F1B7D-1B7F1BAB-1BAD1BBA-1BFF1C38-1C3A1C4A-1C4C1C80-1CCF1CF3-1CFF1DE7-1DFC1F161F171F1E1F1F1F461F471F4E1F4F1F581F5A1F5C1F5E1F7E1F7F1FB51FC51FD41FD51FDC1FF01FF11FF51FFF2065-206920722073208F2095-209F20B9-20CF20F1-20FF218A-218F23E9-23FF2427-243F244B-245F26CE26E226E4-26E727002705270A270B2728274C274E2753-2755275F27602795-279727B027BF27CB27CD-27CF2B4D-2B4F2B5A-2BFF2C2F2C5F2CF2-2CF82D26-2D2F2D66-2D6E
 2D70-2D7F2D97-2D9F2DA72DAF2DB72DBF2DC72DCF2DD72DDF2E32-2E7F2E9A2EF4-2+});
+
+function addUnicodePackage (pack) {
+    var codePoint = /\w{4}/g;
+    for (var name in pack)
+        exports.packages[name] = pack[name].replace(codePoint, "\\u$&");
+};
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/document', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/event_emitter', 'ace/range', 'ace/anchor'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+var Range = require("./range").Range;
+var Anchor = require("./anchor").Anchor;
+
+var Document = function(text) {
+    this.$lines = [];
+
+    if (Array.isArray(text)) {
+        this.insertLines(0, text);
+    }
+    // There has to be one line at least in the document. If you pass an empty
+    // string to the insert function, nothing will happen. Workaround.
+    else if (text.length == 0) {
+        this.$lines = [""];
+    } else {
+        this.insert({row: 0, column:0}, text);
+    }
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.setValue = function(text) {
+        var len = this.getLength();
+        this.remove(new Range(0, 0, len, this.getLine(len-1).length));
+        this.insert({row: 0, column:0}, text);
+    };
+
+    this.getValue = function() {
+        return this.getAllLines().join(this.getNewLineCharacter());
+    };
+
+    this.createAnchor = function(row, column) {
+        return new Anchor(this, row, column);
+    };
+
+    // check for IE split bug
+    if ("aaa".split(/a/).length == 0)
+        this.$split = function(text) {
+            return text.replace(/\r\n|\r/g, "\n").split("\n");
+        }
+    else
+        this.$split = function(text) {
+            return text.split(/\r\n|\r|\n/);
+        };
+
+
+    this.$detectNewLine = function(text) {
+        var match = text.match(/^.*?(\r\n|\r|\n)/m);
+        if (match) {
+            this.$autoNewLine = match[1];
+        } else {
+            this.$autoNewLine = "\n";
+        }
+    };
+
+    this.getNewLineCharacter = function() {
+      switch (this.$newLineMode) {
+          case "windows":
+              return "\r\n";
+
+          case "unix":
+              return "\n";
+
+          case "auto":
+              return this.$autoNewLine;
+      }
+    };
+
+    this.$autoNewLine = "\n";
+    this.$newLineMode = "auto";
+    this.setNewLineMode = function(newLineMode) {
+        if (this.$newLineMode === newLineMode)
+            return;
+
+        this.$newLineMode = newLineMode;
+    };
+
+    this.getNewLineMode = function() {
+        return this.$newLineMode;
+    };
+
+    this.isNewLine = function(text) {
+        return (text == "\r\n" || text == "\r" || text == "\n");
+    };
+
+    /**
+     * Get a verbatim copy of the given line as it is in the document
+     */
+    this.getLine = function(row) {
+        return this.$lines[row] || "";
+    };
+
+    this.getLines = function(firstRow, lastRow) {
+        return this.$lines.slice(firstRow, lastRow + 1);
+    };
+
+    /**
+     * Returns all lines in the document as string array. Warning: The caller
+     * should not modify this array!
+     */
+    this.getAllLines = function() {
+        return this.getLines(0, this.getLength());
+    };
+
+    this.getLength = function() {
+        return this.$lines.length;
+    };
+
+    this.getTextRange = function(range) {
+        if (range.start.row == range.end.row) {
+            return this.$lines[range.start.row].substring(range.start.column,
+                                                         range.end.column);
+        }
+        else {
+            var lines = [];
+            lines.push(this.$lines[range.start.row].substring(range.start.column));
+            lines.push.apply(lines, this.getLines(range.start.row+1, range.end.row-1));
+            lines.push(this.$lines[range.end.row].substring(0, range.end.column));
+            return lines.join(this.getNewLineCharacter());
+        }
+    };
+
+    this.$clipPosition = function(position) {
+        var length = this.getLength();
+        if (position.row >= length) {
+            position.row = Math.max(0, length - 1);
+            position.column = this.getLine(length-1).length;
+        }
+        return position;
+    };
+
+    this.insert = function(position, text) {
+        if (text.length == 0)
+            return position;
+
+        position = this.$clipPosition(position);
+
+        if (this.getLength() <= 1)
+            this.$detectNewLine(text);
+
+        var lines = this.$split(text);
+        var firstLine = lines.splice(0, 1)[0];
+        var lastLine = lines.length == 0 ? null : lines.splice(lines.length - 1, 1)[0];
+
+        position = this.insertInLine(position, firstLine);
+        if (lastLine !== null) {
+            position = this.insertNewLine(position); // terminate first line
+            position = this.insertLines(position.row, lines);
+            position = this.insertInLine(position, lastLine || "");
+        }
+        return position;
+    };
+
+    this.insertLines = function(row, lines) {
+        if (lines.length == 0)
+            return {row: row, column: 0};
+
+        var args = [row, 0];
+        args.push.apply(args, lines);
+        this.$lines.splice.apply(this.$lines, args);
+
+        var range = new Range(row, 0, row + lines.length, 0);
+        var delta = {
+            action: "insertLines",
+            range: range,
+            lines: lines
+        };
+        this._dispatchEvent("change", { data: delta });
+        return range.end;
+    };
+
+    this.insertNewLine = function(position) {
+        position = this.$clipPosition(position);
+        var line = this.$lines[position.row] || "";
+
+        this.$lines[position.row] = line.substring(0, position.column);
+        this.$lines.splice(position.row + 1, 0, line.substring(position.column, line.length));
+
+        var end = {
+            row : position.row + 1,
+            column : 0
+        };
+
+        var delta = {
+            action: "insertText",
+            range: Range.fromPoints(position, end),
+            text: this.getNewLineCharacter()
+        };
+        this._dispatchEvent("change", { data: delta });
+
+        return end;
+    };
+
+    this.insertInLine = function(position, text) {
+        if (text.length == 0)
+            return position;
+
+        var line = this.$lines[position.row] || "";
+
+        this.$lines[position.row] = line.substring(0, position.column) + text
+                + line.substring(position.column);
+
+        var end = {
+            row : position.row,
+            column : position.column + text.length
+        };
+
+        var delta = {
+            action: "insertText",
+            range: Range.fromPoints(position, end),
+            text: text
+        };
+        this._dispatchEvent("change", { data: delta });
+
+        return end;
+    };
+
+    this.remove = function(range) {
+        // clip to document
+        range.start = this.$clipPosition(range.start);
+        range.end = this.$clipPosition(range.end);
+
+        if (range.isEmpty())
+            return range.start;
+
+        var firstRow = range.start.row;
+        var lastRow = range.end.row;
+
+        if (range.isMultiLine()) {
+            var firstFullRow = range.start.column == 0 ? firstRow : firstRow + 1;
+            var lastFullRow = lastRow - 1;
+
+            if (range.end.column > 0)
+                this.removeInLine(lastRow, 0, range.end.column);
+
+            if (lastFullRow >= firstFullRow)
+                this.removeLines(firstFullRow, lastFullRow);
+
+            if (firstFullRow != firstRow) {
+                this.removeInLine(firstRow, range.start.column, this.getLine(firstRow).length);
+                this.removeNewLine(range.start.row);
+            }
+        }
+        else {
+            this.removeInLine(firstRow, range.start.column, range.end.column);
+        }
+        return range.start;
+    };
+
+    this.removeInLine = function(row, startColumn, endColumn) {
+        if (startColumn == endColumn)
+            return;
+
+        var range = new Range(row, startColumn, row, endColumn);
+        var line = this.getLine(row);
+        var removed = line.substring(startColumn, endColumn);
+        var newLine = line.substring(0, startColumn) + line.substring(endColumn, line.length);
+        this.$lines.splice(row, 1, newLine);
+
+        var delta = {
+            action: "removeText",
+            range: range,
+            text: removed
+        };
+        this._dispatchEvent("change", { data: delta });
+        return range.start;
+    };
+
+    /**
+     * Removes a range of full lines
+     *
+     * @param firstRow {Integer} The first row to be removed
+     * @param lastRow {Integer} The last row to be removed
+     * @return {String[]} The removed lines
+     */
+    this.removeLines = function(firstRow, lastRow) {
+        var range = new Range(firstRow, 0, lastRow + 1, 0);
+        var removed = this.$lines.splice(firstRow, lastRow - firstRow + 1);
+
+        var delta = {
+            action: "removeLines",
+            range: range,
+            nl: this.getNewLineCharacter(),
+            lines: removed
+        };
+        this._dispatchEvent("change", { data: delta });
+        return removed;
+    };
+
+    this.removeNewLine = function(row) {
+        var firstLine = this.getLine(row);
+        var secondLine = this.getLine(row+1);
+
+        var range = new Range(row, firstLine.length, row+1, 0);
+        var line = firstLine + secondLine;
+
+        this.$lines.splice(row, 2, line);
+
+        var delta = {
+            action: "removeText",
+            range: range,
+            text: this.getNewLineCharacter()
+        };
+        this._dispatchEvent("change", { data: delta });
+    };
+
+    this.replace = function(range, text) {
+        if (text.length == 0 && range.isEmpty())
+            return range.start;
+
+        // Shortcut: If the text we want to insert is the same as it is already
+        // in the document, we don't have to replace anything.
+        if (text == this.getTextRange(range))
+            return range.end;
+
+        this.remove(range);
+        if (text) {
+            var end = this.insert(range.start, text);
+        }
+        else {
+            end = range.start;
+        }
+
+        return end;
+    };
+
+    this.applyDeltas = function(deltas) {
+        for (var i=0; i<deltas.length; i++) {
+            var delta = deltas[i];
+            var range = Range.fromPoints(delta.range.start, delta.range.end);
+
+            if (delta.action == "insertLines")
+                this.insertLines(range.start.row, delta.lines);
+            else if (delta.action == "insertText")
+                this.insert(range.start, delta.text);
+            else if (delta.action == "removeLines")
+                this.removeLines(range.start.row, range.end.row - 1);
+            else if (delta.action == "removeText")
+                this.remove(range);
+        }
+    };
+
+    this.revertDeltas = function(deltas) {
+        for (var i=deltas.length-1; i>=0; i--) {
+            var delta = deltas[i];
+
+            var range = Range.fromPoints(delta.range.start, delta.range.end);
+
+            if (delta.action == "insertLines")
+                this.removeLines(range.start.row, range.end.row - 1);
+            else if (delta.action == "insertText")
+                this.remove(range);
+            else if (delta.action == "removeLines")
+                this.insertLines(range.start.row, delta.lines);
+            else if (delta.action == "removeText")
+                this.insert(range.start, delta.text);
+        }
+    };
+
+}).call(Document.prototype);
+
+exports.Document = Document;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/anchor', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+
+/**
+ * An Anchor is a floating pointer in the document. Whenever text is inserted or
+ * deleted before the cursor, the position of the cursor is updated
+ */
+var Anchor = exports.Anchor = function(doc, row, column) {
+    this.document = doc;
+    
+    if (typeof column == "undefined")
+        this.setPosition(row.row, row.column);
+    else
+        this.setPosition(row, column);
+
+    this.$onChange = this.onChange.bind(this);
+    doc.on("change", this.$onChange);
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+    
+    this.getPosition = function() {
+        return this.$clipPositionToDocument(this.row, this.column);
+    };
+    
+    this.getDocument = function() {
+        return this.document;
+    };
+    
+    this.onChange = function(e) {
+        var delta = e.data;
+        var range = delta.range;
+            
+        if (range.start.row == range.end.row && range.start.row != this.row)
+            return;
+            
+        if (range.start.row > this.row)
+            return;
+            
+        if (range.start.row == this.row && range.start.column > this.column)
+            return;
+    
+        var row = this.row;
+        var column = this.column;
+        
+        if (delta.action === "insertText") {
+            if (range.start.row === row && range.start.column <= column) {
+                if (range.start.row === range.end.row) {
+                    column += range.end.column - range.start.column;
+                }
+                else {
+                    column -= range.start.column;
+                    row += range.end.row - range.start.row;
+                }
+            }
+            else if (range.start.row !== range.end.row && range.start.row < row) {
+                row += range.end.row - range.start.row;
+            }
+        } else if (delta.action === "insertLines") {
+            if (range.start.row <= row) {
+                row += range.end.row - range.start.row;
+            }
+        }
+        else if (delta.action == "removeText") {
+            if (range.start.row == row && range.start.column < column) {
+                if (range.end.column >= column)
+                    column = range.start.column;
+                else
+                    column = Math.max(0, column - (range.end.column - range.start.column));
+                
+            } else if (range.start.row !== range.end.row && range.start.row < row) {
+                if (range.end.row == row) {
+                    column = Math.max(0, column - range.end.column) + range.start.column;
+                }
+                row -= (range.end.row - range.start.row);
+            }
+            else if (range.end.row == row) {
+                row -= range.end.row - range.start.row;
+                column = Math.max(0, column - range.end.column) + range.start.column;
+            }
+        } else if (delta.action == "removeLines") {
+            if (range.start.row <= row) {
+                if (range.end.row <= row)
+                    row -= range.end.row - range.start.row;
+                else {
+                    row = range.start.row;
+                    column = 0;
+                }
+            }
+        }
+
+        this.setPosition(row, column, true);
+    };
+
+    this.setPosition = function(row, column, noClip) {
+        var pos;
+        if (noClip) {
+            pos = {
+                row: row,
+                column: column
+            };
+        }
+        else {
+            pos = this.$clipPositionToDocument(row, column);
+        }
+        
+        if (this.row == pos.row && this.column == pos.column)
+            return;
+            
+        var old = {
+            row: this.row,
+            column: this.column
+        };
+        
+        this.row = pos.row;
+        this.column = pos.column;
+        this._dispatchEvent("change", {
+            old: old,
+            value: pos
+        });
+    };
+    
+    this.detach = function() {
+        this.document.removeEventListener("change", this.$onChange);
+    };
+    
+    this.$clipPositionToDocument = function(row, column) {
+        var pos = {};
+    
+        if (row >= this.document.getLength()) {
+            pos.row = Math.max(0, this.document.getLength() - 1);
+            pos.column = this.document.getLine(pos.row).length;
+        }
+        else if (row < 0) {
+            pos.row = 0;
+            pos.column = 0;
+        }
+        else {
+            pos.row = row;
+            pos.column = Math.min(this.document.getLine(pos.row).length, Math.max(0, column));
+        }
+        
+        if (column < 0)
+            pos.column = 0;
+            
+        return pos;
+    };
+    
+}).call(Anchor.prototype);
+
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/background_tokenizer', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+
+var BackgroundTokenizer = function(tokenizer, editor) {
+    this.running = false;    
+    this.lines = [];
+    this.currentLine = 0;
+    this.tokenizer = tokenizer;
+
+    var self = this;
+
+    this.$worker = function() {
+        if (!self.running) { return; }
+
+        var workerStart = new Date();
+        var startLine = self.currentLine;
+        var doc = self.doc;
+
+        var processedLines = 0;
+
+        var len = doc.getLength();
+        while (self.currentLine < len) {
+            self.lines[self.currentLine] = self.$tokenizeRows(self.currentLine, self.currentLine)[0];
+            self.currentLine++;
+
+            // only check every 5 lines
+            processedLines += 1;
+            if ((processedLines % 5 == 0) && (new Date() - workerStart) > 20) {
+                self.fireUpdateEvent(startLine, self.currentLine-1);
+                self.running = setTimeout(self.$worker, 20);
+                return;
+            }
+        }
+
+        self.running = false;
+
+        self.fireUpdateEvent(startLine, len - 1);
+    };
+};
+
+(function(){
+
+    oop.implement(this, EventEmitter);
+
+    this.setTokenizer = function(tokenizer) {
+        this.tokenizer = tokenizer;
+        this.lines = [];
+
+        this.start(0);
+    };
+
+    this.setDocument = function(doc) {
+        this.doc = doc;
+        this.lines = [];
+
+        this.stop();
+    };
+
+    this.fireUpdateEvent = function(firstRow, lastRow) {
+        var data = {
+            first: firstRow,
+            last: lastRow
+        };
+        this._dispatchEvent("update", {data: data});
+    };
+
+    this.start = function(startRow) {
+        this.currentLine = Math.min(startRow || 0, this.currentLine,
+                                    this.doc.getLength());
+
+        // remove all cached items below this line
+        this.lines.splice(this.currentLine, this.lines.length);
+
+        this.stop();
+        // pretty long delay to prevent the tokenizer from interfering with the user
+        this.running = setTimeout(this.$worker, 700);
+    };
+
+    this.stop = function() {
+        if (this.running)
+            clearTimeout(this.running);
+        this.running = false;
+    };
+
+    this.getTokens = function(firstRow, lastRow) {
+        return this.$tokenizeRows(firstRow, lastRow);
+    };
+
+    this.getState = function(row) {
+        return this.$tokenizeRows(row, row)[0].state;
+    };
+
+    this.$tokenizeRows = function(firstRow, lastRow) {
+        if (!this.doc)
+            return [];
+            
+        var rows = [];
+
+        // determine start state
+        var state = "start";
+        var doCache = false;
+        if (firstRow > 0 && this.lines[firstRow - 1]) {
+            state = this.lines[firstRow - 1].state;
+            doCache = true;
+        } else if (firstRow == 0) {
+            state = "start";
+            doCache = true;
+        } else if (this.lines.length > 0) {
+            // Guess that we haven't changed state.
+            state = this.lines[this.lines.length-1].state;
+        }
+
+        var lines = this.doc.getLines(firstRow, lastRow);
+        for (var row=firstRow; row<=lastRow; row++) {
+            if (!this.lines[row]) {
+                var tokens = this.tokenizer.getLineTokens(lines[row-firstRow] || "", state);
+                var state = tokens.state;
+                rows.push(tokens);
+
+                if (doCache) {
+                    this.lines[row] = tokens;
+                }
+            }
+            else {
+                var tokens = this.lines[row];
+                state = tokens.state;
+                rows.push(tokens);
+            }
+        }
+        return rows;
+    };
+
+}).call(BackgroundTokenizer.prototype);
+
+exports.BackgroundTokenizer = BackgroundTokenizer;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Julian Viereck <julian DOT viereck AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/edit_session/folding', ['require', 'exports', 'module' , 'ace/range', 'ace/edit_session/fold_line', 'ace/edit_session/fold', 'ace/token_iterator'], function(require, exports, module) {
+
+var Range = require("../range").Range;
+var FoldLine = require("./fold_line").FoldLine;
+var Fold = require("./fold").Fold;
+var TokenIterator = require("../token_iterator").TokenIterator;
+
+function Folding() {
+    /**
+     * Looks up a fold at a given row/column. Possible values for side:
+     *   -1: ignore a fold if fold.start = row/column
+     *   +1: ignore a fold if fold.end = row/column
+     */
+    this.getFoldAt = function(row, column, side) {
+        var foldLine = this.getFoldLine(row);
+        if (!foldLine)
+            return null;
+
+        var folds = foldLine.folds;
+        for (var i = 0; i < folds.length; i++) {
+            var fold = folds[i];
+            if (fold.range.contains(row, column)) {
+                if (side == 1 && fold.range.isEnd(row, column)) {
+                    continue;
+                } else if (side == -1 && fold.range.isStart(row, column)) {
+                    continue;
+                }
+                return fold;
+            }
+        }
+    };
+
+    /**
+     * Returns all folds in the given range. Note, that this will return folds
+     *
+     */
+    this.getFoldsInRange = function(range) {
+        range = range.clone();
+        var start = range.start;
+        var end = range.end;
+        var foldLines = this.$foldData;
+        var foundFolds = [];
+
+        start.column += 1;
+        end.column -= 1;
+
+        for (var i = 0; i < foldLines.length; i++) {
+            var cmp = foldLines[i].range.compareRange(range);
+            if (cmp == 2) {
+                // Range is before foldLine. No intersection. This means,
+                // there might be other foldLines that intersect.
+                continue;
+            }
+            else if (cmp == -2) {
+                // Range is after foldLine. There can't be any other foldLines then,
+                // so let's give up.
+                break;
+            }
+
+            var folds = foldLines[i].folds;
+            for (var j = 0; j < folds.length; j++) {
+                var fold = folds[j];
+                cmp = fold.range.compareRange(range);
+                if (cmp == -2) {
+                    break;
+                } else if (cmp == 2) {
+                    continue;
+                } else
+                // WTF-state: Can happen due to -1/+1 to start/end column.
+                if (cmp == 42) {
+                    break;
+                }
+                foundFolds.push(fold);
+            }
+        }
+        return foundFolds;
+    };
+    
+    /**
+     * Returns all folds in the document
+     */
+    this.getAllFolds = function() {
+        var folds = [];
+        var foldLines = this.$foldData;
+        
+        function addFold(fold) {
+            folds.push(fold);
+            if (!fold.subFolds)
+                return;
+                
+            for (var i = 0; i < fold.subFolds.length; i++)
+                addFold(fold.subFolds[i]);
+        }
+        
+        for (var i = 0; i < foldLines.length; i++)
+            for (var j = 0; j < foldLines[i].folds.length; j++)
+                addFold(foldLines[i].folds[j]);
+
+        return folds;
+    };
+
+    /**
+     * Returns the string between folds at the given position.
+     * E.g.
+     *  foo<fold>b|ar<fold>wolrd -> "bar"
+     *  foo<fold>bar<fold>wol|rd -> "world"
+     *  foo<fold>bar<fo|ld>wolrd -> <null>
+     *
+     * where | means the position of row/column
+     *
+     * The trim option determs if the return string should be trimed according
+     * to the "side" passed with the trim value:
+     *
+     * E.g.
+     *  foo<fold>b|ar<fold>wolrd -trim=-1> "b"
+     *  foo<fold>bar<fold>wol|rd -trim=+1> "rld"
+     *  fo|o<fold>bar<fold>wolrd -trim=00> "foo"
+     */
+    this.getFoldStringAt = function(row, column, trim, foldLine) {
+        foldLine = foldLine || this.getFoldLine(row);
+        if (!foldLine)
+            return null;
+
+        var lastFold = {
+            end: { column: 0 }
+        };
+        // TODO: Refactor to use getNextFoldTo function.
+        var str, fold;
+        for (var i = 0; i < foldLine.folds.length; i++) {
+            fold = foldLine.folds[i];
+            var cmp = fold.range.compareEnd(row, column);
+            if (cmp == -1) {
+                str = this
+                    .getLine(fold.start.row)
+                    .substring(lastFold.end.column, fold.start.column);
+                break;
+            }
+            else if (cmp === 0) {
+                return null;
+            }
+            lastFold = fold;
+        }
+        if (!str)
+            str = this.getLine(fold.start.row).substring(lastFold.end.column);
+
+        if (trim == -1)
+            return str.substring(0, column - lastFold.end.column);
+        else if (trim == 1)
+            return str.substring(column - lastFold.end.column);
+        else
+            return str;
+    };
+
+    this.getFoldLine = function(docRow, startFoldLine) {
+        var foldData = this.$foldData;
+        var i = 0;
+        if (startFoldLine)
+            i = foldData.indexOf(startFoldLine);
+        if (i == -1)
+            i = 0;
+        for (i; i < foldData.length; i++) {
+            var foldLine = foldData[i];
+            if (foldLine.start.row <= docRow && foldLine.end.row >= docRow) {
+                return foldLine;
+            } else if (foldLine.end.row > docRow) {
+                return null;
+            }
+        }
+        return null;
+    };
+
+    // returns the fold which starts after or contains docRow
+    this.getNextFoldLine = function(docRow, startFoldLine) {
+        var foldData = this.$foldData;
+        var i = 0;
+        if (startFoldLine)
+            i = foldData.indexOf(startFoldLine);
+        if (i == -1)
+            i = 0;
+        for (i; i < foldData.length; i++) {
+            var foldLine = foldData[i];
+            if (foldLine.end.row >= docRow) {
+                return foldLine;
+            }
+        }
+        return null;
+    };
+
+    this.getFoldedRowCount = function(first, last) {
+        var foldData = this.$foldData, rowCount = last-first+1;
+        for (var i = 0; i < foldData.length; i++) {
+            var foldLine = foldData[i],
+                end = foldLine.end.row,
+                start = foldLine.start.row;
+            if (end >= last) {
+                if(start < last) {
+                    if(start >= first)
+                        rowCount -= last-start;
+                    else
+                        rowCount = 0;//in one fold
+                }
+                break;
+            } else if(end >= first){
+                if (start >= first) //fold inside range
+                    rowCount -=  end-start;
+                else
+                    rowCount -=  end-first+1;
+            }
+        }
+        return rowCount;
+    };
+
+    this.$addFoldLine = function(foldLine) {
+        this.$foldData.push(foldLine);
+        this.$foldData.sort(function(a, b) {
+            return a.start.row - b.start.row;
+        });
+        return foldLine;
+    };
+
+    /**
+     * Adds a new fold.
+     *
+     * @returns
+     *      The new created Fold object or an existing fold object in case the
+     *      passed in range fits an existing fold exactly.
+     */
+    this.addFold = function(placeholder, range) {
+        var foldData = this.$foldData;
+        var added = false;
+        var fold;
+        
+        if (placeholder instanceof Fold)
+            fold = placeholder;
+        else
+            fold = new Fold(range, placeholder);
+
+        this.$clipRangeToDocument(fold.range);
+
+        var startRow = fold.start.row;
+        var startColumn = fold.start.column;
+        var endRow = fold.end.row;
+        var endColumn = fold.end.column;
+
+        // --- Some checking ---
+        if (fold.placeholder.length < 2)
+            throw "Placeholder has to be at least 2 characters";
+
+        if (startRow == endRow && endColumn - startColumn < 2)
+            throw "The range has to be at least 2 characters width";
+
+        var startFold = this.getFoldAt(startRow, startColumn, 1);
+        var endFold = this.getFoldAt(endRow, endColumn, -1);
+        if (startFold && endFold == startFold)
+            return startFold.addSubFold(fold);
+
+        if (
+            (startFold && !startFold.range.isStart(startRow, startColumn))
+            || (endFold && !endFold.range.isEnd(endRow, endColumn))
+        ) {
+            throw "A fold can't intersect already existing fold" + fold.range + startFold.range;
+        }
+
+        // Check if there are folds in the range we create the new fold for.
+        var folds = this.getFoldsInRange(fold.range);
+        if (folds.length > 0) {
+            // Remove the folds from fold data.
+            this.removeFolds(folds);
+            // Add the removed folds as subfolds on the new fold.
+            fold.subFolds = folds;
+        }
+
+        for (var i = 0; i < foldData.length; i++) {
+            var foldLine = foldData[i];
+            if (endRow == foldLine.start.row) {
+                foldLine.addFold(fold);
+                added = true;
+                break;
+            }
+            else if (startRow == foldLine.end.row) {
+                foldLine.addFold(fold);
+                added = true;
+                if (!fold.sameRow) {
+                    // Check if we might have to merge two FoldLines.
+                    var foldLineNext = foldData[i + 1];
+                    if (foldLineNext && foldLineNext.start.row == endRow) {
+                        // We need to merge!
+                        foldLine.merge(foldLineNext);
+                        break;
+                    }
+                }
+                break;
+            }
+            else if (endRow <= foldLine.start.row) {
+                break;
+            }
+        }
+
+        if (!added)
+            foldLine = this.$addFoldLine(new FoldLine(this.$foldData, fold));
+
+        if (this.$useWrapMode)
+            this.$updateWrapData(foldLine.start.row, foldLine.start.row);
+
+        // Notify that fold data has changed.
+        this.$modified = true;
+        this._dispatchEvent("changeFold", { data: fold });
+
+        return fold;
+    };
+
+    this.addFolds = function(folds) {
+        folds.forEach(function(fold) {
+            this.addFold(fold);
+        }, this);
+    };
+
+    this.removeFold = function(fold) {
+        var foldLine = fold.foldLine;
+        var startRow = foldLine.start.row;
+        var endRow = foldLine.end.row;
+
+        var foldLines = this.$foldData;
+        var folds = foldLine.folds;
+        // Simple case where there is only one fold in the FoldLine such that
+        // the entire fold line can get removed directly.
+        if (folds.length == 1) {
+            foldLines.splice(foldLines.indexOf(foldLine), 1);
+        } else
+        // If the fold is the last fold of the foldLine, just remove it.
+        if (foldLine.range.isEnd(fold.end.row, fold.end.column)) {
+            folds.pop();
+            foldLine.end.row = folds[folds.length - 1].end.row;
+            foldLine.end.column = folds[folds.length - 1].end.column;
+        } else
+        // If the fold is the first fold of the foldLine, just remove it.
+        if (foldLine.range.isStart(fold.start.row, fold.start.column)) {
+            folds.shift();
+            foldLine.start.row = folds[0].start.row;
+            foldLine.start.column = folds[0].start.column;
+        } else
+        // We know there are more then 2 folds and the fold is not at the edge.
+        // This means, the fold is somewhere in between.
+        //
+        // If the fold is in one row, we just can remove it.
+        if (fold.sameRow) {
+            folds.splice(folds.indexOf(fold), 1);
+        } else
+        // The fold goes over more then one row. This means remvoing this fold
+        // will cause the fold line to get splitted up. newFoldLine is the second part
+        {
+            var newFoldLine = foldLine.split(fold.start.row, fold.start.column);
+            folds = newFoldLine.folds;
+            folds.shift();
+            newFoldLine.start.row = folds[0].start.row;
+            newFoldLine.start.column = folds[0].start.column;
+        }
+
+        if (this.$useWrapMode) {
+            this.$updateWrapData(startRow, endRow);
+        }
+
+        // Notify that fold data has changed.
+        this.$modified = true;
+        this._dispatchEvent("changeFold", { data: fold });
+    };
+
+    this.removeFolds = function(folds) {
+        // We need to clone the folds array passed in as it might be the folds
+        // array of a fold line and as we call this.removeFold(fold), folds
+        // are removed from folds and changes the current index.
+        var cloneFolds = [];
+        for (var i = 0; i < folds.length; i++) {
+            cloneFolds.push(folds[i]);
+        }
+
+        cloneFolds.forEach(function(fold) {
+            this.removeFold(fold);
+        }, this);
+        this.$modified = true;
+    };
+
+    this.expandFold = function(fold) {
+        this.removeFold(fold);
+        fold.subFolds.forEach(function(fold) {
+            this.addFold(fold);
+        }, this);
+        fold.subFolds = [];
+    };
+
+    this.expandFolds = function(folds) {
+        folds.forEach(function(fold) {
+            this.expandFold(fold);
+        }, this);
+    };
+
+    this.unfold = function(location, expandInner) {
+        var range, folds;
+        if (location == null)
+            range = new Range(0, 0, this.getLength(), 0);
+        else if (typeof location == "number")
+            range = new Range(location, 0, location, this.getLine(location).length);
+        else if ("row" in location)
+            range = Range.fromPoints(location, location);
+        else
+            range = location;
+
+        folds = this.getFoldsInRange(range);
+        if (expandInner) {
+            this.removeFolds(folds);
+        } else {
+            // TODO: might need to remove and add folds in one go instead of using
+            // expandFolds several times.
+            while (folds.length) {
+                this.expandFolds(folds);
+                folds = this.getFoldsInRange(range);
+            }
+        }
+    };
+
+    /**
+     * Checks if a given documentRow is folded. This is true if there are some
+     * folded parts such that some parts of the line is still visible.
+     **/
+    this.isRowFolded = function(docRow, startFoldRow) {
+        return !!this.getFoldLine(docRow, startFoldRow);
+    };
+
+    this.getRowFoldEnd = function(docRow, startFoldRow) {
+        var foldLine = this.getFoldLine(docRow, startFoldRow);
+        return (foldLine
+            ? foldLine.end.row
+            : docRow);
+    };
+
+    this.getFoldDisplayLine = function(foldLine, endRow, endColumn, startRow, startColumn) {
+        if (startRow == null) {
+            startRow = foldLine.start.row;
+            startColumn = 0;
+        }
+
+        if (endRow == null) {
+            endRow = foldLine.end.row;
+            endColumn = this.getLine(endRow).length;
+        }
+
+        // Build the textline using the FoldLine walker.
+        var doc = this.doc;
+        var textLine = "";
+
+        foldLine.walk(function(placeholder, row, column, lastColumn) {
+            if (row < startRow) {
+                return;
+            } else if (row == startRow) {
+                if (column < startColumn) {
+                    return;
+                }
+                lastColumn = Math.max(startColumn, lastColumn);
+            }
+            if (placeholder) {
+                textLine += placeholder;
+            } else {
+                textLine += doc.getLine(row).substring(lastColumn, column);
+            }
+        }.bind(this), endRow, endColumn);
+        return textLine;
+    };
+
+    this.getDisplayLine = function(row, endColumn, startRow, startColumn) {
+        var foldLine = this.getFoldLine(row);
+
+        if (!foldLine) {
+            var line;
+            line = this.doc.getLine(row);
+            return line.substring(startColumn || 0, endColumn || line.length);
+        } else {
+            return this.getFoldDisplayLine(
+                foldLine, row, endColumn, startRow, startColumn);
+        }
+    };
+
+    this.$cloneFoldData = function() {
+        var fd = [];
+        fd = this.$foldData.map(function(foldLine) {
+            var folds = foldLine.folds.map(function(fold) {
+                return fold.clone();
+            });
+            return new FoldLine(fd, folds);
+        });
+
+        return fd;
+    };
+
+    this.toggleFold = function(tryToUnfold) {
+        var selection = this.selection;
+        var range = selection.getRange();
+        var fold;
+        var bracketPos;
+
+        if (range.isEmpty()) {
+            var cursor = range.start;
+            fold = this.getFoldAt(cursor.row, cursor.column);
+
+            if (fold) {
+                this.expandFold(fold);
+                return;
+            }
+            else if (bracketPos = this.findMatchingBracket(cursor)) {
+                if (range.comparePoint(bracketPos) == 1) {
+                    range.end = bracketPos;
+                } 
+                else {
+                    range.start = bracketPos;
+                    range.start.column++;
+                    range.end.column--;
+                }
+            }
+            else if (bracketPos = this.findMatchingBracket({row: cursor.row, column: cursor.column + 1})) {
+                if (range.comparePoint(bracketPos) == 1)
+                    range.end = bracketPos;
+                else
+                    range.start = bracketPos;
+
+                range.start.column++;
+            }
+            else {
+                range = this.getCommentFoldRange(cursor.row, cursor.column) || range;
+            }
+        } else {
+            var folds = this.getFoldsInRange(range);
+            if (tryToUnfold && folds.length) {
+                this.expandFolds(folds);
+                return;
+            } 
+            else if (folds.length == 1 ) {
+                fold = folds[0];
+            }
+        }
+
+        if (!fold)
+            fold = this.getFoldAt(range.start.row, range.start.column);
+
+        if (fold && fold.range.toString() == range.toString()) {
+            this.expandFold(fold);
+            return;
+        }
+
+        var placeholder = "...";
+        if (!range.isMultiLine()) {
+            placeholder = this.getTextRange(range);
+            if(placeholder.length < 4)
+                return;
+            placeholder = placeholder.trim().substring(0, 2) + "..";
+        }
+
+        this.addFold(placeholder, range);
+    };
+
+    this.getCommentFoldRange = function(row, column) {
+        var iterator = new TokenIterator(this, row, column);
+        var token = iterator.getCurrentToken();
+        if (token && /^comment|string/.test(token.type)) {
+            var range = new Range();
+            var re = new RegExp(token.type.replace(/\..*/, "\\."));
+            do {
+                token = iterator.stepBackward();
+            } while(token && re.test(token.type));
+
+            iterator.stepForward();
+            range.start.row = iterator.getCurrentTokenRow();
+            range.start.column = iterator.getCurrentTokenColumn() + 2;
+
+            iterator = new TokenIterator(this, row, column);
+
+            do {
+                token = iterator.stepForward();
+            } while(token && re.test(token.type));
+            
+            token = iterator.stepBackward();
+
+            range.end.row = iterator.getCurrentTokenRow();
+            range.end.column = iterator.getCurrentTokenColumn() + token.value.length;
+            return range;
+        }
+    };
+
+    this.foldAll = function(startRow, endRow) {
+        var foldWidgets = this.foldWidgets;
+        endRow = endRow || foldWidgets.length;
+        for (var row = startRow || 0; row < endRow; row++) {
+            if (foldWidgets[row] == null)
+                foldWidgets[row] = this.getFoldWidget(row);
+            if (foldWidgets[row] != "start")
+                continue;
+
+            var range = this.getFoldWidgetRange(row);
+            // sometimes range can be incompatible with existing fold
+            // wouldn't it be better for addFold to return null istead of throwing?
+            if (range && range.end.row < endRow) try {
+                this.addFold("...", range);
+            } catch(e) {}
+        }
+    };
+    
+    this.$foldStyles = {
+        "manual": 1,
+        "markbegin": 1,
+        "markbeginend": 1
+    };
+    this.$foldStyle = "markbegin";
+    this.setFoldStyle = function(style) {
+        if (!this.$foldStyles[style])
+            throw new Error("invalid fold style: " + style + "[" + Object.keys(this.$foldStyles).join(", ") + "]");
+        
+        if (this.$foldStyle == style)
+            return;
+
+        this.$foldStyle = style;
+        
+        if (style == "manual")
+            this.unfold();
+        
+        // reset folding
+        var mode = this.$foldMode;
+        this.$setFolding(null);
+        this.$setFolding(mode);
+    };
+
+    // structured folding
+    this.$setFolding = function(foldMode) {
+        if (this.$foldMode == foldMode)
+            return;
+            
+        this.$foldMode = foldMode;
+        
+        this.removeListener('change', this.$updateFoldWidgets);
+        this._emit("changeAnnotation");
+        
+        if (!foldMode || this.$foldStyle == "manual") {
+            this.foldWidgets = null;
+            return;
+        }
+        
+        this.foldWidgets = [];
+        this.getFoldWidget = foldMode.getFoldWidget.bind(foldMode, this, this.$foldStyle);
+        this.getFoldWidgetRange = foldMode.getFoldWidgetRange.bind(foldMode, this, this.$foldStyle);
+        
+        this.$updateFoldWidgets = this.updateFoldWidgets.bind(this);
+        this.on('change', this.$updateFoldWidgets);
+        
+    };
+
+    this.onFoldWidgetClick = function(row, e) {
+        var type = this.getFoldWidget(row);
+        var line = this.getLine(row);
+        var onlySubfolds = e.shiftKey;
+        var addSubfolds = onlySubfolds || e.ctrlKey || e.altKey || e.metaKey;
+        var fold;
+
+        if (type == "end")
+            fold = this.getFoldAt(row, 0, -1);
+        else
+            fold = this.getFoldAt(row, line.length, 1);
+
+        if (fold) {
+            if (addSubfolds)
+                this.removeFold(fold);
+            else
+                this.expandFold(fold);
+            return;
+        }
+
+        var range = this.getFoldWidgetRange(row);
+        if (range) {
+            if (!onlySubfolds)
+                this.addFold("...", range);
+
+            if (addSubfolds)
+                this.foldAll(range.start.row + 1, range.end.row);
+        }
+    };
+    
+    this.updateFoldWidgets = function(e) {
+        var delta = e.data;
+        var range = delta.range;
+        var firstRow = range.start.row;
+        var len = range.end.row - firstRow;
+
+        if (len === 0) {
+            this.foldWidgets[firstRow] = null;
+        } else if (delta.action == "removeText" || delta.action == "removeLines") {
+            this.foldWidgets.splice(firstRow, len + 1, null);
+        } else {
+            var args = Array(len + 1);
+            args.unshift(firstRow, 1);
+            this.foldWidgets.splice.apply(this.foldWidgets, args);
+        }
+    };
+
+}
+
+exports.Folding = Folding;
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Julian Viereck <julian DOT viereck AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/edit_session/fold_line', ['require', 'exports', 'module' , 'ace/range'], function(require, exports, module) {
+
+var Range = require("../range").Range;
+
+/**
+ * If an array is passed in, the folds are expected to be sorted already.
+ */
+function FoldLine(foldData, folds) {
+    this.foldData = foldData;
+    if (Array.isArray(folds)) {
+        this.folds = folds;
+    } else {
+        folds = this.folds = [ folds ];
+    }
+
+    var last = folds[folds.length - 1]
+    this.range = new Range(folds[0].start.row, folds[0].start.column,
+                           last.end.row, last.end.column);
+    this.start = this.range.start;
+    this.end   = this.range.end;
+
+    this.folds.forEach(function(fold) {
+        fold.setFoldLine(this);
+    }, this);
+}
+
+(function() {
+    /**
+     * Note: This doesn't update wrapData!
+     */
+    this.shiftRow = function(shift) {
+        this.start.row += shift;
+        this.end.row += shift;
+        this.folds.forEach(function(fold) {
+            fold.start.row += shift;
+            fold.end.row += shift;
+        });
+    }
+
+    this.addFold = function(fold) {
+        if (fold.sameRow) {
+            if (fold.start.row < this.startRow || fold.endRow > this.endRow) {
+                throw "Can't add a fold to this FoldLine as it has no connection";
+            }
+            this.folds.push(fold);
+            this.folds.sort(function(a, b) {
+                return -a.range.compareEnd(b.start.row, b.start.column);
+            });
+            if (this.range.compareEnd(fold.start.row, fold.start.column) > 0) {
+                this.end.row = fold.end.row;
+                this.end.column =  fold.end.column;
+            } else if (this.range.compareStart(fold.end.row, fold.end.column) < 0) {
+                this.start.row = fold.start.row;
+                this.start.column = fold.start.column;
+            }
+        } else if (fold.start.row == this.end.row) {
+            this.folds.push(fold);
+            this.end.row = fold.end.row;
+            this.end.column = fold.end.column;
+        } else if (fold.end.row == this.start.row) {
+            this.folds.unshift(fold);
+            this.start.row = fold.start.row;
+            this.start.column = fold.start.column;
+        } else {
+            throw "Trying to add fold to FoldRow that doesn't have a matching row";
+        }
+        fold.foldLine = this;
+    }
+
+    this.containsRow = function(row) {
+        return row >= this.start.row && row <= this.end.row;
+    }
+
+    this.walk = function(callback, endRow, endColumn) {
+        var lastEnd = 0,
+            folds = this.folds,
+            fold,
+            comp, stop, isNewRow = true;
+
+        if (endRow == null) {
+            endRow = this.end.row;
+            endColumn = this.end.column;
+        }
+
+        for (var i = 0; i < folds.length; i++) {
+            fold = folds[i];
+
+            comp = fold.range.compareStart(endRow, endColumn);
+            // This fold is after the endRow/Column.
+            if (comp == -1) {
+                callback(null, endRow, endColumn, lastEnd, isNewRow);
+                return;
+            }
+
+            stop = callback(null, fold.start.row, fold.start.column, lastEnd, isNewRow);
+            stop = !stop && callback(fold.placeholder, fold.start.row, fold.start.column, lastEnd);
+
+            // If the user requested to stop the walk or endRow/endColumn is
+            // inside of this fold (comp == 0), then end here.
+            if (stop || comp == 0) {
+                return;
+            }
+
+            // Note the new lastEnd might not be on the same line. However,
+            // it's the callback's job to recognize this.
+            isNewRow = !fold.sameRow;
+            lastEnd = fold.end.column;
+        }
+        callback(null, endRow, endColumn, lastEnd, isNewRow);
+    }
+
+    this.getNextFoldTo = function(row, column) {
+        var fold, cmp;
+        for (var i = 0; i < this.folds.length; i++) {
+            fold = this.folds[i];
+            cmp = fold.range.compareEnd(row, column);
+            if (cmp == -1) {
+                return {
+                    fold: fold,
+                    kind: "after"
+                };
+            } else if (cmp == 0) {
+                return {
+                    fold: fold,
+                    kind: "inside"
+                }
+            }
+        }
+        return null;
+    }
+
+    this.addRemoveChars = function(row, column, len) {
+        var ret = this.getNextFoldTo(row, column),
+            fold, folds;
+        if (ret) {
+            fold = ret.fold;
+            if (ret.kind == "inside"
+                && fold.start.column != column
+                && fold.start.row != row)
+            {
+                throw "Moving characters inside of a fold should never be reached";
+            } else if (fold.start.row == row) {
+                folds = this.folds;
+                var i = folds.indexOf(fold);
+                if (i == 0) {
+                    this.start.column += len;
+                }
+                for (i; i < folds.length; i++) {
+                    fold = folds[i];
+                    fold.start.column += len;
+                    if (!fold.sameRow) {
+                        return;
+                    }
+                    fold.end.column += len;
+                }
+                this.end.column += len;
+            }
+        }
+    }
+
+    this.split = function(row, column) {
+        var fold = this.getNextFoldTo(row, column).fold,
+            folds = this.folds;
+        var foldData = this.foldData;
+
+        if (!fold) {
+            return null;
+        }
+        var i = folds.indexOf(fold);
+        var foldBefore = folds[i - 1];
+        this.end.row = foldBefore.end.row;
+        this.end.column = foldBefore.end.column;
+
+        // Remove the folds after row/column and create a new FoldLine
+        // containing these removed folds.
+        folds = folds.splice(i, folds.length - i);
+
+        var newFoldLine = new FoldLine(foldData, folds);
+        foldData.splice(foldData.indexOf(this) + 1, 0, newFoldLine);
+        return newFoldLine;
+    }
+
+    this.merge = function(foldLineNext) {
+        var folds = foldLineNext.folds;
+        for (var i = 0; i < folds.length; i++) {
+            this.addFold(folds[i]);
+        }
+        // Remove the foldLineNext - no longer needed, as
+        // it's merged now with foldLineNext.
+        var foldData = this.foldData;
+        foldData.splice(foldData.indexOf(foldLineNext), 1);
+    }
+
+    this.toString = function() {
+        var ret = [this.range.toString() + ": [" ];
+
+        this.folds.forEach(function(fold) {
+            ret.push("  " + fold.toString());
+        });
+        ret.push("]")
+        return ret.join("\n");
+    }
+
+    this.idxToPosition = function(idx) {
+        var lastFoldEndColumn = 0;
+        var fold;
+
+        for (var i = 0; i < this.folds.length; i++) {
+            var fold = this.folds[i];
+
+            idx -= fold.start.column - lastFoldEndColumn;
+            if (idx < 0) {
+                return {
+                    row: fold.start.row,
+                    column: fold.start.column + idx
+                };
+            }
+
+            idx -= fold.placeholder.length;
+            if (idx < 0) {
+                return fold.start;
+            }
+
+            lastFoldEndColumn = fold.end.column;
+        }
+
+        return {
+            row: this.end.row,
+            column: this.end.column + idx
+        };
+    }
+}).call(FoldLine.prototype);
+
+exports.FoldLine = FoldLine;
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Julian Viereck <julian DOT viereck AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/edit_session/fold', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+/**
+ * Simple fold-data struct.
+ **/
+var Fold = exports.Fold = function(range, placeholder) {
+    this.foldLine = null;
+    this.placeholder = placeholder;
+    this.range = range;
+    this.start = range.start;
+    this.end = range.end;
+
+    this.sameRow = range.start.row == range.end.row;
+    this.subFolds = [];
+};
+
+(function() {
+
+    this.toString = function() {
+        return '"' + this.placeholder + '" ' + this.range.toString();
+    };
+
+    this.setFoldLine = function(foldLine) {
+        this.foldLine = foldLine;
+        this.subFolds.forEach(function(fold) {
+            fold.setFoldLine(foldLine);
+        });
+    };
+
+    this.clone = function() {
+        var range = this.range.clone();
+        var fold = new Fold(range, this.placeholder);
+        this.subFolds.forEach(function(subFold) {
+            fold.subFolds.push(subFold.clone());
+        });
+        return fold;
+    };
+
+    this.addSubFold = function(fold) {
+        if (this.range.isEequal(fold))
+            return this;
+
+        if (!this.range.containsRange(fold))
+            throw "A fold can't intersect already existing fold" + fold.range + this.range;
+
+        var row = fold.range.start.row, column = fold.range.start.column;
+        for (var i = 0, cmp = -1; i < this.subFolds.length; i++) {
+            cmp = this.subFolds[i].range.compare(row, column);
+            if (cmp != 1)
+                break;
+        }
+        var afterStart = this.subFolds[i];
+
+        if (cmp == 0)
+            return afterStart.addSubFold(fold)
+
+        // cmp == -1
+        var row = fold.range.end.row, column = fold.range.end.column;
+        for (var j = i, cmp = -1; j < this.subFolds.length; j++) {
+            cmp = this.subFolds[j].range.compare(row, column);
+            if (cmp != 1)
+                break;
+        }
+        var afterEnd = this.subFolds[j];
+
+        if (cmp == 0)
+            throw "A fold can't intersect already existing fold" + fold.range + this.range;
+
+        var consumedFolds = this.subFolds.splice(i, j - i, fold)
+        fold.setFoldLine(this.foldLine);
+
+        return fold;
+    }
+
+}).call(Fold.prototype);
+
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/token_iterator', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var TokenIterator = function(session, initialRow, initialColumn) {
+    this.$session = session;
+    this.$row = initialRow;
+    this.$rowTokens = session.getTokens(initialRow, initialRow)[0].tokens;
+
+    var token = session.getTokenAt(initialRow, initialColumn);
+    this.$tokenIndex = token ? token.index : -1;
+};
+
+(function() {
+    
+    this.stepBackward = function() {
+        this.$tokenIndex -= 1;
+        
+        while (this.$tokenIndex < 0) {
+            this.$row -= 1;
+            if (this.$row < 0) {
+                this.$row = 0;
+                return null;
+            }
+                
+            this.$rowTokens = this.$session.getTokens(this.$row, this.$row)[0].tokens;
+            this.$tokenIndex = this.$rowTokens.length - 1;
+        }
+            
+        return this.$rowTokens[this.$tokenIndex];
+    };
+    
+    this.stepForward = function() {
+        var rowCount = this.$session.getLength();
+        this.$tokenIndex += 1;
+        
+        while (this.$tokenIndex >= this.$rowTokens.length) {
+            this.$row += 1;
+            if (this.$row >= rowCount) {
+                this.$row = rowCount - 1;
+                return null;
+            }
+
+            this.$rowTokens = this.$session.getTokens(this.$row, this.$row)[0].tokens;
+            this.$tokenIndex = 0;
+        }
+            
+        return this.$rowTokens[this.$tokenIndex];
+    };
+    
+    this.getCurrentToken = function () {
+        return this.$rowTokens[this.$tokenIndex];
+    };
+    
+    this.getCurrentTokenRow = function () {
+        return this.$row;
+    };
+    
+    this.getCurrentTokenColumn = function() {
+        var rowTokens = this.$rowTokens;
+        var tokenIndex = this.$tokenIndex;
+        
+        // If a column was cached by EditSession.getTokenAt, then use it
+        var column = rowTokens[tokenIndex].start;
+        if (column !== undefined)
+            return column;
+            
+        column = 0;
+        while (tokenIndex > 0) {
+            tokenIndex -= 1;
+            column += rowTokens[tokenIndex].value.length;
+        }
+        
+        return column;  
+    };
+            
+}).call(TokenIterator.prototype);
+
+exports.TokenIterator = TokenIterator;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/edit_session/bracket_match', ['require', 'exports', 'module' , 'ace/token_iterator'], function(require, exports, module) {
+
+var TokenIterator = require("../token_iterator").TokenIterator;
+
+function BracketMatch() {
+
+    this.findMatchingBracket = function(position) {
+        if (position.column == 0) return null;
+
+        var charBeforeCursor = this.getLine(position.row).charAt(position.column-1);
+        if (charBeforeCursor == "") return null;
+
+        var match = charBeforeCursor.match(/([\(\[\{])|([\)\]\}])/);
+        if (!match) {
+            return null;
+        }
+
+        if (match[1]) {
+            return this.$findClosingBracket(match[1], position);
+        } else {
+            return this.$findOpeningBracket(match[2], position);
+        }
+    };
+
+    this.$brackets = {
+        ")": "(",
+        "(": ")",
+        "]": "[",
+        "[": "]",
+        "{": "}",
+        "}": "{"
+    };
+
+    this.$findOpeningBracket = function(bracket, position) {
+        var openBracket = this.$brackets[bracket];
+        var depth = 1;
+
+        var iterator = new TokenIterator(this, position.row, position.column);
+        var token = iterator.getCurrentToken();
+        if (!token) return null;
+        
+        // token.type contains a period-delimited list of token identifiers
+        // (e.g.: "constant.numeric" or "paren.lparen").  Create a pattern that
+        // matches any token containing the same identifiers or a subset.  In
+        // addition, if token.type includes "rparen", then also match "lparen".
+        // So if type.token is "paren.rparen", then typeRe will match "lparen.paren".
+        var typeRe = new RegExp("(\\.?" +
+            token.type.replace(".", "|").replace("rparen", "lparen|rparen") + ")+");
+        
+        // Start searching in token, just before the character at position.column
+        var valueIndex = position.column - iterator.getCurrentTokenColumn() - 2;
+        var value = token.value;
+        
+        while (true) {
+        
+            while (valueIndex >= 0) {
+                var char = value.charAt(valueIndex);
+                if (char == openBracket) {
+                    depth -= 1;
+                    if (depth == 0) {
+                        return {row: iterator.getCurrentTokenRow(),
+                            column: valueIndex + iterator.getCurrentTokenColumn()};
+                    }
+                }
+                else if (char == bracket) {
+                    depth += 1;
+                }
+                valueIndex -= 1;
+            }
+
+            // Scan backward through the document, looking for the next token
+            // whose type matches typeRe
+            do {
+                token = iterator.stepBackward();
+            } while (token && !typeRe.test(token.type));
+
+            if (token == null)
+                break;
+                
+            value = token.value;
+            valueIndex = value.length - 1;
+        }
+        
+        return null;
+    };
+
+    this.$findClosingBracket = function(bracket, position) {
+        var closingBracket = this.$brackets[bracket];
+        var depth = 1;
+
+        var iterator = new TokenIterator(this, position.row, position.column);
+        var token = iterator.getCurrentToken();
+        if (!token) return null;
+
+        // token.type contains a period-delimited list of token identifiers
+        // (e.g.: "constant.numeric" or "paren.lparen").  Create a pattern that
+        // matches any token containing the same identifiers or a subset.  In
+        // addition, if token.type includes "lparen", then also match "rparen".
+        // So if type.token is "lparen.paren", then typeRe will match "paren.rparen".
+        var typeRe = new RegExp("(\\.?" +
+            token.type.replace(".", "|").replace("lparen", "lparen|rparen") + ")+");
+
+        // Start searching in token, after the character at position.column
+        var valueIndex = position.column - iterator.getCurrentTokenColumn();
+
+        while (true) {
+
+            var value = token.value;
+            var valueLength = value.length;
+            while (valueIndex < valueLength) {
+                var char = value.charAt(valueIndex);
+                if (char == closingBracket) {
+                    depth -= 1;
+                    if (depth == 0) {
+                        return {row: iterator.getCurrentTokenRow(),
+                            column: valueIndex + iterator.getCurrentTokenColumn()};
+                    }
+                }
+                else if (char == bracket) {
+                    depth += 1;
+                }
+                valueIndex += 1;
+            }
+
+            // Scan forward through the document, looking for the next token
+            // whose type matches typeRe
+            do {
+                token = iterator.stepForward();
+            } while (token && !typeRe.test(token.type));
+
+            if (token == null)
+                break;
+
+            valueIndex = 0;
+        }
+        
+        return null;
+    };
+}
+exports.BracketMatch = BracketMatch;
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai DOT sucan AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/search', ['require', 'exports', 'module' , 'ace/lib/lang', 'ace/lib/oop', 'ace/range'], function(require, exports, module) {
+
+var lang = require("./lib/lang");
+var oop = require("./lib/oop");
+var Range = require("./range").Range;
+
+var Search = function() {
+    this.$options = {
+        needle: "",
+        backwards: false,
+        wrap: false,
+        caseSensitive: false,
+        wholeWord: false,
+        scope: Search.ALL,
+        regExp: false
+    };
+};
+
+Search.ALL = 1;
+Search.SELECTION = 2;
+
+(function() {
+
+    this.set = function(options) {
+        oop.mixin(this.$options, options);
+        return this;
+    };
+    
+    this.getOptions = function() {
+        return lang.copyObject(this.$options);
+    };
+
+    this.find = function(session) {
+        if (!this.$options.needle)
+            return null;
+
+        if (this.$options.backwards) {
+            var iterator = this.$backwardMatchIterator(session);
+        } else {
+            iterator = this.$forwardMatchIterator(session);
+        }
+
+        var firstRange = null;
+        iterator.forEach(function(range) {
+            firstRange = range;
+            return true;
+        });
+
+        return firstRange;
+    };
+
+    this.findAll = function(session) {
+        var options = this.$options;
+        if (!options.needle)
+            return [];
+
+        if (options.backwards) {
+            var iterator = this.$backwardMatchIterator(session);
+        } else {
+            iterator = this.$forwardMatchIterator(session);
+        }
+
+        var ignoreCursor = !options.start && options.wrap && options.scope == Search.ALL;
+        if (ignoreCursor)
+            options.start = {row: 0, column: 0};
+
+        var ranges = [];
+        iterator.forEach(function(range) {
+            ranges.push(range);
+        });
+
+        if (ignoreCursor)
+            options.start = null;
+
+        return ranges;
+    };
+
+    this.replace = function(input, replacement) {
+        var re = this.$assembleRegExp();
+        var match = re.exec(input);
+        if (match && match[0].length == input.length) {
+            if (this.$options.regExp) {
+                return input.replace(re, replacement);
+            } else {
+                return replacement;
+            }
+        } else {
+            return null;
+        }
+    };
+
+    this.$forwardMatchIterator = function(session) {
+        var re = this.$assembleRegExp();
+        var self = this;
+
+        return {
+            forEach: function(callback) {
+                self.$forwardLineIterator(session).forEach(function(line, startIndex, row) {
+                    if (startIndex) {
+                        line = line.substring(startIndex);
+                    }
+
+                    var matches = [];
+
+                    line.replace(re, function(str) {
+                        var offset = arguments[arguments.length-2];
+                        matches.push({
+                            str: str,
+                            offset: startIndex + offset
+                        });
+                        return str;
+                    });
+
+                    for (var i=0; i<matches.length; i++) {
+                        var match = matches[i];
+                        var range = self.$rangeFromMatch(row, match.offset, match.str.length);
+                        if (callback(range))
+                            return true;
+                    }
+
+                });
+            }
+        };
+    };
+
+    this.$backwardMatchIterator = function(session) {
+        var re = this.$assembleRegExp();
+        var self = this;
+
+        return {
+            forEach: function(callback) {
+                self.$backwardLineIterator(session).forEach(function(line, startIndex, row) {
+                    if (startIndex) {
+                        line = line.substring(startIndex);
+                    }
+
+                    var matches = [];
+
+                    line.replace(re, function(str, offset) {
+                        matches.push({
+                            str: str,
+                            offset: startIndex + offset
+                        });
+                        return str;
+                    });
+
+                    for (var i=matches.length-1; i>= 0; i--) {
+                        var match = matches[i];
+                        var range = self.$rangeFromMatch(row, match.offset, match.str.length);
+                        if (callback(range))
+                            return true;
+                    }
+                });
+            }
+        };
+    };
+
+    this.$rangeFromMatch = function(row, column, length) {
+        return new Range(row, column, row, column+length);
+    };
+
+    this.$assembleRegExp = function() {
+        if (this.$options.regExp) {
+            var needle = this.$options.needle;
+        } else {
+            needle = lang.escapeRegExp(this.$options.needle);
+        }
+
+        if (this.$options.wholeWord) {
+            needle = "\\b" + needle + "\\b";
+        }
+
+        var modifier = "g";
+        if (!this.$options.caseSensitive) {
+            modifier += "i";
+        }
+
+        var re = new RegExp(needle, modifier);
+        return re;
+    };
+
+    this.$forwardLineIterator = function(session) {
+        var searchSelection = this.$options.scope == Search.SELECTION;
+
+        var range = this.$options.range || session.getSelection().getRange();
+        var start = this.$options.start || range[searchSelection ? "start" : "end"];
+
+        var firstRow = searchSelection ? range.start.row : 0;
+        var firstColumn = searchSelection ? range.start.column : 0;
+        var lastRow = searchSelection ? range.end.row : session.getLength() - 1;
+
+        var wrap = this.$options.wrap;
+        var inWrap = false;
+
+        function getLine(row) {
+            var line = session.getLine(row);
+            if (searchSelection && row == range.end.row) {
+                line = line.substring(0, range.end.column);
+            }
+            if (inWrap && row == start.row) {
+                line = line.substring(0, start.column);
+            }
+            return line;
+        }
+
+        return {
+            forEach: function(callback) {
+                var row = start.row;
+
+                var line = getLine(row);
+                var startIndex = start.column;
+
+                var stop = false;
+                inWrap = false;
+
+                while (!callback(line, startIndex, row)) {
+
+                    if (stop) {
+                        return;
+                    }
+
+                    row++;
+                    startIndex = 0;
+
+                    if (row > lastRow) {
+                        if (wrap) {
+                            row = firstRow;
+                            startIndex = firstColumn;
+                            inWrap = true;
+                        } else {
+                            return;
+                        }
+                    }
+
+                    if (row == start.row)
+                        stop = true;
+
+                    line = getLine(row);
+                }
+            }
+        };
+    };
+
+    this.$backwardLineIterator = function(session) {
+        var searchSelection = this.$options.scope == Search.SELECTION;
+
+        var range = this.$options.range || session.getSelection().getRange();
+        var start = this.$options.start || range[searchSelection ? "end" : "start"];
+
+        var firstRow = searchSelection ? range.start.row : 0;
+        var firstColumn = searchSelection ? range.start.column : 0;
+        var lastRow = searchSelection ? range.end.row : session.getLength() - 1;
+
+        var wrap = this.$options.wrap;
+
+        return {
+            forEach : function(callback) {
+                var row = start.row;
+
+                var line = session.getLine(row).substring(0, start.column);
+                var startIndex = 0;
+                var stop = false;
+                var inWrap = false;
+
+                while (!callback(line, startIndex, row)) {
+
+                    if (stop)
+                        return;
+
+                    row--;
+                    startIndex = 0;
+
+                    if (row < firstRow) {
+                        if (wrap) {
+                            row = lastRow;
+                            inWrap = true;
+                        } else {
+                            return;
+                        }
+                    }
+
+                    if (row == start.row)
+                        stop = true;
+
+                    line = session.getLine(row);
+                    if (searchSelection) {
+                        if (row == firstRow)
+                            startIndex = firstColumn;
+                        else if (row == lastRow)
+                            line = line.substring(0, range.end.column);
+                    }
+
+                    if (inWrap && row == start.row)
+                        startIndex = start.column;
+                }
+            }
+        };
+    };
+
+}).call(Search.prototype);
+
+exports.Search = Search;
+});
+define('ace/commands/command_manager', ['require', 'exports', 'module' , 'ace/lib/keys'], function(require, exports, module) {
+
+var keyUtil = require("../lib/keys");
+
+var CommandManager = function(platform, commands) {
+    if (typeof platform !== "string")
+        throw new TypeError("'platform' argument must be either 'mac' or 'win'");
+
+    this.platform = platform;
+    this.commands = {};
+    this.commmandKeyBinding = {};
+
+    if (commands)
+        commands.forEach(this.addCommand, this);
+};
+
+(function() {
+
+    this.addCommand = function(command) {
+        if (this.commands[command.name])
+            this.removeCommand(command);
+
+        this.commands[command.name] = command;
+
+        if (command.bindKey) {
+            this._buildKeyHash(command);
+        }
+    };
+
+    this.removeCommand = function(command) {
+        var name = (typeof command === 'string' ? command : command.name);
+        command = this.commands[name];
+        delete this.commands[name];
+
+        // exaustive search is brute force but since removeCommand is
+        // not a performance critical operation this should be OK
+        var ckb = this.commmandKeyBinding;
+        for (var hashId in ckb) {
+            for (var key in ckb[hashId]) {
+                if (ckb[hashId][key] == command)
+                    delete ckb[hashId][key];
+            }
+        }
+    };
+
+    this.addCommands = function(commands) {
+        Object.keys(commands).forEach(function(name) {
+            var command = commands[name];
+            if (typeof command === "string")
+                return this.bindKey(command, name);
+
+            if (typeof command === "function")
+                command = { exec: command };
+
+            if (!command.name)
+                command.name = name;
+
+            this.addCommand(command);
+        }, this);
+    };
+
+    this.removeCommands = function(commands) {
+        Object.keys(commands).forEach(function(name) {
+            this.removeCommand(commands[name]);
+        }, this);
+    };
+
+    this.bindKey = function(key, command) {
+        if(!key)
+            return;
+
+        var ckb = this.commmandKeyBinding;
+        key.split("|").forEach(function(keyPart) {
+            var binding = parseKeys(keyPart, command);
+            var hashId = binding.hashId;
+            (ckb[hashId] || (ckb[hashId] = {}))[binding.key] = command;
+        });
+    };
+
+    this.bindKeys = function(keyList) {
+        Object.keys(keyList).forEach(function(key) {
+            this.bindKey(key, keyList[key]);
+        }, this);
+    };
+
+    this._buildKeyHash = function(command) {
+        var binding = command.bindKey;
+        if (!binding)
+            return;
+
+        var key = typeof binding == "string" ? binding: binding[this.platform];
+        this.bindKey(key, command);
+    }
+
+    function parseKeys(keys, val, ret) {
+        var key;
+        var hashId = 0;
+        var parts = splitSafe(keys);
+
+        for (var i=0, l = parts.length; i < l; i++) {
+            if (keyUtil.KEY_MODS[parts[i]])
+                hashId = hashId | keyUtil.KEY_MODS[parts[i]];
+            else
+                key = parts[i] || "-"; //when empty, the splitSafe removed a '-'
+        }
+
+        return {
+            key: key,
+            hashId: hashId
+        }
+    }
+
+    function splitSafe(s, separator) {
+        return (s.toLowerCase()
+            .trim()
+            .split(new RegExp("[\\s ]*\\-[\\s ]*", "g"), 999));
+    }
+
+    this.findKeyCommand = function findKeyCommand(hashId, textOrKey) {
+        // Convert keyCode to the string representation.
+        if (typeof textOrKey == "number") {
+            textOrKey = keyUtil.keyCodeToString(textOrKey);
+        }
+
+        var ckbr = this.commmandKeyBinding;
+        return ckbr[hashId] && ckbr[hashId][textOrKey.toLowerCase()];
+    }
+
+    this.exec = function(command, editor, args) {
+        if (typeof command === 'string')
+            command = this.commands[command];
+
+        if (!command)
+            return false;
+
+        if (editor && editor.$readOnly && !command.readOnly)
+            return false;
+
+        command.exec(editor, args || {});
+        return true;
+    };
+
+    this.toggleRecording = function() {
+        if (this.$inReplay)
+            return;
+        if (this.recording) {
+            this.macro.pop();
+            this.exec = this.normal_exec;
+            return this.recording = false;
+        }
+        this.macro = [];
+        this.normal_exec = this.exec;
+        this.exec = function(command, editor, args) {
+            this.macro.push([command, args]);
+            return this.normal_exec(command, editor, args);
+        };
+        return this.recording = true;
+    };
+
+    this.replay = function(editor) {
+        if (this.$inReplay)
+            return;
+
+        if (!this.macro || this.recording)
+            return this.toggleRecording();
+
+        try {
+            this.$inReplay = true;
+            this.macro.forEach(function(x) {
+                if (typeof x == "string")
+                    this.exec(x, editor);
+                else
+                    this.exec(x[0], editor, x[1]);
+            }, this)
+        } finally {
+            this.$inReplay = false;
+        }
+    };
+
+    this.trimMacro = function(m) {
+        return m.map(function(x){
+            if (typeof x[0] != "string")
+                x[0] = x[0].name;
+            if (!x[1])
+                x = x[0];
+            return x
+        })
+    }
+
+}).call(CommandManager.prototype);
+
+exports.CommandManager = CommandManager;
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Mihai Sucan <mihai DOT sucan AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/undomanager', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var UndoManager = function() {
+    this.reset();
+};
+
+(function() {
+
+    this.execute = function(options) {
+        var deltas = options.args[0];
+        this.$doc  = options.args[1];
+        this.$undoStack.push(deltas);
+        this.$redoStack = [];
+    };
+
+    this.undo = function(dontSelect) {
+        var deltas = this.$undoStack.pop();
+        var undoSelectionRange = null;
+        if (deltas) {
+            undoSelectionRange =
+                this.$doc.undoChanges(deltas, dontSelect);
+            this.$redoStack.push(deltas);
+        }
+        return undoSelectionRange;
+    };
+
+    this.redo = function(dontSelect) {
+        var deltas = this.$redoStack.pop();
+        var redoSelectionRange = null;
+        if (deltas) {
+            redoSelectionRange =
+                this.$doc.redoChanges(deltas, dontSelect);
+            this.$undoStack.push(deltas);
+        }
+        return redoSelectionRange;
+    };
+
+    this.reset = function() {
+        this.$undoStack = [];
+        this.$redoStack = [];
+    };
+
+    this.hasUndo = function() {
+        return this.$undoStack.length > 0;
+    };
+
+    this.hasRedo = function() {
+        return this.$redoStack.length > 0;
+    };
+
+}).call(UndoManager.prototype);
+
+exports.UndoManager = UndoManager;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian at ajax.org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/virtual_renderer', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/dom', 'ace/lib/event', 'ace/lib/useragent', 'ace/layer/gutter', 'ace/layer/marker', 'ace/layer/text', 'ace/layer/cursor', 'ace/scrollbar', 'ace/renderloop', 'ace/lib/event_emitter', 'text!ace/css/editor.css'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var dom = require("./lib/dom");
+var event = require("./lib/event");
+var useragent = require("./lib/useragent");
+var GutterLayer = require("./layer/gutter").Gutter;
+var MarkerLayer = require("./layer/marker").Marker;
+var TextLayer = require("./layer/text").Text;
+var CursorLayer = require("./layer/cursor").Cursor;
+var ScrollBar = require("./scrollbar").ScrollBar;
+var RenderLoop = require("./renderloop").RenderLoop;
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+var editorCss = require("text!./css/editor.css");
+
+dom.importCssString(editorCss, "ace_editor");
+
+var VirtualRenderer = function(container, theme) {
+    this.container = container;
+
+    // TODO: this breaks rendering in Cloud9 with multiple ace instances
+//    // Imports CSS once per DOM document ('ace_editor' serves as an identifier).
+//    dom.importCssString(editorCss, "ace_editor", container.ownerDocument);
+    
+    // Chrome has some strange rendering issues if this is not done async
+    setTimeout(function() {
+        dom.addCssClass(container, "ace_editor");
+    }, 0);
+
+    this.setTheme(theme);
+
+    this.$gutter = dom.createElement("div");
+    this.$gutter.className = "ace_gutter";
+    this.container.appendChild(this.$gutter);
+
+    this.scroller = dom.createElement("div");
+    this.scroller.className = "ace_scroller";
+    this.container.appendChild(this.scroller);
+
+    this.content = dom.createElement("div");
+    this.content.className = "ace_content";
+    this.scroller.appendChild(this.content);
+
+    this.$gutterLayer = new GutterLayer(this.$gutter);
+    this.$gutterLayer.on("changeGutterWidth", this.onResize.bind(this, true));    
+    
+    this.$markerBack = new MarkerLayer(this.content);
+
+    var textLayer = this.$textLayer = new TextLayer(this.content);
+    this.canvas = textLayer.element;
+
+    this.$markerFront = new MarkerLayer(this.content);
+
+    this.characterWidth = textLayer.getCharacterWidth();
+    this.lineHeight = textLayer.getLineHeight();
+
+    this.$cursorLayer = new CursorLayer(this.content);
+    this.$cursorPadding = 8;
+
+    // Indicates whether the horizontal scrollbar is visible
+    this.$horizScroll = true;
+    this.$horizScrollAlwaysVisible = true;
+
+    this.scrollBar = new ScrollBar(container);
+    this.scrollBar.addEventListener("scroll", this.onScroll.bind(this));
+
+    this.scrollTop = 0;
+
+    this.cursorPos = {
+        row : 0,
+        column : 0
+    };
+
+    var _self = this;
+    this.$textLayer.addEventListener("changeCharaterSize", function() {
+        _self.characterWidth = textLayer.getCharacterWidth();
+        _self.lineHeight = textLayer.getLineHeight();
+        _self.$updatePrintMargin();
+        _self.onResize(true);
+
+        _self.$loop.schedule(_self.CHANGE_FULL);
+    });
+
+    this.$size = {
+        width: 0,
+        height: 0,
+        scrollerHeight: 0,
+        scrollerWidth: 0
+    };
+
+    this.layerConfig = {
+        width : 1,
+        padding : 0,
+        firstRow : 0,
+        firstRowScreen: 0,
+        lastRow : 0,
+        lineHeight : 1,
+        characterWidth : 1,
+        minHeight : 1,
+        maxHeight : 1,
+        offset : 0,
+        height : 1
+    };
+
+    this.$loop = new RenderLoop(
+        this.$renderChanges.bind(this),
+        this.container.ownerDocument.defaultView
+    );
+    this.$loop.schedule(this.CHANGE_FULL);
+
+    this.setPadding(4);
+    this.$updatePrintMargin();
+};
+
+(function() {
+    this.showGutter = true;
+
+    this.CHANGE_CURSOR = 1;
+    this.CHANGE_MARKER = 2;
+    this.CHANGE_GUTTER = 4;
+    this.CHANGE_SCROLL = 8;
+    this.CHANGE_LINES = 16;
+    this.CHANGE_TEXT = 32;
+    this.CHANGE_SIZE = 64;
+    this.CHANGE_MARKER_BACK = 128;
+    this.CHANGE_MARKER_FRONT = 256;
+    this.CHANGE_FULL = 512;
+
+    oop.implement(this, EventEmitter);
+
+    this.setSession = function(session) {
+        this.session = session;
+        this.$cursorLayer.setSession(session);
+        this.$markerBack.setSession(session);
+        this.$markerFront.setSession(session);
+        this.$gutterLayer.setSession(session);
+        this.$textLayer.setSession(session);
+        this.$loop.schedule(this.CHANGE_FULL);
+    };
+
+    /**
+     * Triggers partial update of the text layer
+     */
+    this.updateLines = function(firstRow, lastRow) {
+        if (lastRow === undefined)
+            lastRow = Infinity;
+
+        if (!this.$changedLines) {
+            this.$changedLines = {
+                firstRow: firstRow,
+                lastRow: lastRow
+            };
+        }
+        else {
+            if (this.$changedLines.firstRow > firstRow)
+                this.$changedLines.firstRow = firstRow;
+
+            if (this.$changedLines.lastRow < lastRow)
+                this.$changedLines.lastRow = lastRow;
+        }
+
+        this.$loop.schedule(this.CHANGE_LINES);
+    };
+
+    /**
+     * Triggers full update of the text layer
+     */
+    this.updateText = function() {
+        this.$loop.schedule(this.CHANGE_TEXT);
+    };
+
+    /**
+     * Triggers a full update of all layers
+     */
+    this.updateFull = function() {
+        this.$loop.schedule(this.CHANGE_FULL);
+    };
+
+    this.updateFontSize = function() {
+        this.$textLayer.checkForSizeChanges();
+    };
+
+    /**
+     * Triggers resize of the editor
+     */
+    this.onResize = function(force) {
+        var changes = this.CHANGE_SIZE;
+        var size = this.$size;
+
+        var height = dom.getInnerHeight(this.container);
+        if (force || size.height != height) {
+            size.height = height;
+
+            this.scroller.style.height = height + "px";
+            size.scrollerHeight = this.scroller.clientHeight;
+            this.scrollBar.setHeight(size.scrollerHeight);
+
+            if (this.session) {
+                this.scrollToY(this.getScrollTop());
+                changes = changes | this.CHANGE_FULL;
+            }
+        }
+
+        var width = dom.getInnerWidth(this.container);
+        if (force || size.width != width) {
+            size.width = width;
+
+            var gutterWidth = this.showGutter ? this.$gutter.offsetWidth : 0;
+            this.scroller.style.left = gutterWidth + "px";
+            size.scrollerWidth = Math.max(0, width - gutterWidth - this.scrollBar.getWidth());
+            this.scroller.style.width = size.scrollerWidth + "px";
+
+            if (this.session.getUseWrapMode() && this.adjustWrapLimit() || force)
+                changes = changes | this.CHANGE_FULL;
+        }
+
+        this.$loop.schedule(changes);
+    };
+
+    this.adjustWrapLimit = function(){
+        var availableWidth = this.$size.scrollerWidth - this.$padding * 2;
+        var limit = Math.floor(availableWidth / this.characterWidth) - 1;
+        return this.session.adjustWrapLimit(limit);
+    };
+
+    this.setShowInvisibles = function(showInvisibles) {
+        if (this.$textLayer.setShowInvisibles(showInvisibles))
+            this.$loop.schedule(this.CHANGE_TEXT);
+    };
+
+    this.getShowInvisibles = function() {
+        return this.$textLayer.showInvisibles;
+    };
+
+    this.$showPrintMargin = true;
+    this.setShowPrintMargin = function(showPrintMargin) {
+        this.$showPrintMargin = showPrintMargin;
+        this.$updatePrintMargin();
+    };
+
+    this.getShowPrintMargin = function() {
+        return this.$showPrintMargin;
+    };
+
+    this.$printMarginColumn = 80;
+    this.setPrintMarginColumn = function(showPrintMargin) {
+        this.$printMarginColumn = showPrintMargin;
+        this.$updatePrintMargin();
+    };
+
+    this.getPrintMarginColumn = function() {
+        return this.$printMarginColumn;
+    };
+
+    this.getShowGutter = function(){
+        return this.showGutter;
+    };
+
+    this.setShowGutter = function(show){
+        if(this.showGutter === show)
+            return;
+        this.$gutter.style.display = show ? "block" : "none";
+        this.showGutter = show;
+        this.onResize(true);
+    };
+
+    this.$updatePrintMargin = function() {
+        var containerEl;
+
+        if (!this.$showPrintMargin && !this.$printMarginEl)
+            return;
+
+        if (!this.$printMarginEl) {
+            containerEl = dom.createElement("div");
+            containerEl.className = "ace_print_margin_layer";
+            this.$printMarginEl = dom.createElement("div");
+            this.$printMarginEl.className = "ace_print_margin";
+            containerEl.appendChild(this.$printMarginEl);
+            this.content.insertBefore(containerEl, this.$textLayer.element);
+        }
+
+        var style = this.$printMarginEl.style;
+        style.left = ((this.characterWidth * this.$printMarginColumn) + this.$padding * 2) + "px";
+        style.visibility = this.$showPrintMargin ? "visible" : "hidden";
+    };
+
+    this.getContainerElement = function() {
+        return this.container;
+    };
+
+    this.getMouseEventTarget = function() {
+        return this.content;
+    };
+
+    this.getTextAreaContainer = function() {
+        return this.container;
+    };
+
+    this.moveTextAreaToCursor = function(textarea) {
+        // in IE the native cursor always shines through
+        // this persists in IE9
+        if (useragent.isIE)
+            return;
+
+        var pos = this.$cursorLayer.getPixelPosition();
+        if (!pos)
+            return;
+
+        var bounds = this.content.getBoundingClientRect();
+        var offset = this.layerConfig.offset;
+
+        textarea.style.left = (bounds.left + pos.left + this.$padding) + "px";
+        textarea.style.top = (bounds.top + pos.top - this.scrollTop + offset) + "px";
+    };
+
+    this.getFirstVisibleRow = function() {
+        return this.layerConfig.firstRow;
+    };
+
+    this.getFirstFullyVisibleRow = function() {
+        return this.layerConfig.firstRow + (this.layerConfig.offset === 0 ? 0 : 1);
+    };
+
+    this.getLastFullyVisibleRow = function() {
+        var flint = Math.floor((this.layerConfig.height + this.layerConfig.offset) / this.layerConfig.lineHeight);
+        return this.layerConfig.firstRow - 1 + flint;
+    };
+
+    this.getLastVisibleRow = function() {
+        return this.layerConfig.lastRow;
+    };
+
+    this.$padding = null;
+    this.setPadding = function(padding) {
+        this.$padding = padding;
+        this.$textLayer.setPadding(padding);
+        this.$cursorLayer.setPadding(padding);
+        this.$markerFront.setPadding(padding);
+        this.$markerBack.setPadding(padding);
+        this.$loop.schedule(this.CHANGE_FULL);
+        this.$updatePrintMargin();
+    };
+
+    this.getHScrollBarAlwaysVisible = function() {
+        return this.$horizScrollAlwaysVisible;
+    };
+
+    this.setHScrollBarAlwaysVisible = function(alwaysVisible) {
+        if (this.$horizScrollAlwaysVisible != alwaysVisible) {
+            this.$horizScrollAlwaysVisible = alwaysVisible;
+            if (!this.$horizScrollAlwaysVisible || !this.$horizScroll)
+                this.$loop.schedule(this.CHANGE_SCROLL);
+        }
+    };
+
+    this.onScroll = function(e) {
+        this.scrollToY(e.data);
+    };
+
+    this.$updateScrollBar = function() {
+        this.scrollBar.setInnerHeight(this.layerConfig.maxHeight);
+        this.scrollBar.setScrollTop(this.scrollTop);
+    };
+
+    this.$renderChanges = function(changes) {
+        if (!changes || !this.session)
+            return;
+
+        // text, scrolling and resize changes can cause the view port size to change
+        if (changes & this.CHANGE_FULL ||
+            changes & this.CHANGE_SIZE ||
+            changes & this.CHANGE_TEXT ||
+            changes & this.CHANGE_LINES ||
+            changes & this.CHANGE_SCROLL
+        )
+            this.$computeLayerConfig();
+
+        // full
+        if (changes & this.CHANGE_FULL) {
+            this.$textLayer.update(this.layerConfig);
+            if (this.showGutter)
+                this.$gutterLayer.update(this.layerConfig);
+            this.$markerBack.update(this.layerConfig);
+            this.$markerFront.update(this.layerConfig);
+            this.$cursorLayer.update(this.layerConfig);
+            this.$updateScrollBar();
+            return;
+        }
+
+        // scrolling
+        if (changes & this.CHANGE_SCROLL) {
+            if (changes & this.CHANGE_TEXT || changes & this.CHANGE_LINES)
+                this.$textLayer.update(this.layerConfig);
+            else
+                this.$textLayer.scrollLines(this.layerConfig);
+
+            if (this.showGutter)
+                this.$gutterLayer.update(this.layerConfig);
+            this.$markerBack.update(this.layerConfig);
+            this.$markerFront.update(this.layerConfig);
+            this.$cursorLayer.update(this.layerConfig);
+            this.$updateScrollBar();
+            return;
+        }
+
+        if (changes & this.CHANGE_TEXT) {
+            this.$textLayer.update(this.layerConfig);
+            if (this.showGutter)
+                this.$gutterLayer.update(this.layerConfig);
+        }
+        else if (changes & this.CHANGE_LINES) {
+            this.$updateLines();
+            this.$updateScrollBar();
+            if (this.showGutter)
+                this.$gutterLayer.update(this.layerConfig);
+        } else if (changes & this.CHANGE_GUTTER) {
+            if (this.showGutter)
+                this.$gutterLayer.update(this.layerConfig);
+        }
+
+        if (changes & this.CHANGE_CURSOR)
+            this.$cursorLayer.update(this.layerConfig);
+
+        if (changes & (this.CHANGE_MARKER | this.CHANGE_MARKER_FRONT)) {
+            this.$markerFront.update(this.layerConfig);
+        }
+
+        if (changes & (this.CHANGE_MARKER | this.CHANGE_MARKER_BACK)) {
+            this.$markerBack.update(this.layerConfig);
+        }
+
+        if (changes & this.CHANGE_SIZE)
+            this.$updateScrollBar();
+    };
+
+    this.$computeLayerConfig = function() {
+        var session = this.session;
+
+        var offset = this.scrollTop % this.lineHeight;
+        var minHeight = this.$size.scrollerHeight + this.lineHeight;
+
+        var longestLine = this.$getLongestLine();
+
+        var horizScroll = this.$horizScrollAlwaysVisible || this.$size.scrollerWidth - longestLine < 0;
+        var horizScrollChanged = this.$horizScroll !== horizScroll;
+        this.$horizScroll = horizScroll;
+        if (horizScrollChanged)
+            this.scroller.style.overflowX = horizScroll ? "scroll" : "hidden";
+
+        var maxHeight = this.session.getScreenLength() * this.lineHeight;
+        this.scrollTop = Math.max(0, Math.min(this.scrollTop, maxHeight - this.$size.scrollerHeight));
+
+        var lineCount = Math.ceil(minHeight / this.lineHeight) - 1;
+        var firstRow = Math.max(0, Math.round((this.scrollTop - offset) / this.lineHeight));
+        var lastRow = firstRow + lineCount;
+
+        // Map lines on the screen to lines in the document.
+        var firstRowScreen, firstRowHeight;
+        var lineHeight = { lineHeight: this.lineHeight };
+        firstRow = session.screenToDocumentRow(firstRow, 0);
+
+        // Check if firstRow is inside of a foldLine. If true, then use the first
+        // row of the foldLine.
+        var foldLine = session.getFoldLine(firstRow);
+        if (foldLine) {
+            firstRow = foldLine.start.row;
+        }
+
+        firstRowScreen = session.documentToScreenRow(firstRow, 0);
+        firstRowHeight = session.getRowHeight(lineHeight, firstRow);
+
+        lastRow = Math.min(session.screenToDocumentRow(lastRow, 0), session.getLength() - 1);
+        minHeight = this.$size.scrollerHeight + session.getRowHeight(lineHeight, lastRow)+
+                                                firstRowHeight;
+
+        offset = this.scrollTop - firstRowScreen * this.lineHeight;
+
+        this.layerConfig = {
+            width : longestLine,
+            padding : this.$padding,
+            firstRow : firstRow,
+            firstRowScreen: firstRowScreen,
+            lastRow : lastRow,
+            lineHeight : this.lineHeight,
+            characterWidth : this.characterWidth,
+            minHeight : minHeight,
+            maxHeight : maxHeight,
+            offset : offset,
+            height : this.$size.scrollerHeight
+        };
+
+        // For debugging.
+        // console.log(JSON.stringify(this.layerConfig));
+
+        this.$gutterLayer.element.style.marginTop = (-offset) + "px";
+        this.content.style.marginTop = (-offset) + "px";
+        this.content.style.width = longestLine + "px";
+        this.content.style.height = minHeight + "px";
+
+        // scroller.scrollWidth was smaller than scrollLeft we needed
+        if (this.$desiredScrollLeft) {
+            this.scrollToX(this.$desiredScrollLeft);
+            this.$desiredScrollLeft = 0;
+        }
+
+        // Horizontal scrollbar visibility may have changed, which changes
+        // the client height of the scroller
+        if (horizScrollChanged)
+            this.onResize(true);
+    };
+
+    this.$updateLines = function() {
+        var firstRow = this.$changedLines.firstRow;
+        var lastRow = this.$changedLines.lastRow;
+        this.$changedLines = null;
+
+        var layerConfig = this.layerConfig;
+
+        // if the update changes the width of the document do a full redraw
+        if (layerConfig.width != this.$getLongestLine())
+            return this.$textLayer.update(layerConfig);
+
+        if (firstRow > layerConfig.lastRow + 1) { return; }
+        if (lastRow < layerConfig.firstRow) { return; }
+
+        // if the last row is unknown -> redraw everything
+        if (lastRow === Infinity) {
+            if (this.showGutter)
+                this.$gutterLayer.update(layerConfig);
+            this.$textLayer.update(layerConfig);
+            return;
+        }
+
+        // else update only the changed rows
+        this.$textLayer.updateLines(layerConfig, firstRow, lastRow);
+    };
+
+    this.$getLongestLine = function() {
+        var charCount = this.session.getScreenWidth() + 1;
+        if (this.$textLayer.showInvisibles)
+            charCount += 1;
+
+        return Math.max(this.$size.scrollerWidth, Math.round(charCount * this.characterWidth));
+    };
+
+    this.updateFrontMarkers = function() {
+        this.$markerFront.setMarkers(this.session.getMarkers(true));
+        this.$loop.schedule(this.CHANGE_MARKER_FRONT);
+    };
+
+    this.updateBackMarkers = function() {
+        this.$markerBack.setMarkers(this.session.getMarkers());
+        this.$loop.schedule(this.CHANGE_MARKER_BACK);
+    };
+
+    this.addGutterDecoration = function(row, className){
+        this.$gutterLayer.addGutterDecoration(row, className);
+        this.$loop.schedule(this.CHANGE_GUTTER);
+    };
+
+    this.removeGutterDecoration = function(row, className){
+        this.$gutterLayer.removeGutterDecoration(row, className);
+        this.$loop.schedule(this.CHANGE_GUTTER);
+    };
+
+    this.setBreakpoints = function(rows) {
+        this.$gutterLayer.setBreakpoints(rows);
+        this.$loop.schedule(this.CHANGE_GUTTER);
+    };
+
+    this.setAnnotations = function(annotations) {
+        this.$gutterLayer.setAnnotations(annotations);
+        this.$loop.schedule(this.CHANGE_GUTTER);
+    };
+
+    this.updateCursor = function() {
+        this.$loop.schedule(this.CHANGE_CURSOR);
+    };
+
+    this.hideCursor = function() {
+        this.$cursorLayer.hideCursor();
+    };
+
+    this.showCursor = function() {
+        this.$cursorLayer.showCursor();
+    };
+
+    this.scrollCursorIntoView = function() {
+        // the editor is not visible
+        if (this.$size.scrollerHeight === 0)
+            return;
+
+        var pos = this.$cursorLayer.getPixelPosition();
+
+        var left = pos.left;
+        var top = pos.top;
+
+        if (this.scrollTop > top) {
+            this.scrollToY(top);
+        }
+
+        if (this.scrollTop + this.$size.scrollerHeight < top + this.lineHeight) {
+            this.scrollToY(top + this.lineHeight - this.$size.scrollerHeight);
+        }
+
+        var scrollLeft = this.scroller.scrollLeft;
+
+        if (scrollLeft > left) {
+            this.scrollToX(left);
+        }
+
+        if (scrollLeft + this.$size.scrollerWidth < left + this.characterWidth) {
+            if (left > this.layerConfig.width)
+                this.$desiredScrollLeft = left + 2 * this.characterWidth;
+            else
+                this.scrollToX(Math.round(left + this.characterWidth - this.$size.scrollerWidth));
+        }
+    };
+
+    this.getScrollTop = function() {
+        return this.scrollTop;
+    };
+
+    this.getScrollLeft = function() {
+        return this.scroller.scrollLeft;
+    };
+
+    this.getScrollTopRow = function() {
+        return this.scrollTop / this.lineHeight;
+    };
+
+    this.getScrollBottomRow = function() {
+        return Math.max(0, Math.floor((this.scrollTop + this.$size.scrollerHeight) / this.lineHeight) - 1);
+    };
+
+    this.scrollToRow = function(row) {
+        this.scrollToY(row * this.lineHeight);
+    };
+
+    this.scrollToLine = function(line, center) {
+        var lineHeight = { lineHeight: this.lineHeight };
+        var offset = 0;
+        for (var l = 1; l < line; l++) {
+            offset += this.session.getRowHeight(lineHeight, l-1);
+        }
+
+        if (center) {
+            offset -= this.$size.scrollerHeight / 2;
+        }
+        this.scrollToY(offset);
+    };
+
+    this.scrollToY = function(scrollTop) {
+        // after calling scrollBar.setScrollTop
+        // scrollbar sends us event with same scrollTop. ignore it
+        scrollTop = Math.max(0, scrollTop);
+        if (this.scrollTop !== scrollTop) {
+            this.$loop.schedule(this.CHANGE_SCROLL);
+            this.scrollTop = scrollTop;
+        }
+    };
+
+    this.scrollToX = function(scrollLeft) {
+        if (scrollLeft <= this.$padding)
+            scrollLeft = 0;
+
+        this.scroller.scrollLeft = scrollLeft;
+    };
+
+    this.scrollBy = function(deltaX, deltaY) {
+        deltaY && this.scrollToY(this.scrollTop + deltaY);
+        deltaX && this.scrollToX(this.scroller.scrollLeft + deltaX);
+    };
+
+    this.isScrollableBy = function(deltaX, deltaY) {
+        if (deltaY < 0 && this.scrollTop > 0)
+           return true;
+        if (deltaY > 0 && this.scrollTop + this.$size.scrollerHeight < this.layerConfig.maxHeight)
+           return true;
+        // todo: handle horizontal scrolling
+    };
+
+    this.screenToTextCoordinates = function(pageX, pageY) {
+        var canvasPos = this.scroller.getBoundingClientRect();
+
+        var col = Math.round((pageX + this.scroller.scrollLeft - canvasPos.left - this.$padding - dom.getPageScrollLeft())
+                / this.characterWidth);
+        var row = Math.floor((pageY + this.scrollTop - canvasPos.top - dom.getPageScrollTop())
+                / this.lineHeight);
+
+        return this.session.screenToDocumentPosition(row, Math.max(col, 0));
+    };
+
+    this.textToScreenCoordinates = function(row, column) {
+        var canvasPos = this.scroller.getBoundingClientRect();
+        var pos = this.session.documentToScreenPosition(row, column);
+
+        var x = this.$padding + Math.round(pos.column * this.characterWidth);
+        var y = pos.row * this.lineHeight;
+
+        return {
+            pageX: canvasPos.left + x - this.getScrollLeft(),
+            pageY: canvasPos.top + y - this.getScrollTop()
+        };
+    };
+
+    this.visualizeFocus = function() {
+        dom.addCssClass(this.container, "ace_focus");
+    };
+
+    this.visualizeBlur = function() {
+        dom.removeCssClass(this.container, "ace_focus");
+    };
+
+    this.showComposition = function(position) {
+        if (!this.$composition) {
+            this.$composition = dom.createElement("div");
+            this.$composition.className = "ace_composition";
+            this.content.appendChild(this.$composition);
+        }
+
+        this.$composition.innerHTML = "&#160;";
+
+        var pos = this.$cursorLayer.getPixelPosition();
+        var style = this.$composition.style;
+        style.top = pos.top + "px";
+        style.left = (pos.left + this.$padding) + "px";
+        style.height = this.lineHeight + "px";
+
+        this.hideCursor();
+    };
+
+    this.setCompositionText = function(text) {
+        dom.setInnerText(this.$composition, text);
+    };
+
+    this.hideComposition = function() {
+        this.showCursor();
+
+        if (!this.$composition)
+            return;
+
+        var style = this.$composition.style;
+        style.top = "-10000px";
+        style.left = "-10000px";
+    };
+
+    this.setTheme = function(theme) {
+        var _self = this;
+
+        this.$themeValue = theme;
+        if (!theme || typeof theme == "string") {
+            theme = theme || "ace/theme/textmate";
+            require([theme], function(theme) {
+                afterLoad(theme);
+            });
+        } else {
+            afterLoad(theme);
+        }
+
+        function afterLoad(theme) {
+            dom.importCssString(
+                theme.cssText,
+                theme.cssClass,
+                _self.container.ownerDocument
+            );
+
+            if (_self.$theme)
+                dom.removeCssClass(_self.container, _self.$theme);
+
+            _self.$theme = theme ? theme.cssClass : null;
+
+            if (_self.$theme)
+                dom.addCssClass(_self.container, _self.$theme);
+
+            if (theme && theme.isDark)
+                dom.addCssClass(_self.container, "ace_dark");
+            else
+                dom.removeCssClass(_self.container, "ace_dark");
+
+            // force re-measure of the gutter width
+            if (_self.$size) {
+                _self.$size.width = 0;
+                _self.onResize();
+            }
+        }
+    };
+
+    this.getTheme = function() {
+        return this.$themeValue;
+    };
+
+    // Methods allows to add / remove CSS classnames to the editor element.
+    // This feature can be used by plug-ins to provide a visual indication of
+    // a certain mode that editor is in.
+
+    this.setStyle = function setStyle(style) {
+      dom.addCssClass(this.container, style);
+    };
+
+    this.unsetStyle = function unsetStyle(style) {
+      dom.removeCssClass(this.container, style);
+    };
+
+    this.destroy = function() {
+        this.$textLayer.destroy();
+        this.$cursorLayer.destroy();
+    };
+
+}).call(VirtualRenderer.prototype);
+
+exports.VirtualRenderer = VirtualRenderer;
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian DOT viereck AT gmail DOT com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/layer/gutter', ['require', 'exports', 'module' , 'ace/lib/dom', 'ace/lib/oop', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var dom = require("../lib/dom");
+var oop = require("../lib/oop");
+var EventEmitter = require("../lib/event_emitter").EventEmitter;
+
+var Gutter = function(parentEl) {
+    this.element = dom.createElement("div");
+    this.element.className = "ace_layer ace_gutter-layer";
+    parentEl.appendChild(this.element);
+    this.setShowFoldWidgets(this.$showFoldWidgets);
+    
+    this.gutterWidth = 0;
+
+    this.$breakpoints = [];
+    this.$annotations = [];
+    this.$decorations = [];
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+    
+    this.setSession = function(session) {
+        this.session = session;
+    };
+
+    this.addGutterDecoration = function(row, className){
+        if (!this.$decorations[row])
+            this.$decorations[row] = "";
+        this.$decorations[row] += " ace_" + className;
+    };
+
+    this.removeGutterDecoration = function(row, className){
+        this.$decorations[row] = this.$decorations[row].replace(" ace_" + className, "");
+    };
+
+    this.setBreakpoints = function(rows) {
+        this.$breakpoints = rows.concat();
+    };
+
+    this.setAnnotations = function(annotations) {
+        // iterate over sparse array
+        this.$annotations = [];
+        for (var row in annotations) if (annotations.hasOwnProperty(row)) {
+            var rowAnnotations = annotations[row];
+            if (!rowAnnotations)
+                continue;
+
+            var rowInfo = this.$annotations[row] = {
+                text: []
+            };
+            for (var i=0; i<rowAnnotations.length; i++) {
+                var annotation = rowAnnotations[i];
+                var annoText = annotation.text.replace(/"/g, "&quot;").replace(/'/g, "&#8217;").replace(/</, "&lt;");
+                if (rowInfo.text.indexOf(annoText) === -1)
+                    rowInfo.text.push(annoText);
+                var type = annotation.type;
+                if (type == "error")
+                    rowInfo.className = "ace_error";
+                else if (type == "warning" && rowInfo.className != "ace_error")
+                    rowInfo.className = "ace_warning";
+                else if (type == "info" && (!rowInfo.className))
+                    rowInfo.className = "ace_info";
+            }
+        }
+    };
+
+    this.update = function(config) {
+        this.$config = config;
+
+        var emptyAnno = {className: "", text: []};
+        var html = [];
+        var i = config.firstRow;
+        var lastRow = config.lastRow;
+        var fold = this.session.getNextFoldLine(i);
+        var foldStart = fold ? fold.start.row : Infinity;
+        var foldWidgets = this.$showFoldWidgets && this.session.foldWidgets;
+
+        while (true) {
+            if(i > foldStart) {
+                i = fold.end.row + 1;
+                fold = this.session.getNextFoldLine(i, fold);
+                foldStart = fold ?fold.start.row :Infinity;
+            }
+            if(i > lastRow)
+                break;
+
+            var annotation = this.$annotations[i] || emptyAnno;
+            html.push("<div class='ace_gutter-cell",
+                this.$decorations[i] || "",
+                this.$breakpoints[i] ? " ace_breakpoint " : " ",
+                annotation.className,
+                "' title='", annotation.text.join("\n"),
+                "' style='height:", config.lineHeight, "px;'>", (i+1));
+
+            if (foldWidgets) {
+                var c = foldWidgets[i];
+                // check if cached value is invalidated and we need to recompute
+                if (c == null)
+                    c = foldWidgets[i] = this.session.getFoldWidget(i);
+                if (c)
+                    html.push(
+                        "<span class='ace_fold-widget ", c,
+                        c == "start" && i == foldStart && i < fold.end.row ? " closed" : " open",
+                        "'></span>"
+                    );
+            }
+
+            var wrappedRowLength = this.session.getRowLength(i) - 1;
+            while (wrappedRowLength--) {
+                html.push("</div><div class='ace_gutter-cell' style='height:", config.lineHeight, "px'>\xA6");
+            }
+
+            html.push("</div>");
+
+            i++;
+        }
+        this.element = dom.setInnerHtml(this.element, html.join(""));
+        this.element.style.height = config.minHeight + "px";
+        
+        var gutterWidth = this.element.offsetWidth;
+        if (gutterWidth !== this.gutterWidth) {
+            this.gutterWidth = gutterWidth;
+            this._emit("changeGutterWidth", gutterWidth);
+        }
+    };
+
+    this.$showFoldWidgets = true;
+    this.setShowFoldWidgets = function(show) {
+        if (show)
+            dom.addCssClass(this.element, "ace_folding-enabled");
+        else
+            dom.removeCssClass(this.element, "ace_folding-enabled");
+
+        this.$showFoldWidgets = show;
+    };
+    
+    this.getShowFoldWidgets = function() {
+        return this.$showFoldWidgets;
+    };
+
+}).call(Gutter.prototype);
+
+exports.Gutter = Gutter;
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/layer/marker', ['require', 'exports', 'module' , 'ace/range', 'ace/lib/dom'], function(require, exports, module) {
+
+var Range = require("../range").Range;
+var dom = require("../lib/dom");
+
+var Marker = function(parentEl) {
+    this.element = dom.createElement("div");
+    this.element.className = "ace_layer ace_marker-layer";
+    parentEl.appendChild(this.element);
+};
+
+(function() {
+
+    this.$padding = 0;
+
+    this.setPadding = function(padding) {
+        this.$padding = padding;
+    };
+    this.setSession = function(session) {
+        this.session = session;
+    };
+    
+    this.setMarkers = function(markers) {
+        this.markers = markers;
+    };
+
+    this.update = function(config) {
+        var config = config || this.config;
+        if (!config)
+            return;
+
+        this.config = config;
+
+
+        var html = [];
+        for ( var key in this.markers) {
+            var marker = this.markers[key];
+
+            var range = marker.range.clipRows(config.firstRow, config.lastRow);
+            if (range.isEmpty()) continue;
+
+            range = range.toScreenRange(this.session);
+            if (marker.renderer) {
+                var top = this.$getTop(range.start.row, config);
+                var left = Math.round(
+                    this.$padding + range.start.column * config.characterWidth
+                );
+                marker.renderer(html, range, left, top, config);
+            }
+            else if (range.isMultiLine()) {
+                if (marker.type == "text") {
+                    this.drawTextMarker(html, range, marker.clazz, config);
+                } else {
+                    this.drawMultiLineMarker(
+                        html, range, marker.clazz, config,
+                        marker.type
+                    );
+                }
+            }
+            else {
+                this.drawSingleLineMarker(
+                    html, range, marker.clazz, config,
+                    null, marker.type
+                );
+            }
+        }
+        this.element = dom.setInnerHtml(this.element, html.join(""));
+    };
+
+    this.$getTop = function(row, layerConfig) {
+        return (row - layerConfig.firstRowScreen) * layerConfig.lineHeight;
+    };
+
+    /**
+     * Draws a marker, which spans a range of text in a single line
+     */ 
+    this.drawTextMarker = function(stringBuilder, range, clazz, layerConfig) {
+        // selection start
+        var row = range.start.row;
+
+        var lineRange = new Range(
+            row, range.start.column,
+            row, this.session.getScreenLastRowColumn(row)
+        );
+        this.drawSingleLineMarker(stringBuilder, lineRange, clazz, layerConfig, 1, "text");
+
+        // selection end
+        row = range.end.row;
+        lineRange = new Range(row, 0, row, range.end.column);
+        this.drawSingleLineMarker(stringBuilder, lineRange, clazz, layerConfig, 0, "text");
+
+        for (row = range.start.row + 1; row < range.end.row; row++) {
+            lineRange.start.row = row;
+            lineRange.end.row = row;
+            lineRange.end.column = this.session.getScreenLastRowColumn(row);
+            this.drawSingleLineMarker(stringBuilder, lineRange, clazz, layerConfig, 1, "text");
+        }
+    };
+
+    /**
+     * Draws a multi line marker, where lines span the full width
+     */
+     this.drawMultiLineMarker = function(stringBuilder, range, clazz, layerConfig, type) {
+        // from selection start to the end of the line
+        var padding = type === "background" ? 0 : this.$padding;
+        var height = layerConfig.lineHeight;
+        var width = Math.round(layerConfig.width - (range.start.column * layerConfig.characterWidth));
+        var top = this.$getTop(range.start.row, layerConfig);
+        var left = Math.round(
+            padding + range.start.column * layerConfig.characterWidth
+        );
+
+        stringBuilder.push(
+            "<div class='", clazz, "' style='",
+            "height:", height, "px;",
+            "width:", width, "px;",
+            "top:", top, "px;",
+            "left:", left, "px;'></div>"
+        );
+
+        // from start of the last line to the selection end
+        top = this.$getTop(range.end.row, layerConfig);
+        width = Math.round(range.end.column * layerConfig.characterWidth);
+
+        stringBuilder.push(
+            "<div class='", clazz, "' style='",
+            "height:", height, "px;",
+            "width:", width, "px;",
+            "top:", top, "px;",
+            "left:", padding, "px;'></div>"
+        );
+
+        // all the complete lines
+        height = (range.end.row - range.start.row - 1) * layerConfig.lineHeight;
+        if (height < 0)
+            return;
+        top = this.$getTop(range.start.row + 1, layerConfig);
+        width = layerConfig.width;
+
+        stringBuilder.push(
+            "<div class='", clazz, "' style='",
+            "height:", height, "px;",
+            "width:", width, "px;",
+            "top:", top, "px;",
+            "left:", padding, "px;'></div>"
+        );
+    };
+
+    /**
+     * Draws a marker which covers one single full line
+     */
+    this.drawSingleLineMarker = function(stringBuilder, range, clazz, layerConfig, extraLength, type) {
+        var padding = type === "background" ? 0 : this.$padding;
+        var height = layerConfig.lineHeight;
+
+        if (type === "background")
+            var width = layerConfig.width;
+        else
+            width = Math.round((range.end.column + (extraLength || 0) - range.start.column) * layerConfig.characterWidth);
+
+        var top = this.$getTop(range.start.row, layerConfig);
+        var left = Math.round(
+            padding + range.start.column * layerConfig.characterWidth
+        );
+
+        stringBuilder.push(
+            "<div class='", clazz, "' style='",
+            "height:", height, "px;",
+            "width:", width, "px;",
+            "top:", top, "px;",
+            "left:", left,"px;'></div>"
+        );
+    };
+
+}).call(Marker.prototype);
+
+exports.Marker = Marker;
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian DOT viereck AT gmail DOT com>
+ *      Mihai Sucan <mihai.sucan at gmail.com>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/layer/text', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/dom', 'ace/lib/lang', 'ace/lib/useragent', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var oop = require("../lib/oop");
+var dom = require("../lib/dom");
+var lang = require("../lib/lang");
+var useragent = require("../lib/useragent");
+var EventEmitter = require("../lib/event_emitter").EventEmitter;
+
+var Text = function(parentEl) {
+    this.element = dom.createElement("div");
+    this.element.className = "ace_layer ace_text-layer";
+    parentEl.appendChild(this.element);
+
+    this.$characterSize = this.$measureSizes() || {width: 0, height: 0};
+    this.$pollSizeChanges();
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.EOF_CHAR = "\xB6"; //"&para;";
+    this.EOL_CHAR = "\xAC"; //"&not;";
+    this.TAB_CHAR = "\u2192"; //"&rarr;";
+    this.SPACE_CHAR = "\xB7"; //"&middot;";
+    this.$padding = 0;
+
+    this.setPadding = function(padding) {
+        this.$padding = padding;
+        this.element.style.padding = "0 " + padding + "px";
+    };
+
+    this.getLineHeight = function() {
+        return this.$characterSize.height || 1;
+    };
+
+    this.getCharacterWidth = function() {
+        return this.$characterSize.width || 1;
+    };
+
+    this.checkForSizeChanges = function() {
+        var size = this.$measureSizes();
+        if (size && (this.$characterSize.width !== size.width || this.$characterSize.height !== size.height)) {
+            this.$characterSize = size;
+            this._dispatchEvent("changeCharaterSize", {data: size});
+        }
+    };
+
+    this.$pollSizeChanges = function() {
+        var self = this;
+        this.$pollSizeChangesTimer = setInterval(function() {
+            self.checkForSizeChanges();
+        }, 500);
+    };
+
+    this.$fontStyles = {
+        fontFamily : 1,
+        fontSize : 1,
+        fontWeight : 1,
+        fontStyle : 1,
+        lineHeight : 1
+    };
+
+    this.$measureSizes = function() {
+        var n = 1000;
+        if (!this.$measureNode) {
+            var measureNode = this.$measureNode = dom.createElement("div");
+            var style = measureNode.style;
+
+            style.width = style.height = "auto";
+            style.left = style.top = (-n * 40)  + "px";
+
+            style.visibility = "hidden";
+            style.position = "absolute";
+            style.overflow = "visible";
+            style.whiteSpace = "nowrap";
+
+            // in FF 3.6 monospace fonts can have a fixed sub pixel width.
+            // that's why we have to measure many characters
+            // Note: characterWidth can be a float!
+            measureNode.innerHTML = lang.stringRepeat("Xy", n);
+
+            if (this.element.ownerDocument.body) {
+                this.element.ownerDocument.body.appendChild(measureNode);
+            } else {
+                var container = this.element.parentNode;
+                while (!dom.hasCssClass(container, "ace_editor"))
+                    container = container.parentNode;
+                container.appendChild(measureNode);
+            }
+
+        }
+
+        var style = this.$measureNode.style;
+        var computedStyle = dom.computedStyle(this.element);
+        for (var prop in this.$fontStyles)
+            style[prop] = computedStyle[prop];
+
+        var size = {
+            height: this.$measureNode.offsetHeight,
+            width: this.$measureNode.offsetWidth / (n * 2)
+        };
+
+        // Size and width can be null if the editor is not visible or
+        // detached from the document
+        if (size.width == 0 && size.height == 0)
+            return null;
+
+        return size;
+    };
+
+    this.setSession = function(session) {
+        this.session = session;
+    };
+
+    this.showInvisibles = false;
+    this.setShowInvisibles = function(showInvisibles) {
+        if (this.showInvisibles == showInvisibles)
+            return false;
+
+        this.showInvisibles = showInvisibles;
+        return true;
+    };
+
+    this.$tabStrings = [];
+    this.$computeTabString = function() {
+        var tabSize = this.session.getTabSize();
+        var tabStr = this.$tabStrings = [0];
+        for (var i = 1; i < tabSize + 1; i++) {
+            if (this.showInvisibles) {
+                tabStr.push("<span class='ace_invisible'>"
+                    + this.TAB_CHAR
+                    + new Array(i).join("&#160;")
+                    + "</span>");
+            } else {
+                tabStr.push(new Array(i+1).join("&#160;"));
+            }
+        }
+
+    };
+
+    this.updateLines = function(config, firstRow, lastRow) {
+        this.$computeTabString();
+        // Due to wrap line changes there can be new lines if e.g.
+        // the line to updated wrapped in the meantime.
+        if (this.config.lastRow != config.lastRow ||
+            this.config.firstRow != config.firstRow) {
+            this.scrollLines(config);
+        }
+        this.config = config;
+
+        var first = Math.max(firstRow, config.firstRow);
+        var last = Math.min(lastRow, config.lastRow);
+
+        var lineElements = this.element.childNodes;
+        var lineElementsIdx = 0;
+
+        for (var row = config.firstRow; row < first; row++) {
+            var foldLine = this.session.getFoldLine(row);
+            if (foldLine) {
+                if (foldLine.containsRow(first)) {
+                    first = foldLine.start.row;
+                    break;
+                } else {
+                    row = foldLine.end.row;
+                }
+            }
+            lineElementsIdx ++;
+        }
+
+        for (var i=first; i<=last; i++) {
+            var lineElement = lineElements[lineElementsIdx++];
+            if (!lineElement)
+                continue;
+
+            var html = [];
+            var tokens = this.session.getTokens(i, i);
+            this.$renderLine(html, i, tokens[0].tokens, !this.$useLineGroups());
+            lineElement = dom.setInnerHtml(lineElement, html.join(""));
+
+            i = this.session.getRowFoldEnd(i);
+        }
+    };
+
+    this.scrollLines = function(config) {
+        this.$computeTabString();
+        var oldConfig = this.config;
+        this.config = config;
+
+        if (!oldConfig || oldConfig.lastRow < config.firstRow)
+            return this.update(config);
+
+        if (config.lastRow < oldConfig.firstRow)
+            return this.update(config);
+
+        var el = this.element;
+        if (oldConfig.firstRow < config.firstRow)
+            for (var row=this.session.getFoldedRowCount(oldConfig.firstRow, config.firstRow - 1); row>0; row--)
+                el.removeChild(el.firstChild);
+
+        if (oldConfig.lastRow > config.lastRow)
+            for (var row=this.session.getFoldedRowCount(config.lastRow + 1, oldConfig.lastRow); row>0; row--)
+                el.removeChild(el.lastChild);
+
+        if (config.firstRow < oldConfig.firstRow) {
+            var fragment = this.$renderLinesFragment(config, config.firstRow, oldConfig.firstRow - 1);
+            if (el.firstChild)
+                el.insertBefore(fragment, el.firstChild);
+            else
+                el.appendChild(fragment);
+        }
+
+        if (config.lastRow > oldConfig.lastRow) {
+            var fragment = this.$renderLinesFragment(config, oldConfig.lastRow + 1, config.lastRow);
+            el.appendChild(fragment);
+        }
+    };
+
+    this.$renderLinesFragment = function(config, firstRow, lastRow) {
+        var fragment = this.element.ownerDocument.createDocumentFragment(),
+            row = firstRow,
+            fold = this.session.getNextFoldLine(row),
+            foldStart = fold ?fold.start.row :Infinity;
+
+        while (true) {
+            if (row > foldStart) {
+                row = fold.end.row+1;
+                fold = this.session.getNextFoldLine(row, fold);
+                foldStart = fold ?fold.start.row :Infinity;
+            }
+            if (row > lastRow)
+                break;
+
+            var container = dom.createElement("div");
+
+            var html = [];
+            // Get the tokens per line as there might be some lines in between
+            // beeing folded.
+            // OPTIMIZE: If there is a long block of unfolded lines, just make
+            // this call once for that big block of unfolded lines.
+            var tokens = this.session.getTokens(row, row);
+            if (tokens.length == 1)
+                this.$renderLine(html, row, tokens[0].tokens, false);
+
+            // don't use setInnerHtml since we are working with an empty DIV
+            container.innerHTML = html.join("");
+            if (this.$useLineGroups()) {
+                container.className = 'ace_line_group';
+                fragment.appendChild(container);
+            } else {
+                var lines = container.childNodes
+                while(lines.length)
+                    fragment.appendChild(lines[0]);
+            }
+
+            row++;
+        }
+        return fragment;
+    };
+
+    this.update = function(config) {
+        this.$computeTabString();
+        this.config = config;
+
+        var html = [];
+        var firstRow = config.firstRow, lastRow = config.lastRow;
+
+        var row = firstRow,
+            fold = this.session.getNextFoldLine(row),
+            foldStart = fold ?fold.start.row :Infinity;
+
+        while (true) {
+            if (row > foldStart) {
+                row = fold.end.row+1;
+                fold = this.session.getNextFoldLine(row, fold);
+                foldStart = fold ?fold.start.row :Infinity;
+            }
+            if (row > lastRow)
+                break;
+
+            if (this.$useLineGroups())
+                html.push("<div class='ace_line_group'>")
+
+            // Get the tokens per line as there might be some lines in between
+            // beeing folded.
+            // OPTIMIZE: If there is a long block of unfolded lines, just make
+            // this call once for that big block of unfolded lines.
+            var tokens = this.session.getTokens(row, row);
+            if (tokens.length == 1)
+                this.$renderLine(html, row, tokens[0].tokens, false);
+
+            if (this.$useLineGroups())
+                html.push("</div>"); // end the line group
+
+            row++;
+        }
+        this.element = dom.setInnerHtml(this.element, html.join(""));
+    };
+
+    this.$textToken = {
+        "text": true,
+        "rparen": true,
+        "lparen": true
+    };
+
+    this.$renderToken = function(stringBuilder, screenColumn, token, value) {        
+        var self = this;
+        var replaceReg = /\t|&|<|( +)|([\v\f \u00a0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000])|[\u1100-\u115F]|[\u11A3-\u11A7]|[\u11FA-\u11FF]|[\u2329-\u232A]|[\u2E80-\u2E99]|[\u2E9B-\u2EF3]|[\u2F00-\u2FD5]|[\u2FF0-\u2FFB]|[\u3000-\u303E]|[\u3041-\u3096]|[\u3099-\u30FF]|[\u3105-\u312D]|[\u3131-\u318E]|[\u3190-\u31BA]|[\u31C0-\u31E3]|[\u31F0-\u321E]|[\u3220-\u3247]|[\u3250-\u32FE]|[\u3300-\u4DBF]|[\u4E00-\uA48C]|[\uA490-\uA4C6]|[\uA960-\uA97C]|[\uAC00-\uD7A3]|[\uD7B0-\uD7C6]|[\uD7CB-\uD7FB]|[\uF900-\uFAFF]|[\uFE10-\uFE19]|[\uFE30-\uFE52]|[\uFE54-\uFE66]|[\uFE68-\uFE6B]|[\uFF01-\uFF60]|[\uFFE0-\uFFE6]/g;
+        var replaceFunc = function(c, a, b, tabIdx, idx4) {
+            if (c.charCodeAt(0) == 32) {
+                return new Array(c.length+1).join("&#160;");
+            } else if (c == "\t") {
+                var tabSize = self.session.getScreenTabSize(screenColumn + tabIdx);
+                screenColumn += tabSize - 1;
+                return self.$tabStrings[tabSize];
+            } else if (c == "&") {
+                if (useragent.isOldGecko)
+                    return "&";
+                else
+                    return "&amp;";
+            } else if (c == "<") {
+                return "&lt;";
+            } else if (c == "\u3000") {
+                // U+3000 is both invisible AND full-width, so must be handled uniquely
+                var classToUse = self.showInvisibles ? "ace_cjk ace_invisible" : "ace_cjk";
+                var space = self.showInvisibles ? self.SPACE_CHAR : "";
+                screenColumn += 1;
+                return "<span class='" + classToUse + "' style='width:" +
+                    (self.config.characterWidth * 2) +
+                    "px'>" + space + "</span>";
+            } else if (c.match(/[\v\f \u00a0\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000]/)) {
+                if (self.showInvisibles) {
+                    var space = new Array(c.length+1).join(self.SPACE_CHAR);
+                    return "<span class='ace_invisible'>" + space + "</span>";
+                } else {
+                    return "&#160;";
+                }
+            } else {
+                screenColumn += 1;
+                return "<span class='ace_cjk' style='width:" +
+                    (self.config.characterWidth * 2) +
+                    "px'>" + c + "</span>";
+            }
+        };
+
+        var output = value.replace(replaceReg, replaceFunc);
+
+        if (!this.$textToken[token.type]) {
+            var classes = "ace_" + token.type.replace(/\./g, " ace_");
+            stringBuilder.push("<span class='", classes, "'>", output, "</span>");
+        }
+        else {
+            stringBuilder.push(output);
+        }
+        return screenColumn + value.length;
+    };
+
+    this.$renderLineCore = function(stringBuilder, lastRow, tokens, splits, onlyContents) {
+        var chars = 0;
+        var split = 0;
+        var splitChars;
+        var characterWidth = this.config.characterWidth;
+        var screenColumn = 0;
+        var self = this;
+
+        if (!splits || splits.length == 0)
+            splitChars = Number.MAX_VALUE;
+        else
+            splitChars = splits[0];
+
+        if (!onlyContents) {
+            stringBuilder.push("<div class='ace_line' style='height:",
+                this.config.lineHeight, "px",
+                "'>"
+            );
+        }
+        
+        for (var i = 0; i < tokens.length; i++) {
+            var token = tokens[i];
+            var value = token.value;
+
+            if (chars + value.length < splitChars) {
+                screenColumn = self.$renderToken(
+                    stringBuilder, screenColumn, token, value
+                );
+                chars += value.length;
+            }
+            else {
+                while (chars + value.length >= splitChars) {
+                    screenColumn = self.$renderToken(
+                        stringBuilder, screenColumn, 
+                        token, value.substring(0, splitChars - chars)
+                    );
+                    value = value.substring(splitChars - chars);
+                    chars = splitChars;
+                    
+                    if (!onlyContents) {
+                        stringBuilder.push("</div>",
+                            "<div class='ace_line' style='height:",
+                            this.config.lineHeight, "px",
+                            "'>"
+                        );
+                    }
+
+                    split ++;
+                    screenColumn = 0;
+                    splitChars = splits[split] || Number.MAX_VALUE;
+                }
+                if (value.length != 0) {
+                    chars += value.length;
+                    screenColumn = self.$renderToken(
+                        stringBuilder, screenColumn, token, value
+                    );
+                }
+            }
+        }
+
+        if (this.showInvisibles) {
+            if (lastRow !== this.session.getLength() - 1)
+                stringBuilder.push("<span class='ace_invisible'>" + this.EOL_CHAR + "</span>");
+            else
+                stringBuilder.push("<span class='ace_invisible'>" + this.EOF_CHAR + "</span>");
+        }
+        if (!onlyContents)
+            stringBuilder.push("</div>");
+    };
+
+    this.$renderLine = function(stringBuilder, row, tokens, onlyContents) {
+        // Check if the line to render is folded or not. If not, things are
+        // simple, otherwise, we need to fake some things...
+        if (!this.session.isRowFolded(row)) {
+            var splits = this.session.getRowSplitData(row);
+            this.$renderLineCore(stringBuilder, row, tokens, splits, onlyContents);
+        } else {
+            this.$renderFoldLine(stringBuilder, row, tokens, onlyContents);
+        }
+    };
+
+    this.$renderFoldLine = function(stringBuilder, row, tokens, onlyContents) {
+        var session = this.session,
+            foldLine = session.getFoldLine(row),
+            renderTokens = [];
+
+        function addTokens(tokens, from, to) {
+            var idx = 0, col = 0;
+            while ((col + tokens[idx].value.length) < from) {
+                col += tokens[idx].value.length;
+                idx++;
+
+                if (idx == tokens.length) {
+                    return;
+                }
+            }
+            if (col != from) {
+                var value = tokens[idx].value.substring(from - col);
+                // Check if the token value is longer then the from...to spacing.
+                if (value.length > (to - from)) {
+                    value = value.substring(0, to - from);
+                }
+
+                renderTokens.push({
+                    type: tokens[idx].type,
+                    value: value
+                });
+
+                col = from + value.length;
+                idx += 1;
+            }
+
+            while (col < to) {
+                var value = tokens[idx].value;
+                if (value.length + col > to) {
+                    value = value.substring(0, to - col);
+                }
+                renderTokens.push({
+                    type: tokens[idx].type,
+                    value: value
+                });
+                col += value.length;
+                idx += 1;
+            }
+        }
+
+        foldLine.walk(function(placeholder, row, column, lastColumn, isNewRow) {
+            if (placeholder) {
+               renderTokens.push({
+                    type: "fold",
+                    value: placeholder
+                });
+            } else {
+                if (isNewRow) {
+                   tokens = this.session.getTokens(row, row)[0].tokens;
+                }
+                if (tokens.length != 0) {
+                    addTokens(tokens, lastColumn, column);
+                }
+            }
+        }.bind(this), foldLine.end.row, this.session.getLine(foldLine.end.row).length);
+
+        // TODO: Build a fake splits array!
+        var splits = this.session.$useWrapMode?this.session.$wrapData[row]:null;
+        this.$renderLineCore(stringBuilder, row, renderTokens, splits, onlyContents);
+    };
+    
+    this.$useLineGroups = function() {
+        // For the updateLines function to work correctly, it's important that the
+        // child nodes of this.element correspond on a 1-to-1 basis to rows in the 
+        // document (as distinct from lines on the screen). For sessions that are
+        // wrapped, this means we need to add a layer to the node hierarchy (tagged
+        // with the class name ace_line_group).
+        return this.session.getUseWrapMode();
+    };
+
+    this.destroy = function() {
+        clearInterval(this.$pollSizeChangesTimer);
+        if (this.$measureNode)
+            this.$measureNode.parentNode.removeChild(this.$measureNode);
+        delete this.$measureNode;
+    };
+
+}).call(Text.prototype);
+
+exports.Text = Text;
+
+});
+/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Julian Viereck <julian.viereck at gmail.com>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/layer/cursor', ['require', 'exports', 'module' , 'ace/lib/dom'], function(require, exports, module) {
+
+var dom = require("../lib/dom");
+
+var Cursor = function(parentEl) {
+    this.element = dom.createElement("div");
+    this.element.className = "ace_layer ace_cursor-layer";
+    parentEl.appendChild(this.element);
+
+    this.cursor = dom.createElement("div");
+    this.cursor.className = "ace_cursor ace_hidden";
+    this.element.appendChild(this.cursor);
+
+    this.isVisible = false;
+};
+
+(function() {
+
+    this.$padding = 0;
+    this.setPadding = function(padding) {
+        this.$padding = padding;
+    };
+
+    this.setSession = function(session) {
+        this.session = session;
+    };
+
+    this.hideCursor = function() {
+        this.isVisible = false;
+        dom.addCssClass(this.cursor, "ace_hidden");
+        clearInterval(this.blinkId);
+    };
+
+    this.showCursor = function() {
+        this.isVisible = true;
+        dom.removeCssClass(this.cursor, "ace_hidden");
+        this.cursor.style.visibility = "visible";
+        this.restartTimer();
+    };
+
+    this.restartTimer = function() {
+        clearInterval(this.blinkId);
+        if (!this.isVisible) {
+            return;
+        }
+
+        var cursor = this.cursor;
+        this.blinkId = setInterval(function() {
+            cursor.style.visibility = "hidden";
+            setTimeout(function() {
+                cursor.style.visibility = "visible";
+            }, 400);
+        }, 1000);
+    };
+
+    this.getPixelPosition = function(onScreen) {
+        if (!this.config || !this.session) {
+            return {
+                left : 0,
+                top : 0
+            };
+        }
+
+        var position = this.session.selection.getCursor();
+        var pos = this.session.documentToScreenPosition(position);
+        var cursorLeft = Math.round(this.$padding +
+                                    pos.column * this.config.characterWidth);
+        var cursorTop = (pos.row - (onScreen ? this.config.firstRowScreen : 0)) *
+            this.config.lineHeight;
+
+        return {
+            left : cursorLeft,
+            top : cursorTop
+        };
+    };
+
+    this.update = function(config) {
+        this.config = config;
+
+        this.pixelPos = this.getPixelPosition(true);
+
+        this.cursor.style.left = this.pixelPos.left + "px";
+        this.cursor.style.top =  this.pixelPos.top + "px";
+        this.cursor.style.width = config.characterWidth + "px";
+        this.cursor.style.height = config.lineHeight + "px";
+
+        var overwrite = this.session.getOverwrite()
+        if (overwrite != this.overwrite) {
+            this.overwrite = overwrite;
+            if (overwrite)
+                dom.addCssClass(this.cursor, "ace_overwrite");
+            else
+                dom.removeCssClass(this.cursor, "ace_overwrite");
+        }
+
+        this.restartTimer();
+    };
+
+    this.destroy = function() {
+        clearInterval(this.blinkId);
+    }
+
+}).call(Cursor.prototype);
+
+exports.Cursor = Cursor;
+
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/scrollbar', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/dom', 'ace/lib/event', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var dom = require("./lib/dom");
+var event = require("./lib/event");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+
+var ScrollBar = function(parent) {
+    this.element = dom.createElement("div");
+    this.element.className = "ace_sb";
+
+    this.inner = dom.createElement("div");
+    this.element.appendChild(this.inner);
+
+    parent.appendChild(this.element);
+
+    // in OSX lion the scrollbars appear to have no width. In this case resize
+    // the to show the scrollbar but still pretend that the scrollbar has a width
+    // of 0px
+    // in Firefox 6+ scrollbar is hidden if element has the same width as scrollbar
+    // make element a little bit wider to retain scrollbar when page is zoomed 
+    this.width = dom.scrollbarWidth(parent.ownerDocument);
+    this.element.style.width = (this.width || 15) + 5 + "px";
+
+    event.addListener(this.element, "scroll", this.onScroll.bind(this));
+};
+
+(function() {
+    oop.implement(this, EventEmitter);
+
+    this.onScroll = function() {
+        this._dispatchEvent("scroll", {data: this.element.scrollTop});
+    };
+
+    this.getWidth = function() {
+        return this.width;
+    };
+
+    this.setHeight = function(height) {
+        this.element.style.height = height + "px";
+    };
+
+    this.setInnerHeight = function(height) {
+        this.inner.style.height = height + "px";
+    };
+
+    this.setScrollTop = function(scrollTop) {
+        this.element.scrollTop = scrollTop;
+    };
+
+}).call(ScrollBar.prototype);
+
+exports.ScrollBar = ScrollBar;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/renderloop', ['require', 'exports', 'module' , 'ace/lib/event'], function(require, exports, module) {
+
+var event = require("./lib/event");
+
+var RenderLoop = function(onRender, win) {
+    this.onRender = onRender;
+    this.pending = false;
+    this.changes = 0;
+    this.window = win || window;
+};
+
+(function() {
+
+    this.schedule = function(change) {
+        //this.onRender(change);
+        //return;
+        this.changes = this.changes | change;
+        if (!this.pending) {
+            this.pending = true;
+            var _self = this;
+            event.nextTick(function() {
+                _self.pending = false;
+                var changes = _self.changes;
+                _self.changes = 0;
+                _self.onRender(changes);
+            }, this.window);
+        }
+    };
+
+}).call(RenderLoop.prototype);
+
+exports.RenderLoop = RenderLoop;
+});
+define("text!ace/css/editor.css", [], "@import url(//fonts.googleapis.com/css?family=Droid+Sans+Mono);\n" +
+  "\n" +
+  "\n" +
+  ".ace_editor {\n" +
+  "    position: absolute;\n" +
+  "    overflow: hidden;\n" +
+  "    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Droid Sans Mono', 'Courier New', monospace;\n" +
+  "    font-size: 12px;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_scroller {\n" +
+  "    position: absolute;\n" +
+  "    overflow-x: scroll;\n" +
+  "    overflow-y: hidden;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_content {\n" +
+  "    position: absolute;\n" +
+  "    box-sizing: border-box;\n" +
+  "    -moz-box-sizing: border-box;\n" +
+  "    -webkit-box-sizing: border-box;\n" +
+  "    cursor: text;\n" +
+  "}\n" +
+  "\n" +
+  "/* setting pointer-events: auto; on node under the mouse, which changes during scroll,\n" +
+  "  will break mouse wheel scrolling in Safari */\n" +
+  ".ace_content * {\n" +
+  "     pointer-events: none;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_composition {\n" +
+  "    position: absolute;\n" +
+  "    background: #555;\n" +
+  "    color: #DDD;\n" +
+  "    z-index: 4;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter .ace_layer {\n" +
+  "    position: relative;\n" +
+  "    min-width: 54px;\n" +
+  "    text-align: right;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter {\n" +
+  "    position: absolute;\n" +
+  "    overflow : hidden;\n" +
+  "    height: 100%;\n" +
+  "    width: auto;\n" +
+  "    cursor: default;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter-cell {\n" +
+  "    padding-left: 19px;\n" +
+  "    padding-right: 6px;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter-cell.ace_error {\n" +
+  "    background-image: url(\"data:image/gif,GIF89a%10%00%10%00%D5%00%00%F5or%F5%87%88%F5nr%F4ns%EBmq%F5z%7F%DDJT%DEKS%DFOW%F1Yc%F2ah%CE(7%CE)8%D18E%DD%40M%F2KZ%EBU%60%F4%60m%DCir%C8%16(%C8%19*%CE%255%F1%3FR%F1%3FS%E6%AB%B5%CA%5DI%CEn%5E%F7%A2%9A%C9G%3E%E0a%5B%F7%89%85%F5yy%F6%82%80%ED%82%80%FF%BF%BF%E3%C4%C4%FF%FF%FF%FF%FF%FF%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00!%F9%04%01%00%00%25%00%2C%00%00%00%00%10%00%10%00%00%06p%C0%92pH%2C%1A%8F%C8%D2H%93%E1d4%23%E4%88%D3%09mB%1DN%B48%F5%90%40%60%92G%5B%94%20%3E%22%D2%87%24%FA%20%24%C5%06A%00%20%B1%07%02B%A38%89X.v%17%82%11%13q%10%0Fi%24%0F%8B%10%7BD%12%0Ei%09%92%09%0EpD%18%15%24%0A%9Ci%05%0C%18F%18%0B%07%04%01%04%06%A0H%18%12%0D%14%0D%12%A1I%B3%B4%B5IA%00%3B\");\n" +
+  "    background-repeat: no-repeat;\n" +
+  "    background-position: 2px center;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter-cell.ace_warning {\n" +
+  "    background-image: url(\"data:image/gif,GIF89a%10%00%10%00%D5%00%00%FF%DBr%FF%DE%81%FF%E2%8D%FF%E2%8F%FF%E4%96%FF%E3%97%FF%E5%9D%FF%E6%9E%FF%EE%C1%FF%C8Z%FF%CDk%FF%D0s%FF%D4%81%FF%D5%82%FF%D5%83%FF%DC%97%FF%DE%9D%FF%E7%B8%FF%CCl%7BQ%13%80U%15%82W%16%81U%16%89%5B%18%87%5B%18%8C%5E%1A%94d%1D%C5%83-%C9%87%2F%C6%84.%C6%85.%CD%8B2%C9%871%CB%8A3%CD%8B5%DC%98%3F%DF%9BB%E0%9CC%E1%A5U%CB%871%CF%8B5%D1%8D6%DB%97%40%DF%9AB%DD%99B%E3%B0p%E7%CC%AE%FF%FF%FF%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00!%F9%04%01%00%00%2F%00%2C%00%00%00%00%10%00%10%00%00%06a%C0%97pH%2C%1A%8FH%A1%ABTr%25%87%2B%04%82%F4%7C%B9X%91%08%CB%99%1C!%26%13%84*iJ9(%15G%CA%84%14%01%1A%97%0C%03%80%3A%9A%3E%81%84%3E%11%08%B1%8B%20%02%12%0F%18%1A%0F%0A%03'F%1C%04%0B%10%16%18%10%0B%05%1CF%1D-%06%07%9A%9A-%1EG%1B%A0%A1%A0U%A4%A5%A6BA%00%3B\");\n" +
+  "    background-repeat: no-repeat;\n" +
+  "    background-position: 2px center;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_sb {\n" +
+  "    position: absolute;\n" +
+  "    overflow-x: hidden;\n" +
+  "    overflow-y: scroll;\n" +
+  "    right: 0;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_sb div {\n" +
+  "    position: absolute;\n" +
+  "    width: 1px;\n" +
+  "    left: 0;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_print_margin_layer {\n" +
+  "    z-index: 0;\n" +
+  "    position: absolute;\n" +
+  "    overflow: hidden;\n" +
+  "    margin: 0;\n" +
+  "    left: 0;\n" +
+  "    height: 100%;\n" +
+  "    width: 100%;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_print_margin {\n" +
+  "    position: absolute;\n" +
+  "    height: 100%;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor textarea {\n" +
+  "    position: fixed;\n" +
+  "    z-index: -1;\n" +
+  "    width: 10px;\n" +
+  "    height: 30px;\n" +
+  "    opacity: 0;\n" +
+  "    background: transparent;\n" +
+  "    appearance: none;\n" +
+  "    -moz-appearance: none;\n" +
+  "    border: none;\n" +
+  "    resize: none;\n" +
+  "    outline: none;\n" +
+  "    overflow: hidden;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_layer {\n" +
+  "    z-index: 1;\n" +
+  "    position: absolute;\n" +
+  "    overflow: hidden;\n" +
+  "    white-space: nowrap;\n" +
+  "    height: 100%;\n" +
+  "    width: 100%;\n" +
+  "    box-sizing: border-box;\n" +
+  "    -moz-box-sizing: border-box;\n" +
+  "    -webkit-box-sizing: border-box;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_text-layer {\n" +
+  "    color: black;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cjk {\n" +
+  "    display: inline-block;\n" +
+  "    text-align: center;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cursor-layer {\n" +
+  "    z-index: 4;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cursor {\n" +
+  "    z-index: 4;\n" +
+  "    position: absolute;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cursor.ace_hidden {\n" +
+  "    opacity: 0.2;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_line {\n" +
+  "    white-space: nowrap;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_step {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 3;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_selection {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 4;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_bracket {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 5;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_active_line {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 2;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_selected_word {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 6;\n" +
+  "    box-sizing: border-box;\n" +
+  "    -moz-box-sizing: border-box;\n" +
+  "    -webkit-box-sizing: border-box;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_line .ace_fold {\n" +
+  "    cursor: pointer;\n" +
+  "    color: darkred;\n" +
+  "    -moz-outline-radius: 4px;\n" +
+  "    outline-radius: 4px;\n" +
+  "    border-radius: 4px;\n" +
+  "    outline: 1px solid #1C00FF;\n" +
+  "    outline-offset: -2px;\n" +
+  "    pointer-events: auto;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_dark .ace_fold {\n" +
+  "    color: #E6E1DC;\n" +
+  "    outline-color: #FC6F09;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold:hover{\n" +
+  "    background: gold!important;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_dragging .ace_content {\n" +
+  "    cursor: move;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_folding-enabled .ace_gutter-cell {\n" +
+  "    padding-right: 9px!important;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget {\n" +
+  "    margin-right: -9px;\n" +
+  "    display: inline-block;\n" +
+  "    height: 9px;\n" +
+  "    width: 9px;\n" +
+  "    background: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41Ljg3O4BdAAAAbUlEQVQoU2NgoBqIiIibCcRn0tPzbufmlt4uKam+XVXVdLuhoeN2UVHlGSCeCbYsMTHjdlxcSjOyzSB+a2vvbbhYXV2rGsgkoIQvSBBEg0wCiaM4GSQAsg5kAsg6DAUw1SAJkJtwKkBWSFaoAADKrzXSD2pEpgAAAABJRU5ErkJggg==\") no-repeat;\n" +
+  "    background-origin: content-box;\n" +
+  "    padding: 1px 0;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget.end{\n" +
+  "    transform: scaleY(-1);\n" +
+  "    -moz-transform: scaleY(-1);\n" +
+  "    -webkit-transform: scaleY(-1);\n" +
+  "    opacity:0.8;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget.closed{\n" +
+  "    -moz-transform: none;\n" +
+  "    -webkit-transform: none;\n" +
+  "    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJBAMAAAASvxsjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAC1QTFRF////fn6FXl5kXl5kWFhecnJ5WFhecnJ5YWFoZ2dubW11dHR7enqCgICIhYWNjO3uwQAAAA90Uk5TACZNg5mZzMzb29vb29vbP7t0EwAAACtJREFUCFtjYAhgAIE6ARB5+SKIPKAD4mxg3ggkF2iB2JMngsQzwGocgBgA2zEHmb0961QAAAAASUVORK5CYII=\");\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget:hover {\n" +
+  "    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41Ljg3O4BdAAAASklEQVQoU2NgoBqQWHFlJhD/lzny/TY6BomD5MGWgSQPvPj5H4bXP4GwQeJw1wA5augKoaaqoTgZWSFWBTDVMIUgGq+nCSrApRsAuCZYT+KbmI0AAAAASUVORK5CYII=\");\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget.closed:hover {\n" +
+  "    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJBAMAAAASvxsjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABVQTFRF////HMT3GKjUHMT3GKjUr+T5wOj5rFcpYAAAAAR0Uk5TACaZ2z7RZscAAAAkSURBVAhbY2BQYAABZwEQaWYIIk2TQRyzNBDHDMI2RKgBqQcAaNgD0/oixWYAAAAASUVORK5CYII=\");\n" +
+  "}\n" +
+  "\n" +
+  "");
+
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/theme/textmate', ['require', 'exports', 'module' , 'ace/lib/dom'], function(require, exports, module) {
+exports.isDark = false;
+exports.cssClass = "ace-tm";
+exports.cssText = ".ace-tm .ace_editor {\
+  border: 2px solid rgb(159, 159, 159);\
+}\
+\
+.ace-tm .ace_editor.ace_focus {\
+  border: 2px solid #327fbd;\
+}\
+\
+.ace-tm .ace_gutter {\
+  width: 50px;\
+  background: #e8e8e8;\
+  color: #333;\
+  overflow : hidden;\
+}\
+\
+.ace-tm .ace_gutter-layer {\
+  width: 100%;\
+  text-align: right;\
+}\
+\
+.ace-tm .ace_gutter-layer .ace_gutter-cell {\
+  padding-right: 6px;\
+}\
+\
+.ace-tm .ace_print_margin {\
+  width: 1px;\
+  background: #e8e8e8;\
+}\
+\
+.ace-tm .ace_text-layer {\
+  cursor: text;\
+}\
+\
+.ace-tm .ace_cursor {\
+  border-left: 2px solid black;\
+}\
+\
+.ace-tm .ace_cursor.ace_overwrite {\
+  border-left: 0px;\
+  border-bottom: 1px solid black;\
+}\
+        \
+.ace-tm .ace_line .ace_invisible {\
+  color: rgb(191, 191, 191);\
+}\
+\
+.ace-tm .ace_line .ace_keyword {\
+  color: blue;\
+}\
+\
+.ace-tm .ace_line .ace_constant.ace_buildin {\
+  color: rgb(88, 72, 246);\
+}\
+\
+.ace-tm .ace_line .ace_constant.ace_language {\
+  color: rgb(88, 92, 246);\
+}\
+\
+.ace-tm .ace_line .ace_constant.ace_library {\
+  color: rgb(6, 150, 14);\
+}\
+\
+.ace-tm .ace_line .ace_invalid {\
+  background-color: rgb(153, 0, 0);\
+  color: white;\
+}\
+\
+.ace-tm .ace_line .ace_support.ace_function {\
+  color: rgb(60, 76, 114);\
+}\
+\
+.ace-tm .ace_line .ace_support.ace_constant {\
+  color: rgb(6, 150, 14);\
+}\
+\
+.ace-tm .ace_line .ace_support.ace_type,\
+.ace-tm .ace_line .ace_support.ace_class {\
+  color: rgb(109, 121, 222);\
+}\
+\
+.ace-tm .ace_line .ace_keyword.ace_operator {\
+  color: rgb(104, 118, 135);\
+}\
+\
+.ace-tm .ace_line .ace_string {\
+  color: rgb(3, 106, 7);\
+}\
+\
+.ace-tm .ace_line .ace_comment {\
+  color: rgb(76, 136, 107);\
+}\
+\
+.ace-tm .ace_line .ace_comment.ace_doc {\
+  color: rgb(0, 102, 255);\
+}\
+\
+.ace-tm .ace_line .ace_comment.ace_doc.ace_tag {\
+  color: rgb(128, 159, 191);\
+}\
+\
+.ace-tm .ace_line .ace_constant.ace_numeric {\
+  color: rgb(0, 0, 205);\
+}\
+\
+.ace-tm .ace_line .ace_variable {\
+  color: rgb(49, 132, 149);\
+}\
+\
+.ace-tm .ace_line .ace_xml_pe {\
+  color: rgb(104, 104, 91);\
+}\
+\
+.ace-tm .ace_entity.ace_name.ace_function {\
+  color: #0000A2;\
+}\
+\
+.ace-tm .ace_markup.ace_markupine {\
+    text-decoration:underline;\
+}\
+\
+.ace-tm .ace_markup.ace_heading {\
+  color: rgb(12, 7, 255);\
+}\
+\
+.ace-tm .ace_markup.ace_list {\
+  color:rgb(185, 6, 144);\
+}\
+\
+.ace-tm .ace_marker-layer .ace_selection {\
+  background: rgb(181, 213, 255);\
+}\
+\
+.ace-tm .ace_marker-layer .ace_step {\
+  background: rgb(252, 255, 0);\
+}\
+\
+.ace-tm .ace_marker-layer .ace_stack {\
+  background: rgb(164, 229, 101);\
+}\
+\
+.ace-tm .ace_marker-layer .ace_bracket {\
+  margin: -1px 0 0 -1px;\
+  border: 1px solid rgb(192, 192, 192);\
+}\
+\
+.ace-tm .ace_marker-layer .ace_active_line {\
+  background: rgba(0, 0, 0, 0.07);\
+}\
+\
+.ace-tm .ace_marker-layer .ace_selected_word {\
+  background: rgb(250, 250, 255);\
+  border: 1px solid rgb(200, 200, 250);\
+}\
+\
+.ace-tm .ace_meta.ace_tag {\
+  color:rgb(28, 2, 255);\
+}\
+\
+.ace-tm .ace_string.ace_regex {\
+  color: rgb(255, 0, 0)\
+}";
+
+    var dom = require("../lib/dom");
+    dom.importCssString(exports.cssText);
+});
+define("text!ace/css/editor.css", [], "@import url(//fonts.googleapis.com/css?family=Droid+Sans+Mono);\n" +
+  "\n" +
+  "\n" +
+  ".ace_editor {\n" +
+  "    position: absolute;\n" +
+  "    overflow: hidden;\n" +
+  "    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Droid Sans Mono', 'Courier New', monospace;\n" +
+  "    font-size: 12px;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_scroller {\n" +
+  "    position: absolute;\n" +
+  "    overflow-x: scroll;\n" +
+  "    overflow-y: hidden;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_content {\n" +
+  "    position: absolute;\n" +
+  "    box-sizing: border-box;\n" +
+  "    -moz-box-sizing: border-box;\n" +
+  "    -webkit-box-sizing: border-box;\n" +
+  "    cursor: text;\n" +
+  "}\n" +
+  "\n" +
+  "/* setting pointer-events: auto; on node under the mouse, which changes during scroll,\n" +
+  "  will break mouse wheel scrolling in Safari */\n" +
+  ".ace_content * {\n" +
+  "     pointer-events: none;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_composition {\n" +
+  "    position: absolute;\n" +
+  "    background: #555;\n" +
+  "    color: #DDD;\n" +
+  "    z-index: 4;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter .ace_layer {\n" +
+  "    position: relative;\n" +
+  "    min-width: 54px;\n" +
+  "    text-align: right;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter {\n" +
+  "    position: absolute;\n" +
+  "    overflow : hidden;\n" +
+  "    height: 100%;\n" +
+  "    width: auto;\n" +
+  "    cursor: default;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter-cell {\n" +
+  "    padding-left: 19px;\n" +
+  "    padding-right: 6px;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter-cell.ace_error {\n" +
+  "    background-image: url(\"data:image/gif,GIF89a%10%00%10%00%D5%00%00%F5or%F5%87%88%F5nr%F4ns%EBmq%F5z%7F%DDJT%DEKS%DFOW%F1Yc%F2ah%CE(7%CE)8%D18E%DD%40M%F2KZ%EBU%60%F4%60m%DCir%C8%16(%C8%19*%CE%255%F1%3FR%F1%3FS%E6%AB%B5%CA%5DI%CEn%5E%F7%A2%9A%C9G%3E%E0a%5B%F7%89%85%F5yy%F6%82%80%ED%82%80%FF%BF%BF%E3%C4%C4%FF%FF%FF%FF%FF%FF%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00!%F9%04%01%00%00%25%00%2C%00%00%00%00%10%00%10%00%00%06p%C0%92pH%2C%1A%8F%C8%D2H%93%E1d4%23%E4%88%D3%09mB%1DN%B48%F5%90%40%60%92G%5B%94%20%3E%22%D2%87%24%FA%20%24%C5%06A%00%20%B1%07%02B%A38%89X.v%17%82%11%13q%10%0Fi%24%0F%8B%10%7BD%12%0Ei%09%92%09%0EpD%18%15%24%0A%9Ci%05%0C%18F%18%0B%07%04%01%04%06%A0H%18%12%0D%14%0D%12%A1I%B3%B4%B5IA%00%3B\");\n" +
+  "    background-repeat: no-repeat;\n" +
+  "    background-position: 2px center;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_gutter-cell.ace_warning {\n" +
+  "    background-image: url(\"data:image/gif,GIF89a%10%00%10%00%D5%00%00%FF%DBr%FF%DE%81%FF%E2%8D%FF%E2%8F%FF%E4%96%FF%E3%97%FF%E5%9D%FF%E6%9E%FF%EE%C1%FF%C8Z%FF%CDk%FF%D0s%FF%D4%81%FF%D5%82%FF%D5%83%FF%DC%97%FF%DE%9D%FF%E7%B8%FF%CCl%7BQ%13%80U%15%82W%16%81U%16%89%5B%18%87%5B%18%8C%5E%1A%94d%1D%C5%83-%C9%87%2F%C6%84.%C6%85.%CD%8B2%C9%871%CB%8A3%CD%8B5%DC%98%3F%DF%9BB%E0%9CC%E1%A5U%CB%871%CF%8B5%D1%8D6%DB%97%40%DF%9AB%DD%99B%E3%B0p%E7%CC%AE%FF%FF%FF%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00!%F9%04%01%00%00%2F%00%2C%00%00%00%00%10%00%10%00%00%06a%C0%97pH%2C%1A%8FH%A1%ABTr%25%87%2B%04%82%F4%7C%B9X%91%08%CB%99%1C!%26%13%84*iJ9(%15G%CA%84%14%01%1A%97%0C%03%80%3A%9A%3E%81%84%3E%11%08%B1%8B%20%02%12%0F%18%1A%0F%0A%03'F%1C%04%0B%10%16%18%10%0B%05%1CF%1D-%06%07%9A%9A-%1EG%1B%A0%A1%A0U%A4%A5%A6BA%00%3B\");\n" +
+  "    background-repeat: no-repeat;\n" +
+  "    background-position: 2px center;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_sb {\n" +
+  "    position: absolute;\n" +
+  "    overflow-x: hidden;\n" +
+  "    overflow-y: scroll;\n" +
+  "    right: 0;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_sb div {\n" +
+  "    position: absolute;\n" +
+  "    width: 1px;\n" +
+  "    left: 0;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_print_margin_layer {\n" +
+  "    z-index: 0;\n" +
+  "    position: absolute;\n" +
+  "    overflow: hidden;\n" +
+  "    margin: 0;\n" +
+  "    left: 0;\n" +
+  "    height: 100%;\n" +
+  "    width: 100%;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_print_margin {\n" +
+  "    position: absolute;\n" +
+  "    height: 100%;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor textarea {\n" +
+  "    position: fixed;\n" +
+  "    z-index: -1;\n" +
+  "    width: 10px;\n" +
+  "    height: 30px;\n" +
+  "    opacity: 0;\n" +
+  "    background: transparent;\n" +
+  "    appearance: none;\n" +
+  "    -moz-appearance: none;\n" +
+  "    border: none;\n" +
+  "    resize: none;\n" +
+  "    outline: none;\n" +
+  "    overflow: hidden;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_layer {\n" +
+  "    z-index: 1;\n" +
+  "    position: absolute;\n" +
+  "    overflow: hidden;\n" +
+  "    white-space: nowrap;\n" +
+  "    height: 100%;\n" +
+  "    width: 100%;\n" +
+  "    box-sizing: border-box;\n" +
+  "    -moz-box-sizing: border-box;\n" +
+  "    -webkit-box-sizing: border-box;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_text-layer {\n" +
+  "    color: black;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cjk {\n" +
+  "    display: inline-block;\n" +
+  "    text-align: center;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cursor-layer {\n" +
+  "    z-index: 4;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cursor {\n" +
+  "    z-index: 4;\n" +
+  "    position: absolute;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_cursor.ace_hidden {\n" +
+  "    opacity: 0.2;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_line {\n" +
+  "    white-space: nowrap;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_step {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 3;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_selection {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 4;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_bracket {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 5;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_active_line {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 2;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_marker-layer .ace_selected_word {\n" +
+  "    position: absolute;\n" +
+  "    z-index: 6;\n" +
+  "    box-sizing: border-box;\n" +
+  "    -moz-box-sizing: border-box;\n" +
+  "    -webkit-box-sizing: border-box;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_line .ace_fold {\n" +
+  "    cursor: pointer;\n" +
+  "    color: darkred;\n" +
+  "    -moz-outline-radius: 4px;\n" +
+  "    outline-radius: 4px;\n" +
+  "    border-radius: 4px;\n" +
+  "    outline: 1px solid #1C00FF;\n" +
+  "    outline-offset: -2px;\n" +
+  "    pointer-events: auto;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_dark .ace_fold {\n" +
+  "    color: #E6E1DC;\n" +
+  "    outline-color: #FC6F09;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold:hover{\n" +
+  "    background: gold!important;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_dragging .ace_content {\n" +
+  "    cursor: move;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_folding-enabled .ace_gutter-cell {\n" +
+  "    padding-right: 9px!important;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget {\n" +
+  "    margin-right: -9px;\n" +
+  "    display: inline-block;\n" +
+  "    height: 9px;\n" +
+  "    width: 9px;\n" +
+  "    background: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41Ljg3O4BdAAAAbUlEQVQoU2NgoBqIiIibCcRn0tPzbufmlt4uKam+XVXVdLuhoeN2UVHlGSCeCbYsMTHjdlxcSjOyzSB+a2vvbbhYXV2rGsgkoIQvSBBEg0wCiaM4GSQAsg5kAsg6DAUw1SAJkJtwKkBWSFaoAADKrzXSD2pEpgAAAABJRU5ErkJggg==\") no-repeat;\n" +
+  "    background-origin: content-box;\n" +
+  "    padding: 1px 0;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget.end{\n" +
+  "    transform: scaleY(-1);\n" +
+  "    -moz-transform: scaleY(-1);\n" +
+  "    -webkit-transform: scaleY(-1);\n" +
+  "    opacity:0.8;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget.closed{\n" +
+  "    -moz-transform: none;\n" +
+  "    -webkit-transform: none;\n" +
+  "    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJBAMAAAASvxsjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAC1QTFRF////fn6FXl5kXl5kWFhecnJ5WFhecnJ5YWFoZ2dubW11dHR7enqCgICIhYWNjO3uwQAAAA90Uk5TACZNg5mZzMzb29vb29vbP7t0EwAAACtJREFUCFtjYAhgAIE6ARB5+SKIPKAD4mxg3ggkF2iB2JMngsQzwGocgBgA2zEHmb0961QAAAAASUVORK5CYII=\");\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget:hover {\n" +
+  "    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJCAYAAADgkQYQAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAAEnQAABJ0Ad5mH3gAAAAZdEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41Ljg3O4BdAAAASklEQVQoU2NgoBqQWHFlJhD/lzny/TY6BomD5MGWgSQPvPj5H4bXP4GwQeJw1wA5augKoaaqoTgZWSFWBTDVMIUgGq+nCSrApRsAuCZYT+KbmI0AAAAASUVORK5CYII=\");\n" +
+  "}\n" +
+  "\n" +
+  ".ace_fold-widget.closed:hover {\n" +
+  "    background-image: url(\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAkAAAAJBAMAAAASvxsjAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAABVQTFRF////HMT3GKjUHMT3GKjUr+T5wOj5rFcpYAAAAAR0Uk5TACaZ2z7RZscAAAAkSURBVAhbY2BQYAABZwEQaWYIIk2TQRyzNBDHDMI2RKgBqQcAaNgD0/oixWYAAAAASUVORK5CYII=\");\n" +
+  "}\n" +
+  "\n" +
+  "");
+
+define("text!ace/ext/static.css", [], ".ace_editor {\n" +
+  "   font-family: 'Monaco', 'Menlo', 'Droid Sans Mono', 'Courier New', monospace;\n" +
+  "   font-size: 12px;\n" +
+  "}\n" +
+  "\n" +
+  ".ace_editor .ace_gutter { \n" +
+  "    width: 25px !important;\n" +
+  "    display: block;\n" +
+  "    float: left;\n" +
+  "    text-align: right; \n" +
+  "    padding: 0 3px 0 0; \n" +
+  "    margin-right: 3px;\n" +
+  "}\n" +
+  "\n" +
+  ".ace-row { clear: both; }\n" +
+  "\n" +
+  "*.ace_gutter-cell {\n" +
+  "  -moz-user-select: -moz-none;\n" +
+  "  -khtml-user-select: none;\n" +
+  "  -webkit-user-select: none;\n" +
+  "  user-select: none;\n" +
+  "}");
+
+define("text!kitchen-sink/styles.css", [], "html {\n" +
+  "    height: 100%;\n" +
+  "    width: 100%;\n" +
+  "    overflow: hidden;\n" +
+  "}\n" +
+  "\n" +
+  "body {\n" +
+  "    overflow: hidden;\n" +
+  "    margin: 0;\n" +
+  "    padding: 0;\n" +
+  "    height: 100%;\n" +
+  "    width: 100%;\n" +
+  "    font-family: Arial, Helvetica, sans-serif, Tahoma, Verdana, sans-serif;\n" +
+  "    font-size: 12px;\n" +
+  "    background: rgb(14, 98, 165);\n" +
+  "    color: white;\n" +
+  "}\n" +
+  "\n" +
+  "#logo {\n" +
+  "    padding: 15px;\n" +
+  "    margin-left: 70px;\n" +
+  "}\n" +
+  "\n" +
+  "#editor {\n" +
+  "    position: absolute;\n" +
+  "    top:  0px;\n" +
+  "    left: 300px;\n" +
+  "    bottom: 0px;\n" +
+  "    right: 0px;\n" +
+  "    background: white;\n" +
+  "}\n" +
+  "\n" +
+  "#controls {\n" +
+  "    padding: 5px;\n" +
+  "}\n" +
+  "\n" +
+  "#controls td {\n" +
+  "    text-align: right;\n" +
+  "}\n" +
+  "\n" +
+  "#controls td + td {\n" +
+  "    text-align: left;\n" +
+  "}");
+
+define("text!kitchen-sink/docs/css.css", [], ".text-layer {\n" +
+  "    font-family: Monaco, \"Courier New\", monospace;\n" +
+  "    font-size: 12px;\n" +
+  "    cursor: text;\n" +
+  "}\n" +
+  "\n" +
+  ".blinker {\n" +
+  "    animation-duration: 1s;\n" +
+  "    animation-name: blink;\n" +
+  "    animation-iteration-count: infinite;\n" +
+  "    animation-direction: alternate;\n" +
+  "    animation-timing-function: linear;\n" +
+  "}\n" +
+  "\n" +
+  "@keyframes blink {\n" +
+  "    0% {\n" +
+  "        opacity: 0;\n" +
+  "    }\n" +
+  "    40% {\n" +
+  "        opacity: 0;\n" +
+  "    }\n" +
+  "    40.5% {\n" +
+  "        opacity: 1\n" +
+  "    }\n" +
+  "    100% {\n" +
+  "        opacity: 1\n" +
+  "    }\n" +
+  "}");
+
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Mozilla Skywriter.
+ *
+ * The Initial Developer of the Original Code is
+ * Mozilla.
+ * Portions created by the Initial Developer are Copyright (C) 2009
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Kevin Dangoor (kdangoor at mozilla.com)
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+require(["ace/ace"], function(ace) {
+    window.ace = ace;
+});
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,192 @@
+define("ace/mode/spoofax2ace", ["require", "exports", "module", "ace/lib/oop", "ace/mode/text", "ace/mode/spoofax2ace_tokenizer", "ace/mode/matching_brace_outdent", "ace/range", "ace/worker/worker_client"], function (a, b, c) {
+    var d = a("ace/lib/oop"),
+        e = a("ace/mode/text").Mode,
+        f = a("ace/mode/spoofax2ace_tokenizer").SpoofaxToAceTokenizer,
+        g = a("ace/mode/matching_brace_outdent").MatchingBraceOutdent,
+        h = a("ace/range").Range,
+        i = a("ace/worker/worker_client").WorkerClient,
+        j = function () {
+            this.$tokenizer = new f, this.$outdent = new g, this.$worker = null, this.debugWorker = !0
+        };
+    d.inherits(j, e);
+    var k, l;
+    ((function () {
+        this.createWorker = function (a) {
+            console.log("Creating worker"), k = (new Date).getTime();
+            var b = this.$tokenizer,
+                c = a.getDocument();
+            console.log("Creating worker 1");
+            var d = new i(["ace", "pilot"], "worker-spoofax2ace.js", "ace/mode/spoofax2ace_worker", "SpoofaxToAceWorker");
+            console.log("Creating worker 2"), d.call("setValue", [c.getValue()]), console.log("Creating worker 3");
+            var e = function (a) {
+                    var c = a.data,
+                        e = a.data.range;
+                    c.action === "insertText" && c.text === "\n" && b.shiftTokens(e.start.row, 1), c.action === "insertLines" && b.shiftTokens(e.start.row, c.lines.length), c.action === "removeText" && c.text === "\n" && b.unshiftTokens(e.start.row, 1), c.action === "removeLines" && b.unshiftTokens(e.start.row, c.lines.length), d.emit("change", a)
+                };
+            return c.on("change", e), this.debugWorker && (d.on("log", function (a) {
+                console.log("worker:" + a.data)
+            }), d.on("debug", function (a) {
+                console.log(a.data)
+            })), d.on("loaded", function (a) {
+                l = (new Date).getTime(), console.log("Loading completed in " + (l - k) + " ms."), d.call("setValue", [c.getValue()])
+            }), d.on("jsglr", function (c) {
+                b.setTokens(c.data.parsed), a.setAnnotations(c.data.errors)
+            }), d.on("terminate", function () {
+                c.removeListener("change", e), a.clearAnnotations()
+            }), this.$worker = d, d
+        }
+    })).call(j.prototype), b.Mode = j
+}), define("ace/mode/spoofax2ace_tokenizer", ["require", "exports", "module", "ace/lib/oop", "ace/lib/event_emitter"], function (a, b, c) {
+    var d = a("ace/lib/oop"),
+        e = a("ace/lib/event_emitter").EventEmitter,
+        f = function () {
+            this.parsed = []
+        };
+    ((function () {
+        d.implement(this, e), this.fireUpdateEvent = function (a, b) {
+            var c = {
+                first: a,
+                last: b
+            };
+            this._dispatchEvent("update", {
+                data: c
+            })
+        }, this.setTokens = function (a) {
+            this.parsed = a, this.fireUpdateEvent(0, undefined)
+        }, this.shiftTokens = function (a, b) {
+            var c = [a, 0];
+            for (var d = 0; d < b; d++) c.push({});
+            Array.prototype.splice.apply(this.parsed, c)
+        }, this.unshiftTokens = function (a, b) {
+            this.parsed.splice(a, b)
+        }, this.unknownLine = function (a) {
+            tokens = [];
+            var b = {
+                type: "plain",
+                value: a
+            };
+            return tokens.push(b), tokens
+        }, this.getLineTokens = function (a, b) {
+            var c = [];
+            b === "start" && (b = 0);
+            var d = this.parsed[b];
+            return d === undefined || d.text !== a || d.tokens.length === 0 ? c = this.unknownLine(a) : c = d.tokens, {
+                tokens: c,
+                state: b + 1
+            }
+        }
+    })).call(f.prototype), b.SpoofaxToAceTokenizer = f
+}), define("ace/mode/matching_brace_outdent", ["require", "exports", "module", "ace/range"], function (a, b, c) {
+    var d = a("../range").Range,
+        e = function () {};
+    ((function () {
+        this.checkOutdent = function (a, b) {
+            return /^\s+$/.test(a) ? /^\s*\}/.test(b) : !1
+        }, this.autoOutdent = function (a, b) {
+            var c = a.getLine(b),
+                e = c.match(/^(\s*\})/);
+            if (!e) return 0;
+            var f = e[1].length,
+                g = a.findMatchingBracket({
+                    row: b,
+                    column: f
+                });
+            if (!g || g.row == b) return 0;
+            var h = this.$getIndent(a.getLine(g.row));
+            a.replace(new d(b, 0, b, f - 1), h)
+        }, this.$getIndent = function (a) {
+            var b = a.match(/^(\s+)/);
+            return b ? b[1] : ""
+        }
+    })).call(e.prototype), b.MatchingBraceOutdent = e
+}), define("ace/worker/worker_client", ["require", "exports", "module", "ace/lib/oop", "ace/lib/event_emitter"], function (a, b, c) {
+    var d = a("../lib/oop"),
+        e = a("../lib/event_emitter").EventEmitter,
+        f = function (b, c, d, e) {
+            this.changeListener = this.changeListener.bind(this);
+            if (window.require.packaged) var f = this.$guessBasePath(),
+                g = this.$worker = new Worker(f + c);
+            else {
+                var h = this.$normalizePath(a.nameToUrl("ace/worker/worker", null, "_")),
+                    g = this.$worker = new Worker(h),
+                    i = {};
+                for (var j = 0; j < b.length; j++) {
+                    var k = b[j],
+                        l = this.$normalizePath(a.nameToUrl(k, null, "_").replace(/.js$/, ""));
+                    i[k] = l
+                }
+            }
+            this.$worker.postMessage({
+                init: !0,
+                tlns: i,
+                module: d,
+                classname: e
+            }), this.callbackId = 1, this.callbacks = {};
+            var m = this;
+            this.$worker.onerror = function (a) {
+                throw window.console && console.log && console.log(a), a
+            }, this.$worker.onmessage = function (a) {
+                var b = a.data;
+                switch (b.type) {
+                case "log":
+                    window.console && console.log && console.log(b.data);
+                    break;
+                case "event":
+                    m._dispatchEvent(b.name, {
+                        data: b.data
+                    });
+                    break;
+                case "call":
+                    var c = m.callbacks[b.id];
+                    c && (c(b.data), delete m.callbacks[b.id])
+                }
+            }
+        };
+    ((function () {
+        d.implement(this, e), this.$normalizePath = function (a) {
+            return a.match(/^\w+:/) || (a = location.protocol + "//" + location.host + (a.charAt(0) == "/" ? "" : location.pathname.replace(/\/[^\/]*$/, "")) + "/" + a.replace(/^[\/]+/, "")), a
+        }, this.$guessBasePath = function () {
+            if (a.aceBaseUrl) return a.aceBaseUrl;
+            var b = document.getElementsByTagName("script");
+            for (var c = 0; c < b.length; c++) {
+                var d = b[c],
+                    e = d.getAttribute("data-ace-base");
+                if (e) return e.replace(/\/*$/, "/");
+                var f = d.src || d.getAttribute("src");
+                if (!f) continue;
+                var g = f.match(/^(?:(.*\/)ace\.js|(.*\/)ace-uncompressed\.js)(?:\?|$)/);
+                if (g) return g[1] || g[2]
+            }
+            return ""
+        }, this.terminate = function () {
+            this._dispatchEvent("terminate", {}), this.$worker.terminate(), this.$worker = null, this.$doc.removeEventListener("change", this.changeListener), this.$doc = null
+        }, this.send = function (a, b) {
+            this.$worker.postMessage({
+                command: a,
+                args: b
+            })
+        }, this.call = function (a, b, c) {
+            if (c) {
+                var d = this.callbackId++;
+                this.callbacks[d] = c, b.push(d)
+            }
+            this.send(a, b)
+        }, this.emit = function (a, b) {
+            try {
+                this.$worker.postMessage({
+                    event: a,
+                    data: {
+                        data: b.data
+                    }
+                })
+            } catch (c) {}
+        }, this.attachToDocument = function (a) {
+            this.$doc && this.terminate(), this.$doc = a, this.call("setValue", [a.getValue()]), a.on("change", this.changeListener)
+        }, this.changeListener = function (a) {
+            a.range = {
+                start: a.data.range.start,
+                end: a.data.range.end
+            }, this.emit("change", a)
+        }
+    })).call(f.prototype), b.WorkerClient = f
+})

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1 @@
+define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",b.cssText=".ace-dawn .ace_editor {  border: 2px solid rgb(159, 159, 159);}.ace-dawn .ace_editor.ace_focus {  border: 2px solid #327fbd;}.ace-dawn .ace_gutter {  width: 50px;  background: #e8e8e8;  color: #333;  overflow : hidden;}.ace-dawn .ace_gutter-layer {  width: 100%;  text-align: right;}.ace-dawn .ace_gutter-layer .ace_gutter-cell {  padding-right: 6px;}.ace-dawn .ace_print_margin {  width: 1px;  background: #e8e8e8;}.ace-dawn .ace_scroller {  background-color: #F9F9F9;}.ace-dawn .ace_text-layer {  cursor: text;  color: #080808;}.ace-dawn .ace_cursor {  border-left: 2px solid #000000;}.ace-dawn .ace_cursor.ace_overwrite {  border-left: 0px;  border-bottom: 1px solid #000000;} .ace-dawn .ace_marker-layer .ace_selection {  background: rgba(39, 95, 255, 0.30);}.ace-dawn .ace_marker-layer .ace_step {  background: rgb(198, 219, 174);}.ace-dawn .ace_marker-layer .ace_brac
 ket {  margin: -1px 0 0 -1px;  border: 1px solid rgba(75, 75, 126, 0.50);}.ace-dawn .ace_marker-layer .ace_active_line {  background: rgba(36, 99, 180, 0.12);}.ace-dawn .ace_marker-layer .ace_selected_word {  border: 1px solid rgba(39, 95, 255, 0.30);}       .ace-dawn .ace_invisible {  color: rgba(75, 75, 126, 0.50);}.ace-dawn .ace_keyword {  color:#794938;}.ace-dawn .ace_constant {  color:#811F24;}.ace-dawn .ace_invalid.ace_illegal {  text-decoration:underline;font-style:italic;color:#F8F8F8;background-color:#B52A1D;}.ace-dawn .ace_invalid.ace_deprecated {  text-decoration:underline;font-style:italic;color:#B52A1D;}.ace-dawn .ace_support {  color:#691C97;}.ace-dawn .ace_fold {}.ace-dawn .ace_support.ace_function {  color:#693A17;}.ace-dawn .ace_string {  color:#0B6125;}.ace-dawn .ace_string.ace_regexp {  color:#CF5628;}.ace-dawn .ace_comment {  font-style:italic;color:#5A525F;}.ace-dawn .ace_variable {  color:#234A97;}.ace-dawn .ace_markup.ace_underline {    text-decoration
 :underline;}.ace-dawn .ace_markup.ace_heading {  color:#19356D;}.ace-\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,104 @@
+define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",
+	b.cssText=".ace-dawn .ace_editor {\
+		  border: 2px solid rgb(159, 159, 159);\
+		}\
+		\
+		.ace-dawn .ace_editor.ace_focus {\
+		  border: 2px solid #327fbd;\
+		}\
+		\
+		.ace-dawn .ace_gutter {\
+		  width: 50px;\
+		  background: rgb(227, 227, 227);\
+		  border-right: 1px solid rgb(159, 159, 159);	 \
+		  color: rgb(136, 136, 136);\
+		}\
+		\
+		.ace-dawn .ace_gutter-layer {\
+		  width: 100%;\
+		  text-align: right;\
+		}\
+		\
+		.ace-dawn .ace_gutter-layer .ace_gutter-cell {\
+		  padding-right: 6px;\
+		}\
+		\
+		.ace-dawn .ace_text-layer {\
+		  cursor: text;\
+		}\
+		\
+		.ace-dawn .ace_cursor {\
+		  border-left: 1px solid black;\
+		}\
+		\
+		.ace-dawn .ace_line .ace_keyword, .ace-dawn .ace_line .ace_variable {\
+		  color: rgb(127, 0, 85);\
+		  font-weight:bold;\
+		}\
+		\
+		.ace-dawn .ace_line .ace_constant.ace_buildin {\
+		  color: rgb(88, 72, 246);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_constant.ace_library {\
+		  color: rgb(6, 150, 14);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_function {\
+		  color: rgb(60, 76, 114);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_string {\
+		  color: rgb(42, 0, 255);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_comment {\
+		  color: rgb(63, 127, 95);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_comment.ace_doc {\
+		  color: rgb(63, 95, 191);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_comment.ace_doc.ace_tag {\
+		  color: rgb(127, 159, 191);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_constant.ace_numeric {\
+		}\
+		\
+		.ace-dawn .ace_line .ace_tag {\
+			color: rgb(63, 127, 127);\
+		}\
+		\
+		.ace-dawn .ace_line .ace_xml_pe {\
+		  color: rgb(104, 104, 91);\
+		}\
+		\
+		.ace-dawn .ace_marker-layer .ace_selection {\
+		  background: rgb(181, 213, 255);\
+		}\
+		\
+		.ace-dawn .ace_marker-layer .ace_bracket {\
+		  margin: -1px 0 0 -1px;\
+		  border: 1px solid rgb(192, 192, 192);\
+		}\
+		\
+		\
+		.ace-dawn .ace_invalid.ace_illegal {\
+		  //text-decoration:underline;\
+		  font-style:italic;\
+		  background-image: url(underline.gif);\
+		  background-position: bottom;\
+		  background-repeat: repeat-x;\
+		  //color:#F8F8F8;\
+		  //background-color:#B52A1D;\
+		}\
+		\
+		\
+		.ace-dawn .ace_marker-layer .ace_active_line {\
+		  background: rgb(232, 242, 254);\
+		}";
+
+
+var d=a("../lib/dom");d.importCssString(b.cssText)})
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-eclipse.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-eclipse.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,134 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define(function(require, exports, module) {
+
+    var dom = require("pilot/dom");
+
+    var cssText = ".ace-eclipse .ace_editor {\
+  border: 2px solid rgb(159, 159, 159);\
+}\
+\
+.ace-eclipse .ace_editor.ace_focus {\
+  border: 2px solid #327fbd;\
+}\
+\
+.ace-eclipse .ace_gutter {\
+  width: 50px;\
+  background: rgb(227, 227, 227);\
+  border-right: 1px solid rgb(159, 159, 159);	 \
+  color: rgb(136, 136, 136);\
+}\
+\
+.ace-eclipse .ace_gutter-layer {\
+  width: 100%;\
+  text-align: right;\
+}\
+\
+.ace-eclipse .ace_gutter-layer .ace_gutter-cell {\
+  padding-right: 6px;\
+}\
+\
+.ace-eclipse .ace_text-layer {\
+  cursor: text;\
+}\
+\
+.ace-eclipse .ace_cursor {\
+  border-left: 1px solid black;\
+}\
+\
+.ace-eclipse .ace_line .ace_keyword, .ace-eclipse .ace_line .ace_variable {\
+  color: rgb(127, 0, 85);\
+}\
+\
+.ace-eclipse .ace_line .ace_constant.ace_buildin {\
+  color: rgb(88, 72, 246);\
+}\
+\
+.ace-eclipse .ace_line .ace_constant.ace_library {\
+  color: rgb(6, 150, 14);\
+}\
+\
+.ace-eclipse .ace_line .ace_function {\
+  color: rgb(60, 76, 114);\
+}\
+\
+.ace-eclipse .ace_line .ace_string {\
+  color: rgb(42, 0, 255);\
+}\
+\
+.ace-eclipse .ace_line .ace_comment {\
+  color: rgb(63, 127, 95);\
+}\
+\
+.ace-eclipse .ace_line .ace_comment.ace_doc {\
+  color: rgb(63, 95, 191);\
+}\
+\
+.ace-eclipse .ace_line .ace_comment.ace_doc.ace_tag {\
+  color: rgb(127, 159, 191);\
+}\
+\
+.ace-eclipse .ace_line .ace_constant.ace_numeric {\
+}\
+\
+.ace-eclipse .ace_line .ace_tag {\
+	color: rgb(63, 127, 127);\
+}\
+\
+.ace-eclipse .ace_line .ace_xml_pe {\
+  color: rgb(104, 104, 91);\
+}\
+\
+.ace-eclipse .ace_marker-layer .ace_selection {\
+  background: rgb(181, 213, 255);\
+}\
+\
+.ace-eclipse .ace_marker-layer .ace_bracket {\
+  margin: -1px 0 0 -1px;\
+  border: 1px solid rgb(192, 192, 192);\
+}\
+\
+.ace-eclipse .ace_marker-layer .ace_active_line {\
+  background: rgb(232, 242, 254);\
+}";
+
+    // import CSS once
+    dom.importCssString(cssText);
+
+    exports.cssClass = "ace-eclipse";
+});

Added: spoofax-ace/trunk/spoofax-ace/resources/ace/static.py
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/static.py	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,242 @@
+#!/usr/bin/env python
+"""static - A stupidly simple WSGI way to serve static (or mixed) content.
+
+(See the docstrings of the various functions and classes.)
+
+Copyright (C) 2006-2009 Luke Arno - http://lukearno.com/
+
+This library is free software; you can redistribute it and/or
+modify it under the terms of the GNU Lesser General Public
+License as published by the Free Software Foundation; either
+version 2.1 of the License, or (at your option) any later version.
+
+This library is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+Lesser General Public License for more details.
+
+You should have received a copy of the GNU Lesser General Public
+License along with this library; if not, write to:
+
+The Free Software Foundation, Inc.,
+51 Franklin Street, Fifth Floor,
+Boston, MA  02110-1301, USA.
+
+Luke Arno can be found at http://lukearno.com/
+
+"""
+
+import mimetypes
+import rfc822
+import time
+import string
+import sys
+from os import path, stat, getcwd
+from wsgiref import util
+from wsgiref.headers import Headers
+from wsgiref.simple_server import make_server
+from optparse import OptionParser
+
+try: from pkg_resources import resource_filename, Requirement
+except: pass
+
+try: import kid
+except: pass
+
+
+class MagicError(Exception): pass
+
+
+class StatusApp:
+    """Used by WSGI apps to return some HTTP status."""
+
+    def __init__(self, status, message=None):
+        self.status = status
+        if message is None:
+            self.message = status
+        else:
+            self.message = message
+
+    def __call__(self, environ, start_response, headers=[]):
+        if self.message:
+            Headers(headers).add_header('Content-type', 'text/plain')
+        start_response(self.status, headers)
+        if environ['REQUEST_METHOD'] == 'HEAD':
+            return [""]
+        else:
+            return [self.message]
+
+
+class Cling(object):
+    """A stupidly simple way to serve static content via WSGI.
+
+    Serve the file of the same path as PATH_INFO in self.datadir.
+
+    Look up the Content-type in self.content_types by extension
+    or use 'text/plain' if the extension is not found.
+
+    Serve up the contents of the file or delegate to self.not_found.
+    """
+
+    block_size = 16 * 4096
+    index_file = 'index.html'
+    not_found = StatusApp('404 Not Found')
+    not_modified = StatusApp('304 Not Modified', "")
+    moved_permanently = StatusApp('301 Moved Permanently')
+    method_not_allowed = StatusApp('405 Method Not Allowed')
+
+    def __init__(self, root, **kw):
+        """Just set the root and any other attribs passes via **kw."""
+        self.root = root
+        for k, v in kw.iteritems():
+            setattr(self, k, v)
+
+    def __call__(self, environ, start_response):
+        """Respond to a request when called in the usual WSGI way."""
+        if environ['REQUEST_METHOD'] not in ('GET', 'HEAD'):
+            headers = [('Allow', 'GET, HEAD')]
+            return self.method_not_allowed(environ, start_response, headers)
+        path_info = environ.get('PATH_INFO', '')
+        full_path = self._full_path(path_info)
+        if not self._is_under_root(full_path):
+            return self.not_found(environ, start_response)
+        if path.isdir(full_path):
+            if full_path[-1] <> '/' or full_path == self.root:
+                location = util.request_uri(environ, include_query=False) + '/'
+                if environ.get('QUERY_STRING'):
+                    location += '?' + environ.get('QUERY_STRING')
+                headers = [('Location', location)]
+                return self.moved_permanently(environ, start_response, headers)
+            else:
+                full_path = self._full_path(path_info + self.index_file)
+        content_type = self._guess_type(full_path)
+        try:
+            etag, last_modified = self._conditions(full_path, environ)
+            headers = [('Date', rfc822.formatdate(time.time())),
+                       ('Last-Modified', last_modified),
+                       ('ETag', etag)]
+            if_modified = environ.get('HTTP_IF_MODIFIED_SINCE')
+            if if_modified and (rfc822.parsedate(if_modified)
+                                >= rfc822.parsedate(last_modified)):
+                return self.not_modified(environ, start_response, headers)
+            if_none = environ.get('HTTP_IF_NONE_MATCH')
+            if if_none and (if_none == '*' or etag in if_none):
+                return self.not_modified(environ, start_response, headers)
+            file_like = self._file_like(full_path)
+            headers.append(('Content-Type', content_type))
+            start_response("200 OK", headers)
+            if environ['REQUEST_METHOD'] == 'GET':
+                return self._body(full_path, environ, file_like)
+            else:
+                return ['']
+        except (IOError, OSError), e:
+            print e
+            return self.not_found(environ, start_response)
+
+    def _full_path(self, path_info):
+        """Return the full path from which to read."""
+        return self.root + path_info
+
+    def _is_under_root(self, full_path):
+        """Guard against arbitrary file retrieval."""
+        if (path.abspath(full_path) + path.sep)\
+            .startswith(path.abspath(self.root) + path.sep):
+            return True
+        else:
+            return False
+
+    def _guess_type(self, full_path):
+        """Guess the mime type using the mimetypes module."""
+        return mimetypes.guess_type(full_path)[0] or 'text/plain'
+
+    def _conditions(self, full_path, environ):
+        """Return a tuple of etag, last_modified by mtime from stat."""
+        mtime = stat(full_path).st_mtime
+        return str(mtime), rfc822.formatdate(mtime)
+
+    def _file_like(self, full_path):
+        """Return the appropriate file object."""
+        return open(full_path, 'rb')
+
+    def _body(self, full_path, environ, file_like):
+        """Return an iterator over the body of the response."""
+        way_to_send = environ.get('wsgi.file_wrapper', iter_and_close)
+        return way_to_send(file_like, self.block_size)
+
+
+def iter_and_close(file_like, block_size):
+    """Yield file contents by block then close the file."""
+    while 1:
+        try:
+            block = file_like.read(block_size)
+            if block: yield block
+            else: raise StopIteration
+        except StopIteration, si:
+            file_like.close()
+            return
+
+
+def cling_wrap(package_name, dir_name, **kw):
+    """Return a Cling that serves from the given package and dir_name.
+
+    This uses pkg_resources.resource_filename which is not the
+    recommended way, since it extracts the files.
+
+    I think this works fine unless you have some _very_ serious
+    requirements for static content, in which case you probably
+    shouldn't be serving it through a WSGI app, IMHO. YMMV.
+    """
+    resource = Requirement.parse(package_name)
+    return Cling(resource_filename(resource, dir_name), **kw)
+
+
+def command():
+    parser = OptionParser(usage="%prog DIR [HOST][:][PORT]",
+                          version="static 0.3.6")
+    options, args = parser.parse_args()
+    if len(args) in (1, 2):
+        if len(args) == 2:
+            parts = args[1].split(":")
+            if len(parts) == 1:
+                host = parts[0]
+                port = None
+            elif len(parts) == 2:
+                host, port = parts
+            else:
+                sys.exit("Invalid host:port specification.")
+        elif len(args) == 1:
+            host, port = None, None
+        if not host:
+            host = '0.0.0.0'
+        if not port:
+            port = 8888
+        try:
+            port = int(port)
+        except:
+            sys.exit("Invalid host:port specification.")
+        app = Cling(args[0])
+        try:
+            make_server(host, port, app).serve_forever()
+        except KeyboardInterrupt, ki:
+            print "Cio, baby!"
+        except:
+            sys.exit("Problem initializing server.")
+    else:
+        parser.print_help(sys.stderr)
+        sys.exit(1)
+
+
+def test():
+    from wsgiref.validate import validator
+    app = Cling(getcwd())
+    try:
+        print "Serving " + getcwd() + " to http://localhost:8888"
+        make_server('0.0.0.0', 8888, validator(app)).serve_forever()
+    except KeyboardInterrupt, ki:
+        print ""
+        print "Ciao, baby!"
+
+
+if __name__ == '__main__':
+    test()
+

Added: spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/code.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/code.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,531 @@
+/**
+ * Code Editor for the Cloud9 IDE
+ *
+ * @copyright 2010, Ajax.org B.V.
+ * @license GPLv3 <http://www.gnu.org/licenses/gpl.txt>
+ */
+
+define(function(require, exports, module) {
+
+require("apf/elements/codeeditor");
+
+var ide = require("core/ide");
+var ext = require("core/ext");
+var EditSession = require("ace/edit_session").EditSession;
+var HashHandler = require("ace/keyboard/hash_handler").HashHandler;
+var useragent = require("ace/lib/useragent");
+var Document = require("ace/document").Document;
+var Range = require("ace/range").Range;
+var ProxyDocument = require("ext/code/proxydocument");
+var CommandManager = require("ace/commands/command_manager").CommandManager;
+var defaultCommands = require("ace/commands/default_commands").commands;
+var markup = require("text!ext/code/code.xml");
+var settings = require("ext/settings/settings");
+var markupSettings = require("text!ext/code/settings.xml");
+var editors = require("ext/editors/editors");
+
+apf.actiontracker.actions.aceupdate = function(undoObj, undo){
+    var q = undoObj.args;
+
+    if (!undoObj.initial) {
+        undoObj.initial = true;
+        return;
+    }
+
+    if (undo)
+        q[1].undoChanges(q[0]);
+    else
+        q[1].redoChanges(q[0]);
+};
+
+var SupportedModes = {
+    "text/x-tiger": "spoofax2ace",
+    "application/javascript": "javascript",
+    "application/json": "json",
+    "text/css": "css",
+    "text/x-scss": "scss",
+    "text/html": "html",
+    "application/xhtml+xml": "html",
+    "application/xml": "xml",
+    "application/rdf+xml": "xml",
+    "application/rss+xml": "xml",
+    "image/svg+xml": "svg",
+    "application/wsdl+xml": "xml",
+    "application/xslt+xml": "xml",
+    "application/atom+xml": "xml",
+    "application/mathml+xml": "xml",
+    "application/x-httpd-php": "php",
+    "text/x-script.python": "python",
+    "text/x-script.ruby": "ruby",
+    "text/x-script.perl": "perl",
+    "text/x-script.perl-module": "perl",
+    "text/x-c": "c_cpp",
+    "text/x-java-source": "java",
+    "text/x-groovy": "groovy",
+    "text/x-csharp": "csharp",
+    "text/x-script.coffeescript": "coffee",
+    "text/x-markdown": "markdown",
+    "text/x-web-textile": "textile",
+    "text/x-script.ocaml": "ocaml",
+    "text/x-script.clojure": "clojure",
+    "application/x-latex": "latex",
+    "text/x-lua": "lua",
+    "text/x-script.powershell": "powershell",
+    "text/x-scala": "scala",
+    "text/x-coldfusion": "coldfusion",
+    "text/x-sql": "sql"
+};
+
+var contentTypes = {
+    "tig": "text/x-tiger",
+    "js": "application/javascript",
+    "json": "application/json",
+    "css": "text/css",
+    "less": "text/css",
+    "scss": "text/x-scss",
+    "sass": "text/x-sass",
+
+    "xml": "application/xml",
+    "rdf": "application/rdf+xml",
+    "rss": "application/rss+xml",
+    "svg": "image/svg+xml",
+    "wsdl": "application/wsdl+xml",
+    "xslt": "application/xslt+xml",
+    "atom": "application/atom+xml",
+    "mathml": "application/mathml+xml",
+    "mml": "application/mathml+xml",
+
+    "php": "application/x-httpd-php",
+    "phtml": "application/x-httpd-php",
+    "html": "text/html",
+    "xhtml": "application/xhtml+xml",
+    "coffee": "text/x-script.coffeescript",
+    "*Cakefile": "text/x-script.coffeescript",
+    "py": "text/x-script.python",
+
+    "ru": "text/x-script.ruby",
+    "gemspec": "text/x-script.ruby",
+    "rake": "text/x-script.ruby",
+    "rb": "text/x-script.ruby",
+
+    "c": "text/x-c",
+    "cc": "text/x-c",
+    "cpp": "text/x-c",
+    "cxx": "text/x-c",
+    "h": "text/x-c",
+    "hh": "text/x-c",
+
+    "cs": "text/x-csharp",
+
+    "java": "text/x-java-source",
+    "clj": "text/x-script.clojure",
+    "groovy": "text/x-groovy",
+    "scala": "text/x-scala",
+
+    "ml": "text/x-script.ocaml",
+    "mli": "text/x-script.ocaml",
+
+    "md": "text/x-markdown",
+    "markdown": "text/x-markdown",
+    "textile": "text/x-web-textile",
+    "latex": "application/x-latex",
+    "tex": "application/x-latex",
+    "ltx": "application/x-latex",
+
+    "lua": "text/x-lua",
+
+    "pl": "text/x-script.perl",
+    "pm": "text/x-script.perl-module",
+
+    "ps1": "text/x-script.powershell",
+    "cfm": "text/x-coldfusion",
+    "sql": "text/x-sql"
+};
+
+module.exports = ext.register("ext/code/code", {
+    name    : "Code Editor",
+    dev     : "Ajax.org",
+    type    : ext.EDITOR,
+    markup  : markup,
+    deps    : [editors],
+
+    nodes : [],
+
+    fileExtensions : Object.keys(contentTypes),
+    supportedModes: Object.keys(SupportedModes),
+    commandManager : new CommandManager(useragent.isMac ? "mac" : "win", defaultCommands),
+
+    getState : function(doc) {
+        doc = doc ? doc.acesession : this.getDocument();
+        if (!doc || typeof doc.getSelection != "function")
+            return;
+
+        var folds = doc.getAllFolds().map(function(fold) {
+            return {
+                start: fold.start,
+                end: fold.end,
+                placeholder: fold.placeholder
+            };
+        });
+
+        var sel = doc.getSelection();
+        return {
+            scrolltop  : doc.getScrollTop(),
+            scrollleft : doc.getScrollLeft(),
+            selection  : sel.getRange(),
+            folds      : folds
+        };
+    },
+
+    setState : function(doc, state){
+        var aceDoc = doc ? doc.acesession : this.getDocument();
+        if (!aceDoc || !state || typeof aceDoc.getSelection != "function")
+            return;
+
+        var sel = aceDoc.getSelection();
+
+        //are those 3 lines set the values in per document base or are global for editor
+        sel.setSelectionRange(state.selection, false);
+
+        aceDoc.setScrollTop(state.scrolltop);
+        aceDoc.setScrollLeft(state.scrollleft);
+
+        if (state.folds) {
+            for (var i = 0, l=state.folds.length; i < l; i++) {
+                var fold = state.folds[i];
+                aceDoc.addFold(fold.placeholder, Range.fromPoints(fold.start, fold.end));
+            }
+        }
+
+        // if newfile == 1 and there is text cached, restore it
+        var node = doc.getNode && doc.getNode();
+        if (node && parseInt(node.getAttribute("newfile") || 0, 10) === 1 && node.childNodes.length) {
+            // the text is cached within a CDATA block as first childNode of the <file>
+            if (doc.getNode().childNodes[0] instanceof CDATASection) {
+                aceDoc.setValue(doc.getNode().childNodes[0].nodeValue);
+            }
+        }
+    },
+
+    getSyntax : function(node) {
+        if (!node)
+            return "";
+
+        var mime = node.getAttribute("customtype");
+
+        if (!mime) {
+            var fileName = node.getAttribute("name");
+
+            if (fileName.lastIndexOf(".") != -1)
+                mime = contentTypes[fileName.split(".").pop()];
+            else
+                mime = contentTypes["*" + fileName];
+        }
+
+        if (mime) {
+            mime = mime.split(";")[0];
+            return (SupportedModes[mime] || "text");
+        }
+
+        return "text";
+    },
+
+    getSelection : function(){
+        if (typeof ceEditor == "undefined")
+            return null;
+        return ceEditor.getSelection();
+    },
+
+    getDocument : function(){
+        if (typeof ceEditor == "undefined")
+            return null;
+        return ceEditor.getSession();
+    },
+
+    setDocument : function(doc, actiontracker){
+        var _self = this;
+
+        if (!doc.acesession) {
+            doc.isInited = doc.hasValue();
+            doc.acedoc = doc.acedoc || new ProxyDocument(new Document(doc.getValue() || ""));
+            doc.acesession = new EditSession(doc.acedoc);
+            doc.acedoc = doc.acesession.getDocument();
+
+            doc.acesession.setUndoManager(actiontracker);
+
+            if (doc.isInited && doc.state)
+                 _self.setState(doc, doc.state);
+
+            doc.addEventListener("prop.value", function(e) {
+                if (this.editor != _self)
+                    return;
+
+                doc.acesession.setValue(e.value || "");
+                if (doc.state)
+                    _self.setState(doc, doc.state);
+                doc.isInited = true;
+            });
+
+            doc.addEventListener("retrievevalue", function(e) {
+                if (this.editor != _self)
+                    return;
+
+                if (!doc.isInited)
+                    return e.value;
+                else
+                    return doc.acesession.getValue();
+            });
+
+            doc.addEventListener("close", function(){
+                if (this.editor != _self)
+                    return;
+
+                //??? destroy doc.acesession
+            });
+        }
+        ceEditor.setProperty("value", doc.acesession);
+
+        if (doc.editor && doc.editor != this) {
+            var value = doc.getValue();
+            if (doc.acesession.getValue() !== value) {
+                doc.editor = this;
+                doc.dispatchEvent("prop.value", {value : value});
+            }
+        }
+
+        doc.editor = this;
+    },
+
+    hook: function() {
+        var _self      = this;
+
+        //Settings Support
+        ide.addEventListener("init.ext/settings/settings", function(e) {
+            var heading = e.ext.getHeading("Code Editor");
+            heading.insertMarkup(markupSettings);
+        });
+
+        ide.addEventListener("loadsettings", function(e) {
+            var model = e.model;
+            if (!model.queryNode("editors/code")) {
+                var node = apf.n("<code />")
+                  .attr("overwrite", "false")
+                  .attr("selectstyle", "line")
+                  .attr("activeline", "true")
+                  .attr("showinvisibles", "false")
+                  .attr("showprintmargin", "true")
+                  .attr("printmargincolumn", "80")
+                  .attr("softtabs", "true")
+                  .attr("tabsize", "4")
+                  .attr("scrollspeed", "2")
+                  .attr("fontsize", "12")
+                  .attr("wrapmode", "false")
+                  .attr("wraplimitmin", "")
+                  .attr("wraplimitmax", "")
+                  .attr("gutter", "true")
+                  .attr("highlightselectedword", "true")
+                  .attr("autohidehorscrollbar", "true").node();
+
+                var editors = apf.createNodeFromXpath(model.data, "editors");
+                apf.xmldb.appendChild(editors, node);
+            }
+
+            // pre load theme
+            var theme = e.model.queryValue("editors/code/@theme");
+            if (theme)
+                require([theme], function() {});
+            // pre load custom mime types
+            _self.getCustomTypes(e.model);
+        });
+
+        ide.addEventListener("afteropenfile", function(e) {
+            if (_self.setState)
+                _self.setState(e.doc, e.doc.state);
+
+            if (e.doc && e.doc.editor && e.doc.editor.ceEditor) {
+                // check if there is a scriptid, if not check if the file is somewhere in the stack
+                if (typeof mdlDbgStack != "undefined" && mdlDbgStack.data && e.node
+                  && (!e.node.hasAttribute("scriptid") || !e.node.getAttribute("scriptid"))
+                  && e.node.hasAttribute("scriptname") && e.node.getAttribute("scriptname")) {
+                    var nodes = mdlDbgStack.data.selectNodes("//frame[@script='" + e.node.getAttribute("scriptname").replace(ide.workspaceDir + "/", "") + "']");
+                    if (nodes.length) {
+                        e.node.setAttribute("scriptid", nodes[0].getAttribute("scriptid"));
+                    }
+                }
+                e.doc.editor.ceEditor.afterOpenFile(e.doc.editor.ceEditor.getSession());
+            }
+        });
+
+        tabEditors.addEventListener("afterswitch", function(e) {
+            ceEditor.afterOpenFile(ceEditor.getSession());
+        });
+
+        // preload common language modes
+        require(["ace/mode/javascript", "ace/mode/html", "ace/mode/css"], function() {});
+    },
+
+    init: function(amlPage) {
+        amlPage.appendChild(ceEditor);
+        ceEditor.show();
+
+        this.ceEditor = this.amlEditor = ceEditor;
+        ceEditor.$editor.commands = this.commandManager;
+
+        var _self = this;
+
+        this.nodes.push(
+            //Add a panel to the statusbar showing whether the insert button is pressed
+            sbMain.appendChild(new apf.section({
+                caption : "{ceEditor.insert}"
+            })),
+
+            //Add a panel to the statusbar showing the length of the document
+            sbMain.appendChild(new apf.section({
+                caption : "Length: {ceEditor.value.length}"
+            })),
+
+            mnuView.appendChild(new apf.item({
+                caption : "Syntax Highlighting",
+                submenu : "mnuSyntax"
+            })),
+
+            mnuView.appendChild(new apf.divider()),
+
+            mnuView.appendChild(new apf.item({
+                type    : "check",
+                caption : "Show Invisibles",
+                checked : "[{require('ext/settings/settings').model}::editors/code/@showinvisibles]"
+            })),
+
+            mnuView.appendChild(new apf.item({
+                type    : "check",
+                caption : "Wrap Lines",
+                checked : "{ceEditor.wrapmode}"
+            }))
+        );
+
+        mnuSyntax.onitemclick = function(e) {
+            var file = ide.getActivePageModel();
+            if (file) {
+                var value = e.relatedNode.value;
+
+                if (value == "auto")
+                    apf.xmldb.removeAttribute(file, "customtype", "");
+                else
+                    apf.xmldb.setAttribute(file, "customtype", value);
+
+                if (file.getAttribute("customtype")) {
+                    var fileName = file.getAttribute("name");
+
+                    if (contentTypes["*" + fileName])
+                        delete contentTypes["*" + fileName];
+
+                    var mime = value.split(";")[0];
+                    var fileExt = (fileName.lastIndexOf(".") != -1) ?
+                        fileName.split(".").pop() : null;
+
+                    if (fileExt && contentTypes[fileExt] !== mime)
+                        delete contentTypes[fileExt];
+
+                    var customType = fileExt ?
+                        contentTypes[fileExt] : contentTypes["*" + fileName];
+
+                    if (!customType)
+                        _self.setCustomType(fileExt ? fileExt : file, mime);
+                    ide.dispatchEvent("track_action", {
+                        type: "syntax highlighting",
+                        fileType: fileExt,
+                        fileName: fileName,
+                        mime: mime,
+                        customType: customType
+                    });
+                }
+            }
+        };
+
+        ide.addEventListener("keybindingschange", function(e) {
+            if (typeof ceEditor == "undefined")
+                return;
+
+            var bindings = e.keybindings.code;
+            ceEditor.$editor.setKeyboardHandler(new HashHandler(bindings));
+            // In case the `keybindingschange` event gets fired after other
+            // plugins that change keybindings have already changed them (i.e.
+            // the vim plugin), we fire an event so these plugins can react to it.
+            ide.dispatchEvent("code.ext:defaultbindingsrestored", {});
+        });
+    },
+
+    /**
+     * Saves custom syntax for extension type in settings.xml
+     *
+     * @param {String|xmlNode} ext Contains the extension type shorthand
+     * @param {String} mime Mime type string the extension will be related to
+     */
+    setCustomType: function(ext, mime) {
+        var node;
+
+        if (typeof ext === "string") {
+            node = settings.model.queryNode('auto/customtypes/mime[@ext="' + ext + '"]');
+            if (!node)
+                settings.model.appendXml('<mime name="' + mime + '" ext="' + ext + '" />', "auto/customtypes");
+        } else {
+            var name = ext.getAttribute("name") || "";
+            node = settings.model.queryNode('auto/customtypes/mime[@filename="' + name + '"]');
+            if (node)
+                apf.xmldb.removeAttribute(node, "ext");
+            else
+                settings.model.appendXml('<mime name="' + mime + '" filename="' + name + '" />', "auto/customtypes");
+        }
+
+        apf.xmldb.setAttribute(node, "name", mime);
+        settings.save();
+    },
+
+    /**
+     * Retrieves custom syntax for extensions saved in settings.xml
+     *
+     * @param {Object} model Settings' model
+     */
+    getCustomTypes: function(model) {
+        var customTypes = model.queryNode("auto/customtypes");
+        if (!customTypes)
+            customTypes = apf.createNodeFromXpath(model.data, "auto/customtypes");
+
+        var mimes = customTypes.selectNodes("mime");
+        mimes.forEach(function(n) {
+            if (n.getAttribute("filename"))
+                contentTypes["*" + n.getAttribute("filename")] = n.getAttribute("name");
+            else
+                contentTypes[n.getAttribute("ext")] = n.getAttribute("name");
+        });
+    },
+
+
+    enable : function() {
+        this.nodes.each(function(item){
+            item.show();
+        });
+    },
+
+    disable : function() {
+        this.nodes.each(function(item){
+            item.hide();
+        });
+    },
+
+    destroy : function(){
+        this.nodes.each(function(item){
+            item.destroy(true, true);
+        });
+
+        if (self.ceEditor) {
+            ceEditor.destroy(true, true);
+            mnuSyntax.destroy(true, true);
+        }
+
+        this.nodes = [];
+    }
+});
+
+});

Added: spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/code.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/cloud9/client/ext/code/code.xml	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,76 @@
+<a:application xmlns:a="http://ajax.org/2005/aml">
+    <a:codeeditor id="ceEditor"
+      flex              = "1"
+      anchors           = "2 0 0 0"
+      visible           = "false"
+      syntax            = "{require('ext/code/code').getSyntax(%[.])}"
+      theme             = "[{require('ext/settings/settings').model}::editors/code/@theme]"
+      overwrite         = "[{require('ext/settings/settings').model}::editors/code/@overwrite]"
+      folding           = "[{require('ext/settings/settings').model}::editors/code/@folding]"
+      behaviors         = "[{require('ext/settings/settings').model}::editors/code/@behaviors]"
+      selectstyle       = "[{require('ext/settings/settings').model}::editors/code/@selectstyle]"
+      activeline        = "[{require('ext/settings/settings').model}::editors/code/@activeline]"
+      showinvisibles    = "[{require('ext/settings/settings').model}::editors/code/@showinvisibles]"
+      showprintmargin   = "[{require('ext/settings/settings').model}::editors/code/@showprintmargin]"
+      printmargincolumn = "[{require('ext/settings/settings').model}::editors/code/@printmargincolumn]"
+      softtabs          = "[{require('ext/settings/settings').model}::editors/code/@softtabs]"
+      tabsize           = "[{require('ext/settings/settings').model}::editors/code/@tabsize]"
+      scrollspeed       = "[{require('ext/settings/settings').model}::editors/code/@scrollspeed]"
+      
+      fontsize          = "[{require('ext/settings/settings').model}::editors/code/@fontsize]"
+      wrapmode          = "[@wrapmode]"
+      wraplimitmin      = "80"
+      wraplimitmax      = "80"
+      gutter            = "[{require('ext/settings/settings').model}::editors/code/@gutter]"
+      highlightselectedword = "[{require('ext/settings/settings').model}::editors/code/@highlightselectedword]"
+      autohidehorscrollbar  = "[{require('ext/settings/settings').model}::editors/code/@autohidehorscrollbar]"
+      
+      contextmenu       = "mnuCtxEditor"
+      debugger          = "{this.syntax == 'javascript' ? dbg : null}"
+      readonly          = "{[@loading] or cloud9config.readonly or (location.host and window.stDebugProcessRunning and stDebugProcessRunning.active and [@scriptid])}"
+    />
+    
+    <a:menu id="mnuCtxEditor" render="runtime">
+        <a:item onclick="tabEditors.getPage().$at.undo()">Undo</a:item>
+        <a:item onclick="tabEditors.getPage().$at.redo()">Redo</a:item>
+        <a:divider />
+        <a:item 
+          visible="{stDebugProcessRunning.active and !stRunning.active}"
+          onclick="
+            require('ext/quickwatch/quickwatch').toggleDialog(1, true);
+          ">Quick Watch</a:item>
+        <a:divider visible="{stDebugProcessRunning.active and !stRunning.active}" />
+        <a:item onclick="ceEditor.$editor.getSelection().selectAll()">Select All</a:item>
+    </a:menu>
+    
+    <a:menu id="mnuSyntax">
+        <a:item type="radio" value="auto">Auto-Select</a:item>
+        <a:item type="radio" value="text/plain">Plain Text</a:item>
+        <a:divider />
+        <a:item type="radio" value="text/x-tiger">Tiger</a:item>
+        <a:item type="radio" value="text/x-csharp">C#</a:item>
+        <a:item type="radio" value="text/x-c">C/C++</a:item>
+        <a:item type="radio" value="text/x-script.clojure">Clojure</a:item>
+        <a:item type="radio" value="text/x-script.coffeescript">CoffeeScript</a:item>
+        <a:item type="radio" value="text/x-coldfusion">Coldfusion</a:item>
+        <a:item type="radio" value="text/css">CSS</a:item>
+        <a:item type="radio" value="text/x-groovy">Groovy</a:item>
+        <a:item type="radio" value="text/x-java-source">Java</a:item>
+        <a:item type="radio" value="application/javascript">JavaScript</a:item>
+        <a:item type="radio" value="application/x-latex">Latex</a:item>
+        <a:item type="radio" value="text/x-lua">Lua</a:item>
+        <a:item type="radio" value="text/x-markdown">Markdown</a:item>
+        <a:item type="radio" value="text/x-script.ocaml">OCaml</a:item>
+        <a:item type="radio" value="application/x-httpd-php">PHP</a:item>
+        <a:item type="radio" value="text/x-script.perl">Perl</a:item>
+        <a:item type="radio" value="text/x-script.powershell">Powershell</a:item>
+        <a:item type="radio" value="text/x-script.python">Python</a:item>
+        <a:item type="radio" value="text/x-script.ruby">Ruby</a:item>
+        <a:item type="radio" value="text/x-scala">Scala</a:item>
+        <a:item type="radio" value="text/x-scss">SCSS</a:item>
+        <a:item type="radio" value="text/x-sql">SQL</a:item>
+        <a:item type="radio" value="text/x-web-textile">Textile</a:item>
+        <a:item type="radio" value="text/html">(X)HTML</a:item>
+        <a:item type="radio" value="application/xml">XML</a:item>
+    </a:menu>
+</a:application>

Added: spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,121 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define(function(require, exports, module) {
+
+var oop = require("ace/lib/oop");
+var TextMode = require("ace/mode/text").Mode;
+var Spoofax2AceTokenizer = require("ace/mode/spoofax2ace_tokenizer").Spoofax2AceTokenizer;
+var MatchingBraceOutdent = require("ace/mode/matching_brace_outdent").MatchingBraceOutdent;
+var Range = require("ace/range").Range;
+var WorkerClient = require("ace/worker/worker_client").WorkerClient;
+
+var Spoofax2AceMode = function() {
+    this.$tokenizer = new Spoofax2AceTokenizer();
+    this.$outdent = new MatchingBraceOutdent();
+    this.$worker = null;
+    this.debugWorker = true;
+};
+oop.inherits(Spoofax2AceMode, TextMode);
+
+var before;
+var after;
+
+(function() {
+    this.createWorker = function(session) {
+        console.log("Creating worker");
+        before = new Date().getTime();
+        var tokenizer = this.$tokenizer;
+        var doc = session.getDocument();
+        var worker = new WorkerClient(["ace", "pilot"], "worker-spoofax2ace.js", "ace/mode/spoofax2ace_worker", "SpoofaxToAceWorker");
+        worker.call("setValue", [doc.getValue()]);
+
+        var onChange = function(e) {
+            var d = e.data;
+            var r = e.data.range;
+            if(d.action === "insertText" && d.text === '\n') {
+                tokenizer.shiftTokens(r.start.row, 1);
+            }
+            if(d.action === "insertLines") {
+                tokenizer.shiftTokens(r.start.row, d.lines.length);
+            }
+            if(d.action === "removeText" && d.text === '\n') {
+                tokenizer.unshiftTokens(r.start.row, 1);
+            }
+            if(d.action === "removeLines"){
+                tokenizer.unshiftTokens(r.start.row, d.lines.length);
+            }
+
+            worker.emit("change", e);
+        };
+        doc.on("change", onChange);
+
+        if(this.debugWorker) {
+            worker.on("log", function(e) {
+                console.log("worker:" + e.data);
+            });
+
+            worker.on("debug", function(e) {
+                console.log(e.data);
+            });
+        }
+
+        worker.on("loaded", function(e) {
+            after = new Date().getTime();
+            console.log("Loading completed in " + (after-before) + " ms.");
+            worker.call("setValue", [doc.getValue()]);
+        });
+
+        worker.on("jsglr", function(e) {
+            tokenizer.setTokens(e.data.parsed);
+            session.setAnnotations(e.data.errors);
+        });
+
+        worker.on("terminate", function() {
+            doc.removeListener("change", onChange);
+            session.clearAnnotations();
+        });
+
+        this.$worker = worker;
+
+        return worker;
+    };
+
+}).call(Spoofax2AceMode.prototype);
+
+exports.Mode = Spoofax2AceMode;
+});

Added: spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_tokenizer.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_tokenizer.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,111 @@
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define(function(require, exports, module) {
+
+var oop = require("ace/lib/oop");
+var EventEmitter = require("ace/lib/event_emitter").EventEmitter;
+
+var Spoofax2AceTokenizer = function() {
+    this.parsed = [];
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.fireUpdateEvent = function(firstRow, lastRow) {
+        var data = {
+            first: firstRow,
+            last: lastRow
+        };
+        this._dispatchEvent("update", {data: data});
+    };
+
+    this.setTokens = function(tokens) {
+        this.parsed = tokens;
+        this.fireUpdateEvent(0, undefined);
+    }
+
+    this.shiftTokens = function(start, amount) {
+        var args = [start, 0];
+        for(var i = 0; i < amount; i++) {
+            args.push({});
+        }
+        Array.prototype.splice.apply(this.parsed, args);
+    }
+
+    this.unshiftTokens = function(start, amount) {
+        this.parsed.splice(start, amount);
+    }
+
+    this.unknownLine = function(text) {
+        tokens = [];
+
+        var token = {
+            type: "plain",
+            value: text
+        };
+
+        tokens.push(token);
+        return tokens;
+    }
+
+    this.getLineTokens = function(text, line) {
+        var tokens = [];
+        if(line === 'start') {
+            line = 0;
+        }
+
+        var p = this.parsed[line];
+
+        if(p === undefined || p.text !== text || p.tokens.length === 0) {
+            tokens = this.unknownLine(text);
+        } else {
+            tokens = p.tokens;
+        }
+
+        return {
+            tokens : tokens,
+            state : line + 1
+        };
+    };
+
+}).call(Spoofax2AceTokenizer.prototype);
+
+exports.Spoofax2AceTokenizer = Spoofax2AceTokenizer;
+});

Added: spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_worker.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/cloud9/support/ace/lib/ace/mode/spoofax2ace_worker.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,149 @@
+define(function(require, exports, module) {
+
+var oop = require("ace/lib/oop"); 
+var Mirror = require("ace/worker/mirror").Mirror; 
+var SpoofaxToAceWorker = exports.SpoofaxToAceWorker = function(sender) {
+//    $self.sender = sender;
+    this.setTimeout(100);
+    this.analyzer = null;
+    this.loaded = false;
+    this.loading = false;
+    this.load();
+    Mirror.call(this, sender);
+};
+
+
+var strategoProg = require("ace/strategoprog");
+
+
+var working = false;
+var goAgain = false;
+
+
+/*
+ *  Statistics collecting start
+ */
+
+var lastLineCount = 0;
+var analyzeCount = 0;
+var totalAnalyzeTime = 0;
+
+
+var doneAnalyzing = function(lineCount, timeTaken)
+{
+	if (lastLineCount !== lineCount)
+	{
+		lastLineCount = lineCount;
+		analyzeCount = 1;
+		totalAnalyzeTime = timeTaken;
+	} else
+	{
+        	totalAnalyzeTime = totalAnalyzeTime + timeTaken;
+	        analyzeCount = analyzeCount + 1;
+		sender.emit("log", "Analyzed " + lastLineCount +" lines " + analyzeCount + " times. cur:" + timeTaken + " avg: " + averageAnalyzeTime());
+	}
+}
+
+var averageAnalyzeTime = function() 
+{
+  return parseInt(totalAnalyzeTime/analyzeCount);
+}
+
+/*
+ *  Statistics collecting end
+ */
+
+oop.inherits(SpoofaxToAceWorker, Mirror); (function() {
+    this.log = function(value) {
+        if(typeof(console) !== 'undefined' && console.log !== undefined) {
+            console.log(value);
+        } else {
+            sender.emit("log", value);
+        }
+    }
+	
+    this.load = function() {
+    }	
+
+
+    this.onUpdate = function() {
+	if (!this.loaded)
+	{
+		sender.emit("log", "Not yet loaded...");
+		if (!this.loading)
+		{
+			this.loading = true;
+			var start = new Date().getTime();
+			this.analyzer = StrategoJS.init();
+
+			this.loaded = true;
+			this.loading = false;
+			var elapsed = (new Date().getTime() - start);
+		        sender.emit("log", "loaded. (" +  elapsed + ")");
+			this.onUpdate();
+		}
+		return;
+	}
+    	if (working)
+    	{
+                sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+    	goAgain = false;
+	
+	sender.emit("log", "spoofax2ace_worker.onUpdate enter");
+//        sender.emit("log", "Analyze start");
+	var analyze_start = new Date().getTime();
+
+    
+        var value = this.doc.getValue();
+        value = value.replace(/^#!.*\n/, "\n");
+	var result = null;
+	try
+	{
+		result = this.analyzer.main(["aap", value]);
+	}
+	catch (exception)
+	{
+		sender.emit("log", "Error while analyzing: " + exception.message);
+		sender.emit("log", "Stack: " + exception.stack);
+		debugger;
+	}
+
+
+        if (result === null)
+        {
+		sender.emit("log", "Error while analyzing");
+        	working = false;
+        	return;
+        }
+        var splitlines = value.split('\n');
+        var length = result.tokens.length;
+        var parsed = [];
+        for(var i = 0; i < length; i++) {
+            var line = splitlines[i];
+            var tokens = result.tokens[i];
+            parsed[i] = {text: line, tokens: tokens};
+        }
+
+
+        sender.emit("jsglr", {
+            parsed: parsed,
+            errors: result.errors
+        });
+
+	var analyze_elapsed = (new Date().getTime() - analyze_start);
+
+	doneAnalyzing(length, analyze_elapsed);
+
+        sender.emit("log", "spoofax2ace_worker.onUpdate exit");
+        working = false;
+        if (goAgain)
+        	onUpdate();
+    }
+
+}).call(SpoofaxToAceWorker.prototype);
+
+});

Added: spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,16 @@
+ </pre>
+<script src="src/ace-uncompressed.js" type="text/javascript" charset="utf-8"></script>
+<script src="src/theme-dawn.js" type="text/javascript" charset="utf-8"></script>
+<script src="src/mode-spoofax2ace.js" type="text/javascript" charset="utf-8"></script>
+<script src="require.js" type="text/javascript" charset="utf-8"></script>
+
+<script>
+window.onload = function() {
+    var editor = ace.edit("editor");
+    editor.setTheme("ace/theme/dawn");
+    var S2AMode = require("ace/mode/spoofax2ace").Mode;
+    editor.getSession().setMode(new S2AMode());
+};
+</script>
+</body>
+</html>

Added: spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,24 @@
+ <!DOCTYPE html>
+<html lang="en">
+<head>
+  <meta charset="UTF-8">
+  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
+  <title>Editor</title>
+  <style type="text/css" media="screen">
+    body {
+        overflow: hidden;
+    }
+    
+    #editor { 
+        margin: 0;
+        position: absolute;
+        top: 0;
+        bottom: 0;
+        left: 0;
+        right: 0;
+    }
+  </style>
+</head>
+<body>
+<input type=checkbox id='local'>
+<pre id="editor">

Added: spoofax-ace/trunk/spoofax-ace/resources/html/test_append.html
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/html/test_append.html	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,23 @@
+</textarea>
+<script src="src/jsbin.wrapped.js" type="text/javascript" charset="utf-8"></script>
+
+
+<script>
+
+var analyzer = undefined;
+
+go = function(sourcecode)
+{
+	analyzer.main(["aap", sourcecode]);
+};
+
+window.onload = function() 
+{
+analyzer = StrategoJS.init();
+
+//go();
+};
+</script>
+
+</body>
+</html>
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/html/test_prepend.html
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/html/test_prepend.html	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,28 @@
+ <!DOCTYPE html>
+<html lang="en">
+<head>
+  <meta charset="UTF-8">
+  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
+  <title>Editor</title>
+  <style type="text/css" media="screen">
+
+    body {
+
+    }
+    
+    #editor { 
+
+        position: absolute; 
+        top: 50px;
+        bottom: 0;
+        left: 0;
+        right: 0;
+    }
+
+  </style>
+</head>
+<body>
+<a href='#' onclick="go(document.getElementById('editor').innerHTML); return false;">[Re Run]</a>
+<br />
+
+<textarea id="editor">
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/html/underline.gif
==============================================================================
Binary file. No diff available.

Added: spoofax-ace/trunk/spoofax-ace/resources/java/StatsCollector.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/java/StatsCollector.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,77 @@
+import java.net.Socket;
+import java.util.HashMap;
+import java.util.Map;
+
+public class StatsCollector  {
+	private static Map<String, Task> _tasks = new HashMap<String, Task>();
+	
+	public static void StartTask(String task)
+	{ 
+		task = task.replaceAll("\"", "");
+		if (_tasks.containsKey(task)) 
+			_tasks.remove(task);
+		_tasks.put(task, new Task());
+	}
+	public static void FinishedTask(String task)
+	{
+		task = task.replaceAll("\"", "");
+		if (_tasks.containsKey(task))
+			_tasks.get(task).Finished();
+	}
+	public static void RecordElapsed(String task, String langName, String metricName, String metricValue)
+	{
+		task = task.replaceAll("\"", "");
+		langName = langName.replaceAll("\"", "");
+		metricName = metricName.replaceAll("\"", "");
+		if (!_tasks.containsKey(task))
+			return;
+		String data = "#"+"nodejs_"+metricName+"_"+task+"#"+langName+"#"+metricValue+"#"+_tasks.get(task).Elapsed()+"#";
+		new StatsPoster(data).start();
+	}  
+	
+	public static void RecordMemorySize(String task, String langName, String metricName, String metricValue)
+	{
+		task = task.replaceAll("\"", "");
+		langName = langName.replaceAll("\"", "");
+		metricName = metricName.replaceAll("\"", "");
+		String data = "#"+"nodejs_"+metricName+"_"+task+"#"+langName+"#"+metricValue+"#"+
+				(Runtime.getRuntime().totalMemory() - Runtime.getRuntime().freeMemory())
+				+"#";
+		new StatsPoster(data).start();
+	}
+}
+
+class StatsPoster extends Thread {
+	private final String _postStr; 
+    public StatsPoster(String str) {
+    	_postStr = str;
+    }
+    public void run() {
+    	try {
+			Socket sock = new Socket("127.0.0.1", 8889);
+			sock.getOutputStream().write(_postStr.getBytes(), 0, _postStr.length());
+			
+		} catch (Exception e) {
+		}
+    }
+}
+
+
+class Task 
+{
+	private long _startTime;
+	private long _stoptime = Long.MAX_VALUE;
+	public Task()
+	{
+		_startTime = System.currentTimeMillis();
+	}
+	public void Finished()
+	{
+		if (_stoptime == Long.MAX_VALUE)
+			_stoptime = System.currentTimeMillis();
+	}
+	public long Elapsed()
+	{
+		return (_stoptime - _startTime);
+	};
+}

Added: spoofax-ace/trunk/spoofax-ace/resources/java/finished_task_0_1.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/java/finished_task_0_1.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,18 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+public class finished_task_0_1 extends Strategy {
+
+	public static finished_task_0_1 instance = new finished_task_0_1();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current,
+			IStrategoTerm test) {
+		StatsCollector.FinishedTask(test.toString());
+		ITermFactory factory = context.getFactory();
+		return factory.makeString("ok");
+	}
+
+}

Added: spoofax-ace/trunk/spoofax-ace/resources/java/record_current_heap_size_0_4.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/java/record_current_heap_size_0_4.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,16 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+public class record_current_heap_size_0_4 extends Strategy {
+
+	public static record_current_heap_size_0_4 instance = new record_current_heap_size_0_4();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current,	IStrategoTerm task, IStrategoTerm langname, IStrategoTerm metricname, IStrategoTerm metricvalue) {
+		StatsCollector.RecordMemorySize(task.toString(), langname.toString(), metricname.toString(), metricvalue.toString());
+		ITermFactory factory = context.getFactory();
+		return factory.makeString("ok");
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/resources/java/record_task_0_4.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/java/record_task_0_4.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,18 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+public class record_task_0_4 extends Strategy {
+
+	public static record_task_0_4 instance = new record_task_0_4();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current,	IStrategoTerm task, IStrategoTerm langname, IStrategoTerm metricname, IStrategoTerm metricvalue) {
+		StatsCollector.RecordElapsed(task.toString(), langname.toString(), metricname.toString(), metricvalue.toString());
+		ITermFactory factory = context.getFactory();
+		return factory.makeString("ok");
+	}
+
+}
+

Added: spoofax-ace/trunk/spoofax-ace/resources/java/start_task_0_1.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/java/start_task_0_1.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,18 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+public class start_task_0_1 extends Strategy {
+
+	public static start_task_0_1 instance = new start_task_0_1();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current,
+			IStrategoTerm test) {
+		StatsCollector.StartTask(test.toString());
+		ITermFactory factory = context.getFactory();
+		return factory.makeString("ok");
+	}
+
+}

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-append.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,1109 @@
+
+}
+).call(SpoofaxToAceWorker.prototype);
+});
+
+define('ace/worker/mirror', ['require', 'exports', 'module' , 'ace/document', 'ace/lib/lang'], function(require, exports, module) {
+    
+var Document = require("../document").Document;
+var lang = require("../lib/lang");
+    
+var Mirror = exports.Mirror = function(sender) {
+    this.sender = sender;
+    var doc = this.doc = new Document("");
+    
+    var deferredUpdate = this.deferredUpdate = lang.deferredCall(this.onUpdate.bind(this));
+    
+    var _self = this;
+    sender.on("change", function(e) {
+        doc.applyDeltas([e.data]);        
+        deferredUpdate.schedule(_self.$timeout);
+    });
+};
+
+(function() {
+    
+    this.$timeout = 500;
+    
+    this.setTimeout = function(timeout) {
+        this.$timeout = timeout;
+    };
+    
+    this.setValue = function(value) {
+        this.doc.setValue(value);
+        this.deferredUpdate.schedule(this.$timeout);
+    };
+    
+    this.getValue = function(callbackId) {
+        this.sender.callback(this.doc.getValue(), callbackId);
+    };
+    
+    this.onUpdate = function() {
+        // abstract method
+    };
+    
+}).call(Mirror.prototype);
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/document', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/event_emitter', 'ace/range', 'ace/anchor'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+var Range = require("./range").Range;
+var Anchor = require("./anchor").Anchor;
+
+var Document = function(text) {
+    this.$lines = [];
+
+    if (Array.isArray(text)) {
+        this.insertLines(0, text);
+    }
+    // There has to be one line at least in the document. If you pass an empty
+    // string to the insert function, nothing will happen. Workaround.
+    else if (text.length == 0) {
+        this.$lines = [""];
+    } else {
+        this.insert({row: 0, column:0}, text);
+    }
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+
+    this.setValue = function(text) {
+        var len = this.getLength();
+        this.remove(new Range(0, 0, len, this.getLine(len-1).length));
+        this.insert({row: 0, column:0}, text);
+    };
+
+    this.getValue = function() {
+        return this.getAllLines().join(this.getNewLineCharacter());
+    };
+
+    this.createAnchor = function(row, column) {
+        return new Anchor(this, row, column);
+    };
+
+    // check for IE split bug
+    if ("aaa".split(/a/).length == 0)
+        this.$split = function(text) {
+            return text.replace(/\r\n|\r/g, "\n").split("\n");
+        }
+    else
+        this.$split = function(text) {
+            return text.split(/\r\n|\r|\n/);
+        };
+
+
+    this.$detectNewLine = function(text) {
+        var match = text.match(/^.*?(\r\n|\r|\n)/m);
+        if (match) {
+            this.$autoNewLine = match[1];
+        } else {
+            this.$autoNewLine = "\n";
+        }
+    };
+
+    this.getNewLineCharacter = function() {
+      switch (this.$newLineMode) {
+          case "windows":
+              return "\r\n";
+
+          case "unix":
+              return "\n";
+
+          case "auto":
+              return this.$autoNewLine;
+      }
+    };
+
+    this.$autoNewLine = "\n";
+    this.$newLineMode = "auto";
+    this.setNewLineMode = function(newLineMode) {
+        if (this.$newLineMode === newLineMode)
+            return;
+
+        this.$newLineMode = newLineMode;
+    };
+
+    this.getNewLineMode = function() {
+        return this.$newLineMode;
+    };
+
+    this.isNewLine = function(text) {
+        return (text == "\r\n" || text == "\r" || text == "\n");
+    };
+
+    /**
+     * Get a verbatim copy of the given line as it is in the document
+     */
+    this.getLine = function(row) {
+        return this.$lines[row] || "";
+    };
+
+    this.getLines = function(firstRow, lastRow) {
+        return this.$lines.slice(firstRow, lastRow + 1);
+    };
+
+    /**
+     * Returns all lines in the document as string array. Warning: The caller
+     * should not modify this array!
+     */
+    this.getAllLines = function() {
+        return this.getLines(0, this.getLength());
+    };
+
+    this.getLength = function() {
+        return this.$lines.length;
+    };
+
+    this.getTextRange = function(range) {
+        if (range.start.row == range.end.row) {
+            return this.$lines[range.start.row].substring(range.start.column,
+                                                         range.end.column);
+        }
+        else {
+            var lines = [];
+            lines.push(this.$lines[range.start.row].substring(range.start.column));
+            lines.push.apply(lines, this.getLines(range.start.row+1, range.end.row-1));
+            lines.push(this.$lines[range.end.row].substring(0, range.end.column));
+            return lines.join(this.getNewLineCharacter());
+        }
+    };
+
+    this.$clipPosition = function(position) {
+        var length = this.getLength();
+        if (position.row >= length) {
+            position.row = Math.max(0, length - 1);
+            position.column = this.getLine(length-1).length;
+        }
+        return position;
+    };
+
+    this.insert = function(position, text) {
+        if (text.length == 0)
+            return position;
+
+        position = this.$clipPosition(position);
+
+        if (this.getLength() <= 1)
+            this.$detectNewLine(text);
+
+        var lines = this.$split(text);
+        var firstLine = lines.splice(0, 1)[0];
+        var lastLine = lines.length == 0 ? null : lines.splice(lines.length - 1, 1)[0];
+
+        position = this.insertInLine(position, firstLine);
+        if (lastLine !== null) {
+            position = this.insertNewLine(position); // terminate first line
+            position = this.insertLines(position.row, lines);
+            position = this.insertInLine(position, lastLine || "");
+        }
+        return position;
+    };
+
+    this.insertLines = function(row, lines) {
+        if (lines.length == 0)
+            return {row: row, column: 0};
+
+        var args = [row, 0];
+        args.push.apply(args, lines);
+        this.$lines.splice.apply(this.$lines, args);
+
+        var range = new Range(row, 0, row + lines.length, 0);
+        var delta = {
+            action: "insertLines",
+            range: range,
+            lines: lines
+        };
+        this._dispatchEvent("change", { data: delta });
+        return range.end;
+    };
+
+    this.insertNewLine = function(position) {
+        position = this.$clipPosition(position);
+        var line = this.$lines[position.row] || "";
+
+        this.$lines[position.row] = line.substring(0, position.column);
+        this.$lines.splice(position.row + 1, 0, line.substring(position.column, line.length));
+
+        var end = {
+            row : position.row + 1,
+            column : 0
+        };
+
+        var delta = {
+            action: "insertText",
+            range: Range.fromPoints(position, end),
+            text: this.getNewLineCharacter()
+        };
+        this._dispatchEvent("change", { data: delta });
+
+        return end;
+    };
+
+    this.insertInLine = function(position, text) {
+        if (text.length == 0)
+            return position;
+
+        var line = this.$lines[position.row] || "";
+
+        this.$lines[position.row] = line.substring(0, position.column) + text
+                + line.substring(position.column);
+
+        var end = {
+            row : position.row,
+            column : position.column + text.length
+        };
+
+        var delta = {
+            action: "insertText",
+            range: Range.fromPoints(position, end),
+            text: text
+        };
+        this._dispatchEvent("change", { data: delta });
+
+        return end;
+    };
+
+    this.remove = function(range) {
+        // clip to document
+        range.start = this.$clipPosition(range.start);
+        range.end = this.$clipPosition(range.end);
+
+        if (range.isEmpty())
+            return range.start;
+
+        var firstRow = range.start.row;
+        var lastRow = range.end.row;
+
+        if (range.isMultiLine()) {
+            var firstFullRow = range.start.column == 0 ? firstRow : firstRow + 1;
+            var lastFullRow = lastRow - 1;
+
+            if (range.end.column > 0)
+                this.removeInLine(lastRow, 0, range.end.column);
+
+            if (lastFullRow >= firstFullRow)
+                this.removeLines(firstFullRow, lastFullRow);
+
+            if (firstFullRow != firstRow) {
+                this.removeInLine(firstRow, range.start.column, this.getLine(firstRow).length);
+                this.removeNewLine(range.start.row);
+            }
+        }
+        else {
+            this.removeInLine(firstRow, range.start.column, range.end.column);
+        }
+        return range.start;
+    };
+
+    this.removeInLine = function(row, startColumn, endColumn) {
+        if (startColumn == endColumn)
+            return;
+
+        var range = new Range(row, startColumn, row, endColumn);
+        var line = this.getLine(row);
+        var removed = line.substring(startColumn, endColumn);
+        var newLine = line.substring(0, startColumn) + line.substring(endColumn, line.length);
+        this.$lines.splice(row, 1, newLine);
+
+        var delta = {
+            action: "removeText",
+            range: range,
+            text: removed
+        };
+        this._dispatchEvent("change", { data: delta });
+        return range.start;
+    };
+
+    /**
+     * Removes a range of full lines
+     *
+     * @param firstRow {Integer} The first row to be removed
+     * @param lastRow {Integer} The last row to be removed
+     * @return {String[]} The removed lines
+     */
+    this.removeLines = function(firstRow, lastRow) {
+        var range = new Range(firstRow, 0, lastRow + 1, 0);
+        var removed = this.$lines.splice(firstRow, lastRow - firstRow + 1);
+
+        var delta = {
+            action: "removeLines",
+            range: range,
+            nl: this.getNewLineCharacter(),
+            lines: removed
+        };
+        this._dispatchEvent("change", { data: delta });
+        return removed;
+    };
+
+    this.removeNewLine = function(row) {
+        var firstLine = this.getLine(row);
+        var secondLine = this.getLine(row+1);
+
+        var range = new Range(row, firstLine.length, row+1, 0);
+        var line = firstLine + secondLine;
+
+        this.$lines.splice(row, 2, line);
+
+        var delta = {
+            action: "removeText",
+            range: range,
+            text: this.getNewLineCharacter()
+        };
+        this._dispatchEvent("change", { data: delta });
+    };
+
+    this.replace = function(range, text) {
+        if (text.length == 0 && range.isEmpty())
+            return range.start;
+
+        // Shortcut: If the text we want to insert is the same as it is already
+        // in the document, we don't have to replace anything.
+        if (text == this.getTextRange(range))
+            return range.end;
+
+        this.remove(range);
+        if (text) {
+            var end = this.insert(range.start, text);
+        }
+        else {
+            end = range.start;
+        }
+
+        return end;
+    };
+
+    this.applyDeltas = function(deltas) {
+        for (var i=0; i<deltas.length; i++) {
+            var delta = deltas[i];
+            var range = Range.fromPoints(delta.range.start, delta.range.end);
+
+            if (delta.action == "insertLines")
+                this.insertLines(range.start.row, delta.lines);
+            else if (delta.action == "insertText")
+                this.insert(range.start, delta.text);
+            else if (delta.action == "removeLines")
+                this.removeLines(range.start.row, range.end.row - 1);
+            else if (delta.action == "removeText")
+                this.remove(range);
+        }
+    };
+
+    this.revertDeltas = function(deltas) {
+        for (var i=deltas.length-1; i>=0; i--) {
+            var delta = deltas[i];
+
+            var range = Range.fromPoints(delta.range.start, delta.range.end);
+
+            if (delta.action == "insertLines")
+                this.removeLines(range.start.row, range.end.row - 1);
+            else if (delta.action == "insertText")
+                this.remove(range);
+            else if (delta.action == "removeLines")
+                this.insertLines(range.start.row, delta.lines);
+            else if (delta.action == "removeText")
+                this.insert(range.start, delta.text);
+        }
+    };
+
+}).call(Document.prototype);
+
+exports.Document = Document;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/range', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var Range = function(startRow, startColumn, endRow, endColumn) {
+    this.start = {
+        row: startRow,
+        column: startColumn
+    };
+
+    this.end = {
+        row: endRow,
+        column: endColumn
+    };
+};
+
+(function() {
+    this.isEequal = function(range) {
+        return this.start.row == range.start.row &&
+            this.end.row == range.end.row &&
+            this.start.column == range.start.column &&
+            this.end.column == range.end.column
+    };
+
+    this.toString = function() {
+        return ("Range: [" + this.start.row + "/" + this.start.column +
+            "] -> [" + this.end.row + "/" + this.end.column + "]");
+    };
+
+    this.contains = function(row, column) {
+        return this.compare(row, column) == 0;
+    };
+
+    /**
+     * Compares this range (A) with another range (B), where B is the passed in
+     * range.
+     *
+     * Return values:
+     *  -2: (B) is infront of (A) and doesn't intersect with (A)
+     *  -1: (B) begins before (A) but ends inside of (A)
+     *   0: (B) is completly inside of (A) OR (A) is complety inside of (B)
+     *  +1: (B) begins inside of (A) but ends outside of (A)
+     *  +2: (B) is after (A) and doesn't intersect with (A)
+     *
+     *  42: FTW state: (B) ends in (A) but starts outside of (A)
+     */
+    this.compareRange = function(range) {
+        var cmp,
+            end = range.end,
+            start = range.start;
+
+        cmp = this.compare(end.row, end.column);
+        if (cmp == 1) {
+            cmp = this.compare(start.row, start.column);
+            if (cmp == 1) {
+                return 2;
+            } else if (cmp == 0) {
+                return 1;
+            } else {
+                return 0;
+            }
+        } else if (cmp == -1) {
+            return -2;
+        } else {
+            cmp = this.compare(start.row, start.column);
+            if (cmp == -1) {
+                return -1;
+            } else if (cmp == 1) {
+                return 42;
+            } else {
+                return 0;
+            }
+        }
+    }
+
+    this.comparePoint = function(p) {
+        return this.compare(p.row, p.column);
+    }
+
+    this.containsRange = function(range) {
+        return this.comparePoint(range.start) == 0 && this.comparePoint(range.end) == 0;
+    }
+
+    this.isEnd = function(row, column) {
+        return this.end.row == row && this.end.column == column;
+    }
+
+    this.isStart = function(row, column) {
+        return this.start.row == row && this.start.column == column;
+    }
+
+    this.setStart = function(row, column) {
+        if (typeof row == "object") {
+            this.start.column = row.column;
+            this.start.row = row.row;
+        } else {
+            this.start.row = row;
+            this.start.column = column;
+        }
+    }
+
+    this.setEnd = function(row, column) {
+        if (typeof row == "object") {
+            this.end.column = row.column;
+            this.end.row = row.row;
+        } else {
+            this.end.row = row;
+            this.end.column = column;
+        }
+    }
+
+    this.inside = function(row, column) {
+        if (this.compare(row, column) == 0) {
+            if (this.isEnd(row, column) || this.isStart(row, column)) {
+                return false;
+            } else {
+                return true;
+            }
+        }
+        return false;
+    }
+
+    this.insideStart = function(row, column) {
+        if (this.compare(row, column) == 0) {
+            if (this.isEnd(row, column)) {
+                return false;
+            } else {
+                return true;
+            }
+        }
+        return false;
+    }
+
+    this.insideEnd = function(row, column) {
+        if (this.compare(row, column) == 0) {
+            if (this.isStart(row, column)) {
+                return false;
+            } else {
+                return true;
+            }
+        }
+        return false;
+    }
+
+    this.compare = function(row, column) {
+        if (!this.isMultiLine()) {
+            if (row === this.start.row) {
+                return column < this.start.column ? -1 : (column > this.end.column ? 1 : 0);
+            };
+        }
+
+        if (row < this.start.row)
+            return -1;
+
+        if (row > this.end.row)
+            return 1;
+
+        if (this.start.row === row)
+            return column >= this.start.column ? 0 : -1;
+
+        if (this.end.row === row)
+            return column <= this.end.column ? 0 : 1;
+
+        return 0;
+    };
+
+    /**
+     * Like .compare(), but if isStart is true, return -1;
+     */
+    this.compareStart = function(row, column) {
+        if (this.start.row == row && this.start.column == column) {
+            return -1;
+        } else {
+            return this.compare(row, column);
+        }
+    }
+
+    /**
+     * Like .compare(), but if isEnd is true, return 1;
+     */
+    this.compareEnd = function(row, column) {
+        if (this.end.row == row && this.end.column == column) {
+            return 1;
+        } else {
+            return this.compare(row, column);
+        }
+    }
+
+    this.compareInside = function(row, column) {
+        if (this.end.row == row && this.end.column == column) {
+            return 1;
+        } else if (this.start.row == row && this.start.column == column) {
+            return -1;
+        } else {
+            return this.compare(row, column);
+        }
+    }
+
+    this.clipRows = function(firstRow, lastRow) {
+        if (this.end.row > lastRow) {
+            var end = {
+                row: lastRow+1,
+                column: 0
+            };
+        }
+
+        if (this.start.row > lastRow) {
+            var start = {
+                row: lastRow+1,
+                column: 0
+            };
+        }
+
+        if (this.start.row < firstRow) {
+            var start = {
+                row: firstRow,
+                column: 0
+            };
+        }
+
+        if (this.end.row < firstRow) {
+            var end = {
+                row: firstRow,
+                column: 0
+            };
+        }
+        return Range.fromPoints(start || this.start, end || this.end);
+    };
+
+    this.extend = function(row, column) {
+        var cmp = this.compare(row, column);
+
+        if (cmp == 0)
+            return this;
+        else if (cmp == -1)
+            var start = {row: row, column: column};
+        else
+            var end = {row: row, column: column};
+
+        return Range.fromPoints(start || this.start, end || this.end);
+    };
+
+    this.isEmpty = function() {
+        return (this.start.row == this.end.row && this.start.column == this.end.column);
+    };
+
+    this.isMultiLine = function() {
+        return (this.start.row !== this.end.row);
+    };
+
+    this.clone = function() {
+        return Range.fromPoints(this.start, this.end);
+    };
+
+    this.collapseRows = function() {
+        if (this.end.column == 0)
+            return new Range(this.start.row, 0, Math.max(this.start.row, this.end.row-1), 0)
+        else
+            return new Range(this.start.row, 0, this.end.row, 0)
+    };
+
+    this.toScreenRange = function(session) {
+        var screenPosStart =
+            session.documentToScreenPosition(this.start);
+        var screenPosEnd =
+            session.documentToScreenPosition(this.end);
+
+        return new Range(
+            screenPosStart.row, screenPosStart.column,
+            screenPosEnd.row, screenPosEnd.column
+        );
+    };
+
+}).call(Range.prototype);
+
+
+Range.fromPoints = function(start, end) {
+    return new Range(start.row, start.column, end.row, end.column);
+};
+
+exports.Range = Range;
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/anchor', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/lib/event_emitter'], function(require, exports, module) {
+
+var oop = require("./lib/oop");
+var EventEmitter = require("./lib/event_emitter").EventEmitter;
+
+/**
+ * An Anchor is a floating pointer in the document. Whenever text is inserted or
+ * deleted before the cursor, the position of the cursor is updated
+ */
+var Anchor = exports.Anchor = function(doc, row, column) {
+    this.document = doc;
+    
+    if (typeof column == "undefined")
+        this.setPosition(row.row, row.column);
+    else
+        this.setPosition(row, column);
+
+    this.$onChange = this.onChange.bind(this);
+    doc.on("change", this.$onChange);
+};
+
+(function() {
+
+    oop.implement(this, EventEmitter);
+    
+    this.getPosition = function() {
+        return this.$clipPositionToDocument(this.row, this.column);
+    };
+    
+    this.getDocument = function() {
+        return this.document;
+    };
+    
+    this.onChange = function(e) {
+        var delta = e.data;
+        var range = delta.range;
+            
+        if (range.start.row == range.end.row && range.start.row != this.row)
+            return;
+            
+        if (range.start.row > this.row)
+            return;
+            
+        if (range.start.row == this.row && range.start.column > this.column)
+            return;
+    
+        var row = this.row;
+        var column = this.column;
+        
+        if (delta.action === "insertText") {
+            if (range.start.row === row && range.start.column <= column) {
+                if (range.start.row === range.end.row) {
+                    column += range.end.column - range.start.column;
+                }
+                else {
+                    column -= range.start.column;
+                    row += range.end.row - range.start.row;
+                }
+            }
+            else if (range.start.row !== range.end.row && range.start.row < row) {
+                row += range.end.row - range.start.row;
+            }
+        } else if (delta.action === "insertLines") {
+            if (range.start.row <= row) {
+                row += range.end.row - range.start.row;
+            }
+        }
+        else if (delta.action == "removeText") {
+            if (range.start.row == row && range.start.column < column) {
+                if (range.end.column >= column)
+                    column = range.start.column;
+                else
+                    column = Math.max(0, column - (range.end.column - range.start.column));
+                
+            } else if (range.start.row !== range.end.row && range.start.row < row) {
+                if (range.end.row == row) {
+                    column = Math.max(0, column - range.end.column) + range.start.column;
+                }
+                row -= (range.end.row - range.start.row);
+            }
+            else if (range.end.row == row) {
+                row -= range.end.row - range.start.row;
+                column = Math.max(0, column - range.end.column) + range.start.column;
+            }
+        } else if (delta.action == "removeLines") {
+            if (range.start.row <= row) {
+                if (range.end.row <= row)
+                    row -= range.end.row - range.start.row;
+                else {
+                    row = range.start.row;
+                    column = 0;
+                }
+            }
+        }
+
+        this.setPosition(row, column, true);
+    };
+
+    this.setPosition = function(row, column, noClip) {
+        var pos;
+        if (noClip) {
+            pos = {
+                row: row,
+                column: column
+            };
+        }
+        else {
+            pos = this.$clipPositionToDocument(row, column);
+        }
+        
+        if (this.row == pos.row && this.column == pos.column)
+            return;
+            
+        var old = {
+            row: this.row,
+            column: this.column
+        };
+        
+        this.row = pos.row;
+        this.column = pos.column;
+        this._dispatchEvent("change", {
+            old: old,
+            value: pos
+        });
+    };
+    
+    this.detach = function() {
+        this.document.removeEventListener("change", this.$onChange);
+    };
+    
+    this.$clipPositionToDocument = function(row, column) {
+        var pos = {};
+    
+        if (row >= this.document.getLength()) {
+            pos.row = Math.max(0, this.document.getLength() - 1);
+            pos.column = this.document.getLine(pos.row).length;
+        }
+        else if (row < 0) {
+            pos.row = 0;
+            pos.column = 0;
+        }
+        else {
+            pos.row = row;
+            pos.column = Math.min(this.document.getLine(pos.row).length, Math.max(0, column));
+        }
+        
+        if (column < 0)
+            pos.column = 0;
+            
+        return pos;
+    };
+    
+}).call(Anchor.prototype);
+
+});
+/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/lang', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+exports.stringReverse = function(string) {
+    return string.split("").reverse().join("");
+};
+
+exports.stringRepeat = function (string, count) {
+     return new Array(count + 1).join(string);
+};
+
+var trimBeginRegexp = /^\s\s*/;
+var trimEndRegexp = /\s\s*$/;
+
+exports.stringTrimLeft = function (string) {
+    return string.replace(trimBeginRegexp, '');
+};
+
+exports.stringTrimRight = function (string) {
+    return string.replace(trimEndRegexp, '');
+};
+
+exports.copyObject = function(obj) {
+    var copy = {};
+    for (var key in obj) {
+        copy[key] = obj[key];
+    }
+    return copy;
+};
+
+exports.copyArray = function(array){
+    var copy = [];
+    for (var i=0, l=array.length; i<l; i++) {
+        if (array[i] && typeof array[i] == "object")
+            copy[i] = this.copyObject( array[i] );
+        else 
+            copy[i] = array[i];
+    }
+    return copy;
+};
+
+exports.deepCopy = function (obj) {
+    if (typeof obj != "object") {
+        return obj;
+    }
+    
+    var copy = obj.constructor();
+    for (var key in obj) {
+        if (typeof obj[key] == "object") {
+            copy[key] = this.deepCopy(obj[key]);
+        } else {
+            copy[key] = obj[key];
+        }
+    }
+    return copy;
+};
+
+exports.arrayToMap = function(arr) {
+    var map = {};
+    for (var i=0; i<arr.length; i++) {
+        map[arr[i]] = 1;
+    }
+    return map;
+
+};
+
+/**
+ * splice out of 'array' anything that === 'value'
+ */
+exports.arrayRemove = function(array, value) {
+  for (var i = 0; i <= array.length; i++) {
+    if (value === array[i]) {
+      array.splice(i, 1);
+    }
+  }
+};
+
+exports.escapeRegExp = function(str) {
+    return str.replace(/([.*+?^${}()|[\]\/\\])/g, '\\$1');
+};
+
+exports.deferredCall = function(fcn) {
+
+    var timer = null;
+    var callback = function() {
+        timer = null;
+        fcn();
+    };
+
+    var deferred = function(timeout) {
+        deferred.cancel();
+        timer = setTimeout(callback, timeout || 0);
+        return deferred;
+    };
+
+    deferred.schedule = deferred;
+
+    deferred.call = function() {
+        this.cancel();
+        fcn();
+        return deferred;
+    };
+
+    deferred.cancel = function() {
+        clearTimeout(timer);
+        timer = null;
+        return deferred;
+    };
+
+    return deferred;
+};
+
+});

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,1535 @@
+var console = {
+    log: function(msg) {
+        postMessage({type: "log", data: msg});
+    }
+};
+var window = {
+    console: console
+};
+
+$self = {};
+
+var normalizeModule = function(parentId, moduleName) {
+    // normalize plugin requires
+    if (moduleName.indexOf("!") !== -1) {
+        var chunks = moduleName.split("!");
+        return normalizeModule(parentId, chunks[0]) + "!" + normalizeModule(parentId, chunks[1]);
+    }
+    // normalize relative requires
+    if (moduleName.charAt(0) == ".") {
+        var base = parentId.split("/").slice(0, -1).join("/");
+        var moduleName = base + "/" + moduleName;
+        
+        while(moduleName.indexOf(".") !== -1 && previous != moduleName) {
+            var previous = moduleName;
+            var moduleName = moduleName.replace(/\/\.\//, "/").replace(/[^\/]+\/\.\.\//, "");
+        }
+    }
+    
+    return moduleName;
+};
+
+var require = function(parentId, id) {
+    var id = normalizeModule(parentId, id);
+    
+    var module = require.modules[id];
+    if (module) {
+        if (!module.initialized) {
+            module.exports = module.factory().exports;
+            module.initialized = true;
+        }
+        return module.exports;
+    }
+    
+    var chunks = id.split("/");
+    chunks[0] = require.tlns[chunks[0]] || chunks[0];
+    path = chunks.join("/") + ".js";
+    
+    require.id = id;
+    importScripts(path);
+    return require(parentId, id);    
+};
+
+require.modules = {};
+require.tlns = {};
+
+var define = function(id, deps, factory) {
+    if (arguments.length == 2) {
+        factory = deps;
+    } else if (arguments.length == 1) {
+        factory = id;
+        id = require.id;
+    }
+
+    if (id.indexOf("text!") === 0) 
+        return;
+    
+    var req = function(deps, factory) {
+        return require(id, deps, factory);
+    }
+
+    require.modules[id] = {
+        factory: function() {
+            var module = {
+                exports: {}
+            };
+            var returnExports = factory(req, module.exports, module);
+            if (returnExports)
+                module.exports = returnExports;
+            return module;
+        }
+    };
+};
+
+function initBaseUrls(topLevelNamespaces) {
+    require.tlns = topLevelNamespaces;
+}
+
+function initSender() {
+
+    var EventEmitter = require(null, "ace/lib/event_emitter").EventEmitter;
+    var oop = require(null, "ace/lib/oop");
+    
+    var Sender = function() {};
+    
+    (function() {
+        
+        oop.implement(this, EventEmitter);
+                
+        this.callback = function(data, callbackId) {
+            postMessage({
+                type: "call",
+                id: callbackId,
+                data: data
+            });
+        };
+    
+        this.emit = function(name, data) {
+            postMessage({
+                type: "event",
+                name: name,
+                data: data
+            });
+        };
+        
+    }).call(Sender.prototype);
+    
+    return new Sender();
+}
+
+var main;
+var sender;
+
+onmessage = function(e) {
+    var msg = e.data;
+    if (msg.command) {
+        main[msg.command].apply(main, msg.args);
+    }
+    else if (msg.init) {        
+        initBaseUrls(msg.tlns);
+        require(null, "ace/lib/fixoldbrowsers");
+        sender = initSender();
+        var clazz = require(null, msg.module)[msg.classname];
+        main = new clazz(sender);
+    } 
+    else if (msg.event && sender) {
+        sender._dispatchEvent(msg.event, msg.data);
+    }
+};
+// vim:set ts=4 sts=4 sw=4 st:
+// -- kriskowal Kris Kowal Copyright (C) 2009-2010 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright(C) 2010 XXX No License Specified
+// -- fschaefer Florian Sch???fer Copyright (C) 2010 MIT License
+// -- Irakli Gozalishvili Copyright (C) 2010 MIT License
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/fixoldbrowsers', ['require', 'exports', 'module' , 'ace/lib/regexp', 'ace/lib/es5-shim'], function(require, exports, module) {
+
+require("./regexp");
+require("./es5-shim");
+
+});define('ace/lib/regexp', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+// Based on code from:
+//
+// XRegExp 1.5.0
+// (c) 2007-2010 Steven Levithan
+// MIT License
+// <http://xregexp.com>
+// Provides an augmented, extensible, cross-browser implementation of regular expressions,
+// including support for additional syntax, flags, and methods
+
+    //---------------------------------
+    //  Private variables
+    //---------------------------------
+
+    var real = {
+            exec: RegExp.prototype.exec,
+            test: RegExp.prototype.test,
+            match: String.prototype.match,
+            replace: String.prototype.replace,
+            split: String.prototype.split
+        },
+        compliantExecNpcg = real.exec.call(/()??/, "")[1] === undefined, // check `exec` handling of nonparticipating capturing groups
+        compliantLastIndexIncrement = function () {
+            var x = /^/g;
+            real.test.call(x, "");
+            return !x.lastIndex;
+        }();
+
+    //---------------------------------
+    //  Overriden native methods
+    //---------------------------------
+
+    // Adds named capture support (with backreferences returned as `result.name`), and fixes two
+    // cross-browser issues per ES3:
+    // - Captured values for nonparticipating capturing groups should be returned as `undefined`,
+    //   rather than the empty string.
+    // - `lastIndex` should not be incremented after zero-length matches.
+    RegExp.prototype.exec = function (str) {
+        var match = real.exec.apply(this, arguments),
+            name, r2;
+        if (match) {
+            // Fix browsers whose `exec` methods don't consistently return `undefined` for
+            // nonparticipating capturing groups
+            if (!compliantExecNpcg && match.length > 1 && indexOf(match, "") > -1) {
+                r2 = RegExp(this.source, real.replace.call(getNativeFlags(this), "g", ""));
+                // Using `str.slice(match.index)` rather than `match[0]` in case lookahead allowed
+                // matching due to characters outside the match
+                real.replace.call(str.slice(match.index), r2, function () {
+                    for (var i = 1; i < arguments.length - 2; i++) {
+                        if (arguments[i] === undefined)
+                            match[i] = undefined;
+                    }
+                });
+            }
+            // Attach named capture properties
+            if (this._xregexp && this._xregexp.captureNames) {
+                for (var i = 1; i < match.length; i++) {
+                    name = this._xregexp.captureNames[i - 1];
+                    if (name)
+                       match[name] = match[i];
+                }
+            }
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (!compliantLastIndexIncrement && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+        }
+        return match;
+    };
+
+    // Don't override `test` if it won't change anything
+    if (!compliantLastIndexIncrement) {
+        // Fix browser bug in native method
+        RegExp.prototype.test = function (str) {
+            // Use the native `exec` to skip some processing overhead, even though the overriden
+            // `exec` would take care of the `lastIndex` fix
+            var match = real.exec.call(this, str);
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (match && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+            return !!match;
+        };
+    }
+
+    //---------------------------------
+    //  Private helper functions
+    //---------------------------------
+
+    function getNativeFlags (regex) {
+        return (regex.global     ? "g" : "") +
+               (regex.ignoreCase ? "i" : "") +
+               (regex.multiline  ? "m" : "") +
+               (regex.extended   ? "x" : "") + // Proposed for ES4; included in AS3
+               (regex.sticky     ? "y" : "");
+    };
+
+    function indexOf (array, item, from) {
+        if (Array.prototype.indexOf) // Use the native array method if available
+            return array.indexOf(item, from);
+        for (var i = from || 0; i < array.length; i++) {
+            if (array[i] === item)
+                return i;
+        }
+        return -1;
+    };
+
+});// vim: ts=4 sts=4 sw=4 expandtab
+// -- kriskowal Kris Kowal Copyright (C) 2009-2011 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright (C) 2010 XXX TODO License or CLA
+// -- fschaefer Florian Sch???fer Copyright (C) 2010 MIT License
+// -- Gozala Irakli Gozalishvili Copyright (C) 2010 MIT License
+// -- kitcambridge Kit Cambridge Copyright (C) 2011 MIT License
+// -- kossnocorp Sasha Koss XXX TODO License or CLA
+// -- bryanforbes Bryan Forbes XXX TODO License or CLA
+// -- killdream Quildreen Motta Copyright (C) 2011 MIT Licence
+// -- michaelficarra Michael Ficarra Copyright (C) 2011 3-clause BSD License
+// -- sharkbrainguy Gerard Paapu Copyright (C) 2011 MIT License
+// -- bbqsrc Brendan Molloy (C) 2011 Creative Commons Zero (public domain)
+// -- iwyg XXX TODO License or CLA
+// -- DomenicDenicola Domenic Denicola Copyright (C) 2011 MIT License
+// -- xavierm02 Montillet Xavier XXX TODO License or CLA
+// -- Raynos Raynos XXX TODO License or CLA
+// -- samsonjs Sami Samhuri Copyright (C) 2010 MIT License
+// -- rwldrn Rick Waldron Copyright (C) 2011 MIT License
+// -- lexer Alexey Zakharov XXX TODO License or CLA
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/es5-shim', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+/**
+ * Brings an environment as close to ECMAScript 5 compliance
+ * as is possible with the facilities of erstwhile engines.
+ *
+ * Annotated ES5: http://es5.github.com/ (specific links below)
+ * ES5 Spec: http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf
+ *
+ * @module
+ */
+
+/*whatsupdoc*/
+
+//
+// Function
+// ========
+//
+
+// ES-5 15.3.4.5
+// http://es5.github.com/#x15.3.4.5
+
+if (!Function.prototype.bind) {
+    Function.prototype.bind = function bind(that) { // .length is 1
+        // 1. Let Target be the this value.
+        var target = this;
+        // 2. If IsCallable(Target) is false, throw a TypeError exception.
+        if (typeof target != "function")
+            throw new TypeError(); // TODO message
+        // 3. Let A be a new (possibly empty) internal list of all of the
+        //   argument values provided after thisArg (arg1, arg2 etc), in order.
+        // XXX slicedArgs will stand in for "A" if used
+        var args = slice.call(arguments, 1); // for normal call
+        // 4. Let F be a new native ECMAScript object.
+        // 11. Set the [[Prototype]] internal property of F to the standard
+        //   built-in Function prototype object as specified in 15.3.3.1.
+        // 12. Set the [[Call]] internal property of F as described in
+        //   15.3.4.5.1.
+        // 13. Set the [[Construct]] internal property of F as described in
+        //   15.3.4.5.2.
+        // 14. Set the [[HasInstance]] internal property of F as described in
+        //   15.3.4.5.3.
+        var bound = function () {
+
+            if (this instanceof bound) {
+                // 15.3.4.5.2 [[Construct]]
+                // When the [[Construct]] internal method of a function object,
+                // F that was created using the bind function is called with a
+                // list of arguments ExtraArgs, the following steps are taken:
+                // 1. Let target be the value of F's [[TargetFunction]]
+                //   internal property.
+                // 2. If target has no [[Construct]] internal method, a
+                //   TypeError exception is thrown.
+                // 3. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the
+                //   list boundArgs in the same order followed by the same
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Construct]] internal 
+                //   method of target providing args as the arguments.
+
+                var F = function(){};
+                F.prototype = target.prototype;
+                var self = new F;
+
+                var result = target.apply(
+                    self,
+                    args.concat(slice.call(arguments))
+                );
+                if (result !== null && Object(result) === result)
+                    return result;
+                return self;
+
+            } else {
+                // 15.3.4.5.1 [[Call]]
+                // When the [[Call]] internal method of a function object, F,
+                // which was created using the bind function is called with a
+                // this value and a list of arguments ExtraArgs, the following
+                // steps are taken:
+                // 1. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 2. Let boundThis be the value of F's [[BoundThis]] internal
+                //   property.
+                // 3. Let target be the value of F's [[TargetFunction]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the 
+                //   list boundArgs in the same order followed by the same 
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Call]] internal method 
+                //   of target providing boundThis as the this value and 
+                //   providing args as the arguments.
+
+                // equiv: target.call(this, ...boundArgs, ...args)
+                return target.apply(
+                    that,
+                    args.concat(slice.call(arguments))
+                );
+
+            }
+
+        };
+        // XXX bound.length is never writable, so don't even try
+        //
+        // 15. If the [[Class]] internal property of Target is "Function", then
+        //     a. Let L be the length property of Target minus the length of A.
+        //     b. Set the length own property of F to either 0 or L, whichever is 
+        //       larger.
+        // 16. Else set the length own property of F to 0.
+        // 17. Set the attributes of the length own property of F to the values
+        //   specified in 15.3.5.1.
+
+        // TODO
+        // 18. Set the [[Extensible]] internal property of F to true.
+        
+        // TODO
+        // 19. Let thrower be the [[ThrowTypeError]] function Object (13.2.3).
+        // 20. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "caller", PropertyDescriptor {[[Get]]: thrower, [[Set]]:
+        //   thrower, [[Enumerable]]: false, [[Configurable]]: false}, and 
+        //   false.
+        // 21. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "arguments", PropertyDescriptor {[[Get]]: thrower, 
+        //   [[Set]]: thrower, [[Enumerable]]: false, [[Configurable]]: false},
+        //   and false.
+
+        // TODO
+        // NOTE Function objects created using Function.prototype.bind do not 
+        // have a prototype property or the [[Code]], [[FormalParameters]], and
+        // [[Scope]] internal properties.
+        // XXX can't delete prototype in pure-js.
+
+        // 22. Return F.
+        return bound;
+    };
+}
+
+// Shortcut to an often accessed properties, in order to avoid multiple
+// dereference that costs universally.
+// _Please note: Shortcuts are defined after `Function.prototype.bind` as we
+// us it in defining shortcuts.
+var call = Function.prototype.call;
+var prototypeOfArray = Array.prototype;
+var prototypeOfObject = Object.prototype;
+var slice = prototypeOfArray.slice;
+var toString = call.bind(prototypeOfObject.toString);
+var owns = call.bind(prototypeOfObject.hasOwnProperty);
+
+// If JS engine supports accessors creating shortcuts.
+var defineGetter;
+var defineSetter;
+var lookupGetter;
+var lookupSetter;
+var supportsAccessors;
+if ((supportsAccessors = owns(prototypeOfObject, "__defineGetter__"))) {
+    defineGetter = call.bind(prototypeOfObject.__defineGetter__);
+    defineSetter = call.bind(prototypeOfObject.__defineSetter__);
+    lookupGetter = call.bind(prototypeOfObject.__lookupGetter__);
+    lookupSetter = call.bind(prototypeOfObject.__lookupSetter__);
+}
+
+//
+// Array
+// =====
+//
+
+// ES5 15.4.3.2
+// http://es5.github.com/#x15.4.3.2
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/isArray
+if (!Array.isArray) {
+    Array.isArray = function isArray(obj) {
+        return toString(obj) == "[object Array]";
+    };
+}
+
+// The IsCallable() check in the Array functions
+// has been replaced with a strict check on the
+// internal class of the object to trap cases where
+// the provided function was actually a regular
+// expression literal, which in V8 and
+// JavaScriptCore is a typeof "function".  Only in
+// V8 are regular expression literals permitted as
+// reduce parameters, so it is desirable in the
+// general case for the shim to match the more
+// strict and common behavior of rejecting regular
+// expressions.
+
+// ES5 15.4.4.18
+// http://es5.github.com/#x15.4.4.18
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/forEach
+if (!Array.prototype.forEach) {
+    Array.prototype.forEach = function forEach(fun /*, thisp*/) {
+        var self = toObject(this),
+            thisp = arguments[1],
+            i = 0,
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        while (i < length) {
+            if (i in self) {
+                // Invoke the callback function with call, passing arguments:
+                // context, property value, property key, thisArg object context
+                fun.call(thisp, self[i], i, self);
+            }
+            i++;
+        }
+    };
+}
+
+// ES5 15.4.4.19
+// http://es5.github.com/#x15.4.4.19
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/map
+if (!Array.prototype.map) {
+    Array.prototype.map = function map(fun /*, thisp*/) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = Array(length),
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self)
+                result[i] = fun.call(thisp, self[i], i, self);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.20
+// http://es5.github.com/#x15.4.4.20
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/filter
+if (!Array.prototype.filter) {
+    Array.prototype.filter = function filter(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = [],
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                result.push(self[i]);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.16
+// http://es5.github.com/#x15.4.4.16
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every
+if (!Array.prototype.every) {
+    Array.prototype.every = function every(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && !fun.call(thisp, self[i], i, self))
+                return false;
+        }
+        return true;
+    };
+}
+
+// ES5 15.4.4.17
+// http://es5.github.com/#x15.4.4.17
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/some
+if (!Array.prototype.some) {
+    Array.prototype.some = function some(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                return true;
+        }
+        return false;
+    };
+}
+
+// ES5 15.4.4.21
+// http://es5.github.com/#x15.4.4.21
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduce
+if (!Array.prototype.reduce) {
+    Array.prototype.reduce = function reduce(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value and an empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var i = 0;
+        var result;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i++];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (++i >= length)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        for (; i < length; i++) {
+            if (i in self)
+                result = fun.call(void 0, result, self[i], i, self);
+        }
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.22
+// http://es5.github.com/#x15.4.4.22
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduceRight
+if (!Array.prototype.reduceRight) {
+    Array.prototype.reduceRight = function reduceRight(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value, empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var result, i = length - 1;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i--];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (--i < 0)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        do {
+            if (i in this)
+                result = fun.call(void 0, result, self[i], i, self);
+        } while (i--);
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.14
+// http://es5.github.com/#x15.4.4.14
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/indexOf
+if (!Array.prototype.indexOf) {
+    Array.prototype.indexOf = function indexOf(sought /*, fromIndex */ ) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+
+        var i = 0;
+        if (arguments.length > 1)
+            i = toInteger(arguments[1]);
+
+        // handle negative indices
+        i = i >= 0 ? i : Math.max(0, length + i);
+        for (; i < length; i++) {
+            if (i in self && self[i] === sought) {
+                return i;
+            }
+        }
+        return -1;
+    };
+}
+
+// ES5 15.4.4.15
+// http://es5.github.com/#x15.4.4.15
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/lastIndexOf
+if (!Array.prototype.lastIndexOf) {
+    Array.prototype.lastIndexOf = function lastIndexOf(sought /*, fromIndex */) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+        var i = length - 1;
+        if (arguments.length > 1)
+            i = Math.min(i, toInteger(arguments[1]));
+        // handle negative indices
+        i = i >= 0 ? i : length - Math.abs(i);
+        for (; i >= 0; i--) {
+            if (i in self && sought === self[i])
+                return i;
+        }
+        return -1;
+    };
+}
+
+//
+// Object
+// ======
+//
+
+// ES5 15.2.3.2
+// http://es5.github.com/#x15.2.3.2
+if (!Object.getPrototypeOf) {
+    // https://github.com/kriskowal/es5-shim/issues#issue/2
+    // http://ejohn.org/blog/objectgetprototypeof/
+    // recommended by fschaefer on github
+    Object.getPrototypeOf = function getPrototypeOf(object) {
+        return object.__proto__ || (
+            object.constructor ?
+            object.constructor.prototype :
+            prototypeOfObject
+        );
+    };
+}
+
+// ES5 15.2.3.3
+// http://es5.github.com/#x15.2.3.3
+if (!Object.getOwnPropertyDescriptor) {
+    var ERR_NON_OBJECT = "Object.getOwnPropertyDescriptor called on a " +
+                         "non-object: ";
+    Object.getOwnPropertyDescriptor = function getOwnPropertyDescriptor(object, property) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT + object);
+        // If object does not owns property return undefined immediately.
+        if (!owns(object, property))
+            return;
+
+        var descriptor, getter, setter;
+
+        // If object has a property then it's for sure both `enumerable` and
+        // `configurable`.
+        descriptor =  { enumerable: true, configurable: true };
+
+        // If JS engine supports accessor properties then property may be a
+        // getter or setter.
+        if (supportsAccessors) {
+            // Unfortunately `__lookupGetter__` will return a getter even
+            // if object has own non getter property along with a same named
+            // inherited getter. To avoid misbehavior we temporary remove
+            // `__proto__` so that `__lookupGetter__` will return getter only
+            // if it's owned by an object.
+            var prototype = object.__proto__;
+            object.__proto__ = prototypeOfObject;
+
+            var getter = lookupGetter(object, property);
+            var setter = lookupSetter(object, property);
+
+            // Once we have getter and setter we can put values back.
+            object.__proto__ = prototype;
+
+            if (getter || setter) {
+                if (getter) descriptor.get = getter;
+                if (setter) descriptor.set = setter;
+
+                // If it was accessor property we're done and return here
+                // in order to avoid adding `value` to the descriptor.
+                return descriptor;
+            }
+        }
+
+        // If we got this far we know that object has an own property that is
+        // not an accessor so we set it as a value and return descriptor.
+        descriptor.value = object[property];
+        return descriptor;
+    };
+}
+
+// ES5 15.2.3.4
+// http://es5.github.com/#x15.2.3.4
+if (!Object.getOwnPropertyNames) {
+    Object.getOwnPropertyNames = function getOwnPropertyNames(object) {
+        return Object.keys(object);
+    };
+}
+
+// ES5 15.2.3.5
+// http://es5.github.com/#x15.2.3.5
+if (!Object.create) {
+    Object.create = function create(prototype, properties) {
+        var object;
+        if (prototype === null) {
+            object = { "__proto__": null };
+        } else {
+            if (typeof prototype != "object")
+                throw new TypeError("typeof prototype["+(typeof prototype)+"] != 'object'");
+            var Type = function () {};
+            Type.prototype = prototype;
+            object = new Type();
+            // IE has no built-in implementation of `Object.getPrototypeOf`
+            // neither `__proto__`, but this manually setting `__proto__` will
+            // guarantee that `Object.getPrototypeOf` will work as expected with
+            // objects created using `Object.create`
+            object.__proto__ = prototype;
+        }
+        if (properties !== void 0)
+            Object.defineProperties(object, properties);
+        return object;
+    };
+}
+
+// ES5 15.2.3.6
+// http://es5.github.com/#x15.2.3.6
+
+// Patch for WebKit and IE8 standard mode
+// Designed by hax <hax.github.com>
+// related issue: https://github.com/kriskowal/es5-shim/issues#issue/5
+// IE8 Reference:
+//     http://msdn.microsoft.com/en-us/library/dd282900.aspx
+//     http://msdn.microsoft.com/en-us/library/dd229916.aspx
+// WebKit Bugs:
+//     https://bugs.webkit.org/show_bug.cgi?id=36423
+
+function doesDefinePropertyWork(object) {
+    try {
+        Object.defineProperty(object, "sentinel", {});
+        return "sentinel" in object;
+    } catch (exception) {
+        // returns falsy
+    }
+}
+
+// check whether defineProperty works if it's given. Otherwise,
+// shim partially.
+if (Object.defineProperty) {
+    var definePropertyWorksOnObject = doesDefinePropertyWork({});
+    var definePropertyWorksOnDom = typeof document == "undefined" ||
+        doesDefinePropertyWork(document.createElement("div"));
+    if (!definePropertyWorksOnObject || !definePropertyWorksOnDom) {
+        var definePropertyFallback = Object.defineProperty;
+    }
+}
+
+if (!Object.defineProperty || definePropertyFallback) {
+    var ERR_NON_OBJECT_DESCRIPTOR = "Property description must be an object: ";
+    var ERR_NON_OBJECT_TARGET = "Object.defineProperty called on non-object: "
+    var ERR_ACCESSORS_NOT_SUPPORTED = "getters & setters can not be defined " +
+                                      "on this javascript engine";
+
+    Object.defineProperty = function defineProperty(object, property, descriptor) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT_TARGET + object);
+        if ((typeof descriptor != "object" && typeof descriptor != "function") || descriptor === null)
+            throw new TypeError(ERR_NON_OBJECT_DESCRIPTOR + descriptor);
+
+        // make a valiant attempt to use the real defineProperty
+        // for I8's DOM elements.
+        if (definePropertyFallback) {
+            try {
+                return definePropertyFallback.call(Object, object, property, descriptor);
+            } catch (exception) {
+                // try the shim if the real one doesn't work
+            }
+        }
+
+        // If it's a data property.
+        if (owns(descriptor, "value")) {
+            // fail silently if "writable", "enumerable", or "configurable"
+            // are requested but not supported
+            /*
+            // alternate approach:
+            if ( // can't implement these features; allow false but not true
+                !(owns(descriptor, "writable") ? descriptor.writable : true) ||
+                !(owns(descriptor, "enumerable") ? descriptor.enumerable : true) ||
+                !(owns(descriptor, "configurable") ? descriptor.configurable : true)
+            )
+                throw new RangeError(
+                    "This implementation of Object.defineProperty does not " +
+                    "support configurable, enumerable, or writable."
+                );
+            */
+
+            if (supportsAccessors && (lookupGetter(object, property) ||
+                                      lookupSetter(object, property)))
+            {
+                // As accessors are supported only on engines implementing
+                // `__proto__` we can safely override `__proto__` while defining
+                // a property to make sure that we don't hit an inherited
+                // accessor.
+                var prototype = object.__proto__;
+                object.__proto__ = prototypeOfObject;
+                // Deleting a property anyway since getter / setter may be
+                // defined on object itself.
+                delete object[property];
+                object[property] = descriptor.value;
+                // Setting original `__proto__` back now.
+                object.__proto__ = prototype;
+            } else {
+                object[property] = descriptor.value;
+            }
+        } else {
+            if (!supportsAccessors)
+                throw new TypeError(ERR_ACCESSORS_NOT_SUPPORTED);
+            // If we got that far then getters and setters can be defined !!
+            if (owns(descriptor, "get"))
+                defineGetter(object, property, descriptor.get);
+            if (owns(descriptor, "set"))
+                defineSetter(object, property, descriptor.set);
+        }
+
+        return object;
+    };
+}
+
+// ES5 15.2.3.7
+// http://es5.github.com/#x15.2.3.7
+if (!Object.defineProperties) {
+    Object.defineProperties = function defineProperties(object, properties) {
+        for (var property in properties) {
+            if (owns(properties, property))
+                Object.defineProperty(object, property, properties[property]);
+        }
+        return object;
+    };
+}
+
+// ES5 15.2.3.8
+// http://es5.github.com/#x15.2.3.8
+if (!Object.seal) {
+    Object.seal = function seal(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.9
+// http://es5.github.com/#x15.2.3.9
+if (!Object.freeze) {
+    Object.freeze = function freeze(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// detect a Rhino bug and patch it
+try {
+    Object.freeze(function () {});
+} catch (exception) {
+    Object.freeze = (function freeze(freezeObject) {
+        return function freeze(object) {
+            if (typeof object == "function") {
+                return object;
+            } else {
+                return freezeObject(object);
+            }
+        };
+    })(Object.freeze);
+}
+
+// ES5 15.2.3.10
+// http://es5.github.com/#x15.2.3.10
+if (!Object.preventExtensions) {
+    Object.preventExtensions = function preventExtensions(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.11
+// http://es5.github.com/#x15.2.3.11
+if (!Object.isSealed) {
+    Object.isSealed = function isSealed(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.12
+// http://es5.github.com/#x15.2.3.12
+if (!Object.isFrozen) {
+    Object.isFrozen = function isFrozen(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.13
+// http://es5.github.com/#x15.2.3.13
+if (!Object.isExtensible) {
+    Object.isExtensible = function isExtensible(object) {
+        // 1. If Type(O) is not Object throw a TypeError exception.
+        if (Object(object) === object) {
+            throw new TypeError(); // TODO message
+        }
+        // 2. Return the Boolean value of the [[Extensible]] internal property of O.
+        var name = '';
+        while (owns(object, name)) {
+            name += '?';
+        }
+        object[name] = true;
+        var returnValue = owns(object, name);
+        delete object[name];
+        return returnValue;
+    };
+}
+
+// ES5 15.2.3.14
+// http://es5.github.com/#x15.2.3.14
+if (!Object.keys) {
+    // http://whattheheadsaid.com/2010/10/a-safer-object-keys-compatibility-implementation
+    var hasDontEnumBug = true,
+        dontEnums = [
+            "toString",
+            "toLocaleString",
+            "valueOf",
+            "hasOwnProperty",
+            "isPrototypeOf",
+            "propertyIsEnumerable",
+            "constructor"
+        ],
+        dontEnumsLength = dontEnums.length;
+
+    for (var key in {"toString": null})
+        hasDontEnumBug = false;
+
+    Object.keys = function keys(object) {
+
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError("Object.keys called on a non-object");
+
+        var keys = [];
+        for (var name in object) {
+            if (owns(object, name)) {
+                keys.push(name);
+            }
+        }
+
+        if (hasDontEnumBug) {
+            for (var i = 0, ii = dontEnumsLength; i < ii; i++) {
+                var dontEnum = dontEnums[i];
+                if (owns(object, dontEnum)) {
+                    keys.push(dontEnum);
+                }
+            }
+        }
+
+        return keys;
+    };
+
+}
+
+//
+// Date
+// ====
+//
+
+// ES5 15.9.5.43
+// http://es5.github.com/#x15.9.5.43
+// This function returns a String value represent the instance in time 
+// represented by this Date object. The format of the String is the Date Time 
+// string format defined in 15.9.1.15. All fields are present in the String. 
+// The time zone is always UTC, denoted by the suffix Z. If the time value of 
+// this object is not a finite Number a RangeError exception is thrown.
+if (!Date.prototype.toISOString || (new Date(-62198755200000).toISOString().indexOf('-000001') === -1)) {
+    Date.prototype.toISOString = function toISOString() {
+        var result, length, value, year;
+        if (!isFinite(this))
+            throw new RangeError;
+
+        // the date time string format is specified in 15.9.1.15.
+        result = [this.getUTCMonth() + 1, this.getUTCDate(),
+            this.getUTCHours(), this.getUTCMinutes(), this.getUTCSeconds()];
+        year = this.getUTCFullYear();
+        year = (year < 0 ? '-' : (year > 9999 ? '+' : '')) + ('00000' + Math.abs(year)).slice(0 <= year && year <= 9999 ? -4 : -6);
+
+        length = result.length;
+        while (length--) {
+            value = result[length];
+            // pad months, days, hours, minutes, and seconds to have two digits.
+            if (value < 10)
+                result[length] = "0" + value;
+        }
+        // pad milliseconds to have three digits.
+        return year + "-" + result.slice(0, 2).join("-") + "T" + result.slice(2).join(":") + "." +
+            ("000" + this.getUTCMilliseconds()).slice(-3) + "Z";
+    }
+}
+
+// ES5 15.9.4.4
+// http://es5.github.com/#x15.9.4.4
+if (!Date.now) {
+    Date.now = function now() {
+        return new Date().getTime();
+    };
+}
+
+// ES5 15.9.5.44
+// http://es5.github.com/#x15.9.5.44
+// This function provides a String representation of a Date object for use by 
+// JSON.stringify (15.12.3).
+if (!Date.prototype.toJSON) {
+    Date.prototype.toJSON = function toJSON(key) {
+        // When the toJSON method is called with argument key, the following 
+        // steps are taken:
+
+        // 1.  Let O be the result of calling ToObject, giving it the this
+        // value as its argument.
+        // 2. Let tv be ToPrimitive(O, hint Number).
+        // 3. If tv is a Number and is not finite, return null.
+        // XXX
+        // 4. Let toISO be the result of calling the [[Get]] internal method of
+        // O with argument "toISOString".
+        // 5. If IsCallable(toISO) is false, throw a TypeError exception.
+        if (typeof this.toISOString != "function")
+            throw new TypeError(); // TODO message
+        // 6. Return the result of calling the [[Call]] internal method of
+        //  toISO with O as the this value and an empty argument list.
+        return this.toISOString();
+
+        // NOTE 1 The argument is ignored.
+
+        // NOTE 2 The toJSON function is intentionally generic; it does not
+        // require that its this value be a Date object. Therefore, it can be
+        // transferred to other kinds of objects for use as a method. However,
+        // it does require that any such object have a toISOString method. An
+        // object is free to use the argument key to filter its
+        // stringification.
+    };
+}
+
+// ES5 15.9.4.2
+// http://es5.github.com/#x15.9.4.2
+// based on work shared by Daniel Friesen (dantman)
+// http://gist.github.com/303249
+if (Date.parse("+275760-09-13T00:00:00.000Z") !== 8.64e15) {
+    // XXX global assignment won't work in embeddings that use
+    // an alternate object for the context.
+    Date = (function(NativeDate) {
+
+        // Date.length === 7
+        var Date = function Date(Y, M, D, h, m, s, ms) {
+            var length = arguments.length;
+            if (this instanceof NativeDate) {
+                var date = length == 1 && String(Y) === Y ? // isString(Y)
+                    // We explicitly pass it through parse:
+                    new NativeDate(Date.parse(Y)) :
+                    // We have to manually make calls depending on argument
+                    // length here
+                    length >= 7 ? new NativeDate(Y, M, D, h, m, s, ms) :
+                    length >= 6 ? new NativeDate(Y, M, D, h, m, s) :
+                    length >= 5 ? new NativeDate(Y, M, D, h, m) :
+                    length >= 4 ? new NativeDate(Y, M, D, h) :
+                    length >= 3 ? new NativeDate(Y, M, D) :
+                    length >= 2 ? new NativeDate(Y, M) :
+                    length >= 1 ? new NativeDate(Y) :
+                                  new NativeDate();
+                // Prevent mixups with unfixed Date object
+                date.constructor = Date;
+                return date;
+            }
+            return NativeDate.apply(this, arguments);
+        };
+
+        // 15.9.1.15 Date Time String Format.
+        var isoDateExpression = new RegExp("^" +
+            "(\\d{4}|[\+\-]\\d{6})" + // four-digit year capture or sign + 6-digit extended year
+            "(?:-(\\d{2})" + // optional month capture
+            "(?:-(\\d{2})" + // optional day capture
+            "(?:" + // capture hours:minutes:seconds.milliseconds
+                "T(\\d{2})" + // hours capture
+                ":(\\d{2})" + // minutes capture
+                "(?:" + // optional :seconds.milliseconds
+                    ":(\\d{2})" + // seconds capture
+                    "(?:\\.(\\d{3}))?" + // milliseconds capture
+                ")?" +
+            "(?:" + // capture UTC offset component
+                "Z|" + // UTC capture
+                "(?:" + // offset specifier +/-hours:minutes
+                    "([-+])" + // sign capture
+                    "(\\d{2})" + // hours offset capture
+                    ":(\\d{2})" + // minutes offset capture
+                ")" +
+            ")?)?)?)?" +
+        "$");
+
+        // Copy any custom methods a 3rd party library may have added
+        for (var key in NativeDate)
+            Date[key] = NativeDate[key];
+
+        // Copy "native" methods explicitly; they may be non-enumerable
+        Date.now = NativeDate.now;
+        Date.UTC = NativeDate.UTC;
+        Date.prototype = NativeDate.prototype;
+        Date.prototype.constructor = Date;
+
+        // Upgrade Date.parse to handle simplified ISO 8601 strings
+        Date.parse = function parse(string) {
+            var match = isoDateExpression.exec(string);
+            if (match) {
+                match.shift(); // kill match[0], the full match
+                // parse months, days, hours, minutes, seconds, and milliseconds
+                for (var i = 1; i < 7; i++) {
+                    // provide default values if necessary
+                    match[i] = +(match[i] || (i < 3 ? 1 : 0));
+                    // match[1] is the month. Months are 0-11 in JavaScript
+                    // `Date` objects, but 1-12 in ISO notation, so we
+                    // decrement.
+                    if (i == 1)
+                        match[i]--;
+                }
+
+                // parse the UTC offset component
+                var minuteOffset = +match.pop(), hourOffset = +match.pop(), sign = match.pop();
+
+                // compute the explicit time zone offset if specified
+                var offset = 0;
+                if (sign) {
+                    // detect invalid offsets and return early
+                    if (hourOffset > 23 || minuteOffset > 59)
+                        return NaN;
+
+                    // express the provided time zone offset in minutes. The offset is
+                    // negative for time zones west of UTC; positive otherwise.
+                    offset = (hourOffset * 60 + minuteOffset) * 6e4 * (sign == "+" ? -1 : 1);
+                }
+
+                // Date.UTC for years between 0 and 99 converts year to 1900 + year
+                // The Gregorian calendar has a 400-year cycle, so 
+                // to Date.UTC(year + 400, .... ) - 12622780800000 == Date.UTC(year, ...),
+                // where 12622780800000 - number of milliseconds in Gregorian calendar 400 years
+                var year = +match[0];
+                if (0 <= year && year <= 99) {
+                    match[0] = year + 400;
+                    return NativeDate.UTC.apply(this, match) + offset - 12622780800000;
+                }
+
+                // compute a new UTC date value, accounting for the optional offset
+                return NativeDate.UTC.apply(this, match) + offset;
+            }
+            return NativeDate.parse.apply(this, arguments);
+        };
+
+        return Date;
+    })(Date);
+}
+
+//
+// String
+// ======
+//
+
+// ES5 15.5.4.20
+// http://es5.github.com/#x15.5.4.20
+var ws = "\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003" +
+    "\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028" +
+    "\u2029\uFEFF";
+if (!String.prototype.trim || ws.trim()) {
+    // http://blog.stevenlevithan.com/archives/faster-trim-javascript
+    // http://perfectionkills.com/whitespace-deviations/
+    ws = "[" + ws + "]";
+    var trimBeginRegexp = new RegExp("^" + ws + ws + "*"),
+        trimEndRegexp = new RegExp(ws + ws + "*$");
+    String.prototype.trim = function trim() {
+        return String(this).replace(trimBeginRegexp, "").replace(trimEndRegexp, "");
+    };
+}
+
+//
+// Util
+// ======
+//
+
+// ES5 9.4
+// http://es5.github.com/#x9.4
+// http://jsperf.com/to-integer
+var toInteger = function (n) {
+    n = +n;
+    if (n !== n) // isNaN
+        n = 0;
+    else if (n !== 0 && n !== (1/0) && n !== -(1/0))
+        n = (n > 0 || -1) * Math.floor(Math.abs(n));
+    return n;
+};
+
+var prepareString = "a"[0] != "a",
+    // ES5 9.9
+    // http://es5.github.com/#x9.9
+    toObject = function (o) {
+        if (o == null) { // this matches both null and undefined
+            throw new TypeError(); // TODO message
+        }
+        // If the implementation doesn't support by-index access of
+        // string characters (ex. IE < 7), split the string
+        if (prepareString && typeof o == "string" && o) {
+            return o.split("");
+        }
+        return Object(o);
+    };
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Mike de Boer <mike AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/event_emitter', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var EventEmitter = {};
+
+EventEmitter._emit =
+EventEmitter._dispatchEvent = function(eventName, e) {
+    this._eventRegistry = this._eventRegistry || {};
+    this._defaultHandlers = this._defaultHandlers || {};
+
+    var listeners = this._eventRegistry[eventName] || [];
+    var defaultHandler = this._defaultHandlers[eventName];
+    if (!listeners.length && !defaultHandler)
+        return;
+
+    e = e || {};
+    e.type = eventName;
+    
+    if (!e.stopPropagation) {
+        e.stopPropagation = function() {
+            this.propagationStopped = true;
+        };
+    }
+    
+    if (!e.preventDefault) {
+        e.preventDefault = function() {
+            this.defaultPrevented = true;
+        };
+    }
+
+    for (var i=0; i<listeners.length; i++) {
+        listeners[i](e);
+        if (e.propagationStopped)
+            break;
+    }
+    
+    if (defaultHandler && !e.defaultPrevented)
+        defaultHandler(e);
+};
+
+EventEmitter.setDefaultHandler = function(eventName, callback) {
+    this._defaultHandlers = this._defaultHandlers || {};
+    
+    if (this._defaultHandlers[eventName])
+        throw new Error("The default handler for '" + eventName + "' is already set");
+        
+    this._defaultHandlers[eventName] = callback;
+};
+
+EventEmitter.on =
+EventEmitter.addEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        var listeners = this._eventRegistry[eventName] = [];
+
+    if (listeners.indexOf(callback) == -1)
+        listeners.push(callback);
+};
+
+EventEmitter.removeListener =
+EventEmitter.removeEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        return;
+
+    var index = listeners.indexOf(callback);
+    if (index !== -1)
+        listeners.splice(index, 1);
+};
+
+EventEmitter.removeAllListeners = function(eventName) {
+    if (this._eventRegistry) this._eventRegistry[eventName] = [];
+};
+
+exports.EventEmitter = EventEmitter;
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/oop', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+exports.inherits = (function() {
+    var tempCtor = function() {};
+    return function(ctor, superCtor) {
+        tempCtor.prototype = superCtor.prototype;
+        ctor.super_ = superCtor.prototype;
+        ctor.prototype = new tempCtor();
+        ctor.prototype.constructor = ctor;
+    }
+}());
+
+exports.mixin = function(obj, mixin) {
+    for (var key in mixin) {
+        obj[key] = mixin[key];
+    }
+};
+
+exports.implement = function(proto, mixin) {
+    exports.mixin(proto, mixin);
+};
+
+});
+
+
+define('ace/mode/spoofax2ace_worker', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/worker/mirror'], 
+function(require, exports, module) { 
+	var oop = require("ace/lib/oop"); 
+	var Mirror = require("ace/worker/mirror").Mirror; 
+
+	var working = false;
+	var goAgain = false;
+	var SpoofaxToAceWorker = exports.SpoofaxToAceWorker = function(sender) {
+	    $self.sender = sender;
+	    this.setTimeout(100);
+	    Mirror.call(this, sender);
+	};
+
+
+oop.inherits(SpoofaxToAceWorker, Mirror); (function() {
+
+
+        this.log = function(value) {
+            if(typeof(console) !== 'undefined' && console.log !== undefined) {
+                console.log(value);
+            } else {
+                sender.emit("log", value);
+            }
+        }
+	
+        this.load = function() {
+        }
+        
+		this.onUpdate = function()
+		{
+			this.delegateWork();
+		}
+
+
+        
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,1636 @@
+var console = {
+    log: function(msg) {
+        postMessage({type: "log", data: msg});
+    }
+};
+var window = {
+    console: console
+};
+
+var normalizeModule = function(parentId, moduleName) {
+    // normalize plugin requires
+    if (moduleName.indexOf("!") !== -1) {
+        var chunks = moduleName.split("!");
+        return normalizeModule(parentId, chunks[0]) + "!" + normalizeModule(parentId, chunks[1]);
+    }
+    // normalize relative requires
+    if (moduleName.charAt(0) == ".") {
+        var base = parentId.split("/").slice(0, -1).join("/");
+        var moduleName = base + "/" + moduleName;
+        
+        while(moduleName.indexOf(".") !== -1 && previous != moduleName) {
+            var previous = moduleName;
+            var moduleName = moduleName.replace(/\/\.\//, "/").replace(/[^\/]+\/\.\.\//, "");
+        }
+    }
+    
+    return moduleName;
+};
+
+var require = function(parentId, id) {
+    var id = normalizeModule(parentId, id);
+    
+    var module = require.modules[id];
+    if (module) {
+        if (!module.initialized) {
+            module.exports = module.factory().exports;
+            module.initialized = true;
+        }
+        return module.exports;
+    }
+    
+    var chunks = id.split("/");
+    chunks[0] = require.tlns[chunks[0]] || chunks[0];
+    path = chunks.join("/") + ".js";
+    
+    require.id = id;
+    importScripts(path);
+    return require(parentId, id);    
+};
+
+require.modules = {};
+require.tlns = {};
+
+var define = function(id, deps, factory) {
+    if (arguments.length == 2) {
+        factory = deps;
+    } else if (arguments.length == 1) {
+        factory = id;
+        id = require.id;
+    }
+
+    if (id.indexOf("text!") === 0) 
+        return;
+    
+    var req = function(deps, factory) {
+        return require(id, deps, factory);
+    }
+
+    require.modules[id] = {
+        factory: function() {
+            var module = {
+                exports: {}
+            };
+            var returnExports = factory(req, module.exports, module);
+            if (returnExports)
+                module.exports = returnExports;
+            return module;
+        }
+    };
+};
+
+function initBaseUrls(topLevelNamespaces) {
+    require.tlns = topLevelNamespaces;
+}
+
+function initSender() {
+
+    var EventEmitter = require(null, "ace/lib/event_emitter").EventEmitter;
+    var oop = require(null, "ace/lib/oop");
+    
+    var Sender = function() {};
+    
+    (function() {
+        
+        oop.implement(this, EventEmitter);
+                
+        this.callback = function(data, callbackId) {
+            postMessage({
+                type: "call",
+                id: callbackId,
+                data: data
+            });
+        };
+    
+        this.emit = function(name, data) {
+            postMessage({
+                type: "event",
+                name: name,
+                data: data
+            });
+        };
+        
+    }).call(Sender.prototype);
+    
+    return new Sender();
+}
+
+var main;
+var sender;
+
+onmessage = function(e) {
+    var msg = e.data;
+    if (msg.command) {
+        main[msg.command].apply(main, msg.args);
+    }
+    else if (msg.init) {        
+        initBaseUrls(msg.tlns);
+        require(null, "ace/lib/fixoldbrowsers");
+        sender = initSender();
+        var clazz = require(null, msg.module)[msg.classname];
+        main = new clazz(sender);
+    } 
+    else if (msg.event && sender) {
+        sender._dispatchEvent(msg.event, msg.data);
+    }
+};
+// vim:set ts=4 sts=4 sw=4 st:
+// -- kriskowal Kris Kowal Copyright (C) 2009-2010 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright(C) 2010 XXX No License Specified
+// -- fschaefer Florian Sch?fer Copyright (C) 2010 MIT License
+// -- Irakli Gozalishvili Copyright (C) 2010 MIT License
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/fixoldbrowsers', ['require', 'exports', 'module' , 'ace/lib/regexp', 'ace/lib/es5-shim'], function(require, exports, module) {
+
+require("./regexp");
+require("./es5-shim");
+
+});define('ace/lib/regexp', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+// Based on code from:
+//
+// XRegExp 1.5.0
+// (c) 2007-2010 Steven Levithan
+// MIT License
+// <http://xregexp.com>
+// Provides an augmented, extensible, cross-browser implementation of regular expressions,
+// including support for additional syntax, flags, and methods
+
+    //---------------------------------
+    //  Private variables
+    //---------------------------------
+
+    var real = {
+            exec: RegExp.prototype.exec,
+            test: RegExp.prototype.test,
+            match: String.prototype.match,
+            replace: String.prototype.replace,
+            split: String.prototype.split
+        },
+        compliantExecNpcg = real.exec.call(/()??/, "")[1] === undefined, // check `exec` handling of nonparticipating capturing groups
+        compliantLastIndexIncrement = function () {
+            var x = /^/g;
+            real.test.call(x, "");
+            return !x.lastIndex;
+        }();
+
+    //---------------------------------
+    //  Overriden native methods
+    //---------------------------------
+
+    // Adds named capture support (with backreferences returned as `result.name`), and fixes two
+    // cross-browser issues per ES3:
+    // - Captured values for nonparticipating capturing groups should be returned as `undefined`,
+    //   rather than the empty string.
+    // - `lastIndex` should not be incremented after zero-length matches.
+    RegExp.prototype.exec = function (str) {
+        var match = real.exec.apply(this, arguments),
+            name, r2;
+        if (match) {
+            // Fix browsers whose `exec` methods don't consistently return `undefined` for
+            // nonparticipating capturing groups
+            if (!compliantExecNpcg && match.length > 1 && indexOf(match, "") > -1) {
+                r2 = RegExp(this.source, real.replace.call(getNativeFlags(this), "g", ""));
+                // Using `str.slice(match.index)` rather than `match[0]` in case lookahead allowed
+                // matching due to characters outside the match
+                real.replace.call(str.slice(match.index), r2, function () {
+                    for (var i = 1; i < arguments.length - 2; i++) {
+                        if (arguments[i] === undefined)
+                            match[i] = undefined;
+                    }
+                });
+            }
+            // Attach named capture properties
+            if (this._xregexp && this._xregexp.captureNames) {
+                for (var i = 1; i < match.length; i++) {
+                    name = this._xregexp.captureNames[i - 1];
+                    if (name)
+                       match[name] = match[i];
+                }
+            }
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (!compliantLastIndexIncrement && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+        }
+        return match;
+    };
+
+    // Don't override `test` if it won't change anything
+    if (!compliantLastIndexIncrement) {
+        // Fix browser bug in native method
+        RegExp.prototype.test = function (str) {
+            // Use the native `exec` to skip some processing overhead, even though the overriden
+            // `exec` would take care of the `lastIndex` fix
+            var match = real.exec.call(this, str);
+            // Fix browsers that increment `lastIndex` after zero-length matches
+            if (match && this.global && !match[0].length && (this.lastIndex > match.index))
+                this.lastIndex--;
+            return !!match;
+        };
+    }
+
+    //---------------------------------
+    //  Private helper functions
+    //---------------------------------
+
+    function getNativeFlags (regex) {
+        return (regex.global     ? "g" : "") +
+               (regex.ignoreCase ? "i" : "") +
+               (regex.multiline  ? "m" : "") +
+               (regex.extended   ? "x" : "") + // Proposed for ES4; included in AS3
+               (regex.sticky     ? "y" : "");
+    };
+
+    function indexOf (array, item, from) {
+        if (Array.prototype.indexOf) // Use the native array method if available
+            return array.indexOf(item, from);
+        for (var i = from || 0; i < array.length; i++) {
+            if (array[i] === item)
+                return i;
+        }
+        return -1;
+    };
+
+});// vim: ts=4 sts=4 sw=4 expandtab
+// -- kriskowal Kris Kowal Copyright (C) 2009-2011 MIT License
+// -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
+// -- dantman Daniel Friesen Copyright (C) 2010 XXX TODO License or CLA
+// -- fschaefer Florian Sch?fer Copyright (C) 2010 MIT License
+// -- Gozala Irakli Gozalishvili Copyright (C) 2010 MIT License
+// -- kitcambridge Kit Cambridge Copyright (C) 2011 MIT License
+// -- kossnocorp Sasha Koss XXX TODO License or CLA
+// -- bryanforbes Bryan Forbes XXX TODO License or CLA
+// -- killdream Quildreen Motta Copyright (C) 2011 MIT Licence
+// -- michaelficarra Michael Ficarra Copyright (C) 2011 3-clause BSD License
+// -- sharkbrainguy Gerard Paapu Copyright (C) 2011 MIT License
+// -- bbqsrc Brendan Molloy (C) 2011 Creative Commons Zero (public domain)
+// -- iwyg XXX TODO License or CLA
+// -- DomenicDenicola Domenic Denicola Copyright (C) 2011 MIT License
+// -- xavierm02 Montillet Xavier XXX TODO License or CLA
+// -- Raynos Raynos XXX TODO License or CLA
+// -- samsonjs Sami Samhuri Copyright (C) 2010 MIT License
+// -- rwldrn Rick Waldron Copyright (C) 2011 MIT License
+// -- lexer Alexey Zakharov XXX TODO License or CLA
+
+/*!
+    Copyright (c) 2009, 280 North Inc. http://280north.com/
+    MIT License. http://github.com/280north/narwhal/blob/master/README.md
+*/
+
+define('ace/lib/es5-shim', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+/**
+ * Brings an environment as close to ECMAScript 5 compliance
+ * as is possible with the facilities of erstwhile engines.
+ *
+ * Annotated ES5: http://es5.github.com/ (specific links below)
+ * ES5 Spec: http://www.ecma-international.org/publications/files/ECMA-ST/Ecma-262.pdf
+ *
+ * @module
+ */
+
+/*whatsupdoc*/
+
+//
+// Function
+// ========
+//
+
+// ES-5 15.3.4.5
+// http://es5.github.com/#x15.3.4.5
+
+if (!Function.prototype.bind) {
+    Function.prototype.bind = function bind(that) { // .length is 1
+        // 1. Let Target be the this value.
+        var target = this;
+        // 2. If IsCallable(Target) is false, throw a TypeError exception.
+        if (typeof target != "function")
+            throw new TypeError(); // TODO message
+        // 3. Let A be a new (possibly empty) internal list of all of the
+        //   argument values provided after thisArg (arg1, arg2 etc), in order.
+        // XXX slicedArgs will stand in for "A" if used
+        var args = slice.call(arguments, 1); // for normal call
+        // 4. Let F be a new native ECMAScript object.
+        // 11. Set the [[Prototype]] internal property of F to the standard
+        //   built-in Function prototype object as specified in 15.3.3.1.
+        // 12. Set the [[Call]] internal property of F as described in
+        //   15.3.4.5.1.
+        // 13. Set the [[Construct]] internal property of F as described in
+        //   15.3.4.5.2.
+        // 14. Set the [[HasInstance]] internal property of F as described in
+        //   15.3.4.5.3.
+        var bound = function () {
+
+            if (this instanceof bound) {
+                // 15.3.4.5.2 [[Construct]]
+                // When the [[Construct]] internal method of a function object,
+                // F that was created using the bind function is called with a
+                // list of arguments ExtraArgs, the following steps are taken:
+                // 1. Let target be the value of F's [[TargetFunction]]
+                //   internal property.
+                // 2. If target has no [[Construct]] internal method, a
+                //   TypeError exception is thrown.
+                // 3. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the
+                //   list boundArgs in the same order followed by the same
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Construct]] internal 
+                //   method of target providing args as the arguments.
+
+                var F = function(){};
+                F.prototype = target.prototype;
+                var self = new F;
+
+                var result = target.apply(
+                    self,
+                    args.concat(slice.call(arguments))
+                );
+                if (result !== null && Object(result) === result)
+                    return result;
+                return self;
+
+            } else {
+                // 15.3.4.5.1 [[Call]]
+                // When the [[Call]] internal method of a function object, F,
+                // which was created using the bind function is called with a
+                // this value and a list of arguments ExtraArgs, the following
+                // steps are taken:
+                // 1. Let boundArgs be the value of F's [[BoundArgs]] internal
+                //   property.
+                // 2. Let boundThis be the value of F's [[BoundThis]] internal
+                //   property.
+                // 3. Let target be the value of F's [[TargetFunction]] internal
+                //   property.
+                // 4. Let args be a new list containing the same values as the 
+                //   list boundArgs in the same order followed by the same 
+                //   values as the list ExtraArgs in the same order.
+                // 5. Return the result of calling the [[Call]] internal method 
+                //   of target providing boundThis as the this value and 
+                //   providing args as the arguments.
+
+                // equiv: target.call(this, ...boundArgs, ...args)
+                return target.apply(
+                    that,
+                    args.concat(slice.call(arguments))
+                );
+
+            }
+
+        };
+        // XXX bound.length is never writable, so don't even try
+        //
+        // 15. If the [[Class]] internal property of Target is "Function", then
+        //     a. Let L be the length property of Target minus the length of A.
+        //     b. Set the length own property of F to either 0 or L, whichever is 
+        //       larger.
+        // 16. Else set the length own property of F to 0.
+        // 17. Set the attributes of the length own property of F to the values
+        //   specified in 15.3.5.1.
+
+        // TODO
+        // 18. Set the [[Extensible]] internal property of F to true.
+        
+        // TODO
+        // 19. Let thrower be the [[ThrowTypeError]] function Object (13.2.3).
+        // 20. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "caller", PropertyDescriptor {[[Get]]: thrower, [[Set]]:
+        //   thrower, [[Enumerable]]: false, [[Configurable]]: false}, and 
+        //   false.
+        // 21. Call the [[DefineOwnProperty]] internal method of F with 
+        //   arguments "arguments", PropertyDescriptor {[[Get]]: thrower, 
+        //   [[Set]]: thrower, [[Enumerable]]: false, [[Configurable]]: false},
+        //   and false.
+
+        // TODO
+        // NOTE Function objects created using Function.prototype.bind do not 
+        // have a prototype property or the [[Code]], [[FormalParameters]], and
+        // [[Scope]] internal properties.
+        // XXX can't delete prototype in pure-js.
+
+        // 22. Return F.
+        return bound;
+    };
+}
+
+// Shortcut to an often accessed properties, in order to avoid multiple
+// dereference that costs universally.
+// _Please note: Shortcuts are defined after `Function.prototype.bind` as we
+// us it in defining shortcuts.
+var call = Function.prototype.call;
+var prototypeOfArray = Array.prototype;
+var prototypeOfObject = Object.prototype;
+var slice = prototypeOfArray.slice;
+var toString = call.bind(prototypeOfObject.toString);
+var owns = call.bind(prototypeOfObject.hasOwnProperty);
+
+// If JS engine supports accessors creating shortcuts.
+var defineGetter;
+var defineSetter;
+var lookupGetter;
+var lookupSetter;
+var supportsAccessors;
+if ((supportsAccessors = owns(prototypeOfObject, "__defineGetter__"))) {
+    defineGetter = call.bind(prototypeOfObject.__defineGetter__);
+    defineSetter = call.bind(prototypeOfObject.__defineSetter__);
+    lookupGetter = call.bind(prototypeOfObject.__lookupGetter__);
+    lookupSetter = call.bind(prototypeOfObject.__lookupSetter__);
+}
+
+//
+// Array
+// =====
+//
+
+// ES5 15.4.3.2
+// http://es5.github.com/#x15.4.3.2
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/isArray
+if (!Array.isArray) {
+    Array.isArray = function isArray(obj) {
+        return toString(obj) == "[object Array]";
+    };
+}
+
+// The IsCallable() check in the Array functions
+// has been replaced with a strict check on the
+// internal class of the object to trap cases where
+// the provided function was actually a regular
+// expression literal, which in V8 and
+// JavaScriptCore is a typeof "function".  Only in
+// V8 are regular expression literals permitted as
+// reduce parameters, so it is desirable in the
+// general case for the shim to match the more
+// strict and common behavior of rejecting regular
+// expressions.
+
+// ES5 15.4.4.18
+// http://es5.github.com/#x15.4.4.18
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/array/forEach
+if (!Array.prototype.forEach) {
+    Array.prototype.forEach = function forEach(fun /*, thisp*/) {
+        var self = toObject(this),
+            thisp = arguments[1],
+            i = 0,
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        while (i < length) {
+            if (i in self) {
+                // Invoke the callback function with call, passing arguments:
+                // context, property value, property key, thisArg object context
+                fun.call(thisp, self[i], i, self);
+            }
+            i++;
+        }
+    };
+}
+
+// ES5 15.4.4.19
+// http://es5.github.com/#x15.4.4.19
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/map
+if (!Array.prototype.map) {
+    Array.prototype.map = function map(fun /*, thisp*/) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = Array(length),
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self)
+                result[i] = fun.call(thisp, self[i], i, self);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.20
+// http://es5.github.com/#x15.4.4.20
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/filter
+if (!Array.prototype.filter) {
+    Array.prototype.filter = function filter(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            result = [],
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                result.push(self[i]);
+        }
+        return result;
+    };
+}
+
+// ES5 15.4.4.16
+// http://es5.github.com/#x15.4.4.16
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/every
+if (!Array.prototype.every) {
+    Array.prototype.every = function every(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && !fun.call(thisp, self[i], i, self))
+                return false;
+        }
+        return true;
+    };
+}
+
+// ES5 15.4.4.17
+// http://es5.github.com/#x15.4.4.17
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/some
+if (!Array.prototype.some) {
+    Array.prototype.some = function some(fun /*, thisp */) {
+        var self = toObject(this),
+            length = self.length >>> 0,
+            thisp = arguments[1];
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        for (var i = 0; i < length; i++) {
+            if (i in self && fun.call(thisp, self[i], i, self))
+                return true;
+        }
+        return false;
+    };
+}
+
+// ES5 15.4.4.21
+// http://es5.github.com/#x15.4.4.21
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduce
+if (!Array.prototype.reduce) {
+    Array.prototype.reduce = function reduce(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value and an empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var i = 0;
+        var result;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i++];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (++i >= length)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        for (; i < length; i++) {
+            if (i in self)
+                result = fun.call(void 0, result, self[i], i, self);
+        }
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.22
+// http://es5.github.com/#x15.4.4.22
+// https://developer.mozilla.org/en/Core_JavaScript_1.5_Reference/Objects/Array/reduceRight
+if (!Array.prototype.reduceRight) {
+    Array.prototype.reduceRight = function reduceRight(fun /*, initial*/) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        // If no callback function or if callback is not a callable function
+        if (toString(fun) != "[object Function]") {
+            throw new TypeError(); // TODO message
+        }
+
+        // no value to return if no initial value, empty array
+        if (!length && arguments.length == 1)
+            throw new TypeError(); // TODO message
+
+        var result, i = length - 1;
+        if (arguments.length >= 2) {
+            result = arguments[1];
+        } else {
+            do {
+                if (i in self) {
+                    result = self[i--];
+                    break;
+                }
+
+                // if array contains no values, no initial value to return
+                if (--i < 0)
+                    throw new TypeError(); // TODO message
+            } while (true);
+        }
+
+        do {
+            if (i in this)
+                result = fun.call(void 0, result, self[i], i, self);
+        } while (i--);
+
+        return result;
+    };
+}
+
+// ES5 15.4.4.14
+// http://es5.github.com/#x15.4.4.14
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/indexOf
+if (!Array.prototype.indexOf) {
+    Array.prototype.indexOf = function indexOf(sought /*, fromIndex */ ) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+
+        var i = 0;
+        if (arguments.length > 1)
+            i = toInteger(arguments[1]);
+
+        // handle negative indices
+        i = i >= 0 ? i : Math.max(0, length + i);
+        for (; i < length; i++) {
+            if (i in self && self[i] === sought) {
+                return i;
+            }
+        }
+        return -1;
+    };
+}
+
+// ES5 15.4.4.15
+// http://es5.github.com/#x15.4.4.15
+// https://developer.mozilla.org/en/JavaScript/Reference/Global_Objects/Array/lastIndexOf
+if (!Array.prototype.lastIndexOf) {
+    Array.prototype.lastIndexOf = function lastIndexOf(sought /*, fromIndex */) {
+        var self = toObject(this),
+            length = self.length >>> 0;
+
+        if (!length)
+            return -1;
+        var i = length - 1;
+        if (arguments.length > 1)
+            i = Math.min(i, toInteger(arguments[1]));
+        // handle negative indices
+        i = i >= 0 ? i : length - Math.abs(i);
+        for (; i >= 0; i--) {
+            if (i in self && sought === self[i])
+                return i;
+        }
+        return -1;
+    };
+}
+
+//
+// Object
+// ======
+//
+
+// ES5 15.2.3.2
+// http://es5.github.com/#x15.2.3.2
+if (!Object.getPrototypeOf) {
+    // https://github.com/kriskowal/es5-shim/issues#issue/2
+    // http://ejohn.org/blog/objectgetprototypeof/
+    // recommended by fschaefer on github
+    Object.getPrototypeOf = function getPrototypeOf(object) {
+        return object.__proto__ || (
+            object.constructor ?
+            object.constructor.prototype :
+            prototypeOfObject
+        );
+    };
+}
+
+// ES5 15.2.3.3
+// http://es5.github.com/#x15.2.3.3
+if (!Object.getOwnPropertyDescriptor) {
+    var ERR_NON_OBJECT = "Object.getOwnPropertyDescriptor called on a " +
+                         "non-object: ";
+    Object.getOwnPropertyDescriptor = function getOwnPropertyDescriptor(object, property) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT + object);
+        // If object does not owns property return undefined immediately.
+        if (!owns(object, property))
+            return;
+
+        var descriptor, getter, setter;
+
+        // If object has a property then it's for sure both `enumerable` and
+        // `configurable`.
+        descriptor =  { enumerable: true, configurable: true };
+
+        // If JS engine supports accessor properties then property may be a
+        // getter or setter.
+        if (supportsAccessors) {
+            // Unfortunately `__lookupGetter__` will return a getter even
+            // if object has own non getter property along with a same named
+            // inherited getter. To avoid misbehavior we temporary remove
+            // `__proto__` so that `__lookupGetter__` will return getter only
+            // if it's owned by an object.
+            var prototype = object.__proto__;
+            object.__proto__ = prototypeOfObject;
+
+            var getter = lookupGetter(object, property);
+            var setter = lookupSetter(object, property);
+
+            // Once we have getter and setter we can put values back.
+            object.__proto__ = prototype;
+
+            if (getter || setter) {
+                if (getter) descriptor.get = getter;
+                if (setter) descriptor.set = setter;
+
+                // If it was accessor property we're done and return here
+                // in order to avoid adding `value` to the descriptor.
+                return descriptor;
+            }
+        }
+
+        // If we got this far we know that object has an own property that is
+        // not an accessor so we set it as a value and return descriptor.
+        descriptor.value = object[property];
+        return descriptor;
+    };
+}
+
+// ES5 15.2.3.4
+// http://es5.github.com/#x15.2.3.4
+if (!Object.getOwnPropertyNames) {
+    Object.getOwnPropertyNames = function getOwnPropertyNames(object) {
+        return Object.keys(object);
+    };
+}
+
+// ES5 15.2.3.5
+// http://es5.github.com/#x15.2.3.5
+if (!Object.create) {
+    Object.create = function create(prototype, properties) {
+        var object;
+        if (prototype === null) {
+            object = { "__proto__": null };
+        } else {
+            if (typeof prototype != "object")
+                throw new TypeError("typeof prototype["+(typeof prototype)+"] != 'object'");
+            var Type = function () {};
+            Type.prototype = prototype;
+            object = new Type();
+            // IE has no built-in implementation of `Object.getPrototypeOf`
+            // neither `__proto__`, but this manually setting `__proto__` will
+            // guarantee that `Object.getPrototypeOf` will work as expected with
+            // objects created using `Object.create`
+            object.__proto__ = prototype;
+        }
+        if (properties !== void 0)
+            Object.defineProperties(object, properties);
+        return object;
+    };
+}
+
+// ES5 15.2.3.6
+// http://es5.github.com/#x15.2.3.6
+
+// Patch for WebKit and IE8 standard mode
+// Designed by hax <hax.github.com>
+// related issue: https://github.com/kriskowal/es5-shim/issues#issue/5
+// IE8 Reference:
+//     http://msdn.microsoft.com/en-us/library/dd282900.aspx
+//     http://msdn.microsoft.com/en-us/library/dd229916.aspx
+// WebKit Bugs:
+//     https://bugs.webkit.org/show_bug.cgi?id=36423
+
+function doesDefinePropertyWork(object) {
+    try {
+        Object.defineProperty(object, "sentinel", {});
+        return "sentinel" in object;
+    } catch (exception) {
+        // returns falsy
+    }
+}
+
+// check whether defineProperty works if it's given. Otherwise,
+// shim partially.
+if (Object.defineProperty) {
+    var definePropertyWorksOnObject = doesDefinePropertyWork({});
+    var definePropertyWorksOnDom = typeof document == "undefined" ||
+        doesDefinePropertyWork(document.createElement("div"));
+    if (!definePropertyWorksOnObject || !definePropertyWorksOnDom) {
+        var definePropertyFallback = Object.defineProperty;
+    }
+}
+
+if (!Object.defineProperty || definePropertyFallback) {
+    var ERR_NON_OBJECT_DESCRIPTOR = "Property description must be an object: ";
+    var ERR_NON_OBJECT_TARGET = "Object.defineProperty called on non-object: "
+    var ERR_ACCESSORS_NOT_SUPPORTED = "getters & setters can not be defined " +
+                                      "on this javascript engine";
+
+    Object.defineProperty = function defineProperty(object, property, descriptor) {
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError(ERR_NON_OBJECT_TARGET + object);
+        if ((typeof descriptor != "object" && typeof descriptor != "function") || descriptor === null)
+            throw new TypeError(ERR_NON_OBJECT_DESCRIPTOR + descriptor);
+
+        // make a valiant attempt to use the real defineProperty
+        // for I8's DOM elements.
+        if (definePropertyFallback) {
+            try {
+                return definePropertyFallback.call(Object, object, property, descriptor);
+            } catch (exception) {
+                // try the shim if the real one doesn't work
+            }
+        }
+
+        // If it's a data property.
+        if (owns(descriptor, "value")) {
+            // fail silently if "writable", "enumerable", or "configurable"
+            // are requested but not supported
+            /*
+            // alternate approach:
+            if ( // can't implement these features; allow false but not true
+                !(owns(descriptor, "writable") ? descriptor.writable : true) ||
+                !(owns(descriptor, "enumerable") ? descriptor.enumerable : true) ||
+                !(owns(descriptor, "configurable") ? descriptor.configurable : true)
+            )
+                throw new RangeError(
+                    "This implementation of Object.defineProperty does not " +
+                    "support configurable, enumerable, or writable."
+                );
+            */
+
+            if (supportsAccessors && (lookupGetter(object, property) ||
+                                      lookupSetter(object, property)))
+            {
+                // As accessors are supported only on engines implementing
+                // `__proto__` we can safely override `__proto__` while defining
+                // a property to make sure that we don't hit an inherited
+                // accessor.
+                var prototype = object.__proto__;
+                object.__proto__ = prototypeOfObject;
+                // Deleting a property anyway since getter / setter may be
+                // defined on object itself.
+                delete object[property];
+                object[property] = descriptor.value;
+                // Setting original `__proto__` back now.
+                object.__proto__ = prototype;
+            } else {
+                object[property] = descriptor.value;
+            }
+        } else {
+            if (!supportsAccessors)
+                throw new TypeError(ERR_ACCESSORS_NOT_SUPPORTED);
+            // If we got that far then getters and setters can be defined !!
+            if (owns(descriptor, "get"))
+                defineGetter(object, property, descriptor.get);
+            if (owns(descriptor, "set"))
+                defineSetter(object, property, descriptor.set);
+        }
+
+        return object;
+    };
+}
+
+// ES5 15.2.3.7
+// http://es5.github.com/#x15.2.3.7
+if (!Object.defineProperties) {
+    Object.defineProperties = function defineProperties(object, properties) {
+        for (var property in properties) {
+            if (owns(properties, property))
+                Object.defineProperty(object, property, properties[property]);
+        }
+        return object;
+    };
+}
+
+// ES5 15.2.3.8
+// http://es5.github.com/#x15.2.3.8
+if (!Object.seal) {
+    Object.seal = function seal(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.9
+// http://es5.github.com/#x15.2.3.9
+if (!Object.freeze) {
+    Object.freeze = function freeze(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// detect a Rhino bug and patch it
+try {
+    Object.freeze(function () {});
+} catch (exception) {
+    Object.freeze = (function freeze(freezeObject) {
+        return function freeze(object) {
+            if (typeof object == "function") {
+                return object;
+            } else {
+                return freezeObject(object);
+            }
+        };
+    })(Object.freeze);
+}
+
+// ES5 15.2.3.10
+// http://es5.github.com/#x15.2.3.10
+if (!Object.preventExtensions) {
+    Object.preventExtensions = function preventExtensions(object) {
+        // this is misleading and breaks feature-detection, but
+        // allows "securable" code to "gracefully" degrade to working
+        // but insecure code.
+        return object;
+    };
+}
+
+// ES5 15.2.3.11
+// http://es5.github.com/#x15.2.3.11
+if (!Object.isSealed) {
+    Object.isSealed = function isSealed(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.12
+// http://es5.github.com/#x15.2.3.12
+if (!Object.isFrozen) {
+    Object.isFrozen = function isFrozen(object) {
+        return false;
+    };
+}
+
+// ES5 15.2.3.13
+// http://es5.github.com/#x15.2.3.13
+if (!Object.isExtensible) {
+    Object.isExtensible = function isExtensible(object) {
+        // 1. If Type(O) is not Object throw a TypeError exception.
+        if (Object(object) === object) {
+            throw new TypeError(); // TODO message
+        }
+        // 2. Return the Boolean value of the [[Extensible]] internal property of O.
+        var name = '';
+        while (owns(object, name)) {
+            name += '?';
+        }
+        object[name] = true;
+        var returnValue = owns(object, name);
+        delete object[name];
+        return returnValue;
+    };
+}
+
+// ES5 15.2.3.14
+// http://es5.github.com/#x15.2.3.14
+if (!Object.keys) {
+    // http://whattheheadsaid.com/2010/10/a-safer-object-keys-compatibility-implementation
+    var hasDontEnumBug = true,
+        dontEnums = [
+            "toString",
+            "toLocaleString",
+            "valueOf",
+            "hasOwnProperty",
+            "isPrototypeOf",
+            "propertyIsEnumerable",
+            "constructor"
+        ],
+        dontEnumsLength = dontEnums.length;
+
+    for (var key in {"toString": null})
+        hasDontEnumBug = false;
+
+    Object.keys = function keys(object) {
+
+        if ((typeof object != "object" && typeof object != "function") || object === null)
+            throw new TypeError("Object.keys called on a non-object");
+
+        var keys = [];
+        for (var name in object) {
+            if (owns(object, name)) {
+                keys.push(name);
+            }
+        }
+
+        if (hasDontEnumBug) {
+            for (var i = 0, ii = dontEnumsLength; i < ii; i++) {
+                var dontEnum = dontEnums[i];
+                if (owns(object, dontEnum)) {
+                    keys.push(dontEnum);
+                }
+            }
+        }
+
+        return keys;
+    };
+
+}
+
+//
+// Date
+// ====
+//
+
+// ES5 15.9.5.43
+// http://es5.github.com/#x15.9.5.43
+// This function returns a String value represent the instance in time 
+// represented by this Date object. The format of the String is the Date Time 
+// string format defined in 15.9.1.15. All fields are present in the String. 
+// The time zone is always UTC, denoted by the suffix Z. If the time value of 
+// this object is not a finite Number a RangeError exception is thrown.
+if (!Date.prototype.toISOString || (new Date(-62198755200000).toISOString().indexOf('-000001') === -1)) {
+    Date.prototype.toISOString = function toISOString() {
+        var result, length, value, year;
+        if (!isFinite(this))
+            throw new RangeError;
+
+        // the date time string format is specified in 15.9.1.15.
+        result = [this.getUTCMonth() + 1, this.getUTCDate(),
+            this.getUTCHours(), this.getUTCMinutes(), this.getUTCSeconds()];
+        year = this.getUTCFullYear();
+        year = (year < 0 ? '-' : (year > 9999 ? '+' : '')) + ('00000' + Math.abs(year)).slice(0 <= year && year <= 9999 ? -4 : -6);
+
+        length = result.length;
+        while (length--) {
+            value = result[length];
+            // pad months, days, hours, minutes, and seconds to have two digits.
+            if (value < 10)
+                result[length] = "0" + value;
+        }
+        // pad milliseconds to have three digits.
+        return year + "-" + result.slice(0, 2).join("-") + "T" + result.slice(2).join(":") + "." +
+            ("000" + this.getUTCMilliseconds()).slice(-3) + "Z";
+    }
+}
+
+// ES5 15.9.4.4
+// http://es5.github.com/#x15.9.4.4
+if (!Date.now) {
+    Date.now = function now() {
+        return new Date().getTime();
+    };
+}
+
+// ES5 15.9.5.44
+// http://es5.github.com/#x15.9.5.44
+// This function provides a String representation of a Date object for use by 
+// JSON.stringify (15.12.3).
+if (!Date.prototype.toJSON) {
+    Date.prototype.toJSON = function toJSON(key) {
+        // When the toJSON method is called with argument key, the following 
+        // steps are taken:
+
+        // 1.  Let O be the result of calling ToObject, giving it the this
+        // value as its argument.
+        // 2. Let tv be ToPrimitive(O, hint Number).
+        // 3. If tv is a Number and is not finite, return null.
+        // XXX
+        // 4. Let toISO be the result of calling the [[Get]] internal method of
+        // O with argument "toISOString".
+        // 5. If IsCallable(toISO) is false, throw a TypeError exception.
+        if (typeof this.toISOString != "function")
+            throw new TypeError(); // TODO message
+        // 6. Return the result of calling the [[Call]] internal method of
+        //  toISO with O as the this value and an empty argument list.
+        return this.toISOString();
+
+        // NOTE 1 The argument is ignored.
+
+        // NOTE 2 The toJSON function is intentionally generic; it does not
+        // require that its this value be a Date object. Therefore, it can be
+        // transferred to other kinds of objects for use as a method. However,
+        // it does require that any such object have a toISOString method. An
+        // object is free to use the argument key to filter its
+        // stringification.
+    };
+}
+
+// ES5 15.9.4.2
+// http://es5.github.com/#x15.9.4.2
+// based on work shared by Daniel Friesen (dantman)
+// http://gist.github.com/303249
+if (Date.parse("+275760-09-13T00:00:00.000Z") !== 8.64e15) {
+    // XXX global assignment won't work in embeddings that use
+    // an alternate object for the context.
+    Date = (function(NativeDate) {
+
+        // Date.length === 7
+        var Date = function Date(Y, M, D, h, m, s, ms) {
+            var length = arguments.length;
+            if (this instanceof NativeDate) {
+                var date = length == 1 && String(Y) === Y ? // isString(Y)
+                    // We explicitly pass it through parse:
+                    new NativeDate(Date.parse(Y)) :
+                    // We have to manually make calls depending on argument
+                    // length here
+                    length >= 7 ? new NativeDate(Y, M, D, h, m, s, ms) :
+                    length >= 6 ? new NativeDate(Y, M, D, h, m, s) :
+                    length >= 5 ? new NativeDate(Y, M, D, h, m) :
+                    length >= 4 ? new NativeDate(Y, M, D, h) :
+                    length >= 3 ? new NativeDate(Y, M, D) :
+                    length >= 2 ? new NativeDate(Y, M) :
+                    length >= 1 ? new NativeDate(Y) :
+                                  new NativeDate();
+                // Prevent mixups with unfixed Date object
+                date.constructor = Date;
+                return date;
+            }
+            return NativeDate.apply(this, arguments);
+        };
+
+        // 15.9.1.15 Date Time String Format.
+        var isoDateExpression = new RegExp("^" +
+            "(\\d{4}|[\+\-]\\d{6})" + // four-digit year capture or sign + 6-digit extended year
+            "(?:-(\\d{2})" + // optional month capture
+            "(?:-(\\d{2})" + // optional day capture
+            "(?:" + // capture hours:minutes:seconds.milliseconds
+                "T(\\d{2})" + // hours capture
+                ":(\\d{2})" + // minutes capture
+                "(?:" + // optional :seconds.milliseconds
+                    ":(\\d{2})" + // seconds capture
+                    "(?:\\.(\\d{3}))?" + // milliseconds capture
+                ")?" +
+            "(?:" + // capture UTC offset component
+                "Z|" + // UTC capture
+                "(?:" + // offset specifier +/-hours:minutes
+                    "([-+])" + // sign capture
+                    "(\\d{2})" + // hours offset capture
+                    ":(\\d{2})" + // minutes offset capture
+                ")" +
+            ")?)?)?)?" +
+        "$");
+
+        // Copy any custom methods a 3rd party library may have added
+        for (var key in NativeDate)
+            Date[key] = NativeDate[key];
+
+        // Copy "native" methods explicitly; they may be non-enumerable
+        Date.now = NativeDate.now;
+        Date.UTC = NativeDate.UTC;
+        Date.prototype = NativeDate.prototype;
+        Date.prototype.constructor = Date;
+
+        // Upgrade Date.parse to handle simplified ISO 8601 strings
+        Date.parse = function parse(string) {
+            var match = isoDateExpression.exec(string);
+            if (match) {
+                match.shift(); // kill match[0], the full match
+                // parse months, days, hours, minutes, seconds, and milliseconds
+                for (var i = 1; i < 7; i++) {
+                    // provide default values if necessary
+                    match[i] = +(match[i] || (i < 3 ? 1 : 0));
+                    // match[1] is the month. Months are 0-11 in JavaScript
+                    // `Date` objects, but 1-12 in ISO notation, so we
+                    // decrement.
+                    if (i == 1)
+                        match[i]--;
+                }
+
+                // parse the UTC offset component
+                var minuteOffset = +match.pop(), hourOffset = +match.pop(), sign = match.pop();
+
+                // compute the explicit time zone offset if specified
+                var offset = 0;
+                if (sign) {
+                    // detect invalid offsets and return early
+                    if (hourOffset > 23 || minuteOffset > 59)
+                        return NaN;
+
+                    // express the provided time zone offset in minutes. The offset is
+                    // negative for time zones west of UTC; positive otherwise.
+                    offset = (hourOffset * 60 + minuteOffset) * 6e4 * (sign == "+" ? -1 : 1);
+                }
+
+                // Date.UTC for years between 0 and 99 converts year to 1900 + year
+                // The Gregorian calendar has a 400-year cycle, so 
+                // to Date.UTC(year + 400, .... ) - 12622780800000 == Date.UTC(year, ...),
+                // where 12622780800000 - number of milliseconds in Gregorian calendar 400 years
+                var year = +match[0];
+                if (0 <= year && year <= 99) {
+                    match[0] = year + 400;
+                    return NativeDate.UTC.apply(this, match) + offset - 12622780800000;
+                }
+
+                // compute a new UTC date value, accounting for the optional offset
+                return NativeDate.UTC.apply(this, match) + offset;
+            }
+            return NativeDate.parse.apply(this, arguments);
+        };
+
+        return Date;
+    })(Date);
+}
+
+//
+// String
+// ======
+//
+
+// ES5 15.5.4.20
+// http://es5.github.com/#x15.5.4.20
+var ws = "\x09\x0A\x0B\x0C\x0D\x20\xA0\u1680\u180E\u2000\u2001\u2002\u2003" +
+    "\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028" +
+    "\u2029\uFEFF";
+if (!String.prototype.trim || ws.trim()) {
+    // http://blog.stevenlevithan.com/archives/faster-trim-javascript
+    // http://perfectionkills.com/whitespace-deviations/
+    ws = "[" + ws + "]";
+    var trimBeginRegexp = new RegExp("^" + ws + ws + "*"),
+        trimEndRegexp = new RegExp(ws + ws + "*$");
+    String.prototype.trim = function trim() {
+        return String(this).replace(trimBeginRegexp, "").replace(trimEndRegexp, "");
+    };
+}
+
+//
+// Util
+// ======
+//
+
+// ES5 9.4
+// http://es5.github.com/#x9.4
+// http://jsperf.com/to-integer
+var toInteger = function (n) {
+    n = +n;
+    if (n !== n) // isNaN
+        n = 0;
+    else if (n !== 0 && n !== (1/0) && n !== -(1/0))
+        n = (n > 0 || -1) * Math.floor(Math.abs(n));
+    return n;
+};
+
+var prepareString = "a"[0] != "a",
+    // ES5 9.9
+    // http://es5.github.com/#x9.9
+    toObject = function (o) {
+        if (o == null) { // this matches both null and undefined
+            throw new TypeError(); // TODO message
+        }
+        // If the implementation doesn't support by-index access of
+        // string characters (ex. IE < 7), split the string
+        if (prepareString && typeof o == "string" && o) {
+            return o.split("");
+        }
+        return Object(o);
+    };
+});/* vim:ts=4:sts=4:sw=4:
+ * ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *      Irakli Gozalishvili <rfobic at gmail.com> (http://jeditoolkit.com)
+ *      Mike de Boer <mike AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/event_emitter', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+var EventEmitter = {};
+
+EventEmitter._emit =
+EventEmitter._dispatchEvent = function(eventName, e) {
+    this._eventRegistry = this._eventRegistry || {};
+    this._defaultHandlers = this._defaultHandlers || {};
+
+    var listeners = this._eventRegistry[eventName] || [];
+    var defaultHandler = this._defaultHandlers[eventName];
+    if (!listeners.length && !defaultHandler)
+        return;
+
+    e = e || {};
+    e.type = eventName;
+    
+    if (!e.stopPropagation) {
+        e.stopPropagation = function() {
+            this.propagationStopped = true;
+        };
+    }
+    
+    if (!e.preventDefault) {
+        e.preventDefault = function() {
+            this.defaultPrevented = true;
+        };
+    }
+
+    for (var i=0; i<listeners.length; i++) {
+        listeners[i](e);
+        if (e.propagationStopped)
+            break;
+    }
+    
+    if (defaultHandler && !e.defaultPrevented)
+        defaultHandler(e);
+};
+
+EventEmitter.setDefaultHandler = function(eventName, callback) {
+    this._defaultHandlers = this._defaultHandlers || {};
+    
+    if (this._defaultHandlers[eventName])
+        throw new Error("The default handler for '" + eventName + "' is already set");
+        
+    this._defaultHandlers[eventName] = callback;
+};
+
+EventEmitter.on =
+EventEmitter.addEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        var listeners = this._eventRegistry[eventName] = [];
+
+    if (listeners.indexOf(callback) == -1)
+        listeners.push(callback);
+};
+
+EventEmitter.removeListener =
+EventEmitter.removeEventListener = function(eventName, callback) {
+    this._eventRegistry = this._eventRegistry || {};
+
+    var listeners = this._eventRegistry[eventName];
+    if (!listeners)
+        return;
+
+    var index = listeners.indexOf(callback);
+    if (index !== -1)
+        listeners.splice(index, 1);
+};
+
+EventEmitter.removeAllListeners = function(eventName) {
+    if (this._eventRegistry) this._eventRegistry[eventName] = [];
+};
+
+exports.EventEmitter = EventEmitter;
+
+});/* ***** BEGIN LICENSE BLOCK *****
+ * Version: MPL 1.1/GPL 2.0/LGPL 2.1
+ *
+ * The contents of this file are subject to the Mozilla Public License Version
+ * 1.1 (the "License"); you may not use this file except in compliance with
+ * the License. You may obtain a copy of the License at
+ * http://www.mozilla.org/MPL/
+ *
+ * Software distributed under the License is distributed on an "AS IS" basis,
+ * WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License
+ * for the specific language governing rights and limitations under the
+ * License.
+ *
+ * The Original Code is Ajax.org Code Editor (ACE).
+ *
+ * The Initial Developer of the Original Code is
+ * Ajax.org B.V.
+ * Portions created by the Initial Developer are Copyright (C) 2010
+ * the Initial Developer. All Rights Reserved.
+ *
+ * Contributor(s):
+ *      Fabian Jakobs <fabian AT ajax DOT org>
+ *
+ * Alternatively, the contents of this file may be used under the terms of
+ * either the GNU General Public License Version 2 or later (the "GPL"), or
+ * the GNU Lesser General Public License Version 2.1 or later (the "LGPL"),
+ * in which case the provisions of the GPL or the LGPL are applicable instead
+ * of those above. If you wish to allow use of your version of this file only
+ * under the terms of either the GPL or the LGPL, and not to allow others to
+ * use your version of this file under the terms of the MPL, indicate your
+ * decision by deleting the provisions above and replace them with the notice
+ * and other provisions required by the GPL or the LGPL. If you do not delete
+ * the provisions above, a recipient may use your version of this file under
+ * the terms of any one of the MPL, the GPL or the LGPL.
+ *
+ * ***** END LICENSE BLOCK ***** */
+
+define('ace/lib/oop', ['require', 'exports', 'module' ], function(require, exports, module) {
+
+exports.inherits = (function() {
+    var tempCtor = function() {};
+    return function(ctor, superCtor) {
+        tempCtor.prototype = superCtor.prototype;
+        ctor.super_ = superCtor.prototype;
+        ctor.prototype = new tempCtor();
+        ctor.prototype.constructor = ctor;
+    }
+}());
+
+exports.mixin = function(obj, mixin) {
+    for (var key in mixin) {
+        obj[key] = mixin[key];
+    }
+};
+
+exports.implement = function(proto, mixin) {
+    exports.mixin(proto, mixin);
+};
+
+});
+
+
+define('ace/mode/spoofax2ace_worker', ['require', 'exports', 'module' , 'ace/lib/oop', 'ace/worker/mirror'], function(require, exports, module) { var oop = require("ace/lib/oop"); 
+var Mirror = require("ace/worker/mirror").Mirror; 
+var working = false;
+var goAgain = false;
+var SpoofaxToAceWorker = exports.SpoofaxToAceWorker = function(sender) {
+    $self.sender = sender;
+    this.setTimeout(100);
+    this.analyzer = null;
+    this.loaded = false;
+    this.loading = false;
+    this.load();
+    Mirror.call(this, sender);
+};
+
+/*
+ *  Statistics collecting start
+ */
+
+var lastLineCount = 0;
+var analyzeCount = 0;
+var totalAnalyzeTime = 0;
+
+
+var doneAnalyzing = function(lineCount, timeTaken)
+{
+	if (lastLineCount !== lineCount)
+	{
+		lastLineCount = lineCount;
+		analyzeCount = 1;
+		totalAnalyzeTime = timeTaken;
+	} else
+	{
+        	totalAnalyzeTime = totalAnalyzeTime + timeTaken;
+	        analyzeCount = analyzeCount + 1;
+		sender.emit("log", "Analyzed " + lastLineCount +" lines " + analyzeCount + " times. cur:" + timeTaken + " avg: " + averageAnalyzeTime());
+	}
+}
+
+var averageAnalyzeTime = function() 
+{
+  return parseInt(totalAnalyzeTime/analyzeCount);
+}
+
+/*
+ *  Statistics collecting end
+ */
+
+oop.inherits(SpoofaxToAceWorker, Mirror); (function() {
+    this.log = function(value) {
+        if(typeof(console) !== 'undefined' && console.log !== undefined) {
+            console.log(value);
+        } else {
+            sender.emit("log", value);
+        }
+    }
+	
+    this.load = function() {
+    }	
+
+
+    this.onUpdate = function() {
+	if (!this.loaded)
+	{
+		sender.emit("log", "Not yet loaded...");
+		if (!this.loading)
+		{
+			this.loading = true;
+			var start = new Date().getTime();
+			this.analyzer = StrategoJS.init();
+
+			this.loaded = true;
+			this.loading = false;
+			var elapsed = (new Date().getTime() - start);
+		        sender.emit("log", "loaded. (" +  elapsed + ")");
+			this.onUpdate();
+		}
+		return;
+	}
+    	if (working)
+    	{
+                sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+    	goAgain = false;
+	
+	sender.emit("log", "spoofax2ace_worker.onUpdate enter");
+//        sender.emit("log", "Analyze start");
+	var analyze_start = new Date().getTime();
+
+    
+        var value = this.doc.getValue();
+        value = value.replace(/^#!.*\n/, "\n");
+	var result = null;
+	try
+	{
+		result = this.analyzer.main(["aap", value]);
+	}
+	catch (exception)
+	{
+		sender.emit("log", "Error while analyzing: " + exception.message);
+		sender.emit("log", "Stack: " + exception.stack);
+		debugger;
+	}
+
+
+        if (result === null)
+        {
+		sender.emit("log", "Error while analyzing");
+        	working = false;
+        	return;
+        }
+        var splitlines = value.split('\n');
+        var length = result.tokens.length;
+        var parsed = [];
+        for(var i = 0; i < length; i++) {
+            var line = splitlines[i];
+            var tokens = result.tokens[i];
+            parsed[i] = {text: line, tokens: tokens};
+        }
+
+
+        sender.emit("jsglr", {
+            parsed: parsed,
+            errors: result.errors
+        });
+
+	var analyze_elapsed = (new Date().getTime() - analyze_start);
+
+	doneAnalyzing(length, analyze_elapsed);
+
+        sender.emit("log", "spoofax2ace_worker.onUpdate exit");
+        working = false;
+        if (goAgain)
+        	onUpdate();
+    }
+   

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/measurements.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/measurements.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,121 @@
+/**
+ * @author Richard Vogelij
+ * Functions meant to provide a hook into gathering runtime statistics and 
+ * automatically posting these to a stats collecting database.
+ * 
+ * Data can be used to perform analysis work.
+ * 
+ * This is currently a static information container. Resets after each use.
+ */
+
+//var DATACOLLECTINGSERVERURL = "http://richard.vogelij.nl:8889";
+var DATACOLLECTINGSERVERURL = "http://192.168.1.125:8889";
+StrategoJSDataCollect = {};
+var StrategoJSDataCollectors = new Array();
+
+
+/*
+ * @name: name of the language
+ * @extrainfo: arbitrary extra info regarding the type of work (analyze/parse/etc)
+ */
+StrategoJSDataCollect.StartWork = function(taskName)
+{
+	var r = {
+			startTime : new Date(),
+			stopTime : null
+	};
+	StrategoJSDataCollectors[taskName] = r;
+}
+
+
+/*
+ * Posts the gathered data to a simple tcp socket using a hacky xmlhttprequest.
+ *  @xaxis: Horizontal metric of the data. E.g. #Lines of code processed/# of errors produced/avg or max Depth of tree
+ */
+
+StrategoJSDataCollect.FinishedWork = function(taskName)
+{
+	if (StrategoJSDataCollectors[taskName] !== undefined)
+	{
+		if (StrategoJSDataCollectors[taskName].stopTime !== null)
+			throw "Datacollector for "+taskName+" was already stopped";
+		StrategoJSDataCollectors[taskName].stopTime = new Date();
+		StrategoJSDataCollectors[taskName].elapsed = StrategoJSDataCollectors[taskName].stopTime - StrategoJSDataCollectors[taskName].startTime; 
+	}
+}
+
+/*
+ * Sends the recorded elapsed time to the datacollector.
+ */
+StrategoJSDataCollect.RecordData = function(taskName, langName, metricName, metricValue)
+{
+
+	if (StrategoJSDataCollectors[taskName] !== undefined)
+	{
+		var collected = StrategoJSDataCollectors[taskName];
+		if (collected.elapsed !== undefined)
+			postStats(langName, getJsEngineString() + "_" + metricName + "_" + taskName, metricValue, collected.elapsed);
+	}
+
+	function postStats(langstr, idstr, xaxis, yaxis) {
+		var post = "#"+idstr+"#"+langstr+"#"+xaxis+"#"+yaxis+"#";
+		logger(post);
+		return;
+	}
+}
+
+
+StrategoJSDataCollect.RecordHeapSize = function(taskName, langName, metricName, metricValue)
+{
+	postStats(langName, getJsEngineString() + "_" + metricName + "_" + taskName, metricValue, process.memoryUsage().heapUsed);
+
+	function postStats(langstr, idstr, xaxis, yaxis) {
+		var post = "#"+idstr+"#"+langstr+"#"+xaxis+"#"+yaxis+"#";
+		logger(post);
+		return;
+	}
+}
+
+
+var xmlhttpreq=undefined;
+function logger(str) {
+	if (xmlhttpreq === undefined)
+	{
+		try
+		{
+			//Required when running from CLI (on V8)
+			xmlhttpreq  = require("./XMLHttpRequest.js").XMLHttpRequest;
+		} catch (err) {
+			xmlhttpreq = XMLHttpRequest;
+		}
+	}
+	try
+	{
+		xmlhttp=new xmlhttpreq();
+		xmlhttp.open("POST", DATACOLLECTINGSERVERURL, false);
+		xmlhttp.setRequestHeader(str, 'hack');//chrome Access-Control-Allow-Origin hack. Just want to send a string over. Let server handle retrieval
+		xmlhttp.send("x", false);
+	} catch (err)
+	{
+		//console.log("Error while posting statistics: " + err.message);
+	}
+	return;
+}
+
+function getJsEngineString()
+{
+	try
+	{
+		var usragent = navigator.userAgent.toLowerCase();
+		if (usragent.indexOf("chrome") > -1) return "chrome";
+		if (usragent.indexOf("netscape") > -1) return "firefox";
+		if (usragent.indexOf("firefox") > -1) return "firefox";
+		if (usragent.indexOf("node-js") > -1) return "nodejs";
+		
+		return "unknown";
+	}
+	catch (err)
+	{
+		return "cli";
+	}
+}
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,11 @@
+/*
+ * This contains logic to decide whether to calc stuff locally or remotely.
+ */
+
+this.delegateWork = function()
+{
+	if (false)
+		this.s2alocal();
+	else
+		this.s2aclient();
+}
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,132 @@
+
+var s2aclient_loading=false;
+var s2aclient_loaded=false;
+var s2aclient_start;
+
+this.s2aclient = function() {
+	console.log("s2aclient");
+	if (!s2aclient_loaded)
+	{
+		sender.emit("log", "Not yet loaded...");
+		if (!s2aclient_loading)
+		{
+			s2aclient_loading = true;
+			s2awebsocket.connect();
+			s2aclient_loaded = true;
+			s2aclient_loading = false;
+		}
+		return;
+	}
+    	if (working)
+    	{
+	        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+	var value = this.doc.getValue();
+	s2aclient_start = new Date().getTime();
+	
+	s2awebsocket.send(value);
+
+	working = false;
+	if (goAgain)
+		onUpdate();
+}
+
+var updateTokens = function(x)
+{
+  sender.emit("jsglr", x);
+  var elapsed = (new Date().getTime() - s2aclient_start);
+  sender.emit("log", "Full client-server cycle took: " +  elapsed + "ms");
+
+}
+
+
+
+var s2awebsocket = {
+	msgIdx : 0,
+	s2aserverurl : 'ws://richard.vogelij.nl:8080/s2aserver',
+	measuretimetoanswer : function() {
+		time = new Date().getTime();
+	},
+	connect : function() {
+		var location = s2awebsocket.s2aserverurl;
+		this._ws = new WebSocket(location);
+		this._ws.onopen = this._onopen;
+		this._ws.onmessage = this._onmessage;
+		this._ws.onclose = this._onclose;
+	},
+	_onopen : function() {
+		s2awebsocket._send('websockets are open for communications!');
+	},
+	_send : function(message) {
+		this.msgIdx++;
+		if (this.msgIdx >= 9999)
+			this.msgIdx = 0;
+		var MAXLEN = 16385 - 4 - 4 - 4; //prepending fragments with three 4-digit based numbers -> MSGID+FRAGMENTIDX+TOTALFRAGMENTS
+		var length = message.length;
+		var fragmentcount = Math.ceil(length / MAXLEN);
+		var curfragment = 1;
+		
+		if (fragmentcount > 9999)
+		{
+			alert('data too large for protocol');
+			return;
+		}
+		for (curfragment=1; curfragment < fragmentcount+1; curfragment++)
+		{
+			fragment = 
+				s2awebsocket.lz(this.msgIdx,4)+
+				s2awebsocket.lz(curfragment,4)+
+				s2awebsocket.lz(fragmentcount,4)+
+				message.substring((curfragment-1)*MAXLEN, (curfragment)*MAXLEN);
+			if (this._ws)
+			{
+				this._ws.send(fragment);
+			}
+		}
+	},
+
+	send : function(text) {
+		
+		if (text != null && text.length > 0)
+		{
+			s2awebsocket._send(text);
+		}
+	},
+
+	_onmessage : function(m) {
+		if (m.data) {
+			console.log('Size of recieved message: ' + m.data.length);
+			//process recieved data
+			if (m.data == "Parse Error")
+			{
+				console.log("Parse error");
+				return;
+			}
+				
+			var obj;
+			try
+			{
+				obj = JSON.parse(m.data);
+			} catch (exception)
+			{
+				console.log("json parse error");
+				console.log(m.data);
+				console.log(exception);
+			}
+			updateTokens(obj);
+		}
+	},
+	_onclose : function(m) {
+		this._ws = null;
+	},
+	lz : function(number, length) {
+			var str = '' + number;
+			while (str.length < length) {
+				str = '0' + str;
+			}
+			return str;
+	}			
+};

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,78 @@
+
+var s2alocal_loading=false;
+var s2alocal_loaded=false;
+var s2alocal_analyzer=null;
+
+this.s2alocal = function() {
+	console.log("s2alocal");
+    if (!s2alocal_loaded)
+    {
+		sender.emit("log", "Not yet loaded...");
+		if (!s2alocal_loading)
+		{
+			s2alocal_loading = true;
+			var start = new Date().getTime();
+			s2alocal_analyzer = StrategoJS.init();
+			s2alocal_loaded = true;
+			s2alocal_loading = false;
+			var elapsed = (new Date().getTime() - start);
+		    sender.emit("log", "loaded. (" +  elapsed + ")");
+		    this.s2alocal();
+		}
+		return;
+	}
+    	if (working)
+    	{
+	        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+    		goAgain = true; 
+    		return;
+    	}
+    	working = true;
+    	goAgain = false;
+	sender.emit("log", "spoofax2ace_worker.onUpdate enter");
+	var analyze_start = new Date().getTime();
+	var value = this.doc.getValue();
+	value = value.replace(/^#!.*\n/, "\n");
+	var result = null;
+	try
+	{
+		result = s2alocal_analyzer.main(["aap", value]);
+	}
+	catch (exception)
+	{
+		sender.emit("log", "Error while analyzing: " + exception.message);
+		sender.emit("log", "Stack: " + exception.stack);
+		debugger;
+	}
+
+
+	if (result === null)
+	{
+		sender.emit("log", "Error while analyzing");
+		working = false;
+		return;
+	}
+	var splitlines = value.split('\n');
+	var length = result.tokens.length;
+	var parsed = [];
+	for(var i = 0; i < length; i++) {
+	    var line = splitlines[i];
+	    var tokens = result.tokens[i];
+	    parsed[i] = {text: line, tokens: tokens};
+	}
+
+
+	sender.emit("jsglr", {
+	    parsed: parsed,
+	    errors: result.errors
+	});
+
+	var analyze_elapsed = (new Date().getTime() - analyze_start);
+
+	doneAnalyzing(length, analyze_elapsed);
+
+	sender.emit("log", "spoofax2ace_worker.onUpdate exit");
+	working = false;
+	if (goAgain)
+		this.s2alocal();
+}

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/stats.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/stats.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,31 @@
+	/*
+	 *  Statistics collecting start
+	 */
+	var lastLineCount = 0;
+	var analyzeCount = 0;
+	var totalAnalyzeTime = 0;
+
+
+	var doneAnalyzing = function(lineCount, timeTaken)
+	{
+		if (lastLineCount !== lineCount)
+		{
+			lastLineCount = lineCount;
+			analyzeCount = 1;
+			totalAnalyzeTime = timeTaken;
+		} else
+		{
+			totalAnalyzeTime = totalAnalyzeTime + timeTaken;
+			analyzeCount = analyzeCount + 1;
+			sender.emit("log", "Analyzed " + lastLineCount +" lines " + analyzeCount + " times. cur:" + 
+				timeTaken + " avg: " + averageAnalyzeTime());
+		}
+	}
+
+	var averageAnalyzeTime = function() 
+	{
+	  return parseInt(totalAnalyzeTime/analyzeCount);
+	}
+	/*
+	 *  Statistics collecting end
+	 */
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/resources/stratego/S2Alib.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/stratego/S2Alib.str	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,31 @@
+/**
+The contents of this file are appended to the entrypoint file which is generated by spoofax2ace. 
+*/
+
+
+print-elapsed(s|msg) =
+      where(times => starttime)
+    ; s
+    ; where(
+        <diff-times>(<times>,starttime)
+      //; <prim("SSL_loginfo")><concat-strings>[ msg
+      ; <debug><concat-strings>[ msg
+        				, " ["
+                        , <self-children-user-time; ticks-to-seconds ; real-to-string(|3)>
+                        , "s/"
+                        , <self-children-sys-time; ticks-to-seconds ; real-to-string(|3)>
+                        , "s]"
+                        ]
+      )
+      
+linecount-in-string = <length><filter(10)><explode-string>
+
+max-depths-summed = <sum><max-depths> 
+max-depths = collect-all(max-depth, conc) 
+	
+max-depth = max-depth(|1)
+max-depth(|d):
+  ast -> max-depth
+  with
+    params := <?_#(<id>)> ast;
+    max-depth := <list-max> [d|<map(max-depth(|<inc> d))> params]
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/S2ASettings.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/S2ASettings.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,23 @@
+package spoofax.ace;
+
+
+public class S2ASettings {
+	
+	//protected S2AGenerator(String spoofaxProjdir, String jssglr, String str2jsPath, String strategoLib, String strategoCtrees, String mainSrcFile) throws IOException, S2ASpoofaxSetupException
+	public final String SpoofaxProjectDir;
+	public final String JssglrImplementation;
+	public final String Str2JSPath;
+	public final String StrategoLibPath;
+	public final String StrategoCtreePath;
+	
+	public String SourceFilePath;
+	
+	public S2ASettings(String pSpoofaxProjDir, String pJssglrImplementation, String pStr2JSPath, String pStrategoLibPath, String pStrategoCtreePath)
+	{
+		SpoofaxProjectDir = pSpoofaxProjDir;
+		JssglrImplementation = pJssglrImplementation;
+		Str2JSPath = pStr2JSPath;
+		StrategoLibPath = pStrategoLibPath;
+		StrategoCtreePath = pStrategoCtreePath;
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/SpoofaxToAce.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/SpoofaxToAce.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,112 @@
+package spoofax.ace;
+
+import java.util.HashMap;
+
+
+import spoofax.ace.generate.java.S2AJavaGenerator;
+import spoofax.ace.generate.javascript.S2AAceEditorGenerator;
+import spoofax.ace.generate.javascript.S2ACloud9PluginGenerator;
+import spoofax.ace.generate.javascript.S2ANodeJSExecutableGenerator;
+
+
+/*
+ * This application creates an Ace (Ajax Cloud9 Editor) editor based on a Spoofax project.
+ * Requirements:
+ * 	- str2js.jar (Compiled version of the strategoxt-javascript-backend)
+ *  - jssglr.generated.js (Through GWT to javascript compiled SGLR parser) 
+ *  - Spoofax project which contains the required files
+ *  
+ * Alternatively it is possible to output a NodeJS executable file. (See P_CLIEXEC)
+ * 
+ * Additional info:
+ *   The ace implementation in the resource directory of this project has been extracted 
+ *   from the build directory in a freshly checked out, and built, ace project.
+ *    
+ */
+public class SpoofaxToAce {
+
+	final static String _version 		= "0.24";
+	final static String P_SPOOFAXDIR 	= "--i";
+	final static String P_JSSGLRJSFILE 	= "--jssglr";
+	final static String P_STR2JSDIR 	= "--s2js";
+	final static String P_STRLIB		= "--strlib";
+	final static String P_STRCTREE		= "--strctrees";
+	final static String P_WWWOUTPUT		= "--wwwout";
+	final static String P_TESTSRC		= "--testsrc";
+	final static String P_CLIEXEC		= "--cliexecutable";
+	final static String P_CLOUD9PLUGIN  = "--cloud9plugin";
+	final static String P_WITHSERVER    = "--withserver";
+
+	
+	final static String[] reqParams = {P_SPOOFAXDIR, P_JSSGLRJSFILE, P_STR2JSDIR, P_STRLIB, P_STRCTREE};
+	final static String[] optParams = {P_WWWOUTPUT, P_TESTSRC, P_CLIEXEC, P_CLOUD9PLUGIN, P_WITHSERVER};	
+	
+	public static void main(String[] args) throws Exception {
+		
+		
+		
+		HashMap<String, String> params = new HashMap<String, String>();
+		String key = "";
+		for (int i = 0; i < args.length; i++)
+		{
+			if (i % 2 == 0)	
+				key = args[i];
+			else
+				params.put(key, args[i]);
+		}
+		
+		for (String p : reqParams)
+		{
+			if (!params.containsKey(p) || params.get(p).equals(""))
+			{
+				showArgs();
+				System.err.println("");
+				System.err.println("Missing required parameter: " + p);
+				return;
+			}
+		}
+		
+		S2ASettings settings = new S2ASettings(
+				params.get(P_SPOOFAXDIR),
+				params.get(P_JSSGLRJSFILE),
+				params.get(P_STR2JSDIR), 
+				params.get(P_STRLIB),
+				params.get(P_STRCTREE)
+		);
+		settings.SourceFilePath = params.get(P_TESTSRC);
+		
+		
+		if (params.containsKey(P_CLIEXEC))
+			new S2ANodeJSExecutableGenerator(settings).Build(params.get(P_CLIEXEC));
+		else if (params.containsKey(P_CLOUD9PLUGIN))
+			new S2ACloud9PluginGenerator(settings).Build(params.get(P_CLOUD9PLUGIN));
+		else
+			new S2AAceEditorGenerator(settings, params.get(P_TESTSRC)).Build(params.get(P_WWWOUTPUT));
+		
+		if (params.containsKey(P_WITHSERVER))
+			new S2AJavaGenerator(settings).Build(params.get(P_WITHSERVER));
+	}
+	
+	private static void showArgs()
+	{
+		System.err.println("Spoofax to Ace v." + _version);
+		System.err.println("usage: spoofax2ace.jar [--option0 value0 --option1 value1 ...]");
+		System.err.println("");
+		System.err.println("");
+		System.err.println("Required:");
+		System.err.println("\t"+P_SPOOFAXDIR+" <dir>\t\tSpoofax project root");
+		System.err.println("\t"+P_JSSGLRJSFILE+" <jsfile>\tPath to jssglr file");
+		System.err.println("\t"+P_STR2JSDIR+" <dir>\t\tPath to str2js");
+		System.err.println("\t"+P_STRLIB+" <dir>\t\tPath to Stratego lib");
+		System.err.println("\t"+P_STRCTREE+" <dir>\tPath to Stratego ctrees");
+		System.err.println("");
+		System.err.println("Optional:");
+		System.err.println("\t"+P_WWWOUTPUT+" <dir>\t\tTarget www root");		
+		System.err.println("\t"+P_TESTSRC+" <file>\tFull path to a source file from the target language");
+		System.err.println("\t"+P_CLIEXEC+" <file>\tOutput a (NodeJS) executable");
+		System.err.println("\t"+P_CLOUD9PLUGIN+" <dir>\tInstall language into Cloud9 installation at <dir>");
+		System.err.println("\t"+P_WITHSERVER+" <dir>\tAlso create native java serverside executable at <dir> (Not fully implemented!)");
+	}
+}
+
+

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2ACompilerException.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2ACompilerException.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+package spoofax.ace.exceptions;
+
+public class S2ACompilerException extends Exception { private static final long serialVersionUID = 1L; }
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2ASpoofaxSetupException.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2ASpoofaxSetupException.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+package spoofax.ace.exceptions;
+
+public class S2ASpoofaxSetupException extends Exception { private static final long serialVersionUID = 1L; }
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2AValidatorException.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2AValidatorException.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+package spoofax.ace.exceptions;
+
+public class S2AValidatorException extends Exception { private static final long serialVersionUID = 1L; }
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2AWrapperException.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/exceptions/S2AWrapperException.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+package spoofax.ace.exceptions;
+
+public class S2AWrapperException extends Exception { private static final long serialVersionUID = 1L; };
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/S2AGenerator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/S2AGenerator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,17 @@
+package spoofax.ace.generate;
+
+import java.io.IOException;
+
+import org.spoofax.NotImplementedException;
+
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.exceptions.S2AValidatorException;
+import spoofax.ace.exceptions.S2AWrapperException;
+
+public class S2AGenerator {
+	public boolean Build(String targetOutput) throws S2ASpoofaxSetupException, S2AWrapperException, S2ACompilerException, S2AValidatorException, IOException, InterruptedException
+	{
+		throw new NotImplementedException("This method must be overridden");
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaCompiler.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaCompiler.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,143 @@
+package spoofax.ace.generate.java;
+
+
+import java.io.BufferedReader;
+import java.io.File;
+import java.io.FileReader;
+import java.io.FileWriter;
+import java.io.IOException;
+import java.io.PrintStream;
+import java.security.Permission;
+import java.util.List;
+
+
+import org.strategoxt.strj.strj;
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2AJavaCompiler {
+	
+	private final String _buildDir;
+	private final String _tmpDir;
+	
+	public S2AJavaCompiler(String tmpDir, String buildDir)
+	{
+		_buildDir = buildDir;
+		_tmpDir = tmpDir;
+	}
+	
+	public void CompileEntrypointToJava(String langName, String strategoEntryProg, String strctrees, String strlib, List<String> externalStrategies) throws S2ACompilerException, IOException, InterruptedException
+	{
+		new File(_buildDir).mkdirs();
+		S2AUtils.EmptyDir(_buildDir);
+		
+		System.err.println("Compiling java entrypoint...");
+		String arg =
+        "-i " + strategoEntryProg + " " +
+        "-o " + _buildDir + " " +
+        "-O 0 " +
+		"-la stratego-lib -la stratego-gpp -la stratego-rtg -la stratego-sglr -la trans " +
+		"-I " + strctrees + " " +
+		"-I " + strlib + " " +
+		"-I " + _tmpDir + " " +
+		"-I . " +
+		
+		"";
+		System.err.println("Strj args: " + arg);
+		PrintStream buErr = System.err;
+		PrintStream errp = null;
+		try
+		{
+			errp = new PrintStream(_tmpDir+"/strj_compiler.log");
+		} catch (Exception e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ACompilerException();
+		}
+		System.setErr(errp);
+		System.setSecurityManager(securityManager);
+		try {
+			strj.main(arg.split(" "));
+		} catch( ExitTrappedException e ) {
+		} finally {
+			System.setSecurityManager(null);
+		}
+		System.setErr(buErr);
+		
+		if (!new File(_buildDir + "/jbuild.java").exists())
+		{
+			System.err.println("###CRITICAL ERROR### No generated java file by strj.");
+			System.err.println("Check for details:");
+			System.err.println("   "+_tmpDir + "/strj_compiler.txt");
+			throw new S2ACompilerException();
+		}
+		
+		System.err.println("Finished generating java entrypoint...");
+		
+		String externalStrategiesStr = "";
+		for (String externalStrat : externalStrategies)
+		{
+			S2AUtils.WriteResourceToFile(getClass(), "/java/"+externalStrat, _buildDir + "/" + externalStrat);
+			externalStrategiesStr += _buildDir + "/" +externalStrat + " ";
+		}
+		
+		
+		
+		HackyReplaceFailingStringInGeneratedJavaFile();
+		S2AUtils.ExecCommandLine(_tmpDir,
+				"javac -cp " + System.getProperty("java.class.path") + ":"+_tmpDir+langName+".jar " +
+				"-source 5 " + 
+				externalStrategiesStr + 
+				_buildDir + "/jbuild.java " 
+		);
+		System.err.println("Compiled java implementation to binary executable");
+	}
+	
+	
+	/*
+	 * In a default Spoofax ant built jar there exists a "trans" class in the "trans" package.
+	 * This class is a helper class and is defined as:  "public class trans extends Main {}"
+	 * 
+	 * When using strjs to compile a stratego program, which uses the spoofax prog as library
+	 *  using "-la trans" as paramater causes a code snipplet in the init method: "trans.Main.init()"
+	 * 
+	 * Due to a bug? in Java the compiler tries to refer to class trans, field Main. which does not 
+	 * exist since trans is a Main itself. 
+	 * 
+	 * To (temporarily) fix this the following method hacks the generated .java file so that it
+	 * can be compiled bij javac 
+	 * 
+	 *  TODO: Fix this in a less hacky way.
+	 * 
+	 */	
+	
+	private void HackyReplaceFailingStringInGeneratedJavaFile() throws IOException
+	{
+        File file = new File(_buildDir + "/jbuild.java");
+        BufferedReader reader = new BufferedReader(new FileReader(file));
+        String line = "", oldtext = "//EDITED\r\n";
+        while((line = reader.readLine()) != null)
+        {
+            oldtext += line + "\r\n";
+        }
+        reader.close();
+        String newtext = oldtext.replaceAll(
+        		"trans.Main.init",
+        		"trans.init");
+        FileWriter writer = new FileWriter(_buildDir + "/jbuild.java");
+        writer.write(newtext);
+        writer.close();
+	}
+	
+	/* -hack- throw custom exception when System.exit is called. */
+	private static class ExitTrappedException extends SecurityException { private static final long serialVersionUID = 1L; }
+	final SecurityManager securityManager = new SecurityManager() {
+		public void checkPermission(Permission permission) {
+			if (permission.getName().startsWith("exitVM")) {
+				throw new ExitTrappedException();
+			}
+		}
+	};
+	
+}
+

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaEntryPoint.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,86 @@
+package spoofax.ace.generate.java;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2AJavaEntryPoint {
+	public static void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2acejava\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        "libstratego-sglr\n" +
+	        "libstratego-gpp\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [x, sourcecode] -> <real-main>sourcecode \n" +
+	        //"      where <debug>$[main running. Src=[sourcecode]] \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> (ast, [errors, warnings, notes])    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        
+	        //Do everything without stats colecting first so jvm can "warm up" and stratego optimizations such as caches have effect.
+	        
+	        //"      where print-elapsed(preparse := <parse-string(|table)>sourcecode|\"Pre parsed source (pre-stats collecting)\")\n" +
+	        //"      where print-elapsed(<"+esvParser.GetSemanticObserverStrategy()+">(preparse, \"\", \"\")|\"Pre analyzed source (pre-stats collecting)\") \n" +
+	        //"      where print-elapsed(preparse := <parse-string(|table)>sourcecode|\"Pre parsed source (pre-stats collecting)\")\n" +
+	        //"      where print-elapsed(<"+esvParser.GetSemanticObserverStrategy()+">(preparse, \"\", \"\")|\"Pre analyzed source (pre-stats collecting)\") \n" +
+	        
+	        
+	        //"      where start-task(|$[java_parse]) "+
+	        "      where print-elapsed(ast := <parse-string(|table)>sourcecode|\"Parsed source\")\n" +
+	        //"      where finished-task(|$[java_parse]) "+
+	        //"      where max-depth := <max-depth>ast \n" +
+	        //"      where max-depths-summed := <max-depths-summed>ast \n"+
+	        
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[CharsOfCode], <strlen>sourcecode) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[TermSize], <term-size>ast) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepth], max-depth) "+
+	        //"      where record-task(|$[java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+
+	        //"      where record-current-heap-size(|$[memsize_after_java_parse], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+	        
+	        //"      where record-current-heap-size(|$[memsize_after_java_parse], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+	        
+
+	        //"      where start-task(|$[java_analyze]) "+
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        //"      where finished-task(|$[java_analyze]) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[CharsOfCode], <strlen>sourcecode) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[TermSize], <term-size>ast) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepth], max-depth) "+
+	        //"      where record-task(|$[java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+	        
+			//"      where record-current-heap-size(|$[memsize_after_java_analyze], $["+esvParser.GetCtreeName()+"], $[LinesOfCode], <linecount-in-string>sourcecode) "+	        
+	        //"      where record-current-heap-size(|$[memsize_after_java_analyze], $["+esvParser.GetCtreeName()+"], $[MaxDepthS], max-depths-summed) "+
+	        
+	        
+	        
+	        "external " + esvParser.GetSemanticObserverStrategy() + "(|) \n" +
+	        //"external start-task(|task) \n" +
+	        //"external finished-task(|task) \n" +
+	        //"external record-task(|task, langname, metricname, metricvalue) \n" +
+	        //"external record-current-heap-size(|task, langname, metricname, metricvalue) \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}	
+
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaGenerator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/java/S2AJavaGenerator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,105 @@
+package spoofax.ace.generate.java;
+
+import java.io.File;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.util.LinkedList;
+import java.util.List;
+
+import spoofax.ace.S2ASettings;
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.generate.S2AGenerator;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.spoofaxinfo.S2ASpoofaxInfo;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2AJavaGenerator extends S2AGenerator {
+	
+	private final S2ASettings _settings;
+	private final S2AEsvParser _esvParser;
+	private final String _strategoEntry;
+	private final String _buildDir;
+	private final String _tmpDir;
+	private final List<String> _externalStrategies = new LinkedList<String>();
+	private final String outputJar = "prog.jar";
+
+	public S2AJavaGenerator(S2ASettings pSettings) throws IOException, S2ASpoofaxSetupException
+	{
+		_tmpDir = System.getProperty("java.io.tmpdir") + "/s2atmp/";
+		_buildDir = _tmpDir + "jbuild";
+		_settings = pSettings;
+		String esvFile = S2ASpoofaxInfo.GetEsvSettings(_settings.SpoofaxProjectDir);
+		_esvParser = new S2AEsvParser(esvFile);
+		_strategoEntry = "spoofax2acejava.str";
+		InitExternalJava();
+	}
+	
+	/*
+	 * Place external strategies in this list 
+	 */
+	
+	private void InitExternalJava()
+	{
+		_externalStrategies.add("start_task_0_1.java");
+		_externalStrategies.add("finished_task_0_1.java");
+		_externalStrategies.add("record_task_0_4.java");
+		_externalStrategies.add("record_current_heap_size_0_4.java");
+		_externalStrategies.add("StatsCollector.java");
+	}
+	
+	public boolean Build(String outputPath) throws S2ASpoofaxSetupException, S2ACompilerException, IOException, InterruptedException
+	{
+		if (!new File(outputPath).mkdirs() || !new File(outputPath).canWrite())
+		{
+			System.err.println("No or output specified (\""+outputPath+"\")");
+			outputPath = System.getProperty("java.io.tmpdir") + "/s2atmp/s2aserver/";
+			System.err.println("Defaulting to: " + outputPath);
+		}
+		
+		S2AJavaEntryPoint.GenerateS2AEntry(this.getClass(), _tmpDir + _strategoEntry, _esvParser);
+		new S2AJavaCompiler(_tmpDir, _buildDir).CompileEntrypointToJava(
+				_esvParser.GetCtreeName(), _tmpDir + _strategoEntry,  
+					_settings.StrategoCtreePath, _settings.StrategoLibPath, _externalStrategies);
+		BuildJar(outputJar);
+		PackRequiredJars(outputPath);
+		return true;
+	}
+	
+	private void PackRequiredJars(String atPath) throws IOException
+	{
+		new File(atPath).mkdirs();
+		S2AUtils.EmptyDir(atPath);
+		S2AUtils.WriteFileToFile(outputJar, atPath+"/prog.jar");
+		S2AUtils.WriteFileToFile("strategoxt.jar", atPath+"/strategoxt.jar");
+		S2AUtils.WriteFileToFile(_tmpDir + _esvParser.GetCtreeName() + ".jar", atPath+"/"+_esvParser.GetCtreeName() + ".jar");
+		if (new File(_tmpDir + _esvParser.GetCtreeName() + "-java.jar").exists())
+			S2AUtils.WriteFileToFile(_tmpDir + _esvParser.GetCtreeName() + "-java.jar", atPath+"/"+_esvParser.GetCtreeName() + "-java.jar");
+	}
+	
+	
+	/*
+	 * Function produces a jar file with suitable manifest 
+	 */
+
+	private void BuildJar(String outputJar) throws IOException, InterruptedException, S2ACompilerException
+	{
+		System.err.println("Building jar...");
+		FileOutputStream fstream = new FileOutputStream(_tmpDir + "MANUFEST.MF");
+		S2AUtils.WriteStringToStream("Manifest-Version: 1.0\n", fstream);
+		S2AUtils.WriteStringToStream("Main-Class: jbuild\n", fstream);
+		S2AUtils.WriteStringToStream("Class-Path: strategoxt.jar "+_esvParser.GetCtreeName()+"-java.jar \n", fstream);
+		fstream.flush();
+		fstream.close();
+		S2AUtils.ExecCommandLine(_tmpDir, "jar cf " + outputJar + " " +
+		"" + _tmpDir + "/" +	"MANUFEST.MF " + 
+		"-C " + _buildDir + " ." +
+		"");
+	}
+	
+	
+}
+
+
+
+

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/IS2AJSEntryPoint.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/IS2AJSEntryPoint.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,8 @@
+package spoofax.ace.generate.javascript;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+
+public interface IS2AJSEntryPoint {
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException;
+}
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AAceEditorGenerator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AAceEditorGenerator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,48 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.File;
+import java.io.IOException;
+
+import spoofax.ace.S2ASettings;
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.exceptions.S2AValidatorException;
+import spoofax.ace.exceptions.S2AWrapperException;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2AAceEditorGenerator extends S2AJSGenerator 
+{
+	private String testSourcefile;
+
+	public S2AAceEditorGenerator(S2ASettings settings, String pTestSourceFile) throws IOException, S2ASpoofaxSetupException {
+		super(settings);
+		testSourcefile = pTestSourceFile;
+		
+	} 
+	
+	
+	/*
+	 * Outputs an implementation of the ACE editor 
+	 */
+	public boolean Build(String wwwoutput) throws S2ASpoofaxSetupException, S2AWrapperException, S2ACompilerException, S2AValidatorException, IOException
+	{
+		final String aceWorkerBin = tmpDir+"/aceworker.js";
+		if (!new File(wwwoutput).canWrite())
+		{
+			System.err.println("No or invalid www output specified (\""+wwwoutput+"\")");
+			wwwoutput = System.getProperty("java.io.tmpdir") + "/s2awwwout/";
+			System.err.println("Defaulting to: " + wwwoutput);
+		}
+		
+		BuildStrProgram();
+		WrapStratego(jsbin, wrappedJsBin, true);
+		WrapAceWorker(wrappedJsBin, aceWorkerBin);
+		BuildAceBackend(aceWorkerBin, wwwoutput);
+		S2AUtils.WriteFileToFile(wrappedJsBin, wwwoutput+"/src/jsbin.wrapped.js");
+		BuildAceFrontEnd(wwwoutput, testSourcefile);
+		System.err.println("S2A Successfully built editor into: " + new File(wwwoutput).getAbsolutePath());
+		System.err.println("  Run with:  (cd "+new File(wwwoutput).getAbsolutePath()+"; ./static.py)");
+		return true;
+	}	
+
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2ACloud9PluginGenerator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2ACloud9PluginGenerator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,58 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.File;
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.S2ASettings;
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.exceptions.S2AValidatorException;
+import spoofax.ace.exceptions.S2AWrapperException;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2ACloud9PluginGenerator extends S2AJSGenerator 
+{
+
+	public S2ACloud9PluginGenerator(S2ASettings settings) throws IOException, S2ASpoofaxSetupException {
+		super(settings);
+	} 
+	
+	public boolean Build(String cloud9Path) throws S2ASpoofaxSetupException, S2AWrapperException, S2ACompilerException, S2AValidatorException, IOException
+	{
+		final String cloud9StrProg = tmpDir+"/strategoprog.js";
+		if (!new File(cloud9Path).canWrite())
+		{
+			System.err.println("No or invalid www output specified (\""+cloud9Path+"\")");
+			cloud9Path = System.getProperty("java.io.tmpdir") + "/s2atmp/cloud9/";
+			System.err.println("Defaulting to: " + cloud9Path);
+		}
+		
+		final String cloud9AceRoot = cloud9Path+"/support/ace/lib/ace/";
+		
+		BuildStrProgram();
+		WrapStratego(jsbin, wrappedJsBin, true);
+		new File(wrappedJsBin).renameTo(new File(cloud9StrProg));
+		new File(cloud9AceRoot).mkdirs();
+		new File(cloud9AceRoot+"/strategoprog.js").delete();
+		
+		FileOutputStream strategoProg;
+		try
+		{
+			strategoProg = new FileOutputStream(cloud9AceRoot+"/strategoprog.js", true);
+			S2AUtils.WriteStringToStream("define(function(require, exports, module) {\n", strategoProg);
+			S2AUtils.WriteFileToStream(cloud9StrProg, strategoProg);
+			S2AUtils.WriteStringToStream("\n});", strategoProg);
+			
+			strategoProg.flush();
+			strategoProg.close();
+		}
+		catch (Exception e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();
+		}
+		System.err.println("Done! (Warning - not implemented dropdown menu appending yet)");
+		return true;
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointMeasure.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointMeasure.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,79 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entry point with profiler start/stop statement targetted for Chrome. 
+ */
+public class S2AJSEntryPointMeasure implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+	        
+	        /*
+	        "      where print-elapsed(testast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source (PRE RUN)\")\n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(testast, \"\", \"\")|\"PRE CACHE RUN Analyzed source\") \n" +
+	        "      where print-elapsed(testast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source (PRE RUN)\")\n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(testast, \"\", \"\")|\"PRE CACHE RUN Analyzed source\") \n" +
+	        */
+	        
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.StartWork('js_parse'); ] \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.FinishedWork('js_parse'); ] \n" +
+	        "      where max-depth := <max-depth>ast \n" +
+	        "      where max-depths-summed := <max-depths-summed>ast \n"+
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'CharsOfCode', [ <strlen>sourcecode ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +	        
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'TermSize', [ <term-size>ast ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'MaxDepth', [ max-depth ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_parse', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_parse', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_parse', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.StartWork('js_analyze'); ] \n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.FinishedWork('js_analyze'); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'CharsOfCode', [ <strlen>sourcecode ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'TermSize', [ <term-size>ast ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'MaxDepth', [ max-depth ]); ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordData('js_analyze', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_analyze', '"+esvParser.GetCtreeName()+"', 'LinesOfCode', [ <linecount-in-string>sourcecode ]); ] \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ StrategoJSDataCollect.RecordHeapSize('memsize_after_js_analyze', '"+esvParser.GetCtreeName()+"', 'MaxDepthS', [ max-depths-summed ]); ] \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfile.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfile.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,55 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint with measurements 
+ */
+public class S2AJSEntryPointProfile implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ console.profile('Parsing'); ] \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profileEnd();  ] \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profile('Analyze'); ] \n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profileEnd();  ] \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfileOnlySyntax.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointProfileOnlySyntax.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,52 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint with measurements 
+ */
+public class S2AJSEntryPointProfileOnlySyntax implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+			"      where <prim(\"SSL_eval_js\")>$[ console.profile('Parsing'); ] \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where <prim(\"SSL_eval_js\")>$[ console.profileEnd();  ] \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [[], [], []]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointRelease.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointRelease.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,51 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint without measurements 
+ */
+public class S2AJSEntryPointRelease implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where print-elapsed((ast2,errors,warnings,notes) := <"+esvParser.GetSemanticObserverStrategy()+">(ast, \"\", \"\")|\"Analyzed source\") \n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointReleaseOnlySyntax.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSEntryPointReleaseOnlySyntax.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,50 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.FileOutputStream;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.utils.S2AUtils;
+
+
+/*
+ * Generates an entypoint without measurements 
+ */
+public class S2AJSEntryPointReleaseOnlySyntax implements IS2AJSEntryPoint {
+	/*
+	 * Generates a stratego file which calls the original editor-analyze
+	 * Strategy results in a ace parseable JS object
+	 */ 
+	public void GenerateS2AEntry(@SuppressWarnings("rawtypes") Class owner, String entryFile, S2AEsvParser esvParser) throws S2ASpoofaxSetupException
+	{
+		try
+		{
+			String strategoMain =
+			"module spoofax2ace\n" +
+			"imports\n" + 
+	        "libstratego-lib\n" +
+	        esvParser.GetCtreeName() + "\n" +
+	        "  rules\n" +
+	        "    main: \n" +
+	        "      [sourcecode,x] -> <print-elapsed(<real-main>sourcecode|\"Total time worked\")> \n" +
+	        "\n" +
+	        "    real-main: sourcecode -> acetokens    \n" +
+	        "      where print-elapsed(table := <import-term("+esvParser.GetTableName()+")>|\"Loaded parsetable\") \n" +
+	        "      where print-elapsed(parser := <prim(\"JSSGLR_GET_PARSER\")>table|\"Loaded parser\") \n" +
+	        "      where print-elapsed(ast := <prim(\"JSSGLR_PARSE_STRING\",parser)>sourcecode|\"Parsed source\")\n" +
+	        "      where print-elapsed(acetokens := <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [[], [], []]) | \"Tokenized\") \n" +
+	        ""
+			;
+			FileOutputStream fstream = new FileOutputStream(entryFile);
+			S2AUtils.WriteStringToStream(strategoMain, fstream);
+			S2AUtils.WriteResourceToStream(owner, "/stratego/S2Alib.str", fstream);
+			fstream.flush();
+			fstream.close();
+		} catch (IOException e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ASpoofaxSetupException();			
+		}
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,283 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.File;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.io.PrintStream;
+import java.security.Permission;
+import s2js.s2js; //make sure cp contains strategoxt.jar
+import spoofax.ace.S2ASettings;
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.exceptions.S2AValidatorException;
+import spoofax.ace.exceptions.S2AWrapperException;
+import spoofax.ace.generate.S2AGenerator;
+import spoofax.ace.spoofaxinfo.S2AEsvParser;
+import spoofax.ace.spoofaxinfo.S2ASpoofaxInfo;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2AJSGenerator extends S2AGenerator {
+	
+	protected final S2ASettings _settings;
+	
+	protected final String tmpDir;
+	protected final String jsbin;
+	protected final String wrappedJsBin;
+	protected final String strategoEntry;
+	protected final String esvFile;
+	protected final S2AEsvParser esvParser;
+	protected final IS2AJSEntryPoint entryPointGenerator;
+	 
+	
+	protected S2AJSGenerator(S2ASettings pSettings) throws IOException, S2ASpoofaxSetupException
+	{
+		_settings = pSettings;
+		tmpDir = System.getProperty("java.io.tmpdir") + "/s2atmp/";
+		jsbin = tmpDir+"/jsbin.js";
+		wrappedJsBin =  tmpDir+"/jsbin.wrapped.js";
+		strategoEntry = tmpDir + "spoofax2ace.str";
+		esvFile = S2ASpoofaxInfo.GetEsvSettings(_settings.SpoofaxProjectDir);
+		esvParser = new S2AEsvParser(esvFile);
+		new File(tmpDir.substring(0,tmpDir.lastIndexOf(File.separator))).mkdirs();
+		S2AUtils.EmptyDir(tmpDir);
+		
+		entryPointGenerator = new S2AJSEntryPointRelease();
+		//entryPointGenerator = new S2AJSEntryPointProfile();
+		//entryPointGenerator = new S2AJSEntryPointReleaseOnlySyntax();
+		//entryPointGenerator = new S2AJSEntryPointProfileOnlySyntax();
+	}
+	
+	
+	/*
+	 * Makes sure required files are available and compiles the back-end Stratego program.
+	 */
+	
+	protected void BuildStrProgram() throws S2ASpoofaxSetupException, S2AWrapperException, S2ACompilerException, S2AValidatorException, IOException
+	{
+		CacheRequiredFiles(tmpDir, esvParser);
+		entryPointGenerator.GenerateS2AEntry(getClass(), strategoEntry, esvParser);
+		CompileStratego2JS(tmpDir, strategoEntry, jsbin);
+	}
+	
+	/*
+	 * Copies the required files (ctree, tbl) to @cacheDir. 
+	 */
+	private void CacheRequiredFiles(String cacheDir, S2AEsvParser esv) throws S2ASpoofaxSetupException
+	{
+		try 
+		{
+			if (S2AUtils.FilesToDest(_settings.SpoofaxProjectDir + "/include", cacheDir, ".tbl") == 0)
+				throw new Exception("No table files present in include folder");
+			if (S2AUtils.FilesToDest(_settings.SpoofaxProjectDir + "/include", cacheDir, ".pp.af") == 0)
+				throw new Exception("No pp.af files present in include folder");
+		    if (S2AUtils.FilesToDest(_settings.SpoofaxProjectDir + "/include", cacheDir, ".ctree") == 0)
+		    	throw new Exception("No ctree files present in include folder");
+		    if (S2AUtils.FilesToDest(_settings.SpoofaxProjectDir + "/include", cacheDir, ".jar") == 0)
+		    	throw new Exception("No jar files present in include folder");
+		} catch (Exception e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			System.err.println("Make sure the spoofax project's ant build has run both the ctree and jar target");
+			throw new S2ASpoofaxSetupException();
+		}
+	}
+	
+	/*
+	 * Places the required files for an ACE editor in the www output directory.  
+	 */
+
+	protected void BuildAceBackend(String wrappedAceWorker, String wwwroot) throws S2AWrapperException
+	{
+		System.err.println("Building ace editor backend...");
+		try {
+			S2AUtils.EmptyDir(wwwroot);
+			new File(wwwroot).mkdirs();
+			new File(wwwroot+"/src").mkdirs();
+			S2AUtils.WriteResourceToFile(getClass(), "/ace/require.js", wwwroot+"/require.js");
+			S2AUtils.WriteResourceToFile(getClass(), "/ace/static.py", wwwroot+"/static.py");
+			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/ace-uncompressed.js", wwwroot+"/src/ace-uncompressed.js");
+			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/mode-spoofax2ace.js", wwwroot+"/src/mode-spoofax2ace.js");
+			//S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-dawn.js", wwwroot+"/src/theme-dawn.js");
+			S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-dawn-original.js", wwwroot+"/src/theme-dawn.js");
+			//S2AUtils.WriteResourceToFile(getClass(), "/ace/src/theme-eclipse.js", wwwroot+"/src/theme-eclipse.js");
+			S2AUtils.WriteFileToFile(wrappedAceWorker, wwwroot+"/src/worker-spoofax2ace.js");
+			new File(wwwroot+"/static.py").setExecutable(true, false);
+		} catch (IOException e) {
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2AWrapperException();
+		}		
+	}
+	
+	/*
+	 *  Builds the ACE frontent. (html file) with an example program from testSrcPath  
+	 */
+	
+	protected void BuildAceFrontEnd(String wwwroot, String testSrcPath) throws S2AWrapperException
+	{
+		System.err.println("Building ace editor based on " + testSrcPath);
+		try
+		{
+			{
+				FileOutputStream editorFrontend = new FileOutputStream(wwwroot+"/editor.html", true);
+				S2AUtils.WriteResourceToStream(getClass(), "/html/editor_prepend.html", editorFrontend);	
+				if (new File(testSrcPath).exists())
+					S2AUtils.WriteFileToStream(testSrcPath, editorFrontend);
+				S2AUtils.WriteResourceToStream(getClass(), "/html/editor_append.html", editorFrontend);
+				editorFrontend.flush();
+				editorFrontend.close();
+				S2AUtils.WriteResourceToFile(getClass(), "/html/underline.gif", wwwroot+"/underline.gif");				
+			}
+			
+			//Also output a simple html file which does not rely on requireJS (requireJS is an issue for JS profilers)
+			{
+				FileOutputStream profilableFrontend = new FileOutputStream(wwwroot+"/test.html", true);
+				S2AUtils.WriteResourceToStream(getClass(), "/html/test_prepend.html", profilableFrontend);	
+				if (new File(testSrcPath).exists())
+					S2AUtils.WriteFileToStream(testSrcPath, profilableFrontend);
+				S2AUtils.WriteResourceToStream(getClass(), "/html/test_append.html", profilableFrontend);
+				profilableFrontend.flush();
+				profilableFrontend.close();
+			}
+			
+		}  catch (IOException e) {
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2AWrapperException();
+		}	
+	}
+	
+	/*
+	 * Turns the stratego program into an ace-worker  
+	 */
+	
+	protected void WrapAceWorker(String wrappedStrprog, String wrappedAceWorker) throws S2AWrapperException
+	{
+		FileOutputStream wrappedAceWorkerStrm;
+		try {
+			wrappedAceWorkerStrm = new FileOutputStream(wrappedAceWorker, true);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/aceworker/worker-spoofax2ace-prepend-new.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/partitioner.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/s2aclient.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/s2alocal.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/stats.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteFileToStream(wrappedStrprog, wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/aceworker/worker-spoofax2ace-append.js", wrappedAceWorkerStrm);
+			wrappedAceWorkerStrm.flush();
+			wrappedAceWorkerStrm.close();
+		} catch (IOException e) {
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2AWrapperException();
+		}		
+	}
+	
+	/*
+	 * Wraps the generated stratego program with dependencies from the stratego-javascript-backend.
+	 * Also adds an jssglr parser implementation. 
+	 * 
+	 * Use param @wrapForAce to specify whether to wrap for Ace or a Cli executable.  
+	 */
+	
+	
+	
+	protected void WrapStratego(String strProg, String wrappedJs, boolean wrapForAce) throws S2AWrapperException
+	{
+		FileOutputStream wrappedStrProg;
+		try {
+			wrappedStrProg = new FileOutputStream(wrappedJs, true);
+			
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/measurements.js", wrappedStrProg);
+			
+			S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/strategojs.js", wrappedStrProg);
+			S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/terms.js", wrappedStrProg);
+			S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/srts.js", wrappedStrProg);
+			S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/ssl.js", wrappedStrProg);
+			if (!wrapForAce)
+				S2AUtils.WriteStringToStream("var navigator = { userAgent: \"node-js\" }; \n", wrappedStrProg);//Nodejs gwt'd jssglr workaround
+			
+			S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/jssglr/jssglr_prepend.js", wrappedStrProg);
+			S2AUtils.WriteFileToStream(_settings.JssglrImplementation, wrappedStrProg);
+			S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/jssglr/jssglr_append.js", wrappedStrProg);
+			S2AUtils.WriteFileToStream(strProg, wrappedStrProg);
+			if (wrapForAce)
+				S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/ace-wrapper-end.js", wrappedStrProg);
+			else
+				S2AUtils.WriteFileToStream(_settings.Str2JSPath + "/src/javascript/cli-wrapper.js", wrappedStrProg);
+			wrappedStrProg.flush();
+		} catch (IOException e) {
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2AWrapperException();
+		}
+	}
+	
+	/*
+	 * Actually compiles the stratego associated with the project's semantic check. 
+	 * Expects the file at @strategoProg to contain a `main` strategy    
+	 */
+	
+	private void CompileStratego2JS(String tmpDir, String strategoProg, String jsOutput) throws S2ACompilerException
+	{
+		System.err.println("Compiling the stratego program...");
+		String arg =
+        "-i " + strategoProg + " " +
+		"-la stratego-lib -la stratego-gpp -la stratego-rtg " +
+        "-I " + _settings.SpoofaxProjectDir + " " +
+		"-I " + _settings.StrategoCtreePath + " " +
+		"-I " + _settings.StrategoLibPath + "" +
+		"";
+		
+		System.err.println("Args:");
+		System.err.println(arg);
+		
+		 
+		PrintStream buOut = System.out;
+		PrintStream buErr = System.err;
+		PrintStream outp = null;
+		PrintStream errp = null;
+		try
+		{
+			outp = new PrintStream(jsOutput);
+			errp = new PrintStream(tmpDir+"/compiler_javascript.log");
+		} catch (Exception e)
+		{
+			System.err.println("###CRITICAL ERROR### " + e.getMessage());
+			throw new S2ACompilerException();
+		}
+		
+		//Capture the dump of the js file into the jsOutput file and set err printstream to a buffer to avoid console spamming
+		System.setOut(outp);
+		System.setErr(errp);
+		
+		//Catch the System.exit call from s2j; We're not done after the compiler has finished.
+		System.setSecurityManager(securityManager);
+		try {
+			s2js.main(arg.split(" "));
+		} catch( ExitTrappedException e ) {
+		} finally {
+			System.setSecurityManager(null);
+		}
+		
+		//Restore original output printstreams
+		System.setOut(buOut);
+		System.setErr(buErr);
+		
+		//Check whether a js file was created
+		if (new File(jsOutput).length() == 0L)
+		{
+			System.err.println("###CRITICAL ERROR### " + "Empty or no output file found.\n\nSee "+tmpDir+"compiler.log for details.");
+			throw new S2ACompilerException();
+		}
+		System.err.println("Finished compiling the stratego program.");
+	}
+	
+	/* -hack- throw custom exception when System.exit is called. */
+	private static class ExitTrappedException extends SecurityException { private static final long serialVersionUID = 1L; }
+	final SecurityManager securityManager = new SecurityManager() {
+		public void checkPermission(Permission permission) {
+			if (permission.getName().startsWith("exitVM")) {
+				throw new ExitTrappedException();
+			}
+		}
+	};
+	
+}
+
+

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2ANodeJSExecutableGenerator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2ANodeJSExecutableGenerator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,38 @@
+package spoofax.ace.generate.javascript;
+
+import java.io.File;
+import java.io.IOException;
+
+import spoofax.ace.S2ASettings;
+import spoofax.ace.exceptions.S2ACompilerException;
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+import spoofax.ace.exceptions.S2AValidatorException;
+import spoofax.ace.exceptions.S2AWrapperException;
+import spoofax.ace.utils.S2AUtils;
+
+public class S2ANodeJSExecutableGenerator extends S2AJSGenerator 
+{
+
+	public S2ANodeJSExecutableGenerator(S2ASettings settings) throws IOException, S2ASpoofaxSetupException {
+		super(settings);
+	}
+	
+	/*
+	 * Outputs a .js file which can be executed using NodeJS from the command line.
+	 * Useful for tests or debugging 
+	 */ 
+	
+	public boolean Build(String outputFile) throws S2ASpoofaxSetupException, S2AWrapperException, S2ACompilerException, S2AValidatorException, IOException
+	{
+		BuildStrProgram();
+		WrapStratego(jsbin, wrappedJsBin, false);
+		S2AUtils.WriteFileToFile(wrappedJsBin, outputFile);
+		System.err.println("S2A Successfully built NodeJS executable: " + new File(outputFile).getAbsolutePath());
+		System.err.println("Call using: node <executable.js> <language source code>");
+		System.err.println("example: ");
+		String exSrc = "/path/to/source.file";
+		System.err.println("  node debug " + new File(outputFile).getName() + " \"$(cat "+exSrc+")\"");
+		return true;
+	}	
+
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/S2AEsvParser.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/S2AEsvParser.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,82 @@
+package spoofax.ace.spoofaxinfo;
+
+import java.io.File;
+import java.io.IOException;
+import java.util.LinkedList;
+import java.util.List;
+
+import org.spoofax.interpreter.terms.IStrategoAppl;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.terms.TermFactory;
+import org.spoofax.terms.io.binary.TermReader;
+
+
+/*
+ * Class retrieves some key information from a Spoofax project settings pack. 
+ */
+
+public class S2AEsvParser {
+	private final String _esvFile;
+	private final TermReader _termReader;
+	private final IStrategoTerm _rootTerm;
+	
+	public S2AEsvParser(String esvFile) throws IOException
+	{
+		_esvFile = esvFile;
+		_termReader = new TermReader(new TermFactory());
+		_rootTerm = _termReader.parseFromFile(_esvFile);
+	}
+	
+	public String GetTableName()
+	{
+		List<IStrategoTerm> result = new LinkedList<IStrategoTerm>();
+		result = FindApplMatches(_rootTerm, "Table", result);
+		String res = result.get(0).getSubterm(0).toString().replaceAll("\"", "");
+		return res;
+	}
+	
+	public String GetCtreeName()
+	{
+		String fn = new File(GetSemanticProviderCtree()).getName();
+		int index = fn.lastIndexOf('.');
+		return fn.substring(0, index);
+	}
+	
+	public String GetSemanticProviderCtree()
+	{
+		List<IStrategoTerm> result = new LinkedList<IStrategoTerm>();
+		result = FindApplMatches(_rootTerm, "SemanticProvider", result);
+		return result.get(0).getSubterm(0).toString();
+	}
+	
+	public String GetSemanticObserverStrategy()
+	{
+		List<IStrategoTerm> result = new LinkedList<IStrategoTerm>();
+		result = FindApplMatches(_rootTerm, "SemanticObserver", result);
+		return result.get(0).getSubterm(0).getSubterm(0).toString().replaceAll("\"", "");
+	}
+
+	public String GetSemanticHoverRuleStrategy()
+	{
+		List<IStrategoTerm> result = new LinkedList<IStrategoTerm>();
+		result = FindApplMatches(_rootTerm, "HoverRule", result);
+		return result.get(0).getSubterm(1).getSubterm(0).toString().replaceAll("\"", "");
+	}
+	
+	public String GetCompletionStrategy()
+	{
+		List<IStrategoTerm> result = new LinkedList<IStrategoTerm>();
+		result = FindApplMatches(_rootTerm, "CompletionProposer", result);
+		return result.get(0).getSubterm(0).getSubterm(0).toString().replaceAll("\"", "");
+	}
+		
+	private List<IStrategoTerm> FindApplMatches(IStrategoTerm visitable, String applName, List<IStrategoTerm> results)
+	{
+		if (visitable.getTermType() == IStrategoTerm.APPL)
+			if (((IStrategoAppl) visitable).getName().equals(applName))
+				results.add((IStrategoTerm)visitable);
+		for (int i = 0; i < visitable.getSubtermCount(); i++)
+			FindApplMatches(visitable.getSubterm(i), applName, results);
+		return results;
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/S2ASpoofaxInfo.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/spoofaxinfo/S2ASpoofaxInfo.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,28 @@
+package spoofax.ace.spoofaxinfo;
+
+import java.io.File;
+
+import spoofax.ace.exceptions.S2ASpoofaxSetupException;
+
+public class S2ASpoofaxInfo {
+	
+	/* 
+	 * Locates the packed .esv file in a spoofax project 
+	 */
+	public static String GetEsvSettings(String spoofaxProj) throws S2ASpoofaxSetupException
+	{
+		if (!new File(spoofaxProj + "/include").exists())
+		{
+			System.err.println("FATAL Error - Directory " + spoofaxProj + "/include/ does not exist.");
+			throw new S2ASpoofaxSetupException();
+		}
+		File dir = new File(spoofaxProj + "/include");
+		for (String file : dir.list())
+		{
+			if (file.endsWith("packed.esv"))
+				return spoofaxProj + "/include/" +file;
+		}
+		System.err.println("FATAL Error - Could not find a *.packed.esv in " + spoofaxProj + "/include/");
+		throw new S2ASpoofaxSetupException();
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/utils/S2AUtils.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/utils/S2AUtils.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,123 @@
+package spoofax.ace.utils;
+
+import java.io.File;
+import java.io.FileInputStream;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.io.InputStream;
+
+import spoofax.ace.exceptions.S2ACompilerException;
+
+public class S2AUtils {
+	private final static int BUFSIZE = 1024;
+	
+	public static void WriteFileToFile(String filesrc, String filedest) throws IOException
+	{
+		System.err.println("Copying to file: " + filedest);
+		FileOutputStream dst = new FileOutputStream(filedest, true);
+		InputStream src =new FileInputStream(filesrc);
+		byte[] b = new byte[BUFSIZE];
+		int len;
+		while ((len = src.read(b)) != -1)
+			dst.write(b, 0, len);
+		dst.flush();
+		dst.close();
+	}
+	
+	public static void WriteResourceToFile(@SuppressWarnings("rawtypes") Class owner, String resource, String filename) throws IOException
+	{
+		System.err.println("Writing file: " + resource);
+		FileOutputStream fo = new FileOutputStream(filename, true);
+		InputStream br = owner.getResourceAsStream(resource);
+		byte[] b = new byte[BUFSIZE];
+		int len;
+		while ((len = br.read(b)) != -1)
+			fo.write(b, 0, len);
+		fo.flush();
+		fo.close();
+	}
+	
+	
+	public static FileOutputStream WriteResourceToStream(@SuppressWarnings("rawtypes") Class owner, String resource, FileOutputStream stream) throws IOException
+	{
+		System.err.println("Merging with: " + resource);
+		InputStream br = owner.getResourceAsStream(resource);
+		byte[] b = new byte[BUFSIZE];
+		int len;
+		while ((len = br.read(b)) != -1)
+			stream.write(b, 0, len);
+		return stream;
+	}
+	
+	public static FileOutputStream WriteFileToStream(String file, FileOutputStream stream) throws IOException
+	{
+		System.err.println("Merging with: " + file);
+		FileInputStream src = new FileInputStream(file);
+		byte[] b = new byte[BUFSIZE];
+		int len;
+		while ((len = src.read(b)) != -1)
+			stream.write(b, 0, len);
+		return stream;
+	}
+	
+	public static FileOutputStream WriteStringToStream(String str, FileOutputStream stream) throws IOException
+	{
+		for (int i = 0; i < str.length(); i++)
+			stream.write(str.charAt(i));
+		return stream;
+	}
+	
+	public static int FilesToDest(String srcPath, String destPath, String withSuffix) throws IOException
+	{
+		int count = 0;
+		File dir = new File(srcPath);
+		for (String file : dir.list())
+		{
+			if (file.endsWith(withSuffix))
+			{
+				WriteFileToFile(srcPath + "/" +file, destPath + "/" + file);
+				count++;
+			}
+		}
+		return count;
+	}
+	
+	public static boolean EmptyDir(String path)
+	{
+		File p = new File(path);
+		if (!p.exists())
+			return false;
+		System.err.println("Emptying dir: " + path);
+		boolean r = true;
+		for (File f : p.listFiles()) 
+		{
+			if (f.isDirectory())
+				EmptyDir(f.getAbsolutePath());
+			else
+				r = r && f.delete();
+		}
+		return r;
+	}
+	
+	public static void ExecCommandLine(String tmpDir, String command) throws IOException, S2ACompilerException, InterruptedException
+	{
+		System.err.println("Executing");
+		System.err.println("  " + command);
+		ProcessBuilder pb = new ProcessBuilder(command.split(" "));
+		pb.redirectErrorStream(true);
+		//pb.redirectOutput(new File(tmpDir+"/cli_output.txt")); //Only available in java 7 (won't build on nixos)
+		Process proc = pb.start();
+		int exitVal = proc.waitFor();
+		if (exitVal != 0)
+		{
+			System.err.println(exitVal + ": Error - Cli executed command returned error code.");
+			//System.err.println("Check for details:");
+			//System.err.println(tmpDir + "cli_output.txt");
+			throw new S2ACompilerException();
+		}
+	}
+	
+			
+	
+	
+}

Added: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/validator/S2AValidator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/validator/S2AValidator.java	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,42 @@
+package spoofax.ace.validator;
+
+import java.io.BufferedReader;
+import java.io.FileReader;
+import java.io.IOException;
+
+import spoofax.ace.exceptions.S2AValidatorException;
+
+public class S2AValidator {
+	
+	/* 
+	 *   Makes sure the stratego file which was pointed at contains a required entry strategy.
+	 *   This validator returns a false positive if the strategy is commented out in the source file.
+	 */
+	public static void ValidateS2AEntryPoint(String strategoSrc) throws S2AValidatorException
+	{
+		final String mainDef = "main: [sourcecode,x] -> <prim(\"JSSGLR_ACE_TOKENIZE\", parser)>(ast, [errors, warnings, notes])"; 
+		
+		System.err.println("Validating entry point: " + strategoSrc);
+		boolean ok = false;
+		BufferedReader br = null;
+		try {
+			br = new BufferedReader(new FileReader(strategoSrc));
+			String line = null;
+			while ((line = br.readLine()) != null)
+			{
+				if (line.contains(mainDef))
+					ok = true;
+			}
+		} catch (IOException e) {
+			e.printStackTrace();
+			throw new S2AValidatorException();
+		}
+		
+		if (!ok)	
+		{
+			System.err.println("Entry point " + strategoSrc + " does not contain required strategy of the following form:");
+			System.err.println("'" + mainDef + "'");
+			throw new S2AValidatorException();
+		}
+	}
+}

Added: spoofax-ace/trunk/spoofax-ace/tests/Makefile
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/Makefile	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,28 @@
+TIGERTESTS := $(wildcard tiger/*.tig)
+TIGERTESTRUNS   := $(subst .tig,.tiger.run,$(TIGERTESTS))
+
+ENTLANGTESTS := $(wildcard entlang/*.tes)
+ENTLANGTESTRUNS   := $(subst .tes,.entlang.run,$(ENTLANGTESTS))
+
+MOBLTESTS := $(wildcard moblgen/*.mobl)
+MOBLTESTRUNS   := $(subst .mobl,.mobl.run,$(MOBLTESTS))
+
+
+ALLTESTS := $(TIGERTESTRUNS) $(ENTLANGTESTRUNS)  $(MOBLTESTRUNS)
+
+all:	$(ALLTESTS)
+tiger: 	$(TIGERTESTRUNS)
+entlang:$(ENTLANGTESTRUNS)
+mobl:	$(MOBLTESTRUNS)
+
+%.tiger.run :
+	./runnode.sh tiger.js $*.tig
+	./runnative.sh tiger $*.tig
+
+%.entlang.run :
+	./runnode.sh entlang.js $*.tes
+
+%.mobl.run :
+#	./runnode.sh mobl.js $*.mobl
+	./runnode.sh moblgwt.js $*.mobl
+	./runnative.sh mobl $*.mobl

Added: spoofax-ace/trunk/spoofax-ace/tests/XMLHttpRequest.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/XMLHttpRequest.js	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,364 @@
+/**
+ * Wrapper for built-in http.js to emulate the browser XMLHttpRequest object.
+ *
+ * This can be used with JS designed for browsers to improve reuse of code and
+ * allow the use of existing libraries.
+ *
+ * Usage: include("XMLHttpRequest.js") and use XMLHttpRequest per W3C specs.
+ *
+ * @todo SSL Support
+ * @author Dan DeFelippi <dan at driverdan.com>
+ * @contributor David Ellis <d.f.ellis at ieee.org>
+ * @license MIT
+ */
+
+var Url = require("url"),
+  spawn = require("child_process").spawn,
+  fs = require('fs');
+
+exports.XMLHttpRequest = function() {
+  /**
+   * Private variables
+   */
+  var self = this;
+  var http = require('http');
+  var https = require('https');
+
+  // Holds http.js objects
+  var client;
+  var request;
+  var response;
+
+  // Request settings
+  var settings = {};
+
+  // Set some default headers
+  var defaultHeaders = {
+    "User-Agent": "node.js",
+    "Accept": "*/*",
+  };
+
+  // Send flag
+  var sendFlag = false;
+  // Error flag, used when errors occur or abort is called
+  var errorFlag = false;
+
+  var headers = defaultHeaders;
+
+  /**
+   * Constants
+   */
+  this.UNSENT = 0;
+  this.OPENED = 1;
+  this.HEADERS_RECEIVED = 2;
+  this.LOADING = 3;
+  this.DONE = 4;
+
+  /**
+   * Public vars
+   */
+  // Current state
+  this.readyState = this.UNSENT;
+
+  // default ready state change handler in case one is not set or is set late
+  this.onreadystatechange = null;
+
+  // Result & response
+  this.responseText = "";
+  this.responseXML = "";
+  this.status = null;
+  this.statusText = null;
+
+  /**
+   * Open the connection. Currently supports local server requests.
+   *
+   * @param string method Connection method (eg GET, POST)
+   * @param string url URL for the connection.
+   * @param boolean async Asynchronous connection. Default is true.
+   * @param string user Username for basic authentication (optional)
+   * @param string password Password for basic authentication (optional)
+   */
+  this.open = function(method, url, async, user, password) {
+    settings = {
+      "method": method,
+      "url": url.toString(),
+      "async": (typeof async !== "boolean" ? true : async),
+      "user": user || null,
+      "password": password || null
+    };
+
+    this.abort();
+
+    setState(this.OPENED);
+  };
+
+  /**
+   * Sets a header for the request.
+   *
+   * @param string header Header name
+   * @param string value Header value
+   */
+  this.setRequestHeader = function(header, value) {
+    if (this.readyState != this.OPENED) {
+      throw "INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN";
+    }
+    if (sendFlag) {
+      throw "INVALID_STATE_ERR: send flag is true";
+    }
+    headers[header] = value;
+  };
+
+  /**
+   * Gets a header from the server response.
+   *
+   * @param string header Name of header to get.
+   * @return string Text of the header or null if it doesn't exist.
+   */
+  this.getResponseHeader = function(header) {
+    if (this.readyState > this.OPENED
+      && response.headers[header]
+      && !errorFlag
+    ) {
+      return response.headers[header];
+    }
+
+    return null;
+  };
+
+  /**
+   * Gets all the response headers.
+   *
+   * @return string 
+   */
+  this.getAllResponseHeaders = function() {
+    if (this.readyState < this.HEADERS_RECEIVED || errorFlag) {
+      return "";
+    }
+    var result = "";
+
+    for (var i in response.headers) {
+      result += i + ": " + response.headers[i] + "\r\n";
+    }
+    return result.substr(0, result.length - 2);
+  };
+
+  /**
+   * Sends the request to the server.
+   *
+   * @param string data Optional data to send as request body.
+   */
+  this.send = function(data) {
+    if (this.readyState != this.OPENED) {
+      throw "INVALID_STATE_ERR: connection must be opened before send() is called";
+    }
+
+    if (sendFlag) {
+      throw "INVALID_STATE_ERR: send has already been called";
+    }
+
+    var ssl = false;
+    var url = Url.parse(settings.url);
+
+    // Determine the server
+    switch (url.protocol) {
+      case 'https:':
+        ssl = true;
+        // SSL & non-SSL both need host, no break here.
+      case 'http:':
+        var host = url.hostname;
+        break;
+
+      case undefined:
+      case '':
+        var host = "localhost";
+        break;
+
+      default:
+        throw "Protocol not supported.";
+    }
+
+    // Default to port 80. If accessing localhost on another port be sure
+    // to use http://localhost:port/path
+    var port = url.port || (ssl ? 443 : 80);
+    // Add query string if one is used
+    var uri = url.pathname + (url.search ? url.search : '');
+
+    // Set the Host header or the server may reject the request
+    this.setRequestHeader("Host", host);
+
+    // Set Basic Auth if necessary
+    if (settings.user) {
+      if (typeof settings.password == "undefined") {
+        settings.password = "";
+      }
+      var authBuf = new Buffer(settings.user + ":" + settings.password);
+      headers["Authorization"] = "Basic " + authBuf.toString("base64");
+    }
+
+    // Set content length header
+    if (settings.method == "GET" || settings.method == "HEAD") {
+      data = null;
+    } else if (data) {
+      this.setRequestHeader("Content-Length", Buffer.byteLength(data));
+
+      if (!headers["Content-Type"]) {
+        this.setRequestHeader("Content-Type", "text/plain;charset=UTF-8");
+      }
+    }
+
+    var options = {
+      host: host,
+      port: port,
+      path: uri,
+      method: settings.method,
+      headers: headers
+    };
+
+    // Reset error flag
+    errorFlag = false;
+
+    // Handle async requests
+    if(!settings.hasOwnProperty("async") || settings.async) {
+      // Use the proper protocol
+      var doRequest = ssl ? https.request : http.request;
+
+      // Request is being sent, set send flag
+      sendFlag = true;
+
+      // As per spec, this is called here for historical reasons.
+      if (typeof self.onreadystatechange === "function") {
+        self.onreadystatechange();
+      }
+
+      // Create the request
+      request = doRequest(options, function(resp) {
+        response = resp;
+        response.setEncoding("utf8");
+
+        setState(self.HEADERS_RECEIVED);
+        self.status = response.statusCode;
+
+        response.on('data', function(chunk) {
+          // Make sure there's some data
+          if (chunk) {
+            self.responseText += chunk;
+          }
+          // Don't emit state changes if the connection has been aborted.
+          if (sendFlag) {
+            setState(self.LOADING);
+          }
+        });
+
+        response.on('end', function() {
+          if (sendFlag) {
+            // Discard the 'end' event if the connection has been aborted
+            setState(self.DONE);
+            sendFlag = false;
+          }
+        });
+
+        response.on('error', function(error) {
+          self.handleError(error);
+        });
+      }).on('error', function(error) {
+        self.handleError(error);
+      });
+
+      // Node 0.4 and later won't accept empty data. Make sure it's needed.
+      if (data) {
+        request.write(data);
+      }
+
+      request.end();
+    } else { // Synchronous
+      // Create a temporary file for communication with the other Node process
+      var syncFile = ".node-xmlhttprequest-sync-" + process.pid;
+      fs.writeFileSync(syncFile, "", "utf8");
+      // The async request the other Node process executes
+      var execString = "var http = require('http'), https = require('https'), fs = require('fs');"
+        + "var doRequest = http" + (ssl?"s":"") + ".request;"
+        + "var options = " + JSON.stringify(options) + ";"
+        + "var responseText = '';"
+        + "var req = doRequest(options, function(response) {"
+        + "response.setEncoding('utf8');"
+        + "response.on('data', function(chunk) {"
+        + "responseText += chunk;"
+        + "});"
+        + "response.on('end', function() {"
+        + "fs.writeFileSync('" + syncFile + "', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');"
+        + "});"
+        + "response.on('error', function(error) {"
+        + "fs.writeFileSync('" + syncFile + "', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"
+        + "});"
+        + "}).on('error', function(error) {"
+        + "fs.writeFileSync('" + syncFile + "', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');"
+        + "});"
+        + (data ? "req.write('" + data.replace(/'/g, "\\'") + "');":"")
+        + "req.end();";
+      // Start the other Node Process, executing this string
+      syncProc = spawn(process.argv[0], ["-e", execString]);
+      while((self.responseText = fs.readFileSync(syncFile, 'utf8')) == "") {
+        // Wait while the file is empty
+      }
+      // Kill the child process once the file has data
+      syncProc.stdin.end();
+      // Remove the temporary file
+      fs.unlinkSync(syncFile);
+      if(self.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)) {
+        // If the file returned an error, handle it
+        var errorObj = self.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/, "");
+        self.handleError(errorObj);
+      } else {
+        // If the file returned okay, parse its data and move to the DONE state
+        self.status = self.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/, "$1");
+        self.responseText = self.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/, "$1");
+        setState(self.DONE);
+      }
+    }
+  };
+
+  this.handleError = function(error) {
+    this.status = 503;
+    this.statusText = error;
+    this.responseText = error.stack;
+    errorFlag = true;
+    setState(this.DONE);
+  };
+
+  /**
+   * Aborts a request.
+   */
+  this.abort = function() {
+    if (request) {
+      request.abort();
+      request = null;
+    }
+
+    headers = defaultHeaders;
+    this.responseText = "";
+    this.responseXML = "";
+
+    errorFlag = true;
+
+    if (this.readyState !== this.UNSENT
+        && (this.readyState !== this.OPENED || sendFlag)
+        && this.readyState !== this.DONE) {
+      sendFlag = false;
+      setState(this.DONE);
+    }
+    this.readyState = this.UNSENT;
+  };
+
+  /**
+   * Changes readyState and calls onreadystatechange.
+   *
+   * @param int state New state
+   */
+  var setState = function(state) {
+    self.readyState = state;
+    if (typeof self.onreadystatechange === "function") {
+      self.onreadystatechange();
+    }
+  };
+};
+

Added: spoofax-ace/trunk/spoofax-ace/tests/entlang/example.tes
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/entlang/example.tes	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,19 @@
+module example
+
+// Example "Test" program (see syntax/Test.sdf for the grammar)
+
+entity User {
+  name     := String
+  password := String
+  homepage := URL
+}
+
+entity BlogPosting {
+  poster := User
+  body   := String
+  body   := String
+}
+
+entity URL {
+  location := String
+}

Added: spoofax-ace/trunk/spoofax-ace/tests/entlang/simple.tes
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/entlang/simple.tes	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1 @@
+module simple
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/moblgen/append
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/moblgen/append	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,2 @@
+
+}

Added: spoofax-ace/trunk/spoofax-ace/tests/moblgen/body
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/moblgen/body	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,10 @@
+  header("Add") {
+    backButton("Back", onclick= { screen return; })
+    button("Add", onclick={
+      add(newTask);
+      screen return;
+    })
+  }
+  group {
+    item { textField(newTask.name, placeholder="Task name") }
+  }

Added: spoofax-ace/trunk/spoofax-ace/tests/moblgen/generate.sh
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/moblgen/generate.sh	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,16 @@
+#!/bin/bash
+
+p="$(cat prepend)"
+b="$(cat body)"
+a="$(cat append)"
+
+content="$p"
+for i in {0..20000}
+do
+	content+="$b"
+	if [ $(( $i % 200 )) -eq 0 ] ;
+	then
+		echo "$content$a" > test$i.mobl
+		echo "Wrote test$i.mobl"
+	fi
+done

Added: spoofax-ace/trunk/spoofax-ace/tests/moblgen/prepend
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/moblgen/prepend	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,5 @@
+application todo
+
+screen addTask() {
+  var newTask = Task()
+

Added: spoofax-ace/trunk/spoofax-ace/tests/runnative.sh
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/runnative.sh	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,2 @@
+#! /bin/bash
+java -cp $1.jar org.mobl.client.EntryPoint $2 | pp-aterm

Added: spoofax-ace/trunk/spoofax-ace/tests/runnode.sh
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/runnode.sh	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1 @@
+node $1  $2 | pp-aterm

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/.node-xmlhttprequest-sync-9994
==============================================================================

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/arrays.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/arrays.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,18 @@
+let 
+
+type vector  = array of int
+
+type matrix = array of vector
+
+var v : vector := vector[3] of 1
+
+var t : matrix := matrix[2] of nil
+
+in for i := 0 to 1 do f
+     t[i] := vector[3] of i;
+   for i := 0 to 1 do
+     for j := 0 to 2 do
+       t[i][j] := i + j;
+   printint(t[1][1])
+   
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/aterm.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/aterm.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,32 @@
+let
+
+type aterm = {fun : string, args : alist}
+type alist = {hd : aterm, tl : alist}
+
+function app(fun: string, args : alist) : aterm =
+  aterm{fun = fun, args = args}
+
+function match(x : aterm, y : aterm) : int =
+  if x = nil then 0
+  else if y = nil then 0
+  else if x.fun = y.fun then match_args(x.args, y.args)
+  else 0
+
+function match_args(xs : alist, ys : alist) : int =
+  if xs <> nil & ys <> nil then
+     match(xs.hd, ys.hd) & match_args(xs.tl,ys.tl)
+  else if xs = nil & ys = nil then 1
+  else 0
+
+function test1() : aterm =
+  app("Succ", alist{hd = app("Zero", nil), tl = nil})
+
+var term : aterm := nil
+
+in
+ 
+   term := test1();
+   print(term.fun)
+   
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/break.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/break.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,17 @@
+let 
+
+  function inttostring(n : int) : string =
+    if n < 10
+    then chr(48 + n)
+    else concat(inttostring(n / 10), inttostring(mod(n, 10)))                     
+
+  var x := 1
+
+in
+
+  while x < 10 do
+    (x := x + 1; print(inttostring(x)); break);
+  print(inttostring(x))
+
+end
+

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test1.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test1.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+let var x : int := 1
+ in printint(x + 2)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test2.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test2.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,6 @@
+let 
+	var n := 0  
+	function fact(n : int) : int =
+      if n = 0 then 1 else n * fact(n - 1)
+ in printint(fact(5))
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test2t.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/eval-test2t.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,36 @@
+/* factorial function; example from SPIM manual */
+
+let 
+
+  var x := 0
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))      
+in 
+
+  for i := 1 to 3 do 
+    (x := x + fact(i);
+     printint(x);
+     print(" "))
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/example.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/example.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1 @@
+let var x := 42 in x end
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/extract.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/extract.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,32 @@
+/* A program to solve the 8-queens problem */
+
+let
+    var N := 8
+
+    type intArray = array of int
+
+    var row := intArray [ N ] of 0
+    var col := intArray [ N ] of 0
+    var diag1 := intArray [N+N-1] of 0
+    var diag2 := intArray [N+N-1] of 0 
+
+    function printboard() =
+       (for i := 0 to N-1
+	 do (for j := 0 to N-1 
+	      do print(if col[i]=j then " O" else " .");
+	     print("\n"));
+         print("\n"))
+
+    function try(c:int) = 
+(    if c=N
+     then printboard()
+     else for r := 0 to N-1
+	   do if row[r]=0 & diag1[r+c]=0 & diag2[r+7-c]=0
+	      then (row[r]:=1; diag1[r+c]:=1; diag2[r+7-c]:=1;
+		    col[c]:=r;
+	            try(c+1);
+		    row[r]:=0; diag1[r+c]:=0; diag2[r+7-c]:=0)
+)
+ in try(0)
+end
+	

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/fac.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/fac.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,6 @@
+/* factorial function; example from SPIM manual */
+
+let function fact(n : int) : int =
+      if n < 1 then 1 else (n * fact(n - 1))
+ in printint(fact(10))
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/for.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/for.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,15 @@
+let 
+  /*var i := 1
+  //var j := i*/
+
+  type vec = array of int
+
+  var v : vec := vec [5] of 0
+
+in 
+
+  for i := 0 to 4 do
+    v[i] := i * i
+  ; printint(v[4])
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/lecture.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/lecture.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,13 @@
+/* factorial function */
+
+let 
+	var x : int := 0
+	
+	function fact(n : int) : int = 
+		if n < 1 then 1 else (n * fact(n - 1))
+
+in 
+   x := fact(5) ;
+   printint(x) 
+
+end
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/merge.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/merge.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,65 @@
+/* merge: 
+	
+   Reads in two lists of integers from standard input, merges
+   them, and prints the resulting list.
+ 
+   If the initial lists are sorted the result list is sorted
+   as well.
+
+*/
+
+let 
+
+ type any = {any : int}
+ var buffer := getchar()
+
+ function readint(any: any) : int =
+ let var i := 0
+     function isdigit(s : string) : int = 
+		  ord(buffer)>=ord("0") & ord(buffer)<=ord("9")
+     function skipto() =
+       while buffer=" " | buffer="\n"
+         do buffer := getchar()
+  in skipto();
+     any.any := isdigit(buffer);
+     while isdigit(buffer)
+       do (i := i*10+ord(buffer)-ord("0"); buffer := getchar());
+     i
+ end
+
+ type list = {first: int, rest: list}
+
+ function readlist() : list =
+    let var any := any{any=0}
+        var i := readint(any)
+     in if any.any
+         then list{first=i,rest=readlist()}
+         else nil
+    end
+
+ function merge(a: list, b: list) : list =
+   if a=nil then b
+   else if b=nil then a
+   else if a.first < b.first 
+      then list{first=a.first,rest=merge(a.rest,b)}
+      else list{first=b.first,rest=merge(a,b.rest)}
+
+ function printint(i: int) =
+  let function f(i:int) = if i>0 
+	     then (f(i/10); print(chr(i-i/10*10+ord("0"))))
+   in if i<0 then (print("-"); f(-i))
+      else if i>0 then f(i)
+      else print("0")
+  end
+
+ function printlist(l: list) =
+   if l=nil then print("\n")
+   else (printint(l.first); print(" "); printlist(l.rest))
+
+   var list1 := readlist()
+   var list2 := (buffer:=getchar(); readlist())
+
+  /* BODY OF MAIN PROGRAM */
+ in printlist(merge(list1,list2))
+end
+

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/multi-arg.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/multi-arg.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,7 @@
+/* function with many (more than four) arguments */
+
+let function multi(arg1 : int, arg2 : int, arg3 : int, arg4 : int, arg5 : int) : int =
+      arg1 + arg2 + arg3 + arg4 + arg5
+ in
+    printint(multi(1,2,3,4,5))
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest4.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest4.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,8 @@
+let function f(x : int, z : int) : int = 
+    let function g(y : int) : int = 
+          (x + y) - z
+     in g(x)
+    end
+ in printint(f(4, 6))
+end
+ 
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest5.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest5.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,17 @@
+/* factorial function; example from SPIM manual */
+
+let 
+
+  var x := 0
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+in 
+
+  for i := 1 to 3 do 
+    (x := x + fact(i);
+     printint(x);
+     print(" "))
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest51.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest51.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,23 @@
+/* factorial function; example from SPIM manual */
+
+let 
+
+  var x := 0
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+      
+in 
+
+  for i := 1 to 3 do 
+    (x := x + fact(i);
+     printint(x);
+     print(" "))
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest52.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest52.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,36 @@
+/* factorial function; example from SPIM manual */
+
+let 
+
+  var x := 0
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))      
+in 
+
+  for i := 1 to 3 do 
+    (x := x + fact(i);
+     printint(x);
+     print(" "))
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest5542.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/mytest5542.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,46 @@
+/* factorial function; example from SPIM manual */
+
+let 
+
+  var x := 0
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))
+  function fact(n : int) : int = 
+      if n < 1 then 1 else (n * fact(n - 1))      
+in 
+
+  for i := 1 to 3 do 
+    (x := x + fact(i);
+     printint(x);
+     print(" "))
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/nestedfunctions.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/nestedfunctions.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,15 @@
+let var x := 1
+ in let var x := x + 3
+     in let function x(x : int, y : int) : int =
+              let var i := 3 var z := 0
+               in for i := 0 to x do z := z + i * y;
+                  z
+              end
+         in x(3,4)
+        end;
+        x + 5
+    end;
+    let var y := 3
+     in printint((x + 6) + y)
+    end
+end
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/prettyprint.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/prettyprint.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,41 @@
+let
+
+type tree = {key: string, left : tree, right: tree}
+
+function prettyprint(tree: tree) : string =
+let
+
+  var output := ""
+
+  function write(s: string) =
+    output := concat(output, s)
+
+  function show(n: int, t: tree) =
+  let function indent(s: string) =
+        (write("\n");
+         for i := 1 to n
+          do write(" ");
+         output := concat(output, s))
+   in if t = nil then indent(".")
+      else (indent(t.key);
+            show(n+1, t.left);
+            show(n+1, t.right))
+  end
+
+ in show(0, tree); 
+    output
+end
+
+function node(x : string, l : tree, r : tree) : tree =
+  tree{key = x, left = l, right = r}
+
+function printnl(x : string) =
+  (print(x); print("\n"))
+
+in let var t := node("a",node("b",nil,nil),
+                         node("c",nil,node("d",nil,nil)))
+    in printnl("start");
+       printnl(prettyprint(t));
+       printnl("end")
+   end
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/queens.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/queens.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,32 @@
+/* A program to solve the 8-queens problem */
+
+let
+    var N := 8
+
+    type intArray = array of int
+
+    var row := intArray [ N ] of 0
+    var col := intArray [ N ] of 0
+    var diag1 := intArray [N+N-1] of 0
+    var diag2 := intArray [N+N-1] of 0
+
+    function printboard() =
+       (for i := 0 to N-1
+	 do (for j := 0 to N-1 
+	      do print(if col[i]=j then " O" else " .");
+	     print("\n"));
+         print("\n"))
+
+    function try(c:int) = 
+(    if c=N
+     then printboard()
+     else for r := 0 to N-1
+	   do if row[r]=0 & diag1[r+c]=0 & diag2[r+7-c]=0
+	      then (row[r]:=1; diag1[r+c]:=1; diag2[r+7-c]:=1;
+		    col[c]:=r;
+	            try(c+1);
+		    row[r]:=0; diag1[r+c]:=0; diag2[r+7-c]:=0)
+)
+ in try(0)
+end
+	

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test1.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test1.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,7 @@
+/* an array type and an array variable */ 
+let
+	type  arrtype = array of int
+	var arr1:arrtype := arrtype [10] of 0
+in
+	arr1
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test12.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test12.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,9 @@
+/* valid for and let */
+
+let
+	var a:= 0
+	var a:= 1
+in 
+	for i:=0 to 100 do (a:=a+1;())
+	; printint(a)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test16.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test16.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,11 @@
+/* error: mutually recursive types thet do not pass through record or array */
+let 
+
+type a=c
+type b=a
+type c=d
+type d=a
+
+in
+ ""
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test17.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test17.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,10 @@
+/* error: definition of recursive types is interrupted */
+let
+/* define a tree */
+type tree ={key: int, children: treelist}
+var d:int :=0
+type treelist = {hd: tree, tl: treelist}
+
+in
+    printint(d)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test2.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test2.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,9 @@
+/* arr1 is valid since expression 0 is int = myint */
+let
+	type myint = int
+	type  arrtype = array of myint
+
+	var arr1:arrtype := arrtype [10] of 0
+in
+	arr1
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test27.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test27.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,10 @@
+/* locals hide globals */
+let
+	var a:=0
+
+	function g(a:int):int = a * 4
+in
+ printint(g(2))
+ ; print(" outer scope a: ")
+ ; printint(a)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test3.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test3.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,11 @@
+/* a record type and a record variable */
+let
+ type  rectype = {name:string, age:int}
+ var rec1:rectype := rectype {name="Nobody", age=1000}
+in
+ rec1.name := "Somebody";
+ print(rec1.name);
+ rec1;
+ printint(rec1.age)
+end
+ 

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test30.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test30.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,10 @@
+/* synonyms are fine */
+
+let 
+ type a = array of int
+ type b = a
+
+ var arr1:a := b [10] of 0
+in
+  printint( arr1[2])
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test37.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test37.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,8 @@
+/* redeclaration of variable; this is legal, there are two different
+   variables with the same name.  The second one hides the first.  */
+let
+	var a := 0
+	var a := " "
+in
+	0
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test38.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test38.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,9 @@
+/* This is illegal, since there are two types with the same name
+    in the same (consecutive) batch of mutually recursive types. 
+    See also test47  */
+let
+	type a = int
+	type a = string
+in
+	0
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test39.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test39.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,9 @@
+/* This is illegal, since there are two functions with the same name
+    in the same (consecutive) batch of mutually recursive functions.
+   See also test48 */
+let
+	function g(a:int):int = a
+	function g(a:int):int = a
+in
+	0
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test3gfg9.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test3gfg9.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,99 @@
+/* This is illegal, since there are two functions with the same name
+    in the same (consecutive) batch of mutually recursive functions.
+   See also test48 */
+let
+	function g(a:int):int = a
+	function g(a:int):int = a
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+	function g(a:int):int = a
+	function g(a:int):int = a	
+in
+	0
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test4.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test4.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,22 @@
+/* define a recursive function */
+let
+
+function printnl(x : string) =
+  (print(x); print("\n"))
+
+function mod(i : int, j : int) : int =
+  i - ((i / j) * j)
+
+function inttostring(n : int) : string =
+  if n < 10 
+  then chr(48 + n)
+  else concat(inttostring(n / 10), inttostring(mod(n, 10)))
+
+/* calculate n! */
+function nfactor(n: int): int =
+  if n = 0 then 1 else (n * nfactor(n-1))
+
+in
+   printnl(inttostring(nfactor(10)))
+end
+

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test41.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test41.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,10 @@
+/* local types hide global */
+let
+	type a = int
+in
+	let
+		type a = string
+	in
+		printint(0)
+	end
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test42.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test42.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,34 @@
+/* correct declarations */
+let 
+
+type arrtype1 = array of int
+type rectype1 = {name:string, address:string, id: int , age: int}
+type arrtype2 = array of rectype1
+type rectype2 = {name : string, dates: arrtype1}
+
+type arrtype3 = array of string
+
+var arr1 := arrtype1 [10] of 0
+var arr2  := arrtype2 [5] of rectype1 {name="aname", address="somewhere", id=0, age=0}
+var arr3:arrtype3 := arrtype3 [100] of ""
+
+var rec1 := rectype1 {name="Kapoios", address="Kapou", id=02432, age=44}
+var rec2 := rectype2 {name="Allos", dates= arrtype1 [3] of 1900}
+
+in
+
+arr1[0] := 1; 
+arr1[9] := 3;
+arr2[3].name := "kati";
+arr2[1].age := 23;
+arr3[34] := "sfd";
+print(arr3[34]);
+print(" ");
+
+rec1.name := "sdf";
+rec2.dates[0] := 2323;
+rec2.dates[2] := 2323;
+
+printint(rec2.dates[2])
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test44.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test44.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,12 @@
+/* valid nil initialization and assignment */
+let 
+
+ type rectype = {name:string, id:int}
+ var b:rectype := nil
+
+in
+
+ b := nil;
+ print("nil ")
+
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test47.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test47.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,11 @@
+/* This is legal.  The second type "a" simply hides the first one.
+   Because of the intervening variable declaration, the two "a" types
+   are not in the same  batch of mutually recursive types.
+   See also test38 */
+let
+ type a = int
+ var  b := 4
+ type a = string
+in
+ printint(0)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test48.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test48.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,11 @@
+/* This is legal.  The second function "g" simply hides the first one.
+   Because of the intervening variable declaration, the two "g" functions
+   are not in the same  batch of mutually recursive functions. 
+   See also test39 */
+let
+	function g(a:int):int = a
+	type t = int
+	function g(a:int):int = a
+in
+	printint(0)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test5.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test5.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,14 @@
+/* define valid recursive types */
+let
+/* define a list */
+type intlist = {hd: int, tl: intlist} 
+
+/* define a tree */
+type tree ={key: int, children: treelist}
+type treelist = {hd: tree, tl: treelist}
+
+var lis:intlist := intlist { hd=24, tl= nil } 
+
+in
+  printint(lis.hd)
+end

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test6.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test6.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,15 @@
+/* define valid mutually recursive procedures */
+let
+
+function do_nothing1(a: int, b: string)=
+	   if a < 25 then
+		do_nothing2(a+1)
+
+function do_nothing2(d: int) =
+		do_nothing1(d, "str")
+
+in
+	do_nothing1(0, "str2")
+	; print("end of exec ")
+end
+

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test7.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test7.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,14 @@
+/* define valid mutually recursive functions */
+let
+
+function do_nothing1(a: int, b: string):int=
+		(if a < 25 then do_nothing2(a+1) else 1;0)
+
+function do_nothing2(d: int):string =
+		(do_nothing1(d, "str");" ")
+
+in
+	do_nothing1(0, "str2")
+	; print("end of exec ")
+end
+

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test8.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test8.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,2 @@
+/* correct if */
+if (10 > 20) then printint(30) else printint(40)

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/test9.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/test9.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+/* error : types of then - else differ */
+
+if (5>4) then printint(13) else  print(" empty ")

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest1.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest1.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,6 @@
+let function f() : int =
+    let var x : int := 1
+     in x + 1
+    end
+in printint(f())
+end
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest2.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest2.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,6 @@
+let function f() : int =
+    let var x : int := 1
+     in x + 1
+    end
+in printint(f())
+end
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest3.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest3.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,6 @@
+let var x := 3
+ in while x < 10 do (
+      x := x + 1
+    )
+    ; printint(x)
+end
\ No newline at end of file

Added: spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest4.tig
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/tests/tiger/trtest4.tig	Fri May  4 00:34:05 2012	(r24789)
@@ -0,0 +1,3 @@
+let var x : string := "abc"
+ in print(x)
+end
\ No newline at end of file

From richard at vogelij.nl  Fri May  4 03:04:35 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Fri, 04 May 2012 01:04:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24790 - in
	spoofax-ace/trunk/spoofax-ace-server: . src/spoofax/ace/tokenize
Message-ID: <20120504010435.64A90CC189@mx4.tudelft.nl>

Author: rvogelij
Date: Fri May  4 01:04:33 2012
New Revision: 24790
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24790&sc=1

Log:
fixed bug where quotes around strings got hidden

Modified:
   spoofax-ace/trunk/spoofax-ace-server/.classpath
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java

Modified: spoofax-ace/trunk/spoofax-ace-server/.classpath
==============================================================================
--- spoofax-ace/trunk/spoofax-ace-server/.classpath	Fri May  4 00:34:05 2012	(r24789)
+++ spoofax-ace/trunk/spoofax-ace-server/.classpath	Fri May  4 01:04:33 2012	(r24790)
@@ -6,5 +6,9 @@
 	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/servlet-api-2.5.jar"/>
 	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/jetty-util-7.6.3.v20120416.jar"/>
 	<classpathentry kind="lib" path="/home/richard/Thesis/Jetty/jetty-all-7.6.3.v20120416.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/mobl.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/mobl-java.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/prog.jar"/>
+	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/strategoxt.jar"/>
 	<classpathentry kind="output" path="bin"/>
 </classpath>

Modified: spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java
==============================================================================
--- spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java	Fri May  4 00:34:05 2012	(r24789)
+++ spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java	Fri May  4 01:04:33 2012	(r24790)
@@ -57,25 +57,17 @@
 			  if (note.getSubterm(i).getSubtermCount() != 0)
 				  AddTermInfoToEditorTokensHash(noteTokens, note.getSubterm(i).getSubterm(0), note.getSubterm(i).getSubterm(1).toString());
 
-		  
-		  
-		  
 		  IToken lefttoken = ImploderAttachment.getLeftToken(ast);
 		  ITokenizer tokenizer = lefttoken.getTokenizer();
 		  
-		  
-		  
 		  StringBuilder errors = new StringBuilder();
 		  errors.append("");
 		  
-		  
 		  StringBuilder[] tokens = new StringBuilder[sourceLength+1];
-		  //System.out.println("Src length: "+ sourceLength);
 		  for (int i = 0; i < sourceLength; i++)
 			  tokens[i] = new StringBuilder();
 		  
 		  
-		  
 		  //bespintokens in an array per LOC
 		  for(int i = 0; i < tokenizer.getTokenCount(); i++) {
 				final IToken x = tokenizer.getTokenAt(i);
@@ -83,7 +75,7 @@
 				final int end = x.getEndOffset() - x.getStartOffset() + start + 1;
 				
 				String bespinType = convertTokenType(x.getKind());
-				//System.out.println(x.getKind() + "  -  " + x.toString());
+				System.out.println(x.getKind() + "  -  " + x.toString());
 				if (noteTokens.containsKey(x))
 				{
 					errors.append(createInfoToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
@@ -100,15 +92,14 @@
 					bespinType = "invalid.illegal";
 				} 
 				tokens[x.getLine()-1].append("  " + createBespinToken(x.toString(), bespinType, start, end, x.getLine()) + "\n,");
-				//System.out.println(createBespinToken(x.toString(), convertTokenType(x.getKind()), start, end, x.getLine()));
 		  }
 		  
 		  StringBuilder json = new StringBuilder();
 		  json.append("{\"parsed\": [\n");
 		  for (int i = 0; i < sourceLines.length; i++)
 		  {
-			  //String safeJson = sourceLines[i].replaceAll("\"", "\\\\\"");
-			  String safeJson = sourceLines[i].replaceAll("\"", "");
+			  String safeJson = sourceLines[i].replaceAll("\"", "\\\\\"");
+			  System.out.println(safeJson);
 			  safeJson = safeJson.replaceAll("	", "\\\\\\t");
 					  
 			  json.append("{\"text\":\""+safeJson+"\",\"tokens\":[\n");
@@ -134,7 +125,7 @@
 	
 	
 	private static String createBespinToken(String value, String tokentype, int startColumn, int endColumn, int lineNumber) {
-		String safeJson = value.replace('\n', ' ').replace('"', ' ');
+		String safeJson = value.replace('\n', ' ').replaceAll("\"", "\\\\\"");
 		safeJson = safeJson.replaceAll("	", "\\\\\\t");
 		String x = ""; 
 	     x += " {";

From richard at vogelij.nl  Fri May  4 03:05:22 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Fri, 04 May 2012 01:05:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24791 -
	spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize
Message-ID: <20120504010522.BDFABCC189@mx4.tudelft.nl>

Author: rvogelij
Date: Fri May  4 01:05:22 2012
New Revision: 24791
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24791&sc=1

Log:
.

Modified:
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java

Modified: spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java
==============================================================================
--- spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java	Fri May  4 01:04:33 2012	(r24790)
+++ spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/Tokenizer.java	Fri May  4 01:05:22 2012	(r24791)
@@ -75,7 +75,7 @@
 				final int end = x.getEndOffset() - x.getStartOffset() + start + 1;
 				
 				String bespinType = convertTokenType(x.getKind());
-				System.out.println(x.getKind() + "  -  " + x.toString());
+				//System.out.println(x.getKind() + "  -  " + x.toString());
 				if (noteTokens.containsKey(x))
 				{
 					errors.append(createInfoToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
@@ -99,7 +99,6 @@
 		  for (int i = 0; i < sourceLines.length; i++)
 		  {
 			  String safeJson = sourceLines[i].replaceAll("\"", "\\\\\"");
-			  System.out.println(safeJson);
 			  safeJson = safeJson.replaceAll("	", "\\\\\\t");
 					  
 			  json.append("{\"text\":\""+safeJson+"\",\"tokens\":[\n");

From richard at vogelij.nl  Fri May  4 03:17:00 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Fri, 04 May 2012 01:17:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24792 -
	spoofax-ace/trunk/spoofax-ace/resources/ace/src
Message-ID: <20120504011700.CC293108C006@mx3.tudelft.nl>

Author: rvogelij
Date: Fri May  4 01:17:00 2012
New Revision: 24792
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24792&sc=1

Log:
replaced ugly red background error markers with nice red curly underlines

Modified:
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js

Modified: spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js	Fri May  4 01:05:22 2012	(r24791)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/theme-dawn-original.js	Fri May  4 01:17:00 2012	(r24792)
@@ -1 +1 @@
-define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",b.cssText=".ace-dawn .ace_editor {  border: 2px solid rgb(159, 159, 159);}.ace-dawn .ace_editor.ace_focus {  border: 2px solid #327fbd;}.ace-dawn .ace_gutter {  width: 50px;  background: #e8e8e8;  color: #333;  overflow : hidden;}.ace-dawn .ace_gutter-layer {  width: 100%;  text-align: right;}.ace-dawn .ace_gutter-layer .ace_gutter-cell {  padding-right: 6px;}.ace-dawn .ace_print_margin {  width: 1px;  background: #e8e8e8;}.ace-dawn .ace_scroller {  background-color: #F9F9F9;}.ace-dawn .ace_text-layer {  cursor: text;  color: #080808;}.ace-dawn .ace_cursor {  border-left: 2px solid #000000;}.ace-dawn .ace_cursor.ace_overwrite {  border-left: 0px;  border-bottom: 1px solid #000000;} .ace-dawn .ace_marker-layer .ace_selection {  background: rgba(39, 95, 255, 0.30);}.ace-dawn .ace_marker-layer .ace_step {  background: rgb(198, 219, 174);}.ace-dawn .ace_marker-layer .ace_brac
 ket {  margin: -1px 0 0 -1px;  border: 1px solid rgba(75, 75, 126, 0.50);}.ace-dawn .ace_marker-layer .ace_active_line {  background: rgba(36, 99, 180, 0.12);}.ace-dawn .ace_marker-layer .ace_selected_word {  border: 1px solid rgba(39, 95, 255, 0.30);}       .ace-dawn .ace_invisible {  color: rgba(75, 75, 126, 0.50);}.ace-dawn .ace_keyword {  color:#794938;}.ace-dawn .ace_constant {  color:#811F24;}.ace-dawn .ace_invalid.ace_illegal {  text-decoration:underline;font-style:italic;color:#F8F8F8;background-color:#B52A1D;}.ace-dawn .ace_invalid.ace_deprecated {  text-decoration:underline;font-style:italic;color:#B52A1D;}.ace-dawn .ace_support {  color:#691C97;}.ace-dawn .ace_fold {}.ace-dawn .ace_support.ace_function {  color:#693A17;}.ace-dawn .ace_string {  color:#0B6125;}.ace-dawn .ace_string.ace_regexp {  color:#CF5628;}.ace-dawn .ace_comment {  font-style:italic;color:#5A525F;}.ace-dawn .ace_variable {  color:#234A97;}.ace-dawn .ace_markup.ace_underline {    text-decoration
 :underline;}.ace-dawn .ace_markup.ace_heading {  color:#19356D;}.ace-\ No newline at end of file
+define("ace/theme/dawn",["require","exports","module"],function(a,b,c){b.isDark=!1,b.cssClass="ace-dawn",b.cssText=".ace-dawn .ace_editor {  border: 2px solid rgb(159, 159, 159);}.ace-dawn .ace_editor.ace_focus {  border: 2px solid #327fbd;}.ace-dawn .ace_gutter {  width: 50px;  background: #e8e8e8;  color: #333;  overflow : hidden;}.ace-dawn .ace_gutter-layer {  width: 100%;  text-align: right;}.ace-dawn .ace_gutter-layer .ace_gutter-cell {  padding-right: 6px;}.ace-dawn .ace_print_margin {  width: 1px;  background: #e8e8e8;}.ace-dawn .ace_scroller {  background-color: #F9F9F9;}.ace-dawn .ace_text-layer {  cursor: text;  color: #080808;}.ace-dawn .ace_cursor {  border-left: 2px solid #000000;}.ace-dawn .ace_cursor.ace_overwrite {  border-left: 0px;  border-bottom: 1px solid #000000;} .ace-dawn .ace_marker-layer .ace_selection {  background: rgba(39, 95, 255, 0.30);}.ace-dawn .ace_marker-layer .ace_step {  background: rgb(198, 219, 174);}.ace-dawn .ace_marker-layer .ace_brac
 ket {  margin: -1px 0 0 -1px;  border: 1px solid rgba(75, 75, 126, 0.50);}.ace-dawn .ace_marker-layer .ace_active_line {  background: rgba(36, 99, 180, 0.12);}.ace-dawn .ace_marker-layer .ace_selected_word {  border: 1px solid rgba(39, 95, 255, 0.30);}       .ace-dawn .ace_invisible {  color: rgba(75, 75, 126, 0.50);}.ace-dawn .ace_keyword {  color:#794938;}.ace-dawn .ace_constant {  color:#811F24;}.ace-dawn .ace_invalid.ace_illegal {  font-style:italic;background-image:url(underline.gif);background-position: bottom;background-repeat: repeat-x; }.ace-dawn .ace_invalid.ace_deprecated {  text-decoration:underline;font-style:italic;color:#B52A1D;}.ace-dawn .ace_support {  color:#691C97;}.ace-dawn .ace_fold {}.ace-dawn .ace_support.ace_function {  color:#693A17;}.ace-dawn .ace_string {  color:#0B6125;}.ace-dawn .ace_string.ace_regexp {  color:#CF5628;}.ace-dawn .ace_comment {  font-style:italic;color:#5A525F;}.ace-dawn .ace_variable {  color:#234A97;}.ace-dawn .ace_markup.ace_un
 derline {    text-decoration:underline;}.ace-dawn .ace_markup.ace_hea\ No newline at end of file

From gabrielkonat at gmail.com  Fri May  4 13:25:46 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 04 May 2012 11:25:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24793 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans
	spoofax-contrib/se...
Message-ID: <20120504112546.6B808CC14E@mx4.tudelft.nl>

Author: gkonat
Date: Fri May  4 11:25:46 2012
New Revision: 24793
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24793&sc=1

Log:
Improved AST splitters.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Fri May  4 01:17:00 2012	(r24792)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Fri May  4 11:25:46 2012	(r24793)
@@ -7,9 +7,9 @@
  
 rules
  
-  index-split = fail
+  index-split = id
  
-  index-is-toplevel = ?TypeDecl(_)
+  //index-is-toplevel = ?TypeDecl(_)
   index-is-toplevel = ?FunDecl(_, _, _, _)
  
   index-is-qualifier = ?Start(_, _)

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Fri May  4 01:17:00 2012	(r24792)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Fri May  4 11:25:46 2012	(r24793)
@@ -7,7 +7,7 @@
  
 rules
  
-  index-split = fail
+  index-split = id
  
   index-is-toplevel = ?Class(_, _)
   index-is-toplevel = ?PartialClass(_, _)

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Fri May  4 01:17:00 2012	(r24792)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Fri May  4 11:25:46 2012	(r24793)
@@ -7,7 +7,7 @@
  
 rules
   
-  index-split = fail
+  index-split = id
  
   index-is-toplevel = ?Entity(_, _)
   index-is-toplevel = ?Aspect(_, _)

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Fri May  4 01:17:00 2012	(r24792)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Fri May  4 11:25:46 2012	(r24793)
@@ -93,11 +93,12 @@
   analyze-top(|phase, language, path, project-path):
     ast -> (ast', filesToAnalyze)
     with
+      full-path := $[[project-path]/[path]];
       if index-split then
+        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
         asts := <index-toplevel-split> ast;
         (ast', filesToAnalyze) := <analyze-top-multiple(|phase, language, path, project-path)> asts
       else
-        full-path := $[[project-path]/[path]];
         Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> ast
       end
       
@@ -145,7 +146,7 @@
         rules(Index-UnresolvedSet: _ -> unresolvedSet);
        
         // Add Unresolved annotations, record globals
-        (Some(ast2), defs) := <analyze-defs(|Anon(), Anon())> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+        (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
         <index-add-all(|file)> defs;
 
         // Find DefData
@@ -196,6 +197,7 @@
    *
    * @internal
    */
+  analyze-defs = analyze-defs(|Anon(), Anon())
   analyze-defs(|head-scope, head-scope-ns):
     ast -> (ast', defs')
     with
@@ -371,33 +373,33 @@
   index-qualifier-subelements = fail
   index-create-qualifier(|qualifier) = fail
   
-  index-toplevel-split = index-toplevel-split(|[])
-  index-toplevel-split(|uri):
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  index-toplevel-split-internal:
     node -> units
     with
       switch id
         case ?():
           units := [((), [])]
         case index-is-qualifier:
-          elems := <mapconcat(index-toplevel-split(|[<nam-get-definition-key> node|uri]))> <index-qualifier-subelements> node;
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
           units := <map(index-transform-qualifier(|node))> elems
         case index-is-toplevel:
-          units := [(node, [<nam-get-definition-key> node|uri])]
+          units := [(node, <index-path> <nam-get-definition-key> node)]
         otherwise:
           <warn(|"Unknown language element found during splitting: ")> node;
-          units := [((), [])]
+          units := [(node, [])]
       end
       
   index-transform-qualifier(|node):
     (elem, subfileName) -> (qualifier, subfileName)
     with
-      !elem;
-      switch id
-        case index-is-toplevel:
-          qualifier := <index-create-qualifier(|node)> elem
-        otherwise:
-          qualifier := ()
-      end
+    	qualifier := <index-create-qualifier(|node)> elem
 
 rules // diffs
   

From gabrielkonat at gmail.com  Fri May  4 17:06:49 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 04 May 2012 15:06:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24794 -
	spoofax-contrib/separate-compilation-examples
Message-ID: <20120504150649.5E5E3108C00A@mx3.tudelft.nl>

Author: gkonat
Date: Fri May  4 15:06:47 2012
New Revision: 24794
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24794&sc=1

Log:
Added readme to clarify dependency on spoofax project.

Added:
   spoofax-contrib/separate-compilation-examples/README

Added: spoofax-contrib/separate-compilation-examples/README
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/README	Fri May  4 15:06:47 2012	(r24794)
@@ -0,0 +1,9 @@
+The separate compilation examples are a set of language examples to validate 
+and test out approaches of the semantic index libraries.
+
+IMPORTANT: To compile these examples both spoofax and spoofax-contrib need 
+to be checked out in the same directory because the index libraries from the 
+org.spoofax.interpreter.library.language project are used. The directory 
+structure should look as follows with root directory SVN:
+- SVN/spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/...
+- SVN/spoofax-contrib/separate-compilation-examples/...
\ No newline at end of file

From gabrielkonat at gmail.com  Fri May  4 17:11:18 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 04 May 2012 15:11:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24795 -
	spoofax-contrib/separate-compilation-examples
Message-ID: <20120504151118.B6D2C108C01C@mx3.tudelft.nl>

Author: gkonat
Date: Fri May  4 15:11:18 2012
New Revision: 24795
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24795&sc=1

Log:
Also require nightly version.

Modified:
   spoofax-contrib/separate-compilation-examples/README

Modified: spoofax-contrib/separate-compilation-examples/README
==============================================================================
--- spoofax-contrib/separate-compilation-examples/README	Fri May  4 15:06:47 2012	(r24794)
+++ spoofax-contrib/separate-compilation-examples/README	Fri May  4 15:11:18 2012	(r24795)
@@ -6,4 +6,7 @@
 org.spoofax.interpreter.library.language project are used. The directory 
 structure should look as follows with root directory SVN:
 - SVN/spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/...
-- SVN/spoofax-contrib/separate-compilation-examples/...
\ No newline at end of file
+- SVN/spoofax-contrib/separate-compilation-examples/...
+
+The Spoofax nightly version (http://www.lclnet.nl/update/nightly) is required 
+as well!
\ No newline at end of file

From gabrielkonat at gmail.com  Fri May  4 19:56:30 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 04 May 2012 17:56:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24796 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
Message-ID: <20120504175630.742357F809C@mx1.tudelft.nl>

Author: gkonat
Date: Fri May  4 17:56:28 2012
New Revision: 24796
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24796&sc=1

Log:
Turn C splitter off for now, it loops.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Fri May  4 15:11:18 2012	(r24795)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Fri May  4 17:56:28 2012	(r24796)
@@ -7,7 +7,7 @@
  
 rules
  
-  index-split = id
+  index-split = fail
  
   //index-is-toplevel = ?TypeDecl(_)
   index-is-toplevel = ?FunDecl(_, _, _, _)

From oskarvanrest at gmail.com  Mon May  7 04:00:48 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 07 May 2012 02:00:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24797 - in
	experimental/graphical-editor/EntityLang/EntityLang: .
	META-INF editor editor/java/EntityLang/strategies
	editor/java/org lib/jars trans
Message-ID: <20120507020048.BE7A4108C021@mx3.tudelft.nl>

Author: OskarVanRest
Date: Mon May  7 02:00:47 2012
New Revision: 24797
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24797&sc=1

Log:
If a GMF editor can be found, it's in-memory EMF model is now updated each time a new ATerm is generated.

Deleted:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/org/
   experimental/graphical-editor/EntityLang/EntityLang/lib/jars/
Modified:
   experimental/graphical-editor/EntityLang/EntityLang/.classpath
   experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
   experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
   experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/.classpath
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/.classpath	Fri May  4 17:56:28 2012	(r24796)
+++ experimental/graphical-editor/EntityLang/EntityLang/.classpath	Mon May  7 02:00:47 2012	(r24797)
@@ -4,15 +4,5 @@
 	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/J2SE-1.5"/>
 	<classpathentry kind="con" path="org.eclipse.pde.core.requiredPlugins"/>
 	<classpathentry kind="con" path="org.eclipse.jdt.junit.JUNIT_CONTAINER/4"/>
-	<classpathentry kind="lib" path="lib/jars/EntityLangEMF.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.common_2.7.0.v20110912-0920.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.gef_3.7.0.v20110407-2050.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.gmf.runtime.diagram.ui_1.3.0.v20100209-2200.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.spoofax.text2model.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.transaction_1.4.0.v20100331-1738.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.emf.edit_2.7.0.v20110606-0949.jar"/>
-	<classpathentry kind="lib" path="lib/jars/EntityLangEMF.diagram.jar"/>
-	<classpathentry kind="lib" path="lib/jars/org.eclipse.gmf.runtime.diagram.ui.resources.editor-1.0.3-v20070601-1400.jar"/>
 	<classpathentry kind="output" path="bin"/>
 </classpath>

Modified: experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Fri May  4 17:56:28 2012	(r24796)
+++ experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Mon May  7 02:00:47 2012	(r24797)
@@ -15,7 +15,12 @@
  org.eclipse.ui.workbench.texteditor,
  org.strategoxt.imp.runtime,
  org.spoofax.jsglr,
- org.strategoxt.strj
+ org.strategoxt.strj,
+ EntityLangEMF.diagram;bundle-version="1.0.0",
+ org.eclipse.emf.transaction;bundle-version="1.4.0",
+ org.eclipse.gmf.runtime.diagram.ui;bundle-version="1.5.0",
+ org.spoofax.text2model.bridges.API;bundle-version="1.0.0",
+ org.eclipse.gmf.runtime.diagram.ui.resources.editor;bundle-version="1.4.1"
 Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Bundle-ActivationPolicy: lazy
 Export-Package: EntityLang

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Fri May  4 17:56:28 2012	(r24796)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Mon May  7 02:00:47 2012	(r24797)
@@ -11,25 +11,9 @@
 builders
                                                                                                                           
   provider : include/entitylang.ctree                                                                                     
-  provider : include/entitylang-java.jar                                                         
-  provider : lib/jars/EntityLangEMF.jar                                                                                   
-  provider : lib/jars/org.eclipse.emf.ecore_2.7.0.v20110912-0920.jar                                                                               
-  provider : lib/jars/org.eclipse.emf.common_2.7.0.v20110912-0920.jar
-  provider : lib/jars/org.eclipse.emf.ecore.xmi-2.5.0.v20100521-1846.jar
-  provider : lib/jars/org.eclipse.emf.edit_2.7.0.v20110606-0949.jar
-  provider : lib/jars/org.eclipse.emf.transaction_1.4.0.v20100331-1738.jar                                                      
-  provider : lib/jars/org.spoofax.text2model.jar
-  provider : lib/jars/org.eclipse.gef_3.7.0.v20110407-2050.jar
-  provider : lib/jars/org.eclipse.gmf.runtime.diagram.ui_1.3.0.v20100209-2200.jar
-  provider : lib/jars/org.eclipse.gmf.runtime.diagram.ui.resources.editor-1.0.3-v20070601-1400.jar
-  provider : lib/jars/org.eclipse.gmf.runtime.notation_1.2.0.v20091021-2333.jar
-  provider : lib/jars/org.eclipse.gmf.runtime.common.ui_1.5.0.v20101221-2230.jar
-  provider : lib/jars/org.eclipse.gmf.runtime.gef.ui_1.2.0.v20090520-1343.jar
-  provider : lib/jars/org.eclipse.emf.edit.ui-2.1.0.jar
-  provider : lib/jars/org.eclipse.draw2d_3.5.0.jar
-  provider : lib/jars/EntityLangEMF.diagram.jar                                                   
+  provider : include/entitylang-java.jar                                    
                                                                                                                           
-  observer : editor-analyze                                                                                               
+  observer : editor-analyze
                                                                                                                           
   builder  : "Generate Java code (for selection)"            = generate-java (openeditor) (realtime)                      
   builder  : "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (meta) (source)     
@@ -45,4 +29,4 @@
       identifier : "new name" = ""
 
  
-  on save : generate-emf
\ No newline at end of file
+  on save : save-emf
\ No newline at end of file

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java	Fri May  4 17:56:28 2012	(r24796)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java	Mon May  7 02:00:47 2012	(r24797)
@@ -9,63 +9,74 @@
 import org.eclipse.emf.ecore.resource.ResourceSet;
 import org.eclipse.emf.transaction.TransactionalEditingDomain;
 import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramEditor;
-import org.eclipse.ui.IEditorPart;
+import org.eclipse.ui.IEditorInput;
 import org.eclipse.ui.IEditorReference;
 import org.eclipse.ui.IWorkbench;
 import org.eclipse.ui.IWorkbenchPage;
 import org.eclipse.ui.IWorkbenchWindow;
 import org.eclipse.ui.PlatformUI;
+import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.lang.Context;
 import org.strategoxt.lang.Strategy;
 
-import EntityLangModel.diagram.part.EntityLangModelDiagramEditor;
+import EntityLangModel.diagram.part.EntityLangModelDiagramEditorPlugin;
+import EntityLangModel.diagram.part.EntityLangModelDocumentProvider;
 
 public class replace_gmf_resource_0_1 extends Strategy {
 
 	public static replace_gmf_resource_0_1 instance = new replace_gmf_resource_0_1();
 
+	public static String lastSerialisedModel = "";
+	
 	@Override
 	public IStrategoTerm invoke(Context context, IStrategoTerm serialisedModel, IStrategoTerm packName) {
-		// find the EMF model
+		if (((IStrategoString) serialisedModel).stringValue().equals(lastSerialisedModel)) {
+			System.out.println("No change since last update");
+			return context.getFactory().makeString("0");
+		}
+		else {
+			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
+		}
+		
 		IWorkbench wb = PlatformUI.getWorkbench();
 		IWorkbenchWindow win = wb.getWorkbenchWindows()[0];
 		IWorkbenchPage page = win.getActivePage();
 		IEditorReference[] editors = page.getEditorReferences();
-		IEditorPart editor = null;
-		String editorID = packName.toString().replaceAll("\"", "") + ".diagram.part." + packName.toString().replaceAll("\"", "") + "DiagramEditorID";
-	    for (int i = 0; i < editors.length; i++) {
+		DiagramEditor diagramEditor = null;
+		String editorID = ((IStrategoString) packName).stringValue() + ".diagram.part." + ((IStrategoString) packName).stringValue() + "DiagramEditorID";
+		for (int i = 0; i < editors.length; i++) {
 			if (editors[i].getId().equals(editorID)) {
-				editor = editors[i].getEditor(false);
+				diagramEditor = (DiagramEditor) editors[i].getEditor(false);
 			}
 		}
 
-		if (editor == null) {
-//			try {page.getViews()[0].getViewSite().getActionBars()
-//				throw new Exception();
-//			} catch (Exception e) {
-//				e.printStackTrace();
-//			}
+		if (diagramEditor == null) {
+			System.out.println("GMF editor not found. Please open it manually");
 			return context.getFactory().makeString("0");
 		}
-		System.out.println("hoi0");
 
-		TransactionalEditingDomain editingDomain = ((DiagramEditor) editor).getEditingDomain();
-		System.out.println("hoi1");
+		TransactionalEditingDomain editingDomain = diagramEditor.getEditingDomain();
 		ResourceSet diagramEditorResourceSet = editingDomain.getResourceSet();
-		System.out.println("hoi2");
-		Resource resource = diagramEditorResourceSet.getResources().get(1);
-		System.out.println("hoi3");
-
-		InputStream is = new ByteArrayInputStream(serialisedModel.toString().getBytes());
-		System.out.println("hoi4");
-
-		try {
-			resource.load(is, Collections.emptyMap());
-		} catch (IOException e) {
-			e.printStackTrace();
-			return context.getFactory().makeString("0");
-		}
+		final Resource semanticModel = diagramEditorResourceSet.getResources().get(1);
+		final InputStream is = new ByteArrayInputStream(((IStrategoString) serialisedModel).stringValue().getBytes());
+		final EntityLangModelDocumentProvider documentProvider = EntityLangModelDiagramEditorPlugin.getInstance().getDocumentProvider();
+		final IEditorInput editorInput = diagramEditor.getEditorInput();
+
+		diagramEditor.getSite().getShell().getDisplay().asyncExec(new Runnable() {
+			public void run() {
+				if (semanticModel.isLoaded()) {
+					semanticModel.unload();
+					try {
+						semanticModel.load(is, Collections.EMPTY_MAP);
+					} catch (IOException e) {
+						e.printStackTrace();
+					}
+					documentProvider.fireElementContentReplaced(editorInput);
+					documentProvider.setCanSaveDocument(editorInput);
+				}
+			}
+		});
 		
 		return context.getFactory().makeString("1");
 	}

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Fri May  4 17:56:28 2012	(r24796)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Mon May  7 02:00:47 2012	(r24797)
@@ -27,31 +27,22 @@
       ast'     := <analyze-top>;
       errors   := <collect-all(constraint-error, conc)> ast';
       warnings := <collect-all(constraint-warning, conc)> ast';
-      notes    := <collect-all(constraint-note, conc)> ast'
-
+      notes    := <collect-all(constraint-note, conc)> ast';      
+      emf      := <try(generate-emf)> (ast', path)
+      
   generate-emf:
-    (selected, position, ast, path, project-path) -> None()
-    with
-      // initialize
-	  editor-init;
-      ast' := <analyze-top> (ast, path, project-path);
+    (ast', path) -> result
+    with      
+      // EMF stuff below
       fileExtension := <lower-case> <packName>;
       filename := <guarantee-extension(|fileExtension)> path;
       <initialize-emf-package> <packName>;
-      
-      // generate EMF
       ast''  := <to-emf(|path)> ast';
       result := <serialise-model(|path)> ast'';
-      
-      // replace GMF's semantic model
       <replace-gmf-resource(|<packName>)> result
-      
-      // write to file
-	  // fdescr := <fopen> (filename, "w");
-	  // <fputs> (result, fdescr);
-	  // <fclose> fdescr;
-	  // <refresh-workspace-file> filename
-  
+	  
+  save-emf:
+  	(selected, position, ast, path, project-path) -> None()
   
   external initialize-emf-package(|)
   external replace-gmf-resource(|packName)

From gabrielkonat at gmail.com  Mon May  7 19:31:38 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 07 May 2012 17:31:38 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24798 -
	spoofax-contrib/separate-compilation-examples
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/cs...
Message-ID: <20120507173138.6BF3C2B800F@mx2.tudelft.nl>

Author: gkonat
Date: Mon May  7 17:31:35 2012
New Revision: 24798
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24798&sc=1

Log:
Index analysis is now properly done on file and subfile level.

Added:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_set_current_file.java   (contents, props changed)
Modified:
   spoofax-contrib/separate-compilation-examples/README
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LanguageLibrary.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax-contrib/separate-compilation-examples/README
==============================================================================
--- spoofax-contrib/separate-compilation-examples/README	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax-contrib/separate-compilation-examples/README	Mon May  7 17:31:35 2012	(r24798)
@@ -9,4 +9,8 @@
 - SVN/spoofax-contrib/separate-compilation-examples/...
 
 The Spoofax nightly version (http://www.lclnet.nl/update/nightly) is required 
-as well!
\ No newline at end of file
+as well!
+
+
+If you get an "module lib/analysis-auto.generated not found" error while
+building, open the main SDF file from the project, edit and save it.
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Mon May  7 17:31:35 2012	(r24798)
@@ -7,22 +7,8 @@
  
 rules
  
-  index-split = fail
- 
-  //index-is-toplevel = ?TypeDecl(_)
+  index-split = id
   index-is-toplevel = ?FunDecl(_, _, _, _)
- 
   index-is-qualifier = ?Start(_, _)
- 
   index-qualifier-subelements = ?Start(_, <id>)
- 
-  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
-    
-  /*
-  name = ?TypeDecl(<name>)
-  name = ?FunDecl(_, <id>, _, _)
-  name = ?Start(_, _); !"Global"
-  name = ?TypeDef(_, <id>)
-  name = ?Type(<id>)
-  name = ?StructDecl(<id>, _)
-  */
\ No newline at end of file
+  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Mon May  7 17:31:35 2012	(r24798)
@@ -8,15 +8,11 @@
 rules
  
   index-split = id
- 
   index-is-toplevel = ?Class(_, _)
   index-is-toplevel = ?PartialClass(_, _)
- 
   index-is-qualifier = ?Namespace(_, _)
   index-is-qualifier = ?Start(_, _)
- 
   index-qualifier-subelements = ?Namespace(_, <id>)
   index-qualifier-subelements = ?Start(_, <id>)
- 
   index-create-qualifier(|qualifier) = !Namespace(<?Namespace(<id>, _)> qualifier, <id>)
   index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str	Mon May  7 17:31:35 2012	(r24798)
@@ -43,6 +43,9 @@
 
 rules // Code generation to java strings
 	
+	to-java:
+	  [_] -> <concat-strings> <map(to-java)>
+	
   // Constructs
   to-java: 
     Module(name, imports, entities) ->

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Mon May  7 17:31:35 2012	(r24798)
@@ -8,18 +8,8 @@
 rules
   
   index-split = id
- 
   index-is-toplevel = ?Entity(_, _)
   index-is-toplevel = ?Aspect(_, _)
- 
   index-is-qualifier = ?Module(_, _, _)
- 
   index-qualifier-subelements = ?Module(_, _, <id>)
- 
-  index-create-qualifier(|qualifier) = !Module(<?Module(<id>, _, _)> qualifier, <?Module(_, <id>, _)> qualifier, <id>)
-  
-  /*  
-  name = ?Entity(<id>, _)
-  name = ?Aspect(<id>, _)
-  name = ?Module(<id>, _, _)
-  */
\ No newline at end of file
+  index-create-qualifier(|qualifier) = !Module(<?Module(<id>, _, _)> qualifier, <?Module(_, <id>, _)> qualifier, <id>)
\ No newline at end of file

Added: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_set_current_file.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LANG_index_set_current_file.java	Mon May  7 17:31:35 2012	(r24798)
@@ -0,0 +1,33 @@
+package org.spoofax.interpreter.library.language;
+
+import static org.spoofax.interpreter.core.Tools.isTermString;
+import static org.spoofax.interpreter.core.Tools.isTermTuple;
+
+import org.spoofax.interpreter.core.IContext;
+import org.spoofax.interpreter.library.AbstractPrimitive;
+import org.spoofax.interpreter.stratego.Strategy;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+
+public class LANG_index_set_current_file extends AbstractPrimitive {
+
+	private static String NAME = "LANG_index_set_current_file";
+	
+	private final SemanticIndexManager index;
+	
+	public LANG_index_set_current_file(SemanticIndexManager index) {
+		super(NAME, 0, 1);
+		this.index = index;
+	}
+
+	@Override
+	public boolean call(IContext env, Strategy[] svars, IStrategoTerm[] tvars) {
+		if (isTermTuple(tvars[0]) || isTermString(tvars[0])) {
+			ISemanticIndex ind = index.getCurrent();
+			SemanticIndexFileDescriptor fileDescriptor = ind.getFileDescriptor(tvars[0]);
+			index.setCurrentFile(fileDescriptor);
+			return true;
+		} else {
+			return false;
+		}
+	}
+}

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LanguageLibrary.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LanguageLibrary.java	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/LanguageLibrary.java	Mon May  7 17:31:35 2012	(r24798)
@@ -31,6 +31,7 @@
 		add(new LANG_index_start_transaction(index));
 		add(new LANG_index_end_transaction(index));
 		add(new LANG_index_get_file_revision(index));
+		add(new LANG_index_set_current_file(index));
 		
 		addSpxIndexPrimitives();
 	}

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java	Mon May  7 17:31:35 2012	(r24798)
@@ -38,10 +38,10 @@
 			ArrayListMultimap.create();
 	private final Multimap<SemanticIndexFileDescriptor, SemanticIndexEntry> entriesPerFileDescriptor = 
 			ArrayListMultimap.create();
+	private final Multimap<URI, SemanticIndexEntry> entriesPerURI = 
+			ArrayListMultimap.create();
 	private final Map<SemanticIndexFileDescriptor, SemanticIndexFile> files =
 			new HashMap<SemanticIndexFileDescriptor, SemanticIndexFile>();
-	private final Multimap<URI, SemanticIndexFileDescriptor> fileDescriptorsPerURI = 
-			ArrayListMultimap.create();
 	
 	private static final IStrategoConstructor FILE_ENTRIES_CON =
 			new TermFactory().makeConstructor("FileEntries", 2);
@@ -92,6 +92,7 @@
 
 		// Add entry to files.
 		entriesPerFileDescriptor.put(entry.getFileDescriptor(), entry);
+		entriesPerURI.put(entry.getFileDescriptor().getURI(), entry);
 	}
 	
 	public void addAll(IStrategoList entries, SemanticIndexFileDescriptor fileDescriptor) {
@@ -161,6 +162,7 @@
 			if (fileDescriptor != null)
 			{
 				entriesPerFileDescriptor.remove(fileDescriptor, entry);
+				entriesPerURI.remove(fileDescriptor.getURI(), entry); // TODO: Might not work because of hashCode of entry.
 			}
 		}
 	}
@@ -174,7 +176,10 @@
 	}
 	
 	public Collection<SemanticIndexEntry> getEntriesInFile(SemanticIndexFileDescriptor fileDescriptor) {
-		return getCollection(entriesPerFileDescriptor.get(fileDescriptor));
+		if(fileDescriptor.getSubfile() == null)
+			return getCollection(entriesPerURI.get(fileDescriptor.getURI()));
+		else
+			return getCollection(entriesPerFileDescriptor.get(fileDescriptor));
 	}
 	
 	public Collection<SemanticIndexEntry> getAllEntries() {
@@ -190,8 +195,6 @@
 		if(file == null) {
 			file = new SemanticIndexFile(fileDescriptor, null);
 			files.put(fileDescriptor, file);
-			if(fileDescriptor.getSubfile() != null)
-				fileDescriptorsPerURI.put(fileDescriptor.getURI(), fileDescriptor);
 		}
 		return file;
 	}
@@ -205,17 +208,7 @@
 	}
 	
 	public void removeFile(SemanticIndexFileDescriptor fileDescriptor) {
-		if(fileDescriptor.getSubfile() == null && fileDescriptorsPerURI.containsKey(fileDescriptor.getURI()))
-		{
-			// Make an array copy because clearFile removes from fileDescriptorsPerURI.
-			SemanticIndexFileDescriptor[] childDescriptors = 
-					fileDescriptorsPerURI.get(fileDescriptor.getURI()).toArray(new SemanticIndexFileDescriptor[0]);
-			
-			for(SemanticIndexFileDescriptor fd : childDescriptors)
-				clearFile(fd);
-		}
-		else 
-			clearFile(fileDescriptor);
+		clearFile(fileDescriptor);
 	}
 	
 	private void clearFile(SemanticIndexFileDescriptor fileDescriptor) {
@@ -228,8 +221,6 @@
 		remove(Arrays.asList(copy));
 
 		assert getEntriesInFile(fileDescriptor).isEmpty();
-		
-		fileDescriptorsPerURI.remove(fileDescriptor.getURI(), fileDescriptor);
 	}
 	
 	public Collection<SemanticIndexFile> getAllFiles() {
@@ -244,8 +235,8 @@
 		entries.clear();
 		childs.clear();
 		entriesPerFileDescriptor.clear();
+		entriesPerURI.clear();
 		files.clear();
-		fileDescriptorsPerURI.clear();
 	}
 	
 	public IStrategoTerm toTerm(boolean includePositions) {

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java	Mon May  7 17:31:35 2012	(r24798)
@@ -89,8 +89,9 @@
 		transactionLock.writeLock().lock();
 		try {
 			// TODO: Efficient copy of transactionIndex into index.
+			
 			if(currentIndex.hasClearedCurrentFile())
-				index.removeFile(currentFile.get());
+				index.removeFile(currentIndex.getCurrentFile());
 			
 			for(TemplateWithFileDescriptor entry : currentIndex.getRemovedEntries())
 				index.remove(entry.getTemplate(), entry.getFileDescriptor());

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/TransactionSemanticIndex.java	Mon May  7 17:31:35 2012	(r24798)
@@ -37,6 +37,10 @@
 		return clearedCurrentFile;
 	}
 	
+	public SemanticIndexFileDescriptor getCurrentFile() {
+		return currentFile;
+	}
+	
 	public Collection<TemplateWithFileDescriptor> getRemovedEntries() {
 		return removedEntries;
 	}
@@ -133,15 +137,10 @@
 	
 	public void removeFile(SemanticIndexFileDescriptor fileDescriptor) {
 		assert fileDescriptor.equals(currentFile) || fileDescriptor.getURI().equals(currentFile.getURI());
-		
-		// TODO: Is a write lock required when fileDescriptor equals currentFile (including the subfile!)
-		getWriteLock().lock();
-		try {
-			clearedCurrentFile = true;
-			transactionIndex.removeFile(fileDescriptor);
-		} finally {
-			getWriteLock().unlock();
-		}
+
+		// TODO: Might need to store which files have been removed and remove all those files when the transaction ends.
+		clearedCurrentFile = true;
+		transactionIndex.removeFile(fileDescriptor);
 	}
 
 	public Collection<SemanticIndexFile> getAllFiles() {

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May  7 17:31:35 2012	(r24798)
@@ -97,76 +97,113 @@
       if index-split then
         index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
         asts := <index-toplevel-split> ast;
-        (ast', filesToAnalyze) := <analyze-top-multiple(|phase, language, path, project-path)> asts
+        astsFilePairs := <map(\(ast, uri) -> (ast, (full-path, <uri-to-string> uri))\)> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
       else
-        Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> ast
+        Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
       end
-      
-  analyze-top-multiple(|phase, language, path, project-path):
-    asts -> (ast', filesToAnalyze)
-    with
-      full-path := $[[project-path]/[path]];
-      results := <map(analyze-top-subfile(|phase, language, path, project-path, full-path))> asts;
-      (ast', filesToAnalyzes) := <unzip> results;
-      filesToAnalyze := <concat> filesToAnalyzes
   
-  analyze-top-subfile(|phase, language, path, project-path, full-path):
-    (ast, subfile) -> (ast', filesToAnalyze)
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
+    with
+			<index-set-current-file> file;
+			(Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+			<index-add-all(|file)> defs
+			
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
+    with
+			<index-set-current-file> file;
+			{| Index-ReadSet:
+			  readSet := <new-iset>;
+			  rules(Index-ReadSet: _ -> readSet);
+			  
+			  // Gather all data for each definition.
+			  ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
+			  data := <origin-track-forced(analyze-tree-data)> ast2;
+			  
+			  // Resolve all references in gathered data.
+			  (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+			  <index-add-all(|file)> data2;
+			  
+			  // Store reads into the index (if not testing language)
+			  if not(is-test-input(|language, full-path)) then
+			    <index-add-all(|file)> <iset-elements> readSet
+			  end
+			|}
+			
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+	analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
     with
-      Results(ast', _, _, _, _, _, filesToAnalyze) := 
-        <analyze-top-internal(|phase, language, project-path, full-path, <uri-to-string> subfile)> ast
+			<index-set-current-file> file;
+			{| Index-ReadSet:
+			  readSet := <new-iset>;
+			  rules(Index-ReadSet: _ -> readSet);
+			  
+			  // Resolve all unresolved references for each use site.
+			  (ast2, uses) := <analyze-uses> ast;
+			  <index-add-all(|file)> uses;
+			  
+			  ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
+			  
+			  // Store reads into the index (if not testing language)
+			  if not(is-test-input(|language, full-path)) then
+			    <index-add-all(|file)> <iset-elements> readSet
+			  end
+			|}
+			
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */		
+	analyze-top-store-ast:
+	  (ast, file) -> <id>
+	  with
+      <index-set-global(|[<filepair-to-string> file, "ast"])> ast
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
    * @internal
    */
-  analyze-top-internal(|language) = 
-    analyze-top-internal(|Editor())
-  analyze-top-internal(|phase, language) = 
-    ?(ast, path, project-path); analyze-top-internal(|phase, language, project-path, $[[project-path]/[path]]); !ast
-  analyze-top-internal(|phase, language, project-path, full-path) = 
-    analyze-top-internal(|phase, language, project-path, full-path, "")
-  analyze-top-internal(|phase, language, project-path, full-path, subfile):
-    ast -> Results(ast5, defs, uses, data', added, removed, filesToAnalyze)
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
     with
       // Init
-      file := (full-path, subfile);
-      index-setup(|language, [project-path], file);
+      index-setup(|language, [project-path], full-path);
       revision := <index-start-transaction>
     with
-      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> file;
-      <index-clear-file> file
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
     with
-      {| Index-ReadSet, Index-UnresolvedSet:
-        readSet := <new-iset>;
+      {| Index-UnresolvedSet:
         unresolvedSet := <new-iset>;
-        
-        rules(Index-ReadSet: _ -> readSet);
         rules(Index-UnresolvedSet: _ -> unresolvedSet);
-       
-        // Add Unresolved annotations, record globals
-        (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
-        <index-add-all(|file)> defs;
-
-        // Find DefData
-        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2;
-        data := <origin-track-forced(analyze-tree-data)> ast3;
-
-        // Resolve all references in DefData
-        (data', _) := <analyze-uses> data;
-        <index-add-all(|file)> data';
-       
-        // Resolve all unresolved references in the tree
-        (ast4, uses) := <analyze-uses> ast3;
-        <index-add-all(|file)> uses;
         
-        ast5 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast4;
-       
-        // Store reads into the index (if current language is not testing language)
-        if not(<is-test-input(|language)> (ast, full-path)) then
-          <index-add-all(|file)> <iset-elements> readSet
-        end
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+      	(asts, _) := <unzip> astFilePairs4
       |}
     with
       index-end-transaction
@@ -174,7 +211,7 @@
       // Schedule re-analysis of dependent files (if current file is not testing language file)
       // HACK: Depends on file extension, could be other languages with .spt extension?
       if Editor() := phase; not(<is-test-file> full-path) then
-        newElems := <conc> (defs, <filter(index-diff-constructors)> data');
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
         
 	      // Find added and removed definitions
 	      (added, removed) := <analyze-diff> (oldElems, newElems);
@@ -182,14 +219,14 @@
 	      
         // Store files that have changed in the index
         index-start-transaction;
-        filesToAnalyze := <analyze-store-diff(|changed, file, ast, revision)>;
+        filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4;
         index-end-transaction
 	    else
 	      (added, removed) := ([], []);
 	      filesToAnalyze := []
       end
     with
-      <index-set-global(|[<filepair-to-string> file, "ast"])> ast5
+    	<list-loop(analyze-top-store-ast)> astFilePairs4
       
   /**
    * Identifies all definitions in the tree and annotates them with their URI.
@@ -322,7 +359,7 @@
       set-total-work-units
     with
       index-parallel-analyze(analyze);
-      filter(not(?ParallelResults((), (), _, _, _, _)); index-set-markers)
+      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
   
   /** @internal */
   index-parallel-analyze(analyze):
@@ -392,7 +429,6 @@
         case index-is-toplevel:
           units := [(node, <index-path> <nam-get-definition-key> node)]
         otherwise:
-          <warn(|"Unknown language element found during splitting: ")> node;
           units := [(node, [])]
       end
       
@@ -411,8 +447,8 @@
       removed := <diff(index-diff-compare)> (defs1, defs2)
     
   /** @internal */
-  analyze-store-diff(|changedEntries, file, ast, revision): 
-    _ -> analyzeFiles'
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
     with
       changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
       dependentFiles  := <index-get-dependent-files> changedEntries;
@@ -430,34 +466,26 @@
       end;*/
       
       // Files to compile
-      compileFiles := <conc> (analyzeFiles', changedFiles);
-      if not(<analyze-astdiff(|ast)> file) then
-        // Add current file if the AST has changed. Cannot use dependency tracking here because
-        // the originating file of a removed definition is not in the index any more.
-        // TODO: Is this still true?
-        compileFiles' := <make-set> [file|compileFiles]
-      else
-        compileFiles' := <make-set> compileFiles
-      end;
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
       // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
-      <map(analyze-add-compilediff)> compileFiles'
+      <map(analyze-add-compilediff)> compileFiles
       
   /** 
-   * Fails if old ASTDiff is not found or if ASTDiff is different.
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
    *
    * @internal
    */
-  analyze-astdiff(|ast):
-    file -> <id>
+  analyze-astdiff:
+    (ast, file) -> file
     where
     	name := [<filepair-to-string> file, "ast-checksum"];
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
       	<index-set-global(|name)> newChecksum;
-        <eq> (oldChecksum, newChecksum)
+        not(<eq> (oldChecksum, newChecksum))
       else
-        <index-set-global(|name)> newChecksum;
-        fail
+        <index-set-global(|name)> newChecksum
       end
       
   /** 
@@ -916,11 +944,8 @@
        
   // Tests if the current file is just a testing language input
   is-test-file = string-ends-with(|".spt")
-  is-test-input(|language):
-    (ast, path) -> (ast, path)
-    where
-      <is-test-file> path;
-      not(!language => "Spoofax-Testing")
+  is-test-language = ?"Spoofax-Testing"
+  is-test-input(|language, path) = <is-test-language> language <+ <is-test-file> path
       
   fake-file = is-test-file <+ index-is-fake-file
       

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Mon May  7 17:31:35 2012	(r24798)
@@ -53,7 +53,7 @@
       // Parse and analyze ast.
       ast                              := <parse-file> path;
       ast'                             := <try(index-desugar-ast)> ast;
-      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path, subfile)> ast'
+      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
     with
       {| Index-ReadSet:
         readSet := <new-iset>;

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May  7 02:00:47 2012	(r24797)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May  7 17:31:35 2012	(r24798)
@@ -45,6 +45,16 @@
    */
   index-setup(|language, project-paths, current-file) =
     prim("LANG_index_setup", language, project-paths, current-file)
+    
+  /**
+   * Sets the current file the index (analysis) is operating on to the given file.
+   *
+   * Example:
+   *   <index-set-current-file> "fullpath/file.ext"
+   *   <index-set-current-file> ("fullpath/file.ext", "subfile")
+   */
+  index-set-current-file = 
+    prim("LANG_index_set_current_file", <id>)
 
   /**
    * Adds given element to the index with given file path and optionally subfile.

From gabrielkonat at gmail.com  Mon May  7 21:48:36 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 07 May 2012 19:48:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24799 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans
	spoofax-contrib/se...
Message-ID: <20120507194836.A753B108C005@mx3.tudelft.nl>

Author: gkonat
Date: Mon May  7 19:48:34 2012
New Revision: 24799
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24799&sc=1

Log:
Added namespace to index-uri-to-string.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May  7 17:31:35 2012	(r24798)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May  7 19:48:34 2012	(r24799)
@@ -131,7 +131,7 @@
   editor-hover:
     (target, position, ast, path, project-path) -> $[[uriString]]
     where
-      uriString := <uri-to-string> <index-path> <nam-get-definition-key> target
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
 
   // Completes an identifier when the user presses control-space
   // (the completion identifier in the AST provides additional context information)

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May  7 17:31:35 2012	(r24798)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May  7 19:48:34 2012	(r24799)
@@ -130,7 +130,7 @@
   editor-hover:
     (target, position, ast, path, project-path) -> $[[uriString]]
     where
-      uriString := <uri-to-string> <index-path> <nam-get-definition-key> target
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
 
   // Completes an identifier when the user presses control-space
   // (the completion identifier in the AST provides additional context information)

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May  7 17:31:35 2012	(r24798)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May  7 19:48:34 2012	(r24799)
@@ -131,7 +131,7 @@
   editor-hover:
     (target, position, ast, path, project-path) -> $[[uriString]]
     where
-      uriString := <uri-to-string> <index-path> <nam-get-definition-key> target
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
 
   // Completes an identifier when the user presses control-space
   // (the completion identifier in the AST provides additional context information)

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May  7 17:31:35 2012	(r24798)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May  7 19:48:34 2012	(r24799)
@@ -97,7 +97,7 @@
       if index-split then
         index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
         asts := <index-toplevel-split> ast;
-        astsFilePairs := <map(\(ast, uri) -> (ast, (full-path, <uri-to-string> uri))\)> asts;
+        astsFilePairs := <map(\(ast, uri) -> (ast, (full-path, <index-uri-to-string> uri))\)> asts;
         Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
       else
         Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
@@ -175,7 +175,7 @@
 	analyze-top-store-ast:
 	  (ast, file) -> <id>
 	  with
-      <index-set-global(|[<filepair-to-string> file, "ast"])> ast
+      <index-set-global(|[<index-filepair-to-string> file, "ast"])> ast
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
@@ -427,7 +427,7 @@
           elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
           units := <map(index-transform-qualifier(|node))> elems
         case index-is-toplevel:
-          units := [(node, <index-path> <nam-get-definition-key> node)]
+          units := [(node, <index-uri> <nam-get-definition-key> node)]
         otherwise:
           units := [(node, [])]
       end
@@ -479,7 +479,7 @@
   analyze-astdiff:
     (ast, file) -> file
     where
-    	name := [<filepair-to-string> file, "ast-checksum"];
+    	name := [<index-filepair-to-string> file, "ast-checksum"];
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
       	<index-set-global(|name)> newChecksum;

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May  7 17:31:35 2012	(r24798)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May  7 19:48:34 2012	(r24799)
@@ -130,7 +130,7 @@
    */
   index-end-transaction = prim("LANG_index_end_transaction")
   
-rules // Index API
+rules // Index querying
   
   /**
    * Gets the file that the analysis is currently in.
@@ -234,6 +234,8 @@
   indexlib-get-value:
     template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
     
+rules // Index globals
+    
   /**
    * Gets the 'fake' path where globals are stored in the index.
    *
@@ -367,6 +369,8 @@
     where
       <indexlib-get> Global(<index-boolean-globals-uri> name)
 
+rules // Index utility
+
   /**
    * Queries if given index file is a 'fake' file for storing internal data.
    */
@@ -418,12 +422,34 @@
     where
       key := <collect-one(?_{_})> x
       
-  uri-to-string = take-until(?Anon(_)); reverse; separate-by(|"."); concat-strings
+  /**
+   * Converts a URI to a string.
+   *
+   * Example:
+   *   <index-uri-to-string> [Entity(), "Bar", "Baz"] => "Entity://Bar.Baz"
+   */
+  index-uri-to-string:
+    [ns|path] -> <concat-strings> [nsStr, "://", pathStr]
+    with
+      pathStr := <take-until(?Anon(_)); reverse; separate-by(|"."); concat-strings> path;
+      nsStr := <?<id>#(_)> ns
   
-  filepair-to-string:
+  /**
+   * Converts a file pair ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-filepair-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   */
+  index-filepair-to-string:
     (file, "") -> file
     
-  filepair-to-string:
+  /**
+   * Converts a file pair ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-filepair-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
+   */
+  index-filepair-to-string:
     (file, subfile) -> <concat-strings> [file, "@", subfile]
     where
       not("" := subfile)

From gabrielkonat at gmail.com  Mon May  7 23:05:17 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 07 May 2012 21:05:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24800 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans
	spoofax-contrib/se...
Message-ID: <20120507210518.00FCB2B800F@mx2.tudelft.nl>

Author: gkonat
Date: Mon May  7 21:05:17 2012
New Revision: 24800
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24800&sc=1

Log:
Code cleanup.
Added a few extra utility functions to the index libraries.
Added and updated some documentation of the index libraries.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/check.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test1.ewa
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test2.ewa
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May  7 21:05:17 2012	(r24800)
@@ -27,11 +27,11 @@
     with
       ast'                    := <desugar-all> ast; // Optional AST desugaring
       (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
-      index-start-transaction;
-      errors                  := <collect-all(constraint-error, conc)> ast'';
-      warnings                := <collect-all(constraint-warning, conc)> ast'';
-      notes                   := <collect-all(constraint-note, conc)> ast'';
-      index-end-transaction;
+      index-transaction(
+        errors                := <collect-all(constraint-error, conc)> ast'';
+        warnings              := <collect-all(constraint-warning, conc)> ast'';
+        notes                 := <collect-all(constraint-note, conc)> ast''
+      );
       filesToAnalyze'         := <make-set> <map(index-filepair-to-file)> filesToAnalyze
 
   // Main entry point for analyzes, called when a single file is opened in the editor.
@@ -64,7 +64,8 @@
       <trigger-commit-and-compile> <language>
       
   // Queue parallel analysis for given list of files.
-  editor-queue-analysis = not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
   
   // Executes parallel analysis using the index library.
   editor-parallel-analyze:
@@ -83,6 +84,7 @@
   generate-deffed:
     (selected, position, ast, path, project-path) -> (filename, result)
     with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       filename := <guarantee-extension(|"aterm")> path;
       result   := <analyze-defs(|Anon(), Anon())> selected
   
@@ -122,9 +124,9 @@
     (node, position, ast, path, project-path) -> target
     where
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      index-start-transaction;
-      target := <index-lookup> node;
-      index-end-transaction
+      index-transaction(
+        target := <index-lookup> node
+      )
 
   // Returns "hover help" information for a particular node in the editor.
   // For references, this rule is invoked using the resolved term.
@@ -139,19 +141,10 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      ast'              := <desugar-all> ast;
-      (ast'', _)        := <analyze-top(|<language>)> (ast', path, project-path);
-      x                 := <collect-one(?COMPLETION(_))> ast'';
-      COMPLETION(name)	:= x;
-      index-start-transaction;
-      (
-        proposals       := <index-lookup-all-levels(|name)> x 
-      <+ 
-        proposals 			:= []
+      ast' := <desugar-all> ast;
+      (ast'', _) := <analyze-top(|<language>)> (ast', path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast'';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
       );
-      index-end-transaction;
-      proposals'        := <map(def-to-name)> proposals
-
-  def-to-name:
-    Def([namespace, name | _]) -> name
-  
\ No newline at end of file
+      proposals' := <map(index-uri-name)> proposals
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/check.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/check.str	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/check.str	Mon May  7 21:05:17 2012	(r24800)
@@ -60,7 +60,7 @@
     x{_} -> (x, $[Use before definition])
     where
       not(<index-is-definition> x);
-      namespace := <index-namespace> x;
+      namespace := <index-uri-namespace> x;
       <is-ordered-namespace> namespace;
       def := <index-lookup> x;
       <gt> (<Fst> <origin-offset> def, <Fst> <origin-offset> x);

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May  7 21:05:17 2012	(r24800)
@@ -26,11 +26,11 @@
     with
       ast'                    := <id> ast; // Optional AST desugaring
       (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
-      index-start-transaction;
-      errors                  := <collect-all(constraint-error, conc)> ast'';
-      warnings                := <collect-all(constraint-warning, conc)> ast'';
-      notes                   := <collect-all(constraint-note, conc)> ast'';
-      index-end-transaction;
+      index-transaction(
+        errors                := <collect-all(constraint-error, conc)> ast'';
+        warnings              := <collect-all(constraint-warning, conc)> ast'';
+        notes                 := <collect-all(constraint-note, conc)> ast''
+      );
       filesToAnalyze'         := <make-set> <map(index-filepair-to-file)> filesToAnalyze
 
   // Main entry point for analyzes, called when a single file is opened in the editor.
@@ -63,7 +63,8 @@
       <trigger-commit-and-compile> <language>
       
   // Queue parallel analysis for given list of files.
-  editor-queue-analysis = not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
       
   // Executes parallel analysis using the index library.
   editor-parallel-analyze:
@@ -82,6 +83,7 @@
   generate-deffed:
     (selected, position, ast, path, project-path) -> (filename, result)
     with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       filename := <guarantee-extension(|"aterm")> path;
       result   := <analyze-defs(|Anon(), Anon())> selected
   
@@ -121,9 +123,9 @@
     (node, position, ast, path, project-path) -> target
     where
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      index-start-transaction;
-      target := <index-lookup> node;
-      index-end-transaction
+      index-transaction(
+        target := <index-lookup> node
+      )
 
   // Returns "hover help" information for a particular node in the editor.
   // For references, this rule is invoked using the resolved term.
@@ -138,17 +140,9 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      (ast', _)         := <analyze-top(|<language>)> (ast, path, project-path);
-      x                 := <collect-one(?COMPLETION(_))> ast';
-      COMPLETION(name)  := x;
-      index-start-transaction;
-      (
-        proposals       := <index-lookup-all-levels(|name)> x
-      <+ 
-        proposals 			:= []
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
       );
-      index-end-transaction;
-      proposals'        := <map(def-to-name)> proposals
-
-  def-to-name:
-    Def([namespace, name | _]) -> name
+      proposals' := <map(index-uri-name)> proposals
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test1.ewa
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test1.ewa	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test1.ewa	Mon May  7 21:05:17 2012	(r24800)
@@ -3,4 +3,4 @@
 entity Ent1
 {
 	mValue : String
-} 
\ No newline at end of file
+}
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test2.ewa
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test2.ewa	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/test/test2.ewa	Mon May  7 21:05:17 2012	(r24800)
@@ -7,6 +7,6 @@
 	Print() {
 		var tst : String = mEnt.mValue
 
-		print tst
+		print mEnt
 	}
 }
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May  7 21:05:17 2012	(r24800)
@@ -27,11 +27,11 @@
     with
       ast'                    := <id> ast; // Optional AST desugaring
       (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
-      index-start-transaction;
-      errors                  := <collect-all(constraint-error, conc)> ast'';
-      warnings                := <collect-all(constraint-warning, conc)> ast'';
-      notes                   := <collect-all(constraint-note, conc)> ast'';
-      index-end-transaction;
+      index-transaction(
+	      errors                := <collect-all(constraint-error, conc)> ast'';
+	      warnings              := <collect-all(constraint-warning, conc)> ast'';
+	      notes                 := <collect-all(constraint-note, conc)> ast''
+      );
       filesToAnalyze'         := <make-set> <map(index-filepair-to-file)> filesToAnalyze
 
   // Main entry point for analyzes, called when a single file is opened in the editor.
@@ -64,7 +64,8 @@
       <trigger-commit-and-compile> <language>
       
   // Queue parallel analysis for given list of files.
-  editor-queue-analysis = not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
       
   // Executes parallel analysis using the index library.
   editor-parallel-analyze:
@@ -83,6 +84,7 @@
   generate-deffed:
     (selected, position, ast, path, project-path) -> (filename, result)
     with
+    	index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       filename := <guarantee-extension(|"aterm")> path;
       result   := <analyze-defs(|Anon(), Anon())> selected
   
@@ -122,9 +124,9 @@
     (node, position, ast, path, project-path) -> target
     where
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      index-start-transaction;
-      target := <index-lookup> node;
-      index-end-transaction
+      index-transaction(
+        target := <index-lookup> node
+      )
 
   // Returns "hover help" information for a particular node in the editor.
   // For references, this rule is invoked using the resolved term.
@@ -139,20 +141,12 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      (ast', _)         := <analyze-top(|<language>)> (ast, path, project-path);
-      x                 := <collect-one(?COMPLETION(_))> ast';
-      COMPLETION(name)  := x;
-      index-start-transaction;
-      (
-        proposals       := <index-lookup-all-levels(|name)> x
-      <+ 
-        proposals       := []
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
       );
-      index-end-transaction;
-      proposals'        := <map(def-to-name)> proposals
-
-  def-to-name:
-    Def([namespace, name | _]) -> name
+      proposals' := <map(index-uri-name)> proposals
   
   // Generates random test files.  
   generate-test-files:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May  7 21:05:17 2012	(r24800)
@@ -83,12 +83,14 @@
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
-   * @param phase     The type of analysis phase. There are 2 phases to choose from:
-   *                  - Editor():   File dependencies are analysed and returned.
-   *                  - Compile():  File dependencies are not analysed and empty lists are returned.
-   * @param language  The name of the language that is being analysed.
+   * @param phase         The type of analysis phase. There are 2 phases to choose from:
+   *                      - Editor():   File dependencies are analysed.
+   *                      - Compile():  File dependencies are not analysed.
+   * @param language      The name of the language that is being analysed.
+   * @param path          The path of the file to analyze relative to project-path.
+   * @param project-path  The path of the directory that contains all the source files.
    *
-   * @see analyze-top-internal(|phase, language)
+   * @see analyze-top-internal(|phase, language, project-path, full-path)
    */
   analyze-top(|phase, language, path, project-path):
     ast -> (ast', filesToAnalyze)
@@ -97,87 +99,15 @@
       if index-split then
         index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
         asts := <index-toplevel-split> ast;
-        astsFilePairs := <map(\(ast, uri) -> (ast, (full-path, <index-uri-to-string> uri))\)> asts;
-        Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
+        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
       else
-        Results(ast', _, _, _, _, _, filesToAnalyze) := <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
       end
   
   /**
-   * Add URI annotations to each definition and unresolved URI annotations to each use site.
-   *
-   * @internal
-   */
-  analyze-top-defs:
-    (ast, file) -> ((ast2, file), defs)
-    with
-			<index-set-current-file> file;
-			(Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
-			<index-add-all(|file)> defs
-			
-  /**
-   * Gathers all data for each definition.
-   *
-   * @internal
-   */
-  analyze-top-data(|language, full-path):
-    (ast, file) -> ((ast2, file), data2)
-    with
-			<index-set-current-file> file;
-			{| Index-ReadSet:
-			  readSet := <new-iset>;
-			  rules(Index-ReadSet: _ -> readSet);
-			  
-			  // Gather all data for each definition.
-			  ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
-			  data := <origin-track-forced(analyze-tree-data)> ast2;
-			  
-			  // Resolve all references in gathered data.
-			  (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
-			  <index-add-all(|file)> data2;
-			  
-			  // Store reads into the index (if not testing language)
-			  if not(is-test-input(|language, full-path)) then
-			    <index-add-all(|file)> <iset-elements> readSet
-			  end
-			|}
-			
-  /**
-   * Resolves all unresolved references for each use site.
-   *
-   * @internal
-   */
-	analyze-top-uses(|language, full-path):
-    (ast, file) -> ((ast3, file), uses)
-    with
-			<index-set-current-file> file;
-			{| Index-ReadSet:
-			  readSet := <new-iset>;
-			  rules(Index-ReadSet: _ -> readSet);
-			  
-			  // Resolve all unresolved references for each use site.
-			  (ast2, uses) := <analyze-uses> ast;
-			  <index-add-all(|file)> uses;
-			  
-			  ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
-			  
-			  // Store reads into the index (if not testing language)
-			  if not(is-test-input(|language, full-path)) then
-			    <index-add-all(|file)> <iset-elements> readSet
-			  end
-			|}
-			
-  /**
-   * Stores AST from file to the index.
-   *
-   * @internal
-   */		
-	analyze-top-store-ast:
-	  (ast, file) -> <id>
-	  with
-      <index-set-global(|[<index-filepair-to-string> file, "ast"])> ast
-  
-  /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
    * @internal
@@ -227,6 +157,80 @@
       end
     with
     	<list-loop(analyze-top-store-ast)> astFilePairs4
+    	
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
+    with
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
+      
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Gather all data for each definition.
+        ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|[<index-file-to-string> file, "ast"])> ast
       
   /**
    * Identifies all definitions in the tree and annotates them with their URI.
@@ -235,6 +239,7 @@
    * @internal
    */
   analyze-defs = analyze-defs(|Anon(), Anon())
+  /** @internal */
   analyze-defs(|head-scope, head-scope-ns):
     ast -> (ast', defs')
     with
@@ -479,7 +484,7 @@
   analyze-astdiff:
     (ast, file) -> file
     where
-    	name := [<index-filepair-to-string> file, "ast-checksum"];
+    	name := [<index-file-to-string> file, "ast-checksum"];
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
       	<index-set-global(|name)> newChecksum;
@@ -502,7 +507,7 @@
    */
   analyze-get-compilediffs = index-get-all-globals(|"compile-diff"); index-clear-global(|"compile-diff")
  
-rules // index API primitives
+rules // index API query primitives
  
   /**
    * Gets all DefData entries that match the kind of data and URI in given definition.
@@ -597,38 +602,6 @@
    */
   index-get-value:
     template -> <index-value> <?[<id>|_]> <index-get-all> template
-   
-  /**
-   * Gets the namespace part of the URI for given key (term{uri} element).
-   *
-   * Example:
-   *   <index-namespace> "Bar"{[Entity(), "Bar"]} => Entity() 
-   */
-  index-namespace:
-    x{[namespace | path]} -> <index-namespace-unwrap> namespace
-
-  /**
-   * Gets the path part of the URI for given key (term{uri} element).
-   *
-   * Example:
-   *   <index-path> "Bar"{[Entity(), "Bar"]} => ["Bar"]
-   */
-  index-path:
-    x{[namespace | path]} -> path'
-    where
-      if !namespace => Unresolved(namespace) then
-        Def(path') := <index-lookup>
-      else
-        path' := path
-      end
-    
-  /**
-   * Determines if a given AST node is a definition site, according to the syntax.
-   *
-   * TODO: Does not work?
-   */
-  index-is-definition =
-    where(nam-get-definition-key)
 
   /**
    * Gets all Def children elements of an URI in a certain namespace.
@@ -718,7 +691,7 @@
   index-get-dependent-files = 
     index-get-referenced-files(index-file-dependent-construct)
      
-rules // index lookup rules (take into account adjust-index-lookup)
+rules // Index lookup rules (take into account adjust-index-lookup)
  
   /**
    * Given an annotated AST node, resolves it, returning its Def.
@@ -897,6 +870,75 @@
       end
     <+
       defs := []
+      
+rules // Index utilities
+  
+  /**
+   * Gets the namespace part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-namespace> "Bar"{[Entity(), "Bar", "Baz"]} => Entity() 
+   */
+  index-uri-namespace:
+    x{[namespace|path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   *
+   * Example:
+   *   <index-uri-path> "Bar"{[Entity(), "Bar", "Baz"]} => ["Bar", "Baz"]
+   */
+  index-uri-path:
+    x{[namespace|path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+      
+  /**
+   * Gets the name part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-name> "Bar"{[Entity(), "Bar", "Baz"] => "Bar"
+   */ 
+  index-uri-name:
+    x{[_|[name|_]]} -> name
+    
+  /**
+   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
+   *
+   * Example:
+   *   <index-uri-name> Def([Entity(), "Bar", "Baz"]) => "Bar"
+   *   <index-uri-name> Type("Foo") => fail
+   *   <index-uri-name> Read([Entity()]) => fail
+   */   
+  index-uri-name:
+    x -> <index-uri-name> <index-uri> x
+    where
+      not(<has-annos> x)
+    
+  /**
+   * Determines if a given AST node is a definition site, according to the syntax.
+   *
+   * TODO: Does not work?
+   */
+  index-is-definition =
+    where(nam-get-definition-key)
+    
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
+   *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
+   *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
        
 /** @internal */
 rules // URI and value projections
@@ -950,6 +992,11 @@
   fake-file = is-test-file <+ index-is-fake-file
       
   index-filepair-to-file = Fst; string-replace(|$[[<project-path>]/], "")
+  
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uriStr))
+    with
+      (<index-uri-to-string> uri <+ !"") => uriStr
        
   index-is-name-substring(|name):
     template -> <id>
@@ -1018,6 +1065,9 @@
     )
   
   external SRTS-EXT-eq-ignore-annos(|t)
+  
+  index-key-unwrap = 
+    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
 
 /** @internal */
 rules // interface for generated code

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May  7 19:48:34 2012	(r24799)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May  7 21:05:17 2012	(r24800)
@@ -122,13 +122,26 @@
    * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
    * until index-end-transaction is called.
    */
-  index-start-transaction = prim("LANG_index_start_transaction")
+  index-start-transaction = 
+    prim("LANG_index_start_transaction")
   
   /**
    * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
    * added to the global index visible for other files.
    */
-  index-end-transaction = prim("LANG_index_end_transaction")
+  index-end-transaction = 
+    prim("LANG_index_end_transaction")
+  
+  /**
+   * Starts a transaction, applies given strategy and ends the transaction.
+   * 
+   * @param s The strategy to apply.
+   *
+   * @see index-start-transaction
+   * @see index-end-transaction
+   */
+  index-transaction(s) = 
+    prim("LANG_index_start_transaction"); s; prim("LANG_index_end_transaction")
   
 rules // Index querying
   
@@ -370,18 +383,52 @@
       <indexlib-get> Global(<index-boolean-globals-uri> name)
 
 rules // Index utility
-
-  /**
-   * Queries if given index file is a 'fake' file for storing internal data.
-   */
-  index-is-fake-file = string-starts-with(|"/.internal")
-    
+  
   /**
    * Gets the URI part for given term.
    */ 
   index-uri = index-uri-impl <+ index-uri-generic
   
   /**
+   * Gets the namespace part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => Entity()
+   */ 
+  index-uri-namespace =
+    ?[<id>|_]
+  
+  /**
+   * Gets the path part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => ["Bar", "Baz"]
+   *   <index-uri-path> [Entity()] => []
+   */ 
+  index-uri-path =
+    ?[_|<id>]
+    
+  /**
+   * Gets the name part of the given URI or fail if there is no name.
+   *
+   * Example:
+   *   <index-uri-name> [Entity(), "Bar", "Baz"] => "Bar"
+   *   <index-uri-name> [Entity()] => fail
+   */ 
+  index-uri-name =
+    ?[_|[<id>|_]]
+  
+  /**
+   * Gets the value part for given term.
+   */  
+  index-value = index-value-impl <+ index-value-generic
+  
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   */
+  index-is-fake-file = string-starts-with(|"/.internal")
+  
+  /**
    * Checks if given URI's are equal. Discards anonymous scopes if necessary.
    *
    * Example:
@@ -395,24 +442,6 @@
   	  u1' := <index-uri-unwrap> u1;
   	  u2' := <index-uri-unwrap> u2;
       (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
-
-  /**
-   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
-   *
-   * Example:
-   *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
-   *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
-   *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
-   */      
-  index-key-eq:
-    (k1, k2) -> <id>
-    where
-      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
-  
-  /**
-   * Gets the value part for given term.
-   */  
-  index-value = index-value-impl <+ index-value-generic
   
   /**
    * Finds the first key (term{uri} element) for given term, or fail. 
@@ -435,21 +464,32 @@
       nsStr := <?<id>#(_)> ns
   
   /**
-   * Converts a file pair ((file, subfile) tuple) to a string.
+   * Converts a file to a string.
    *
    * Example:
-   *   <index-filepair-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   *   <index-file-to-string> "fullpath/file.ext" => "fullpath/file.ext"
    */
-  index-filepair-to-string:
+  index-file-to-string:
+    file -> file
+    where
+      not(<is-tuple> file)
+  
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   */
+  index-file-to-string:
     (file, "") -> file
     
   /**
-   * Converts a file pair ((file, subfile) tuple) to a string.
+   * Converts a file ((file, subfile) tuple) to a string.
    *
    * Example:
-   *   <index-filepair-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
+   *   <index-file-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
    */
-  index-filepair-to-string:
+  index-file-to-string:
     (file, subfile) -> <concat-strings> [file, "@", subfile]
     where
       not("" := subfile)
@@ -476,7 +516,4 @@
     \Unresolved(n) -> n\ <+ id
     
   index-uri-unwrap =
-    \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id
-    
-  index-key-unwrap = 
-    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
+    \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id
\ No newline at end of file

From gabrielkonat at gmail.com  Mon May  7 23:21:27 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 07 May 2012 21:21:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24801 - in
	spoofax-contrib/separate-compilation-examples:
	c-without-macros/trans csharp-partial-classses/trans
	entity-with-aspects/trans
Message-ID: <20120507212127.6BD7F2B800F@mx2.tudelft.nl>

Author: gkonat
Date: Mon May  7 21:21:27 2012
New Revision: 24801
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24801&sc=1

Log:
Restructured main stratego files.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May  7 21:05:17 2012	(r24800)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May  7 21:21:27 2012	(r24801)
@@ -15,10 +15,7 @@
   analysis-manual
   splitter
 
-rules // Main editor interface (defined by editor/C-without-macros-Builders and -References.esv)
-  
-  // Defines the current language.
-  language = !"C-without-macros"
+rules // Analysis
   
   // Analyzes the current program, returning a tuple with the analyzed AST, errors, warnings, notes and
   // files that should be re-analyzed.
@@ -42,17 +39,18 @@
       (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
       <try(editor-queue-analysis)> filesToAnalyze
       
-  // Main entry point for analyzes, called when multiple (changed) files have changed. 
+  // Main entry point for analyzes, called when multiple files have changed. 
   editor-analyze:
     files -> None()
     where
       not(is-tuple)
     with
       index-setup(|<language>, [<project-path>], ".");
-      disable-commit-and-compile
+      disable-commit-and-compile // Disable compilation during analysis.
     with
       editor-queue-analysis
     with
+      // Enable and trigger compilation after all files have been analysed.
       <enable-commit-and-compile> <language>;
       <trigger-commit-and-compile> <language>
       
@@ -62,16 +60,40 @@
     with
       index-setup(|<language>, [<project-path>], ".");
       <trigger-commit-and-compile> <language>
-      
-  // Queue parallel analysis for given list of files.
-  editor-queue-analysis = 
-    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+
+rules // Editor services
   
-  // Executes parallel analysis using the index library.
-  editor-parallel-analyze:
-    files -> None()
-    with
-      index-parallel-analyze-files(analyze)
+  // Resolves a reference when the user control-clicks or presses F3 in the editor.
+  editor-resolve:
+    (node, position, ast, path, project-path) -> target
+    where
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-transaction(
+        target := <index-lookup> node
+      )
+
+  // Returns "hover help" information for a particular node in the editor.
+  // For references, this rule is invoked using the resolved term.
+  editor-hover:
+    (target, position, ast, path, project-path) -> $[[uriString]]
+    where
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
+
+  // Completes an identifier when the user presses control-space
+  // (the completion identifier in the AST provides additional context information)
+  editor-complete:
+    (node, position, ast, path, project-path) -> proposals'
+    where
+      editor-init;
+      ast' := <desugar-all> ast;
+      (ast'', _) := <analyze-top(|<language>)> (ast', path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast'';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
+      );
+      proposals' := <map(index-uri-name)> proposals
+
+rules // Debugging
   
   // Prints the abstract syntax ATerm of a selection.
   generate-aterm:
@@ -119,32 +141,17 @@
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       index-clear
       
-  // Resolves a reference when the user control-clicks or presses F3 in the editor.
-  editor-resolve:
-    (node, position, ast, path, project-path) -> target
-    where
-      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      index-transaction(
-        target := <index-lookup> node
-      )
-
-  // Returns "hover help" information for a particular node in the editor.
-  // For references, this rule is invoked using the resolved term.
-  editor-hover:
-    (target, position, ast, path, project-path) -> $[[uriString]]
-    where
-      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
-
-  // Completes an identifier when the user presses control-space
-  // (the completion identifier in the AST provides additional context information)
-  editor-complete:
-    (node, position, ast, path, project-path) -> proposals'
-    where
-      editor-init;
-      ast' := <desugar-all> ast;
-      (ast'', _) := <analyze-top(|<language>)> (ast', path, project-path);
-      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast'';
-      index-transaction(
-        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
-      );
-      proposals' := <map(index-uri-name)> proposals
\ No newline at end of file
+rules // Utility
+      
+  // Defines the current language.
+  language = !"C-without-macros"
+  
+  // Queue parallel analysis for given list of files.
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+  
+  // Executes parallel analysis using the index library.
+  editor-parallel-analyze:
+    files -> None()
+    with
+      index-parallel-analyze-files(analyze)

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May  7 21:05:17 2012	(r24800)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May  7 21:21:27 2012	(r24801)
@@ -14,10 +14,7 @@
   analysis-manual
   splitter
 
-rules // Main editor interface (defined by editor/CSharpPartialClassses-Builders and -References.esv)
-  
-  // Defines the current language.
-  language = !"CSharpPartialClassses"
+rules // Analysis
   
   // Analyzes the current program, returning a tuple with the analyzed AST, errors, warnings, notes and
   // files that should be re-analyzed.
@@ -41,20 +38,21 @@
       (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
       <try(editor-queue-analysis)> filesToAnalyze
       
-  // Main entry point for analyzes, called when multiple (changed) files have changed. 
+  // Main entry point for analyzes, called when multiple files have changed. 
   editor-analyze:
     files -> None()
     where
       not(is-tuple)
     with
       index-setup(|<language>, [<project-path>], ".");
-      disable-commit-and-compile
+      disable-commit-and-compile // Disable compilation during analysis.
     with
       editor-queue-analysis
     with
+      // Enable and trigger compilation after all files have been analysed.
       <enable-commit-and-compile> <language>;
       <trigger-commit-and-compile> <language>
-      
+ 
   // Called when current file is saved.
   editor-save:
     (ast, _, _, _, _) -> None()
@@ -62,15 +60,38 @@
       index-setup(|<language>, [<project-path>], ".");
       <trigger-commit-and-compile> <language>
       
-  // Queue parallel analysis for given list of files.
-  editor-queue-analysis = 
-    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+rules // Editor services
+  
+  // Resolves a reference when the user control-clicks or presses F3 in the editor.
+  editor-resolve:
+    (node, position, ast, path, project-path) -> target
+    where
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-transaction(
+        target := <index-lookup> node
+      )
+
+  // Returns "hover help" information for a particular node in the editor.
+  // For references, this rule is invoked using the resolved term.
+  editor-hover:
+    (target, position, ast, path, project-path) -> $[[uriString]]
+    where
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
+
+  // Completes an identifier when the user presses control-space
+  // (the completion identifier in the AST provides additional context information)
+  editor-complete:
+    (node, position, ast, path, project-path) -> proposals'
+    where
+      editor-init;
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
+      );
+      proposals' := <map(index-uri-name)> proposals
       
-  // Executes parallel analysis using the index library.
-  editor-parallel-analyze:
-    files -> None()
-    with
-      index-parallel-analyze-files(analyze)
+rules // Debugging
   
   // Prints the abstract syntax ATerm of a selection.
   generate-aterm:
@@ -78,14 +99,6 @@
     with
       filename := <guarantee-extension(|"aterm")> path;
       result   := selected
-      
-  // Prints the definition annotated abstract syntax ATerm of a selection.
-  generate-deffed:
-    (selected, position, ast, path, project-path) -> (filename, result)
-    with
-      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      filename := <guarantee-extension(|"aterm")> path;
-      result   := <analyze-defs(|Anon(), Anon())> selected
   
   // Prints the analyzed annotated abstract syntax ATerm of a selection.
   generate-analyzed:
@@ -95,6 +108,14 @@
       filename := <guarantee-extension(|"analyzed.aterm")> path;
       result   := <analyze> (selected, path, project-path)   
       
+  // Prints the definition annotated abstract syntax ATerm of a selection.
+  generate-deffed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := <analyze-defs(|Anon(), Anon())> selected
+      
   // Prints the entries in the index of the current file.
   index-currentfile:
     (selected, position, ast, path, project-path) -> (filename, result)
@@ -117,32 +138,18 @@
     with
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       index-clear
+      
+rules // Utility
+      
+  // Defines the current language.
+  language = !"CSharpPartialClassses"
   
-  // Resolves a reference when the user control-clicks or presses F3 in the editor.
-  editor-resolve:
-    (node, position, ast, path, project-path) -> target
-    where
-      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      index-transaction(
-        target := <index-lookup> node
-      )
-
-  // Returns "hover help" information for a particular node in the editor.
-  // For references, this rule is invoked using the resolved term.
-  editor-hover:
-    (target, position, ast, path, project-path) -> $[[uriString]]
-    where
-      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
-
-  // Completes an identifier when the user presses control-space
-  // (the completion identifier in the AST provides additional context information)
-  editor-complete:
-    (node, position, ast, path, project-path) -> proposals'
-    where
-      editor-init;
-      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
-      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
-      index-transaction(
-        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
-      );
-      proposals' := <map(index-uri-name)> proposals
\ No newline at end of file
+  // Queue parallel analysis for given list of files.
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+      
+  // Executes parallel analysis using the index library.
+  editor-parallel-analyze:
+    files -> None()
+    with
+      index-parallel-analyze-files(analyze)

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May  7 21:05:17 2012	(r24800)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May  7 21:21:27 2012	(r24801)
@@ -15,10 +15,7 @@
   analysis-manual
   splitter
 
-rules // Main editor interface (defined by editor/EntityWithAspects-Builders and -References.esv)
-  
-  // Defines the current language.
-  language = !"EntityWithAspects"
+rules // Analysis
   
 	// Analyzes the current program, returning a tuple with the analyzed AST, errors, warnings, notes and
 	// files that should be re-analyzed.
@@ -42,17 +39,18 @@
       (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
       <try(editor-queue-analysis)> filesToAnalyze
       
-  // Main entry point for analyzes, called when multiple (changed) files have changed. 
+  // Main entry point for analyzes, called when multiple files have changed. 
   editor-analyze:
     files -> None()
     where
       not(is-tuple)
     with
     	index-setup(|<language>, [<project-path>], ".");
-      disable-commit-and-compile
+      disable-commit-and-compile // Disable compilation during analysis.
     with
       editor-queue-analysis
     with
+      // Enable and trigger compilation after all files have been analysed.
       <enable-commit-and-compile> <language>;
       <trigger-commit-and-compile> <language>
       
@@ -62,17 +60,40 @@
     with
       index-setup(|<language>, [<project-path>], ".");
       <trigger-commit-and-compile> <language>
-      
-  // Queue parallel analysis for given list of files.
-  editor-queue-analysis = 
-    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
-      
-  // Executes parallel analysis using the index library.
-  editor-parallel-analyze:
-    files -> None()
-    with
-      index-parallel-analyze-files(analyze)
-      
+
+rules // Editor services
+  
+  // Resolves a reference when the user control-clicks or presses F3 in the editor.
+  editor-resolve:
+    (node, position, ast, path, project-path) -> target
+    where
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-transaction(
+        target := <index-lookup> node
+      )
+
+  // Returns "hover help" information for a particular node in the editor.
+  // For references, this rule is invoked using the resolved term.
+  editor-hover:
+    (target, position, ast, path, project-path) -> $[[uriString]]
+    where
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
+
+  // Completes an identifier when the user presses control-space
+  // (the completion identifier in the AST provides additional context information)
+  editor-complete:
+    (node, position, ast, path, project-path) -> proposals'
+    where
+      editor-init;
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
+      );
+      proposals' := <map(index-uri-name)> proposals
+
+rules // Debugging
+  
   // Prints the abstract syntax ATerm of a selection.
   generate-aterm:
     (selected, position, ast, path, project-path) -> (filename, result)
@@ -80,14 +101,6 @@
       filename := <guarantee-extension(|"aterm")> path;
       result   := selected
       
-  // Prints the definition annotated abstract syntax ATerm of a selection.
-  generate-deffed:
-    (selected, position, ast, path, project-path) -> (filename, result)
-    with
-    	index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      filename := <guarantee-extension(|"aterm")> path;
-      result   := <analyze-defs(|Anon(), Anon())> selected
-  
   // Prints the analyzed annotated abstract syntax ATerm of a selection.
   generate-analyzed:
     (selected, position, ast, path, project-path) -> (filename, result)
@@ -96,6 +109,14 @@
       filename := <guarantee-extension(|"analyzed.aterm")> path;
       result   := <analyze-top(|<language>)> (selected, path, project-path)   
       
+  // Prints the definition annotated abstract syntax ATerm of a selection.
+  generate-deffed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := <analyze-defs(|Anon(), Anon())> selected
+      
   // Prints the entries in the index of the current file.
   index-currentfile:
     (selected, position, ast, path, project-path) -> (filename, result)
@@ -119,39 +140,24 @@
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       index-clear
       
-  // Resolves a reference when the user control-clicks or presses F3 in the editor.
-  editor-resolve:
-    (node, position, ast, path, project-path) -> target
-    where
-      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
-      index-transaction(
-        target := <index-lookup> node
-      )
-
-  // Returns "hover help" information for a particular node in the editor.
-  // For references, this rule is invoked using the resolved term.
-  editor-hover:
-    (target, position, ast, path, project-path) -> $[[uriString]]
-    where
-      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
-
-  // Completes an identifier when the user presses control-space
-  // (the completion identifier in the AST provides additional context information)
-  editor-complete:
-    (node, position, ast, path, project-path) -> proposals'
-    where
-      editor-init;
-      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
-      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
-      index-transaction(
-        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
-      );
-      proposals' := <map(index-uri-name)> proposals
-  
   // Generates random test files.  
   generate-test-files:
     (selected, position, ast, path, project-path) -> None()
     with
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       <testgen> (selected, position, ast, path, project-path)
-    
\ No newline at end of file
+    
+rules // Utility
+  
+  // Defines the current language.
+  language = !"EntityWithAspects"
+  
+  // Queue parallel analysis for given list of files.
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+      
+  // Executes parallel analysis using the index library.
+  editor-parallel-analyze:
+    files -> None()
+    with
+      index-parallel-analyze-files(analyze)

From oskarvanrest at gmail.com  Tue May  8 02:46:30 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Tue, 08 May 2012 00:46:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24802 - in
	experimental/graphical-editor/EntityLang/EntityLang:
	editor/java/EntityLang/strategies trans
Message-ID: <20120508004630.15DCA108C004@mx3.tudelft.nl>

Author: OskarVanRest
Date: Tue May  8 00:46:27 2012
New Revision: 24802
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24802&sc=1

Log:
Removed initialisation of the EMF package. Initialisation is already done by the GMF editor.

Deleted:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/initialize_emf_package_0_0.java
Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java
   experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java	Mon May  7 21:21:27 2012	(r24801)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java	Tue May  8 00:46:27 2012	(r24802)
@@ -11,7 +11,6 @@
   public InteropRegisterer() {
     super(new Strategy[] { 
     		java_strategy_0_0.instance,
-    		initialize_emf_package_0_0.instance,
     		create_instance_0_1.instance,
     		set_attribute_0_2.instance,
     		set_reference_0_2.instance,

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Mon May  7 21:21:27 2012	(r24801)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Tue May  8 00:46:27 2012	(r24802)
@@ -36,16 +36,19 @@
       // EMF stuff below
       fileExtension := <lower-case> <packName>;
       filename := <guarantee-extension(|fileExtension)> path;
-      <initialize-emf-package> <packName>;
+      // <initialize-emf-package> <packName>;
       ast''  := <to-emf(|path)> ast';
       result := <serialise-model(|path)> ast'';
       <replace-gmf-resource(|<packName>)> result
 	  
   save-emf:
   	(selected, position, ast, path, project-path) -> None()
+  	// where
+  	// 	<save> ast
   
-  external initialize-emf-package(|)
+  // external initialize-emf-package(|)
   external replace-gmf-resource(|packName)
+  // external save(|)
   
   // Transforms a selection to Java
   generate-java:

From dgroenewegen at gmail.com  Tue May  8 13:34:57 2012
From: dgroenewegen at gmail.com (Danny Groenewegen)
Date: Tue, 08 May 2012 11:34:57 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24803 - hydra/webdsl
Message-ID: <20120508113457.D12EECC11A@mx4.tudelft.nl>

Author: dgroenewegen
Date: Tue May  8 11:34:57 2012
New Revision: 24803
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24803&sc=1

Log:
add strc-java argument

Modified:
   hydra/webdsl/tests-separate-compilation.nix

Modified: hydra/webdsl/tests-separate-compilation.nix
==============================================================================
--- hydra/webdsl/tests-separate-compilation.nix	Tue May  8 00:46:27 2012	(r24802)
+++ hydra/webdsl/tests-separate-compilation.nix	Tue May  8 11:34:57 2012	(r24803)
@@ -1,6 +1,7 @@
 { nixpkgs ? ../../nixpkgs
 , nixos ? ../../nixos
 , webdslSrc ? {outPath = ../../webdsl; rev = 1234;}
+, strcJava ? { outPath = ./. ;}
 }:
 let 
   pkgs = import nixpkgs { system = "i686-linux"; };
@@ -23,7 +24,7 @@
  
   defaultMaintainters = [ "rob.vermaas at gmail.com" "dgroenewegen at gmail.com" ];
   webdslRelease = import "${webdslSrc}/release.nix" { inherit nixpkgs ; };
-  webdsl = webdslRelease.buildJava { tarball = webdslRelease.tarball { webdslsSrc = webdslSrc; } ; } ;
+  webdsl = webdslRelease.buildJava { tarball = webdslRelease.tarball { inherit strcJava; webdslsSrc = webdslSrc; } ; } ;
    
   build = appname : src : maintainers :
     pkgs.stdenv.mkDerivation rec {

From gabrielkonat at gmail.com  Tue May  8 13:50:02 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 11:50:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24804 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120508115002.1D1062B8034@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  8 11:50:01 2012
New Revision: 24804
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24804&sc=1

Log:
Added and improved comment documentation.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 11:34:57 2012	(r24803)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 11:50:01 2012	(r24804)
@@ -31,29 +31,103 @@
   // Parallel
   ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
   
-rules // extension points
+rules // Index analysis extension points
  
-  // Should return list of Def(_) and/or [namespace | path] or StopLookup() to stop the lookup
-  adjust-index-lookup(is-use |namespace, path, prefix) = fail
- 
-  // Should call <store-results> on a (list of) DefData
-  adjust-index-def-data(store-results |namespace, path) = fail
- 
-  // Should return a path
-  adjust-index-path(is-def |namespace, path) = fail
- 
-  // adjust-index-path-from-filesystem(|project-path, path)
+  /**
+   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
+   *
+   * The overriden rule must return a list that contains any of the following items:
+   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
+   *                        use site to this definition.
+   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
+   * 
+   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
+   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
+   * will be used.
+   *
+   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
+   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
+   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
+   * lookups that will always fail anyway.
+   *
+   * Extension example:
+	 *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+	 *	   PropAccess(exp, name) -> properties
+	 *     where
+	 *       <check-target-name> name
+	 *	   with
+   *	     if TYPE(type{_}) := <type-of> exp then
+	 *	       properties := <index-lookup-children(|Property(), prefix)> type
+	 *	     else
+	 *	       properties := StopLookup()
+	 *	     end
+	 *
+	 *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     Var(name) -> [[Var() | path], [Property() | path]]
+   *     where
+   *       <check-target-name> name
+   *
+   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
+   *                            lookup algorithm is looking for.
+   * @param namespace           The namespace of the element that should be looked up.
+   * @param path                The path the lookup algorithm is currently looking at for the element.
+   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
+   *                            full name of the element, but could be a partial prefix during content completion.
+   */
+  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
+  
+  /** 
+   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
+   * a (list of) data that must be stored in the index.
+   *
+   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
+   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
+   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
+   * rule fail if you are doing a <filter(store-results)> for example.
+   *
+   * Extension example:
+	 *   adjust-index-def-data(store-results|namespace, path):
+	 *     def -> <store-results> Type([namespace|path], type)
+	 *     where
+	 *       type := <type-of> def
+   *
+   * @param store-results Call this on the data you want to store in the index.
+   * @param namespace     The namespace of the definition that the rule is being called on.
+   * @param path          The path of the definition that the rule is being called on.
+   */
+  adjust-index-def-data(store-results|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
+   * use sites. Should return a path that will be assigned to the definition or use site.
+   *
+   * Extension example:
+   *   adjust-index-path(check-target-definition|namespace, path):
+   *     Start(_, _) -> [<string-replace(|<project-path>, "")> <Fst> <index-get-current-file>]
+   *
+   *
+   * @param check-target-definition 
+   * @param namespace               The namespace that would be given to the current definition or use site.
+   * @param path                    The path that would be given to the current definition or use site.
+   */
+  adjust-index-path(check-target-definition|namespace, path) = fail
   
   /**
-   * Should define constructors to check for difference during analysis. Defaults to Def constructs.
+   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
+   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
    *
    * Extension example:
    *   index-diff-constructors = ?Type(_, _)
+   *
+   * @see index-diff-compare
    */
-  index-diff-constructors = ?Def(_)
+  index-diff-constructors = 
+    ?Def(_)
   
   /**
-   * Should compare two index elements and fail if they are not equal.
+   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
+   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
+   * compared.
    *
    * Extension example:
 	 *   index-diff-compare:
@@ -61,13 +135,15 @@
    *     where
    *       <index-uri-eq> (u1, u2);
    *       <eq> (v1, v2)
+   *
+   * @see index-diff-constructors
    */
   index-diff-compare:
     (Def(u1), Def(u2)) -> <id>
     where
        <index-uri-eq> (u1, u2)
  
-rules // analysis traversals
+rules // Analysis traversals
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
@@ -148,9 +224,9 @@
 	      changed := <conc> (added, removed);
 	      
         // Store files that have changed in the index
-        index-start-transaction;
-        filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4;
-        index-end-transaction
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
 	    else
 	      (added, removed) := ([], []);
 	      filesToAnalyze := []
@@ -355,8 +431,18 @@
         <iset-add(|t)> set
       end
   
-rules // parallel analysis
+rules // Parallel analysis
   
+  /**
+   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
+   * analysis of dependent files that have changed during the analysis.
+   *
+   * Example:
+   *   <index-parallel-analyze-files(analyze)> ["text/file1.ext", "text/file2.ext"]
+   *
+   * @param analyze Strategy that analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and
+   *                must return a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   */
   index-parallel-analyze-files(analyze):
     files -> None()
     with
@@ -406,15 +492,22 @@
       if [] := filesToAnalyze then
         complete-work-unit
       end
-
-rules // splitter
+      
+/** @internal */
+rules // Splitter
   
+  /** @internal */
   index-split = fail
+  /** @internal */
   index-is-toplevel = fail
+  /** @internal */
   index-is-qualifier = fail
+  /** @internal */
   index-qualifier-subelements = fail
+  /** @internal */
   index-create-qualifier(|qualifier) = fail
   
+  /** @internal */
   index-toplevel-split:
     ast -> asts'
     with
@@ -422,6 +515,7 @@
       asts      := <index-toplevel-split-internal> ast';
       asts'     := <strip-annos> asts
       
+  /** @internal */
   index-toplevel-split-internal:
     node -> units
     with
@@ -437,12 +531,14 @@
           units := [(node, [])]
       end
       
+  /** @internal */
   index-transform-qualifier(|node):
     (elem, subfileName) -> (qualifier, subfileName)
     with
     	qualifier := <index-create-qualifier(|node)> elem
 
-rules // diffs
+/** @internal */
+rules // Diffs
   
   /** @internal */
   analyze-diff:
@@ -642,7 +738,8 @@
    *   <index-get-children(|Field(), "ba")> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), ...]
    *   <index-get-children(|Field(), "ze")> [Entity(), "Baz"] => [...]
    */
-  index-get-children(|namespace, prefix) = index-get-children(\uri -> Def(uri)\|namespace, prefix)
+  index-get-children(|namespace, prefix) = 
+  	index-get-children(\uri -> Def(uri)\|namespace, prefix)
   
   /**
    * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
@@ -943,31 +1040,43 @@
 /** @internal */
 rules // URI and value projections
        
+  /** @internal */
   index-uri-impl:
     Def(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     Use(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     Read(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
  
-  // TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
   index-uri-impl:
     ReadWildcard(uri, _) -> uri
 
+  /** @internal */
   index-value-impl:
     Def(value) -> value
 
+  /** @internal */
   index-value-impl:
     Use(value) -> value
 
+  /** @internal */
   index-value-impl:
     Read(value) -> value
-    
+  
+  /** @internal */
   index-value-impl:
     ReadWildcard(_, value) -> value
        
@@ -975,8 +1084,9 @@
 rules // Internal helpers
 
   /**
-   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) )
-   * to a tuple (C(a1, a2), [b1, b2, b3]).
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
    */
   unzip-analyzed:
     appl -> (appl', unzipped-parts)
@@ -984,31 +1094,48 @@
       appl'          := <all(\(a, _) -> a\)> appl;
       unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
        
-  // Tests if the current file is just a testing language input
-  is-test-file = string-ends-with(|".spt")
-  is-test-language = ?"Spoofax-Testing"
-  is-test-input(|language, path) = <is-test-language> language <+ <is-test-file> path
-      
-  fake-file = is-test-file <+ index-is-fake-file
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+  	string-ends-with(|".spt")
+  /** @internal */
+  is-test-language = 
+  	?"Spoofax-Testing"
+  /** @internal */
+  is-test-input(|language, path) = 
+  	<is-test-language> language <+ <is-test-file> path
       
-  index-filepair-to-file = Fst; string-replace(|$[[<project-path>]/], "")
+  /** @internal */
+  fake-file = 
+  	is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+  	Fst; string-replace(|$[[<project-path>]/], "")
   
+  /** @internal */
   ast-uri-to-ast-file(|full-path):
     (ast, uri) -> (ast, (full-path, uriStr))
     with
       (<index-uri-to-string> uri <+ !"") => uriStr
-       
+  
+  /** @internal */     
   index-is-name-substring(|name):
     template -> <id>
     with
       [_, uri-name | _] := <index-uri>
     where
       <is-substring(!name)> uri-name
-      
+   
+  /** @internal */    
   index-readwildcard-substring(|prefix):
     ReadWildcard(_, name) -> <id>
     where <is-substring(!prefix)> name
-    
+  
+  /** @internal */  
   store-wildcard-read(|namespace, path, prefix):
     children -> <id>
     with
@@ -1021,24 +1148,33 @@
           <iset-add(|ReadWildcard([namespace | path], prefix))> set
         end
       end
-      
-  index-is-unresolved(|x, uri) = Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
-  index-add-unresolved(|x, uri) = (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
   
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+  	Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+  	(Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
   index-file-dependent-construct: 
     uri -> <conc> (uses, reads)
     with
     	uses := <index-get-uses-all> Def(uri);
     	reads := <index-get-reads-all> Def(uri)
-    
-  index-file-dependency-filter = ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+  	?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
  
+  /** @internal */
   do-adjust-index-lookup(|namespace, path, use, prefix) =
     repeat-until(
       prim("SSL_EXT_get_parent", <id>)
     , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
     )
  
+  /** @internal */
   index-select(|namespace, path, use) =
     getfirst(
       where(
@@ -1046,6 +1182,7 @@
       )
     )
  
+  /** @internal */
   index-select-all(|namespace, path, use) =
     filter(
       where(
@@ -1053,33 +1190,43 @@
       )
     )
  
+  /** @internal */
   do-adjusted-index-path(|namespace, path, def) =
     adjust-index-path(origin-equal(|def) |namespace, path)
   <+
     ![def | path]
  
+  /** @internal */
   index-eq(|namespace, expected) =
     where(
       ?Def([_, name | _]);
       <SRTS-EXT-eq-ignore-annos(|expected)> name
     )
   
+  /** @internal */
   external SRTS-EXT-eq-ignore-annos(|t)
   
+  /** @internal */
   index-key-unwrap = 
     \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
 
 /** @internal */
-rules // interface for generated code
+rules // Interface for generated code
  
+  /** @internal */
   nam-get-def(|namespace):
     x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
-   
+  
+  /** @internal */ 
   nam-annotate-use(|namespace):
     t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
-   
+  
+  /** @internal */ 
   nam-get-scope-types = fail
+  /** @internal */
   nam-get-definition = fail
+  /** @internal */
   nam-get-definition-key = fail
+  /** @internal */
   nam-annotate-names(|def-path) = fail
   
\ No newline at end of file

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 11:34:57 2012	(r24803)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 11:50:01 2012	(r24804)
@@ -7,17 +7,39 @@
   lib/analysis-library
   
 rules // Extension points
-    
-  // Should desugar given ast.
+  
+  /**
+   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
+   *
+   * Extension example:
+   *   index-desugar-ast:
+   *     ast -> <desugar> ast
+   */
   index-desugar-ast = fail
     
-  // Should compile given analysed ast.
+  /**
+   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
+   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
+   * compilation.
+   *
+   * Extensions example:
+   *   index-compile-ast(|file, subfile):
+   *     ast -> None()
+   *     with
+   *       java := <to-java> ast;
+   *       full-path := <dirname> file;
+   *       filename := <guarantee-extension(|"java")> <base-filename> file;
+   *       writePath := $[[full-path]/java/];
+   *       writeFile :=  $[[writePath][filename]];
+   *       try(<mkdir> writePath);
+   *       <fclose> <fputs> (java, <fopen> (writeFile, "w"))
+   */
   index-compile-ast(|file, subfile) = fail
   
 rules // Compilation
   
   /**
-   * Schedules compilation of all files that have changed since the last compilation.
+   * Schedules compilation in the background of all files that have changed since the last compilation.
    */
   index-schedule-compilation:
     _ -> None()
@@ -76,7 +98,7 @@
 rules // On save handling
   
   /**
-   * Commits the index to disk and schedules compilation.
+   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
    *
    * @see trigger-commit-and-compile
    *
@@ -93,6 +115,9 @@
    * Triggers commit and compilation, requires target language as current term.
    * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
    * enable-commit-and-compile is called.
+   *
+   * @see enable-commit-and-compile
+   * @see disable-commit-and-compile
    */
   trigger-commit-and-compile:
     language -> <id>
@@ -105,12 +130,17 @@
   
   /**
    * Delays commit and compilation until enable-commit-and-compile is called.
+   *
+   * @see enable-commit-and-compile
    */
-  disable-commit-and-compile = index-enable-global(|"delay-compile")
+  disable-commit-and-compile = 
+    index-enable-global(|"delay-compile")
   
   /**
    * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
    * is triggered now.
+   *
+   * @see disable-commit-and-compile
    */
   enable-commit-and-compile:
     language -> <id>
@@ -123,17 +153,20 @@
 /** @internal */
 rules // Compile time reads
 
+  /** @internal */
   index-compilation-restore-read-file:
     (file, subfile) -> (file', subfile)
     with
       file' := <string-replace(|<index-compilation-read-path>, "")> file
       
+  /** @internal */
   index-compilation-clean-reads = 
     ?(file, subfile); index-compilation-file-tuple; index-clear-file
       
+  /** @internal */
   index-compilation-file-tuple:
     (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
     
+  /** @internal */
   index-compilation-read-path =
     !"/.internal/reads/compile"
-    
\ No newline at end of file

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 11:34:57 2012	(r24803)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 11:50:01 2012	(r24804)
@@ -33,6 +33,9 @@
    * Sets up the index library for given language and project paths.
    * Must be called once before doing anything with the library.
    *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   *
    * @obsolete
    */
   index-setup(|language, project-paths) =
@@ -40,8 +43,16 @@
     index-setup(|language, project-paths, ".")
     
   /**
-   * Sets up the index library for given language and project paths.
+   * Sets up the index library for given language, project paths and current file.
    * Must be called once before doing anything with the library.
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
+   *                      Can also be changed later using index-set-current-file.
+   *
+   * Example:
+   *   <index-setup(|"MiniJava", [<project-path>], "test/test.mjv")
    */
   index-setup(|language, project-paths, current-file) =
     prim("LANG_index_setup", language, project-paths, current-file)
@@ -59,6 +70,8 @@
   /**
    * Adds given element to the index with given file path and optionally subfile.
    *
+   * @param file  The file (and subfile) to add the element to.
+   *
    * Example:
    *   <index-add(|"fullpath/file.ext")> Def([Entity(), "Bar"])
    *   <index-add(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
@@ -69,6 +82,8 @@
   /**
    * Adds all given elements to the index with given file path and optionally subfile.
    *
+   * @param file  The file (and subfile) to add the elements to.
+   *
    * Example:
    *   <index-add-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
    *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
@@ -79,6 +94,8 @@
   /**
    * Removes given element from the index that is contained in given file path and optionally subfile.
    *
+   * @param file  The file (and subfile) to remove the element from.
+   *
    * Example:
    *   <index-remove(|"fullpath/file.ext")> Def([Entity(), "Bar"])
    *   <index-remove(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
@@ -89,6 +106,8 @@
   /**
    * Removes all given elements from the index that are contained in given file path and optionally subfile.
    *
+   * @param file  The file (and subfile) to remove the elements from.
+   *
    * Example:
    *   <index-remove-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
    *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
@@ -120,20 +139,22 @@
 
   /**
    * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
-   * until index-end-transaction is called.
+   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
    */
   index-start-transaction = 
     prim("LANG_index_start_transaction")
   
   /**
    * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
-   * added to the global index visible for other files.
+   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
+   * this call.
    */
   index-end-transaction = 
     prim("LANG_index_end_transaction")
   
   /**
-   * Starts a transaction, applies given strategy and ends the transaction.
+   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
+   * strategy are thread safe.
    * 
    * @param s The strategy to apply.
    *
@@ -147,15 +168,18 @@
   
   /**
    * Gets the file that the analysis is currently in.
+   *
+   * @see index-setup(|language, project-paths, current-file)
+   * @see index-set-current-file
    */
   index-get-current-file =
     prim("LANG_index_get_current_file")
   
   /**
-   * Gets a list of all files and subfile for current project.
+   * Gets a list of all files and subfiles for current project.
    *
    * Example:
-   *   <index-get-all-files> => ["fullpath/file.ext", ...]
+   *   <index-get-all-files> => [("fullpath/file.ext", "subfile"), ...]
    */   
   index-get-all-files =
     prim("LANG_index_all_files")
@@ -277,6 +301,8 @@
    * Example:
    *   index-get-global(|"last-compile") => Timestamp(1334322856)
    *   index-get-global(|["last-compile", "file.str"]) => Timestamp(1334322856)
+   * 
+   * @param name  The name or list of names to identify the global value.
    */
   index-get-global(|name):
     _ -> value
@@ -289,6 +315,8 @@
    * Example:
    *   index-get-global(|"last-compile") => [Timestamp(1334322856), ...]
    *   index-get-global(|["last-compile", "file.str"]) => [Timestamp(1334322856), ...]
+   *
+   * @param name  The name or list of names to identify the global value.
    */ 
   index-get-all-globals(|name):
     _ -> values
@@ -301,6 +329,8 @@
    * Example:
    *   <index-add-global(|"last-compile")> Timestamp(1334322856)
    *   <index-add-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
    */   
   index-add-global(|name):
     value -> <id>
@@ -313,6 +343,8 @@
    * Example:
    *   <index-set-global(|"last-compile")> Timestamp(1334322856)
    *   <index-set-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
    */   
   index-set-global(|name):
     value -> <id>
@@ -326,6 +358,8 @@
    * Example:
    *   index-clear-global(|"last-compile")
    *   index-clear-global(|["last-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global value.
    */   
   index-clear-global(|name):
     _ -> <id>
@@ -352,6 +386,8 @@
    * Example:
    *   index-enable-global(|"can-compile")
    *   index-enable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
    */   
   index-enable-global(|name):
     _ -> <id>
@@ -364,6 +400,8 @@
    * Example:
    *   index-disable-global(|"can-compile")
    *   index-disable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
    */   
   index-disable-global(|name):
     _ -> <id>
@@ -376,6 +414,8 @@
    * Example:
    *   index-is-global-enabled(|"can-compile")
    *   index-is-global-enabled(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
    */   
   index-is-global-enabled(|name):
     _ -> <id>
@@ -385,9 +425,18 @@
 rules // Index utility
   
   /**
-   * Gets the URI part for given term.
+   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
+   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
+   * given term.
+   *
+   * Example:
+   *   <index-uri> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => [Entity(), "Bar", "Baz"]
+   *
+   * @see index-uri-impl
+   * @see index-uri-generic
    */ 
-  index-uri = index-uri-impl <+ index-uri-generic
+  index-uri = 
+  	index-uri-impl <+ index-uri-generic
   
   /**
    * Gets the namespace part of the given URI.
@@ -419,14 +468,24 @@
     ?[_|[<id>|_]]
   
   /**
-   * Gets the value part for given term.
+   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
+   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
+   * from the given term.
+   *
+   * Example:
+   *   <index-value> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => TYPE("Bar")
+   *
+   * @see index-value-impl
+   * @see index-value-generic
    */  
-  index-value = index-value-impl <+ index-value-generic
+  index-value = 
+  	index-value-impl <+ index-value-generic
   
   /**
    * Queries if given index file is a 'fake' file for storing internal data.
    */
-  index-is-fake-file = string-starts-with(|"/.internal")
+  index-is-fake-file = 
+  	string-starts-with(|"/.internal")
   
   /**
    * Checks if given URI's are equal. Discards anonymous scopes if necessary.
@@ -497,23 +556,29 @@
 /** @internal */
 rules // URI and value projections
 	
+	/** @internal */
   index-uri-impl:
     DefData(uri, _, _) -> uri
 
+  /** @internal */
   index-uri-generic:
     term -> <?_#(<?[<id>|_]>)> term
   
+  /** @internal */
   index-value-impl:
     DefData(_, _, value) -> value
     
+  /** @internal */
   index-value-generic:
     term -> <?_#(<?[_, <id>|_]> )> term
      
 /** @internal */ 
 rules // Internal helpers
   
+  /** @internal */
   index-namespace-unwrap =
     \Unresolved(n) -> n\ <+ id
     
+  /** @internal */
   index-uri-unwrap =
     \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id
\ No newline at end of file

From gabrielkonat at gmail.com  Tue May  8 14:06:15 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 12:06:15 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24805 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120508120615.943C52B8015@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  8 12:06:15 2012
New Revision: 24805
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24805&sc=1

Log:
Examples before annotations.
Small documentation updates.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 11:50:01 2012	(r24804)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 12:06:15 2012	(r24805)
@@ -440,8 +440,9 @@
    * Example:
    *   <index-parallel-analyze-files(analyze)> ["text/file1.ext", "text/file2.ext"]
    *
-   * @param analyze Strategy that analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and
-   *                must return a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
+   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
+   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
    */
   index-parallel-analyze-files(analyze):
     files -> None()
@@ -608,10 +609,10 @@
   /**
    * Gets all DefData entries that match the kind of data and URI in given definition.
    *
-   * @param kind Only data of this kind is returned.
-   *
    * Example:
    *   <index-get-data(|Type())> Def([Entity(), "Bar"]) => [DefData([Entity(), "Bar"], Type(), TYPE("Bar")), ...]
+   *
+   * @param kind Only data of this kind is returned.
    */
   index-get-data(|kind):
     <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
@@ -619,10 +620,10 @@
 	/**
 	 * Gets all data entries that match the kind of data and URI in given definition.
 	 *
-	 * @param kind Only data of this kind is returned.
-	 *
 	 * Example:
 	 *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
+	 *
+	 * @param kind Only data of this kind is returned.
 	 */
   index-get-data-all(|kind):
     <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
@@ -671,10 +672,10 @@
   /**
    * Get all values of index entries that match the given template.
    *
-   * @see index-value
-   *
    * Example:
    *   <index-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @see index-value
    */
   index-get-all-values:
     template -> <map(index-value)> <index-get-all> template
@@ -691,10 +692,10 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
-   * @see index-value
-   *
    * Example:
    *   <index-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @see index-value
    */
   index-get-value:
     template -> <index-value> <?[<id>|_]> <index-get-all> template
@@ -703,20 +704,21 @@
    * Gets all Def children elements of an URI in a certain namespace.
    * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
    *
-   * @param namespace Only child Def elements in this namespace are returned.
-   *
    * Example:
    *   <index-get-children(|Field())> Def([Entity(), "Baz"]) => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
    *   <index-get-children(|Field())> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
    *   <index-get-children(|Field())> [Entity(), "Baz"] => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
    */
-  index-get-children(|namespace) = index-get-children(\uri -> Def(uri)\|namespace)
+  index-get-children(|namespace) = 
+  	index-get-children(\uri -> Def(uri)\|namespace)
   
   /**
    * Gets all children elements of an URI in a certain namespace using custom templates.
    * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
    *
-   * @param construct-template  Should create a template to match index entries with, given an URI.
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
    * @param namespace           Only child elements in this namespace are returned.
    */
   index-get-children(construct-template|namespace):
@@ -730,13 +732,13 @@
    * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
    * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
    *
-   * @param namespace Only child Def elements in this namespace are returned.
-   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
-   *
    * Example:
    *   <index-get-children(|Field(), "fo")> Def([Entity(), "Baz"]) => [Def([Field(), "Foo"]), ...]
    *   <index-get-children(|Field(), "ba")> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), ...]
    *   <index-get-children(|Field(), "ze")> [Entity(), "Baz"] => [...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
    */
   index-get-children(|namespace, prefix) = 
   	index-get-children(\uri -> Def(uri)\|namespace, prefix)
@@ -746,7 +748,7 @@
    * using custom templates.
    * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
    *
-   * @param construct-template  Should create a template to match index entries with, given an URI.
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
    * @param namespace           Only child elements in this namespace are returned.
    * @param prefix              Only child elements where the name starts with this prefix are returned.
    */
@@ -762,12 +764,12 @@
   /**
    * Gets a set of all files that have a reference to the given index entries.
    *
-   * @param construct-from-uri  Construction strategy that creates a list of reference constructs from all 
-   *                            given entries, such as \uri -> [Read(uri), Use(uri, [])]\
-   *
    * Example:
    *   <index-get-referenced-files(\uri -> [Read(uri), Use(uri, [])]\)> [Def([Entity(), "Bar"]), ...] => 
    *     [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
+   *                            constructs from all given entries, such as \uri -> [Read(uri), Use(uri, [])]\
    */
   index-get-referenced-files(construct-from-uri):
     entries -> files
@@ -779,11 +781,11 @@
   /**
    * Convenience function for finding files with Read and Use dependencies to the given definitions.
    *
-   * @see index-get-referenced-files(construct-from-uri)
-   * @see index-file-dependent-construct
-   *
    * Example:
    *   <index-get-dependent-files> [Def([Entity(), "Bar"]), ...] => [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
    */
   index-get-dependent-files = 
     index-get-referenced-files(index-file-dependent-construct)
@@ -794,23 +796,22 @@
    * Given an annotated AST node, resolves it, returning its Def.
    */
   index-lookup:
-    x{[namespace | path]} -> <index-lookup(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    */
   index-lookup-all:
-    x{[namespace | path]} -> <index-lookup-all(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
    */
-  index-lookup(is-adjust-lookup-enabled |namespace, path, prefix):
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> def
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
@@ -821,25 +822,24 @@
       <+
 	      // TODO: optimize: try not to call do-adjust-index-lookup from here
 	      [_ | path'] := path;
-	      def         := <index-lookup(is-adjust-lookup-enabled |namespace, path', prefix)> x
+	      def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
       end
 
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
    */
-  index-lookup-all(is-adjust-lookup-enabled |namespace, path, prefix):
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> defs'
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
       defs       := <index-select-all(|namespace, path, x)>;
       // TODO: optimize: try not to call do-adjust-index-lookup from here
       if [_ | path'] := path then
-        defs2 := <index-lookup-all(is-adjust-lookup-enabled |namespace, path', prefix)> x;
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
         defs' := <conc> (defs, defs2)
       else
         defs' := defs
@@ -848,17 +848,15 @@
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    */
   index-lookup-outermost(|prefix):
-    x{[namespace | path]} -> <index-lookup-outermost(id |<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
    */
@@ -875,23 +873,20 @@
   /**
    * Given an annotated AST node, returns a Def that has the same parent URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    */
   index-lookup-one-level(|prefix):
-    x{[namespace | path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
    *
    * @internal
    */
-  index-lookup-one-level(is-adjusted-lookup-enabled |namespace, path, prefix):
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
     x{_} -> defs
     with
       is-adjusted-lookup-enabled;
@@ -908,22 +903,18 @@
       defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
       
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
    */
   index-lookup-all-levels(|prefix):
-    x{[namespace | path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
    */
@@ -949,12 +940,10 @@
       end
  
   /**
-   * Given an annotated AST node, resolves it,
-   * and returns all child Defs of its definition.
+   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
    *
    * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only child Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
    */
   index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
     x{[ns | path]} -> defs

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 11:50:01 2012	(r24804)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 12:06:15 2012	(r24805)
@@ -33,6 +33,9 @@
    *       writeFile :=  $[[writePath][filename]];
    *       try(<mkdir> writePath);
    *       <fclose> <fputs> (java, <fopen> (writeFile, "w"))
+   *
+   * @param file    The file that must be compiled.
+   * @param subfile The subfile that must be compiled ("" if there is no subfile).
    */
   index-compile-ast(|file, subfile) = fail
   

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 11:50:01 2012	(r24804)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 12:06:15 2012	(r24805)
@@ -46,13 +46,13 @@
    * Sets up the index library for given language, project paths and current file.
    * Must be called once before doing anything with the library.
    *
+   * Example:
+   *   <index-setup(|"MiniJava", [<project-path>], "test/test.mjv")
+   *
    * @param language      The language to set the index up for.
    * @param project-path  The project paths that contain all source files to analyse and compile.
    * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
    *                      Can also be changed later using index-set-current-file.
-   *
-   * Example:
-   *   <index-setup(|"MiniJava", [<project-path>], "test/test.mjv")
    */
   index-setup(|language, project-paths, current-file) =
     prim("LANG_index_setup", language, project-paths, current-file)
@@ -70,11 +70,11 @@
   /**
    * Adds given element to the index with given file path and optionally subfile.
    *
-   * @param file  The file (and subfile) to add the element to.
-   *
    * Example:
    *   <index-add(|"fullpath/file.ext")> Def([Entity(), "Bar"])
    *   <index-add(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   *
+   * @param file  The file (and subfile) to add the element to.
    */
   index-add(|file) =
     prim("LANG_index_add", <id>, file)
@@ -82,11 +82,11 @@
   /**
    * Adds all given elements to the index with given file path and optionally subfile.
    *
-   * @param file  The file (and subfile) to add the elements to.
-   *
    * Example:
    *   <index-add-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
    *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to add the elements to.
    */
   index-add-all(|file) =
     list-loop(with(index-add(|file)))
@@ -94,11 +94,11 @@
   /**
    * Removes given element from the index that is contained in given file path and optionally subfile.
    *
-   * @param file  The file (and subfile) to remove the element from.
-   *
    * Example:
    *   <index-remove(|"fullpath/file.ext")> Def([Entity(), "Bar"])
    *   <index-remove(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   * 
+   * @param file  The file (and subfile) to remove the element from.
    */
   index-remove(|file) =
     prim("LANG_index_remove", <id>, file)
@@ -106,11 +106,11 @@
   /**
    * Removes all given elements from the index that are contained in given file path and optionally subfile.
    *
-   * @param file  The file (and subfile) to remove the elements from.
-   *
    * Example:
    *   <index-remove-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
    *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to remove the elements from.
    */
   index-remove-all(|file) =
     list-loop(with(index-remove(|file)))
@@ -199,11 +199,11 @@
   /**
    * Gets index entries in some namespace for the given file path and optionally subfile.
    *
-   * @param namespace Only index entries from this namespace are retrieved.
-   *
    * Example:
    *   <index-get-all-in-file(|Import())> "fullpath/file.ext" => [Def([Import(), "Bar"]), ...]
    *   <index-get-all-in-file(|Import())> ("fullpath/file.ext", "subfile") => [Def([Import(), "Bar"]), ...]
+   *
+   * @param namespace Only index entries from this namespace are retrieved.
    */  
   index-get-all-in-file(|namespace):
     filepath -> entries
@@ -243,10 +243,10 @@
   /**
    * Get all values of index entries that match the given template.
    *
-   * @see index-value
-   *
    * Example:
    *   <indexlib-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @see index-value
    */
   indexlib-get-all-values:
     template -> <map(index-value)> <indexlib-get-all> template
@@ -263,10 +263,10 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
-   * @see index-value
-   *
    * Example:
    *   <indexlib-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @see index-value
    */
   indexlib-get-value:
     template -> <index-value> <?[<id>|_]> <indexlib-get-all> template

From gabrielkonat at gmail.com  Tue May  8 14:18:22 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 12:18:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24806 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120508121822.0BE772B802F@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  8 12:18:20 2012
New Revision: 24806
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24806&sc=1

Log:
Tabs to spaces.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 12:06:15 2012	(r24805)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 12:18:20 2012	(r24806)
@@ -51,18 +51,18 @@
    * lookups that will always fail anyway.
    *
    * Extension example:
-	 *   adjust-index-lookup(check-target-name|namespace, path, prefix):
-	 *	   PropAccess(exp, name) -> properties
-	 *     where
-	 *       <check-target-name> name
-	 *	   with
-   *	     if TYPE(type{_}) := <type-of> exp then
-	 *	       properties := <index-lookup-children(|Property(), prefix)> type
-	 *	     else
-	 *	       properties := StopLookup()
-	 *	     end
-	 *
-	 *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     PropAccess(exp, name) -> properties
+   *     where
+   *       <check-target-name> name
+   *     with
+   *       if TYPE(type{_}) := <type-of> exp then
+   *         properties := <index-lookup-children(|Property(), prefix)> type
+   *       else
+   *         properties := StopLookup()
+   *       end
+   *
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
    *     Var(name) -> [[Var() | path], [Property() | path]]
    *     where
    *       <check-target-name> name
@@ -86,10 +86,10 @@
    * rule fail if you are doing a <filter(store-results)> for example.
    *
    * Extension example:
-	 *   adjust-index-def-data(store-results|namespace, path):
-	 *     def -> <store-results> Type([namespace|path], type)
-	 *     where
-	 *       type := <type-of> def
+   *   adjust-index-def-data(store-results|namespace, path):
+   *     def -> <store-results> Type([namespace|path], type)
+   *     where
+   *       type := <type-of> def
    *
    * @param store-results Call this on the data you want to store in the index.
    * @param namespace     The namespace of the definition that the rule is being called on.
@@ -130,7 +130,7 @@
    * compared.
    *
    * Extension example:
-	 *   index-diff-compare:
+   *   index-diff-compare:
    *     (Type(u1, v1), Type(u2, v2)) -> <id>
    *     where
    *       <index-uri-eq> (u1, u2);
@@ -209,7 +209,7 @@
         data := <concat> dataList;
         (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
         uses := <concat> usesList;
-      	(asts, _) := <unzip> astFilePairs4
+        (asts, _) := <unzip> astFilePairs4
       |}
     with
       index-end-transaction
@@ -219,21 +219,21 @@
       if Editor() := phase; not(<is-test-file> full-path) then
         newElems := <conc> (defs, <filter(index-diff-constructors)> data);
         
-	      // Find added and removed definitions
-	      (added, removed) := <analyze-diff> (oldElems, newElems);
-	      changed := <conc> (added, removed);
-	      
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
         // Store files that have changed in the index
         index-transaction(
           filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
         )
-	    else
-	      (added, removed) := ([], []);
-	      filesToAnalyze := []
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
       end
     with
-    	<list-loop(analyze-top-store-ast)> astFilePairs4
-    	
+      <list-loop(analyze-top-store-ast)> astFilePairs4
+      
   /**
    * Add URI annotations to each definition and unresolved URI annotations to each use site.
    *
@@ -536,7 +536,7 @@
   index-transform-qualifier(|node):
     (elem, subfileName) -> (qualifier, subfileName)
     with
-    	qualifier := <index-create-qualifier(|node)> elem
+      qualifier := <index-create-qualifier(|node)> elem
 
 /** @internal */
 rules // Diffs
@@ -581,10 +581,10 @@
   analyze-astdiff:
     (ast, file) -> file
     where
-    	name := [<index-file-to-string> file, "ast-checksum"];
+      name := [<index-file-to-string> file, "ast-checksum"];
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
-      	<index-set-global(|name)> newChecksum;
+        <index-set-global(|name)> newChecksum;
         not(<eq> (oldChecksum, newChecksum))
       else
         <index-set-global(|name)> newChecksum
@@ -617,14 +617,14 @@
   index-get-data(|kind):
     <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
       
-	/**
-	 * Gets all data entries that match the kind of data and URI in given definition.
-	 *
-	 * Example:
-	 *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
-	 *
-	 * @param kind Only data of this kind is returned.
-	 */
+  /**
+   * Gets all data entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   */
   index-get-data-all(|kind):
     <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
      
@@ -712,7 +712,7 @@
    * @param namespace Only child Def elements in this namespace are returned.
    */
   index-get-children(|namespace) = 
-  	index-get-children(\uri -> Def(uri)\|namespace)
+    index-get-children(\uri -> Def(uri)\|namespace)
   
   /**
    * Gets all children elements of an URI in a certain namespace using custom templates.
@@ -741,7 +741,7 @@
    * @param prefix    Only child Def elements where the name starts with this prefix are returned.
    */
   index-get-children(|namespace, prefix) = 
-  	index-get-children(\uri -> Def(uri)\|namespace, prefix)
+    index-get-children(\uri -> Def(uri)\|namespace, prefix)
   
   /**
    * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
@@ -820,9 +820,9 @@
       else
         def        := <index-select(|namespace, path, x)>
       <+
-	      // TODO: optimize: try not to call do-adjust-index-lookup from here
-	      [_ | path'] := path;
-	      def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
       end
 
   /**
@@ -926,10 +926,10 @@
       if ?StopLookup() then
         all-defs := []
       else
-	      mapconcat(\d at Def(p) -> [d]\
-	          <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
-	          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
-	      ?all-defs
+        mapconcat(\d at Def(p) -> [d]\
+            <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
+            <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?all-defs
       end
     <+
       one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
@@ -1089,21 +1089,21 @@
    * @internal
    */
   is-test-file = 
-  	string-ends-with(|".spt")
+    string-ends-with(|".spt")
   /** @internal */
   is-test-language = 
-  	?"Spoofax-Testing"
+    ?"Spoofax-Testing"
   /** @internal */
   is-test-input(|language, path) = 
-  	<is-test-language> language <+ <is-test-file> path
+    <is-test-language> language <+ <is-test-file> path
       
   /** @internal */
   fake-file = 
-  	is-test-file <+ index-is-fake-file
+    is-test-file <+ index-is-fake-file
   
   /** @internal */    
   index-filepair-to-file = 
-  	Fst; string-replace(|$[[<project-path>]/], "")
+    Fst; string-replace(|$[[<project-path>]/], "")
   
   /** @internal */
   ast-uri-to-ast-file(|full-path):
@@ -1140,21 +1140,21 @@
   
   /** @internal */    
   index-is-unresolved(|x, uri) = 
-  	Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
   /** @internal */
   index-add-unresolved(|x, uri) = 
-  	(Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
   
   /** @internal */
   index-file-dependent-construct: 
     uri -> <conc> (uses, reads)
     with
-    	uses := <index-get-uses-all> Def(uri);
-    	reads := <index-get-reads-all> Def(uri)
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
   
   /** @internal */  
   index-file-dependency-filter = 
-  	?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
  
   /** @internal */
   do-adjust-index-lookup(|namespace, path, use, prefix) =

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 12:06:15 2012	(r24805)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 12:18:20 2012	(r24806)
@@ -287,12 +287,12 @@
    * @internal
    */
   index-globals-uri:
-  	names -> uri
-  	with
-  		if is-list then
-  			uri := <concat> [[Global()], names, ["globals", ".internal"]]
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["globals", ".internal"]]
       else
-      	uri := [Global(), names, "global", ".internal"]
+        uri := [Global(), names, "global", ".internal"]
       end
     
   /**
@@ -436,7 +436,7 @@
    * @see index-uri-generic
    */ 
   index-uri = 
-  	index-uri-impl <+ index-uri-generic
+    index-uri-impl <+ index-uri-generic
   
   /**
    * Gets the namespace part of the given URI.
@@ -479,13 +479,13 @@
    * @see index-value-generic
    */  
   index-value = 
-  	index-value-impl <+ index-value-generic
+    index-value-impl <+ index-value-generic
   
   /**
    * Queries if given index file is a 'fake' file for storing internal data.
    */
   index-is-fake-file = 
-  	string-starts-with(|"/.internal")
+    string-starts-with(|"/.internal")
   
   /**
    * Checks if given URI's are equal. Discards anonymous scopes if necessary.
@@ -496,10 +496,10 @@
    *   <index-uri-eq> ([Entity(), "Foo"], [Entity(), "Bar"]) => fail
    */
   index-uri-eq:
-  	(u1, u2) -> <id>
-  	where
-  	  u1' := <index-uri-unwrap> u1;
-  	  u2' := <index-uri-unwrap> u2;
+    (u1, u2) -> <id>
+    where
+      u1' := <index-uri-unwrap> u1;
+      u2' := <index-uri-unwrap> u2;
       (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
   
   /**
@@ -555,8 +555,8 @@
       
 /** @internal */
 rules // URI and value projections
-	
-	/** @internal */
+  
+  /** @internal */
   index-uri-impl:
     DefData(uri, _, _) -> uri
 

From gabrielkonat at gmail.com  Tue May  8 15:03:37 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 13:03:37 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24807 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120508130337.B7D8F2B8005@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  8 13:03:37 2012
New Revision: 24807
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24807&sc=1

Log:
Added type documentation.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 12:18:20 2012	(r24806)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 13:03:37 2012	(r24807)
@@ -73,6 +73,7 @@
    * @param path                The path the lookup algorithm is currently looking at for the element.
    * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
    *                            full name of the element, but could be a partial prefix during content completion.
+   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
    */
   adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
   
@@ -94,6 +95,7 @@
    * @param store-results Call this on the data you want to store in the index.
    * @param namespace     The namespace of the definition that the rule is being called on.
    * @param path          The path of the definition that the rule is being called on.
+   * @type def -> fail 
    */
   adjust-index-def-data(store-results|namespace, path) = fail
   
@@ -109,6 +111,7 @@
    * @param check-target-definition 
    * @param namespace               The namespace that would be given to the current definition or use site.
    * @param path                    The path that would be given to the current definition or use site.
+   * @type def -> uri@[namespace|path]
    */
   adjust-index-path(check-target-definition|namespace, path) = fail
   
@@ -119,6 +122,8 @@
    * Extension example:
    *   index-diff-constructors = ?Type(_, _)
    *
+   * @type a -> ?a
+   *
    * @see index-diff-compare
    */
   index-diff-constructors = 
@@ -136,6 +141,8 @@
    *       <index-uri-eq> (u1, u2);
    *       <eq> (v1, v2)
    *
+   * @type (a, b) -> ?(a, b)
+   *
    * @see index-diff-constructors
    */
   index-diff-compare:
@@ -151,6 +158,8 @@
    *
    * @param language  The name of the language that is being analysed.
    *
+   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
    * @see analyze-top(|phase, language)
    */
   analyze-top(|language):
@@ -165,6 +174,7 @@
    * @param language      The name of the language that is being analysed.
    * @param path          The path of the file to analyze relative to project-path.
    * @param project-path  The path of the directory that contains all the source files.
+   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
    *
    * @see analyze-top-internal(|phase, language, project-path, full-path)
    */
@@ -187,6 +197,8 @@
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
    * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
    */
   analyze-top-internal(|phase, language, project-path, full-path):
     astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
@@ -443,6 +455,7 @@
    * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
    *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
    *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @type List((file, subfile) or file) -> None()
    */
   index-parallel-analyze-files(analyze):
     files -> None()
@@ -613,6 +626,7 @@
    *   <index-get-data(|Type())> Def([Entity(), "Bar"]) => [DefData([Entity(), "Bar"], Type(), TYPE("Bar")), ...]
    *
    * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(DefData(uri, kind, value))
    */
   index-get-data(|kind):
     <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
@@ -624,6 +638,7 @@
    *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
    *
    * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(value)
    */
   index-get-data-all(|kind):
     <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
@@ -633,6 +648,8 @@
    *
    * Example:
    *   <index-get-uses-all> Def([Entity(), "M", "Bar"]) => [Use([Entity(), "M", "Bar"]), ...]
+   *
+   * @type Def(uri) -> List(Use(uri))
    */
   index-get-uses-all:
     <with(?Def(uri) | "Def expected")> -> <index-get-all> Use(uri)
@@ -642,6 +659,8 @@
    *
    * Example:
    *   <index-get-reads-all> [Property(), "Bar", "p"] => [Read([Property(), "Bar", "p"]), ...]
+   *
+   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
    */
   index-get-reads-all:
     template -> <conc> (reads, readwildcards')
@@ -660,6 +679,8 @@
    *
    * Example:
    *   <index-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
    */
   index-get-all:
     template -> <indexlib-get-all> template
@@ -675,6 +696,8 @@
    * Example:
    *   <index-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
    *
+   * @type template -> List(value)
+   *
    * @see index-value
    */
   index-get-all-values:
@@ -685,6 +708,8 @@
    *
    * Example:
    *   <index-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
    */
   index-get:
     template -> <?[<id>|_]> <index-get-all> template
@@ -695,6 +720,8 @@
    * Example:
    *   <index-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
    *
+   * @type template -> ?value
+   *
    * @see index-value
    */
   index-get-value:
@@ -710,6 +737,7 @@
    *   <index-get-children(|Field())> [Entity(), "Baz"] => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
    *
    * @param namespace Only child Def elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
   index-get-children(|namespace) = 
     index-get-children(\uri -> Def(uri)\|namespace)
@@ -720,6 +748,7 @@
    *
    * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
    * @param namespace           Only child elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
   index-get-children(construct-template|namespace):
     <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children
@@ -739,6 +768,7 @@
    *
    * @param namespace Only child Def elements in this namespace are returned.
    * @param prefix    Only child Def elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
   index-get-children(|namespace, prefix) = 
     index-get-children(\uri -> Def(uri)\|namespace, prefix)
@@ -751,6 +781,7 @@
    * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
    * @param namespace           Only child elements in this namespace are returned.
    * @param prefix              Only child elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
   index-get-children(construct-template|namespace, prefix):
     <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children'
@@ -770,6 +801,7 @@
    *
    * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
    *                            constructs from all given entries, such as \uri -> [Read(uri), Use(uri, [])]\
+   * @type List(elem) -> List((file, subfile))
    */
   index-get-referenced-files(construct-from-uri):
     entries -> files
@@ -784,6 +816,8 @@
    * Example:
    *   <index-get-dependent-files> [Def([Entity(), "Bar"]), ...] => [("fullpath/otherfile.ext", "subfile"), ...]
    *
+   * @type List(elem) -> List((file, subfile))
+   *
    * @see index-get-referenced-files(construct-from-uri)
    * @see index-file-dependent-construct
    */
@@ -794,12 +828,16 @@
  
   /**
    * Given an annotated AST node, resolves it, returning its Def.
+   *
+   * @type "name"{uri} -> ?Def(uri')
    */
   index-lookup:
     x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
+   * 
+   * @type "name"{uri} -> List(Def(uri'))
    */
   index-lookup-all:
     x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
@@ -810,6 +848,7 @@
    * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
+   * @type "name"{uri} -> ?Def(uri')
    */
   index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> def
@@ -830,6 +869,7 @@
    *
    * @param prefix  Only Defs with a name that starts with this string are returned.
    *
+   * @type "name"{uri} -> List(Def(uri'))
    * @internal
    */
   index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
@@ -849,6 +889,7 @@
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
    * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> ?Def(uri')
    */
   index-lookup-outermost(|prefix):
     x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
@@ -858,6 +899,7 @@
    *
    * @param prefix  Only Defs with a name that starts with this string are returned.
    *
+   * @type "name"{uri} -> ?Def(uri')
    * @internal
    */
   index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
@@ -871,9 +913,10 @@
       def        := <index-select(|namespace, path, x)>
  
   /**
-   * Given an annotated AST node, returns a Def that has the same parent URI.
+   * Given an annotated AST node, returns Defs that have the same parent URI.
    *
    * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
    */
   index-lookup-one-level(|prefix):
     x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
@@ -884,6 +927,7 @@
    * @param namespace Only Defs with this namespace are returned.
    * @param prefix    Only Defs with a name that starts with this string are returned.
    *
+   * @type "name"{uri} -> List(Def(uri'))
    * @internal
    */
   index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
@@ -907,6 +951,7 @@
    *
    * @param namespace Only Defs with this namespace are returned.
    * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
    */
   index-lookup-all-levels(|prefix):
     x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
@@ -917,6 +962,7 @@
    * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
+   * @type "name"{uri} -> List(Def(uri'))
    */
   index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
     x{_} -> all-defs
@@ -944,6 +990,7 @@
    *
    * @param namespace Only child Defs with this namespace are returned.
    * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
    */
   index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
     x{[ns | path]} -> defs
@@ -963,7 +1010,9 @@
    * Gets the namespace part of the URI for given key (term{uri} element).
    *
    * Example:
-   *   <index-uri-namespace> "Bar"{[Entity(), "Bar", "Baz"]} => Entity() 
+   *   <index-uri-namespace> "Bar"{[Entity(), "Bar", "Baz"]} => Entity()
+   *
+   * @type "name"{uri@[namespace|path]} -> namespace
    */
   index-uri-namespace:
     x{[namespace|path]} -> <index-namespace-unwrap> namespace
@@ -973,6 +1022,8 @@
    *
    * Example:
    *   <index-uri-path> "Bar"{[Entity(), "Bar", "Baz"]} => ["Bar", "Baz"]
+   *
+   * @type "name"{uri@[namespace|path]} -> path'
    */
   index-uri-path:
     x{[namespace|path]} -> path'
@@ -988,6 +1039,8 @@
    *
    * Example:
    *   <index-uri-name> "Bar"{[Entity(), "Bar", "Baz"] => "Bar"
+   *
+   * @type "name"{uri@[namespace|[name|restPath]]} -> name
    */ 
   index-uri-name:
     x{[_|[name|_]]} -> name
@@ -999,6 +1052,8 @@
    *   <index-uri-name> Def([Entity(), "Bar", "Baz"]) => "Bar"
    *   <index-uri-name> Type("Foo") => fail
    *   <index-uri-name> Read([Entity()]) => fail
+   *
+   * @type x -> name
    */   
   index-uri-name:
     x -> <index-uri-name> <index-uri> x
@@ -1008,7 +1063,9 @@
   /**
    * Determines if a given AST node is a definition site, according to the syntax.
    *
-   * TODO: Does not work?
+   * FIXME: Also succeeds on use sites.
+   *
+   * @type def -> ?def
    */
   index-is-definition =
     where(nam-get-definition-key)
@@ -1020,6 +1077,8 @@
    *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
    *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
    *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
+   *
+   * @type (k1, k2) -> ?(k1, k2)
    */      
   index-key-eq:
     (k1, k2) -> <id>

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 12:18:20 2012	(r24806)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 13:03:37 2012	(r24807)
@@ -14,6 +14,8 @@
    * Extension example:
    *   index-desugar-ast:
    *     ast -> <desugar> ast
+   *
+   * @type ast -> ast'
    */
   index-desugar-ast = fail
     
@@ -36,6 +38,7 @@
    *
    * @param file    The file that must be compiled.
    * @param subfile The subfile that must be compiled ("" if there is no subfile).
+   * @type ast -> None()
    */
   index-compile-ast(|file, subfile) = fail
   
@@ -43,6 +46,8 @@
   
   /**
    * Schedules compilation in the background of all files that have changed since the last compilation.
+   *
+   * @type x -> x
    */
   index-schedule-compilation:
     _ -> None()
@@ -119,6 +124,8 @@
    * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
    * enable-commit-and-compile is called.
    *
+   * @type language -> ?language
+   *
    * @see enable-commit-and-compile
    * @see disable-commit-and-compile
    */
@@ -134,6 +141,8 @@
   /**
    * Delays commit and compilation until enable-commit-and-compile is called.
    *
+   * @type x -> x
+   *
    * @see enable-commit-and-compile
    */
   disable-commit-and-compile = 
@@ -143,6 +152,8 @@
    * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
    * is triggered now.
    *
+   * @type x -> x
+   *
    * @see disable-commit-and-compile
    */
   enable-commit-and-compile:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 12:18:20 2012	(r24806)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May  8 13:03:37 2012	(r24807)
@@ -37,6 +37,7 @@
    * @param project-path  The project paths that contain all source files to analyse and compile.
    *
    * @obsolete
+   * @type x -> x
    */
   index-setup(|language, project-paths) =
     obsolete(!"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)");
@@ -53,6 +54,7 @@
    * @param project-path  The project paths that contain all source files to analyse and compile.
    * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
    *                      Can also be changed later using index-set-current-file.
+   * @type x -> x
    */
   index-setup(|language, project-paths, current-file) =
     prim("LANG_index_setup", language, project-paths, current-file)
@@ -63,6 +65,8 @@
    * Example:
    *   <index-set-current-file> "fullpath/file.ext"
    *   <index-set-current-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
    */
   index-set-current-file = 
     prim("LANG_index_set_current_file", <id>)
@@ -75,6 +79,7 @@
    *   <index-add(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
    *
    * @param file  The file (and subfile) to add the element to.
+   * @type x -> ?x
    */
   index-add(|file) =
     prim("LANG_index_add", <id>, file)
@@ -87,6 +92,7 @@
    *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
    *
    * @param file  The file (and subfile) to add the elements to.
+   * @type List(x) -> ?List(x)
    */
   index-add-all(|file) =
     list-loop(with(index-add(|file)))
@@ -99,6 +105,7 @@
    *   <index-remove(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
    * 
    * @param file  The file (and subfile) to remove the element from.
+   * @type x -> ?x
    */
   index-remove(|file) =
     prim("LANG_index_remove", <id>, file)
@@ -111,6 +118,7 @@
    *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
    *
    * @param file  The file (and subfile) to remove the elements from.
+   * @type List(x) -> ?List(x)
    */
   index-remove-all(|file) =
     list-loop(with(index-remove(|file)))
@@ -121,18 +129,24 @@
    * Example:
    *   <index-clear-file> "fullpath/file.ext"
    *   <index-clear-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
    */
   index-clear-file = 
     prim("LANG_index_clear_file", <id>)
     
   /**
    * Clears all elements from the index.
+   *
+   * @type x -> x
    */
   index-clear = 
     prim("LANG_index_clear_all")
    
   /**
    * Commits index to a file on disk.
+   *
+   * @type x -> x
    */
   index-commit = 
     prim("LANG_index_commit")
@@ -140,6 +154,8 @@
   /**
    * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
    * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
+   *
+   * @type x -> x
    */
   index-start-transaction = 
     prim("LANG_index_start_transaction")
@@ -148,6 +164,8 @@
    * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
    * added to the global index visible for other files. Operations on the index are not thread safe any more after 
    * this call.
+   *
+   * @type x -> x
    */
   index-end-transaction = 
     prim("LANG_index_end_transaction")
@@ -157,6 +175,7 @@
    * strategy are thread safe.
    * 
    * @param s The strategy to apply.
+   * @type x -> x'
    *
    * @see index-start-transaction
    * @see index-end-transaction
@@ -169,6 +188,8 @@
   /**
    * Gets the file that the analysis is currently in.
    *
+   * @type x -> (file, subfile)
+   *
    * @see index-setup(|language, project-paths, current-file)
    * @see index-set-current-file
    */
@@ -180,6 +201,8 @@
    *
    * Example:
    *   <index-get-all-files> => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type x -> List((file, subfile))
    */   
   index-get-all-files =
     prim("LANG_index_all_files")
@@ -190,6 +213,8 @@
    * Examples:
    *   <index-get-all-in-file> "fullpath/file.ext" => [Def([Entity(), "Bar"]), ...]
    *   <index-get-all-in-file> ("fullpath/file.ext", "subfile") => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file:
     filepath -> entries
@@ -204,6 +229,7 @@
    *   <index-get-all-in-file(|Import())> ("fullpath/file.ext", "subfile") => [Def([Import(), "Bar"]), ...]
    *
    * @param namespace Only index entries from this namespace are retrieved.
+   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file(|namespace):
     filepath -> entries
@@ -218,6 +244,8 @@
    * Example:
    *   <index-get-file-revision> "fullpath/file.ext" => 13
    *   <index-get-file-revision> ("fullpath/file.ext", "subfile") => 37
+   *
+   * @type file or (file, subfile) -> Int
    */
   index-get-file-revision:
     file -> <prim("LANG_index_get_file_revision", file)>
@@ -227,6 +255,8 @@
    *
    * Example:
    *   <index-get-files-of> Def([Entity(), "Bar"]) => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type template -> List((file, subfile))
    */  
   index-get-files-of:
     template -> <prim("LANG_index_get_files_of", template)>
@@ -236,6 +266,8 @@
    *
    * Example:
    *   <indexlib-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
    */
   indexlib-get-all:
     template -> <prim("LANG_index_get", template)>
@@ -246,6 +278,8 @@
    * Example:
    *   <indexlib-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
    *
+   * @type template -> List(value)
+   *
    * @see index-value
    */
   indexlib-get-all-values:
@@ -256,6 +290,8 @@
    *
    * Example:
    *   <indexlib-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
    */
   indexlib-get:
     template -> <?[<id>|_]> <indexlib-get-all> template
@@ -266,6 +302,8 @@
    * Example:
    *   <indexlib-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
    *
+   * @type template -> ?value
+   *
    * @see index-value
    */
   indexlib-get-value:
@@ -285,6 +323,7 @@
    * Gets the URI where globals are stored in the index for given name or names.
    *
    * @internal
+   * @type name or List(name) -> uri
    */
   index-globals-uri:
     names -> uri
@@ -303,6 +342,7 @@
    *   index-get-global(|["last-compile", "file.str"]) => Timestamp(1334322856)
    * 
    * @param name  The name or list of names to identify the global value.
+   * @type _ -> ?value
    */
   index-get-global(|name):
     _ -> value
@@ -317,6 +357,7 @@
    *   index-get-global(|["last-compile", "file.str"]) => [Timestamp(1334322856), ...]
    *
    * @param name  The name or list of names to identify the global value.
+   * @type _ -> List(value)
    */ 
   index-get-all-globals(|name):
     _ -> values
@@ -331,6 +372,7 @@
    *   <index-add-global(|["last-compile", "file.str"])> Timestamp(1334322856)
    *
    * @param name  The name or list of names to identify the global value.
+   * @type x -> x
    */   
   index-add-global(|name):
     value -> <id>
@@ -345,6 +387,7 @@
    *   <index-set-global(|["last-compile", "file.str"])> Timestamp(1334322856)
    *
    * @param name  The name or list of names to identify the global value.
+   * @type x -> x
    */   
   index-set-global(|name):
     value -> <id>
@@ -360,6 +403,7 @@
    *   index-clear-global(|["last-compile", "file.str"])
    *
    * @param name  The name or list of names to identify the global value.
+   * @type x -> x
    */   
   index-clear-global(|name):
     _ -> <id>
@@ -388,6 +432,7 @@
    *   index-enable-global(|["can-compile", "file.str"])
    *
    * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
    */   
   index-enable-global(|name):
     _ -> <id>
@@ -402,6 +447,7 @@
    *   index-disable-global(|["can-compile", "file.str"])
    *
    * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
    */   
   index-disable-global(|name):
     _ -> <id>
@@ -416,6 +462,7 @@
    *   index-is-global-enabled(|["can-compile", "file.str"])
    *
    * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> ?x
    */   
   index-is-global-enabled(|name):
     _ -> <id>
@@ -432,6 +479,8 @@
    * Example:
    *   <index-uri> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => [Entity(), "Bar", "Baz"]
    *
+   * @type elem -> ?uri
+   *
    * @see index-uri-impl
    * @see index-uri-generic
    */ 
@@ -443,6 +492,8 @@
    *
    * Example:
    *   <index-uri-path> [Entity(), "Bar", "Baz"] => Entity()
+   *
+   * @type uri@[namespace|path] -> namespace
    */ 
   index-uri-namespace =
     ?[<id>|_]
@@ -453,6 +504,8 @@
    * Example:
    *   <index-uri-path> [Entity(), "Bar", "Baz"] => ["Bar", "Baz"]
    *   <index-uri-path> [Entity()] => []
+   *
+   * @type uri@[namespace|path] -> path
    */ 
   index-uri-path =
     ?[_|<id>]
@@ -463,6 +516,8 @@
    * Example:
    *   <index-uri-name> [Entity(), "Bar", "Baz"] => "Bar"
    *   <index-uri-name> [Entity()] => fail
+   *
+   * @type uri@[namespace|[name|restPath]] -> ?name
    */ 
   index-uri-name =
     ?[_|[<id>|_]]
@@ -475,6 +530,8 @@
    * Example:
    *   <index-value> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => TYPE("Bar")
    *
+   * @type elem -> ?value
+   *
    * @see index-value-impl
    * @see index-value-generic
    */  
@@ -483,6 +540,8 @@
   
   /**
    * Queries if given index file is a 'fake' file for storing internal data.
+   *
+   * @type x -> ?x
    */
   index-is-fake-file = 
     string-starts-with(|"/.internal")
@@ -494,6 +553,8 @@
    *   <index-uri-eq> ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"]) => 
    *     ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"])
    *   <index-uri-eq> ([Entity(), "Foo"], [Entity(), "Bar"]) => fail
+   *
+   * @type (u1, u2) -> ?(u1, u2)
    */
   index-uri-eq:
     (u1, u2) -> <id>
@@ -504,6 +565,8 @@
   
   /**
    * Finds the first key (term{uri} element) for given term, or fail. 
+   *
+   * @type x -> ?name{uri}
    */
   index-find-key:
     x -> key
@@ -515,6 +578,8 @@
    *
    * Example:
    *   <index-uri-to-string> [Entity(), "Bar", "Baz"] => "Entity://Bar.Baz"
+   *
+   * @type uri -> str
    */
   index-uri-to-string:
     [ns|path] -> <concat-strings> [nsStr, "://", pathStr]
@@ -527,6 +592,8 @@
    *
    * Example:
    *   <index-file-to-string> "fullpath/file.ext" => "fullpath/file.ext"
+   *
+   * @type file -> file
    */
   index-file-to-string:
     file -> file
@@ -538,6 +605,8 @@
    *
    * Example:
    *   <index-file-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   *
+   * @type (file, "") -> file
    */
   index-file-to-string:
     (file, "") -> file
@@ -547,6 +616,8 @@
    *
    * Example:
    *   <index-file-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
+   *
+   * @type (file, subfile) -> str
    */
   index-file-to-string:
     (file, subfile) -> <concat-strings> [file, "@", subfile]

From gabrielkonat at gmail.com  Tue May  8 16:12:06 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 14:12:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24808 -
	spoofax-contrib/separate-compilation-examples/c-without-macros
	spoofax-contrib/separate-compilation-examples/csharp-partial-classses
	spoofax-contrib/separate-compi...
Message-ID: <20120508141206.CA7CB108C027@mx3.tudelft.nl>

Author: gkonat
Date: Tue May  8 14:12:06 2012
New Revision: 24808
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24808&sc=1

Log:
Split the internal stuff of the analysis library into its own file.

Added:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str
Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/build.main.xml
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/build.main.xml
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/build.main.xml
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/editor/EntityWithAspects-Builders.esv
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax-imp/trunk/experimental/NamingExperiment/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/   (props changed)
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/build.main.xml
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/build.main.xml	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/build.main.xml	Tue May  8 14:12:06 2012	(r24808)
@@ -52,6 +52,7 @@
           <!-- Copy libraries from naming experiment, Ant is stupid and cannot link on Windows :( -->
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" tofile="lib/index-library.str"/>
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" tofile="lib/analysis-library.str"/>
+          <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str" tofile="lib/analysis-library-internal.str"/>
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" tofile="lib/compilation-library.str"/>
         </target>
         
@@ -59,6 +60,7 @@
           <!-- Link libraries from naming experiment -->
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" link="${basedir}/lib/index-library.str" overwrite="true" />
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" link="${basedir}/lib/analysis-library.str" overwrite="true" />
+          <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str" link="${basedir}/lib/analysis-library-internal.str" overwrite="true" />
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" link="${basedir}/lib/compilation-library.str" overwrite="true" />
         </target>
     </project>
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/build.main.xml
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/build.main.xml	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/build.main.xml	Tue May  8 14:12:06 2012	(r24808)
@@ -47,11 +47,12 @@
             <os family="windows"/>
           </condition>  
         </target>
-      	
+        
         <target name="copy-lib-files" if="isWin" depends="os-detection">
           <!-- Copy libraries from naming experiment, Ant is stupid and cannot link on Windows :( -->
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" tofile="lib/index-library.str"/>
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" tofile="lib/analysis-library.str"/>
+          <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str" tofile="lib/analysis-library-internal.str"/>
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" tofile="lib/compilation-library.str"/>
         </target>
         
@@ -59,6 +60,7 @@
           <!-- Link libraries from naming experiment -->
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" link="${basedir}/lib/index-library.str" overwrite="true" />
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" link="${basedir}/lib/analysis-library.str" overwrite="true" />
+          <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str" link="${basedir}/lib/analysis-library-internal.str" overwrite="true" />
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" link="${basedir}/lib/compilation-library.str" overwrite="true" />
         </target>
     </project>
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/build.main.xml
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/build.main.xml	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/build.main.xml	Tue May  8 14:12:06 2012	(r24808)
@@ -52,6 +52,7 @@
           <!-- Copy libraries from naming experiment, Ant is stupid and cannot link on Windows :( -->
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" tofile="lib/index-library.str"/>
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" tofile="lib/analysis-library.str"/>
+        	<copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str" tofile="lib/analysis-library-internal.str"/>
           <copy file="../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" tofile="lib/compilation-library.str"/>
         </target>
         
@@ -59,6 +60,7 @@
           <!-- Link libraries from naming experiment -->
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" link="${basedir}/lib/index-library.str" overwrite="true" />
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" link="${basedir}/lib/analysis-library.str" overwrite="true" />
+        	<symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str" link="${basedir}/lib/analysis-library-internal.str" overwrite="true" />
           <symlink resource="${basedir}/../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" link="${basedir}/lib/compilation-library.str" overwrite="true" />
         </target>
     </project>
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/editor/EntityWithAspects-Builders.esv
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/editor/EntityWithAspects-Builders.esv	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/editor/EntityWithAspects-Builders.esv	Tue May  8 14:12:06 2012	(r24808)
@@ -20,8 +20,9 @@
   builder  : "Show analyzed syntax" = generate-analyzed (openeditor) (realtime) (meta) (source)
   builder  : "Show index entries for current file" = index-currentfile (openeditor) (realtime) (meta) (source)
   builder  : "Show index entries for all files" = index-allfiles (openeditor) (realtime) (meta) (source)
-  builder  : "Clear index" = index-cleanall (meta) (source) 
-  builder  : "Generate test files" = generate-test-files (meta)                                                                                                    
+  builder  : "Clear index" = index-cleanall (meta) (source)
+  builder  : "Generate test files" = generate-test-files (meta)
+  builder  : "Create quoted libraries" = create-quoted-libraries (meta)
 
 refactorings
                                                                                                                         

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Tue May  8 14:12:06 2012	(r24808)
@@ -161,3 +161,30 @@
     files -> None()
     with
       index-parallel-analyze-files(analyze)
+      
+rules // Print index libraries
+  
+  create-quoted-libraries:
+    (_, _, _, path, project-path) -> None()
+    with
+      files := [$[[project-path]/lib/index-library], $[[project-path]/lib/analysis-library], $[[project-path]/lib/compilation-library]];
+      strings := <map(\file -> (file, <read-text-file> $[[file].str])\)> files;
+      <map(\(file, string) -> <write-lib> ($[[file].generated.str2], string)\)> strings
+      
+  write-lib:
+    (file, string) -> None()
+    with
+      replaces := [
+        ("\\",                       "\\\\"                              ),
+        ("\"",                       "\\\""                              ),
+        ("lib/index-library",        "lib/index-library.generated"       ),
+        ("lib/analysis-library",     "lib/analysis-library.generated"    ),
+        ("lib/compilation-library",  "lib/compilation-library.generated" )
+      ];
+      string' := <list-string-replace> (string, replaces);
+      <fclose> <fputs> (string', <fopen> (file, "w"))
+      
+  list-string-replace:
+    (string, replaces) -> string'
+    with
+      string' := <foldl(\((r, w), str) -> <string-replace(|r, w)> str\)> (replaces, string)

Modified: spoofax-imp/trunk/experimental/NamingExperiment/build.main.xml
==============================================================================
--- spoofax-imp/trunk/experimental/NamingExperiment/build.main.xml	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-imp/trunk/experimental/NamingExperiment/build.main.xml	Tue May  8 14:12:06 2012	(r24808)
@@ -40,5 +40,25 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="spoofaximp.default.ctree"/>
+        <target name="all" depends="link-lib-files, copy-lib-files, spoofaximp.default.ctree"/>
+      
+        <target name="os-detection">
+          <condition property="isWin">
+            <os family="windows"/>
+          </condition>  
+        </target>
+        
+        <target name="copy-lib-files" if="isWin" depends="os-detection">
+          <!-- Copy libraries from naming experiment, Ant is stupid and cannot link on Windows :( -->
+          <copy file="../../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" tofile="lib/index-library.str"/>
+          <copy file="../../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" tofile="lib/analysis-library.str"/>
+          <copy file="../../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" tofile="lib/compilation-library.str"/>
+        </target>
+        
+        <target name="link-lib-files" unless="isWin" depends="os-detection">
+          <!-- Link libraries from naming experiment -->
+          <symlink resource="${basedir}/../../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str" link="${basedir}/lib/index-library.str" overwrite="true" />
+          <symlink resource="${basedir}/../../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str" link="${basedir}/lib/analysis-library.str" overwrite="true" />
+          <symlink resource="${basedir}/../../../../spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str" link="${basedir}/lib/compilation-library.str" overwrite="true" />
+        </target>
     </project>
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May  8 14:12:06 2012	(r24808)
@@ -96,18 +96,67 @@
   
   FileEntries : Term * Term -> Term
   
+  // Globals
+  Global : Namespace
+  Global : List(UriPart) -> Summary
+  Global : List(UriPart) * List(Summary) -> Summary
+  
 rules // Index management
    
+  /**
+   * Sets up the index library for given language and project paths.
+   * Must be called once before doing anything with the library.
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   *
+   * @obsolete
+   * @type x -> x
+   */
   index-setup(|language, project-paths) =
     obsolete(!\"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)\");
     index-setup(|language, project-paths, \".\")
     
   /**
-   * Sets up the index library for given language and project paths.
+   * Sets up the index library for given language, project paths and current file.
    * Must be called once before doing anything with the library.
+   *
+   * Example:
+   *   <index-setup(|\"MiniJava\", [<project-path>], \"test/test.mjv\")
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
+   *                      Can also be changed later using index-set-current-file.
+   * @type x -> x
    */
   index-setup(|language, project-paths, current-file) =
     prim(\"LANG_index_setup\", language, project-paths, current-file)
+    
+  /**
+   * Sets the current file the index (analysis) is operating on to the given file.
+   *
+   * Example:
+   *   <index-set-current-file> \"fullpath/file.ext\"
+   *   <index-set-current-file> (\"fullpath/file.ext\", \"subfile\")
+   *
+   * @type x -> ?x
+   */
+  index-set-current-file = 
+    prim(\"LANG_index_set_current_file\", <id>)
+
+  /**
+   * Adds given element to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add(|\"fullpath/file.ext\")> Def([Entity(), \"Bar\"])
+   *   <index-add(|(\"fullpath/file.ext\", \"subfile\"))> Def([Entity(), \"Bar\"])
+   *
+   * @param file  The file (and subfile) to add the element to.
+   * @type x -> ?x
+   */
+  index-add(|file) =
+    prim(\"LANG_index_add\", <id>, file)
 
   /**
    * Adds all given elements to the index with given file path and optionally subfile.
@@ -115,9 +164,25 @@
    * Example:
    *   <index-add-all(|\"fullpath/file.ext\")> [Def([Entity(), \"Bar\"]), ...]
    *   <index-add-all(|(\"fullpath/file.ext\", \"subfile\"))> [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @param file  The file (and subfile) to add the elements to.
+   * @type List(x) -> ?List(x)
    */
   index-add-all(|file) =
-    list-loop(with(prim(\"LANG_index_add\", <id>, file)))
+    list-loop(with(index-add(|file)))
+    
+  /**
+   * Removes given element from the index that is contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove(|\"fullpath/file.ext\")> Def([Entity(), \"Bar\"])
+   *   <index-remove(|(\"fullpath/file.ext\", \"subfile\"))> Def([Entity(), \"Bar\"])
+   * 
+   * @param file  The file (and subfile) to remove the element from.
+   * @type x -> ?x
+   */
+  index-remove(|file) =
+    prim(\"LANG_index_remove\", <id>, file)
     
   /**
    * Removes all given elements from the index that are contained in given file path and optionally subfile.
@@ -125,9 +190,12 @@
    * Example:
    *   <index-remove-all(|\"fullpath/file.ext\")> [Def([Entity(), \"Bar\"]), ...]
    *   <index-remove-all(|(\"fullpath/file.ext\", \"subfile\"))> [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @param file  The file (and subfile) to remove the elements from.
+   * @type List(x) -> ?List(x)
    */
-  index-remove-all(|files) =
-    list-loop(with(prim(\"LANG_index_remove\", <id>, files)))
+  index-remove-all(|file) =
+    list-loop(with(index-remove(|file)))
     
   /**
    * Removes all elements from the index that are contained in given file path and optionally subfile.
@@ -135,38 +203,80 @@
    * Example:
    *   <index-clear-file> \"fullpath/file.ext\"
    *   <index-clear-file> (\"fullpath/file.ext\", \"subfile\")
+   *
+   * @type x -> ?x
    */
   index-clear-file = 
     prim(\"LANG_index_clear_file\", <id>)
     
   /**
    * Clears all elements from the index.
+   *
+   * @type x -> x
    */
   index-clear = 
     prim(\"LANG_index_clear_all\")
    
   /**
    * Commits index to a file on disk.
+   *
+   * @type x -> x
    */
   index-commit = 
-    if not(index-timestamp-get-updates(|\"LANG_index_commit\") => []) then
-      prim(\"LANG_index_commit\");
-      index-timestamp-set-updated(|\"LANG_index_commit\")
-    end
+    prim(\"LANG_index_commit\")
+
+  /**
+   * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
+   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
+   *
+   * @type x -> x
+   */
+  index-start-transaction = 
+    prim(\"LANG_index_start_transaction\")
   
-rules // Index API
+  /**
+   * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
+   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
+   * this call.
+   *
+   * @type x -> x
+   */
+  index-end-transaction = 
+    prim(\"LANG_index_end_transaction\")
+  
+  /**
+   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
+   * strategy are thread safe.
+   * 
+   * @param s The strategy to apply.
+   * @type x -> x'
+   *
+   * @see index-start-transaction
+   * @see index-end-transaction
+   */
+  index-transaction(s) = 
+    prim(\"LANG_index_start_transaction\"); s; prim(\"LANG_index_end_transaction\")
+  
+rules // Index querying
   
   /**
    * Gets the file that the analysis is currently in.
+   *
+   * @type x -> (file, subfile)
+   *
+   * @see index-setup(|language, project-paths, current-file)
+   * @see index-set-current-file
    */
   index-get-current-file =
     prim(\"LANG_index_get_current_file\")
   
   /**
-   * Gets a list of all files and subfile for current project.
+   * Gets a list of all files and subfiles for current project.
    *
    * Example:
-   *   <index-get-all-files> => [\"fullpath/file.ext\", ...]
+   *   <index-get-all-files> => [(\"fullpath/file.ext\", \"subfile\"), ...]
+   *
+   * @type x -> List((file, subfile))
    */   
   index-get-all-files =
     prim(\"LANG_index_all_files\")
@@ -177,6 +287,8 @@
    * Examples:
    *   <index-get-all-in-file> \"fullpath/file.ext\" => [Def([Entity(), \"Bar\"]), ...]
    *   <index-get-all-in-file> (\"fullpath/file.ext\", \"subfile\") => [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file:
     filepath -> entries
@@ -184,10 +296,14 @@
       entries := <prim(\"LANG_index_get_all_in_file\", filepath)>
    
   /**
-   * Gets all index entries for the given file path and optionally subfile.
+   * Gets index entries in some namespace for the given file path and optionally subfile.
    *
    * Example:
    *   <index-get-all-in-file(|Import())> \"fullpath/file.ext\" => [Def([Import(), \"Bar\"]), ...]
+   *   <index-get-all-in-file(|Import())> (\"fullpath/file.ext\", \"subfile\") => [Def([Import(), \"Bar\"]), ...]
+   *
+   * @param namespace Only index entries from this namespace are retrieved.
+   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file(|namespace):
     filepath -> entries
@@ -197,29 +313,35 @@
       filter(where(index-uri => [namespace | _]))
     
   /**
+   * Gets the revision of a file and optionally subfile.
+   *
+   * Example:
+   *   <index-get-file-revision> \"fullpath/file.ext\" => 13
+   *   <index-get-file-revision> (\"fullpath/file.ext\", \"subfile\") => 37
+   *
+   * @type file or (file, subfile) -> Int
+   */
+  index-get-file-revision:
+    file -> <prim(\"LANG_index_get_file_revision\", file)>
+    
+  /**
    * Gets the containing files and subfiles of index entry with given template.
    *
    * Example:
    *   <index-get-files-of> Def([Entity(), \"Bar\"]) => [(\"fullpath/file.ext\", \"subfile\"), ...]
+   *
+   * @type template -> List((file, subfile))
    */  
   index-get-files-of:
     template -> <prim(\"LANG_index_get_files_of\", template)>
     
   /**
-   * Gets all index entries (of every file for current project).
-   *
-   * Example:
-   *   <indexlib-get-all-elements> => [Def([Entity(), \"Bar\"]), ...]
-   */
-  indexlib-get-all-elements =
-    // TODO: is there a use case for this? doing this is *expensive*
-    <mapconcat(index-get-all-in-file)> <index-get-all-files>
-    
-  /**
    * Get all index entries that match the given template.
    *
    * Example:
    *   <indexlib-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @type template -> List(elem)
    */
   indexlib-get-all:
     template -> <prim(\"LANG_index_get\", template)>
@@ -227,10 +349,12 @@
   /**
    * Get all values of index entries that match the given template.
    *
-   * @see index-value
-   *
    * Example:
    *   <indexlib-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
    */
   indexlib-get-all-values:
     template -> <map(index-value)> <indexlib-get-all> template
@@ -240,6 +364,8 @@
    *
    * Example:
    *   <indexlib-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
+   *
+   * @type template -> ?elem
    */
   indexlib-get:
     template -> <?[<id>|_]> <indexlib-get-all> template
@@ -247,43 +373,252 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
-   * @see index-value
-   *
    * Example:
    *   <indexlib-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
    */
   indexlib-get-value:
     template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
- 
+    
+rules // Index globals
+    
   /**
-   * Updates the \"last updated\" timestamp for the given service name.
+   * Gets the 'fake' path where globals are stored in the index.
    *
-   * @see index-get-changes-since-timestamp(|service)
+   * @internal
    */
-  index-timestamp-set-updated(|service) =
-    file := $[/.internal/timestamps/[service]];
-    <index-clear-file> file;
-    prim(\"LANG_index_add\", DefData([Timestamp(), \"timestamps\", \".internal\"], Timestamp(), []), file)
-   
+  index-globals-path = 
+    !\"/.internal/globals\"
+    
   /**
-   * Gets all files with changes since the last time stamp update for the given service name.
+   * Gets the URI where globals are stored in the index for given name or names.
+   *
+   * @internal
+   * @type name or List(name) -> uri
    */
-  index-timestamp-get-updates(|service):
-    _ -> files'
+  index-globals-uri:
+    names -> uri
     with
-      timestampName := $[/.internal/timestamps/[service]];
-      files := <prim(\"LANG_index_get_files_newer_than\", timestampName)>;
-      files' := <remove-all(?(timestampName, _))> files
-
+      if is-list then
+        uri := <concat> [[Global()], names, [\"globals\", \".internal\"]]
+      else
+        uri := [Global(), names, \"global\", \".internal\"]
+      end
+    
   /**
-   * Queries if given index file is a 'fake' file for storing internal data.
+   * Gets the first value in global storage with given name, or fail.
+   *
+   * Example:
+   *   index-get-global(|\"last-compile\") => Timestamp(1334322856)
+   *   index-get-global(|[\"last-compile\", \"file.str\"]) => Timestamp(1334322856)
+   * 
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> ?value
+   */
+  index-get-global(|name):
+    _ -> value
+    where
+      value := <indexlib-get-value> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Gets all values in global storage with given name.
+   *
+   * Example:
+   *   index-get-global(|\"last-compile\") => [Timestamp(1334322856), ...]
+   *   index-get-global(|[\"last-compile\", \"file.str\"]) => [Timestamp(1334322856), ...]
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> List(value)
+   */ 
+  index-get-all-globals(|name):
+    _ -> values
+    with
+      values := <indexlib-get-all-values> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Add value to global storage with given name.
+   *
+   * Example:
+   *   <index-add-global(|\"last-compile\")> Timestamp(1334322856)
+   *   <index-add-global(|[\"last-compile\", \"file.str\"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-add-global(|name):
+    value -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-globals-uri> name, value)
+      
+  /**
+   * Overwrites value in global storage with given value.
+   *
+   * Example:
+   *   <index-set-global(|\"last-compile\")> Timestamp(1334322856)
+   *   <index-set-global(|[\"last-compile\", \"file.str\"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-set-global(|name):
+    value -> <id>
+    with
+      index-clear-global(|name);
+      <index-add-global(|name)> value
+    
+  /**
+   * Removes all values from global storage with given name.
+   *
+   * Example:
+   *   index-clear-global(|\"last-compile\")
+   *   index-clear-global(|[\"last-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-clear-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-globals-uri> name, ())
+      
+  /**
+   * Gets the URI where boolean globals are stored in the index for given name or names.
+   *
+   * @internal
    */
-  index-is-fake-file = string-starts-with(|\"/.internal\")
+  index-boolean-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, [\"boolean\", \"globals\", \".internal\"]]
+      else
+        uri := [Global(), names, \"boolean\", \"global\", \".internal\"]
+      end
+      
+  /**
+   * Sets boolean value true to global boolean storage with given name.
+   *
+   * Example:
+   *   index-enable-global(|\"can-compile\")
+   *   index-enable-global(|[\"can-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-enable-global(|name):
+    _ -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Sets boolean value false to global boolean storage with given name.
+   *
+   * Example:
+   *   index-disable-global(|\"can-compile\")
+   *   index-disable-global(|[\"can-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-disable-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Query for boolean value true in global boolean storage with given name.
+   *
+   * Example:
+   *   index-is-global-enabled(|\"can-compile\")
+   *   index-is-global-enabled(|[\"can-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> ?x
+   */   
+  index-is-global-enabled(|name):
+    _ -> <id>
+    where
+      <indexlib-get> Global(<index-boolean-globals-uri> name)
+
+rules // Index utility
+  
+  /**
+   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
+   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
+   * given term.
+   *
+   * Example:
+   *   <index-uri> DefData([Entity(), \"Bar\", \"Baz\"], Type(), TYPE(\"Bar\")) => [Entity(), \"Bar\", \"Baz\"]
+   *
+   * @type elem -> ?uri
+   *
+   * @see index-uri-impl
+   * @see index-uri-generic
+   */ 
+  index-uri = 
+    index-uri-impl <+ index-uri-generic
+  
+  /**
+   * Gets the namespace part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), \"Bar\", \"Baz\"] => Entity()
+   *
+   * @type uri@[namespace|path] -> namespace
+   */ 
+  index-uri-namespace =
+    ?[<id>|_]
+  
+  /**
+   * Gets the path part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), \"Bar\", \"Baz\"] => [\"Bar\", \"Baz\"]
+   *   <index-uri-path> [Entity()] => []
+   *
+   * @type uri@[namespace|path] -> path
+   */ 
+  index-uri-path =
+    ?[_|<id>]
     
   /**
-   * Gets the URI part for given term.
+   * Gets the name part of the given URI or fail if there is no name.
+   *
+   * Example:
+   *   <index-uri-name> [Entity(), \"Bar\", \"Baz\"] => \"Bar\"
+   *   <index-uri-name> [Entity()] => fail
+   *
+   * @type uri@[namespace|[name|restPath]] -> ?name
    */ 
-  index-uri = index-uri-impl <+ index-uri-generic
+  index-uri-name =
+    ?[_|[<id>|_]]
+  
+  /**
+   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
+   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
+   * from the given term.
+   *
+   * Example:
+   *   <index-value> DefData([Entity(), \"Bar\", \"Baz\"], Type(), TYPE(\"Bar\")) => TYPE(\"Bar\")
+   *
+   * @type elem -> ?value
+   *
+   * @see index-value-impl
+   * @see index-value-generic
+   */  
+  index-value = 
+    index-value-impl <+ index-value-generic
+  
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   *
+   * @type x -> ?x
+   */
+  index-is-fake-file = 
+    string-starts-with(|\"/.internal\")
   
   /**
    * Checks if given URI's are equal. Discards anonymous scopes if necessary.
@@ -292,6 +627,8 @@
    *   <index-uri-eq> ([Entity(), Anon(\"a\"), \"Bar\"], [Entity(), Anon(\"b\"), \"Bar\"]) => 
    *     ([Entity(), Anon(\"a\"), \"Bar\"], [Entity(), Anon(\"b\"), \"Bar\"])
    *   <index-uri-eq> ([Entity(), \"Foo\"], [Entity(), \"Bar\"]) => fail
+   *
+   * @type (u1, u2) -> ?(u1, u2)
    */
   index-uri-eq:
     (u1, u2) -> <id>
@@ -299,59 +636,97 @@
       u1' := <index-uri-unwrap> u1;
       u2' := <index-uri-unwrap> u2;
       (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
-
+  
   /**
-   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   * Finds the first key (term{uri} element) for given term, or fail. 
    *
-   * Example:
-   *   <index-key-eq> (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]}) => 
-   *     (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]})
-   *   <index-key-eq> (\"Foo\"{[Entity(), \"Foo\"]}, \"Bar\"{[Entity(), \"Bar\"]}) => fail
-   */      
-  index-key-eq:
-    (k1, k2) -> <id>
+   * @type x -> ?name{uri}
+   */
+  index-find-key:
+    x -> key
     where
-      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
+      key := <collect-one(?_{_})> x
+      
+  /**
+   * Converts a URI to a string.
+   *
+   * Example:
+   *   <index-uri-to-string> [Entity(), \"Bar\", \"Baz\"] => \"Entity://Bar.Baz\"
+   *
+   * @type uri -> str
+   */
+  index-uri-to-string:
+    [ns|path] -> <concat-strings> [nsStr, \"://\", pathStr]
+    with
+      pathStr := <take-until(?Anon(_)); reverse; separate-by(|\".\"); concat-strings> path;
+      nsStr := <?<id>#(_)> ns
   
   /**
-   * Gets the value part for given term.
-   */  
-  index-value = index-value-impl <+ index-value-generic
+   * Converts a file to a string.
+   *
+   * Example:
+   *   <index-file-to-string> \"fullpath/file.ext\" => \"fullpath/file.ext\"
+   *
+   * @type file -> file
+   */
+  index-file-to-string:
+    file -> file
+    where
+      not(<is-tuple> file)
   
   /**
-   * Finds the first key (term{uri} element) for given term, or fail. 
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> (\"fullpath/file.ext\", \"\") => \"fullpath/file.ext\"
+   *
+   * @type (file, \"\") -> file
    */
-  index-find-key:
-    x -> key
+  index-file-to-string:
+    (file, \"\") -> file
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> (\"fullpath/file.ext\", \"subfile\") => \"fullpath/file.ext at subfile\"
+   *
+   * @type (file, subfile) -> str
+   */
+  index-file-to-string:
+    (file, subfile) -> <concat-strings> [file, \"@\", subfile]
     where
-      key := <collect-one(?_{_})> x
+      not(\"\" := subfile)
       
 /** @internal */
 rules // URI and value projections
-    
+  
+  /** @internal */
   index-uri-impl:
     DefData(uri, _, _) -> uri
 
+  /** @internal */
   index-uri-generic:
     term -> <?_#(<?[<id>|_]>)> term
   
+  /** @internal */
   index-value-impl:
     DefData(_, _, value) -> value
     
+  /** @internal */
   index-value-generic:
     term -> <?_#(<?[_, <id>|_]> )> term
      
 /** @internal */ 
 rules // Internal helpers
   
+  /** @internal */
   index-namespace-unwrap =
     \\Unresolved(n) -> n\\ <+ id
     
+  /** @internal */
   index-uri-unwrap =
     \\[ns|xs] -> [<index-namespace-unwrap> ns|xs]\\ <+ id
-    
-  index-key-unwrap = 
-    \\key{uri} -> key{<index-uri-unwrap> uri}\\ <+ id
 "
 
   create-analysis-library =
@@ -361,19 +736,20 @@
  
 imports
   libstratego-lib
+  libstratego-parallel
   lib/editor-common.generated
   lib/index-library.generated
  
 signature constructors
  
   // Analyze constructors
-  AnalysedResult : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) -> AnalysedResult
+  Results     : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
   Editor      : AnalysisPhase
   Compile     : AnalysisPhase
  
   // Index elements
   Def          : List(UriPart) -> Summary
-  Use          : List(UriPart) * List(UriPart) -> Summary
+  Use          : List(UriPart) -> Summary
   BadUse       : List(UriPart) -> Summary
   Read         : List(UriPart) -> Summary
   ReadWildcard : List(UriPart) * String -> Summary
@@ -386,232 +762,306 @@
   // Adjust lookup actions
   StopLookup   : LookupAction
   
-rules // extension points
- 
-  // Should return list of Def(_) and/or [namespace | path] or StopLookup() to stop the lookup
-  adjust-index-lookup(is-use |namespace, path, prefix) = fail
- 
-  // adjust-index-select(|namespace, path, use) = fail // (e.g., for imports)
- 
-  // Should call <store-results> on a (list of) DefData
-  adjust-index-def-data(store-results |namespace, path) = fail
- 
-  // Should return a path
-  adjust-index-path(is-def |namespace, path) = fail
+  // Parallel
+  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
+  
+rules // Index analysis extension points
  
-  // adjust-index-path-from-filesystem(|project-path, path)
+  /**
+   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
+   *
+   * The overriden rule must return a list that contains any of the following items:
+   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
+   *                        use site to this definition.
+   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
+   * 
+   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
+   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
+   * will be used.
+   *
+   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
+   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
+   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
+   * lookups that will always fail anyway.
+   *
+   * Extension example:
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     PropAccess(exp, name) -> properties
+   *     where
+   *       <check-target-name> name
+   *     with
+   *       if TYPE(type{_}) := <type-of> exp then
+   *         properties := <index-lookup-children(|Property(), prefix)> type
+   *       else
+   *         properties := StopLookup()
+   *       end
+   *
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     Var(name) -> [[Var() | path], [Property() | path]]
+   *     where
+   *       <check-target-name> name
+   *
+   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
+   *                            lookup algorithm is looking for.
+   * @param namespace           The namespace of the element that should be looked up.
+   * @param path                The path the lookup algorithm is currently looking at for the element.
+   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
+   *                            full name of the element, but could be a partial prefix during content completion.
+   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
+   */
+  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
+  
+  /** 
+   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
+   * a (list of) data that must be stored in the index.
+   *
+   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
+   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
+   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
+   * rule fail if you are doing a <filter(store-results)> for example.
+   *
+   * Extension example:
+   *   adjust-index-def-data(store-results|namespace, path):
+   *     def -> <store-results> Type([namespace|path], type)
+   *     where
+   *       type := <type-of> def
+   *
+   * @param store-results Call this on the data you want to store in the index.
+   * @param namespace     The namespace of the definition that the rule is being called on.
+   * @param path          The path of the definition that the rule is being called on.
+   * @type def -> fail 
+   */
+  adjust-index-def-data(store-results|namespace, path) = fail
   
   /**
-   * Should define constructors to check for difference during analysis. Defaults to Def constructs.
+   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
+   * use sites. Should return a path that will be assigned to the definition or use site.
+   *
+   * Extension example:
+   *   adjust-index-path(check-target-definition|namespace, path):
+   *     Start(_, _) -> [<string-replace(|<project-path>, \"\")> <Fst> <index-get-current-file>]
+   *
+   *
+   * @param check-target-definition 
+   * @param namespace               The namespace that would be given to the current definition or use site.
+   * @param path                    The path that would be given to the current definition or use site.
+   * @type def -> uri@[namespace|path]
+   */
+  adjust-index-path(check-target-definition|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
+   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
    *
    * Extension example:
    *   index-diff-constructors = ?Type(_, _)
+   *
+   * @type a -> ?a
+   *
+   * @see index-diff-compare
    */
-  index-diff-constructors = ?Def(_)
+  index-diff-constructors = 
+    ?Def(_)
   
   /**
-   * Should compare two index elements and fail if they are not equal.
+   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
+   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
+   * compared.
    *
    * Extension example:
-     *   index-diff-compare:
+   *   index-diff-compare:
    *     (Type(u1, v1), Type(u2, v2)) -> <id>
    *     where
    *       <index-uri-eq> (u1, u2);
    *       <eq> (v1, v2)
+   *
+   * @type (a, b) -> ?(a, b)
+   *
+   * @see index-diff-constructors
    */
   index-diff-compare:
     (Def(u1), Def(u2)) -> <id>
     where
        <index-uri-eq> (u1, u2)
-       
-  post-analyze-top(|phase, language, full-path) = fail
  
-rules // analysis traversals
+rules // Analysis traversals
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
-   * Defaults to Editor() phase and tries to automatically determine language name.
+   * Defaults to Editor() phase.
    *
-   * @see analyze-top(|phase, language)
-   */
-  analyze-top = analyze-top(|Editor())
-  
-  /**
-   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
-   * Tries to automatically determine language name.
+   * @param language  The name of the language that is being analysed.
+   *
+   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
    *
    * @see analyze-top(|phase, language)
    */
-  analyze-top(|phase) = ?(ast, _, _); analyze-top(|phase, <index-origin-language> ast)
+  analyze-top(|language):
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
    
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
-   * @param phase     The type of analysis phase. There are currently 2 phases to choose from:
-   *                  - Editor():   All information is stored into the index and dependent files
-   *                                are automatically scheduled for re-analysis.
-   *                  - Compile():  No information is stored and no re-analysis is done.
-   * @param language  The name of the language that is being analysed.
+   * @param phase         The type of analysis phase. There are 2 phases to choose from:
+   *                      - Editor():   File dependencies are analysed.
+   *                      - Compile():  File dependencies are not analysed.
+   * @param language      The name of the language that is being analysed.
+   * @param path          The path of the file to analyze relative to project-path.
+   * @param project-path  The path of the directory that contains all the source files.
+   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
    *
-   * @see analyze-top-internal(|phase, language)
+   * @see analyze-top-internal(|phase, language, project-path, full-path)
    */
-  analyze-top(|phase, language):
-    (ast, path, project-path) -> ast'
+  analyze-top(|phase, language, path, project-path):
+    ast -> (ast', filesToAnalyze)
     with
-      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|phase, language)> (ast, path, project-path)
+      full-path := $[[project-path]/[path]];
+      if index-split then
+        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
+        asts := <index-toplevel-split> ast;
+        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
+      else
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
+      end
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
    * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
    */
-  analyze-top-internal = 
-    analyze-top-internal(|Editor())
-  analyze-top-internal(|phase) = 
-    ?(ast, path, project-path); analyze-top-internal(|phase, <index-origin-language> ast)
-  analyze-top-internal(|phase, language) = 
-    ?(_, path, project-path); analyze-top-internal(|phase, language, $[[project-path]/[path]])
-  analyze-top-internal(|phase, language, full-path):
-    (ast, path, project-path) -> AnalysedResult(ast5, defs, uses, data', added, removed)
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
     with
       // Init
-      index-setup(|language, [project-path], full-path)
+      index-setup(|language, [project-path], full-path);
+      revision := <index-start-transaction>
     with
-      file := (full-path, \"\"); // TODO: Get subfile or add subfile param.
-        // Store copy of elements for diff and clear file
-      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> file;
-      <index-clear-file> file
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
     with
-      {| Index-ReadSet, Index-UnresolvedSet:
-        readSet := <new-iset>;
+      {| Index-UnresolvedSet:
         unresolvedSet := <new-iset>;
-        
-        rules(Index-ReadSet: _ -> readSet);
         rules(Index-UnresolvedSet: _ -> unresolvedSet);
-       
-        // Add Unresolved annotations, record globals
-        (Some(ast2), defs) := <analyze-defs(|Anon(), Anon())> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
-        <index-add-all(|file)> defs;
-
-        // Find DefData
-        ast3 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast2;
-        data := <origin-track-forced(analyze-tree-data)> ast3;
-        <index-add-all(|file)> data;
-
-        // Resolve an references in DefData (using what we just stored)
-        (data', data-uses) := <analyze-uses> data;
-        <index-remove-all(|file)> data;
-        <index-add-all(|file)> data';
-       
-        // Resolve all unresolved references in the tree
-        (ast4, uses) := <analyze-uses> ast3;
-        <index-add-all(|file)> uses;
         
-        ast5 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast4;
-       
-        // Store reads into the index (if current language is not testing language)
-        if not(<is-test-input(|language)> (ast, path)) then
-          <index-add-all(|file)> <iset-elements> readSet
-        end
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+        (asts, _) := <unzip> astFilePairs4
       |}
     with
+      index-end-transaction
+    with
       // Schedule re-analysis of dependent files (if current file is not testing language file)
       // HACK: Depends on file extension, could be other languages with .spt extension?
-      if Editor() := phase; not(<is-test-file> path) then
-        newElems := <conc> (defs, <filter(index-diff-constructors)> data');
+      if Editor() := phase; not(<is-test-file> full-path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
         
-          // Find added and removed definitions
-          (added, removed) := <analyze-diff> (oldElems, newElems);
-          changed := <conc> (added, removed);
-
-          // Schedule re-analysis of files that depend on added or removed elements
-          <reanalyze-all(|full-path)> changed;
-          
-          // TODO: Move diff stuff to compilation-library somehow.
-          // Store added and removed elements in the index
-          analyze-store-diff(|changed, file, ast)
-        else
-          (added, removed) := ([], [])
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
+        // Store files that have changed in the index
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
       end
     with
-      try(post-analyze-top(|phase, language, full-path))
-
-  analyze-diff:
-    (defs1, defs2) -> (added, removed)
-    with
-      added   := <diff(index-diff-compare)> (defs2, defs1);
-      removed := <diff(index-diff-compare)> (defs1, defs2)
-  
-  reanalyze-all(|file) =
-    index-get-dependent-files; 
-    filter(not(analyze-changed-filter-file(|file)); reanalyze-file)
-    
-  analyze-changed-filter-file(|file) = 
-    ?files@(<id>, _); (is-test-file <+ index-is-fake-file <+ ?file); !files
-    
-  reanalyze-file = 
-    ?(<id>, _); debug(!\"Re-analyzing \"); prim(\"SSL_EXT_queue_analysis\")
-    
-  analyze-store-diff(|changedEntries, file, ast): 
-    _ -> <id>
-    with
-      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
-      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
-      dependentFiles  := <index-get-dependent-files> changedEntries;
-      files := <conc> (changedFiles, dependentFiles);
-      
-      if not(<analyze-astdiff(|ast)> file) then
-        // Add current file if the AST has changed. Cannot use dependency tracking here because
-        // the originating file of a removed definition is not in the index any more.
-        files' := <make-set> [file|files] 
-        else
-            files' := <make-set> files
-        end;
-      
-      if not([] := files') then
-        storePath := <analyze-diff-path>;
-        <map(analyze-add-diff(|storePath))> files'
-      end
+      <list-loop(analyze-top-store-ast)> astFilePairs4
       
-  analyze-add-diff(|storePath):
-    file -> <id>
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
     with
-      <index-add-all(|storePath)> [Diff([Diff(), \".internal\"], file)]
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
       
-  analyze-get-diffs:
-    _ -> diffs
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
     with
-        diffs := <make-set> <index-get-all-values> Diff([Diff(), \".internal\"], ())
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
         
-  // Fails if old ASTDiff is not found or if ASTDiff is different.
-  analyze-astdiff(|ast):
-    (file, subfile) -> <id>
-    where
-      storePath := <analyze-diff-path>;
-        newChecksum := <checksum> ast;
-      if oldChecksum := <index-get-value> Diff([ASTDiff(), file, \".internal\"], ()) then
-        <index-remove-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], ())];
-          <index-add-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], newChecksum)];
-        <eq> (oldChecksum, newChecksum)
-        else
-            <index-add-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], newChecksum)];
-            fail
+        // Gather all data for each definition.
+        ast2 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
         end
+      |}
       
-  analyze-clean-diff:
-    _ -> <id>
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
     with
-        storePath := <analyze-diff-path>; 
-      <index-remove-all(|storePath)> [Diff([Diff(), \".internal\"], ())]
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
         
-  analyze-diff-path = 
-    !\"/.internal/diff\"
- 
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|[<index-file-to-string> file, \"ast\"])> ast
+      
   /**
-   * Identifies all definitions in the tree
-   * and annotates them with their URI.
+   * Identifies all definitions in the tree and annotates them with their URI.
    * Also annotates uses with a preliminary \"Unresolved(_)\" URI.
+   *
+   * @internal
    */
+  analyze-defs = analyze-defs(|Anon(), Anon())
+  /** @internal */
   analyze-defs(|head-scope, head-scope-ns):
     ast -> (ast', defs')
     with
@@ -633,7 +1083,8 @@
         (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
       end;
       defs' := <![def | defs] <+ !defs>
- 
+      
+  /** @internal */
   analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
     ast -> (ast'', defs)
     where
@@ -641,6 +1092,7 @@
       (ast', defs)  := <unzip-analyzed> analyzed;
       ast''         := <try(nam-annotate-names(|def-path))> ast'
  
+  /** @internal */
   update-index-path(|head-scope, head-scope-ns, ast):
     scope-type -> scope-type
     where
@@ -670,23 +1122,19 @@
   */
  
   /**
-   * Analyze all uses, changing their preliminary
-   * \"Unresolve(_)\" URI to a definite URI of their definition.
+   * Analyze all uses, changing their preliminary \"Unresolved(_)\" URI to a definite URI of their definition.
+   *
+   * @internal
    */
-  analyze-uses = analyze-uses(|None())
-  analyze-uses(|parent):
+  analyze-uses:
     ast -> (ast'', uses')
     with
-      analyzed     := <all(analyze-uses(|ast))> ast;
+      analyzed     := <all(analyze-uses)> ast;
       (ast', uses) := <unzip-analyzed> analyzed;
       if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
         if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
           ast'' := ast{def-uri};
-          if key{keyUri} := <nam-get-definition-key> parent ; not(<eq>(key, ast')) then
-            uses' := [Use(def-uri, keyUri) | uses]
-          else
-            uses' := [Use(def-uri, [namespace | path]) | uses]
-          end
+          uses' := [Use(def-uri) | uses]
         else
           ast'' := ast';
           uses' := [BadUse([namespace, x]) | uses]
@@ -697,7 +1145,9 @@
       end
  
   /**
-   * Collects all index data (e.g., types of definitions).
+   * Collects all index data (e.g. types of definitions).
+   *
+   * @internal
    */
   analyze-tree-data:
     tree -> data
@@ -705,7 +1155,8 @@
       set := <new-iset>;
       <topdown(analyze-tree-data-part(|set))> tree;
       data := <iset-elements> set
- 
+      
+  /** @internal */
   analyze-tree-data-part(|set):
     tree -> tree
     where
@@ -715,7 +1166,8 @@
           <fatal-err(|\"Unexpected result from adjust-index-def-data; should call <store-results>\")> result
         end
       end
- 
+  
+  /** @internal */
   store-index-data-results(|set):
     t -> <fail>
     where
@@ -724,38 +1176,204 @@
       else
         <iset-add(|t)> set
       end
- 
+  
+rules // Parallel analysis
+  
   /**
-   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) )
-   * to a tuple (C(a1, a2), [b1, b2, b3]).
+   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
+   * analysis of dependent files that have changed during the analysis.
+   *
+   * Example:
+   *   <index-parallel-analyze-files(analyze)> [\"text/file1.ext\", \"text/file2.ext\"]
+   *
+   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
+   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
+   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @type List((file, subfile) or file) -> None()
    */
-  unzip-analyzed:
-    appl -> (appl', unzipped-parts)
+  index-parallel-analyze-files(analyze):
+    files -> None()
     with
-      appl'          := <all(\\(a, _) -> a\\)> appl;
-      unzipped-parts := <concat> <get-appl-arguments(\\(_, b) -> b\\) <+ map(\\(_, b) -> b\\) <+ ![]> appl
+      length; 
+      set-total-work-units
+    with
+      index-parallel-analyze(analyze);
+      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
+  
+  /** @internal */
+  index-parallel-analyze(analyze):
+    files -> allResults
+    with
+      map(index-parse-file); // Parsing cannot be done in parallel.
+      map(\\(ast, file) -> (ast, file, <project-path>)\\);
+      parallel-unordered(all(index-analyze(analyze)));
+      ?results;
+      with(<eq> (<length> results, <length> files) | \"Input size not equal to output size\");
+      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
+      if not([] := filesToAnalyze) then
+        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
+      else
+        allResults := results
+      end
+  
+  /** @internal */   
+  index-parse-file:
+    file -> (ast, file)
+    with
+    if <file-exists> file then
+      ast := <parse-file> file
+    else
+      ast := ()
+    end
+   
+  /** @internal */   
+  index-set-markers:
+    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
+    with
+      <set-markers(|ast)> (ast', errors, warnings, notes)
+      
+  /** @internal */
+  index-analyze(analyze):
+    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
+    with
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      if [] := filesToAnalyze then
+        complete-work-unit
+      end
+      
+/** @internal */
+rules // Splitter
+  
+  /** @internal */
+  index-split = fail
+  /** @internal */
+  index-is-toplevel = fail
+  /** @internal */
+  index-is-qualifier = fail
+  /** @internal */
+  index-qualifier-subelements = fail
+  /** @internal */
+  index-create-qualifier(|qualifier) = fail
+  
+  /** @internal */
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  /** @internal */
+  index-toplevel-split-internal:
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, <index-uri> <nam-get-definition-key> node)]
+        otherwise:
+          units := [(node, [])]
+      end
+      
+  /** @internal */
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      qualifier := <index-create-qualifier(|node)> elem
+
+/** @internal */
+rules // Diffs
+  
+  /** @internal */
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+    
+  /** @internal */
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
+    with
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      
+      // Files to analyze
+      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
+      analyzeFiles' := analyzeFiles;
+      // TODO: Is this extra check needed?
+      /*if <getfirst(index-get-file-revision; \\r -> (r, revision)\\; gt)> analyzeFiles then
+        // Add current file if the current file has read information from another file with a higher revision.
+        // This indicates that potentially outdated information was read.
+        analyzeFiles' := [file|analyzeFiles]
+      else
+        analyzeFiles' := analyzeFiles
+      end;*/
+      
+      // Files to compile
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      <map(analyze-add-compilediff)> compileFiles
+      
+  /** 
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
+   *
+   * @internal
+   */
+  analyze-astdiff:
+    (ast, file) -> file
+    where
+      name := [<index-file-to-string> file, \"ast-checksum\"];
+      newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-global(|name)> then
+        <index-set-global(|name)> newChecksum;
+        not(<eq> (oldChecksum, newChecksum))
+      else
+        <index-set-global(|name)> newChecksum
+      end
+      
+  /** 
+   * Adds given file to the list of files to compile.
+   *
+   * @internal
+   */
+  analyze-add-compilediff = index-add-global(|\"compile-diff\")
+  
+  /** 
+   * Gets the list of files to compile, and then clear it.
+   *
+   * @internal
+   */
+  analyze-get-compilediffs = index-get-all-globals(|\"compile-diff\"); index-clear-global(|\"compile-diff\")
  
-rules // index API primitives
+rules // index API query primitives
  
   /**
    * Gets all DefData entries that match the kind of data and URI in given definition.
    *
+   * Example:
+   *   <index-get-data(|Type())> Def([Entity(), \"Bar\"]) => [DefData([Entity(), \"Bar\"], Type(), TYPE(\"Bar\")), ...]
+   *
    * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(DefData(uri, kind, value))
+   */
+  index-get-data(|kind):
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-value> DefData(uri, kind, ())
+      
+  /**
+   * Gets all data entries that match the kind of data and URI in given definition.
    *
    * Example:
-   *   <index-get-data(|Type())> Def([Entity(), \"Bar\"]) => [DefData([Entity(), \"Bar\"], Type(), TYPE(\"Bar\")), ...]
+   *   <index-get-data-all(|Type())> Def([Entity(), \"Bar\"]) => [TYPE(\"Bar\"), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(value)
    */
-  index-get-data(|kind):
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-value> DefData(uri, kind, ())
-      
-    /**
-     * Gets all data entries that match the kind of data and URI in given definition.
-     *
-     * @param kind Only data of this kind is returned.
-     *
-     * Example:
-     *   <index-get-data-all(|Type())> Def([Entity(), \"Bar\"]) => [TYPE(\"Bar\"), ...]
-     */
   index-get-data-all(|kind):
     <with(?Def(uri) | \"Def expected\")> -> <index-get-all-values> DefData(uri, kind, ())
      
@@ -763,16 +1381,20 @@
    * Gets all Use entries that match the URI in given definition.
    *
    * Example:
-   *   <index-get-uses-all> Def([Entity(), \"M\", \"Bar\"]) => [Use([Entity(), \"M\", \"Bar\"], [Entity(), \"M\"]), ...]
+   *   <index-get-uses-all> Def([Entity(), \"M\", \"Bar\"]) => [Use([Entity(), \"M\", \"Bar\"]), ...]
+   *
+   * @type Def(uri) -> List(Use(uri))
    */
   index-get-uses-all:
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-all> Use(uri, [])
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-all> Use(uri)
      
   /**
    * Gets all Read or ReadWildcard entries that match the given template.
    *
    * Example:
    *   <index-get-reads-all> [Property(), \"Bar\", \"p\"] => [Read([Property(), \"Bar\", \"p\"]), ...]
+   *
+   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
    */
   index-get-reads-all:
     template -> <conc> (reads, readwildcards')
@@ -791,6 +1413,8 @@
    *
    * Example:
    *   <index-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @type template -> List(elem)
    */
   index-get-all:
     template -> <indexlib-get-all> template
@@ -803,10 +1427,12 @@
   /**
    * Get all values of index entries that match the given template.
    *
-   * @see index-value
-   *
    * Example:
    *   <index-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
    */
   index-get-all-values:
     template -> <map(index-value)> <index-get-all> template
@@ -816,6 +1442,8 @@
    *
    * Example:
    *   <index-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
+   *
+   * @type template -> ?elem
    */
   index-get:
     template -> <?[<id>|_]> <index-get-all> template
@@ -823,119 +1451,140 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
-   * @see index-value
-   *
    * Example:
    *   <index-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
    */
   index-get-value:
     template -> <index-value> <?[<id>|_]> <index-get-all> template
-   
-  /**
-   * Gets the namespace part of the URI for given term.
-   */
-  index-namespace:
-    x{[namespace | path]} -> <index-namespace-unwrap> namespace
 
   /**
-   * Gets the path part of the URI for given term.
+   * Gets all Def children elements of an URI in a certain namespace.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field())> Def([Entity(), \"Baz\"]) => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
+   *   <index-get-children(|Field())> \"Foo\"{[Entity(), \"Baz\"]} => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
+   *   <index-get-children(|Field())> [Entity(), \"Baz\"] => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
-  index-path:
-    x{[namespace | path]} -> path'
-    where
-      if !namespace => Unresolved(namespace) then
-        Def(path') := <index-lookup>
-      else
-        path' := path
-      end
-    
+  index-get-children(|namespace) = 
+    index-get-children(\\uri -> Def(uri)\\|namespace)
+  
   /**
-   * Determines if a given AST node is a definition site,
-   * according to the syntax.
+   * Gets all children elements of an URI in a certain namespace using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
-  index-is-definition =
-    where(nam-get-definition-key)
- 
+  index-get-children(construct-template|namespace):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | \"Def, key or uri expected\")> -> children
+    with
+      template  := <construct-template> [namespace | path];
+      children  := <prim(\"LANG_index_get_children\", template)>;
+      <store-wildcard-read(|namespace, path, \"\")> children
+
   /**
-   * Returns all children of a Def.
+   * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
    *
-   * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * Example:
+   *   <index-get-children(|Field(), \"fo\")> Def([Entity(), \"Baz\"]) => [Def([Field(), \"Foo\"]), ...]
+   *   <index-get-children(|Field(), \"ba\")> \"Foo\"{[Entity(), \"Baz\"]} => [Def([Field(), \"Bar\"]), ...]
+   *   <index-get-children(|Field(), \"ze\")> [Entity(), \"Baz\"] => [...]
    *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
-  index-get-children(|namespace, prefix):
-    <with(?Def([parent-ns | path]) | \"Def expected\")> -> children'
+  index-get-children(|namespace, prefix) = 
+    index-get-children(\\uri -> Def(uri)\\|namespace, prefix)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
+   * using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @param prefix              Only child elements where the name starts with this prefix are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace, prefix):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | \"Def, key or uri expected\")> -> children'
     with
-      with(not(!namespace => Def(_)) | \"index-get-children interface changed\");
       prefix'   := <strip-annos> prefix;
-      template  := Def([namespace | path]);
+      template  := <construct-template> [namespace | path];
       children  := <prim(\"LANG_index_get_children\", template)>;
       children' := <filter(index-is-name-substring(|prefix'))> children;
-      store     := [namespace, prefix' | path];
-      // Store read in index.
-      if set := <Index-ReadSet> then
-        if 1 := <length> children' then
-          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
-          // be handled in the index primitives instead.
-          <iset-add(|Read([namespace, prefix' | path]))> set
-        else
-          <iset-add(|ReadWildcard([namespace | path], prefix'))> set
-        end
-      end
+      <store-wildcard-read(|namespace, path, prefix')> children'
 
   /**
    * Gets a set of all files that have a reference to the given index entries.
    *
-   * @param construct-from-uri  Construction strategy that creates a list of reference constructs from all 
-   *                            given entries, such as \\uri -> [Read(uri), Use(uri, [])]\\
-   *
    * Example:
    *   <index-get-referenced-files(\\uri -> [Read(uri), Use(uri, [])]\\)> [Def([Entity(), \"Bar\"]), ...] => 
    *     [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
+   *
+   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
+   *                            constructs from all given entries, such as \\uri -> [Read(uri), Use(uri, [])]\\
+   * @type List(elem) -> List((file, subfile))
    */
   index-get-referenced-files(construct-from-uri):
     entries -> files
     where
       uris        := <filter(index-uri)> entries;
       referenced  := <concat> <filter(construct-from-uri)> uris;
-      files       := <make-set> <mapconcat(index-get-files-of)> referenced
+      files       := <iset-elements> <iset-addlist(|<mapconcat(index-get-files-of)> referenced)> <new-iset>
  
   /**
    * Convenience function for finding files with Read and Use dependencies to the given definitions.
    *
-   * @see index-get-referenced-files(construct-from-uri)
-   * @see index-file-dependent-construct
-   *
    * Example:
    *   <index-get-dependent-files> [Def([Entity(), \"Bar\"]), ...] => [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
+   *
+   * @type List(elem) -> List((file, subfile))
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
    */
   index-get-dependent-files = 
     index-get-referenced-files(index-file-dependent-construct)
      
-rules // index lookup rules (take into account adjust-index-lookup)
+rules // Index lookup rules (take into account adjust-index-lookup)
  
   /**
    * Given an annotated AST node, resolves it, returning its Def.
+   *
+   * @type \"name\"{uri} -> ?Def(uri')
    */
   index-lookup:
-    x{[namespace | path]} -> <index-lookup(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
+   * 
+   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-all:
-    x{[namespace | path]} -> <index-lookup-all(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
+   * @type \"name\"{uri} -> ?Def(uri')
    */
-  index-lookup(is-adjust-lookup-enabled |namespace, path, prefix):
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> def
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
@@ -944,27 +1593,27 @@
       else
         def        := <index-select(|namespace, path, x)>
       <+
-          // TODO: optimize: try not to call do-adjust-index-lookup from here
-          [_ | path'] := path;
-          def         := <index-lookup(is-adjust-lookup-enabled |namespace, path', prefix)> x
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
       end
 
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
+   * @type \"name\"{uri} -> List(Def(uri'))
    * @internal
    */
-  index-lookup-all(is-adjust-lookup-enabled |namespace, path, prefix):
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> defs'
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
       defs       := <index-select-all(|namespace, path, x)>;
       // TODO: optimize: try not to call do-adjust-index-lookup from here
       if [_ | path'] := path then
-        defs2 := <index-lookup-all(is-adjust-lookup-enabled |namespace, path', prefix)> x;
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
         defs' := <conc> (defs, defs2)
       else
         defs' := defs
@@ -973,18 +1622,18 @@
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> ?Def(uri')
    */
   index-lookup-outermost(|prefix):
-    x{[namespace | path]} -> <index-lookup-outermost(id |<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
+   * @type \"name\"{uri} -> ?Def(uri')
    * @internal
    */
   index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
@@ -998,23 +1647,24 @@
       def        := <index-select(|namespace, path, x)>
  
   /**
-   * Given an annotated AST node, returns a Def that has the same parent URI.
+   * Given an annotated AST node, returns Defs that have the same parent URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-one-level(|prefix):
-    x{[namespace | path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   *
+   * @type \"name\"{uri} -> List(Def(uri'))
+   * @internal
    */
-  index-lookup-one-level(is-adjusted-lookup-enabled |namespace, path, prefix):
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
     x{_} -> defs
     with
       is-adjusted-lookup-enabled;
@@ -1031,22 +1681,22 @@
       defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
       
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-all-levels(|prefix):
-    x{[namespace | path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
     x{_} -> all-defs
@@ -1056,10 +1706,10 @@
       if ?StopLookup() then
         all-defs := []
       else
-          mapconcat(\\d at Def(p) -> [d]\\
-              <+ \\[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\\
-              <+ fatal-err(|\"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup\"));
-          ?all-defs
+        mapconcat(\\d at Def(p) -> [d]\\
+            <+ \\[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\\
+            <+ fatal-err(|\"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup\"));
+        ?all-defs
       end
     <+
       one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
@@ -1069,23 +1719,12 @@
         all-defs := one-level
       end
  
-  /** @Deprecated */
-  index-lookup-contained(|namespace, prefix) =
-    obsolete(!\"index-lookup-contained; use index-lookup-children\");
-    index-lookup-children(|namespace, prefix)
-   
-  /** @Deprecated */
-  index-lookup-contained-all-levels(|namespace, name) =
-    obsolete(!\"index-lookup-contained-all-levels; use index-lookup-descendants\");
-    index-lookup-descendants(|namespace, name)
- 
   /**
-   * Given an annotated AST node, resolves it,
-   * and returns all child Defs of its definition.
+   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
    *
    * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only child Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
     x{[ns | path]} -> defs
@@ -1098,100 +1737,226 @@
       end
     <+
       defs := []
- 
+      
+rules // Index utilities
+  
   /**
-   * Given an annotated AST node, resolves it,
-   * and returns all descendant Defs of its definition.
+   * Gets the namespace part of the URI for given key (term{uri} element).
    *
-   * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only child Defs with a name that starts with this
-   *                  string are returned.
+   * Example:
+   *   <index-uri-namespace> \"Bar\"{[Entity(), \"Bar\", \"Baz\"]} => Entity()
+   *
+   * @type \"name\"{uri@[namespace|path]} -> namespace
    */
-  index-lookup-descendants(|namespace, name):
-    x{[ns | path]} -> defs
-    with
-      if !ns => Unresolved(_) then
-        Def([_ | def-path]) := <index-lookup>;
-        defs := <index-lookup-all-levels(id|namespace, def-path, name)> x
+  index-uri-namespace:
+    x{[namespace|path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   *
+   * Example:
+   *   <index-uri-path> \"Bar\"{[Entity(), \"Bar\", \"Baz\"]} => [\"Bar\", \"Baz\"]
+   *
+   * @type \"name\"{uri@[namespace|path]} -> path'
+   */
+  index-uri-path:
+    x{[namespace|path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
       else
-        defs := <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, name)>
+        path' := path
       end
-    <+
-      defs := []
+      
+  /**
+   * Gets the name part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-name> \"Bar\"{[Entity(), \"Bar\", \"Baz\"] => \"Bar\"
+   *
+   * @type \"name\"{uri@[namespace|[name|restPath]]} -> name
+   */ 
+  index-uri-name:
+    x{[_|[name|_]]} -> name
+    
+  /**
+   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
+   *
+   * Example:
+   *   <index-uri-name> Def([Entity(), \"Bar\", \"Baz\"]) => \"Bar\"
+   *   <index-uri-name> Type(\"Foo\") => fail
+   *   <index-uri-name> Read([Entity()]) => fail
+   *
+   * @type x -> name
+   */   
+  index-uri-name:
+    x -> <index-uri-name> <index-uri> x
+    where
+      not(<has-annos> x)
+    
+  /**
+   * Determines if a given AST node is a definition site, according to the syntax.
+   *
+   * FIXME: Also succeeds on use sites.
+   *
+   * @type def -> ?def
+   */
+  index-is-definition =
+    where(nam-get-definition-key)
+    
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]}) => 
+   *     (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]})
+   *   <index-key-eq> (\"Foo\"{[Entity(), \"Foo\"]}, \"Bar\"{[Entity(), \"Bar\"]}) => fail
+   *
+   * @type (k1, k2) -> ?(k1, k2)
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
        
 /** @internal */
 rules // URI and value projections
        
+  /** @internal */
   index-uri-impl:
     Def(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
-    Use(uri, _) -> uri
+    Use(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     Read(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
  
-  // TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
   index-uri-impl:
     ReadWildcard(uri, _) -> uri
 
+  /** @internal */
   index-value-impl:
     Def(value) -> value
 
+  /** @internal */
   index-value-impl:
-    Use(_, value) -> value
+    Use(value) -> value
 
+  /** @internal */
   index-value-impl:
     Read(value) -> value
-    
+  
+  /** @internal */
   index-value-impl:
     ReadWildcard(_, value) -> value
        
 /** @internal */
 rules // Internal helpers
+
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\\(a, _) -> a\\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\\(_, b) -> b\\) <+ map(\\(_, b) -> b\\) <+ ![]> appl
        
-  index-origin-language = (origin-term <+ id); prim(\"SSL_EXT_origin_language\", <id>)
-       
-  // Tests if the current file is just a testing language input
-  is-test-file = string-ends-with(|\".spt\")
-  is-test-input(|language):
-    (ast, path) -> (ast, path)
-    where
-      <is-test-file> path;
-      not(!language => \"Spoofax-Testing\")
-       
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+    string-ends-with(|\".spt\")
+  /** @internal */
+  is-test-language = 
+    ?\"Spoofax-Testing\"
+  /** @internal */
+  is-test-input(|language, path) = 
+    <is-test-language> language <+ <is-test-file> path
+      
+  /** @internal */
+  fake-file = 
+    is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+    Fst; string-replace(|$[[<project-path>]/], \"\")
+  
+  /** @internal */
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uriStr))
+    with
+      (<index-uri-to-string> uri <+ !\"\") => uriStr
+  
+  /** @internal */     
   index-is-name-substring(|name):
     template -> <id>
     with
       [_, uri-name | _] := <index-uri>
     where
       <is-substring(!name)> uri-name
-      
+   
+  /** @internal */    
   index-readwildcard-substring(|prefix):
     ReadWildcard(_, name) -> <id>
     where <is-substring(!prefix)> name
-      
-  index-is-unresolved(|x, uri) = Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
-  index-add-unresolved(|x, uri) = (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
   
+  /** @internal */  
+  store-wildcard-read(|namespace, path, prefix):
+    children -> <id>
+    with
+      if set := <Index-ReadSet> then
+        if 1 := <length> children then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix))> set
+        end
+      end
+  
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
   index-file-dependent-construct: 
     uri -> <conc> (uses, reads)
     with
-        uses := <index-get-uses-all> Def(uri);
-        reads := <index-get-reads-all> Def(uri)
-    
-  index-file-dependency-filter = ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_, _)
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
  
+  /** @internal */
   do-adjust-index-lookup(|namespace, path, use, prefix) =
-    // UNDONE: try(origin-term);
     repeat-until(
       prim(\"SSL_EXT_get_parent\", <id>)
     , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
     )
  
+  /** @internal */
   index-select(|namespace, path, use) =
     getfirst(
       where(
@@ -1199,6 +1964,7 @@
       )
     )
  
+  /** @internal */
   index-select-all(|namespace, path, use) =
     filter(
       where(
@@ -1206,30 +1972,44 @@
       )
     )
  
+  /** @internal */
   do-adjusted-index-path(|namespace, path, def) =
     adjust-index-path(origin-equal(|def) |namespace, path)
   <+
     ![def | path]
  
+  /** @internal */
   index-eq(|namespace, expected) =
     where(
       ?Def([_, name | _]);
       <SRTS-EXT-eq-ignore-annos(|expected)> name
     )
   
+  /** @internal */
   external SRTS-EXT-eq-ignore-annos(|t)
+  
+  /** @internal */
+  index-key-unwrap = 
+    \\key{uri} -> key{<index-uri-unwrap> uri}\\ <+ id
+
+/** @internal */
+rules // Interface for generated code
  
-rules // interface for generated code
- 
+  /** @internal */
   nam-get-def(|namespace):
     x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
-   
+  
+  /** @internal */ 
   nam-annotate-use(|namespace):
     t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
-   
+  
+  /** @internal */ 
   nam-get-scope-types = fail
+  /** @internal */
   nam-get-definition = fail
+  /** @internal */
   nam-get-definition-key = fail
+  /** @internal */
   nam-annotate-names(|def-path) = fail
 "
 
@@ -1245,138 +2025,181 @@
   lib/analysis-library.generated
   
 rules // Extension points
+  
+  /**
+   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
+   *
+   * Extension example:
+   *   index-desugar-ast:
+   *     ast -> <desugar> ast
+   *
+   * @type ast -> ast'
+   */
+  index-desugar-ast = fail
     
-  // Should compile given analysed ast.
-  index-compile-ast(|file, subfile, project-path) = fail
+  /**
+   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
+   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
+   * compilation.
+   *
+   * Extensions example:
+   *   index-compile-ast(|file, subfile):
+   *     ast -> None()
+   *     with
+   *       java := <to-java> ast;
+   *       full-path := <dirname> file;
+   *       filename := <guarantee-extension(|\"java\")> <base-filename> file;
+   *       writePath := $[[full-path]/java/];
+   *       writeFile :=  $[[writePath][filename]];
+   *       try(<mkdir> writePath);
+   *       <fclose> <fputs> (java, <fopen> (writeFile, \"w\"))
+   *
+   * @param file    The file that must be compiled.
+   * @param subfile The subfile that must be compiled (\"\" if there is no subfile).
+   * @type ast -> None()
+   */
+  index-compile-ast(|file, subfile) = fail
   
 rules // Compilation
   
+  /**
+   * Schedules compilation in the background of all files that have changed since the last compilation.
+   *
+   * @type x -> x
+   */
   index-schedule-compilation:
-    <with(?(_, _, _) | \"(ast, path, project-path) tuple expected\")> -> None()
+    _ -> None()
     with
-      queue-strategy(|\"index-compilation\", \"Compiling!\")
-    
-  index-compilation:
-    (ast, path, project-path) -> <index-compilation(|path, project-path)> ast
+      queue-strategy(|\"index-compilation\", \"Compiling files\")
   
-  index-compilation(|path, project-path):
-    ast -> None()
+  /** @internal */
+  index-compilation:
+    language -> None()
     with
       // Init
-      full-path := $[[project-path]/[path]];
-      language  := <index-origin-language> ast;
-      index-setup(|language, [project-path], full-path)
+      project-path := <project-path>;
+      index-setup(|language, [project-path], \".\")
     with
-      // Determine the files to compile by looking at changed files.
-      diffs         := <analyze-get-diffs>;
+      // Determine the files to compile by looking at changed files
+      diffs         := <analyze-get-compilediffs>;
       files         := <map(index-compilation-restore-read-file)> diffs;
       filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
       
-      // Clean compile time reads.
+      // Clean compile time reads
       <filter(index-compilation-clean-reads)> filteredFiles;
       
+      // Set total work units to number of files to compile for visual indication
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles;
-      
-      // Clean diffs
-      analyze-clean-diff
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
 
+  /** @internal */
   index-compilation-file(|language, project-path):
-    (file, subfile) -> None()
+    (path, subfile) -> None()
     with
       // Parse and analyze ast.
-      ast                                 := <parse-file> file;
-      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|Compile(), language, file)> (ast, file, project-path)
+      ast                              := <parse-file> path;
+      ast'                             := <try(index-desugar-ast)> ast;
+      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
     with
       {| Index-ReadSet:
         readSet := <new-iset>;
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <index-compile-ast(|file, subfile, project-path)> ast';
+        <index-compile-ast(|path, subfile)> ast'';
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;
-        <index-add-all(|<index-compilation-file-tuple> (file, subfile))> reads
+        <index-add-all(|<index-compilation-file-tuple> (path, subfile))> reads
       |}
 
-  index-compilation-filter-file = 
-    ?(<id>, _); (is-test-file <+ index-is-fake-file <+ not(file-exists))
-
-rules // Compile time reads
-
-  index-compilation-restore-read-file:
-    (file, subfile) -> (file', subfile)
-    with
-      file' := <string-replace(|<index-compilation-read-path>, \"\")> file
-      
-  index-compilation-clean-reads = 
-    ?(file, subfile); index-compilation-file-tuple; index-clear-file
-      
-  index-compilation-file-tuple:
-    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
-    
-  index-compilation-read-path =
-    !\"/.internal/reads/compile\"
-    
-signature constructors // On save handling
-
-  CommitAndCompile : List(UriPart) -> Summary
-  CommitAndCompile : Namespace
+  /** @internal */
+  index-compilation-filter-file:
+    (file, subfile) -> (file, subfile)
+    where
+      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
     
 rules // On save handling
   
+  /**
+   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
+   *
+   * @see trigger-commit-and-compile
+   *
+   * @internal
+   */
   commit-and-compile:
-    (_, path, project-path) -> <id>
+    language -> None()
     with
       index-commit
     with
       index-schedule-compilation
-  
-  index-on-save:
-    (ast, _, _, path, project-path) -> None()
-    with
-      if 0 := <analysis-count> then
-        disable-commit-and-compile;
-        <commit-and-compile> (ast, path, project-path)
-      else
-        enable-commit-and-compile
-      end
-      
-  post-analyze-top(|phase, language, full-path):
-    _ -> <id>
-    with
-      if Editor() := phase then 
-          scheduledAnalyses := <analysis-count>
-      else
-        scheduledAnalyses := -1
-      end
+
+  /**
+   * Triggers commit and compilation, requires target language as current term.
+   * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
+   * enable-commit-and-compile is called.
+   *
+   * @type language -> ?language
+   *
+   * @see enable-commit-and-compile
+   * @see disable-commit-and-compile
+   */
+  trigger-commit-and-compile:
+    language -> <id>
     with
-      if 0 := scheduledAnalyses; check-commit-and-compile then
-        disable-commit-and-compile;
+      if not(index-is-global-enabled(|\"delay-compile\")) then
         commit-and-compile
+      else
+        index-enable-global(|\"trigger-compile\")
       end
-      
-  analysis-count = 
-    prim(\"SSL_EXT_queue_analysis_count\")
-      
+  
+  /**
+   * Delays commit and compilation until enable-commit-and-compile is called.
+   *
+   * @type x -> x
+   *
+   * @see enable-commit-and-compile
+   */
+  disable-commit-and-compile = 
+    index-enable-global(|\"delay-compile\")
+  
+  /**
+   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
+   * is triggered now.
+   *
+   * @type x -> x
+   *
+   * @see disable-commit-and-compile
+   */
   enable-commit-and-compile:
-    _ -> <id>
+    language -> <id>
     with
-      <index-add-all(|<index-commit-and-compile-path>)> [CommitAndCompile([CommitAndCompile(), \".internal\"])]
+      if index-is-global-enabled(|\"trigger-compile\") then
+        commit-and-compile
+      end;
+      index-disable-global(|\"delay-compile\")
       
-  disable-commit-and-compile:
-    _ -> <id>
+/** @internal */
+rules // Compile time reads
+
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
     with
-      <index-clear-file> <index-commit-and-compile-path>
+      file' := <string-replace(|<index-compilation-read-path>, \"\")> file
       
-  check-commit-and-compile:
-    _ -> <id>
-    where
-        <index-get> CommitAndCompile([CommitAndCompile(), \".internal\"])
+  /** @internal */
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
       
-  index-commit-and-compile-path =
-    !\"/.internal/commit-and-compile\"
+  /** @internal */
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  /** @internal */
+  index-compilation-read-path =
+    !\"/.internal/reads/compile\"
 "
\ No newline at end of file

Added: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str	Tue May  8 14:12:06 2012	(r24808)
@@ -0,0 +1,733 @@
+module lib/analysis-library-internal
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library
+  lib/index-library
+  
+signature constructors
+  
+  // Analysis
+  Results         : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
+  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
+  
+  // Namespaces
+  Diff            : Namespace
+  ASTDiff         : Namespace
+  
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
+   */
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
+    with
+      // Init
+      index-setup(|language, [project-path], full-path);
+      revision := <index-start-transaction>
+    with
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
+    with
+      {| Index-UnresolvedSet:
+        unresolvedSet := <new-iset>;
+        rules(Index-UnresolvedSet: _ -> unresolvedSet);
+        
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+        (asts, _) := <unzip> astFilePairs4
+      |}
+    with
+      index-end-transaction
+    with
+      // Schedule re-analysis of dependent files (if current file is not testing language file)
+      // HACK: Depends on file extension, could be other languages with .spt extension?
+      if Editor() := phase; not(<is-test-file> full-path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
+        
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
+        // Store files that have changed in the index
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
+      end
+    with
+      <list-loop(analyze-top-store-ast)> astFilePairs4
+      
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
+    with
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
+      
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Gather all data for each definition.
+        ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|[<index-file-to-string> file, "ast"])> ast
+      
+  /**
+   * Identifies all definitions in the tree and annotates them with their URI.
+   * Also annotates uses with a preliminary "Unresolved(_)" URI.
+   *
+   * @internal
+   */
+  analyze-defs = analyze-defs(|Anon(), Anon())
+  /** @internal */
+  analyze-defs(|head-scope, head-scope-ns):
+    ast -> (ast', defs')
+    with
+      if def := <nam-get-definition> ast then
+        Def(def-path)                     := def;
+        [head-scope-ns', head-scope' | _] := def-path
+      else
+        def-path       := INTERNAL_ERROR();
+        head-scope-ns' := head-scope-ns;
+        head-scope'    := head-scope
+      end;
+      if scope-types := <nam-get-scope-types> ast then
+        {| IndexPath:
+          <list-loop(update-index-path(|head-scope', head-scope-ns', ast))> scope-types;
+          // <balanced-update-path> head-scope';
+          (ast', defs) := <analyze-defs-recurse(|Anon(), Anon(), def-path)> ast
+        |}
+      else
+        (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
+      end;
+      defs' := <![def | defs] <+ !defs>
+      
+  /** @internal */
+  analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
+    ast -> (ast'', defs)
+    where
+      analyzed      := <all(analyze-defs(|head-scope, head-scope-ns))> ast;
+      (ast', defs)  := <unzip-analyzed> analyzed;
+      ast''         := <try(nam-annotate-names(|def-path))> ast'
+ 
+  /** @internal */
+  update-index-path(|head-scope, head-scope-ns, ast):
+    scope-type -> scope-type
+    where
+      if !head-scope-ns => Anon() then
+        path  := <IndexPath <+ ![]> scope-type;
+        path' := <do-adjusted-index-path(|scope-type, path, Anon(<new>))> ast
+      else
+        path  := <IndexPath <+ ![]> head-scope-ns;
+        path' := <do-adjusted-index-path(|scope-type, path, head-scope)> ast
+      end;
+      rules(IndexPath: scope-type -> path')
+ 
+  /* TODO: consider using simple-update-def-path
+   *       which uses "balanced" path scopes
+   *       e.g. when Entity doesn't scope Function
+   *       then it's hard to access properties from a function
+  balanced-update-index-path:
+    head-scope -> head-scope
+    where
+      if !head-scope => Anon() then
+        head-scope' := Anon(<new>)
+      else
+        head-scope' := head-scope
+      end;
+      (something with do-adjust-path)
+      rules(IndexPath := [head-scope' | <IndexPath <+ ![]> ()])
+  */
+ 
+  /**
+   * Analyze all uses, changing their preliminary "Unresolved(_)" URI to a definite URI of their definition.
+   *
+   * @internal
+   */
+  analyze-uses:
+    ast -> (ast'', uses')
+    with
+      analyzed     := <all(analyze-uses)> ast;
+      (ast', uses) := <unzip-analyzed> analyzed;
+      if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
+        if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
+          ast'' := ast{def-uri};
+          uses' := [Use(def-uri) | uses]
+        else
+          ast'' := ast';
+          uses' := [BadUse([namespace, x]) | uses]
+        end
+      else
+        ast'' := ast';
+        uses' := uses
+      end
+ 
+  /**
+   * Collects all index data (e.g. types of definitions).
+   *
+   * @internal
+   */
+  analyze-tree-data:
+    tree -> data
+    where
+      set := <new-iset>;
+      <topdown(analyze-tree-data-part(|set))> tree;
+      data := <iset-elements> set
+      
+  /** @internal */
+  analyze-tree-data-part(|set):
+    tree -> tree
+    where
+      if def-term := <nam-get-definition-key> then
+        _{[namespace | path]} := def-term;
+        if result := <adjust-index-def-data(store-index-data-results(|set) |namespace, path)> tree then
+          <fatal-err(|"Unexpected result from adjust-index-def-data; should call <store-results>")> result
+        end
+      end
+  
+  /** @internal */
+  store-index-data-results(|set):
+    t -> <fail>
+    where
+      if is-list then
+        <iset-addlist(|t)> set
+      else
+        <iset-add(|t)> set
+      end
+      
+rules // Parallel analysis
+  
+  /** @internal */
+  index-parallel-analyze(analyze):
+    files -> allResults
+    with
+      map(index-parse-file); // Parsing cannot be done in parallel.
+      map(\(ast, file) -> (ast, file, <project-path>)\);
+      parallel-unordered(all(index-analyze(analyze)));
+      ?results;
+      with(<eq> (<length> results, <length> files) | "Input size not equal to output size");
+      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
+      if not([] := filesToAnalyze) then
+        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
+      else
+        allResults := results
+      end
+  
+  /** @internal */   
+  index-parse-file:
+    file -> (ast, file)
+    with
+    if <file-exists> file then
+      ast := <parse-file> file
+    else
+      ast := ()
+    end
+   
+  /** @internal */   
+  index-set-markers:
+    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
+    with
+      <set-markers(|ast)> (ast', errors, warnings, notes)
+      
+  /** @internal */
+  index-analyze(analyze):
+    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
+    with
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      if [] := filesToAnalyze then
+        complete-work-unit
+      end
+      
+/** @internal */
+rules // Splitter
+  
+  /** @internal */
+  index-split = fail
+  /** @internal */
+  index-is-toplevel = fail
+  /** @internal */
+  index-is-qualifier = fail
+  /** @internal */
+  index-qualifier-subelements = fail
+  /** @internal */
+  index-create-qualifier(|qualifier) = fail
+  
+  /** @internal */
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  /** @internal */
+  index-toplevel-split-internal:
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, <index-uri> <nam-get-definition-key> node)]
+        otherwise:
+          units := [(node, [])]
+      end
+      
+  /** @internal */
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      qualifier := <index-create-qualifier(|node)> elem
+
+/** @internal */
+rules // Diffs
+  
+  /** @internal */
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+    
+  /** @internal */
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
+    with
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      
+      // Files to analyze
+      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
+      analyzeFiles' := analyzeFiles;
+      // TODO: Is this extra check needed?
+      /*if <getfirst(index-get-file-revision; \r -> (r, revision)\; gt)> analyzeFiles then
+        // Add current file if the current file has read information from another file with a higher revision.
+        // This indicates that potentially outdated information was read.
+        analyzeFiles' := [file|analyzeFiles]
+      else
+        analyzeFiles' := analyzeFiles
+      end;*/
+      
+      // Files to compile
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      <map(analyze-add-compilediff)> compileFiles
+      
+  /** 
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
+   *
+   * @internal
+   */
+  analyze-astdiff:
+    (ast, file) -> file
+    where
+      name := [<index-file-to-string> file, "ast-checksum"];
+      newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-global(|name)> then
+        <index-set-global(|name)> newChecksum;
+        not(<eq> (oldChecksum, newChecksum))
+      else
+        <index-set-global(|name)> newChecksum
+      end
+      
+  /** 
+   * Adds given file to the list of files to compile.
+   *
+   * @internal
+   */
+  analyze-add-compilediff = index-add-global(|"compile-diff")
+  
+  /** 
+   * Gets the list of files to compile, and then clear it.
+   *
+   * @internal
+   */
+  analyze-get-compilediffs = index-get-all-globals(|"compile-diff"); index-clear-global(|"compile-diff")
+  
+rules // Index lookup rules (that take into account adjust-index-lookup)
+  
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> def
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      if <?StopLookup()> candidates then
+        fail
+      else
+        def        := <index-select(|namespace, path, x)>
+      <+
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
+      end
+
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> defs'
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      defs       := <index-select-all(|namespace, path, x)>;
+      // TODO: optimize: try not to call do-adjust-index-lookup from here
+      if [_ | path'] := path then
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
+        defs' := <conc> (defs, defs2)
+      else
+        defs' := defs
+      end
+      
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   * @internal
+   */
+  index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> def
+    where
+      // TODO: optimize: just like index-lookup
+      [_ | path'] := path;
+      def         := <index-lookup-outermost(is-adjust-lookup-enabled |namespace, path', prefix)> x
+    <+
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      def        := <index-select(|namespace, path, x)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
+    x{_} -> defs
+    with
+      is-adjusted-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        defs := StopLookup()
+      else
+        mapconcat(\d at Def(p) -> [d]\
+          <+ \[namespace' | path'] -> <index-lookup-one-level(fail |namespace', path', prefix)> x\
+          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?defs
+      end
+    <+
+      defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
+    x{_} -> all-defs
+    with
+      is-adjust-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        all-defs := []
+      else
+        mapconcat(\d at Def(p) -> [d]\
+            <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
+            <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?all-defs
+      end
+    <+
+      one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
+      if [_ | path'] := path then
+        all-defs := <concat> [one-level, <index-lookup-all-levels(fail |namespace, path', prefix)> x]
+      else
+        all-defs := one-level
+      end
+      
+/** @internal */
+rules // URI and value projections
+       
+  /** @internal */
+  index-uri-impl:
+    Def(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Use(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Read(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
+ 
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
+  index-uri-impl:
+    ReadWildcard(uri, _) -> uri
+
+  /** @internal */
+  index-value-impl:
+    Def(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Use(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Read(value) -> value
+  
+  /** @internal */
+  index-value-impl:
+    ReadWildcard(_, value) -> value
+       
+/** @internal */
+rules // Internal helpers
+
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\(a, _) -> a\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
+       
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+    string-ends-with(|".spt")
+  /** @internal */
+  is-test-language = 
+    ?"Spoofax-Testing"
+  /** @internal */
+  is-test-input(|language, path) = 
+    <is-test-language> language <+ <is-test-file> path
+      
+  /** @internal */
+  fake-file = 
+    is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+    Fst; string-replace(|$[[<project-path>]/], "")
+  
+  /** @internal */
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uriStr))
+    with
+      (<index-uri-to-string> uri <+ !"") => uriStr
+  
+  /** @internal */     
+  index-is-name-substring(|name):
+    template -> <id>
+    with
+      [_, uri-name | _] := <index-uri>
+    where
+      <is-substring(!name)> uri-name
+   
+  /** @internal */    
+  index-readwildcard-substring(|prefix):
+    ReadWildcard(_, name) -> <id>
+    where <is-substring(!prefix)> name
+  
+  /** @internal */  
+  store-wildcard-read(|namespace, path, prefix):
+    children -> <id>
+    with
+      if set := <Index-ReadSet> then
+        if 1 := <length> children then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix))> set
+        end
+      end
+  
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
+  index-file-dependent-construct: 
+    uri -> <conc> (uses, reads)
+    with
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+ 
+  /** @internal */
+  do-adjust-index-lookup(|namespace, path, use, prefix) =
+    repeat-until(
+      prim("SSL_EXT_get_parent", <id>)
+    , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
+    )
+ 
+  /** @internal */
+  index-select(|namespace, path, use) =
+    getfirst(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  index-select-all(|namespace, path, use) =
+    filter(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  do-adjusted-index-path(|namespace, path, def) =
+    adjust-index-path(origin-equal(|def) |namespace, path)
+  <+
+    ![def | path]
+ 
+  /** @internal */
+  index-eq(|namespace, expected) =
+    where(
+      ?Def([_, name | _]);
+      <SRTS-EXT-eq-ignore-annos(|expected)> name
+    )
+  
+  /** @internal */
+  external SRTS-EXT-eq-ignore-annos(|t)
+  
+  /** @internal */
+  index-key-unwrap = 
+    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
+    
+/** @internal */
+rules // Interface for generated code
+ 
+  /** @internal */
+  nam-get-def(|namespace):
+    x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
+  
+  /** @internal */ 
+  nam-annotate-use(|namespace):
+    t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
+  
+  /** @internal */ 
+  nam-get-scope-types = fail
+  /** @internal */
+  nam-get-definition = fail
+  /** @internal */
+  nam-get-definition-key = fail
+  /** @internal */
+  nam-annotate-names(|def-path) = fail
\ No newline at end of file

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 13:03:37 2012	(r24807)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Tue May  8 14:12:06 2012	(r24808)
@@ -4,12 +4,12 @@
   libstratego-lib
   libstratego-parallel
   lib/editor-common.generated
+  lib/analysis-library-internal
   lib/index-library
  
 signature constructors
  
   // Analyze constructors
-  Results     : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
   Editor      : AnalysisPhase
   Compile     : AnalysisPhase
  
@@ -20,17 +20,10 @@
   Read         : List(UriPart) -> Summary
   ReadWildcard : List(UriPart) * String -> Summary
   Diff         : List(UriPart) * List(Summary) -> Summary
-    
-  // Namespaces
-  Diff         : Namespace
-  ASTDiff      : Namespace
   
   // Adjust lookup actions
   StopLookup   : LookupAction
   
-  // Parallel
-  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
-  
 rules // Index analysis extension points
  
   /**
@@ -193,256 +186,6 @@
           <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
       end
   
-  /**
-   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
-   *
-   * @internal
-   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
-   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
-   */
-  analyze-top-internal(|phase, language, project-path, full-path):
-    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
-    with
-      // Init
-      index-setup(|language, [project-path], full-path);
-      revision := <index-start-transaction>
-    with
-      // Store old elements
-      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
-      <index-clear-file> full-path
-    with
-      {| Index-UnresolvedSet:
-        unresolvedSet := <new-iset>;
-        rules(Index-UnresolvedSet: _ -> unresolvedSet);
-        
-        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
-        defs := <concat> defsList;
-        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
-        data := <concat> dataList;
-        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
-        uses := <concat> usesList;
-        (asts, _) := <unzip> astFilePairs4
-      |}
-    with
-      index-end-transaction
-    with
-      // Schedule re-analysis of dependent files (if current file is not testing language file)
-      // HACK: Depends on file extension, could be other languages with .spt extension?
-      if Editor() := phase; not(<is-test-file> full-path) then
-        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
-        
-        // Find added and removed definitions
-        (added, removed) := <analyze-diff> (oldElems, newElems);
-        changed := <conc> (added, removed);
-        
-        // Store files that have changed in the index
-        index-transaction(
-          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
-        )
-      else
-        (added, removed) := ([], []);
-        filesToAnalyze := []
-      end
-    with
-      <list-loop(analyze-top-store-ast)> astFilePairs4
-      
-  /**
-   * Add URI annotations to each definition and unresolved URI annotations to each use site.
-   *
-   * @internal
-   */
-  analyze-top-defs:
-    (ast, file) -> ((ast2, file), defs)
-    with
-      <index-set-current-file> file;
-      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
-      <index-add-all(|file)> defs
-      
-  /**
-   * Gathers all data for each definition.
-   *
-   * @internal
-   */
-  analyze-top-data(|language, full-path):
-    (ast, file) -> ((ast2, file), data2)
-    with
-      <index-set-current-file> file;
-      {| Index-ReadSet:
-        readSet := <new-iset>;
-        rules(Index-ReadSet: _ -> readSet);
-        
-        // Gather all data for each definition.
-        ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
-        data := <origin-track-forced(analyze-tree-data)> ast2;
-        
-        // Resolve all references in gathered data.
-        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
-        <index-add-all(|file)> data2;
-        
-        // Store reads into the index (if not testing language)
-        if not(is-test-input(|language, full-path)) then
-          <index-add-all(|file)> <iset-elements> readSet
-        end
-      |}
-      
-  /**
-   * Resolves all unresolved references for each use site.
-   *
-   * @internal
-   */
-  analyze-top-uses(|language, full-path):
-    (ast, file) -> ((ast3, file), uses)
-    with
-      <index-set-current-file> file;
-      {| Index-ReadSet:
-        readSet := <new-iset>;
-        rules(Index-ReadSet: _ -> readSet);
-        
-        // Resolve all unresolved references for each use site.
-        (ast2, uses) := <analyze-uses> ast;
-        <index-add-all(|file)> uses;
-        
-        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
-        
-        // Store reads into the index (if not testing language)
-        if not(is-test-input(|language, full-path)) then
-          <index-add-all(|file)> <iset-elements> readSet
-        end
-      |}
-      
-  /**
-   * Stores AST from file to the index.
-   *
-   * @internal
-   */   
-  analyze-top-store-ast:
-    (ast, file) -> <id>
-    with
-      <index-set-global(|[<index-file-to-string> file, "ast"])> ast
-      
-  /**
-   * Identifies all definitions in the tree and annotates them with their URI.
-   * Also annotates uses with a preliminary "Unresolved(_)" URI.
-   *
-   * @internal
-   */
-  analyze-defs = analyze-defs(|Anon(), Anon())
-  /** @internal */
-  analyze-defs(|head-scope, head-scope-ns):
-    ast -> (ast', defs')
-    with
-      if def := <nam-get-definition> ast then
-        Def(def-path)                     := def;
-        [head-scope-ns', head-scope' | _] := def-path
-      else
-        def-path       := INTERNAL_ERROR();
-        head-scope-ns' := head-scope-ns;
-        head-scope'    := head-scope
-      end;
-      if scope-types := <nam-get-scope-types> ast then
-        {| IndexPath:
-          <list-loop(update-index-path(|head-scope', head-scope-ns', ast))> scope-types;
-          // <balanced-update-path> head-scope';
-          (ast', defs) := <analyze-defs-recurse(|Anon(), Anon(), def-path)> ast
-        |}
-      else
-        (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
-      end;
-      defs' := <![def | defs] <+ !defs>
-      
-  /** @internal */
-  analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
-    ast -> (ast'', defs)
-    where
-      analyzed      := <all(analyze-defs(|head-scope, head-scope-ns))> ast;
-      (ast', defs)  := <unzip-analyzed> analyzed;
-      ast''         := <try(nam-annotate-names(|def-path))> ast'
- 
-  /** @internal */
-  update-index-path(|head-scope, head-scope-ns, ast):
-    scope-type -> scope-type
-    where
-      if !head-scope-ns => Anon() then
-        path  := <IndexPath <+ ![]> scope-type;
-        path' := <do-adjusted-index-path(|scope-type, path, Anon(<new>))> ast
-      else
-        path  := <IndexPath <+ ![]> head-scope-ns;
-        path' := <do-adjusted-index-path(|scope-type, path, head-scope)> ast
-      end;
-      rules(IndexPath: scope-type -> path')
- 
-  /* TODO: consider using simple-update-def-path
-   *       which uses "balanced" path scopes
-   *       e.g. when Entity doesn't scope Function
-   *       then it's hard to access properties from a function
-  balanced-update-index-path:
-    head-scope -> head-scope
-    where
-      if !head-scope => Anon() then
-        head-scope' := Anon(<new>)
-      else
-        head-scope' := head-scope
-      end;
-      (something with do-adjust-path)
-      rules(IndexPath := [head-scope' | <IndexPath <+ ![]> ()])
-  */
- 
-  /**
-   * Analyze all uses, changing their preliminary "Unresolved(_)" URI to a definite URI of their definition.
-   *
-   * @internal
-   */
-  analyze-uses:
-    ast -> (ast'', uses')
-    with
-      analyzed     := <all(analyze-uses)> ast;
-      (ast', uses) := <unzip-analyzed> analyzed;
-      if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
-        if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
-          ast'' := ast{def-uri};
-          uses' := [Use(def-uri) | uses]
-        else
-          ast'' := ast';
-          uses' := [BadUse([namespace, x]) | uses]
-        end
-      else
-        ast'' := ast';
-        uses' := uses
-      end
- 
-  /**
-   * Collects all index data (e.g. types of definitions).
-   *
-   * @internal
-   */
-  analyze-tree-data:
-    tree -> data
-    where
-      set := <new-iset>;
-      <topdown(analyze-tree-data-part(|set))> tree;
-      data := <iset-elements> set
-      
-  /** @internal */
-  analyze-tree-data-part(|set):
-    tree -> tree
-    where
-      if def-term := <nam-get-definition-key> then
-        _{[namespace | path]} := def-term;
-        if result := <adjust-index-def-data(store-index-data-results(|set) |namespace, path)> tree then
-          <fatal-err(|"Unexpected result from adjust-index-def-data; should call <store-results>")> result
-        end
-      end
-  
-  /** @internal */
-  store-index-data-results(|set):
-    t -> <fail>
-    where
-      if is-list then
-        <iset-addlist(|t)> set
-      else
-        <iset-add(|t)> set
-      end
-  
 rules // Parallel analysis
   
   /**
@@ -465,159 +208,8 @@
     with
       index-parallel-analyze(analyze);
       filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
-  
-  /** @internal */
-  index-parallel-analyze(analyze):
-    files -> allResults
-    with
-      map(index-parse-file); // Parsing cannot be done in parallel.
-      map(\(ast, file) -> (ast, file, <project-path>)\);
-      parallel-unordered(all(index-analyze(analyze)));
-      ?results;
-      with(<eq> (<length> results, <length> files) | "Input size not equal to output size");
-      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
-      if not([] := filesToAnalyze) then
-        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
-      else
-        allResults := results
-      end
-  
-  /** @internal */   
-  index-parse-file:
-    file -> (ast, file)
-    with
-    if <file-exists> file then
-      ast := <parse-file> file
-    else
-      ast := ()
-    end
-   
-  /** @internal */   
-  index-set-markers:
-    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
-    with
-      <set-markers(|ast)> (ast', errors, warnings, notes)
-      
-  /** @internal */
-  index-analyze(analyze):
-    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
-    with
-      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
-      if [] := filesToAnalyze then
-        complete-work-unit
-      end
-      
-/** @internal */
-rules // Splitter
-  
-  /** @internal */
-  index-split = fail
-  /** @internal */
-  index-is-toplevel = fail
-  /** @internal */
-  index-is-qualifier = fail
-  /** @internal */
-  index-qualifier-subelements = fail
-  /** @internal */
-  index-create-qualifier(|qualifier) = fail
-  
-  /** @internal */
-  index-toplevel-split:
-    ast -> asts'
-    with
-      (ast', _) := <analyze-defs> ast;
-      asts      := <index-toplevel-split-internal> ast';
-      asts'     := <strip-annos> asts
-      
-  /** @internal */
-  index-toplevel-split-internal:
-    node -> units
-    with
-      switch id
-        case ?():
-          units := [((), [])]
-        case index-is-qualifier:
-          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
-          units := <map(index-transform-qualifier(|node))> elems
-        case index-is-toplevel:
-          units := [(node, <index-uri> <nam-get-definition-key> node)]
-        otherwise:
-          units := [(node, [])]
-      end
-      
-  /** @internal */
-  index-transform-qualifier(|node):
-    (elem, subfileName) -> (qualifier, subfileName)
-    with
-      qualifier := <index-create-qualifier(|node)> elem
-
-/** @internal */
-rules // Diffs
-  
-  /** @internal */
-  analyze-diff:
-    (defs1, defs2) -> (added, removed)
-    with
-      added   := <diff(index-diff-compare)> (defs2, defs1);
-      removed := <diff(index-diff-compare)> (defs1, defs2)
-    
-  /** @internal */
-  analyze-store-diff(|changedEntries, revision): 
-    astFilePairs -> analyzeFiles'
-    with
-      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
-      dependentFiles  := <index-get-dependent-files> changedEntries;
-      
-      // Files to analyze
-      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
-      analyzeFiles' := analyzeFiles;
-      // TODO: Is this extra check needed?
-      /*if <getfirst(index-get-file-revision; \r -> (r, revision)\; gt)> analyzeFiles then
-        // Add current file if the current file has read information from another file with a higher revision.
-        // This indicates that potentially outdated information was read.
-        analyzeFiles' := [file|analyzeFiles]
-      else
-        analyzeFiles' := analyzeFiles
-      end;*/
-      
-      // Files to compile
-      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
-      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
-      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
-      <map(analyze-add-compilediff)> compileFiles
-      
-  /** 
-   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
-   *
-   * @internal
-   */
-  analyze-astdiff:
-    (ast, file) -> file
-    where
-      name := [<index-file-to-string> file, "ast-checksum"];
-      newChecksum := <checksum> ast;
-      if oldChecksum := <index-get-global(|name)> then
-        <index-set-global(|name)> newChecksum;
-        not(<eq> (oldChecksum, newChecksum))
-      else
-        <index-set-global(|name)> newChecksum
-      end
-      
-  /** 
-   * Adds given file to the list of files to compile.
-   *
-   * @internal
-   */
-  analyze-add-compilediff = index-add-global(|"compile-diff")
-  
-  /** 
-   * Gets the list of files to compile, and then clear it.
-   *
-   * @internal
-   */
-  analyze-get-compilediffs = index-get-all-globals(|"compile-diff"); index-clear-global(|"compile-diff")
  
-rules // index API query primitives
+rules // Query primitives
  
   /**
    * Gets all DefData entries that match the kind of data and URI in given definition.
@@ -824,7 +416,7 @@
   index-get-dependent-files = 
     index-get-referenced-files(index-file-dependent-construct)
      
-rules // Index lookup rules (take into account adjust-index-lookup)
+rules // Index lookup rules (that take into account adjust-index-lookup)
  
   /**
    * Given an annotated AST node, resolves it, returning its Def.
@@ -843,49 +435,6 @@
     x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
-   * Given an annotated AST node, resolves it, returning all its Defs.
-   *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   *
-   * @internal
-   * @type "name"{uri} -> ?Def(uri')
-   */
-  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
-    x -> def
-    where
-      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
-      if <?StopLookup()> candidates then
-        fail
-      else
-        def        := <index-select(|namespace, path, x)>
-      <+
-        // TODO: optimize: try not to call do-adjust-index-lookup from here
-        [_ | path'] := path;
-        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
-      end
-
-  /**
-   * Given an annotated AST node, resolves it, returning all its Defs.
-   *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   *
-   * @type "name"{uri} -> List(Def(uri'))
-   * @internal
-   */
-  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
-    x -> defs'
-    where
-      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
-      defs       := <index-select-all(|namespace, path, x)>;
-      // TODO: optimize: try not to call do-adjust-index-lookup from here
-      if [_ | path'] := path then
-        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
-        defs' := <conc> (defs, defs2)
-      else
-        defs' := defs
-      end
- 
-  /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
    * @param prefix  Only Defs with a name that starts with this string are returned.
@@ -895,24 +444,6 @@
     x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
-   *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   *
-   * @type "name"{uri} -> ?Def(uri')
-   * @internal
-   */
-  index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
-    x -> def
-    where
-      // TODO: optimize: just like index-lookup
-      [_ | path'] := path;
-      def         := <index-lookup-outermost(is-adjust-lookup-enabled |namespace, path', prefix)> x
-    <+
-      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
-      def        := <index-select(|namespace, path, x)>
- 
-  /**
    * Given an annotated AST node, returns Defs that have the same parent URI.
    *
    * @param prefix  Only Defs with a name that starts with this string are returned.
@@ -920,31 +451,6 @@
    */
   index-lookup-one-level(|prefix):
     x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
- 
-  /**
-   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
-   *
-   * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Only Defs with a name that starts with this string are returned.
-   *
-   * @type "name"{uri} -> List(Def(uri'))
-   * @internal
-   */
-  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
-    x{_} -> defs
-    with
-      is-adjusted-lookup-enabled;
-      do-adjust-index-lookup(|namespace, path, x, prefix);
-      if ?StopLookup() then
-        defs := StopLookup()
-      else
-        mapconcat(\d at Def(p) -> [d]\
-          <+ \[namespace' | path'] -> <index-lookup-one-level(fail |namespace', path', prefix)> x\
-          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
-        ?defs
-      end
-    <+
-      defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
       
   /**
    * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
@@ -957,35 +463,6 @@
     x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
-   *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   *
-   * @internal
-   * @type "name"{uri} -> List(Def(uri'))
-   */
-  index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
-    x{_} -> all-defs
-    with
-      is-adjust-lookup-enabled;
-      do-adjust-index-lookup(|namespace, path, x, prefix);
-      if ?StopLookup() then
-        all-defs := []
-      else
-        mapconcat(\d at Def(p) -> [d]\
-            <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
-            <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
-        ?all-defs
-      end
-    <+
-      one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
-      if [_ | path'] := path then
-        all-defs := <concat> [one-level, <index-lookup-all-levels(fail |namespace, path', prefix)> x]
-      else
-        all-defs := one-level
-      end
- 
-  /**
    * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
    *
    * @param namespace Only child Defs with this namespace are returned.
@@ -1084,197 +561,4 @@
     (k1, k2) -> <id>
     where
       <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
-       
-/** @internal */
-rules // URI and value projections
-       
-  /** @internal */
-  index-uri-impl:
-    Def(uri) -> uri
-    
-  /** @internal */  
-  index-uri-impl:
-    Use(uri) -> uri
-    
-  /** @internal */  
-  index-uri-impl:
-    Read(uri) -> uri
-    
-  /** @internal */  
-  index-uri-impl:
-    x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
- 
-  /**
-   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
-   * 
-   * @internal 
-   */
-  index-uri-impl:
-    ReadWildcard(uri, _) -> uri
-
-  /** @internal */
-  index-value-impl:
-    Def(value) -> value
-
-  /** @internal */
-  index-value-impl:
-    Use(value) -> value
-
-  /** @internal */
-  index-value-impl:
-    Read(value) -> value
-  
-  /** @internal */
-  index-value-impl:
-    ReadWildcard(_, value) -> value
-       
-/** @internal */
-rules // Internal helpers
-
-  /**
-   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
-   *
-   * @internal
-   */
-  unzip-analyzed:
-    appl -> (appl', unzipped-parts)
-    with
-      appl'          := <all(\(a, _) -> a\)> appl;
-      unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
-       
-  /**
-   * Tests if the current file is just a testing language input
-   *
-   * @internal
-   */
-  is-test-file = 
-    string-ends-with(|".spt")
-  /** @internal */
-  is-test-language = 
-    ?"Spoofax-Testing"
-  /** @internal */
-  is-test-input(|language, path) = 
-    <is-test-language> language <+ <is-test-file> path
-      
-  /** @internal */
-  fake-file = 
-    is-test-file <+ index-is-fake-file
-  
-  /** @internal */    
-  index-filepair-to-file = 
-    Fst; string-replace(|$[[<project-path>]/], "")
-  
-  /** @internal */
-  ast-uri-to-ast-file(|full-path):
-    (ast, uri) -> (ast, (full-path, uriStr))
-    with
-      (<index-uri-to-string> uri <+ !"") => uriStr
-  
-  /** @internal */     
-  index-is-name-substring(|name):
-    template -> <id>
-    with
-      [_, uri-name | _] := <index-uri>
-    where
-      <is-substring(!name)> uri-name
-   
-  /** @internal */    
-  index-readwildcard-substring(|prefix):
-    ReadWildcard(_, name) -> <id>
-    where <is-substring(!prefix)> name
-  
-  /** @internal */  
-  store-wildcard-read(|namespace, path, prefix):
-    children -> <id>
-    with
-      if set := <Index-ReadSet> then
-        if 1 := <length> children then
-          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
-          // be handled in the index primitives instead.
-          <iset-add(|Read([namespace | path]))> set
-        else
-          <iset-add(|ReadWildcard([namespace | path], prefix))> set
-        end
-      end
-  
-  /** @internal */    
-  index-is-unresolved(|x, uri) = 
-    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
-  /** @internal */
-  index-add-unresolved(|x, uri) = 
-    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
-  
-  /** @internal */
-  index-file-dependent-construct: 
-    uri -> <conc> (uses, reads)
-    with
-      uses := <index-get-uses-all> Def(uri);
-      reads := <index-get-reads-all> Def(uri)
-  
-  /** @internal */  
-  index-file-dependency-filter = 
-    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
- 
-  /** @internal */
-  do-adjust-index-lookup(|namespace, path, use, prefix) =
-    repeat-until(
-      prim("SSL_EXT_get_parent", <id>)
-    , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
-    )
- 
-  /** @internal */
-  index-select(|namespace, path, use) =
-    getfirst(
-      where(
-        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
-      )
-    )
- 
-  /** @internal */
-  index-select-all(|namespace, path, use) =
-    filter(
-      where(
-        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
-      )
-    )
- 
-  /** @internal */
-  do-adjusted-index-path(|namespace, path, def) =
-    adjust-index-path(origin-equal(|def) |namespace, path)
-  <+
-    ![def | path]
- 
-  /** @internal */
-  index-eq(|namespace, expected) =
-    where(
-      ?Def([_, name | _]);
-      <SRTS-EXT-eq-ignore-annos(|expected)> name
-    )
-  
-  /** @internal */
-  external SRTS-EXT-eq-ignore-annos(|t)
-  
-  /** @internal */
-  index-key-unwrap = 
-    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
-
-/** @internal */
-rules // Interface for generated code
- 
-  /** @internal */
-  nam-get-def(|namespace):
-    x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
-  
-  /** @internal */ 
-  nam-annotate-use(|namespace):
-    t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
-  
-  /** @internal */ 
-  nam-get-scope-types = fail
-  /** @internal */
-  nam-get-definition = fail
-  /** @internal */
-  nam-get-definition-key = fail
-  /** @internal */
-  nam-annotate-names(|def-path) = fail
-  
\ No newline at end of file
+      
\ No newline at end of file

From gabrielkonat at gmail.com  Tue May  8 16:14:16 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 14:14:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24809 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <20120508141416.280897F8009@mx1.tudelft.nl>

Author: gkonat
Date: Tue May  8 14:14:15 2012
New Revision: 24809
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24809&sc=1

Log:
Revert generated files.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May  8 14:12:06 2012	(r24808)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May  8 14:14:15 2012	(r24809)
@@ -6,11 +6,11 @@
 strategies
 
   create-analysis-auto-placeholder = 
-  	<file-exists> "lib/analysis-auto.generated.str"
+    <file-exists> "lib/analysis-auto.generated.str"
   <+
-  	try(<file-exists <+ mkdir> "lib");
-  	sdf-name := <get-sdf-main-module>;
-	<output-text-file(|["lib"], "analysis-auto.generated.str")>
+    try(<file-exists <+ mkdir> "lib");
+    sdf-name := <get-sdf-main-module>;
+  <output-text-file(|["lib"], "analysis-auto.generated.str")>
 <conc-strings> ("module lib/analysis-auto.generated
 
 signature
@@ -67,11 +67,11 @@
 
   nam-annotate-use(|n) =
     fail
-")	
+")  
 
   create-index-library =
-	try(<file-exists <+ mkdir> "lib");
-	<output-text-file(|["lib"], "index-library.generated.str")>
+  try(<file-exists <+ mkdir> "lib");
+  <output-text-file(|["lib"], "index-library.generated.str")>
 "module lib/index-library.generated
 
 imports
@@ -96,67 +96,18 @@
   
   FileEntries : Term * Term -> Term
   
-  // Globals
-  Global : Namespace
-  Global : List(UriPart) -> Summary
-  Global : List(UriPart) * List(Summary) -> Summary
-  
 rules // Index management
    
-  /**
-   * Sets up the index library for given language and project paths.
-   * Must be called once before doing anything with the library.
-   *
-   * @param language      The language to set the index up for.
-   * @param project-path  The project paths that contain all source files to analyse and compile.
-   *
-   * @obsolete
-   * @type x -> x
-   */
   index-setup(|language, project-paths) =
     obsolete(!\"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)\");
     index-setup(|language, project-paths, \".\")
     
   /**
-   * Sets up the index library for given language, project paths and current file.
+   * Sets up the index library for given language and project paths.
    * Must be called once before doing anything with the library.
-   *
-   * Example:
-   *   <index-setup(|\"MiniJava\", [<project-path>], \"test/test.mjv\")
-   *
-   * @param language      The language to set the index up for.
-   * @param project-path  The project paths that contain all source files to analyse and compile.
-   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
-   *                      Can also be changed later using index-set-current-file.
-   * @type x -> x
    */
   index-setup(|language, project-paths, current-file) =
     prim(\"LANG_index_setup\", language, project-paths, current-file)
-    
-  /**
-   * Sets the current file the index (analysis) is operating on to the given file.
-   *
-   * Example:
-   *   <index-set-current-file> \"fullpath/file.ext\"
-   *   <index-set-current-file> (\"fullpath/file.ext\", \"subfile\")
-   *
-   * @type x -> ?x
-   */
-  index-set-current-file = 
-    prim(\"LANG_index_set_current_file\", <id>)
-
-  /**
-   * Adds given element to the index with given file path and optionally subfile.
-   *
-   * Example:
-   *   <index-add(|\"fullpath/file.ext\")> Def([Entity(), \"Bar\"])
-   *   <index-add(|(\"fullpath/file.ext\", \"subfile\"))> Def([Entity(), \"Bar\"])
-   *
-   * @param file  The file (and subfile) to add the element to.
-   * @type x -> ?x
-   */
-  index-add(|file) =
-    prim(\"LANG_index_add\", <id>, file)
 
   /**
    * Adds all given elements to the index with given file path and optionally subfile.
@@ -164,25 +115,9 @@
    * Example:
    *   <index-add-all(|\"fullpath/file.ext\")> [Def([Entity(), \"Bar\"]), ...]
    *   <index-add-all(|(\"fullpath/file.ext\", \"subfile\"))> [Def([Entity(), \"Bar\"]), ...]
-   *
-   * @param file  The file (and subfile) to add the elements to.
-   * @type List(x) -> ?List(x)
    */
   index-add-all(|file) =
-    list-loop(with(index-add(|file)))
-    
-  /**
-   * Removes given element from the index that is contained in given file path and optionally subfile.
-   *
-   * Example:
-   *   <index-remove(|\"fullpath/file.ext\")> Def([Entity(), \"Bar\"])
-   *   <index-remove(|(\"fullpath/file.ext\", \"subfile\"))> Def([Entity(), \"Bar\"])
-   * 
-   * @param file  The file (and subfile) to remove the element from.
-   * @type x -> ?x
-   */
-  index-remove(|file) =
-    prim(\"LANG_index_remove\", <id>, file)
+    list-loop(with(prim(\"LANG_index_add\", <id>, file)))
     
   /**
    * Removes all given elements from the index that are contained in given file path and optionally subfile.
@@ -190,12 +125,9 @@
    * Example:
    *   <index-remove-all(|\"fullpath/file.ext\")> [Def([Entity(), \"Bar\"]), ...]
    *   <index-remove-all(|(\"fullpath/file.ext\", \"subfile\"))> [Def([Entity(), \"Bar\"]), ...]
-   *
-   * @param file  The file (and subfile) to remove the elements from.
-   * @type List(x) -> ?List(x)
    */
-  index-remove-all(|file) =
-    list-loop(with(index-remove(|file)))
+  index-remove-all(|files) =
+    list-loop(with(prim(\"LANG_index_remove\", <id>, files)))
     
   /**
    * Removes all elements from the index that are contained in given file path and optionally subfile.
@@ -203,80 +135,38 @@
    * Example:
    *   <index-clear-file> \"fullpath/file.ext\"
    *   <index-clear-file> (\"fullpath/file.ext\", \"subfile\")
-   *
-   * @type x -> ?x
    */
   index-clear-file = 
     prim(\"LANG_index_clear_file\", <id>)
     
   /**
    * Clears all elements from the index.
-   *
-   * @type x -> x
    */
   index-clear = 
     prim(\"LANG_index_clear_all\")
    
   /**
    * Commits index to a file on disk.
-   *
-   * @type x -> x
    */
   index-commit = 
-    prim(\"LANG_index_commit\")
-
-  /**
-   * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
-   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
-   *
-   * @type x -> x
-   */
-  index-start-transaction = 
-    prim(\"LANG_index_start_transaction\")
-  
-  /**
-   * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
-   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
-   * this call.
-   *
-   * @type x -> x
-   */
-  index-end-transaction = 
-    prim(\"LANG_index_end_transaction\")
-  
-  /**
-   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
-   * strategy are thread safe.
-   * 
-   * @param s The strategy to apply.
-   * @type x -> x'
-   *
-   * @see index-start-transaction
-   * @see index-end-transaction
-   */
-  index-transaction(s) = 
-    prim(\"LANG_index_start_transaction\"); s; prim(\"LANG_index_end_transaction\")
+    if not(index-timestamp-get-updates(|\"LANG_index_commit\") => []) then
+      prim(\"LANG_index_commit\");
+      index-timestamp-set-updated(|\"LANG_index_commit\")
+    end
   
-rules // Index querying
+rules // Index API
   
   /**
    * Gets the file that the analysis is currently in.
-   *
-   * @type x -> (file, subfile)
-   *
-   * @see index-setup(|language, project-paths, current-file)
-   * @see index-set-current-file
    */
   index-get-current-file =
     prim(\"LANG_index_get_current_file\")
   
   /**
-   * Gets a list of all files and subfiles for current project.
+   * Gets a list of all files and subfile for current project.
    *
    * Example:
-   *   <index-get-all-files> => [(\"fullpath/file.ext\", \"subfile\"), ...]
-   *
-   * @type x -> List((file, subfile))
+   *   <index-get-all-files> => [\"fullpath/file.ext\", ...]
    */   
   index-get-all-files =
     prim(\"LANG_index_all_files\")
@@ -287,8 +177,6 @@
    * Examples:
    *   <index-get-all-in-file> \"fullpath/file.ext\" => [Def([Entity(), \"Bar\"]), ...]
    *   <index-get-all-in-file> (\"fullpath/file.ext\", \"subfile\") => [Def([Entity(), \"Bar\"]), ...]
-   *
-   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file:
     filepath -> entries
@@ -296,14 +184,10 @@
       entries := <prim(\"LANG_index_get_all_in_file\", filepath)>
    
   /**
-   * Gets index entries in some namespace for the given file path and optionally subfile.
+   * Gets all index entries for the given file path and optionally subfile.
    *
    * Example:
    *   <index-get-all-in-file(|Import())> \"fullpath/file.ext\" => [Def([Import(), \"Bar\"]), ...]
-   *   <index-get-all-in-file(|Import())> (\"fullpath/file.ext\", \"subfile\") => [Def([Import(), \"Bar\"]), ...]
-   *
-   * @param namespace Only index entries from this namespace are retrieved.
-   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file(|namespace):
     filepath -> entries
@@ -313,35 +197,29 @@
       filter(where(index-uri => [namespace | _]))
     
   /**
-   * Gets the revision of a file and optionally subfile.
-   *
-   * Example:
-   *   <index-get-file-revision> \"fullpath/file.ext\" => 13
-   *   <index-get-file-revision> (\"fullpath/file.ext\", \"subfile\") => 37
-   *
-   * @type file or (file, subfile) -> Int
-   */
-  index-get-file-revision:
-    file -> <prim(\"LANG_index_get_file_revision\", file)>
-    
-  /**
    * Gets the containing files and subfiles of index entry with given template.
    *
    * Example:
    *   <index-get-files-of> Def([Entity(), \"Bar\"]) => [(\"fullpath/file.ext\", \"subfile\"), ...]
-   *
-   * @type template -> List((file, subfile))
    */  
   index-get-files-of:
     template -> <prim(\"LANG_index_get_files_of\", template)>
     
   /**
+   * Gets all index entries (of every file for current project).
+   *
+   * Example:
+   *   <indexlib-get-all-elements> => [Def([Entity(), \"Bar\"]), ...]
+   */
+  indexlib-get-all-elements =
+    // TODO: is there a use case for this? doing this is *expensive*
+    <mapconcat(index-get-all-in-file)> <index-get-all-files>
+    
+  /**
    * Get all index entries that match the given template.
    *
    * Example:
    *   <indexlib-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
-   *
-   * @type template -> List(elem)
    */
   indexlib-get-all:
     template -> <prim(\"LANG_index_get\", template)>
@@ -349,12 +227,10 @@
   /**
    * Get all values of index entries that match the given template.
    *
+   * @see index-value
+   *
    * Example:
    *   <indexlib-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
-   *
-   * @type template -> List(value)
-   *
-   * @see index-value
    */
   indexlib-get-all-values:
     template -> <map(index-value)> <indexlib-get-all> template
@@ -364,8 +240,6 @@
    *
    * Example:
    *   <indexlib-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
-   *
-   * @type template -> ?elem
    */
   indexlib-get:
     template -> <?[<id>|_]> <indexlib-get-all> template
@@ -373,252 +247,43 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
+   * @see index-value
+   *
    * Example:
    *   <indexlib-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
-   *
-   * @type template -> ?value
-   *
-   * @see index-value
    */
   indexlib-get-value:
     template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
-    
-rules // Index globals
-    
-  /**
-   * Gets the 'fake' path where globals are stored in the index.
-   *
-   * @internal
-   */
-  index-globals-path = 
-    !\"/.internal/globals\"
-    
-  /**
-   * Gets the URI where globals are stored in the index for given name or names.
-   *
-   * @internal
-   * @type name or List(name) -> uri
-   */
-  index-globals-uri:
-    names -> uri
-    with
-      if is-list then
-        uri := <concat> [[Global()], names, [\"globals\", \".internal\"]]
-      else
-        uri := [Global(), names, \"global\", \".internal\"]
-      end
-    
+ 
   /**
-   * Gets the first value in global storage with given name, or fail.
+   * Updates the \"last updated\" timestamp for the given service name.
    *
-   * Example:
-   *   index-get-global(|\"last-compile\") => Timestamp(1334322856)
-   *   index-get-global(|[\"last-compile\", \"file.str\"]) => Timestamp(1334322856)
-   * 
-   * @param name  The name or list of names to identify the global value.
-   * @type _ -> ?value
+   * @see index-get-changes-since-timestamp(|service)
    */
-  index-get-global(|name):
-    _ -> value
-    where
-      value := <indexlib-get-value> Global(<index-globals-uri> name, ())
-    
-  /**
-   * Gets all values in global storage with given name.
-   *
-   * Example:
-   *   index-get-global(|\"last-compile\") => [Timestamp(1334322856), ...]
-   *   index-get-global(|[\"last-compile\", \"file.str\"]) => [Timestamp(1334322856), ...]
-   *
-   * @param name  The name or list of names to identify the global value.
-   * @type _ -> List(value)
-   */ 
-  index-get-all-globals(|name):
-    _ -> values
-    with
-      values := <indexlib-get-all-values> Global(<index-globals-uri> name, ())
-    
-  /**
-   * Add value to global storage with given name.
-   *
-   * Example:
-   *   <index-add-global(|\"last-compile\")> Timestamp(1334322856)
-   *   <index-add-global(|[\"last-compile\", \"file.str\"])> Timestamp(1334322856)
-   *
-   * @param name  The name or list of names to identify the global value.
-   * @type x -> x
-   */   
-  index-add-global(|name):
-    value -> <id>
-    with
-      <index-add(|<index-globals-path>)> Global(<index-globals-uri> name, value)
-      
-  /**
-   * Overwrites value in global storage with given value.
-   *
-   * Example:
-   *   <index-set-global(|\"last-compile\")> Timestamp(1334322856)
-   *   <index-set-global(|[\"last-compile\", \"file.str\"])> Timestamp(1334322856)
-   *
-   * @param name  The name or list of names to identify the global value.
-   * @type x -> x
-   */   
-  index-set-global(|name):
-    value -> <id>
-    with
-      index-clear-global(|name);
-      <index-add-global(|name)> value
-    
-  /**
-   * Removes all values from global storage with given name.
-   *
-   * Example:
-   *   index-clear-global(|\"last-compile\")
-   *   index-clear-global(|[\"last-compile\", \"file.str\"])
-   *
-   * @param name  The name or list of names to identify the global value.
-   * @type x -> x
-   */   
-  index-clear-global(|name):
-    _ -> <id>
-    with
-      <index-remove(|<index-globals-path>)> Global(<index-globals-uri> name, ())
-      
+  index-timestamp-set-updated(|service) =
+    file := $[/.internal/timestamps/[service]];
+    <index-clear-file> file;
+    prim(\"LANG_index_add\", DefData([Timestamp(), \"timestamps\", \".internal\"], Timestamp(), []), file)
+   
   /**
-   * Gets the URI where boolean globals are stored in the index for given name or names.
-   *
-   * @internal
+   * Gets all files with changes since the last time stamp update for the given service name.
    */
-  index-boolean-globals-uri:
-    names -> uri
-    with
-      if is-list then
-        uri := <concat> [[Global()], names, [\"boolean\", \"globals\", \".internal\"]]
-      else
-        uri := [Global(), names, \"boolean\", \"global\", \".internal\"]
-      end
-      
-  /**
-   * Sets boolean value true to global boolean storage with given name.
-   *
-   * Example:
-   *   index-enable-global(|\"can-compile\")
-   *   index-enable-global(|[\"can-compile\", \"file.str\"])
-   *
-   * @param name  The name or list of names to identify the global boolean value.
-   * @type x -> x
-   */   
-  index-enable-global(|name):
-    _ -> <id>
-    with
-      <index-add(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
-      
-  /**
-   * Sets boolean value false to global boolean storage with given name.
-   *
-   * Example:
-   *   index-disable-global(|\"can-compile\")
-   *   index-disable-global(|[\"can-compile\", \"file.str\"])
-   *
-   * @param name  The name or list of names to identify the global boolean value.
-   * @type x -> x
-   */   
-  index-disable-global(|name):
-    _ -> <id>
+  index-timestamp-get-updates(|service):
+    _ -> files'
     with
-      <index-remove(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
-      
-  /**
-   * Query for boolean value true in global boolean storage with given name.
-   *
-   * Example:
-   *   index-is-global-enabled(|\"can-compile\")
-   *   index-is-global-enabled(|[\"can-compile\", \"file.str\"])
-   *
-   * @param name  The name or list of names to identify the global boolean value.
-   * @type x -> ?x
-   */   
-  index-is-global-enabled(|name):
-    _ -> <id>
-    where
-      <indexlib-get> Global(<index-boolean-globals-uri> name)
+      timestampName := $[/.internal/timestamps/[service]];
+      files := <prim(\"LANG_index_get_files_newer_than\", timestampName)>;
+      files' := <remove-all(?(timestampName, _))> files
 
-rules // Index utility
-  
   /**
-   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
-   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
-   * given term.
-   *
-   * Example:
-   *   <index-uri> DefData([Entity(), \"Bar\", \"Baz\"], Type(), TYPE(\"Bar\")) => [Entity(), \"Bar\", \"Baz\"]
-   *
-   * @type elem -> ?uri
-   *
-   * @see index-uri-impl
-   * @see index-uri-generic
-   */ 
-  index-uri = 
-    index-uri-impl <+ index-uri-generic
-  
-  /**
-   * Gets the namespace part of the given URI.
-   *
-   * Example:
-   *   <index-uri-path> [Entity(), \"Bar\", \"Baz\"] => Entity()
-   *
-   * @type uri@[namespace|path] -> namespace
-   */ 
-  index-uri-namespace =
-    ?[<id>|_]
-  
-  /**
-   * Gets the path part of the given URI.
-   *
-   * Example:
-   *   <index-uri-path> [Entity(), \"Bar\", \"Baz\"] => [\"Bar\", \"Baz\"]
-   *   <index-uri-path> [Entity()] => []
-   *
-   * @type uri@[namespace|path] -> path
-   */ 
-  index-uri-path =
-    ?[_|<id>]
+   * Queries if given index file is a 'fake' file for storing internal data.
+   */
+  index-is-fake-file = string-starts-with(|\"/.internal\")
     
   /**
-   * Gets the name part of the given URI or fail if there is no name.
-   *
-   * Example:
-   *   <index-uri-name> [Entity(), \"Bar\", \"Baz\"] => \"Bar\"
-   *   <index-uri-name> [Entity()] => fail
-   *
-   * @type uri@[namespace|[name|restPath]] -> ?name
+   * Gets the URI part for given term.
    */ 
-  index-uri-name =
-    ?[_|[<id>|_]]
-  
-  /**
-   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
-   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
-   * from the given term.
-   *
-   * Example:
-   *   <index-value> DefData([Entity(), \"Bar\", \"Baz\"], Type(), TYPE(\"Bar\")) => TYPE(\"Bar\")
-   *
-   * @type elem -> ?value
-   *
-   * @see index-value-impl
-   * @see index-value-generic
-   */  
-  index-value = 
-    index-value-impl <+ index-value-generic
-  
-  /**
-   * Queries if given index file is a 'fake' file for storing internal data.
-   *
-   * @type x -> ?x
-   */
-  index-is-fake-file = 
-    string-starts-with(|\"/.internal\")
+  index-uri = index-uri-impl <+ index-uri-generic
   
   /**
    * Checks if given URI's are equal. Discards anonymous scopes if necessary.
@@ -627,8 +292,6 @@
    *   <index-uri-eq> ([Entity(), Anon(\"a\"), \"Bar\"], [Entity(), Anon(\"b\"), \"Bar\"]) => 
    *     ([Entity(), Anon(\"a\"), \"Bar\"], [Entity(), Anon(\"b\"), \"Bar\"])
    *   <index-uri-eq> ([Entity(), \"Foo\"], [Entity(), \"Bar\"]) => fail
-   *
-   * @type (u1, u2) -> ?(u1, u2)
    */
   index-uri-eq:
     (u1, u2) -> <id>
@@ -636,120 +299,81 @@
       u1' := <index-uri-unwrap> u1;
       u2' := <index-uri-unwrap> u2;
       (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
-  
-  /**
-   * Finds the first key (term{uri} element) for given term, or fail. 
-   *
-   * @type x -> ?name{uri}
-   */
-  index-find-key:
-    x -> key
-    where
-      key := <collect-one(?_{_})> x
-      
-  /**
-   * Converts a URI to a string.
-   *
-   * Example:
-   *   <index-uri-to-string> [Entity(), \"Bar\", \"Baz\"] => \"Entity://Bar.Baz\"
-   *
-   * @type uri -> str
-   */
-  index-uri-to-string:
-    [ns|path] -> <concat-strings> [nsStr, \"://\", pathStr]
-    with
-      pathStr := <take-until(?Anon(_)); reverse; separate-by(|\".\"); concat-strings> path;
-      nsStr := <?<id>#(_)> ns
-  
+
   /**
-   * Converts a file to a string.
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
    *
    * Example:
-   *   <index-file-to-string> \"fullpath/file.ext\" => \"fullpath/file.ext\"
-   *
-   * @type file -> file
-   */
-  index-file-to-string:
-    file -> file
+   *   <index-key-eq> (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]}) => 
+   *     (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]})
+   *   <index-key-eq> (\"Foo\"{[Entity(), \"Foo\"]}, \"Bar\"{[Entity(), \"Bar\"]}) => fail
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
     where
-      not(<is-tuple> file)
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
   
   /**
-   * Converts a file ((file, subfile) tuple) to a string.
-   *
-   * Example:
-   *   <index-file-to-string> (\"fullpath/file.ext\", \"\") => \"fullpath/file.ext\"
-   *
-   * @type (file, \"\") -> file
-   */
-  index-file-to-string:
-    (file, \"\") -> file
-    
+   * Gets the value part for given term.
+   */  
+  index-value = index-value-impl <+ index-value-generic
+  
   /**
-   * Converts a file ((file, subfile) tuple) to a string.
-   *
-   * Example:
-   *   <index-file-to-string> (\"fullpath/file.ext\", \"subfile\") => \"fullpath/file.ext at subfile\"
-   *
-   * @type (file, subfile) -> str
+   * Finds the first key (term{uri} element) for given term, or fail. 
    */
-  index-file-to-string:
-    (file, subfile) -> <concat-strings> [file, \"@\", subfile]
+  index-find-key:
+    x -> key
     where
-      not(\"\" := subfile)
+      key := <collect-one(?_{_})> x
       
 /** @internal */
 rules // URI and value projections
-  
-  /** @internal */
+    
   index-uri-impl:
     DefData(uri, _, _) -> uri
 
-  /** @internal */
   index-uri-generic:
     term -> <?_#(<?[<id>|_]>)> term
   
-  /** @internal */
   index-value-impl:
     DefData(_, _, value) -> value
     
-  /** @internal */
   index-value-generic:
     term -> <?_#(<?[_, <id>|_]> )> term
      
 /** @internal */ 
 rules // Internal helpers
   
-  /** @internal */
   index-namespace-unwrap =
     \\Unresolved(n) -> n\\ <+ id
     
-  /** @internal */
   index-uri-unwrap =
     \\[ns|xs] -> [<index-namespace-unwrap> ns|xs]\\ <+ id
+    
+  index-key-unwrap = 
+    \\key{uri} -> key{<index-uri-unwrap> uri}\\ <+ id
 "
 
   create-analysis-library =
-	try(<file-exists <+ mkdir> "lib");
-	<output-text-file(|["lib"], "analysis-library.generated.str")>
+  try(<file-exists <+ mkdir> "lib");
+  <output-text-file(|["lib"], "analysis-library.generated.str")>
 "module lib/analysis-library.generated
  
 imports
   libstratego-lib
-  libstratego-parallel
   lib/editor-common.generated
   lib/index-library.generated
  
 signature constructors
  
   // Analyze constructors
-  Results     : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
+  AnalysedResult : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) -> AnalysedResult
   Editor      : AnalysisPhase
   Compile     : AnalysisPhase
  
   // Index elements
   Def          : List(UriPart) -> Summary
-  Use          : List(UriPart) -> Summary
+  Use          : List(UriPart) * List(UriPart) -> Summary
   BadUse       : List(UriPart) -> Summary
   Read         : List(UriPart) -> Summary
   ReadWildcard : List(UriPart) * String -> Summary
@@ -762,306 +386,232 @@
   // Adjust lookup actions
   StopLookup   : LookupAction
   
-  // Parallel
-  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
-  
-rules // Index analysis extension points
+rules // extension points
  
-  /**
-   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
-   *
-   * The overriden rule must return a list that contains any of the following items:
-   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
-   *                        use site to this definition.
-   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
-   * 
-   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
-   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
-   * will be used.
-   *
-   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
-   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
-   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
-   * lookups that will always fail anyway.
-   *
-   * Extension example:
-   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
-   *     PropAccess(exp, name) -> properties
-   *     where
-   *       <check-target-name> name
-   *     with
-   *       if TYPE(type{_}) := <type-of> exp then
-   *         properties := <index-lookup-children(|Property(), prefix)> type
-   *       else
-   *         properties := StopLookup()
-   *       end
-   *
-   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
-   *     Var(name) -> [[Var() | path], [Property() | path]]
-   *     where
-   *       <check-target-name> name
-   *
-   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
-   *                            lookup algorithm is looking for.
-   * @param namespace           The namespace of the element that should be looked up.
-   * @param path                The path the lookup algorithm is currently looking at for the element.
-   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
-   *                            full name of the element, but could be a partial prefix during content completion.
-   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
-   */
-  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
-  
-  /** 
-   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
-   * a (list of) data that must be stored in the index.
-   *
-   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
-   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
-   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
-   * rule fail if you are doing a <filter(store-results)> for example.
-   *
-   * Extension example:
-   *   adjust-index-def-data(store-results|namespace, path):
-   *     def -> <store-results> Type([namespace|path], type)
-   *     where
-   *       type := <type-of> def
-   *
-   * @param store-results Call this on the data you want to store in the index.
-   * @param namespace     The namespace of the definition that the rule is being called on.
-   * @param path          The path of the definition that the rule is being called on.
-   * @type def -> fail 
-   */
-  adjust-index-def-data(store-results|namespace, path) = fail
-  
-  /**
-   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
-   * use sites. Should return a path that will be assigned to the definition or use site.
-   *
-   * Extension example:
-   *   adjust-index-path(check-target-definition|namespace, path):
-   *     Start(_, _) -> [<string-replace(|<project-path>, \"\")> <Fst> <index-get-current-file>]
-   *
-   *
-   * @param check-target-definition 
-   * @param namespace               The namespace that would be given to the current definition or use site.
-   * @param path                    The path that would be given to the current definition or use site.
-   * @type def -> uri@[namespace|path]
-   */
-  adjust-index-path(check-target-definition|namespace, path) = fail
+  // Should return list of Def(_) and/or [namespace | path] or StopLookup() to stop the lookup
+  adjust-index-lookup(is-use |namespace, path, prefix) = fail
+ 
+  // adjust-index-select(|namespace, path, use) = fail // (e.g., for imports)
+ 
+  // Should call <store-results> on a (list of) DefData
+  adjust-index-def-data(store-results |namespace, path) = fail
+ 
+  // Should return a path
+  adjust-index-path(is-def |namespace, path) = fail
+ 
+  // adjust-index-path-from-filesystem(|project-path, path)
   
   /**
-   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
-   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
+   * Should define constructors to check for difference during analysis. Defaults to Def constructs.
    *
    * Extension example:
    *   index-diff-constructors = ?Type(_, _)
-   *
-   * @type a -> ?a
-   *
-   * @see index-diff-compare
    */
-  index-diff-constructors = 
-    ?Def(_)
+  index-diff-constructors = ?Def(_)
   
   /**
-   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
-   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
-   * compared.
+   * Should compare two index elements and fail if they are not equal.
    *
    * Extension example:
-   *   index-diff-compare:
+     *   index-diff-compare:
    *     (Type(u1, v1), Type(u2, v2)) -> <id>
    *     where
    *       <index-uri-eq> (u1, u2);
    *       <eq> (v1, v2)
-   *
-   * @type (a, b) -> ?(a, b)
-   *
-   * @see index-diff-constructors
    */
   index-diff-compare:
     (Def(u1), Def(u2)) -> <id>
     where
        <index-uri-eq> (u1, u2)
+       
+  post-analyze-top(|phase, language, full-path) = fail
  
-rules // Analysis traversals
+rules // analysis traversals
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
-   * Defaults to Editor() phase.
+   * Defaults to Editor() phase and tries to automatically determine language name.
    *
-   * @param language  The name of the language that is being analysed.
-   *
-   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
+   * @see analyze-top(|phase, language)
+   */
+  analyze-top = analyze-top(|Editor())
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Tries to automatically determine language name.
    *
    * @see analyze-top(|phase, language)
    */
-  analyze-top(|language):
-    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
+  analyze-top(|phase) = ?(ast, _, _); analyze-top(|phase, <index-origin-language> ast)
    
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
-   * @param phase         The type of analysis phase. There are 2 phases to choose from:
-   *                      - Editor():   File dependencies are analysed.
-   *                      - Compile():  File dependencies are not analysed.
-   * @param language      The name of the language that is being analysed.
-   * @param path          The path of the file to analyze relative to project-path.
-   * @param project-path  The path of the directory that contains all the source files.
-   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
+   * @param phase     The type of analysis phase. There are currently 2 phases to choose from:
+   *                  - Editor():   All information is stored into the index and dependent files
+   *                                are automatically scheduled for re-analysis.
+   *                  - Compile():  No information is stored and no re-analysis is done.
+   * @param language  The name of the language that is being analysed.
    *
-   * @see analyze-top-internal(|phase, language, project-path, full-path)
+   * @see analyze-top-internal(|phase, language)
    */
-  analyze-top(|phase, language, path, project-path):
-    ast -> (ast', filesToAnalyze)
+  analyze-top(|phase, language):
+    (ast, path, project-path) -> ast'
     with
-      full-path := $[[project-path]/[path]];
-      if index-split then
-        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
-        asts := <index-toplevel-split> ast;
-        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
-        Results(ast', _, _, _, _, _, filesToAnalyze) := 
-          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
-      else
-        Results(ast', _, _, _, _, _, filesToAnalyze) := 
-          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
-      end
+      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|phase, language)> (ast, path, project-path)
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
    * @internal
-   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
-   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
    */
-  analyze-top-internal(|phase, language, project-path, full-path):
-    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
+  analyze-top-internal = 
+    analyze-top-internal(|Editor())
+  analyze-top-internal(|phase) = 
+    ?(ast, path, project-path); analyze-top-internal(|phase, <index-origin-language> ast)
+  analyze-top-internal(|phase, language) = 
+    ?(_, path, project-path); analyze-top-internal(|phase, language, $[[project-path]/[path]])
+  analyze-top-internal(|phase, language, full-path):
+    (ast, path, project-path) -> AnalysedResult(ast5, defs, uses, data', added, removed)
     with
       // Init
-      index-setup(|language, [project-path], full-path);
-      revision := <index-start-transaction>
+      index-setup(|language, [project-path], full-path)
     with
-      // Store old elements
-      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
-      <index-clear-file> full-path
+      file := (full-path, \"\"); // TODO: Get subfile or add subfile param.
+        // Store copy of elements for diff and clear file
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> file;
+      <index-clear-file> file
     with
-      {| Index-UnresolvedSet:
+      {| Index-ReadSet, Index-UnresolvedSet:
+        readSet := <new-iset>;
         unresolvedSet := <new-iset>;
+        
+        rules(Index-ReadSet: _ -> readSet);
         rules(Index-UnresolvedSet: _ -> unresolvedSet);
+       
+        // Add Unresolved annotations, record globals
+        (Some(ast2), defs) := <analyze-defs(|Anon(), Anon())> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+        <index-add-all(|file)> defs;
+
+        // Find DefData
+        ast3 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast2;
+        data := <origin-track-forced(analyze-tree-data)> ast3;
+        <index-add-all(|file)> data;
+
+        // Resolve an references in DefData (using what we just stored)
+        (data', data-uses) := <analyze-uses> data;
+        <index-remove-all(|file)> data;
+        <index-add-all(|file)> data';
+       
+        // Resolve all unresolved references in the tree
+        (ast4, uses) := <analyze-uses> ast3;
+        <index-add-all(|file)> uses;
         
-        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
-        defs := <concat> defsList;
-        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
-        data := <concat> dataList;
-        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
-        uses := <concat> usesList;
-        (asts, _) := <unzip> astFilePairs4
+        ast5 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast4;
+       
+        // Store reads into the index (if current language is not testing language)
+        if not(<is-test-input(|language)> (ast, path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
       |}
     with
-      index-end-transaction
-    with
       // Schedule re-analysis of dependent files (if current file is not testing language file)
       // HACK: Depends on file extension, could be other languages with .spt extension?
-      if Editor() := phase; not(<is-test-file> full-path) then
-        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
+      if Editor() := phase; not(<is-test-file> path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data');
         
-        // Find added and removed definitions
-        (added, removed) := <analyze-diff> (oldElems, newElems);
-        changed := <conc> (added, removed);
-        
-        // Store files that have changed in the index
-        index-transaction(
-          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
-        )
-      else
-        (added, removed) := ([], []);
-        filesToAnalyze := []
+          // Find added and removed definitions
+          (added, removed) := <analyze-diff> (oldElems, newElems);
+          changed := <conc> (added, removed);
+
+          // Schedule re-analysis of files that depend on added or removed elements
+          <reanalyze-all(|full-path)> changed;
+          
+          // TODO: Move diff stuff to compilation-library somehow.
+          // Store added and removed elements in the index
+          analyze-store-diff(|changed, file, ast)
+        else
+          (added, removed) := ([], [])
       end
     with
-      <list-loop(analyze-top-store-ast)> astFilePairs4
-      
-  /**
-   * Add URI annotations to each definition and unresolved URI annotations to each use site.
-   *
-   * @internal
-   */
-  analyze-top-defs:
-    (ast, file) -> ((ast2, file), defs)
+      try(post-analyze-top(|phase, language, full-path))
+
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+  
+  reanalyze-all(|file) =
+    index-get-dependent-files; 
+    filter(not(analyze-changed-filter-file(|file)); reanalyze-file)
+    
+  analyze-changed-filter-file(|file) = 
+    ?files@(<id>, _); (is-test-file <+ index-is-fake-file <+ ?file); !files
+    
+  reanalyze-file = 
+    ?(<id>, _); debug(!\"Re-analyzing \"); prim(\"SSL_EXT_queue_analysis\")
+    
+  analyze-store-diff(|changedEntries, file, ast): 
+    _ -> <id>
     with
-      <index-set-current-file> file;
-      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
-      <index-add-all(|file)> defs
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      files := <conc> (changedFiles, dependentFiles);
       
-  /**
-   * Gathers all data for each definition.
-   *
-   * @internal
-   */
-  analyze-top-data(|language, full-path):
-    (ast, file) -> ((ast2, file), data2)
+      if not(<analyze-astdiff(|ast)> file) then
+        // Add current file if the AST has changed. Cannot use dependency tracking here because
+        // the originating file of a removed definition is not in the index any more.
+        files' := <make-set> [file|files] 
+        else
+            files' := <make-set> files
+        end;
+      
+      if not([] := files') then
+        storePath := <analyze-diff-path>;
+        <map(analyze-add-diff(|storePath))> files'
+      end
+      
+  analyze-add-diff(|storePath):
+    file -> <id>
     with
-      <index-set-current-file> file;
-      {| Index-ReadSet:
-        readSet := <new-iset>;
-        rules(Index-ReadSet: _ -> readSet);
-        
-        // Gather all data for each definition.
-        ast2 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast; // Parent pointers needed.
-        data := <origin-track-forced(analyze-tree-data)> ast2;
-        
-        // Resolve all references in gathered data.
-        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
-        <index-add-all(|file)> data2;
-        
-        // Store reads into the index (if not testing language)
-        if not(is-test-input(|language, full-path)) then
-          <index-add-all(|file)> <iset-elements> readSet
-        end
-      |}
+      <index-add-all(|storePath)> [Diff([Diff(), \".internal\"], file)]
       
-  /**
-   * Resolves all unresolved references for each use site.
-   *
-   * @internal
-   */
-  analyze-top-uses(|language, full-path):
-    (ast, file) -> ((ast3, file), uses)
+  analyze-get-diffs:
+    _ -> diffs
     with
-      <index-set-current-file> file;
-      {| Index-ReadSet:
-        readSet := <new-iset>;
-        rules(Index-ReadSet: _ -> readSet);
+        diffs := <make-set> <index-get-all-values> Diff([Diff(), \".internal\"], ())
         
-        // Resolve all unresolved references for each use site.
-        (ast2, uses) := <analyze-uses> ast;
-        <index-add-all(|file)> uses;
-        
-        ast3 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast2; // AST changed, reset parent pointers.
-        
-        // Store reads into the index (if not testing language)
-        if not(is-test-input(|language, full-path)) then
-          <index-add-all(|file)> <iset-elements> readSet
+  // Fails if old ASTDiff is not found or if ASTDiff is different.
+  analyze-astdiff(|ast):
+    (file, subfile) -> <id>
+    where
+      storePath := <analyze-diff-path>;
+        newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-value> Diff([ASTDiff(), file, \".internal\"], ()) then
+        <index-remove-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], ())];
+          <index-add-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], newChecksum)];
+        <eq> (oldChecksum, newChecksum)
+        else
+            <index-add-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], newChecksum)];
+            fail
         end
-      |}
       
-  /**
-   * Stores AST from file to the index.
-   *
-   * @internal
-   */   
-  analyze-top-store-ast:
-    (ast, file) -> <id>
+  analyze-clean-diff:
+    _ -> <id>
     with
-      <index-set-global(|[<index-file-to-string> file, \"ast\"])> ast
-      
+        storePath := <analyze-diff-path>; 
+      <index-remove-all(|storePath)> [Diff([Diff(), \".internal\"], ())]
+        
+  analyze-diff-path = 
+    !\"/.internal/diff\"
+ 
   /**
-   * Identifies all definitions in the tree and annotates them with their URI.
+   * Identifies all definitions in the tree
+   * and annotates them with their URI.
    * Also annotates uses with a preliminary \"Unresolved(_)\" URI.
-   *
-   * @internal
    */
-  analyze-defs = analyze-defs(|Anon(), Anon())
-  /** @internal */
   analyze-defs(|head-scope, head-scope-ns):
     ast -> (ast', defs')
     with
@@ -1083,8 +633,7 @@
         (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
       end;
       defs' := <![def | defs] <+ !defs>
-      
-  /** @internal */
+ 
   analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
     ast -> (ast'', defs)
     where
@@ -1092,7 +641,6 @@
       (ast', defs)  := <unzip-analyzed> analyzed;
       ast''         := <try(nam-annotate-names(|def-path))> ast'
  
-  /** @internal */
   update-index-path(|head-scope, head-scope-ns, ast):
     scope-type -> scope-type
     where
@@ -1122,19 +670,23 @@
   */
  
   /**
-   * Analyze all uses, changing their preliminary \"Unresolved(_)\" URI to a definite URI of their definition.
-   *
-   * @internal
+   * Analyze all uses, changing their preliminary
+   * \"Unresolve(_)\" URI to a definite URI of their definition.
    */
-  analyze-uses:
+  analyze-uses = analyze-uses(|None())
+  analyze-uses(|parent):
     ast -> (ast'', uses')
     with
-      analyzed     := <all(analyze-uses)> ast;
+      analyzed     := <all(analyze-uses(|ast))> ast;
       (ast', uses) := <unzip-analyzed> analyzed;
       if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
         if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
           ast'' := ast{def-uri};
-          uses' := [Use(def-uri) | uses]
+          if key{keyUri} := <nam-get-definition-key> parent ; not(<eq>(key, ast')) then
+            uses' := [Use(def-uri, keyUri) | uses]
+          else
+            uses' := [Use(def-uri, [namespace | path]) | uses]
+          end
         else
           ast'' := ast';
           uses' := [BadUse([namespace, x]) | uses]
@@ -1145,9 +697,7 @@
       end
  
   /**
-   * Collects all index data (e.g. types of definitions).
-   *
-   * @internal
+   * Collects all index data (e.g., types of definitions).
    */
   analyze-tree-data:
     tree -> data
@@ -1155,8 +705,7 @@
       set := <new-iset>;
       <topdown(analyze-tree-data-part(|set))> tree;
       data := <iset-elements> set
-      
-  /** @internal */
+ 
   analyze-tree-data-part(|set):
     tree -> tree
     where
@@ -1166,8 +715,7 @@
           <fatal-err(|\"Unexpected result from adjust-index-def-data; should call <store-results>\")> result
         end
       end
-  
-  /** @internal */
+ 
   store-index-data-results(|set):
     t -> <fail>
     where
@@ -1176,204 +724,38 @@
       else
         <iset-add(|t)> set
       end
-  
-rules // Parallel analysis
-  
+ 
   /**
-   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
-   * analysis of dependent files that have changed during the analysis.
-   *
-   * Example:
-   *   <index-parallel-analyze-files(analyze)> [\"text/file1.ext\", \"text/file2.ext\"]
-   *
-   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
-   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
-   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
-   * @type List((file, subfile) or file) -> None()
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) )
+   * to a tuple (C(a1, a2), [b1, b2, b3]).
    */
-  index-parallel-analyze-files(analyze):
-    files -> None()
-    with
-      length; 
-      set-total-work-units
-    with
-      index-parallel-analyze(analyze);
-      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
-  
-  /** @internal */
-  index-parallel-analyze(analyze):
-    files -> allResults
-    with
-      map(index-parse-file); // Parsing cannot be done in parallel.
-      map(\\(ast, file) -> (ast, file, <project-path>)\\);
-      parallel-unordered(all(index-analyze(analyze)));
-      ?results;
-      with(<eq> (<length> results, <length> files) | \"Input size not equal to output size\");
-      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
-      if not([] := filesToAnalyze) then
-        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
-      else
-        allResults := results
-      end
-  
-  /** @internal */   
-  index-parse-file:
-    file -> (ast, file)
-    with
-    if <file-exists> file then
-      ast := <parse-file> file
-    else
-      ast := ()
-    end
-   
-  /** @internal */   
-  index-set-markers:
-    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
-    with
-      <set-markers(|ast)> (ast', errors, warnings, notes)
-      
-  /** @internal */
-  index-analyze(analyze):
-    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
-    with
-      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
-      if [] := filesToAnalyze then
-        complete-work-unit
-      end
-      
-/** @internal */
-rules // Splitter
-  
-  /** @internal */
-  index-split = fail
-  /** @internal */
-  index-is-toplevel = fail
-  /** @internal */
-  index-is-qualifier = fail
-  /** @internal */
-  index-qualifier-subelements = fail
-  /** @internal */
-  index-create-qualifier(|qualifier) = fail
-  
-  /** @internal */
-  index-toplevel-split:
-    ast -> asts'
-    with
-      (ast', _) := <analyze-defs> ast;
-      asts      := <index-toplevel-split-internal> ast';
-      asts'     := <strip-annos> asts
-      
-  /** @internal */
-  index-toplevel-split-internal:
-    node -> units
-    with
-      switch id
-        case ?():
-          units := [((), [])]
-        case index-is-qualifier:
-          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
-          units := <map(index-transform-qualifier(|node))> elems
-        case index-is-toplevel:
-          units := [(node, <index-uri> <nam-get-definition-key> node)]
-        otherwise:
-          units := [(node, [])]
-      end
-      
-  /** @internal */
-  index-transform-qualifier(|node):
-    (elem, subfileName) -> (qualifier, subfileName)
-    with
-      qualifier := <index-create-qualifier(|node)> elem
-
-/** @internal */
-rules // Diffs
-  
-  /** @internal */
-  analyze-diff:
-    (defs1, defs2) -> (added, removed)
-    with
-      added   := <diff(index-diff-compare)> (defs2, defs1);
-      removed := <diff(index-diff-compare)> (defs1, defs2)
-    
-  /** @internal */
-  analyze-store-diff(|changedEntries, revision): 
-    astFilePairs -> analyzeFiles'
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
     with
-      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
-      dependentFiles  := <index-get-dependent-files> changedEntries;
-      
-      // Files to analyze
-      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
-      analyzeFiles' := analyzeFiles;
-      // TODO: Is this extra check needed?
-      /*if <getfirst(index-get-file-revision; \\r -> (r, revision)\\; gt)> analyzeFiles then
-        // Add current file if the current file has read information from another file with a higher revision.
-        // This indicates that potentially outdated information was read.
-        analyzeFiles' := [file|analyzeFiles]
-      else
-        analyzeFiles' := analyzeFiles
-      end;*/
-      
-      // Files to compile
-      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
-      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
-      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
-      <map(analyze-add-compilediff)> compileFiles
-      
-  /** 
-   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
-   *
-   * @internal
-   */
-  analyze-astdiff:
-    (ast, file) -> file
-    where
-      name := [<index-file-to-string> file, \"ast-checksum\"];
-      newChecksum := <checksum> ast;
-      if oldChecksum := <index-get-global(|name)> then
-        <index-set-global(|name)> newChecksum;
-        not(<eq> (oldChecksum, newChecksum))
-      else
-        <index-set-global(|name)> newChecksum
-      end
-      
-  /** 
-   * Adds given file to the list of files to compile.
-   *
-   * @internal
-   */
-  analyze-add-compilediff = index-add-global(|\"compile-diff\")
-  
-  /** 
-   * Gets the list of files to compile, and then clear it.
-   *
-   * @internal
-   */
-  analyze-get-compilediffs = index-get-all-globals(|\"compile-diff\"); index-clear-global(|\"compile-diff\")
+      appl'          := <all(\\(a, _) -> a\\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\\(_, b) -> b\\) <+ map(\\(_, b) -> b\\) <+ ![]> appl
  
-rules // index API query primitives
+rules // index API primitives
  
   /**
    * Gets all DefData entries that match the kind of data and URI in given definition.
    *
-   * Example:
-   *   <index-get-data(|Type())> Def([Entity(), \"Bar\"]) => [DefData([Entity(), \"Bar\"], Type(), TYPE(\"Bar\")), ...]
-   *
    * @param kind Only data of this kind is returned.
-   * @type Def(uri) -> List(DefData(uri, kind, value))
-   */
-  index-get-data(|kind):
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-value> DefData(uri, kind, ())
-      
-  /**
-   * Gets all data entries that match the kind of data and URI in given definition.
    *
    * Example:
-   *   <index-get-data-all(|Type())> Def([Entity(), \"Bar\"]) => [TYPE(\"Bar\"), ...]
-   *
-   * @param kind Only data of this kind is returned.
-   * @type Def(uri) -> List(value)
+   *   <index-get-data(|Type())> Def([Entity(), \"Bar\"]) => [DefData([Entity(), \"Bar\"], Type(), TYPE(\"Bar\")), ...]
    */
+  index-get-data(|kind):
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-value> DefData(uri, kind, ())
+      
+    /**
+     * Gets all data entries that match the kind of data and URI in given definition.
+     *
+     * @param kind Only data of this kind is returned.
+     *
+     * Example:
+     *   <index-get-data-all(|Type())> Def([Entity(), \"Bar\"]) => [TYPE(\"Bar\"), ...]
+     */
   index-get-data-all(|kind):
     <with(?Def(uri) | \"Def expected\")> -> <index-get-all-values> DefData(uri, kind, ())
      
@@ -1381,20 +763,16 @@
    * Gets all Use entries that match the URI in given definition.
    *
    * Example:
-   *   <index-get-uses-all> Def([Entity(), \"M\", \"Bar\"]) => [Use([Entity(), \"M\", \"Bar\"]), ...]
-   *
-   * @type Def(uri) -> List(Use(uri))
+   *   <index-get-uses-all> Def([Entity(), \"M\", \"Bar\"]) => [Use([Entity(), \"M\", \"Bar\"], [Entity(), \"M\"]), ...]
    */
   index-get-uses-all:
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-all> Use(uri)
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-all> Use(uri, [])
      
   /**
    * Gets all Read or ReadWildcard entries that match the given template.
    *
    * Example:
    *   <index-get-reads-all> [Property(), \"Bar\", \"p\"] => [Read([Property(), \"Bar\", \"p\"]), ...]
-   *
-   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
    */
   index-get-reads-all:
     template -> <conc> (reads, readwildcards')
@@ -1413,8 +791,6 @@
    *
    * Example:
    *   <index-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
-   *
-   * @type template -> List(elem)
    */
   index-get-all:
     template -> <indexlib-get-all> template
@@ -1427,12 +803,10 @@
   /**
    * Get all values of index entries that match the given template.
    *
+   * @see index-value
+   *
    * Example:
    *   <index-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
-   *
-   * @type template -> List(value)
-   *
-   * @see index-value
    */
   index-get-all-values:
     template -> <map(index-value)> <index-get-all> template
@@ -1442,8 +816,6 @@
    *
    * Example:
    *   <index-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
-   *
-   * @type template -> ?elem
    */
   index-get:
     template -> <?[<id>|_]> <index-get-all> template
@@ -1451,140 +823,119 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
+   * @see index-value
+   *
    * Example:
    *   <index-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
-   *
-   * @type template -> ?value
-   *
-   * @see index-value
    */
   index-get-value:
     template -> <index-value> <?[<id>|_]> <index-get-all> template
-
+   
   /**
-   * Gets all Def children elements of an URI in a certain namespace.
-   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
-   *
-   * Example:
-   *   <index-get-children(|Field())> Def([Entity(), \"Baz\"]) => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
-   *   <index-get-children(|Field())> \"Foo\"{[Entity(), \"Baz\"]} => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
-   *   <index-get-children(|Field())> [Entity(), \"Baz\"] => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
-   *
-   * @param namespace Only child Def elements in this namespace are returned.
-   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   * Gets the namespace part of the URI for given term.
    */
-  index-get-children(|namespace) = 
-    index-get-children(\\uri -> Def(uri)\\|namespace)
-  
+  index-namespace:
+    x{[namespace | path]} -> <index-namespace-unwrap> namespace
+
   /**
-   * Gets all children elements of an URI in a certain namespace using custom templates.
-   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
-   *
-   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
-   * @param namespace           Only child elements in this namespace are returned.
-   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   * Gets the path part of the URI for given term.
    */
-  index-get-children(construct-template|namespace):
-    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | \"Def, key or uri expected\")> -> children
-    with
-      template  := <construct-template> [namespace | path];
-      children  := <prim(\"LANG_index_get_children\", template)>;
-      <store-wildcard-read(|namespace, path, \"\")> children
-
+  index-path:
+    x{[namespace | path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+    
   /**
-   * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
-   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
-   *
-   * Example:
-   *   <index-get-children(|Field(), \"fo\")> Def([Entity(), \"Baz\"]) => [Def([Field(), \"Foo\"]), ...]
-   *   <index-get-children(|Field(), \"ba\")> \"Foo\"{[Entity(), \"Baz\"]} => [Def([Field(), \"Bar\"]), ...]
-   *   <index-get-children(|Field(), \"ze\")> [Entity(), \"Baz\"] => [...]
-   *
-   * @param namespace Only child Def elements in this namespace are returned.
-   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
-   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   * Determines if a given AST node is a definition site,
+   * according to the syntax.
    */
-  index-get-children(|namespace, prefix) = 
-    index-get-children(\\uri -> Def(uri)\\|namespace, prefix)
-  
+  index-is-definition =
+    where(nam-get-definition-key)
+ 
   /**
-   * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
-   * using custom templates.
-   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   * Returns all children of a Def.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
    *
-   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
-   * @param namespace           Only child elements in this namespace are returned.
-   * @param prefix              Only child elements where the name starts with this prefix are returned.
-   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
    */
-  index-get-children(construct-template|namespace, prefix):
-    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | \"Def, key or uri expected\")> -> children'
+  index-get-children(|namespace, prefix):
+    <with(?Def([parent-ns | path]) | \"Def expected\")> -> children'
     with
+      with(not(!namespace => Def(_)) | \"index-get-children interface changed\");
       prefix'   := <strip-annos> prefix;
-      template  := <construct-template> [namespace | path];
+      template  := Def([namespace | path]);
       children  := <prim(\"LANG_index_get_children\", template)>;
       children' := <filter(index-is-name-substring(|prefix'))> children;
-      <store-wildcard-read(|namespace, path, prefix')> children'
+      store     := [namespace, prefix' | path];
+      // Store read in index.
+      if set := <Index-ReadSet> then
+        if 1 := <length> children' then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace, prefix' | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix'))> set
+        end
+      end
 
   /**
    * Gets a set of all files that have a reference to the given index entries.
    *
+   * @param construct-from-uri  Construction strategy that creates a list of reference constructs from all 
+   *                            given entries, such as \\uri -> [Read(uri), Use(uri, [])]\\
+   *
    * Example:
    *   <index-get-referenced-files(\\uri -> [Read(uri), Use(uri, [])]\\)> [Def([Entity(), \"Bar\"]), ...] => 
    *     [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
-   *
-   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
-   *                            constructs from all given entries, such as \\uri -> [Read(uri), Use(uri, [])]\\
-   * @type List(elem) -> List((file, subfile))
    */
   index-get-referenced-files(construct-from-uri):
     entries -> files
     where
       uris        := <filter(index-uri)> entries;
       referenced  := <concat> <filter(construct-from-uri)> uris;
-      files       := <iset-elements> <iset-addlist(|<mapconcat(index-get-files-of)> referenced)> <new-iset>
+      files       := <make-set> <mapconcat(index-get-files-of)> referenced
  
   /**
    * Convenience function for finding files with Read and Use dependencies to the given definitions.
    *
-   * Example:
-   *   <index-get-dependent-files> [Def([Entity(), \"Bar\"]), ...] => [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
-   *
-   * @type List(elem) -> List((file, subfile))
-   *
    * @see index-get-referenced-files(construct-from-uri)
    * @see index-file-dependent-construct
+   *
+   * Example:
+   *   <index-get-dependent-files> [Def([Entity(), \"Bar\"]), ...] => [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
    */
   index-get-dependent-files = 
     index-get-referenced-files(index-file-dependent-construct)
      
-rules // Index lookup rules (take into account adjust-index-lookup)
+rules // index lookup rules (take into account adjust-index-lookup)
  
   /**
    * Given an annotated AST node, resolves it, returning its Def.
-   *
-   * @type \"name\"{uri} -> ?Def(uri')
    */
   index-lookup:
-    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+    x{[namespace | path]} -> <index-lookup(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
-   * 
-   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-all:
-    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+    x{[namespace | path]} -> <index-lookup-all(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
    *
    * @internal
-   * @type \"name\"{uri} -> ?Def(uri')
    */
-  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
+  index-lookup(is-adjust-lookup-enabled |namespace, path, prefix):
     x -> def
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
@@ -1593,27 +944,27 @@
       else
         def        := <index-select(|namespace, path, x)>
       <+
-        // TODO: optimize: try not to call do-adjust-index-lookup from here
-        [_ | path'] := path;
-        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
+          // TODO: optimize: try not to call do-adjust-index-lookup from here
+          [_ | path'] := path;
+          def         := <index-lookup(is-adjust-lookup-enabled |namespace, path', prefix)> x
       end
 
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
    *
-   * @type \"name\"{uri} -> List(Def(uri'))
    * @internal
    */
-  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
+  index-lookup-all(is-adjust-lookup-enabled |namespace, path, prefix):
     x -> defs'
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
       defs       := <index-select-all(|namespace, path, x)>;
       // TODO: optimize: try not to call do-adjust-index-lookup from here
       if [_ | path'] := path then
-        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled |namespace, path', prefix)> x;
         defs' := <conc> (defs, defs2)
       else
         defs' := defs
@@ -1622,18 +973,18 @@
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   * @type \"name\"{uri} -> ?Def(uri')
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
    */
   index-lookup-outermost(|prefix):
-    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace | path]} -> <index-lookup-outermost(id |<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
    *
-   * @type \"name\"{uri} -> ?Def(uri')
    * @internal
    */
   index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
@@ -1647,24 +998,23 @@
       def        := <index-select(|namespace, path, x)>
  
   /**
-   * Given an annotated AST node, returns Defs that have the same parent URI.
+   * Given an annotated AST node, returns a Def that has the same parent URI.
    *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   * @type \"name\"{uri} -> List(Def(uri'))
+   * @param prefix    Only Defs with a name that starts with this
+   *                  string are returned.
    */
   index-lookup-one-level(|prefix):
-    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace | path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and
+   * returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Only Defs with a name that starts with this string are returned.
-   *
-   * @type \"name\"{uri} -> List(Def(uri'))
-   * @internal
+   * @param prefix    Indicates that only Defs with a name that starts with this
+   *                  string are demanded.
    */
-  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
+  index-lookup-one-level(is-adjusted-lookup-enabled |namespace, path, prefix):
     x{_} -> defs
     with
       is-adjusted-lookup-enabled;
@@ -1681,22 +1031,22 @@
       defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
       
   /**
-   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and
+   * returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Only Defs with a name that starts with this string are returned.
-   * @type \"name\"{uri} -> List(Def(uri'))
+   * @param prefix    Indicates that only Defs with a name that starts with this
+   *                  string are demanded.
    */
   index-lookup-all-levels(|prefix):
-    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+    x{[namespace | path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
  
   /**
-   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and
+   * returns all possibly matching Defs with a common ancestor URI. 
    *
-   * @param prefix  Only Defs with a name that starts with this string are returned.
-   *
-   * @internal
-   * @type \"name\"{uri} -> List(Def(uri'))
+   * @param prefix    Indicates that only Defs with a name that starts with this
+   *                  string are demanded.
    */
   index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
     x{_} -> all-defs
@@ -1706,10 +1056,10 @@
       if ?StopLookup() then
         all-defs := []
       else
-        mapconcat(\\d at Def(p) -> [d]\\
-            <+ \\[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\\
-            <+ fatal-err(|\"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup\"));
-        ?all-defs
+          mapconcat(\\d at Def(p) -> [d]\\
+              <+ \\[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\\
+              <+ fatal-err(|\"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup\"));
+          ?all-defs
       end
     <+
       one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
@@ -1719,12 +1069,23 @@
         all-defs := one-level
       end
  
+  /** @Deprecated */
+  index-lookup-contained(|namespace, prefix) =
+    obsolete(!\"index-lookup-contained; use index-lookup-children\");
+    index-lookup-children(|namespace, prefix)
+   
+  /** @Deprecated */
+  index-lookup-contained-all-levels(|namespace, name) =
+    obsolete(!\"index-lookup-contained-all-levels; use index-lookup-descendants\");
+    index-lookup-descendants(|namespace, name)
+ 
   /**
-   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
+   * Given an annotated AST node, resolves it,
+   * and returns all child Defs of its definition.
    *
    * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only Defs with a name that starts with this string are returned.
-   * @type \"name\"{uri} -> List(Def(uri'))
+   * @param prefix    Only child Defs with a name that starts with this
+   *                  string are returned.
    */
   index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
     x{[ns | path]} -> defs
@@ -1737,226 +1098,100 @@
       end
     <+
       defs := []
-      
-rules // Index utilities
-  
-  /**
-   * Gets the namespace part of the URI for given key (term{uri} element).
-   *
-   * Example:
-   *   <index-uri-namespace> \"Bar\"{[Entity(), \"Bar\", \"Baz\"]} => Entity()
-   *
-   * @type \"name\"{uri@[namespace|path]} -> namespace
-   */
-  index-uri-namespace:
-    x{[namespace|path]} -> <index-namespace-unwrap> namespace
-
+ 
   /**
-   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   * Given an annotated AST node, resolves it,
+   * and returns all descendant Defs of its definition.
    *
-   * Example:
-   *   <index-uri-path> \"Bar\"{[Entity(), \"Bar\", \"Baz\"]} => [\"Bar\", \"Baz\"]
-   *
-   * @type \"name\"{uri@[namespace|path]} -> path'
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only child Defs with a name that starts with this
+   *                  string are returned.
    */
-  index-uri-path:
-    x{[namespace|path]} -> path'
-    where
-      if !namespace => Unresolved(namespace) then
-        Def(path') := <index-lookup>
+  index-lookup-descendants(|namespace, name):
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-all-levels(id|namespace, def-path, name)> x
       else
-        path' := path
+        defs := <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, name)>
       end
-      
-  /**
-   * Gets the name part of the URI for given key (term{uri} element).
-   *
-   * Example:
-   *   <index-uri-name> \"Bar\"{[Entity(), \"Bar\", \"Baz\"] => \"Bar\"
-   *
-   * @type \"name\"{uri@[namespace|[name|restPath]]} -> name
-   */ 
-  index-uri-name:
-    x{[_|[name|_]]} -> name
-    
-  /**
-   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
-   *
-   * Example:
-   *   <index-uri-name> Def([Entity(), \"Bar\", \"Baz\"]) => \"Bar\"
-   *   <index-uri-name> Type(\"Foo\") => fail
-   *   <index-uri-name> Read([Entity()]) => fail
-   *
-   * @type x -> name
-   */   
-  index-uri-name:
-    x -> <index-uri-name> <index-uri> x
-    where
-      not(<has-annos> x)
-    
-  /**
-   * Determines if a given AST node is a definition site, according to the syntax.
-   *
-   * FIXME: Also succeeds on use sites.
-   *
-   * @type def -> ?def
-   */
-  index-is-definition =
-    where(nam-get-definition-key)
-    
-  /**
-   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
-   *
-   * Example:
-   *   <index-key-eq> (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]}) => 
-   *     (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]})
-   *   <index-key-eq> (\"Foo\"{[Entity(), \"Foo\"]}, \"Bar\"{[Entity(), \"Bar\"]}) => fail
-   *
-   * @type (k1, k2) -> ?(k1, k2)
-   */      
-  index-key-eq:
-    (k1, k2) -> <id>
-    where
-      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
+    <+
+      defs := []
        
 /** @internal */
 rules // URI and value projections
        
-  /** @internal */
   index-uri-impl:
     Def(uri) -> uri
     
-  /** @internal */  
   index-uri-impl:
-    Use(uri) -> uri
+    Use(uri, _) -> uri
     
-  /** @internal */  
   index-uri-impl:
     Read(uri) -> uri
     
-  /** @internal */  
   index-uri-impl:
     x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
  
-  /**
-   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
-   * 
-   * @internal 
-   */
+  // TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
   index-uri-impl:
     ReadWildcard(uri, _) -> uri
 
-  /** @internal */
   index-value-impl:
     Def(value) -> value
 
-  /** @internal */
   index-value-impl:
-    Use(value) -> value
+    Use(_, value) -> value
 
-  /** @internal */
   index-value-impl:
     Read(value) -> value
-  
-  /** @internal */
+    
   index-value-impl:
     ReadWildcard(_, value) -> value
        
 /** @internal */
 rules // Internal helpers
-
-  /**
-   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
-   *
-   * @internal
-   */
-  unzip-analyzed:
-    appl -> (appl', unzipped-parts)
-    with
-      appl'          := <all(\\(a, _) -> a\\)> appl;
-      unzipped-parts := <concat> <get-appl-arguments(\\(_, b) -> b\\) <+ map(\\(_, b) -> b\\) <+ ![]> appl
        
-  /**
-   * Tests if the current file is just a testing language input
-   *
-   * @internal
-   */
-  is-test-file = 
-    string-ends-with(|\".spt\")
-  /** @internal */
-  is-test-language = 
-    ?\"Spoofax-Testing\"
-  /** @internal */
-  is-test-input(|language, path) = 
-    <is-test-language> language <+ <is-test-file> path
-      
-  /** @internal */
-  fake-file = 
-    is-test-file <+ index-is-fake-file
-  
-  /** @internal */    
-  index-filepair-to-file = 
-    Fst; string-replace(|$[[<project-path>]/], \"\")
-  
-  /** @internal */
-  ast-uri-to-ast-file(|full-path):
-    (ast, uri) -> (ast, (full-path, uriStr))
-    with
-      (<index-uri-to-string> uri <+ !\"\") => uriStr
-  
-  /** @internal */     
+  index-origin-language = (origin-term <+ id); prim(\"SSL_EXT_origin_language\", <id>)
+       
+  // Tests if the current file is just a testing language input
+  is-test-file = string-ends-with(|\".spt\")
+  is-test-input(|language):
+    (ast, path) -> (ast, path)
+    where
+      <is-test-file> path;
+      not(!language => \"Spoofax-Testing\")
+       
   index-is-name-substring(|name):
     template -> <id>
     with
       [_, uri-name | _] := <index-uri>
     where
       <is-substring(!name)> uri-name
-   
-  /** @internal */    
+      
   index-readwildcard-substring(|prefix):
     ReadWildcard(_, name) -> <id>
     where <is-substring(!prefix)> name
+      
+  index-is-unresolved(|x, uri) = Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  index-add-unresolved(|x, uri) = (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
   
-  /** @internal */  
-  store-wildcard-read(|namespace, path, prefix):
-    children -> <id>
-    with
-      if set := <Index-ReadSet> then
-        if 1 := <length> children then
-          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
-          // be handled in the index primitives instead.
-          <iset-add(|Read([namespace | path]))> set
-        else
-          <iset-add(|ReadWildcard([namespace | path], prefix))> set
-        end
-      end
-  
-  /** @internal */    
-  index-is-unresolved(|x, uri) = 
-    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
-  /** @internal */
-  index-add-unresolved(|x, uri) = 
-    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
-  
-  /** @internal */
   index-file-dependent-construct: 
     uri -> <conc> (uses, reads)
     with
-      uses := <index-get-uses-all> Def(uri);
-      reads := <index-get-reads-all> Def(uri)
-  
-  /** @internal */  
-  index-file-dependency-filter = 
-    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+        uses := <index-get-uses-all> Def(uri);
+        reads := <index-get-reads-all> Def(uri)
+    
+  index-file-dependency-filter = ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_, _)
  
-  /** @internal */
   do-adjust-index-lookup(|namespace, path, use, prefix) =
+    // UNDONE: try(origin-term);
     repeat-until(
       prim(\"SSL_EXT_get_parent\", <id>)
     , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
     )
  
-  /** @internal */
   index-select(|namespace, path, use) =
     getfirst(
       where(
@@ -1964,7 +1199,6 @@
       )
     )
  
-  /** @internal */
   index-select-all(|namespace, path, use) =
     filter(
       where(
@@ -1972,50 +1206,36 @@
       )
     )
  
-  /** @internal */
   do-adjusted-index-path(|namespace, path, def) =
     adjust-index-path(origin-equal(|def) |namespace, path)
   <+
     ![def | path]
  
-  /** @internal */
   index-eq(|namespace, expected) =
     where(
       ?Def([_, name | _]);
       <SRTS-EXT-eq-ignore-annos(|expected)> name
     )
   
-  /** @internal */
   external SRTS-EXT-eq-ignore-annos(|t)
-  
-  /** @internal */
-  index-key-unwrap = 
-    \\key{uri} -> key{<index-uri-unwrap> uri}\\ <+ id
-
-/** @internal */
-rules // Interface for generated code
  
-  /** @internal */
+rules // interface for generated code
+ 
   nam-get-def(|namespace):
     x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
-  
-  /** @internal */ 
+   
   nam-annotate-use(|namespace):
     t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
-  
-  /** @internal */ 
+   
   nam-get-scope-types = fail
-  /** @internal */
   nam-get-definition = fail
-  /** @internal */
   nam-get-definition-key = fail
-  /** @internal */
   nam-annotate-names(|def-path) = fail
 "
 
   create-compilation-library =
-	try(<file-exists <+ mkdir> "lib");
-	<output-text-file(|["lib"], "compilation-library.generated.str")>
+  try(<file-exists <+ mkdir> "lib");
+  <output-text-file(|["lib"], "compilation-library.generated.str")>
 "module lib/compilation-library.generated
 
 imports
@@ -2025,181 +1245,138 @@
   lib/analysis-library.generated
   
 rules // Extension points
-  
-  /**
-   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
-   *
-   * Extension example:
-   *   index-desugar-ast:
-   *     ast -> <desugar> ast
-   *
-   * @type ast -> ast'
-   */
-  index-desugar-ast = fail
     
-  /**
-   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
-   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
-   * compilation.
-   *
-   * Extensions example:
-   *   index-compile-ast(|file, subfile):
-   *     ast -> None()
-   *     with
-   *       java := <to-java> ast;
-   *       full-path := <dirname> file;
-   *       filename := <guarantee-extension(|\"java\")> <base-filename> file;
-   *       writePath := $[[full-path]/java/];
-   *       writeFile :=  $[[writePath][filename]];
-   *       try(<mkdir> writePath);
-   *       <fclose> <fputs> (java, <fopen> (writeFile, \"w\"))
-   *
-   * @param file    The file that must be compiled.
-   * @param subfile The subfile that must be compiled (\"\" if there is no subfile).
-   * @type ast -> None()
-   */
-  index-compile-ast(|file, subfile) = fail
+  // Should compile given analysed ast.
+  index-compile-ast(|file, subfile, project-path) = fail
   
 rules // Compilation
   
-  /**
-   * Schedules compilation in the background of all files that have changed since the last compilation.
-   *
-   * @type x -> x
-   */
   index-schedule-compilation:
-    _ -> None()
+    <with(?(_, _, _) | \"(ast, path, project-path) tuple expected\")> -> None()
     with
-      queue-strategy(|\"index-compilation\", \"Compiling files\")
-  
-  /** @internal */
+      queue-strategy(|\"index-compilation\", \"Compiling!\")
+    
   index-compilation:
-    language -> None()
+    (ast, path, project-path) -> <index-compilation(|path, project-path)> ast
+  
+  index-compilation(|path, project-path):
+    ast -> None()
     with
       // Init
-      project-path := <project-path>;
-      index-setup(|language, [project-path], \".\")
+      full-path := $[[project-path]/[path]];
+      language  := <index-origin-language> ast;
+      index-setup(|language, [project-path], full-path)
     with
-      // Determine the files to compile by looking at changed files
-      diffs         := <analyze-get-compilediffs>;
+      // Determine the files to compile by looking at changed files.
+      diffs         := <analyze-get-diffs>;
       files         := <map(index-compilation-restore-read-file)> diffs;
       filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
       
-      // Clean compile time reads
+      // Clean compile time reads.
       <filter(index-compilation-clean-reads)> filteredFiles;
       
-      // Set total work units to number of files to compile for visual indication
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles;
+      
+      // Clean diffs
+      analyze-clean-diff
 
-  /** @internal */
   index-compilation-file(|language, project-path):
-    (path, subfile) -> None()
+    (file, subfile) -> None()
     with
       // Parse and analyze ast.
-      ast                              := <parse-file> path;
-      ast'                             := <try(index-desugar-ast)> ast;
-      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
+      ast                                 := <parse-file> file;
+      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|Compile(), language, file)> (ast, file, project-path)
     with
       {| Index-ReadSet:
         readSet := <new-iset>;
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <index-compile-ast(|path, subfile)> ast'';
+        <index-compile-ast(|file, subfile, project-path)> ast';
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;
-        <index-add-all(|<index-compilation-file-tuple> (path, subfile))> reads
+        <index-add-all(|<index-compilation-file-tuple> (file, subfile))> reads
       |}
 
-  /** @internal */
-  index-compilation-filter-file:
-    (file, subfile) -> (file, subfile)
-    where
-      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
+  index-compilation-filter-file = 
+    ?(<id>, _); (is-test-file <+ index-is-fake-file <+ not(file-exists))
+
+rules // Compile time reads
+
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
+    with
+      file' := <string-replace(|<index-compilation-read-path>, \"\")> file
+      
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+      
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  index-compilation-read-path =
+    !\"/.internal/reads/compile\"
+    
+signature constructors // On save handling
+
+  CommitAndCompile : List(UriPart) -> Summary
+  CommitAndCompile : Namespace
     
 rules // On save handling
   
-  /**
-   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
-   *
-   * @see trigger-commit-and-compile
-   *
-   * @internal
-   */
   commit-and-compile:
-    language -> None()
+    (_, path, project-path) -> <id>
     with
       index-commit
     with
       index-schedule-compilation
-
-  /**
-   * Triggers commit and compilation, requires target language as current term.
-   * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
-   * enable-commit-and-compile is called.
-   *
-   * @type language -> ?language
-   *
-   * @see enable-commit-and-compile
-   * @see disable-commit-and-compile
-   */
-  trigger-commit-and-compile:
-    language -> <id>
+  
+  index-on-save:
+    (ast, _, _, path, project-path) -> None()
     with
-      if not(index-is-global-enabled(|\"delay-compile\")) then
-        commit-and-compile
+      if 0 := <analysis-count> then
+        disable-commit-and-compile;
+        <commit-and-compile> (ast, path, project-path)
       else
-        index-enable-global(|\"trigger-compile\")
+        enable-commit-and-compile
+      end
+      
+  post-analyze-top(|phase, language, full-path):
+    _ -> <id>
+    with
+      if Editor() := phase then 
+          scheduledAnalyses := <analysis-count>
+      else
+        scheduledAnalyses := -1
       end
-  
-  /**
-   * Delays commit and compilation until enable-commit-and-compile is called.
-   *
-   * @type x -> x
-   *
-   * @see enable-commit-and-compile
-   */
-  disable-commit-and-compile = 
-    index-enable-global(|\"delay-compile\")
-  
-  /**
-   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
-   * is triggered now.
-   *
-   * @type x -> x
-   *
-   * @see disable-commit-and-compile
-   */
-  enable-commit-and-compile:
-    language -> <id>
     with
-      if index-is-global-enabled(|\"trigger-compile\") then
+      if 0 := scheduledAnalyses; check-commit-and-compile then
+        disable-commit-and-compile;
         commit-and-compile
-      end;
-      index-disable-global(|\"delay-compile\")
+      end
       
-/** @internal */
-rules // Compile time reads
-
-  /** @internal */
-  index-compilation-restore-read-file:
-    (file, subfile) -> (file', subfile)
+  analysis-count = 
+    prim(\"SSL_EXT_queue_analysis_count\")
+      
+  enable-commit-and-compile:
+    _ -> <id>
     with
-      file' := <string-replace(|<index-compilation-read-path>, \"\")> file
+      <index-add-all(|<index-commit-and-compile-path>)> [CommitAndCompile([CommitAndCompile(), \".internal\"])]
       
-  /** @internal */
-  index-compilation-clean-reads = 
-    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+  disable-commit-and-compile:
+    _ -> <id>
+    with
+      <index-clear-file> <index-commit-and-compile-path>
       
-  /** @internal */
-  index-compilation-file-tuple:
-    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
-    
-  /** @internal */
-  index-compilation-read-path =
-    !\"/.internal/reads/compile\"
+  check-commit-and-compile:
+    _ -> <id>
+    where
+        <index-get> CommitAndCompile([CommitAndCompile(), \".internal\"])
+      
+  index-commit-and-compile-path =
+    !\"/.internal/commit-and-compile\"
 "
\ No newline at end of file


From gabrielkonat at gmail.com  Tue May  8 16:32:10 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 14:32:10 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24810 - in
	spoofax-contrib/separate-compilation-examples:
	c-without-macros/trans csharp-partial-classses/trans
	entity-with-aspects/trans
Message-ID: <20120508143210.E92C62B8005@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  8 14:32:09 2012
New Revision: 24810
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24810&sc=1

Log:
Fix broken examples.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/analysis-manual.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Tue May  8 14:32:09 2012	(r24810)
@@ -8,6 +8,7 @@
   lib/analysis-auto.generated
   lib/index-library
   lib/analysis-library
+  lib/analysis-library-internal
   lib/compilation-library
   check
   desugar

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Tue May  8 14:32:09 2012	(r24810)
@@ -4,6 +4,7 @@
  
   include/C-without-macros
   lib/analysis-library
+  lib/analysis-library-internal
  
 rules
  

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Tue May  8 14:32:09 2012	(r24810)
@@ -8,6 +8,7 @@
   lib/analysis-auto.generated
   lib/index-library
   lib/analysis-library
+  lib/analysis-library-internal
   lib/compilation-library
   check
   generate

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Tue May  8 14:32:09 2012	(r24810)
@@ -4,6 +4,7 @@
  
   include/CSharpPartialClassses
   lib/analysis-library
+  lib/analysis-library-internal
  
 rules
  

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/analysis-manual.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/analysis-manual.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/analysis-manual.str	Tue May  8 14:32:09 2012	(r24810)
@@ -5,6 +5,7 @@
   lib/analysis-auto.generated
   lib/index-library
   lib/analysis-library
+  lib/analysis-library-internal
   types
 
 rules // Adjust lookup

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Tue May  8 14:32:09 2012	(r24810)
@@ -8,6 +8,7 @@
   lib/analysis-auto.generated
   lib/index-library
   lib/analysis-library
+  lib/analysis-library-internal
   lib/compilation-library
   check
   generate

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate-test.str	Tue May  8 14:32:09 2012	(r24810)
@@ -7,7 +7,8 @@
   lib/editor-common.generated
   lib/analysis-auto.generated
   lib/index-library
-  lib/analysis-library
+  lib/analysis-library
+  lib/analysis-library-internal
   types
 
 rules // Constants

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Tue May  8 14:14:15 2012	(r24809)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Tue May  8 14:32:09 2012	(r24810)
@@ -4,6 +4,7 @@
  
   include/EntityWithAspects
   lib/analysis-library
+  lib/analysis-library-internal
  
 rules
   

From gabrielkonat at gmail.com  Tue May  8 16:57:51 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 08 May 2012 14:57:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24811 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120508145751.5323A2B8005@mx2.tudelft.nl>

Author: gkonat
Date: Tue May  8 14:57:49 2012
New Revision: 24811
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24811&sc=1

Log:
Added missing import.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 14:32:09 2012	(r24810)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May  8 14:57:49 2012	(r24811)
@@ -5,6 +5,7 @@
   lib/editor-common.generated
   lib/index-library
   lib/analysis-library
+  lib/analysis-library-internal
   
 rules // Extension points
   

From lennart at lclnet.nl  Tue May  8 22:55:18 2012
From: lennart at lclnet.nl (Lennart Kats)
Date: Tue, 08 May 2012 20:55:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24812 - in hydra: jobs
	strategoxt
Message-ID: <20120508205518.AB143108C008@mx3.tudelft.nl>

Author: LennartKats
Date: Tue May  8 20:55:16 2012
New Revision: 24812
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24812&sc=1

Log:
update notification email addresses

Modified:
   hydra/jobs/spoofax-imp-release.nix
   hydra/jobs/spoofax-imp.nix
   hydra/strategoxt/packages.nix

Modified: hydra/jobs/spoofax-imp-release.nix
==============================================================================
--- hydra/jobs/spoofax-imp-release.nix	Tue May  8 14:57:49 2012	(r24811)
+++ hydra/jobs/spoofax-imp-release.nix	Tue May  8 20:55:16 2012	(r24812)
@@ -279,7 +279,7 @@
       '';
 
        __noChroot = true;
-       meta.maintainers = ["l.c.l.kats at tudelft.nl" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com"];
+       meta.maintainers = ["lclkats at gmail.com" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com" "g.h.wachsmuth at tudelft.nl"];
      } ;     
   } ;
 

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Tue May  8 14:57:49 2012	(r24811)
+++ hydra/jobs/spoofax-imp.nix	Tue May  8 20:55:16 2012	(r24812)
@@ -335,7 +335,7 @@
       '';
 
        __noChroot = true;
-       meta.maintainers = ["l.c.l.kats at tudelft.nl" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com" "karltk at strategoxt.org"];
+       meta.maintainers = ["lclkats at gmail.com" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com" "karltk at strategoxt.org" "g.h.wachsmuth at tudelft.nl"];
      } ;     
   } ;
 

Modified: hydra/strategoxt/packages.nix
==============================================================================
--- hydra/strategoxt/packages.nix	Tue May  8 14:57:49 2012	(r24811)
+++ hydra/strategoxt/packages.nix	Tue May  8 20:55:16 2012	(r24812)
@@ -3,7 +3,7 @@
   rob = "rob.vermaas at gmail.com";
   kalleberg = "karltk at strategoxt.org";
   visser = "e.visser at tudelft.nl";
-  kats = "l.c.l.kats at tudelft.nl";
+  kats = "lclkats at gmail.com";
   pierron = "nicolas.b.pierron at gmail.com";
 
   commonSystemsSupported =

From oskarvanrest at gmail.com  Wed May  9 02:46:44 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 09 May 2012 00:46:44 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24813 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF
Message-ID: <20120509004644.9E4B02B8017@mx2.tudelft.nl>

Author: OskarVanRest
Date: Wed May  9 00:46:42 2012
New Revision: 24813
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24813&sc=1

Log:
Buddy Class Loading

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	Tue May  8 20:55:16 2012	(r24812)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	Wed May  9 00:46:42 2012	(r24813)
@@ -41,3 +41,5 @@
 Bundle-Activator: org.strategoxt.imp.runtime.RuntimeActivator
 Import-Package: org.eclipse.ltk.core.refactoring,
  org.eclipse.ltk.ui.refactoring
+Eclipse-BuddyPolicy: registered
+

From dgroenewegen at gmail.com  Wed May  9 13:18:04 2012
From: dgroenewegen at gmail.com (Danny Groenewegen)
Date: Wed, 09 May 2012 11:18:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24814 - hydra/webdsl
Message-ID: <20120509111804.EA24A2B800C@mx2.tudelft.nl>

Author: dgroenewegen
Date: Wed May  9 11:18:02 2012
New Revision: 24814
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24814&sc=1

Log:
move argument to correct position

Modified:
   hydra/webdsl/tests-separate-compilation.nix

Modified: hydra/webdsl/tests-separate-compilation.nix
==============================================================================
--- hydra/webdsl/tests-separate-compilation.nix	Wed May  9 00:46:42 2012	(r24813)
+++ hydra/webdsl/tests-separate-compilation.nix	Wed May  9 11:18:02 2012	(r24814)
@@ -24,7 +24,7 @@
  
   defaultMaintainters = [ "rob.vermaas at gmail.com" "dgroenewegen at gmail.com" ];
   webdslRelease = import "${webdslSrc}/release.nix" { inherit nixpkgs ; };
-  webdsl = webdslRelease.buildJava { tarball = webdslRelease.tarball { inherit strcJava; webdslsSrc = webdslSrc; } ; } ;
+  webdsl = webdslRelease.buildJava { tarball = webdslRelease.tarball { webdslsSrc = webdslSrc; }; inherit strcJava; } ;
    
   build = appname : src : maintainers :
     pkgs.stdenv.mkDerivation rec {

From andre.s.d.vieira at gmail.com  Wed May  9 15:15:27 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Wed, 09 May 2012 13:15:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24815 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed
Message-ID: <20120509131527.7FFE4CC0DC@mx4.tudelft.nl>

Author: AndreVieira
Date: Wed May  9 13:15:25 2012
New Revision: 24815
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24815&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/AST.aterm	Wed May  9 13:15:25 2012	(r24815)
@@ -0,0 +1 @@
+ApplicationDefs("J",[FullTextAnalyzer([],"J",DualFullTextAnalyzerBodyDef("index",FullTextAnalyzerBodyDef([],Tokenizer("J67",[]),[]),"query",FullTextAnalyzerBodyDef([CharFilter("h",[])],Tokenizer("rz7N2P__",[Argument("Jz","\"\"")]),[TokenFilterNoArgs("X")])))],[StyleSection("X",[StyleVarDeclInit("UK_z01_n9k0",StyleSort("J67"),StyleAdd(StyleAdd(StyleVar("q65_J4u_2LX"),StyleVar("hr38HE55o")),StylePropertyValue(MatchDefinition("lZX36I",[Arg("J",FunctionSort([],SimpleSort("UK_z01_n9k0")))]),StyleProperty("ou")))),StyleVarDecl("MM",StyleSort("X"))]),StyleSection("OL",[])])
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/program.app	Wed May  9 13:15:25 2012	(r24815)
@@ -0,0 +1,24 @@
+application J
+
+analyzer J {
+  index {
+  tokenizer = J67 ( )
+  }
+  query {
+  charfilter = h ( )
+  tokenizer = rz7N2P__ ( Jz = "" )
+  tokenfilter = X
+  }
+}
+
+style
+
+X
+
+const UK_z01_n9k0 : J67 := q65_J4u_2LX + hr38HE55o + lZX36I(J : function ( ) : UK_z01_n9k0).ou ;
+
+const MM : X ;
+
+style
+
+OL
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/k_33720crashed/strategyResult.txt	Wed May  9 13:15:25 2012	(r24815)
@@ -0,0 +1,60 @@
+
+Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	rename_top_0_0
+	log_time_1_1
+	map_toplevel_2_0
+	alltd_1_0
+	rename_0_0
+	rename_0_0
+	rename_action_0_0
+	rename_action_0_0_fragment_1
+	rename_bound_immutable_0_1
+	rename_bound_0_1
+	TopLevelDefineName_0_0
+	dr_lookup_rule_0_2
+	dr_lookup_rule_0_2
+	dr_lookup_rule_1_2
+	dr_lookup_rule_1_2
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'rename-bound'
+           "J"Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	rename_top_0_0
+	log_time_1_1
+	map_toplevel_2_0
+	alltd_1_0
+	rename_0_0
+	rename_0_0
+	rename_action_0_0
+	rename_action_0_0_fragment_1
+	rename_bound_immutable_0_1
+	rename_bound_0_1
+	TopLevelDefineName_0_0
+	dr_lookup_rule_0_2
+	dr_lookup_rule_0_2
+	dr_lookup_rule_1_2
+	dr_lookup_rule_1_2
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'rename-bound'
+           "J"
\ No newline at end of file

From v.vergu at gmail.com  Thu May 10 13:36:32 2012
From: v.vergu at gmail.com (Vlag Vergu)
Date: Thu, 10 May 2012 11:36:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24816 - hydra
Message-ID: <20120510113633.035522B8058@mx2.tudelft.nl>

Author: VladVergu
Date: Thu May 10 11:36:32 2012
New Revision: 24816
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24816&sc=1

Log:
Add a phase that's missing and doesn't show the build result in the build products

Modified:
   hydra/build.nix

Modified: hydra/build.nix
==============================================================================
--- hydra/build.nix	Wed May  9 13:15:25 2012	(r24815)
+++ hydra/build.nix	Thu May 10 11:36:32 2012	(r24816)
@@ -86,7 +86,7 @@
         if specpkgs ? checkSupported then specpkgs.checkSupported else true;
 
       # make check after make install, here in stead of as default in nixbuild
-      phases = "unpackPhase patchPhase configurePhase buildPhase installPhase checkPhase fixupPhase distPhase finalPhase";
+      phases = "initPhase unpackPhase patchPhase configurePhase buildPhase installPhase checkPhase fixupPhase distPhase finalPhase";
 
       meta.maintainers = if specpkgs ? notifyAddresses then specpkgs.notifyAddresses else [] ;
 

From gabrielkonat at gmail.com  Thu May 10 13:50:32 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 10 May 2012 11:50:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24817 -
	spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib
	spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans
	spoofax-imp/trunk/org...
Message-ID: <20120510115032.63943CC074@mx4.tudelft.nl>

Author: gkonat
Date: Thu May 10 11:50:30 2012
New Revision: 24817
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24817&sc=1

Log:
Updated Spoofax project to use newest index libraries.

Added:
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/print-index-libraries.str
Modified:
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str	Thu May 10 11:50:30 2012	(r24817)
@@ -32,6 +32,8 @@
     ast2abox(|[<import-term(include/EntityWithAspects.generated.pp.af)>,
                <import-term(include/EntityWithAspects.pp.af)>]);
     box2text-string(|100)
+    
+  language = !"EntityWithAspects"
 
 strategies
   

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Thu May 10 11:50:30 2012	(r24817)
@@ -15,6 +15,7 @@
   generate-test
   analysis-manual
   splitter
+  print-index-libraries
 
 rules // Analysis
   
@@ -161,31 +162,4 @@
   editor-parallel-analyze:
     files -> None()
     with
-      index-parallel-analyze-files(analyze)
-      
-rules // Print index libraries
-  
-  create-quoted-libraries:
-    (_, _, _, path, project-path) -> None()
-    with
-      files := [$[[project-path]/lib/index-library], $[[project-path]/lib/analysis-library], $[[project-path]/lib/compilation-library]];
-      strings := <map(\file -> (file, <read-text-file> $[[file].str])\)> files;
-      <map(\(file, string) -> <write-lib> ($[[file].generated.str2], string)\)> strings
-      
-  write-lib:
-    (file, string) -> None()
-    with
-      replaces := [
-        ("\\",                       "\\\\"                              ),
-        ("\"",                       "\\\""                              ),
-        ("lib/index-library",        "lib/index-library.generated"       ),
-        ("lib/analysis-library",     "lib/analysis-library.generated"    ),
-        ("lib/compilation-library",  "lib/compilation-library.generated" )
-      ];
-      string' := <list-string-replace> (string, replaces);
-      <fclose> <fputs> (string', <fopen> (file, "w"))
-      
-  list-string-replace:
-    (string, replaces) -> string'
-    with
-      string' := <foldl(\((r, w), str) -> <string-replace(|r, w)> str\)> (replaces, string)
+      index-parallel-analyze-files(analyze)
\ No newline at end of file

Added: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/print-index-libraries.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/print-index-libraries.str	Thu May 10 11:50:30 2012	(r24817)
@@ -0,0 +1,33 @@
+module print-index-libraries
+
+imports
+  libstratego-lib
+
+rules // Print index libraries
+  
+  create-quoted-libraries:
+    (_, _, _, path, project-path) -> None()
+    with
+      files := [$[[project-path]/lib/index-library], $[[project-path]/lib/analysis-library], 
+        $[[project-path]/lib/analysis-library-internal], $[[project-path]/lib/compilation-library]];
+      strings := <map(\file -> (file, <read-text-file> $[[file].str])\)> files;
+      <map(\(file, string) -> <write-lib> ($[[file].generated.str2], string)\)> strings
+      
+  write-lib:
+    (file, string) -> None()
+    with
+      replaces := [
+        ("\\",                            "\\\\"                                    ),
+        ("\"",                            "\\\""                                    ),
+        ("lib/index-library",             "lib/index-library.generated"             ),
+        ("lib/analysis-library-internal", "lib/analysis-library-internal.generated" ),
+        ("lib/analysis-library",          "lib/analysis-library.generated"          ),
+        ("lib/compilation-library",       "lib/compilation-library.generated"       )
+      ];
+      string' := <list-string-replace> (string, replaces);
+      <fclose> <fputs> (string', <fopen> (file, "w"))
+      
+  list-string-replace:
+    (string, replaces) -> string'
+    with
+      string' := <foldl(\((r, w), str) -> <string-replace(|r, w)> str\)> (replaces, string)
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	Thu May 10 11:50:30 2012	(r24817)
@@ -150,6 +150,7 @@
     create-analysis-auto-placeholder;
     create-index-library;
     create-analysis-library;
+    create-analysis-internal-library;
     create-compilation-library;
     
     copy-jars;

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str	Thu May 10 11:50:30 2012	(r24817)
@@ -45,6 +45,8 @@
     ast2abox(|[<import-term(include/{sdf-name}.generated.pp.af)>,
                <import-term(include/{sdf-name}.pp.af)>]);
     box2text-string(|100)
+    
+  language = !"{sdf-name}"
 
 strategies
   

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	Thu May 10 11:50:30 2012	(r24817)
@@ -28,59 +28,76 @@
   lib/analysis-auto.generated
   lib/index-library.generated
   lib/analysis-library.generated
+  lib/analysis-library-internal.generated
   lib/compilation-library.generated
   analysis-manual
   check
   generate
   refactor
 
-rules // Main editor interface (defined by editor/{sdf-name}-Builders and -References.esv)
+rules // Analysis
   
-  // Analyzes the current program, returning a tuple with errors, warnings, and notes;
-  // each a list of (term, message) tuples or simply (message) terms.
+  // Analyzes the current program, returning a tuple with the analyzed AST, errors, warnings, notes and
+  // files that should be re-analyzed.
+  analyze:
+    (ast, path, project-path) -> (ast'', errors, warnings, notes, filesToAnalyze')
+    with
+      ast'                    := <id> ast; // Optional AST desugaring
+      (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
+      index-transaction(
+        errors                := <collect-all(constraint-error, conc)> ast'';
+        warnings              := <collect-all(constraint-warning, conc)> ast'';
+        notes                 := <collect-all(constraint-note, conc)> ast''
+      );
+      filesToAnalyze'         := <make-set> <map(index-filepair-to-file)> filesToAnalyze
+
+  // Main entry point for analyzes, called when a single file is opened in the editor.
   editor-analyze:
     (ast, path, project-path) -> (ast', errors, warnings, notes)
     with
       editor-init;
-      ast'     := <analyze-top>;
-      errors   := <collect-all(constraint-error, conc)> ast';
-      warnings := <collect-all(constraint-warning, conc)> ast';
-      notes    := <collect-all(constraint-note, conc)> ast'
-  
-  // Transforms a selection to Java
-  generate-java:
-    (selected, position, ast, path, project-path) -> (filename, result)
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
+      <try(editor-queue-analysis)> filesToAnalyze
+      
+  // Main entry point for analyzes, called when multiple files have changed. 
+  editor-analyze:
+    files -> None()
+    where
+      not(is-tuple)
     with
-      filename := <guarantee-extension(|"java")> path;
-      result   := <to-java> selected
-  
-  // Prints the abstract syntax ATerm of a selection.
-  generate-aterm:
-    (selected, position, ast, path, project-path) -> (filename, result)
+      index-setup(|<language>, [<project-path>], ".");
+      disable-commit-and-compile // Disable compilation during analysis.
     with
-      filename := <guarantee-extension(|"aterm")> path;
-      result   := selected // we just return the input term
+      editor-queue-analysis
+    with
+      // Enable and trigger compilation after all files have been analysed.
+      <enable-commit-and-compile> <language>;
+      <trigger-commit-and-compile> <language>
       
-  // Prints the analyzed abstract syntax ATerm of a selection.
-  generate-analyzed:
-    (selected, position, ast, path, project-path) -> (filename, result)
+  // Called when current file is saved.
+  editor-save:
+    (_, _, _, _, _) -> None()
     with
-      editor-init;
-      filename := <guarantee-extension(|"analyzed.aterm")> path;
-      result   := <analyze-top> (selected, path, project-path)
+      index-setup(|<language>, [<project-path>], ".");
+      <trigger-commit-and-compile> <language>
+
+rules // Editor services
   
   // Resolves a reference when the user control-clicks or presses F3 in the editor.
   editor-resolve:
     (node, position, ast, path, project-path) -> target
     where
-      language  := <index-origin-language> ast;
-      index-setup(|language, [project-path], $[[project-path]/[path]]);
-      target    := <index-lookup> node
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-transaction(
+        target := <index-lookup> node
+      )
 
   // Returns "hover help" information for a particular node in the editor.
   // For references, this rule is invoked using the resolved term.
   editor-hover:
-    (target, position, ast, path, project-path) -> $[Hover help: [<write-to-string> target]]
+    (target, position, ast, path, project-path) -> $[[uriString]]
+    where
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
 
   // Completes an identifier when the user presses control-space
   // (the completion identifier in the AST provides additional context information)
@@ -88,18 +105,72 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      ast'              := <analyze-top> (ast, path, project-path);
-      x                 := <collect-one(?COMPLETION(_))> ast';
-      COMPLETION(name)  := x;
-      (
-        proposals       := <index-lookup-all-levels(|name)> x
-      <+ 
-        proposals       := []
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
       );
-      proposals'        := <map(def-to-name)> proposals
+      proposals' := <map(index-uri-name)> proposals
 
-  def-to-name:
-    Def([namespace, name | _]) -> name
+rules // Debugging
+  
+  // Prints the abstract syntax ATerm of a selection.
+  generate-aterm:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := selected
+      
+  // Prints the analyzed annotated abstract syntax ATerm of a selection.
+  generate-analyzed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      editor-init;
+      filename := <guarantee-extension(|"analyzed.aterm")> path;
+      result   := <analyze-top(|<language>)> (selected, path, project-path)   
+      
+  // Prints the definition annotated abstract syntax ATerm of a selection.
+  generate-deffed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := <analyze-defs(|Anon(), Anon())> selected
+      
+  // Prints the entries in the index of the current file.
+  index-currentfile:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"index.currentfile.aterm")> path;
+      result   := <index-get-all-in-file> path
+      
+  // Prints the entries in the index of all files.
+  index-allfiles:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"index.allfiles.aterm")> path;
+      result   := <map(\filename -> (filename, <index-get-all-in-file> filename)\)> <index-get-all-files>
+      
+  // Cleans all data from the index.
+  index-cleanall:
+    (selected, position, ast, path, project-path)  -> None()
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-clear
+    
+rules // Utility
+  
+  // Queue parallel analysis for given list of files.
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+      
+  // Executes parallel analysis using the index library.
+  editor-parallel-analyze:
+    files -> None()
+    with
+      index-parallel-analyze-files(analyze)
 };
 
 if not(<file-exists> "trans/generate.str") then
@@ -116,7 +187,7 @@
 
 rules // Incremental code generation of project using compilation library.
       
-  index-compile-ast(|file, subfile, project-path):
+  index-compile-ast(|file, subfile):
     ast -> None()
     with
       java := <to-java> ast;
@@ -131,6 +202,9 @@
 rules // Transformation to java strings.
 
   to-java:
+    [_] -> <concat-strings> <map(to-java)>
+
+  to-java:
     Module(x, d*) ->
     $[ package [x];
        

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Thu May 10 11:50:30 2012	(r24817)
@@ -96,18 +96,67 @@
   
   FileEntries : Term * Term -> Term
   
+  // Globals
+  Global : Namespace
+  Global : List(UriPart) -> Summary
+  Global : List(UriPart) * List(Summary) -> Summary
+  
 rules // Index management
    
+  /**
+   * Sets up the index library for given language and project paths.
+   * Must be called once before doing anything with the library.
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   *
+   * @obsolete
+   * @type x -> x
+   */
   index-setup(|language, project-paths) =
     obsolete(!\"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)\");
     index-setup(|language, project-paths, \".\")
     
   /**
-   * Sets up the index library for given language and project paths.
+   * Sets up the index library for given language, project paths and current file.
    * Must be called once before doing anything with the library.
+   *
+   * Example:
+   *   <index-setup(|\"MiniJava\", [<project-path>], \"test/test.mjv\")
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
+   *                      Can also be changed later using index-set-current-file.
+   * @type x -> x
    */
   index-setup(|language, project-paths, current-file) =
     prim(\"LANG_index_setup\", language, project-paths, current-file)
+    
+  /**
+   * Sets the current file the index (analysis) is operating on to the given file.
+   *
+   * Example:
+   *   <index-set-current-file> \"fullpath/file.ext\"
+   *   <index-set-current-file> (\"fullpath/file.ext\", \"subfile\")
+   *
+   * @type x -> ?x
+   */
+  index-set-current-file = 
+    prim(\"LANG_index_set_current_file\", <id>)
+
+  /**
+   * Adds given element to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add(|\"fullpath/file.ext\")> Def([Entity(), \"Bar\"])
+   *   <index-add(|(\"fullpath/file.ext\", \"subfile\"))> Def([Entity(), \"Bar\"])
+   *
+   * @param file  The file (and subfile) to add the element to.
+   * @type x -> ?x
+   */
+  index-add(|file) =
+    prim(\"LANG_index_add\", <id>, file)
 
   /**
    * Adds all given elements to the index with given file path and optionally subfile.
@@ -115,9 +164,25 @@
    * Example:
    *   <index-add-all(|\"fullpath/file.ext\")> [Def([Entity(), \"Bar\"]), ...]
    *   <index-add-all(|(\"fullpath/file.ext\", \"subfile\"))> [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @param file  The file (and subfile) to add the elements to.
+   * @type List(x) -> ?List(x)
    */
   index-add-all(|file) =
-    list-loop(with(prim(\"LANG_index_add\", <id>, file)))
+    list-loop(with(index-add(|file)))
+    
+  /**
+   * Removes given element from the index that is contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove(|\"fullpath/file.ext\")> Def([Entity(), \"Bar\"])
+   *   <index-remove(|(\"fullpath/file.ext\", \"subfile\"))> Def([Entity(), \"Bar\"])
+   * 
+   * @param file  The file (and subfile) to remove the element from.
+   * @type x -> ?x
+   */
+  index-remove(|file) =
+    prim(\"LANG_index_remove\", <id>, file)
     
   /**
    * Removes all given elements from the index that are contained in given file path and optionally subfile.
@@ -125,9 +190,12 @@
    * Example:
    *   <index-remove-all(|\"fullpath/file.ext\")> [Def([Entity(), \"Bar\"]), ...]
    *   <index-remove-all(|(\"fullpath/file.ext\", \"subfile\"))> [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @param file  The file (and subfile) to remove the elements from.
+   * @type List(x) -> ?List(x)
    */
-  index-remove-all(|files) =
-    list-loop(with(prim(\"LANG_index_remove\", <id>, files)))
+  index-remove-all(|file) =
+    list-loop(with(index-remove(|file)))
     
   /**
    * Removes all elements from the index that are contained in given file path and optionally subfile.
@@ -135,38 +203,80 @@
    * Example:
    *   <index-clear-file> \"fullpath/file.ext\"
    *   <index-clear-file> (\"fullpath/file.ext\", \"subfile\")
+   *
+   * @type x -> ?x
    */
   index-clear-file = 
     prim(\"LANG_index_clear_file\", <id>)
     
   /**
    * Clears all elements from the index.
+   *
+   * @type x -> x
    */
   index-clear = 
     prim(\"LANG_index_clear_all\")
    
   /**
    * Commits index to a file on disk.
+   *
+   * @type x -> x
    */
   index-commit = 
-    if not(index-timestamp-get-updates(|\"LANG_index_commit\") => []) then
-      prim(\"LANG_index_commit\");
-      index-timestamp-set-updated(|\"LANG_index_commit\")
-    end
+    prim(\"LANG_index_commit\")
+
+  /**
+   * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
+   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
+   *
+   * @type x -> x
+   */
+  index-start-transaction = 
+    prim(\"LANG_index_start_transaction\")
+  
+  /**
+   * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
+   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
+   * this call.
+   *
+   * @type x -> x
+   */
+  index-end-transaction = 
+    prim(\"LANG_index_end_transaction\")
+  
+  /**
+   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
+   * strategy are thread safe.
+   * 
+   * @param s The strategy to apply.
+   * @type x -> x'
+   *
+   * @see index-start-transaction
+   * @see index-end-transaction
+   */
+  index-transaction(s) = 
+    prim(\"LANG_index_start_transaction\"); s; prim(\"LANG_index_end_transaction\")
   
-rules // Index API
+rules // Index querying
   
   /**
    * Gets the file that the analysis is currently in.
+   *
+   * @type x -> (file, subfile)
+   *
+   * @see index-setup(|language, project-paths, current-file)
+   * @see index-set-current-file
    */
   index-get-current-file =
     prim(\"LANG_index_get_current_file\")
   
   /**
-   * Gets a list of all files and subfile for current project.
+   * Gets a list of all files and subfiles for current project.
    *
    * Example:
-   *   <index-get-all-files> => [\"fullpath/file.ext\", ...]
+   *   <index-get-all-files> => [(\"fullpath/file.ext\", \"subfile\"), ...]
+   *
+   * @type x -> List((file, subfile))
    */   
   index-get-all-files =
     prim(\"LANG_index_all_files\")
@@ -177,6 +287,8 @@
    * Examples:
    *   <index-get-all-in-file> \"fullpath/file.ext\" => [Def([Entity(), \"Bar\"]), ...]
    *   <index-get-all-in-file> (\"fullpath/file.ext\", \"subfile\") => [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file:
     filepath -> entries
@@ -184,10 +296,14 @@
       entries := <prim(\"LANG_index_get_all_in_file\", filepath)>
    
   /**
-   * Gets all index entries for the given file path and optionally subfile.
+   * Gets index entries in some namespace for the given file path and optionally subfile.
    *
    * Example:
    *   <index-get-all-in-file(|Import())> \"fullpath/file.ext\" => [Def([Import(), \"Bar\"]), ...]
+   *   <index-get-all-in-file(|Import())> (\"fullpath/file.ext\", \"subfile\") => [Def([Import(), \"Bar\"]), ...]
+   *
+   * @param namespace Only index entries from this namespace are retrieved.
+   * @type file or (file, subfile) -> List(elem)
    */  
   index-get-all-in-file(|namespace):
     filepath -> entries
@@ -197,29 +313,35 @@
       filter(where(index-uri => [namespace | _]))
     
   /**
+   * Gets the revision of a file and optionally subfile.
+   *
+   * Example:
+   *   <index-get-file-revision> \"fullpath/file.ext\" => 13
+   *   <index-get-file-revision> (\"fullpath/file.ext\", \"subfile\") => 37
+   *
+   * @type file or (file, subfile) -> Int
+   */
+  index-get-file-revision:
+    file -> <prim(\"LANG_index_get_file_revision\", file)>
+    
+  /**
    * Gets the containing files and subfiles of index entry with given template.
    *
    * Example:
    *   <index-get-files-of> Def([Entity(), \"Bar\"]) => [(\"fullpath/file.ext\", \"subfile\"), ...]
+   *
+   * @type template -> List((file, subfile))
    */  
   index-get-files-of:
     template -> <prim(\"LANG_index_get_files_of\", template)>
     
   /**
-   * Gets all index entries (of every file for current project).
-   *
-   * Example:
-   *   <indexlib-get-all-elements> => [Def([Entity(), \"Bar\"]), ...]
-   */
-  indexlib-get-all-elements =
-    // TODO: is there a use case for this? doing this is *expensive*
-    <mapconcat(index-get-all-in-file)> <index-get-all-files>
-    
-  /**
    * Get all index entries that match the given template.
    *
    * Example:
    *   <indexlib-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @type template -> List(elem)
    */
   indexlib-get-all:
     template -> <prim(\"LANG_index_get\", template)>
@@ -227,10 +349,12 @@
   /**
    * Get all values of index entries that match the given template.
    *
-   * @see index-value
-   *
    * Example:
    *   <indexlib-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
    */
   indexlib-get-all-values:
     template -> <map(index-value)> <indexlib-get-all> template
@@ -240,6 +364,8 @@
    *
    * Example:
    *   <indexlib-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
+   *
+   * @type template -> ?elem
    */
   indexlib-get:
     template -> <?[<id>|_]> <indexlib-get-all> template
@@ -247,43 +373,252 @@
   /**
    * Get the value of first index entry that matches the given template, or fail.
    *
-   * @see index-value
-   *
    * Example:
    *   <indexlib-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
    */
   indexlib-get-value:
     template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
- 
+    
+rules // Index globals
+    
   /**
-   * Updates the \"last updated\" timestamp for the given service name.
+   * Gets the 'fake' path where globals are stored in the index.
    *
-   * @see index-get-changes-since-timestamp(|service)
+   * @internal
    */
-  index-timestamp-set-updated(|service) =
-    file := $[/.internal/timestamps/[service]];
-    <index-clear-file> file;
-    prim(\"LANG_index_add\", DefData([Timestamp(), \"timestamps\", \".internal\"], Timestamp(), []), file)
-   
+  index-globals-path = 
+    !\"/.internal/globals\"
+    
   /**
-   * Gets all files with changes since the last time stamp update for the given service name.
+   * Gets the URI where globals are stored in the index for given name or names.
+   *
+   * @internal
+   * @type name or List(name) -> uri
    */
-  index-timestamp-get-updates(|service):
-    _ -> files'
+  index-globals-uri:
+    names -> uri
     with
-      timestampName := $[/.internal/timestamps/[service]];
-      files := <prim(\"LANG_index_get_files_newer_than\", timestampName)>;
-      files' := <remove-all(?(timestampName, _))> files
-
+      if is-list then
+        uri := <concat> [[Global()], names, [\"globals\", \".internal\"]]
+      else
+        uri := [Global(), names, \"global\", \".internal\"]
+      end
+    
   /**
-   * Queries if given index file is a 'fake' file for storing internal data.
+   * Gets the first value in global storage with given name, or fail.
+   *
+   * Example:
+   *   index-get-global(|\"last-compile\") => Timestamp(1334322856)
+   *   index-get-global(|[\"last-compile\", \"file.str\"]) => Timestamp(1334322856)
+   * 
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> ?value
+   */
+  index-get-global(|name):
+    _ -> value
+    where
+      value := <indexlib-get-value> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Gets all values in global storage with given name.
+   *
+   * Example:
+   *   index-get-global(|\"last-compile\") => [Timestamp(1334322856), ...]
+   *   index-get-global(|[\"last-compile\", \"file.str\"]) => [Timestamp(1334322856), ...]
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> List(value)
+   */ 
+  index-get-all-globals(|name):
+    _ -> values
+    with
+      values := <indexlib-get-all-values> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Add value to global storage with given name.
+   *
+   * Example:
+   *   <index-add-global(|\"last-compile\")> Timestamp(1334322856)
+   *   <index-add-global(|[\"last-compile\", \"file.str\"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-add-global(|name):
+    value -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-globals-uri> name, value)
+      
+  /**
+   * Overwrites value in global storage with given value.
+   *
+   * Example:
+   *   <index-set-global(|\"last-compile\")> Timestamp(1334322856)
+   *   <index-set-global(|[\"last-compile\", \"file.str\"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-set-global(|name):
+    value -> <id>
+    with
+      index-clear-global(|name);
+      <index-add-global(|name)> value
+    
+  /**
+   * Removes all values from global storage with given name.
+   *
+   * Example:
+   *   index-clear-global(|\"last-compile\")
+   *   index-clear-global(|[\"last-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-clear-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-globals-uri> name, ())
+      
+  /**
+   * Gets the URI where boolean globals are stored in the index for given name or names.
+   *
+   * @internal
    */
-  index-is-fake-file = string-starts-with(|\"/.internal\")
+  index-boolean-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, [\"boolean\", \"globals\", \".internal\"]]
+      else
+        uri := [Global(), names, \"boolean\", \"global\", \".internal\"]
+      end
+      
+  /**
+   * Sets boolean value true to global boolean storage with given name.
+   *
+   * Example:
+   *   index-enable-global(|\"can-compile\")
+   *   index-enable-global(|[\"can-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-enable-global(|name):
+    _ -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Sets boolean value false to global boolean storage with given name.
+   *
+   * Example:
+   *   index-disable-global(|\"can-compile\")
+   *   index-disable-global(|[\"can-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-disable-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Query for boolean value true in global boolean storage with given name.
+   *
+   * Example:
+   *   index-is-global-enabled(|\"can-compile\")
+   *   index-is-global-enabled(|[\"can-compile\", \"file.str\"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> ?x
+   */   
+  index-is-global-enabled(|name):
+    _ -> <id>
+    where
+      <indexlib-get> Global(<index-boolean-globals-uri> name)
+
+rules // Index utility
+  
+  /**
+   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
+   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
+   * given term.
+   *
+   * Example:
+   *   <index-uri> DefData([Entity(), \"Bar\", \"Baz\"], Type(), TYPE(\"Bar\")) => [Entity(), \"Bar\", \"Baz\"]
+   *
+   * @type elem -> ?uri
+   *
+   * @see index-uri-impl
+   * @see index-uri-generic
+   */ 
+  index-uri = 
+    index-uri-impl <+ index-uri-generic
+  
+  /**
+   * Gets the namespace part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), \"Bar\", \"Baz\"] => Entity()
+   *
+   * @type uri@[namespace|path] -> namespace
+   */ 
+  index-uri-namespace =
+    ?[<id>|_]
+  
+  /**
+   * Gets the path part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), \"Bar\", \"Baz\"] => [\"Bar\", \"Baz\"]
+   *   <index-uri-path> [Entity()] => []
+   *
+   * @type uri@[namespace|path] -> path
+   */ 
+  index-uri-path =
+    ?[_|<id>]
     
   /**
-   * Gets the URI part for given term.
+   * Gets the name part of the given URI or fail if there is no name.
+   *
+   * Example:
+   *   <index-uri-name> [Entity(), \"Bar\", \"Baz\"] => \"Bar\"
+   *   <index-uri-name> [Entity()] => fail
+   *
+   * @type uri@[namespace|[name|restPath]] -> ?name
    */ 
-  index-uri = index-uri-impl <+ index-uri-generic
+  index-uri-name =
+    ?[_|[<id>|_]]
+  
+  /**
+   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
+   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
+   * from the given term.
+   *
+   * Example:
+   *   <index-value> DefData([Entity(), \"Bar\", \"Baz\"], Type(), TYPE(\"Bar\")) => TYPE(\"Bar\")
+   *
+   * @type elem -> ?value
+   *
+   * @see index-value-impl
+   * @see index-value-generic
+   */  
+  index-value = 
+    index-value-impl <+ index-value-generic
+  
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   *
+   * @type x -> ?x
+   */
+  index-is-fake-file = 
+    string-starts-with(|\"/.internal\")
   
   /**
    * Checks if given URI's are equal. Discards anonymous scopes if necessary.
@@ -292,6 +627,8 @@
    *   <index-uri-eq> ([Entity(), Anon(\"a\"), \"Bar\"], [Entity(), Anon(\"b\"), \"Bar\"]) => 
    *     ([Entity(), Anon(\"a\"), \"Bar\"], [Entity(), Anon(\"b\"), \"Bar\"])
    *   <index-uri-eq> ([Entity(), \"Foo\"], [Entity(), \"Bar\"]) => fail
+   *
+   * @type (u1, u2) -> ?(u1, u2)
    */
   index-uri-eq:
     (u1, u2) -> <id>
@@ -299,59 +636,97 @@
       u1' := <index-uri-unwrap> u1;
       u2' := <index-uri-unwrap> u2;
       (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
-
+  
   /**
-   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   * Finds the first key (term{uri} element) for given term, or fail. 
    *
-   * Example:
-   *   <index-key-eq> (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]}) => 
-   *     (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]})
-   *   <index-key-eq> (\"Foo\"{[Entity(), \"Foo\"]}, \"Bar\"{[Entity(), \"Bar\"]}) => fail
-   */      
-  index-key-eq:
-    (k1, k2) -> <id>
+   * @type x -> ?name{uri}
+   */
+  index-find-key:
+    x -> key
     where
-      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
+      key := <collect-one(?_{_})> x
+      
+  /**
+   * Converts a URI to a string.
+   *
+   * Example:
+   *   <index-uri-to-string> [Entity(), \"Bar\", \"Baz\"] => \"Entity://Bar.Baz\"
+   *
+   * @type uri -> str
+   */
+  index-uri-to-string:
+    [ns|path] -> <concat-strings> [nsStr, \"://\", pathStr]
+    with
+      pathStr := <take-until(?Anon(_)); reverse; separate-by(|\".\"); concat-strings> path;
+      nsStr := <?<id>#(_)> ns
   
   /**
-   * Gets the value part for given term.
-   */  
-  index-value = index-value-impl <+ index-value-generic
+   * Converts a file to a string.
+   *
+   * Example:
+   *   <index-file-to-string> \"fullpath/file.ext\" => \"fullpath/file.ext\"
+   *
+   * @type file -> file
+   */
+  index-file-to-string:
+    file -> file
+    where
+      not(<is-tuple> file)
   
   /**
-   * Finds the first key (term{uri} element) for given term, or fail. 
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> (\"fullpath/file.ext\", \"\") => \"fullpath/file.ext\"
+   *
+   * @type (file, \"\") -> file
    */
-  index-find-key:
-    x -> key
+  index-file-to-string:
+    (file, \"\") -> file
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> (\"fullpath/file.ext\", \"subfile\") => \"fullpath/file.ext at subfile\"
+   *
+   * @type (file, subfile) -> str
+   */
+  index-file-to-string:
+    (file, subfile) -> <concat-strings> [file, \"@\", subfile]
     where
-      key := <collect-one(?_{_})> x
+      not(\"\" := subfile)
       
 /** @internal */
 rules // URI and value projections
-    
+  
+  /** @internal */
   index-uri-impl:
     DefData(uri, _, _) -> uri
 
+  /** @internal */
   index-uri-generic:
     term -> <?_#(<?[<id>|_]>)> term
   
+  /** @internal */
   index-value-impl:
     DefData(_, _, value) -> value
     
+  /** @internal */
   index-value-generic:
     term -> <?_#(<?[_, <id>|_]> )> term
      
 /** @internal */ 
 rules // Internal helpers
   
+  /** @internal */
   index-namespace-unwrap =
     \\Unresolved(n) -> n\\ <+ id
     
+  /** @internal */
   index-uri-unwrap =
     \\[ns|xs] -> [<index-namespace-unwrap> ns|xs]\\ <+ id
-    
-  index-key-unwrap = 
-    \\key{uri} -> key{<index-uri-unwrap> uri}\\ <+ id
 "
 
   create-analysis-library =
@@ -361,257 +736,726 @@
  
 imports
   libstratego-lib
+  libstratego-parallel
   lib/editor-common.generated
+  lib/analysis-library-internal.generated
   lib/index-library.generated
  
 signature constructors
  
   // Analyze constructors
-  AnalysedResult : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) -> AnalysedResult
   Editor      : AnalysisPhase
   Compile     : AnalysisPhase
  
   // Index elements
   Def          : List(UriPart) -> Summary
-  Use          : List(UriPart) * List(UriPart) -> Summary
+  Use          : List(UriPart) -> Summary
   BadUse       : List(UriPart) -> Summary
   Read         : List(UriPart) -> Summary
   ReadWildcard : List(UriPart) * String -> Summary
   Diff         : List(UriPart) * List(Summary) -> Summary
-    
-  // Namespaces
-  Diff         : Namespace
-  ASTDiff      : Namespace
   
   // Adjust lookup actions
   StopLookup   : LookupAction
   
-rules // extension points
+rules // Index analysis extension points
  
-  // Should return list of Def(_) and/or [namespace | path] or StopLookup() to stop the lookup
-  adjust-index-lookup(is-use |namespace, path, prefix) = fail
- 
-  // adjust-index-select(|namespace, path, use) = fail // (e.g., for imports)
- 
-  // Should call <store-results> on a (list of) DefData
-  adjust-index-def-data(store-results |namespace, path) = fail
- 
-  // Should return a path
-  adjust-index-path(is-def |namespace, path) = fail
- 
-  // adjust-index-path-from-filesystem(|project-path, path)
-  
   /**
-   * Should define constructors to check for difference during analysis. Defaults to Def constructs.
+   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
+   *
+   * The overriden rule must return a list that contains any of the following items:
+   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
+   *                        use site to this definition.
+   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
+   * 
+   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
+   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
+   * will be used.
+   *
+   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
+   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
+   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
+   * lookups that will always fail anyway.
    *
    * Extension example:
-   *   index-diff-constructors = ?Type(_, _)
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     PropAccess(exp, name) -> properties
+   *     where
+   *       <check-target-name> name
+   *     with
+   *       if TYPE(type{_}) := <type-of> exp then
+   *         properties := <index-lookup-children(|Property(), prefix)> type
+   *       else
+   *         properties := StopLookup()
+   *       end
+   *
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     Var(name) -> [[Var() | path], [Property() | path]]
+   *     where
+   *       <check-target-name> name
+   *
+   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
+   *                            lookup algorithm is looking for.
+   * @param namespace           The namespace of the element that should be looked up.
+   * @param path                The path the lookup algorithm is currently looking at for the element.
+   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
+   *                            full name of the element, but could be a partial prefix during content completion.
+   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
+   */
+  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
+  
+  /** 
+   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
+   * a (list of) data that must be stored in the index.
+   *
+   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
+   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
+   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
+   * rule fail if you are doing a <filter(store-results)> for example.
+   *
+   * Extension example:
+   *   adjust-index-def-data(store-results|namespace, path):
+   *     def -> <store-results> Type([namespace|path], type)
+   *     where
+   *       type := <type-of> def
+   *
+   * @param store-results Call this on the data you want to store in the index.
+   * @param namespace     The namespace of the definition that the rule is being called on.
+   * @param path          The path of the definition that the rule is being called on.
+   * @type def -> fail 
    */
-  index-diff-constructors = ?Def(_)
+  adjust-index-def-data(store-results|namespace, path) = fail
   
   /**
-   * Should compare two index elements and fail if they are not equal.
+   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
+   * use sites. Should return a path that will be assigned to the definition or use site.
    *
    * Extension example:
-     *   index-diff-compare:
-   *     (Type(u1, v1), Type(u2, v2)) -> <id>
+   *   adjust-index-path(check-target-definition|namespace, path):
+   *     Start(_, _) -> [<string-replace(|<project-path>, \"\")> <Fst> <index-get-current-file>]
+   *
+   *
+   * @param check-target-definition 
+   * @param namespace               The namespace that would be given to the current definition or use site.
+   * @param path                    The path that would be given to the current definition or use site.
+   * @type def -> uri@[namespace|path]
+   */
+  adjust-index-path(check-target-definition|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
+   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
+   *
+   * Extension example:
+   *   index-diff-constructors = ?Type(_, _)
+   *
+   * @type a -> ?a
+   *
+   * @see index-diff-compare
+   */
+  index-diff-constructors = 
+    ?Def(_)
+  
+  /**
+   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
+   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
+   * compared.
+   *
+   * Extension example:
+   *   index-diff-compare:
+   *     (Type(u1, v1), Type(u2, v2)) -> <id>
    *     where
    *       <index-uri-eq> (u1, u2);
    *       <eq> (v1, v2)
+   *
+   * @type (a, b) -> ?(a, b)
+   *
+   * @see index-diff-constructors
    */
   index-diff-compare:
     (Def(u1), Def(u2)) -> <id>
     where
        <index-uri-eq> (u1, u2)
-       
-  post-analyze-top(|phase, language, full-path) = fail
  
-rules // analysis traversals
+rules // Analysis traversals
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
-   * Defaults to Editor() phase and tries to automatically determine language name.
+   * Defaults to Editor() phase.
+   *
+   * @param language  The name of the language that is being analysed.
+   *
+   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
    *
    * @see analyze-top(|phase, language)
    */
-  analyze-top = analyze-top(|Editor())
-  
+  analyze-top(|language):
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
+   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
-   * Tries to automatically determine language name.
    *
-   * @see analyze-top(|phase, language)
+   * @param phase         The type of analysis phase. There are 2 phases to choose from:
+   *                      - Editor():   File dependencies are analysed.
+   *                      - Compile():  File dependencies are not analysed.
+   * @param language      The name of the language that is being analysed.
+   * @param path          The path of the file to analyze relative to project-path.
+   * @param project-path  The path of the directory that contains all the source files.
+   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top-internal(|phase, language, project-path, full-path)
    */
-  analyze-top(|phase) = ?(ast, _, _); analyze-top(|phase, <index-origin-language> ast)
-   
+  analyze-top(|phase, language, path, project-path):
+    ast -> (ast', filesToAnalyze)
+    with
+      full-path := $[[project-path]/[path]];
+      if index-split then
+        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
+        asts := <index-toplevel-split> ast;
+        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
+      else
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, \"\"))]
+      end
+  
+rules // Parallel analysis
+  
   /**
-   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
+   * analysis of dependent files that have changed during the analysis.
    *
-   * @param phase     The type of analysis phase. There are currently 2 phases to choose from:
-   *                  - Editor():   All information is stored into the index and dependent files
-   *                                are automatically scheduled for re-analysis.
-   *                  - Compile():  No information is stored and no re-analysis is done.
-   * @param language  The name of the language that is being analysed.
+   * Example:
+   *   <index-parallel-analyze-files(analyze)> [\"text/file1.ext\", \"text/file2.ext\"]
    *
-   * @see analyze-top-internal(|phase, language)
+   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
+   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
+   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @type List((file, subfile) or file) -> None()
    */
-  analyze-top(|phase, language):
-    (ast, path, project-path) -> ast'
+  index-parallel-analyze-files(analyze):
+    files -> None()
     with
-      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|phase, language)> (ast, path, project-path)
+      length; 
+      set-total-work-units
+    with
+      index-parallel-analyze(analyze);
+      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
+ 
+rules // Query primitives
+ 
+  /**
+   * Gets all DefData entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data(|Type())> Def([Entity(), \"Bar\"]) => [DefData([Entity(), \"Bar\"], Type(), TYPE(\"Bar\")), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(DefData(uri, kind, value))
+   */
+  index-get-data(|kind):
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-value> DefData(uri, kind, ())
+      
+  /**
+   * Gets all data entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data-all(|Type())> Def([Entity(), \"Bar\"]) => [TYPE(\"Bar\"), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(value)
+   */
+  index-get-data-all(|kind):
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-all-values> DefData(uri, kind, ())
+     
+  /**
+   * Gets all Use entries that match the URI in given definition.
+   *
+   * Example:
+   *   <index-get-uses-all> Def([Entity(), \"M\", \"Bar\"]) => [Use([Entity(), \"M\", \"Bar\"]), ...]
+   *
+   * @type Def(uri) -> List(Use(uri))
+   */
+  index-get-uses-all:
+    <with(?Def(uri) | \"Def expected\")> -> <index-get-all> Use(uri)
+     
+  /**
+   * Gets all Read or ReadWildcard entries that match the given template.
+   *
+   * Example:
+   *   <index-get-reads-all> [Property(), \"Bar\", \"p\"] => [Read([Property(), \"Bar\", \"p\"]), ...]
+   *
+   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
+   */
+  index-get-reads-all:
+    template -> <conc> (reads, readwildcards')
+    where
+      uri   := <index-uri> template;
+      reads := <index-get-all> Read(uri);
+      if !uri => [namespace, prefix | path-parent] then
+        readwildcards  := <index-get-all> ReadWildcard([namespace | path-parent], ());
+        readwildcards' := <filter(index-readwildcard-substring(|prefix))> readwildcards
+      else
+        readwildcards' := []
+      end
+ 
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  index-get-all:
+    template -> <indexlib-get-all> template
+      with
+       if set := <Index-ReadSet> then
+         uri := <index-uri>;
+         <iset-add(|Read(uri))> set
+       end
+       
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  index-get-all-values:
+    template -> <map(index-value)> <index-get-all> template
+       
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
+   *
+   * @type template -> ?elem
+   */
+  index-get:
+    template -> <?[<id>|_]> <index-get-all> template
+      
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  index-get-value:
+    template -> <index-value> <?[<id>|_]> <index-get-all> template
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field())> Def([Entity(), \"Baz\"]) => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
+   *   <index-get-children(|Field())> \"Foo\"{[Entity(), \"Baz\"]} => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
+   *   <index-get-children(|Field())> [Entity(), \"Baz\"] => [Def([Field(), \"Bar\"]), Def([Field(), \"Foo\"]), ...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace) = 
+    index-get-children(\\uri -> Def(uri)\\|namespace)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | \"Def, key or uri expected\")> -> children
+    with
+      template  := <construct-template> [namespace | path];
+      children  := <prim(\"LANG_index_get_children\", template)>;
+      <store-wildcard-read(|namespace, path, \"\")> children
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field(), \"fo\")> Def([Entity(), \"Baz\"]) => [Def([Field(), \"Foo\"]), ...]
+   *   <index-get-children(|Field(), \"ba\")> \"Foo\"{[Entity(), \"Baz\"]} => [Def([Field(), \"Bar\"]), ...]
+   *   <index-get-children(|Field(), \"ze\")> [Entity(), \"Baz\"] => [...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace, prefix) = 
+    index-get-children(\\uri -> Def(uri)\\|namespace, prefix)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
+   * using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @param prefix              Only child elements where the name starts with this prefix are returned.
+   * @type Def(uri) or \"name\"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace, prefix):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | \"Def, key or uri expected\")> -> children'
+    with
+      prefix'   := <strip-annos> prefix;
+      template  := <construct-template> [namespace | path];
+      children  := <prim(\"LANG_index_get_children\", template)>;
+      children' := <filter(index-is-name-substring(|prefix'))> children;
+      <store-wildcard-read(|namespace, path, prefix')> children'
+
+  /**
+   * Gets a set of all files that have a reference to the given index entries.
+   *
+   * Example:
+   *   <index-get-referenced-files(\\uri -> [Read(uri), Use(uri, [])]\\)> [Def([Entity(), \"Bar\"]), ...] => 
+   *     [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
+   *
+   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
+   *                            constructs from all given entries, such as \\uri -> [Read(uri), Use(uri, [])]\\
+   * @type List(elem) -> List((file, subfile))
+   */
+  index-get-referenced-files(construct-from-uri):
+    entries -> files
+    where
+      uris        := <filter(index-uri)> entries;
+      referenced  := <concat> <filter(construct-from-uri)> uris;
+      files       := <iset-elements> <iset-addlist(|<mapconcat(index-get-files-of)> referenced)> <new-iset>
+ 
+  /**
+   * Convenience function for finding files with Read and Use dependencies to the given definitions.
+   *
+   * Example:
+   *   <index-get-dependent-files> [Def([Entity(), \"Bar\"]), ...] => [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
+   *
+   * @type List(elem) -> List((file, subfile))
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
+   */
+  index-get-dependent-files = 
+    index-get-referenced-files(index-file-dependent-construct)
+     
+rules // Index lookup rules (that take into account adjust-index-lookup)
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning its Def.
+   *
+   * @type \"name\"{uri} -> ?Def(uri')
+   */
+  index-lookup:
+    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   * 
+   * @type \"name\"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all:
+    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> ?Def(uri')
+   */
+  index-lookup-outermost(|prefix):
+    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, returns Defs that have the same parent URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> List(Def(uri'))
+   */
+  index-lookup-one-level(|prefix):
+    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(|prefix):
+    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type \"name\"{uri} -> List(Def(uri'))
+   */
+  index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-one-level(id|namespace, def-path, prefix)> x
+      else
+        defs := <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      end
+    <+
+      defs := []
+      
+rules // Index utilities
+  
+  /**
+   * Gets the namespace part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-namespace> \"Bar\"{[Entity(), \"Bar\", \"Baz\"]} => Entity()
+   *
+   * @type \"name\"{uri@[namespace|path]} -> namespace
+   */
+  index-uri-namespace:
+    x{[namespace|path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   *
+   * Example:
+   *   <index-uri-path> \"Bar\"{[Entity(), \"Bar\", \"Baz\"]} => [\"Bar\", \"Baz\"]
+   *
+   * @type \"name\"{uri@[namespace|path]} -> path'
+   */
+  index-uri-path:
+    x{[namespace|path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+      
+  /**
+   * Gets the name part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-name> \"Bar\"{[Entity(), \"Bar\", \"Baz\"] => \"Bar\"
+   *
+   * @type \"name\"{uri@[namespace|[name|restPath]]} -> name
+   */ 
+  index-uri-name:
+    x{[_|[name|_]]} -> name
+    
+  /**
+   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
+   *
+   * Example:
+   *   <index-uri-name> Def([Entity(), \"Bar\", \"Baz\"]) => \"Bar\"
+   *   <index-uri-name> Type(\"Foo\") => fail
+   *   <index-uri-name> Read([Entity()]) => fail
+   *
+   * @type x -> name
+   */   
+  index-uri-name:
+    x -> <index-uri-name> <index-uri> x
+    where
+      not(<has-annos> x)
+    
+  /**
+   * Determines if a given AST node is a definition site, according to the syntax.
+   *
+   * FIXME: Also succeeds on use sites.
+   *
+   * @type def -> ?def
+   */
+  index-is-definition =
+    where(nam-get-definition-key)
+    
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]}) => 
+   *     (\"Bar\"{[Entity(), \"Bar\"]}, \"Bar\"{[Unresolved(Entity()), \"Bar\"]})
+   *   <index-key-eq> (\"Foo\"{[Entity(), \"Foo\"]}, \"Bar\"{[Entity(), \"Bar\"]}) => fail
+   *
+   * @type (k1, k2) -> ?(k1, k2)
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
+"
+
+	create-analysis-internal-library =
+	  try(<file-exists <+ mkdir> "lib");
+	  <output-text-file(|["lib"], "analysis-library-internal.generated.str")>
+"module lib/analysis-library-internal.generated
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library.generated
+  lib/index-library.generated
+  
+signature constructors
+  
+  // Analysis
+  Results         : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
+  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
+  
+  // Namespaces
+  Diff            : Namespace
+  ASTDiff         : Namespace
+  
+rules // Analysis traversals
   
   /**
    * Analyses given AST and annotates definition and use sites found in the AST with URIs.
    *
    * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
    */
-  analyze-top-internal = 
-    analyze-top-internal(|Editor())
-  analyze-top-internal(|phase) = 
-    ?(ast, path, project-path); analyze-top-internal(|phase, <index-origin-language> ast)
-  analyze-top-internal(|phase, language) = 
-    ?(_, path, project-path); analyze-top-internal(|phase, language, $[[project-path]/[path]])
-  analyze-top-internal(|phase, language, full-path):
-    (ast, path, project-path) -> AnalysedResult(ast5, defs, uses, data', added, removed)
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
     with
       // Init
-      index-setup(|language, [project-path], full-path)
+      index-setup(|language, [project-path], full-path);
+      revision := <index-start-transaction>
     with
-      file := (full-path, \"\"); // TODO: Get subfile or add subfile param.
-        // Store copy of elements for diff and clear file
-      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> file;
-      <index-clear-file> file
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
     with
-      {| Index-ReadSet, Index-UnresolvedSet:
-        readSet := <new-iset>;
+      {| Index-UnresolvedSet:
         unresolvedSet := <new-iset>;
-        
-        rules(Index-ReadSet: _ -> readSet);
         rules(Index-UnresolvedSet: _ -> unresolvedSet);
-       
-        // Add Unresolved annotations, record globals
-        (Some(ast2), defs) := <analyze-defs(|Anon(), Anon())> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
-        <index-add-all(|file)> defs;
-
-        // Find DefData
-        ast3 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast2;
-        data := <origin-track-forced(analyze-tree-data)> ast3;
-        <index-add-all(|file)> data;
-
-        // Resolve an references in DefData (using what we just stored)
-        (data', data-uses) := <analyze-uses> data;
-        <index-remove-all(|file)> data;
-        <index-add-all(|file)> data';
-       
-        // Resolve all unresolved references in the tree
-        (ast4, uses) := <analyze-uses> ast3;
-        <index-add-all(|file)> uses;
         
-        ast5 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast4;
-       
-        // Store reads into the index (if current language is not testing language)
-        if not(<is-test-input(|language)> (ast, path)) then
-          <index-add-all(|file)> <iset-elements> readSet
-        end
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+        (asts, _) := <unzip> astFilePairs4
       |}
     with
+      index-end-transaction
+    with
       // Schedule re-analysis of dependent files (if current file is not testing language file)
       // HACK: Depends on file extension, could be other languages with .spt extension?
-      if Editor() := phase; not(<is-test-file> path) then
-        newElems := <conc> (defs, <filter(index-diff-constructors)> data');
+      if Editor() := phase; not(<is-test-file> full-path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
         
-          // Find added and removed definitions
-          (added, removed) := <analyze-diff> (oldElems, newElems);
-          changed := <conc> (added, removed);
-
-          // Schedule re-analysis of files that depend on added or removed elements
-          <reanalyze-all(|full-path)> changed;
-          
-          // TODO: Move diff stuff to compilation-library somehow.
-          // Store added and removed elements in the index
-          analyze-store-diff(|changed, file, ast)
-        else
-          (added, removed) := ([], [])
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
+        // Store files that have changed in the index
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
       end
     with
-      try(post-analyze-top(|phase, language, full-path))
-
-  analyze-diff:
-    (defs1, defs2) -> (added, removed)
-    with
-      added   := <diff(index-diff-compare)> (defs2, defs1);
-      removed := <diff(index-diff-compare)> (defs1, defs2)
-  
-  reanalyze-all(|file) =
-    index-get-dependent-files; 
-    filter(not(analyze-changed-filter-file(|file)); reanalyze-file)
-    
-  analyze-changed-filter-file(|file) = 
-    ?files@(<id>, _); (is-test-file <+ index-is-fake-file <+ ?file); !files
-    
-  reanalyze-file = 
-    ?(<id>, _); debug(!\"Re-analyzing \"); prim(\"SSL_EXT_queue_analysis\")
-    
-  analyze-store-diff(|changedEntries, file, ast): 
-    _ -> <id>
-    with
-      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
-      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
-      dependentFiles  := <index-get-dependent-files> changedEntries;
-      files := <conc> (changedFiles, dependentFiles);
-      
-      if not(<analyze-astdiff(|ast)> file) then
-        // Add current file if the AST has changed. Cannot use dependency tracking here because
-        // the originating file of a removed definition is not in the index any more.
-        files' := <make-set> [file|files] 
-        else
-            files' := <make-set> files
-        end;
+      <list-loop(analyze-top-store-ast)> astFilePairs4
       
-      if not([] := files') then
-        storePath := <analyze-diff-path>;
-        <map(analyze-add-diff(|storePath))> files'
-      end
-      
-  analyze-add-diff(|storePath):
-    file -> <id>
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
     with
-      <index-add-all(|storePath)> [Diff([Diff(), \".internal\"], file)]
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
       
-  analyze-get-diffs:
-    _ -> diffs
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
     with
-        diffs := <make-set> <index-get-all-values> Diff([Diff(), \".internal\"], ())
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
         
-  // Fails if old ASTDiff is not found or if ASTDiff is different.
-  analyze-astdiff(|ast):
-    (file, subfile) -> <id>
-    where
-      storePath := <analyze-diff-path>;
-        newChecksum := <checksum> ast;
-      if oldChecksum := <index-get-value> Diff([ASTDiff(), file, \".internal\"], ()) then
-        <index-remove-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], ())];
-          <index-add-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], newChecksum)];
-        <eq> (oldChecksum, newChecksum)
-        else
-            <index-add-all(|storePath)> [Diff([ASTDiff(), file, \".internal\"], newChecksum)];
-            fail
+        // Gather all data for each definition.
+        ast2 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
         end
+      |}
       
-  analyze-clean-diff:
-    _ -> <id>
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
     with
-        storePath := <analyze-diff-path>; 
-      <index-remove-all(|storePath)> [Diff([Diff(), \".internal\"], ())]
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
         
-  analyze-diff-path = 
-    !\"/.internal/diff\"
- 
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim(\"SSL_EXT_clone_and_set_parents\", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
   /**
-   * Identifies all definitions in the tree
-   * and annotates them with their URI.
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|[<index-file-to-string> file, \"ast\"])> ast
+      
+  /**
+   * Identifies all definitions in the tree and annotates them with their URI.
    * Also annotates uses with a preliminary \"Unresolved(_)\" URI.
+   *
+   * @internal
    */
+  analyze-defs = analyze-defs(|Anon(), Anon())
+  /** @internal */
   analyze-defs(|head-scope, head-scope-ns):
     ast -> (ast', defs')
     with
@@ -633,7 +1477,8 @@
         (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
       end;
       defs' := <![def | defs] <+ !defs>
- 
+      
+  /** @internal */
   analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
     ast -> (ast'', defs)
     where
@@ -641,6 +1486,7 @@
       (ast', defs)  := <unzip-analyzed> analyzed;
       ast''         := <try(nam-annotate-names(|def-path))> ast'
  
+  /** @internal */
   update-index-path(|head-scope, head-scope-ns, ast):
     scope-type -> scope-type
     where
@@ -670,23 +1516,19 @@
   */
  
   /**
-   * Analyze all uses, changing their preliminary
-   * \"Unresolve(_)\" URI to a definite URI of their definition.
+   * Analyze all uses, changing their preliminary \"Unresolved(_)\" URI to a definite URI of their definition.
+   *
+   * @internal
    */
-  analyze-uses = analyze-uses(|None())
-  analyze-uses(|parent):
+  analyze-uses:
     ast -> (ast'', uses')
     with
-      analyzed     := <all(analyze-uses(|ast))> ast;
+      analyzed     := <all(analyze-uses)> ast;
       (ast', uses) := <unzip-analyzed> analyzed;
       if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
         if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
           ast'' := ast{def-uri};
-          if key{keyUri} := <nam-get-definition-key> parent ; not(<eq>(key, ast')) then
-            uses' := [Use(def-uri, keyUri) | uses]
-          else
-            uses' := [Use(def-uri, [namespace | path]) | uses]
-          end
+          uses' := [Use(def-uri) | uses]
         else
           ast'' := ast';
           uses' := [BadUse([namespace, x]) | uses]
@@ -697,7 +1539,9 @@
       end
  
   /**
-   * Collects all index data (e.g., types of definitions).
+   * Collects all index data (e.g. types of definitions).
+   *
+   * @internal
    */
   analyze-tree-data:
     tree -> data
@@ -705,7 +1549,8 @@
       set := <new-iset>;
       <topdown(analyze-tree-data-part(|set))> tree;
       data := <iset-elements> set
- 
+      
+  /** @internal */
   analyze-tree-data-part(|set):
     tree -> tree
     where
@@ -715,7 +1560,8 @@
           <fatal-err(|\"Unexpected result from adjust-index-def-data; should call <store-results>\")> result
         end
       end
- 
+  
+  /** @internal */
   store-index-data-results(|set):
     t -> <fail>
     where
@@ -724,218 +1570,163 @@
       else
         <iset-add(|t)> set
       end
- 
-  /**
-   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) )
-   * to a tuple (C(a1, a2), [b1, b2, b3]).
-   */
-  unzip-analyzed:
-    appl -> (appl', unzipped-parts)
-    with
-      appl'          := <all(\\(a, _) -> a\\)> appl;
-      unzipped-parts := <concat> <get-appl-arguments(\\(_, b) -> b\\) <+ map(\\(_, b) -> b\\) <+ ![]> appl
- 
-rules // index API primitives
- 
-  /**
-   * Gets all DefData entries that match the kind of data and URI in given definition.
-   *
-   * @param kind Only data of this kind is returned.
-   *
-   * Example:
-   *   <index-get-data(|Type())> Def([Entity(), \"Bar\"]) => [DefData([Entity(), \"Bar\"], Type(), TYPE(\"Bar\")), ...]
-   */
-  index-get-data(|kind):
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-value> DefData(uri, kind, ())
-      
-    /**
-     * Gets all data entries that match the kind of data and URI in given definition.
-     *
-     * @param kind Only data of this kind is returned.
-     *
-     * Example:
-     *   <index-get-data-all(|Type())> Def([Entity(), \"Bar\"]) => [TYPE(\"Bar\"), ...]
-     */
-  index-get-data-all(|kind):
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-all-values> DefData(uri, kind, ())
-     
-  /**
-   * Gets all Use entries that match the URI in given definition.
-   *
-   * Example:
-   *   <index-get-uses-all> Def([Entity(), \"M\", \"Bar\"]) => [Use([Entity(), \"M\", \"Bar\"], [Entity(), \"M\"]), ...]
-   */
-  index-get-uses-all:
-    <with(?Def(uri) | \"Def expected\")> -> <index-get-all> Use(uri, [])
-     
-  /**
-   * Gets all Read or ReadWildcard entries that match the given template.
-   *
-   * Example:
-   *   <index-get-reads-all> [Property(), \"Bar\", \"p\"] => [Read([Property(), \"Bar\", \"p\"]), ...]
-   */
-  index-get-reads-all:
-    template -> <conc> (reads, readwildcards')
-    where
-      uri   := <index-uri> template;
-      reads := <index-get-all> Read(uri);
-      if !uri => [namespace, prefix | path-parent] then
-        readwildcards  := <index-get-all> ReadWildcard([namespace | path-parent], ());
-        readwildcards' := <filter(index-readwildcard-substring(|prefix))> readwildcards
-      else
-        readwildcards' := []
-      end
- 
-  /**
-   * Get all index entries that match the given template.
-   *
-   * Example:
-   *   <index-get-all> Def([Entity(), \"Bar\"]) => [Def([Entity(), \"Bar\"]), ...]
-   */
-  index-get-all:
-    template -> <indexlib-get-all> template
-      with
-       if set := <Index-ReadSet> then
-         uri := <index-uri>;
-         <iset-add(|Read(uri))> set
-       end
-       
-  /**
-   * Get all values of index entries that match the given template.
-   *
-   * @see index-value
-   *
-   * Example:
-   *   <index-get-all-values> DefData([Property(), \"s\"], Type(), ()) => [TYPE(\"String\"), ...]
-   */
-  index-get-all-values:
-    template -> <map(index-value)> <index-get-all> template
-       
-  /**
-   * Get the first index entry that matches the given template, or fail.
-   *
-   * Example:
-   *   <index-get> Def([Entity(), \"Bar\"]) => Def([Entity(), \"Bar\"])
-   */
-  index-get:
-    template -> <?[<id>|_]> <index-get-all> template
       
-  /**
-   * Get the value of first index entry that matches the given template, or fail.
-   *
-   * @see index-value
-   *
-   * Example:
-   *   <index-get-value> DefData([Entity(), \"Bar\"], Type(), ()) => TYPE(\"Bar\")
-   */
-  index-get-value:
-    template -> <index-value> <?[<id>|_]> <index-get-all> template
-   
-  /**
-   * Gets the namespace part of the URI for given term.
-   */
-  index-namespace:
-    x{[namespace | path]} -> <index-namespace-unwrap> namespace
-
-  /**
-   * Gets the path part of the URI for given term.
-   */
-  index-path:
-    x{[namespace | path]} -> path'
-    where
-      if !namespace => Unresolved(namespace) then
-        Def(path') := <index-lookup>
+rules // Parallel analysis
+  
+  /** @internal */
+  index-parallel-analyze(analyze):
+    files -> allResults
+    with
+      map(index-parse-file); // Parsing cannot be done in parallel.
+      map(\\(ast, file) -> (ast, file, <project-path>)\\);
+      parallel-unordered(all(index-analyze(analyze)));
+      ?results;
+      with(<eq> (<length> results, <length> files) | \"Input size not equal to output size\");
+      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
+      if not([] := filesToAnalyze) then
+        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
       else
-        path' := path
+        allResults := results
       end
-    
-  /**
-   * Determines if a given AST node is a definition site,
-   * according to the syntax.
-   */
-  index-is-definition =
-    where(nam-get-definition-key)
- 
-  /**
-   * Returns all children of a Def.
-   *
-   * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
-   *
-   */
-  index-get-children(|namespace, prefix):
-    <with(?Def([parent-ns | path]) | \"Def expected\")> -> children'
-    with
-      with(not(!namespace => Def(_)) | \"index-get-children interface changed\");
-      prefix'   := <strip-annos> prefix;
-      template  := Def([namespace | path]);
-      children  := <prim(\"LANG_index_get_children\", template)>;
-      children' := <filter(index-is-name-substring(|prefix'))> children;
-      store     := [namespace, prefix' | path];
-      // Store read in index.
-      if set := <Index-ReadSet> then
-        if 1 := <length> children' then
-          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
-          // be handled in the index primitives instead.
-          <iset-add(|Read([namespace, prefix' | path]))> set
-        else
-          <iset-add(|ReadWildcard([namespace | path], prefix'))> set
-        end
+  
+  /** @internal */   
+  index-parse-file:
+    file -> (ast, file)
+    with
+    if <file-exists> file then
+      ast := <parse-file> file
+    else
+      ast := ()
+    end
+   
+  /** @internal */   
+  index-set-markers:
+    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
+    with
+      <set-markers(|ast)> (ast', errors, warnings, notes)
+      
+  /** @internal */
+  index-analyze(analyze):
+    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
+    with
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      if [] := filesToAnalyze then
+        complete-work-unit
+      end
+      
+/** @internal */
+rules // Splitter
+  
+  /** @internal */
+  index-split = fail
+  /** @internal */
+  index-is-toplevel = fail
+  /** @internal */
+  index-is-qualifier = fail
+  /** @internal */
+  index-qualifier-subelements = fail
+  /** @internal */
+  index-create-qualifier(|qualifier) = fail
+  
+  /** @internal */
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  /** @internal */
+  index-toplevel-split-internal:
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, <index-uri> <nam-get-definition-key> node)]
+        otherwise:
+          units := [(node, [])]
       end
+      
+  /** @internal */
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      qualifier := <index-create-qualifier(|node)> elem
 
-  /**
-   * Gets a set of all files that have a reference to the given index entries.
-   *
-   * @param construct-from-uri  Construction strategy that creates a list of reference constructs from all 
-   *                            given entries, such as \\uri -> [Read(uri), Use(uri, [])]\\
+/** @internal */
+rules // Diffs
+  
+  /** @internal */
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+    
+  /** @internal */
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
+    with
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      
+      // Files to analyze
+      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
+      analyzeFiles' := analyzeFiles;
+      
+      // Files to compile
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      <map(analyze-add-compilediff)> compileFiles
+      
+  /** 
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
    *
-   * Example:
-   *   <index-get-referenced-files(\\uri -> [Read(uri), Use(uri, [])]\\)> [Def([Entity(), \"Bar\"]), ...] => 
-   *     [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
+   * @internal
    */
-  index-get-referenced-files(construct-from-uri):
-    entries -> files
+  analyze-astdiff:
+    (ast, file) -> file
     where
-      uris        := <filter(index-uri)> entries;
-      referenced  := <concat> <filter(construct-from-uri)> uris;
-      files       := <make-set> <mapconcat(index-get-files-of)> referenced
- 
-  /**
-   * Convenience function for finding files with Read and Use dependencies to the given definitions.
-   *
-   * @see index-get-referenced-files(construct-from-uri)
-   * @see index-file-dependent-construct
+      name := [<index-file-to-string> file, \"ast-checksum\"];
+      newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-global(|name)> then
+        <index-set-global(|name)> newChecksum;
+        not(<eq> (oldChecksum, newChecksum))
+      else
+        <index-set-global(|name)> newChecksum
+      end
+      
+  /** 
+   * Adds given file to the list of files to compile.
    *
-   * Example:
-   *   <index-get-dependent-files> [Def([Entity(), \"Bar\"]), ...] => [(\"fullpath/otherfile.ext\", \"subfile\"), ...]
-   */
-  index-get-dependent-files = 
-    index-get-referenced-files(index-file-dependent-construct)
-     
-rules // index lookup rules (take into account adjust-index-lookup)
- 
-  /**
-   * Given an annotated AST node, resolves it, returning its Def.
+   * @internal
    */
-  index-lookup:
-    x{[namespace | path]} -> <index-lookup(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
- 
-  /**
-   * Given an annotated AST node, resolves it, returning all its Defs.
+  analyze-add-compilediff = index-add-global(|\"compile-diff\")
+  
+  /** 
+   * Gets the list of files to compile, and then clear it.
+   *
+   * @internal
    */
-  index-lookup-all:
-    x{[namespace | path]} -> <index-lookup-all(id |<index-namespace-unwrap> namespace, path, <strip-annos> x)>
- 
+  analyze-get-compilediffs = index-get-all-globals(|\"compile-diff\"); index-clear-global(|\"compile-diff\")
+  
+rules // Index lookup rules (that take into account adjust-index-lookup)
+  
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
    * @internal
+   * @type \"name\"{uri} -> ?Def(uri')
    */
-  index-lookup(is-adjust-lookup-enabled |namespace, path, prefix):
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> def
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
@@ -944,47 +1735,38 @@
       else
         def        := <index-select(|namespace, path, x)>
       <+
-          // TODO: optimize: try not to call do-adjust-index-lookup from here
-          [_ | path'] := path;
-          def         := <index-lookup(is-adjust-lookup-enabled |namespace, path', prefix)> x
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
       end
 
   /**
    * Given an annotated AST node, resolves it, returning all its Defs.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
+   * @type \"name\"{uri} -> List(Def(uri'))
    * @internal
    */
-  index-lookup-all(is-adjust-lookup-enabled |namespace, path, prefix):
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
     x -> defs'
     where
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
       defs       := <index-select-all(|namespace, path, x)>;
       // TODO: optimize: try not to call do-adjust-index-lookup from here
       if [_ | path'] := path then
-        defs2 := <index-lookup-all(is-adjust-lookup-enabled |namespace, path', prefix)> x;
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
         defs' := <conc> (defs, defs2)
       else
         defs' := defs
       end
- 
-  /**
-   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
-   *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
-   */
-  index-lookup-outermost(|prefix):
-    x{[namespace | path]} -> <index-lookup-outermost(id |<index-namespace-unwrap> namespace, path, prefix)>
- 
+      
   /**
    * Given an annotated AST node, returns the outermost Def with a corresponding URI.
    *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
+   * @type \"name\"{uri} -> ?Def(uri')
    * @internal
    */
   index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
@@ -996,25 +1778,17 @@
     <+
       candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
       def        := <index-select(|namespace, path, x)>
- 
-  /**
-   * Given an annotated AST node, returns a Def that has the same parent URI.
-   *
-   * @param prefix    Only Defs with a name that starts with this
-   *                  string are returned.
-   */
-  index-lookup-one-level(|prefix):
-    x{[namespace | path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
- 
+      
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
    * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   *
+   * @type \"name\"{uri} -> List(Def(uri'))
+   * @internal
    */
-  index-lookup-one-level(is-adjusted-lookup-enabled |namespace, path, prefix):
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
     x{_} -> defs
     with
       is-adjusted-lookup-enabled;
@@ -1031,22 +1805,12 @@
       defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
       
   /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
    *
-   * @param namespace Only Defs with this namespace are returned.
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
-   */
-  index-lookup-all-levels(|prefix):
-    x{[namespace | path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
- 
-  /**
-   * Given an annotated AST node, resolves it, and
-   * returns all possibly matching Defs with a common ancestor URI. 
+   * @param prefix  Only Defs with a name that starts with this string are returned.
    *
-   * @param prefix    Indicates that only Defs with a name that starts with this
-   *                  string are demanded.
+   * @internal
+   * @type \"name\"{uri} -> List(Def(uri'))
    */
   index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
     x{_} -> all-defs
@@ -1056,10 +1820,10 @@
       if ?StopLookup() then
         all-defs := []
       else
-          mapconcat(\\d at Def(p) -> [d]\\
-              <+ \\[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\\
-              <+ fatal-err(|\"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup\"));
-          ?all-defs
+        mapconcat(\\d at Def(p) -> [d]\\
+            <+ \\[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\\
+            <+ fatal-err(|\"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup\"));
+        ?all-defs
       end
     <+
       one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
@@ -1068,130 +1832,145 @@
       else
         all-defs := one-level
       end
- 
-  /** @Deprecated */
-  index-lookup-contained(|namespace, prefix) =
-    obsolete(!\"index-lookup-contained; use index-lookup-children\");
-    index-lookup-children(|namespace, prefix)
-   
-  /** @Deprecated */
-  index-lookup-contained-all-levels(|namespace, name) =
-    obsolete(!\"index-lookup-contained-all-levels; use index-lookup-descendants\");
-    index-lookup-descendants(|namespace, name)
- 
-  /**
-   * Given an annotated AST node, resolves it,
-   * and returns all child Defs of its definition.
-   *
-   * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only child Defs with a name that starts with this
-   *                  string are returned.
-   */
-  index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
-    x{[ns | path]} -> defs
-    with
-      if !ns => Unresolved(_) then
-        Def([_ | def-path]) := <index-lookup>;
-        defs := <index-lookup-one-level(id|namespace, def-path, prefix)> x
-      else
-        defs := <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
-      end
-    <+
-      defs := []
- 
-  /**
-   * Given an annotated AST node, resolves it,
-   * and returns all descendant Defs of its definition.
-   *
-   * @param namespace Only child Defs with this namespace are returned.
-   * @param prefix    Only child Defs with a name that starts with this
-   *                  string are returned.
-   */
-  index-lookup-descendants(|namespace, name):
-    x{[ns | path]} -> defs
-    with
-      if !ns => Unresolved(_) then
-        Def([_ | def-path]) := <index-lookup>;
-        defs := <index-lookup-all-levels(id|namespace, def-path, name)> x
-      else
-        defs := <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, name)>
-      end
-    <+
-      defs := []
-       
+      
 /** @internal */
 rules // URI and value projections
        
+  /** @internal */
   index-uri-impl:
     Def(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
-    Use(uri, _) -> uri
+    Use(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     Read(uri) -> uri
     
+  /** @internal */  
   index-uri-impl:
     x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
  
-  // TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
   index-uri-impl:
     ReadWildcard(uri, _) -> uri
 
+  /** @internal */
   index-value-impl:
     Def(value) -> value
 
+  /** @internal */
   index-value-impl:
-    Use(_, value) -> value
+    Use(value) -> value
 
+  /** @internal */
   index-value-impl:
     Read(value) -> value
-    
+  
+  /** @internal */
   index-value-impl:
     ReadWildcard(_, value) -> value
        
 /** @internal */
 rules // Internal helpers
+
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\\(a, _) -> a\\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\\(_, b) -> b\\) <+ map(\\(_, b) -> b\\) <+ ![]> appl
        
-  index-origin-language = (origin-term <+ id); prim(\"SSL_EXT_origin_language\", <id>)
-       
-  // Tests if the current file is just a testing language input
-  is-test-file = string-ends-with(|\".spt\")
-  is-test-input(|language):
-    (ast, path) -> (ast, path)
-    where
-      <is-test-file> path;
-      not(!language => \"Spoofax-Testing\")
-       
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+    string-ends-with(|\".spt\")
+  /** @internal */
+  is-test-language = 
+    ?\"Spoofax-Testing\"
+  /** @internal */
+  is-test-input(|language, path) = 
+    <is-test-language> language <+ <is-test-file> path
+      
+  /** @internal */
+  fake-file = 
+    is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+    Fst; string-replace(|$[[<project-path>]/], \"\")
+  
+  /** @internal */
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uriStr))
+    with
+      (<index-uri-to-string> uri <+ !\"\") => uriStr
+  
+  /** @internal */     
   index-is-name-substring(|name):
     template -> <id>
     with
       [_, uri-name | _] := <index-uri>
     where
       <is-substring(!name)> uri-name
-      
+   
+  /** @internal */    
   index-readwildcard-substring(|prefix):
     ReadWildcard(_, name) -> <id>
     where <is-substring(!prefix)> name
-      
-  index-is-unresolved(|x, uri) = Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
-  index-add-unresolved(|x, uri) = (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
   
+  /** @internal */  
+  store-wildcard-read(|namespace, path, prefix):
+    children -> <id>
+    with
+      if set := <Index-ReadSet> then
+        if 1 := <length> children then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix))> set
+        end
+      end
+  
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
   index-file-dependent-construct: 
     uri -> <conc> (uses, reads)
     with
-        uses := <index-get-uses-all> Def(uri);
-        reads := <index-get-reads-all> Def(uri)
-    
-  index-file-dependency-filter = ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_, _)
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
  
+  /** @internal */
   do-adjust-index-lookup(|namespace, path, use, prefix) =
-    // UNDONE: try(origin-term);
     repeat-until(
       prim(\"SSL_EXT_get_parent\", <id>)
     , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
     )
  
+  /** @internal */
   index-select(|namespace, path, use) =
     getfirst(
       where(
@@ -1199,6 +1978,7 @@
       )
     )
  
+  /** @internal */
   index-select-all(|namespace, path, use) =
     filter(
       where(
@@ -1206,30 +1986,44 @@
       )
     )
  
+  /** @internal */
   do-adjusted-index-path(|namespace, path, def) =
     adjust-index-path(origin-equal(|def) |namespace, path)
   <+
     ![def | path]
  
+  /** @internal */
   index-eq(|namespace, expected) =
     where(
       ?Def([_, name | _]);
       <SRTS-EXT-eq-ignore-annos(|expected)> name
     )
   
+  /** @internal */
   external SRTS-EXT-eq-ignore-annos(|t)
+  
+  /** @internal */
+  index-key-unwrap = 
+    \\key{uri} -> key{<index-uri-unwrap> uri}\\ <+ id
+    
+/** @internal */
+rules // Interface for generated code
  
-rules // interface for generated code
- 
+  /** @internal */
   nam-get-def(|namespace):
     x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
-   
+  
+  /** @internal */ 
   nam-annotate-use(|namespace):
     t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
-   
+  
+  /** @internal */ 
   nam-get-scope-types = fail
+  /** @internal */
   nam-get-definition = fail
+  /** @internal */
   nam-get-definition-key = fail
+  /** @internal */
   nam-annotate-names(|def-path) = fail
 "
 
@@ -1243,140 +2037,189 @@
   lib/editor-common.generated
   lib/index-library.generated
   lib/analysis-library.generated
+  lib/analysis-library-internal.generated
   
 rules // Extension points
+  
+  /**
+   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
+   *
+   * Extension example:
+   *   index-desugar-ast:
+   *     ast -> <desugar> ast
+   *
+   * @type ast -> ast'
+   */
+  index-desugar-ast = fail
     
-  // Should compile given analysed ast.
-  index-compile-ast(|file, subfile, project-path) = fail
+  /**
+   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
+   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
+   * compilation.
+   *
+   * Extensions example:
+   *   index-compile-ast(|file, subfile):
+   *     ast -> None()
+   *     with
+   *       java := <to-java> ast;
+   *       full-path := <dirname> file;
+   *       filename := <guarantee-extension(|\"java\")> <base-filename> file;
+   *       writePath := $[[full-path]/java/];
+   *       writeFile :=  $[[writePath][filename]];
+   *       try(<mkdir> writePath);
+   *       <fclose> <fputs> (java, <fopen> (writeFile, \"w\"))
+   *
+   * @param file    The file that must be compiled.
+   * @param subfile The subfile that must be compiled (\"\" if there is no subfile).
+   * @type ast -> None()
+   */
+  index-compile-ast(|file, subfile) = fail
   
 rules // Compilation
   
+  /**
+   * Schedules compilation in the background of all files that have changed since the last compilation.
+   *
+   * @type x -> x
+   */
   index-schedule-compilation:
-    <with(?(_, _, _) | \"(ast, path, project-path) tuple expected\")> -> None()
+    _ -> None()
     with
-      queue-strategy(|\"index-compilation\", \"Compiling!\")
-    
-  index-compilation:
-    (ast, path, project-path) -> <index-compilation(|path, project-path)> ast
+      queue-strategy(|\"index-compilation\", \"Compiling files\")
   
-  index-compilation(|path, project-path):
-    ast -> None()
+  /** @internal */
+  index-compilation:
+    language -> None()
     with
       // Init
-      full-path := $[[project-path]/[path]];
-      language  := <index-origin-language> ast;
-      index-setup(|language, [project-path], full-path)
+      project-path := <project-path>;
+      index-setup(|language, [project-path], \".\")
     with
-      // Determine the files to compile by looking at changed files.
-      diffs         := <analyze-get-diffs>;
+      // Determine the files to compile by looking at changed files
+      diffs         := <analyze-get-compilediffs>;
       files         := <map(index-compilation-restore-read-file)> diffs;
       filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
       
-      // Clean compile time reads.
+      // Clean compile time reads
       <filter(index-compilation-clean-reads)> filteredFiles;
       
+      // Set total work units to number of files to compile for visual indication
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles;
-      
-      // Clean diffs
-      analyze-clean-diff
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
 
+  /** @internal */
   index-compilation-file(|language, project-path):
-    (file, subfile) -> None()
+    (path, subfile) -> None()
     with
       // Parse and analyze ast.
-      ast                                 := <parse-file> file;
-      AnalysedResult(ast', _, _, _, _, _) := <analyze-top-internal(|Compile(), language, file)> (ast, file, project-path)
+      ast                              := <parse-file> path;
+      ast'                             := <try(index-desugar-ast)> ast;
+      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
     with
       {| Index-ReadSet:
         readSet := <new-iset>;
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <index-compile-ast(|file, subfile, project-path)> ast';
+        <try(index-compile-ast(|path, subfile))> ast'';
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;
-        <index-add-all(|<index-compilation-file-tuple> (file, subfile))> reads
+        <index-add-all(|<index-compilation-file-tuple> (path, subfile))> reads
       |}
 
-  index-compilation-filter-file = 
-    ?(<id>, _); (is-test-file <+ index-is-fake-file <+ not(file-exists))
-
-rules // Compile time reads
-
-  index-compilation-restore-read-file:
-    (file, subfile) -> (file', subfile)
-    with
-      file' := <string-replace(|<index-compilation-read-path>, \"\")> file
-      
-  index-compilation-clean-reads = 
-    ?(file, subfile); index-compilation-file-tuple; index-clear-file
-      
-  index-compilation-file-tuple:
-    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
-    
-  index-compilation-read-path =
-    !\"/.internal/reads/compile\"
-    
-signature constructors // On save handling
-
-  CommitAndCompile : List(UriPart) -> Summary
-  CommitAndCompile : Namespace
+  /** @internal */
+  index-compilation-filter-file:
+    (file, subfile) -> (file, subfile)
+    where
+      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
     
 rules // On save handling
   
+  /**
+   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
+   *
+   * @see trigger-commit-and-compile
+   *
+   * @internal
+   */
   commit-and-compile:
-    (_, path, project-path) -> <id>
+    language -> None()
     with
       index-commit
     with
       index-schedule-compilation
-  
-  index-on-save:
-    (ast, _, _, path, project-path) -> None()
-    with
-      if 0 := <analysis-count> then
-        disable-commit-and-compile;
-        <commit-and-compile> (ast, path, project-path)
-      else
-        enable-commit-and-compile
-      end
-      
-  post-analyze-top(|phase, language, full-path):
-    _ -> <id>
-    with
-      if Editor() := phase then 
-          scheduledAnalyses := <analysis-count>
-      else
-        scheduledAnalyses := -1
-      end
+
+  /**
+   * Triggers commit and compilation, requires target language as current term.
+   * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
+   * enable-commit-and-compile is called.
+   *
+   * @type language -> ?language
+   *
+   * @see enable-commit-and-compile
+   * @see disable-commit-and-compile
+   */
+  trigger-commit-and-compile:
+    language -> <id>
     with
-      if 0 := scheduledAnalyses; check-commit-and-compile then
-        disable-commit-and-compile;
+      if not(index-is-global-enabled(|\"delay-compile\")) then
         commit-and-compile
+      else
+        index-enable-global(|\"trigger-compile\")
       end
-      
-  analysis-count = 
-    prim(\"SSL_EXT_queue_analysis_count\")
-      
+  
+  /**
+   * Delays commit and compilation until enable-commit-and-compile is called.
+   *
+   * @type x -> x
+   *
+   * @see enable-commit-and-compile
+   */
+  disable-commit-and-compile = 
+    index-enable-global(|\"delay-compile\")
+  
+  /**
+   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
+   * is triggered now.
+   *
+   * @type x -> x
+   *
+   * @see disable-commit-and-compile
+   */
   enable-commit-and-compile:
-    _ -> <id>
-    with
-      <index-add-all(|<index-commit-and-compile-path>)> [CommitAndCompile([CommitAndCompile(), \".internal\"])]
-      
-  disable-commit-and-compile:
-    _ -> <id>
+    language -> <id>
     with
-      <index-clear-file> <index-commit-and-compile-path>
+      if index-is-global-enabled(|\"trigger-compile\") then
+        commit-and-compile
+      end;
+      index-disable-global(|\"delay-compile\")
       
-  check-commit-and-compile:
-    _ -> <id>
+/** @internal */
+rules // Compile time reads
+
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
+    where
+      file' := <string-replace(|<index-compilation-read-path>, \"\")> file
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file, subfile)
     where
-        <index-get> CommitAndCompile([CommitAndCompile(), \".internal\"])
+      not(<string-replace(|<index-compilation-read-path>, \"\")> file)
       
-  index-commit-and-compile-path =
-    !\"/.internal/commit-and-compile\"
+  /** @internal */
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+      
+  /** @internal */
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  /** @internal */
+  index-compilation-read-path =
+    !\"/.internal/reads/compile\"
 "
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	Thu May 10 11:50:30 2012	(r24817)
@@ -44,7 +44,7 @@
           input
           	identifier: "new name" = ""
           ~~
-          on save: index-on-save
+          on save: editor-save
       ]|
     );
     

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Thu May 10 11:36:32 2012	(r24816)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Thu May 10 11:50:30 2012	(r24817)
@@ -171,8 +171,13 @@
   /** @internal */
   index-compilation-restore-read-file:
     (file, subfile) -> (file', subfile)
-    with
+    where
       file' := <string-replace(|<index-compilation-read-path>, "")> file
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file, subfile)
+    where
+      not(<string-replace(|<index-compilation-read-path>, "")> file)
       
   /** @internal */
   index-compilation-clean-reads = 

From gabrielkonat at gmail.com  Thu May 10 14:17:15 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 10 May 2012 12:17:15 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24818 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language
Message-ID: <20120510121715.A3E577F8064@mx1.tudelft.nl>

Author: gkonat
Date: Thu May 10 12:17:15 2012
New Revision: 24818
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24818&sc=1

Log:


Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexManager.java
==============================================================================

From gabrielkonat at gmail.com  Thu May 10 14:33:41 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 10 May 2012 12:33:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24819 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120510123341.19252CC06A@mx4.tudelft.nl>

Author: gkonat
Date: Thu May 10 12:33:40 2012
New Revision: 24819
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24819&sc=1

Log:


Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May 10 12:17:15 2012	(r24818)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Thu May 10 12:33:40 2012	(r24819)
@@ -183,7 +183,7 @@
           <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
       else
         Results(ast', _, _, _, _, _, filesToAnalyze) := 
-          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, ""))]
       end
   
 rules // Parallel analysis

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Thu May 10 12:17:15 2012	(r24818)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Thu May 10 12:33:40 2012	(r24819)
@@ -91,7 +91,7 @@
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <index-compile-ast(|path, subfile)> ast'';
+        <try(index-compile-ast(|path, subfile))> ast'';
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;

From oskarvanrest at gmail.com  Fri May 11 11:23:20 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Fri, 11 May 2012 09:23:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24820 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <20120511092321.137FB2B8098@mx2.tudelft.nl>

Author: OskarVanRest
Date: Fri May 11 09:23:19 2012
New Revision: 24820
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24820&sc=1

Log:
Buddy Classloading

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-manifest.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-manifest.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-manifest.str	Thu May 10 12:33:40 2012	(r24819)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-manifest.str	Fri May 11 09:23:19 2012	(r24820)
@@ -35,5 +35,6 @@
 Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Bundle-ActivationPolicy: lazy
 Export-Package: ", package, "
+Eclipse-RegisterBuddy: org.strategoxt.imp.runtime
 " // newline required
 )

From oskarvanrest at gmail.com  Fri May 11 11:28:11 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Fri, 11 May 2012 09:28:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24821 -
	experimental/graphical-editor/HUTN
Message-ID: <20120511092811.A5249CC20A@mx4.tudelft.nl>

Author: OskarVanRest
Date: Fri May 11 09:28:11 2012
New Revision: 24821
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24821&sc=1

Log:
Tested out HUTN

Added:
   experimental/graphical-editor/HUTN/

From oskarvanrest at gmail.com  Fri May 11 11:29:18 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Fri, 11 May 2012 09:29:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24822 -
	experimental/graphical-editor/HUTN
Message-ID: <20120511092918.B826F2B807F@mx2.tudelft.nl>

Author: OskarVanRest
Date: Fri May 11 09:29:18 2012
New Revision: 24822
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24822&sc=1

Log:
Tested out HUTN

Added:
   experimental/graphical-editor/HUTN/.project
   experimental/graphical-editor/HUTN/EntityLang-non-unique-names.ecore
   experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore
   experimental/graphical-editor/HUTN/EntityLangModel-non-unique-names.hutn
   experimental/graphical-editor/HUTN/EntityLangModel-unique-names.hutn
   experimental/graphical-editor/HUTN/unique-name-config.model

Added: experimental/graphical-editor/HUTN/.project
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/HUTN/.project	Fri May 11 09:29:18 2012	(r24822)
@@ -0,0 +1,17 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<projectDescription>
+	<name>HUTN</name>
+	<comment></comment>
+	<projects>
+	</projects>
+	<buildSpec>
+		<buildCommand>
+			<name>org.eclipse.epsilon.hutn.dt.builder.HutnBuilder</name>
+			<arguments>
+			</arguments>
+		</buildCommand>
+	</buildSpec>
+	<natures>
+		<nature>org.eclipse.epsilon.hutn.dt.nature.HutnNature</nature>
+	</natures>
+</projectDescription>

Added: experimental/graphical-editor/HUTN/EntityLang-non-unique-names.ecore
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/HUTN/EntityLang-non-unique-names.ecore	Fri May 11 09:29:18 2012	(r24822)
@@ -0,0 +1,32 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ecore:EPackage xmi:version="2.0"
+    xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xmlns:ecore="http://www.eclipse.org/emf/2002/Ecore" name="EntityLangModel-non-unique-names"
+    nsURI="EntityLangModel-non-unique-names" nsPrefix="">
+  <eClassifiers xsi:type="ecore:EClass" name="Module">
+    <eAnnotations source="gmf.diagram"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="definitions" upperBound="-1"
+        eType="#//Entity" containment="true"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Entity" eSuperTypes="#//Type">
+    <eAnnotations source="gmf.node">
+      <details key="label" value="identifier"/>
+    </eAnnotations>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="properties" upperBound="-1"
+        eType="#//Property" containment="true">
+      <eAnnotations source="gmf.compartment"/>
+    </eStructuralFeatures>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Property">
+    <eAnnotations source="gmf.node">
+      <details key="label" value="identifier"/>
+    </eAnnotations>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="type" lowerBound="1" eType="#//Type"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Int" eSuperTypes="#//Type"/>
+  <eClassifiers xsi:type="ecore:EClass" name="String" eSuperTypes="#//Type"/>
+  <eClassifiers xsi:type="ecore:EClass" name="Type" abstract="true"/>
+</ecore:EPackage>

Added: experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore	Fri May 11 09:29:18 2012	(r24822)
@@ -0,0 +1,35 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ecore:EPackage xmi:version="2.0"
+    xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xmlns:ecore="http://www.eclipse.org/emf/2002/Ecore" name="EntityLangModel-unique"
+    nsURI="EntityLangModel-unique" nsPrefix="">
+  <eClassifiers xsi:type="ecore:EClass" name="Module">
+    <eAnnotations source="gmf.diagram"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="definitions" upperBound="-1"
+        eType="#//Entity" containment="true"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Entity" eSuperTypes="#//Type">
+    <eAnnotations source="gmf.node">
+      <details key="label" value="identifier"/>
+    </eAnnotations>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="properties" upperBound="-1"
+        eType="#//Property" containment="true">
+      <eAnnotations source="gmf.compartment"/>
+    </eStructuralFeatures>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Property">
+    <eAnnotations source="gmf.node">
+      <details key="label" value="identifier"/>
+    </eAnnotations>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="type" lowerBound="1" eType="#//Type"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Int" eSuperTypes="#//Type"/>
+  <eClassifiers xsi:type="ecore:EClass" name="String" eSuperTypes="#//Type"/>
+  <eClassifiers xsi:type="ecore:EClass" name="Type" abstract="true"/>
+</ecore:EPackage>

Added: experimental/graphical-editor/HUTN/EntityLangModel-non-unique-names.hutn
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/HUTN/EntityLangModel-non-unique-names.hutn	Fri May 11 09:29:18 2012	(r24822)
@@ -0,0 +1,24 @@
+ at Spec {
+	MetaModel "EntityLang" {
+		nsUri: "EntityLangModel-non-unique-names"
+	}
+}
+
+EntityLangModel-non-unique-names {
+	Module {
+		definitions: 
+			Entity {
+				name = "A"
+				properties:
+					Property "p1" {
+						type = Entity "B1"
+					}
+			}, 
+			Entity "B1" {
+				name = "B"
+			}, 
+			Entity "B2" {
+				name = "B"
+			}
+	}
+}
\ No newline at end of file

Added: experimental/graphical-editor/HUTN/EntityLangModel-unique-names.hutn
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/HUTN/EntityLangModel-unique-names.hutn	Fri May 11 09:29:18 2012	(r24822)
@@ -0,0 +1,22 @@
+ at Spec {
+	MetaModel "EntityLang" {
+		nsUri: "EntityLangModel-unique-names"
+		configFile: "unique-name-config.model"
+	}
+}
+
+EntityLangModel-unique-names {
+	Module {
+		definitions: 
+			Entity "A" {
+				properties:
+					Property "p1" {
+						type = Entity "B"
+					}
+			}, 
+			Entity "B" {
+			}, 
+			Entity "C" {
+			}
+	}
+}
\ No newline at end of file

Added: experimental/graphical-editor/HUTN/unique-name-config.model
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/HUTN/unique-name-config.model	Fri May 11 09:29:18 2012	(r24822)
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="ASCII"?>
+<hutnConfig:Configuration xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:hutnConfig="http://www.eclipse.org/gmt/epsilon/hutnConfig" xmi:id="_b1HjkJtCEeG1pdWABxTMjA">
+  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_dN7woJtCEeG1pdWABxTMjA" classifier="Module" attribute="name"/>
+  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_dmokgJtCEeG1pdWABxTMjA" classifier="Entity" attribute="name"/>
+  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_d4fJgJtCEeG1pdWABxTMjA" classifier="Property" attribute="name"/>
+</hutnConfig:Configuration>

From oskarvanrest at gmail.com  Fri May 11 11:36:29 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Fri, 11 May 2012 09:36:29 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24823 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <20120511093629.CEDDF2B808E@mx2.tudelft.nl>

Author: OskarVanRest
Date: Fri May 11 09:36:29 2012
New Revision: 24823
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24823&sc=1

Log:


Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	Fri May 11 09:29:18 2012	(r24822)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	Fri May 11 09:36:29 2012	(r24823)
@@ -427,7 +427,7 @@
 			Class attachments = descriptor.getAttachmentProvider();
 			Debug.log("Loading JARs from " + Arrays.toString(classpath));
 			Debug.log("Parent class loader: ", attachments.getName() + "; " + attachments.getClassLoader().getClass().getName());
-			// TODO: Use plugin's parent class loader? (Spoofax/322)
+			// Use plugin's parent class loader? (Spoofax/322) => not needed anymore, fixed by Spoofax/522
 			// runtime.loadJars(attachments.getClassLoader(), classpath);
 			runtime.loadJars(getClass().getClassLoader(), classpath);
 			Debug.stopTimer("Successfully loaded " + jars);

From andre.s.d.vieira at gmail.com  Fri May 11 16:02:11 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Fri, 11 May 2012 14:02:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24824 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed
Message-ID: <20120511140211.661AC7F8025@mx1.tudelft.nl>

Author: AndreVieira
Date: Fri May 11 14:02:09 2012
New Revision: 24824
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24824&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/AST.aterm	Fri May 11 14:02:09 2012	(r24824)
@@ -0,0 +1 @@
+ApplicationDefs(Qualified(Qualified("G_130_m_LuS","H_MH_Nn17_H"),"Dk6n8_V8YsL"),[Entity("s86_w13576_","a4T_S",[StaticEntityFunction("x2be_6_AWh7",[Arg("b_L_B___q",SimpleSort("G_130_m_LuS")),Arg("Dx3pC",RefSort(FunctionSort([],[])))],ReturnType(FunctionSort([],[])),Block([ValidateStatement(SearchTimeString(String("'#%o$J& Q% '")),SearchTimeMS(Mod(Null,SetCreation([SearcherRefMod(False,[ConstraintFilter([FacetFilterConstraint(ExternalScopeVar("d4"))]),NamespaceConstraint(ThisCall("Dx3pC",[]))]),EmailFunctionCall(EmailCall("G_130_m_LuS",[SetCreation([Div(Var("x"),GlobalVar("B6397Y_M__")),SearchResultsSize(True)])]))])))),ThrowStatement([SetCreation([TypedSetCreation(RefSort(SimpleSort("Dx3pC")),[ThisCall("x",[SetCreation([ThisCall("b_L_B___q",[])]),Mul(Var("emnY4hFDmO"),EventCall("v4_GI6b_y8D",[EventArg("Dx3pC",ThisCall("x",[True]))]))])]),False]),LargerThanOrEqual(TypedSetCreation(FunctionSort([Arg("jT__ky_Gk_v",SimpleSort("b_L_B___q")),Arg("B6397Y_M__",SimpleSort("x"))],[]),[
 ]),SetCreation([GlobalVar("y8")]))])])),StaticEntityFunction("Dx3pC",[Arg("x2be_6_AWh7",GenericSort("v4_GI6b_y8D",[SimpleSort("A81_xJ")]))],[],Block([ScheduleNoFor(SearcherRefMod(And(EventCall("emnY4hFDmO",[EventArg("n__DY40Y6_0",ForExpNoFilter(ThisCall("s86_w13576_",[]),"G_130_m_LuS",RefSort(SimpleSort("A81_xJ")),ExternalScopeVar("H_MH_Nn17_H")))]),MapCreation([])),[SortBy([SortDef("j8p_",Descending)]),ConstraintFilter([FacetFilterConstraint(SetCreation([GlobalVar("x")])),FacetFilterConstraint(Mod(ExternalScopeVar("d4"),False))])]))]))])],[ACPolicy(PolicyAnd(Name("jT__ky_Gk_v"),Name("jT__ky_Gk_v"))),LayoutSection([LayoutDefinition("h3_GmV7lF7_",MatchDefinition("v",[Arg("Dx3pC",RefSort(GenericSort("G_130_m_LuS",[SimpleSort("G_130_m_LuS")])))]),[]),LayoutDefinition("d4",MatchDefinition("nRbuy_V__13",[Arg("h3_GmV7lF7_",RefSort(SimpleSort("A81_xJ")))]),[])])])
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/program.app	Fri May 11 14:02:09 2012	(r24824)
@@ -0,0 +1,49 @@
+application G_130_m_LuS.H_MH_Nn17_H.Dk6n8_V8YsL
+
+entity s86_w13576_ : a4T_S {
+  static function x2be_6_AWh7 ( b_L_B___q : G_130_m_LuS Dx3pC : Ref<function():> ) : function ( ) :
+  {
+    validate
+    (
+    get searchtime( '#%o$J& Q% ' )
+    ,
+    get searchtimems( null % {~ false where externalscope . d4 in namespace Dx3pC(), email ( G_130_m_LuS ( {x/global.B6397Y_M__, get size( true )} ) )} )
+    )
+    ;
+    throw
+    {Set<Ref<Dx3pC>>(x({b_L_B___q()}, emnY4hFDmO * event ( v4_GI6b_y8D , [ Dx3pC := x(true) ] ))), false}
+    ,
+    Set<function ( jT__ky_Gk_v : b_L_B___q, B6397Y_M__ : x ) :>()
+    >=
+    {global.y8}
+    ;
+  }
+  static function Dx3pC ( x2be_6_AWh7 : v4_GI6b_y8D<A81_xJ> )
+  {
+    schedule
+    ~ event ( emnY4hFDmO , [ n__DY40Y6_0 := [ s86_w13576_() | G_130_m_LuS : Ref<A81_xJ> in externalscope . H_MH_Nn17_H ] ] ) && [
+                                                                                                                                ] sort by j8p_ desc where {global.x} externalscope . d4 % false
+  }
+}
+
+access
+
+control
+
+policy
+
+jT__ky_Gk_v
+
+AND
+
+jT__ky_Gk_v
+
+layout
+h3_GmV7lF7_
+v(Dx3pC : Ref<G_130_m_LuS<G_130_m_LuS>>)
+{
+}
+d4
+nRbuy_V__13(h3_GmV7lF7_ : Ref<A81_xJ>)
+{
+}
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/n_9747crashed/strategyResult.txt	Fri May 11 14:02:09 2012	(r24824)
@@ -0,0 +1,50 @@
+
+Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	declare_globals_0_0
+	typecheck_declare_0_0
+	log_time_1_1
+	declare_all_0_0
+	dr_scope_1_1
+	alltd_1_0
+	declare_0_0
+	declare_entity_0_0
+	declare_entity_body_0_1
+	map_1_0
+	declare_function_0_1
+	with_origin_1_0
+	with_origin_1_1
+	normalize_declare_0_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'declare-function'
+           StaticEntityFunction("Dx3pC",[Arg("x2be_6_AWh7",GenericSort("v4_GI6b_y8D",[SimpleSort("A81_xJ")]))],[],Block([ScheduleNoFor(SearcherRefMod(And(EventCall("emnY4hFDmO",[EventArg("n__DY40Y6_0",ForExp(ThisCall("s86_w13576_",[]),"G_130_m_LuS",RefSort(SimpleSort("A81_xJ")),ExternalScopeVar("H_MH_Nn17_H"),None))]),MapCreation([])),[SortBy([SortDef("j8p_",Descending)]),ConstraintFilter([FacetFilterConstraint(SetCreation([GlobalVar("x")])),FacetFilterConstraint(Mod(ExternalScopeVar("d4"),False))])]))]))Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	declare_globals_0_0
+	typecheck_declare_0_0
+	log_time_1_1
+	declare_all_0_0
+	dr_scope_1_1
+	alltd_1_0
+	declare_0_0
+	declare_entity_0_0
+	declare_entity_body_0_1
+	map_1_0
+	declare_function_0_1
+	with_origin_1_0
+	with_origin_1_1
+	normalize_declare_0_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'declare-function'
+           StaticEntityFunction("Dx3pC",[Arg("x2be_6_AWh7",GenericSort("v4_GI6b_y8D",[SimpleSort("A81_xJ")]))],[],Block([ScheduleNoFor(SearcherRefMod(And(EventCall("emnY4hFDmO",[EventArg("n__DY40Y6_0",ForExp(ThisCall("s86_w13576_",[]),"G_130_m_LuS",RefSort(SimpleSort("A81_xJ")),ExternalScopeVar("H_MH_Nn17_H"),None))]),MapCreation([])),[SortBy([SortDef("j8p_",Descending)]),ConstraintFilter([FacetFilterConstraint(SetCreation([GlobalVar("x")])),FacetFilterConstraint(Mod(ExternalScopeVar("d4"),False))])]))]))
\ No newline at end of file

From oskarvanrest at gmail.com  Mon May 14 00:45:47 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Sun, 13 May 2012 22:45:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24825 -
	experimental/graphical-editor/HUTN
Message-ID: <20120513224547.4B4637F8005@mx1.tudelft.nl>

Author: OskarVanRest
Date: Sun May 13 22:45:36 2012
New Revision: 24825
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24825&sc=1

Log:
Fix

Modified:
   experimental/graphical-editor/HUTN/.project
   experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore
   experimental/graphical-editor/HUTN/unique-name-config.model

Modified: experimental/graphical-editor/HUTN/.project
==============================================================================
--- experimental/graphical-editor/HUTN/.project	Fri May 11 14:02:09 2012	(r24824)
+++ experimental/graphical-editor/HUTN/.project	Sun May 13 22:45:36 2012	(r24825)
@@ -5,13 +5,7 @@
 	<projects>
 	</projects>
 	<buildSpec>
-		<buildCommand>
-			<name>org.eclipse.epsilon.hutn.dt.builder.HutnBuilder</name>
-			<arguments>
-			</arguments>
-		</buildCommand>
 	</buildSpec>
 	<natures>
-		<nature>org.eclipse.epsilon.hutn.dt.nature.HutnNature</nature>
 	</natures>
 </projectDescription>

Modified: experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore
==============================================================================
--- experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore	Fri May 11 14:02:09 2012	(r24824)
+++ experimental/graphical-editor/HUTN/EntityLang-unique-names.ecore	Sun May 13 22:45:36 2012	(r24825)
@@ -1,8 +1,8 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <ecore:EPackage xmi:version="2.0"
     xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
-    xmlns:ecore="http://www.eclipse.org/emf/2002/Ecore" name="EntityLangModel-unique"
-    nsURI="EntityLangModel-unique" nsPrefix="">
+    xmlns:ecore="http://www.eclipse.org/emf/2002/Ecore" name="EntityLangModel-unique-names"
+    nsURI="EntityLangModel-unique-names" nsPrefix="">
   <eClassifiers xsi:type="ecore:EClass" name="Module">
     <eAnnotations source="gmf.diagram"/>
     <eStructuralFeatures xsi:type="ecore:EAttribute" name="name" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"

Modified: experimental/graphical-editor/HUTN/unique-name-config.model
==============================================================================
--- experimental/graphical-editor/HUTN/unique-name-config.model	Fri May 11 14:02:09 2012	(r24824)
+++ experimental/graphical-editor/HUTN/unique-name-config.model	Sun May 13 22:45:36 2012	(r24825)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="ASCII"?>
-<hutnConfig:Configuration xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:hutnConfig="http://www.eclipse.org/gmt/epsilon/hutnConfig" xmi:id="_b1HjkJtCEeG1pdWABxTMjA">
-  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_dN7woJtCEeG1pdWABxTMjA" classifier="Module" attribute="name"/>
-  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_dmokgJtCEeG1pdWABxTMjA" classifier="Entity" attribute="name"/>
-  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_d4fJgJtCEeG1pdWABxTMjA" classifier="Property" attribute="name"/>
+<hutnConfig:Configuration xmi:version="2.0" xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:hutnConfig="http://www.eclipse.org/gmt/epsilon/hutnConfig" xmi:id="_0emsYJyjEeGDKcid8xtmVw">
+  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_07QzMJyjEeGDKcid8xtmVw" classifier="Module" attribute="name"/>
+  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_1Ud9YJyjEeGDKcid8xtmVw" classifier="Entity" attribute="name"/>
+  <rules xsi:type="hutnConfig:IdentifierRule" xmi:id="_1ry4QJyjEeGDKcid8xtmVw" classifier="Property" attribute="name"/>
 </hutnConfig:Configuration>

From oskarvanrest at gmail.com  Mon May 14 01:03:16 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Sun, 13 May 2012 23:03:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24826 -
	experimental/graphical-editor/EntityLang/EntityLang/META-INF
Message-ID: <20120513230316.5C2532B8016@mx2.tudelft.nl>

Author: OskarVanRest
Date: Sun May 13 23:03:16 2012
New Revision: 24826
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24826&sc=1

Log:
Buddy Classloading

Modified:
   experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF

Modified: experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Sun May 13 22:45:36 2012	(r24825)
+++ experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Sun May 13 23:03:16 2012	(r24826)
@@ -24,3 +24,4 @@
 Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Bundle-ActivationPolicy: lazy
 Export-Package: EntityLang
+Eclipse-RegisterBuddy: org.strategoxt.imp.runtime

From oskarvanrest at gmail.com  Mon May 14 01:56:38 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Sun, 13 May 2012 23:56:38 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24827 - in
	experimental/graphical-editor/EntityLang/EntityLang:
	editor/java/EntityLang/GMF editor/java/EntityLang/strategies trans
Message-ID: <20120513235638.D81A52B8012@mx2.tudelft.nl>

Author: OskarVanRest
Date: Sun May 13 23:56:36 2012
New Revision: 24827
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24827&sc=1

Log:
Updated to last nightly revision (index lib has changed).

Added:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
   experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str

Added: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Sun May 13 23:56:36 2012	(r24827)
@@ -0,0 +1,45 @@
+package EntityLang.GMF;
+
+import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.resource.Resource;
+import org.eclipse.emf.ecore.resource.ResourceSet;
+import org.eclipse.emf.transaction.TransactionalEditingDomain;
+import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramEditor;
+import org.eclipse.ui.IEditorReference;
+import org.eclipse.ui.IWorkbench;
+import org.eclipse.ui.IWorkbenchPage;
+import org.eclipse.ui.IWorkbenchWindow;
+import org.eclipse.ui.PlatformUI;
+
+public class GMFUtils {
+
+	/**
+	 * @param the EMF package name
+	 * @return diagram editor belonging to active Spoofax editor
+	 */
+	public static DiagramEditor getDiagramEditor(String packName) {
+		IWorkbench wb = PlatformUI.getWorkbench();
+		IWorkbenchWindow win = wb.getWorkbenchWindows()[0]; //what if multiple windows? (getActiveWorkbenchWindow doesn't work somehow)
+		IWorkbenchPage page = win.getActivePage();
+		IEditorReference[] editors = page.getEditorReferences();
+		DiagramEditor diagramEditor = null;
+		String editorID = (packName + ".diagram.part." + packName + "DiagramEditorID");
+		for (int i = 0; i < editors.length; i++) {
+			if (editors[i].getId().equals(editorID)) {
+				diagramEditor = (DiagramEditor) editors[i].getEditor(false);
+			}
+		}
+		return diagramEditor;
+	}
+	
+	public static EObject getSemanticModel(DiagramEditor diagramEditor) {
+		Resource semanticModelResource = getSemanticModelResource(diagramEditor);
+		return semanticModelResource.getContents().get(0);
+	}
+	
+	public static Resource getSemanticModelResource(DiagramEditor diagramEditor) {
+		TransactionalEditingDomain editingDomain = diagramEditor.getEditingDomain();
+		ResourceSet diagramEditorResourceSet = editingDomain.getResourceSet();
+		return diagramEditorResourceSet.getResources().get(1);
+	}
+}

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java	Sun May 13 23:03:16 2012	(r24826)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java	Sun May 13 23:56:36 2012	(r24827)
@@ -20,6 +20,7 @@
 import org.strategoxt.lang.Context;
 import org.strategoxt.lang.Strategy;
 
+import EntityLang.GMF.GMFUtils;
 import EntityLangModel.diagram.part.EntityLangModelDiagramEditorPlugin;
 import EntityLangModel.diagram.part.EntityLangModelDocumentProvider;
 
@@ -39,36 +40,24 @@
 			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
 		}
 		
-		IWorkbench wb = PlatformUI.getWorkbench();
-		IWorkbenchWindow win = wb.getWorkbenchWindows()[0];
-		IWorkbenchPage page = win.getActivePage();
-		IEditorReference[] editors = page.getEditorReferences();
-		DiagramEditor diagramEditor = null;
-		String editorID = ((IStrategoString) packName).stringValue() + ".diagram.part." + ((IStrategoString) packName).stringValue() + "DiagramEditorID";
-		for (int i = 0; i < editors.length; i++) {
-			if (editors[i].getId().equals(editorID)) {
-				diagramEditor = (DiagramEditor) editors[i].getEditor(false);
-			}
-		}
+		DiagramEditor diagramEditor = GMFUtils.getDiagramEditor(((IStrategoString) packName).stringValue());
 
 		if (diagramEditor == null) {
 			System.out.println("GMF editor not found. Please open it manually");
 			return context.getFactory().makeString("0");
 		}
 
-		TransactionalEditingDomain editingDomain = diagramEditor.getEditingDomain();
-		ResourceSet diagramEditorResourceSet = editingDomain.getResourceSet();
-		final Resource semanticModel = diagramEditorResourceSet.getResources().get(1);
+		final Resource semanticModelResource = GMFUtils.getSemanticModelResource(diagramEditor);
 		final InputStream is = new ByteArrayInputStream(((IStrategoString) serialisedModel).stringValue().getBytes());
 		final EntityLangModelDocumentProvider documentProvider = EntityLangModelDiagramEditorPlugin.getInstance().getDocumentProvider();
 		final IEditorInput editorInput = diagramEditor.getEditorInput();
 
 		diagramEditor.getSite().getShell().getDisplay().asyncExec(new Runnable() {
 			public void run() {
-				if (semanticModel.isLoaded()) {
-					semanticModel.unload();
+				if (semanticModelResource.isLoaded()) {
+					semanticModelResource.unload();
 					try {
-						semanticModel.load(is, Collections.EMPTY_MAP);
+						semanticModelResource.load(is, Collections.EMPTY_MAP);
 					} catch (IOException e) {
 						e.printStackTrace();
 					}

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Sun May 13 23:03:16 2012	(r24826)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Sun May 13 23:56:36 2012	(r24827)
@@ -9,29 +9,66 @@
   lib/analysis-auto.generated
   lib/index-library.generated
   lib/analysis-library.generated
+  lib/analysis-library-internal.generated
   lib/compilation-library.generated
   analysis-manual
   check
   generate
   refactor
-  emf
+imports
+  trans/emf
 
-rules // Main editor interface (defined by editor/EntityLang-Builders and -References.esv)
+rules // Analysis
   
-  // Analyzes the current program, returning a tuple with errors, warnings, and notes;
-  // each a list of (term, message) tuples or simply (message) terms.
+  // Analyzes the current program, returning a tuple with the analyzed AST, errors, warnings, notes and
+  // files that should be re-analyzed.
+  analyze:
+    (ast, path, project-path) -> (ast'', errors, warnings, notes, filesToAnalyze')
+    with
+      ast'                    := <id> ast; // Optional AST desugaring
+      (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
+      index-transaction(
+        errors                := <collect-all(constraint-error, conc)> ast'';
+        warnings              := <collect-all(constraint-warning, conc)> ast'';
+        notes                 := <collect-all(constraint-note, conc)> ast''
+      );
+      filesToAnalyze'         := <make-set> <map(index-filepair-to-file)> filesToAnalyze
+
+  // Main entry point for analyzes, called when a single file is opened in the editor.
   editor-analyze:
     (ast, path, project-path) -> (ast', errors, warnings, notes)
     with
       editor-init;
-      ast'     := <analyze-top>;
-      errors   := <collect-all(constraint-error, conc)> ast';
-      warnings := <collect-all(constraint-warning, conc)> ast';
-      notes    := <collect-all(constraint-note, conc)> ast';      
-      emf      := <try(generate-emf)> (ast', path)
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
+      <try(editor-queue-analysis)> filesToAnalyze;
+      <generate-emf> (ast', path)
       
+  // Main entry point for analyzes, called when multiple files have changed. 
+  editor-analyze:
+    files -> None()
+    where
+      not(is-tuple)
+    with
+      index-setup(|<language>, [<project-path>], ".");
+      disable-commit-and-compile // Disable compilation during analysis.
+    with
+      editor-queue-analysis
+    with
+      // Enable and trigger compilation after all files have been analysed.
+      <enable-commit-and-compile> <language>;
+      <trigger-commit-and-compile> <language>
+      
+  // Called when current file is saved.
+  editor-save:
+    (_, _, _, _, _) -> None()
+    with
+      index-setup(|<language>, [<project-path>], ".");
+      <trigger-commit-and-compile> <language>
+
+rules // EMF
+
   generate-emf:
-    (ast', path) -> result
+    ([ast'], path) -> result
     with      
       // EMF stuff below
       fileExtension := <lower-case> <packName>;
@@ -39,8 +76,9 @@
       // <initialize-emf-package> <packName>;
       ast''  := <to-emf(|path)> ast';
       result := <serialise-model(|path)> ast'';
-      <replace-gmf-resource(|<packName>)> result
-	  
+      <replace-gmf-resource(|<packName>)> result//;
+     // create-listener
+      
   save-emf:
   	(selected, position, ast, path, project-path) -> None()
   	// where
@@ -49,41 +87,26 @@
   // external initialize-emf-package(|)
   external replace-gmf-resource(|packName)
   // external save(|)
-  
-  // Transforms a selection to Java
-  generate-java:
-    (selected, position, ast, path, project-path) -> (filename, result)
-    with
-      filename := <guarantee-extension(|"java")> path;
-      result   := <to-java> selected
-  
-  // Prints the abstract syntax ATerm of a selection.
-  generate-aterm:
-    (selected, position, ast, path, project-path) -> (filename, result)
-    with
-      filename := <guarantee-extension(|"aterm")> path;
-      result   := selected // we just return the input term
-      
-  // Prints the analyzed abstract syntax ATerm of a selection.
-  generate-analyzed:
-    (selected, position, ast, path, project-path) -> (filename, result)
-    with
-      editor-init;
-      filename := <guarantee-extension(|"analyzed.aterm")> path;
-      result   := <analyze-top> (selected, path, project-path)
+  external create-listener(|)
+
+
+rules // Editor services
   
   // Resolves a reference when the user control-clicks or presses F3 in the editor.
   editor-resolve:
     (node, position, ast, path, project-path) -> target
     where
-      language  := <index-origin-language> ast;
-      index-setup(|language, [project-path], $[[project-path]/[path]]);
-      target    := <index-lookup> node
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-transaction(
+        target := <index-lookup> node
+      )
 
   // Returns "hover help" information for a particular node in the editor.
   // For references, this rule is invoked using the resolved term.
   editor-hover:
-    (target, position, ast, path, project-path) -> $[Hover help: [<write-to-string> target]]
+    (target, position, ast, path, project-path) -> $[[uriString]]
+    where
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
 
   // Completes an identifier when the user presses control-space
   // (the completion identifier in the AST provides additional context information)
@@ -91,15 +114,69 @@
     (node, position, ast, path, project-path) -> proposals'
     where
       editor-init;
-      ast'              := <analyze-top> (ast, path, project-path);
-      x                 := <collect-one(?COMPLETION(_))> ast';
-      COMPLETION(name)  := x;
-      (
-        proposals       := <index-lookup-all-levels(|name)> x
-      <+ 
-        proposals       := []
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
       );
-      proposals'        := <map(def-to-name)> proposals
+      proposals' := <map(index-uri-name)> proposals
 
-  def-to-name:
-    Def([namespace, name | _]) -> name
+rules // Debugging
+  
+  // Prints the abstract syntax ATerm of a selection.
+  generate-aterm:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := selected
+      
+  // Prints the analyzed annotated abstract syntax ATerm of a selection.
+  generate-analyzed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      editor-init;
+      filename := <guarantee-extension(|"analyzed.aterm")> path;
+      result   := <analyze-top(|<language>)> (selected, path, project-path)   
+      
+  // Prints the definition annotated abstract syntax ATerm of a selection.
+  generate-deffed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := <analyze-defs(|Anon(), Anon())> selected
+      
+  // Prints the entries in the index of the current file.
+  index-currentfile:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"index.currentfile.aterm")> path;
+      result   := <index-get-all-in-file> path
+      
+  // Prints the entries in the index of all files.
+  index-allfiles:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"index.allfiles.aterm")> path;
+      result   := <map(\filename -> (filename, <index-get-all-in-file> filename)\)> <index-get-all-files>
+      
+  // Cleans all data from the index.
+  index-cleanall:
+    (selected, position, ast, path, project-path)  -> None()
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-clear
+    
+rules // Utility
+  
+  // Queue parallel analysis for given list of files.
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+      
+  // Executes parallel analysis using the index library.
+  editor-parallel-analyze:
+    files -> None()
+    with
+      index-parallel-analyze-files(analyze)

From gabrielkonat at gmail.com  Mon May 14 11:01:44 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 14 May 2012 09:01:44 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24828 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/lib
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-co...
Message-ID: <20120514090144.1C7132B8011@mx2.tudelft.nl>

Author: gkonat
Date: Mon May 14 09:01:43 2012
New Revision: 24828
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24828&sc=1

Log:
Use an URI as subfile.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexFileDescriptor.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str	Mon May 14 09:01:43 2012	(r24828)
@@ -32,6 +32,8 @@
     ast2abox(|[<import-term(include/C-without-macros.generated.pp.af)>,
                <import-term(include/C-without-macros.pp.af)>]);
     box2text-string(|100)
+    
+  language = !"C-without-macros"
 
 strategies
   

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/c_without_macros.str	Mon May 14 09:01:43 2012	(r24828)
@@ -143,9 +143,6 @@
       index-clear
       
 rules // Utility
-      
-  // Defines the current language.
-  language = !"C-without-macros"
   
   // Queue parallel analysis for given list of files.
   editor-queue-analysis = 

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str	Mon May 14 09:01:43 2012	(r24828)
@@ -32,6 +32,8 @@
     ast2abox(|[<import-term(include/CSharpPartialClassses.generated.pp.af)>,
                <import-term(include/CSharpPartialClassses.pp.af)>]);
     box2text-string(|100)
+    
+  language = !"CSharpPartialClassses"
 
 strategies
   

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh	Mon May 14 09:01:43 2012	(r24828)
@@ -1,5 +1,5 @@
 namespace Web {
 	partial class URL {
-		string location;
+		//string location;
 	}
 }
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/csharppartialclassses.str	Mon May 14 09:01:43 2012	(r24828)
@@ -141,10 +141,7 @@
       index-clear
       
 rules // Utility
-      
-  // Defines the current language.
-  language = !"CSharpPartialClassses"
-  
+	
   // Queue parallel analysis for given list of files.
   editor-queue-analysis = 
     not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str	Mon May 14 09:01:43 2012	(r24828)
@@ -13,5 +13,5 @@
 
 rules // Incremental code generation of project
       
-  index-compile-ast(|file, subfile) = id
+  index-compile-ast(|file, subfile) = debug(!"Compiling ast: ")
   
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/entitywithaspects.str	Mon May 14 09:01:43 2012	(r24828)
@@ -151,9 +151,6 @@
     
 rules // Utility
   
-  // Defines the current language.
-  language = !"EntityWithAspects"
-  
   // Queue parallel analysis for given list of files.
   editor-queue-analysis = 
     not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndex.java	Mon May 14 09:01:43 2012	(r24828)
@@ -40,6 +40,8 @@
 			ArrayListMultimap.create();
 	private final Multimap<URI, SemanticIndexEntry> entriesPerURI = 
 			ArrayListMultimap.create();
+	private final Multimap<IStrategoList, SemanticIndexEntry> entriesPerSubfile = 
+			ArrayListMultimap.create();
 	private final Map<SemanticIndexFileDescriptor, SemanticIndexFile> files =
 			new HashMap<SemanticIndexFileDescriptor, SemanticIndexFile>();
 	
@@ -93,6 +95,7 @@
 		// Add entry to files.
 		entriesPerFileDescriptor.put(entry.getFileDescriptor(), entry);
 		entriesPerURI.put(entry.getFileDescriptor().getURI(), entry);
+		entriesPerSubfile.put(entry.getFileDescriptor().getSubfile(), entry);
 	}
 	
 	public void addAll(IStrategoList entries, SemanticIndexFileDescriptor fileDescriptor) {
@@ -162,7 +165,8 @@
 			if (fileDescriptor != null)
 			{
 				entriesPerFileDescriptor.remove(fileDescriptor, entry);
-				entriesPerURI.remove(fileDescriptor.getURI(), entry); // TODO: Might not work because of hashCode of entry.
+				entriesPerURI.remove(fileDescriptor.getURI(), entry);
+				entriesPerSubfile.remove(fileDescriptor.getSubfile(), entry);
 			}
 		}
 	}
@@ -178,6 +182,8 @@
 	public Collection<SemanticIndexEntry> getEntriesInFile(SemanticIndexFileDescriptor fileDescriptor) {
 		if(fileDescriptor.getSubfile() == null)
 			return getCollection(entriesPerURI.get(fileDescriptor.getURI()));
+		else if(fileDescriptor.getURI() == null)
+			return getCollection(entriesPerSubfile.get(fileDescriptor.getSubfile()));
 		else
 			return getCollection(entriesPerFileDescriptor.get(fileDescriptor));
 	}
@@ -236,6 +242,7 @@
 		childs.clear();
 		entriesPerFileDescriptor.clear();
 		entriesPerURI.clear();
+		entriesPerSubfile.clear();
 		files.clear();
 	}
 	

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexFileDescriptor.java
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexFileDescriptor.java	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/java/org/spoofax/interpreter/library/language/SemanticIndexFileDescriptor.java	Mon May 14 09:01:43 2012	(r24828)
@@ -7,6 +7,7 @@
 import java.net.URI;
 
 import org.spoofax.interpreter.library.IOAgent;
+import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.ITermFactory;
@@ -14,7 +15,7 @@
 public class SemanticIndexFileDescriptor {
 	private final URI uri;
 	
-	private final String subfile;
+	private final IStrategoList subfile;
 	
 	private transient IStrategoTerm cachedTerm;
 	
@@ -24,13 +25,16 @@
 		return uri;
 	}
 	
-	public String getSubfile() {
+	public IStrategoList getSubfile() {
 		return subfile;
 	}
 	
-	public SemanticIndexFileDescriptor(URI uri, String subfile) {
+	public SemanticIndexFileDescriptor(URI uri, IStrategoList subfile) {
 		this.uri = uri;
-		this.subfile = "".equals(subfile) ? null : subfile;
+		if(subfile == null || subfile.isEmpty())
+			this.subfile = null;
+		else
+			this.subfile = subfile;
 	}
 	
 	public IStrategoTerm toTerm(ITermFactory factory) {
@@ -38,8 +42,7 @@
 			return cachedTerm;
 		
 		IStrategoString uriString = factory.makeString(toString());
-		IStrategoString descriptorName = factory.makeString(subfile == null ? "" : subfile);
-		cachedTerm = factory.makeTuple(uriString, descriptorName);
+		cachedTerm = factory.makeTuple(uriString, subfile == null ? factory.makeList() : subfile);
 		
 		return cachedTerm;
 	}
@@ -55,10 +58,10 @@
 	 */
 	public static SemanticIndexFileDescriptor fromTerm(IOAgent agent, IStrategoTerm term) {
 		String name;
-		String subfile;
+		IStrategoList subfile;
 		if (isTermTuple(term)) {
 			name = asJavaString(term.getSubterm(0));
-			subfile = asJavaString(term.getSubterm(1));
+			subfile = (IStrategoList)term.getSubterm(1);
 		} else {
 			name = asJavaString(term);
 			subfile = null;

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library-internal.str	Mon May 14 09:01:43 2012	(r24828)
@@ -144,7 +144,7 @@
   analyze-top-store-ast:
     (ast, file) -> <id>
     with
-      <index-set-global(|[<index-file-to-string> file, "ast"])> ast
+      <index-set-global(|<conc> (<index-file-to-uri> file, ["ast"]))> ast
       
   /**
    * Identifies all definitions in the tree and annotates them with their URI.
@@ -399,7 +399,7 @@
   analyze-astdiff:
     (ast, file) -> file
     where
-      name := [<index-file-to-string> file, "ast-checksum"];
+      name := <conc> (<index-file-to-uri> file, ["ast-checksum"]);
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
         <index-set-global(|name)> newChecksum;
@@ -620,9 +620,7 @@
   
   /** @internal */
   ast-uri-to-ast-file(|full-path):
-    (ast, uri) -> (ast, (full-path, uriStr))
-    with
-      (<index-uri-to-string> uri <+ !"") => uriStr
+    (ast, uri) -> (ast, (full-path, uri))
   
   /** @internal */     
   index-is-name-substring(|name):

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/analysis-library.str	Mon May 14 09:01:43 2012	(r24828)
@@ -183,7 +183,7 @@
           <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
       else
         Results(ast', _, _, _, _, _, filesToAnalyze) := 
-          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, ""))]
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, []))]
       end
   
 rules // Parallel analysis

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Mon May 14 09:01:43 2012	(r24828)
@@ -43,6 +43,8 @@
    */
   index-compile-ast(|file, subfile) = fail
   
+  index-partial-ast = fail
+  
 rules // Compilation
   
   /**
@@ -75,23 +77,19 @@
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> <debug(!"Files to compile: ")> filteredFiles
 
   /** @internal */
   index-compilation-file(|language, project-path):
     (path, subfile) -> None()
     with
-      // Parse and analyze ast.
-      ast                              := <parse-file> path;
-      ast'                             := <try(index-desugar-ast)> ast;
-      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
-    with
+    	ast := <index-get-global(|<conc> (<index-file-to-uri> (path, subfile), ["ast"]))>;
       {| Index-ReadSet:
         readSet := <new-iset>;
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <try(index-compile-ast(|path, subfile))> ast'';
+        <try(index-compile-ast(|path, subfile))> ast;
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Sun May 13 23:56:36 2012	(r24827)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Mon May 14 09:01:43 2012	(r24828)
@@ -27,6 +27,9 @@
   Global : List(UriPart) -> Summary
   Global : List(UriPart) * List(Summary) -> Summary
   
+  // None namespace
+  None   : Namespace
+  
 rules // Index management
    
   /**
@@ -604,25 +607,62 @@
    * Converts a file ((file, subfile) tuple) to a string.
    *
    * Example:
-   *   <index-file-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   *   <index-file-to-string> ("fullpath/file.ext", []) => "fullpath/file.ext"
    *
-   * @type (file, "") -> file
+   * @type (file, []) -> file
    */
   index-file-to-string:
-    (file, "") -> file
+    (file, []) -> file
     
   /**
    * Converts a file ((file, subfile) tuple) to a string.
    *
    * Example:
-   *   <index-file-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
+   *   <index-file-to-string> ("fullpath/file.ext", [Entity(), "Foo" "Bar"]) => "fullpath/file.ext at Entity://Foo.Bar"
    *
    * @type (file, subfile) -> str
    */
   index-file-to-string:
-    (file, subfile) -> <concat-strings> [file, "@", subfile]
+    (file, subfile) -> <concat-strings> [file, "@", <index-uri-to-string> subfile]
+    where
+      not([] := subfile)
+
+  /**
+   * Converts a file to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> "fullpath/file.ext" => [None(), "fullpath/file.ext"]
+   *
+   * @type file -> uri
+   */      
+  index-file-to-uri:
+    file -> [None(), file]
+    where
+      not(<is-tuple> file)
+      
+  /**
+   * Converts a file ((file, subfile) tuple) to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> ("fullpath/file.ext", []) => [None(), "fullpath/file.ext]
+   *
+   * @type (file, subfile) -> uri
+   */      
+  index-file-to-uri:
+    (file, []) -> [None(), file]
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> ("fullpath/file.ext", [Entity(), "Foo" "Bar"]) => [Entity(), "Foo", "Bar", "fullpath/file.ext"]
+   *
+   * @type (file, subfile) -> uri
+   */      
+  index-file-to-uri:
+    (file, subfile) -> <conc> ([file], subfile)
     where
-      not("" := subfile)
+      not([] := subfile)
       
 /** @internal */
 rules // URI and value projections

From gabrielkonat at gmail.com  Mon May 14 14:22:00 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 14 May 2012 12:22:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24829 -
	spoofax-contrib/separate-compilation-examples/c-without-macros/lib
	spoofax-contrib/separate-compilation-examples/c-without-macros/trans
	spoofax-contrib/separate-co...
Message-ID: <20120514122200.C970C2B8021@mx2.tudelft.nl>

Author: gkonat
Date: Mon May 14 12:21:58 2012
New Revision: 24829
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24829&sc=1

Log:
Fix splitters.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/lib/   (props changed)
   spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/   (props changed)
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/   (props changed)
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Mon May 14 09:01:43 2012	(r24828)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/trans/splitter.str	Mon May 14 12:21:58 2012	(r24829)
@@ -12,4 +12,4 @@
   index-is-toplevel = ?FunDecl(_, _, _, _)
   index-is-qualifier = ?Start(_, _)
   index-qualifier-subelements = ?Start(_, <id>)
-  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
\ No newline at end of file
+  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, [<id>])
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str	Mon May 14 09:01:43 2012	(r24828)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/generate.str	Mon May 14 12:21:58 2012	(r24829)
@@ -13,5 +13,5 @@
 
 rules // Incremental code generation of project
       
-  index-compile-ast(|file, subfile) = debug(!"Compiling ast: ")
+  index-compile-ast(|file, subfile) = id
   
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Mon May 14 09:01:43 2012	(r24828)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/splitter.str	Mon May 14 12:21:58 2012	(r24829)
@@ -15,5 +15,5 @@
   index-is-qualifier = ?Start(_, _)
   index-qualifier-subelements = ?Namespace(_, <id>)
   index-qualifier-subelements = ?Start(_, <id>)
-  index-create-qualifier(|qualifier) = !Namespace(<?Namespace(<id>, _)> qualifier, <id>)
-  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, <id>)
\ No newline at end of file
+  index-create-qualifier(|qualifier) = !Namespace(<?Namespace(<id>, _)> qualifier, [<id>])
+  index-create-qualifier(|qualifier) = !Start(<?Start(<id>, _)> qualifier, [<id>])
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str	Mon May 14 09:01:43 2012	(r24828)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/generate.str	Mon May 14 12:21:58 2012	(r24829)
@@ -35,7 +35,7 @@
     with
       java := <to-java> ast;
       full-path := <dirname> file;
-      filename := <guarantee-extension(|"java")> <base-filename> file;
+      filename := <guarantee-extension(|"java")> <index-uri-name> subfile;
       writePath := $[[full-path]/java/];
       writeFile :=  $[[writePath][filename]];
       try(<mkdir> writePath);

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Mon May 14 09:01:43 2012	(r24828)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/trans/splitter.str	Mon May 14 12:21:58 2012	(r24829)
@@ -10,7 +10,6 @@
   
   index-split = id
   index-is-toplevel = ?Entity(_, _)
-  index-is-toplevel = ?Aspect(_, _)
   index-is-qualifier = ?Module(_, _, _)
   index-qualifier-subelements = ?Module(_, _, <id>)
-  index-create-qualifier(|qualifier) = !Module(<?Module(<id>, _, _)> qualifier, <?Module(_, <id>, _)> qualifier, <id>)
\ No newline at end of file
+  index-create-qualifier(|qualifier) = !Module(<?Module(<id>, _, _)> qualifier, <?Module(_, <id>, _)> qualifier, [<id>])
\ No newline at end of file

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Mon May 14 09:01:43 2012	(r24828)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Mon May 14 12:21:58 2012	(r24829)
@@ -43,8 +43,6 @@
    */
   index-compile-ast(|file, subfile) = fail
   
-  index-partial-ast = fail
-  
 rules // Compilation
   
   /**

From andre.s.d.vieira at gmail.com  Tue May 15 17:13:08 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Tue, 15 May 2012 15:13:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24830 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed
Message-ID: <20120515151308.83534CC036@mx4.tudelft.nl>

Author: AndreVieira
Date: Tue May 15 15:13:08 2012
New Revision: 24830
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24830&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/AST.aterm	Tue May 15 15:13:08 2012	(r24830)
@@ -0,0 +1 @@
+Application("S_",[AccessControlDefinition("W797vZ_0",[AccessControlPointcut("t",[Arg("I_0E",SimpleSort("HN"))],[AccessControlPointcutElement("r___","xGh6Nm*",["k2G3SpK__79","fUdF32"],[]),AccessControlPointcutElement("k2G3SpK__79","m*",["gG5_5_P__L1","f_Dk"],"*")])]),ACPolicy(Name("HN")),Section("rootFixSection",DefinePage([],"root",[],None,[]))])
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/program.app	Tue May 15 15:13:08 2012	(r24830)
@@ -0,0 +1,49 @@
+application S_
+
+access control rules
+  W797vZ_0
+  pointcut
+  t
+  (
+  I_0E : HN
+  )
+  {
+  r___
+  xGh6Nm*
+  (
+  k2G3SpK__79
+  ,
+  fUdF32
+  )
+  ,
+  k2G3SpK__79
+  m*
+  (
+  gG5_5_P__L1
+  ,
+  f_Dk
+  *
+  )
+  }
+
+access
+
+control
+
+policy
+
+HN
+
+section rootFixSection .
+
+  page
+
+  root
+
+  (
+
+  )
+
+  {
+
+  }
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/z_14807crashed/strategyResult.txt	Tue May 15 15:13:08 2012	(r24830)
@@ -0,0 +1,182 @@
+
+Analyzing: TestFolder2/program.app
+rename: 0.000 s
+
+* : error: Type not defined: HN
+HN
+* : error: pointcut element uses unknown identifier: k2G3SpK__79
+r___ xGh6Nm* ( k2G3SpK__79 , fUdF32 )
+* : error: pointcut element uses unknown identifier: fUdF32
+r___ xGh6Nm* ( k2G3SpK__79 , fUdF32 )
+* : error: pointcut element uses unknown identifier: gG5_5_P__L1
+k2G3SpK__79 m* ( gG5_5_P__L1 , f_Dk * )
+* : error: pointcut element uses unknown identifier: f_Dk
+k2G3SpK__79 m* ( gG5_5_P__L1 , f_Dk * )
+* : error: pointcut element must use pointcut argument: I_0E
+r___ xGh6Nm* ( k2G3SpK__79 , fUdF32 )
+* : error: pointcut element must use pointcut argument: I_0E
+k2G3SpK__79 m* ( gG5_5_P__L1 , f_Dk * )
+* : error: cannot have access control rules without a principal declaration: access control rules
+  W797vZ_0
+  pointcut
+  t
+  (
+  I_0E : HN
+  )
+  {
+  r___
+  xGh6Nm*
+  (
+  k2G3SpK__79
+  ,
+  fUdF32
+  )
+  ,
+  k2G3SpK__79
+  m*
+  (
+  gG5_5_P__L1
+  ,
+  f_Dk
+  *
+  )
+  }
+access control rules
+  W797vZ_0
+  pointcut
+  t
+  (
+  I_0E : HN
+  )
+  {
+  r___
+  xGh6Nm*
+  (
+  k2G3SpK__79
+  ,
+  fUdF32
+  )
+  ,
+  k2G3SpK__79
+  m*
+  (
+  gG5_5_P__L1
+  ,
+  f_Dk
+  *
+  )
+  }
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	catch_errors_editor_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	constraint_error_all_0_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	try_1_0
+	constraint_error_0_0
+	constraint_error_ui_0_0
+	filter_1_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'constraint-error-ui'
+           Section("rootFixSection",DefinePage([],"root",[],None,[]))Analyzing: TestFolder2/program.app
+rename: 0.000 s
+
+* : error: Type not defined: HN
+HN
+* : error: pointcut element uses unknown identifier: k2G3SpK__79
+r___ xGh6Nm* ( k2G3SpK__79 , fUdF32 )
+* : error: pointcut element uses unknown identifier: fUdF32
+r___ xGh6Nm* ( k2G3SpK__79 , fUdF32 )
+* : error: pointcut element uses unknown identifier: gG5_5_P__L1
+k2G3SpK__79 m* ( gG5_5_P__L1 , f_Dk * )
+* : error: pointcut element uses unknown identifier: f_Dk
+k2G3SpK__79 m* ( gG5_5_P__L1 , f_Dk * )
+* : error: pointcut element must use pointcut argument: I_0E
+r___ xGh6Nm* ( k2G3SpK__79 , fUdF32 )
+* : error: pointcut element must use pointcut argument: I_0E
+k2G3SpK__79 m* ( gG5_5_P__L1 , f_Dk * )
+* : error: cannot have access control rules without a principal declaration: access control rules
+  W797vZ_0
+  pointcut
+  t
+  (
+  I_0E : HN
+  )
+  {
+  r___
+  xGh6Nm*
+  (
+  k2G3SpK__79
+  ,
+  fUdF32
+  )
+  ,
+  k2G3SpK__79
+  m*
+  (
+  gG5_5_P__L1
+  ,
+  f_Dk
+  *
+  )
+  }
+access control rules
+  W797vZ_0
+  pointcut
+  t
+  (
+  I_0E : HN
+  )
+  {
+  r___
+  xGh6Nm*
+  (
+  k2G3SpK__79
+  ,
+  fUdF32
+  )
+  ,
+  k2G3SpK__79
+  m*
+  (
+  gG5_5_P__L1
+  ,
+  f_Dk
+  *
+  )
+  }
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	catch_errors_editor_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	constraint_error_all_0_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	try_1_0
+	constraint_error_0_0
+	constraint_error_ui_0_0
+	filter_1_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'constraint-error-ui'
+           Section("rootFixSection",DefinePage([],"root",[],None,[]))
\ No newline at end of file

From oskarvanrest at gmail.com  Wed May 16 03:14:30 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 16 May 2012 01:14:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24831 - in
	experimental/graphical-editor/EntityLang/EntityLang: editor trans
Message-ID: <20120516011430.8B69E7F80AC@mx1.tudelft.nl>

Author: OskarVanRest
Date: Wed May 16 01:14:25 2012
New Revision: 24831
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24831&sc=1

Log:
'add entity' + 'remove entity' refactorings

Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
   experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Tue May 15 15:13:08 2012	(r24830)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Wed May 16 01:14:25 2012	(r24831)
@@ -28,5 +28,10 @@
     input
       identifier : "new name" = ""
 
+  refactoring ID : "Add Entity" = add-entity (source) (cursor)
+    input
+      identifier : "name" = ""
+      
+  refactoring ID : "Remove Entity" = remove-entity (source) (cursor)
  
   on save : save-emf
\ No newline at end of file

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str	Tue May 15 15:13:08 2012	(r24830)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str	Wed May 16 01:14:25 2012	(r24831)
@@ -7,20 +7,46 @@
   entitylang
 
 rules
- 
-  rename-entity:
-    (newname, selected-name, position, ast, path, project-path) -> ([(ast, new-ast)], fatal-errors, errors, warnings)
-    with
-      new-ast  := <topdown(try(rename-type(|selected-name, newname)))> ast; 
-      (errors, warnings) := <semantic-constraint-issues> (ast, new-ast);
-      fatal-errors := []
+  
+	rename-entity:
+		(newname, selected-name, position, ast, path, project-path) -> ([(ast, new-ast)], fatal-errors, errors, warnings)
+		with 
+			new-ast  := <topdown(try(rename-type(|selected-name, newname)))> ast; 
+			(errors, warnings) := <semantic-constraint-issues> (ast, new-ast);
+			fatal-errors := []
 
-  rename-type(|old-name, new-name):
-    Entity(old-name, y) -> Entity(new-name, y)
+	rename-type(|old-name, new-name):
+		Entity(old-name, y) -> Entity(new-name, y)
 
-  rename-type(|old-name, new-name):
-    Type(old-name) -> Type(new-name)
-    
+	rename-type(|old-name, new-name):
+		Type(old-name) -> Type(new-name)
+ 
+	remove-entity:
+		(newname, selected-name, position, ast, path, project-path) -> ([(ast, new-ast)], fatal-errors, errors, warnings)
+		with
+			new-ast  := <topdown(try(remove-type(|selected-name)))> ast; 
+			(errors, warnings) := <semantic-constraint-issues> (ast, new-ast);
+			fatal-errors := []
+ 
+	remove-type(|selected-name):
+		entities -> entities'
+		where
+			entities' := <remove-all(?Entity(selected-name, _))> entities
+ 
+	add-entity:
+		(name, selected-name, position, ast, path, project-path) -> ([(ast, new-ast)], fatal-errors, errors, warnings)
+		with
+			new-ast  := <topdown(try(add-type(|name)))> ast; 
+			(errors, warnings) := <semantic-constraint-issues> (ast, new-ast);
+			fatal-errors := [] 
+ 
+	add-type(|name):
+		Module(mName, entities) -> Module(mName, entities')
+		where
+			entities' := <conc> (entities, [Entity(name, [])])
+
+rules
+	    
   semantic-constraint-issues:
     (ast, new-ast) -> (<diff>(new-errors, errors), <diff>(new-warnings, warnings))
     where

From dgroenewegen at gmail.com  Wed May 16 17:18:22 2012
From: dgroenewegen at gmail.com (Danny Groenewegen)
Date: Wed, 16 May 2012 15:18:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24832 - hydra
Message-ID: <20120516151822.D1C5A7F801B@mx1.tudelft.nl>

Author: dgroenewegen
Date: Wed May 16 15:18:22 2012
New Revision: 24832
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24832&sc=1

Log:
increase permgen space for maven build of eclipse plugin

Modified:
   hydra/spoofax-fun.nix

Modified: hydra/spoofax-fun.nix
==============================================================================
--- hydra/spoofax-fun.nix	Wed May 16 01:14:25 2012	(r24831)
+++ hydra/spoofax-fun.nix	Wed May 16 15:18:22 2012	(r24832)
@@ -36,7 +36,7 @@
     export M2_REPO=/tmp/m3
     ulimit -s unlimited
 	export ANT_ARGS="-lib $bsf"
-    export MAVEN_OPTS="-Xss8m -Xmx2048m"
+    export MAVEN_OPTS="-Xss8m -Xmx2048m -XX:MaxPermSize=256m"
     mkdir -p utils 
     cp -v $eclipse/eclipse/plugins/org.strategoxt.imp.generator_*/lib/StrategoMix.def utils/
     sed -Ei 's|\.[0-9]{12}|.qualifier|g' */site.xml
@@ -140,7 +140,7 @@
 
     mvn package -Dtycho.targetPlatform=${eclipse}/eclipse ${mvnFlags} -e
   '';
-	      
+        
   installPhase = ''
     ensureDir $out/nix-support
     cp -Rv *update*site/target/site $out/
@@ -150,6 +150,6 @@
     echo "file tar $out/${name}.tar.gz" >> $out/nix-support/hydra-build-products
     echo "file site $out/site" >> $out/nix-support/hydra-build-products
   '';
-	        
+          
   __noChroot = true;
 } )

From oskarvanrest at gmail.com  Fri May 18 07:52:51 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Fri, 18 May 2012 05:52:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24833 - in
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime:
	dynamicloading services
Message-ID: <20120518055251.B9712108C003@mx3.tudelft.nl>

Author: OskarVanRest
Date: Fri May 18 05:52:49 2012
New Revision: 24833
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24833&sc=1

Log:
Added a service to replace text, given an old and new AST (using the layout preservation strategy from refactoring)

Added:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/TextReplacerFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ITextReplacer.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/TextReplacer.java
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	Wed May 16 15:18:22 2012	(r24832)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	Fri May 18 05:52:49 2012	(r24833)
@@ -118,6 +118,7 @@
 		serviceFactories.add(new ContentProposerFactory());
 		serviceFactories.add(new AutoEditStrategyFactory());
 		serviceFactories.add(new OnSaveServiceFactory());
+		serviceFactories.add(new TextReplacerFactory());
 	}
 	
 	/**

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/TextReplacerFactory.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/TextReplacerFactory.java	Fri May 18 05:52:49 2012	(r24833)
@@ -0,0 +1,20 @@
+package org.strategoxt.imp.runtime.dynamicloading;
+
+import org.strategoxt.imp.runtime.parser.SGLRParseController;
+import org.strategoxt.imp.runtime.services.ITextReplacer;
+import org.strategoxt.imp.runtime.services.TextReplacer;
+
+/**
+ * @author Oskar van Rest
+ */
+public class TextReplacerFactory extends AbstractServiceFactory<ITextReplacer> {
+
+	public TextReplacerFactory() {
+		super(ITextReplacer.class, false); // not cached; depends on derived editor relation
+	}
+
+	@Override
+	public ITextReplacer create(Descriptor descriptor, SGLRParseController controller) {
+		return new TextReplacer(descriptor, controller);
+	}
+}
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ITextReplacer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ITextReplacer.java	Fri May 18 05:52:49 2012	(r24833)
@@ -0,0 +1,12 @@
+package org.strategoxt.imp.runtime.services;
+
+import org.eclipse.imp.language.ILanguageService;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+
+/**
+ * @author Oskar van Rest
+ */
+public interface ITextReplacer extends ILanguageService {
+	
+	void replaceText(IStrategoTerm resultTuple);
+}

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/TextReplacer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/TextReplacer.java	Fri May 18 05:52:49 2012	(r24833)
@@ -0,0 +1,94 @@
+package org.strategoxt.imp.runtime.services;
+
+import java.io.BufferedWriter;
+import java.io.File;
+import java.io.FileWriter;
+import java.io.IOException;
+
+import org.eclipse.core.resources.IProject;
+import org.eclipse.core.resources.IResource;
+import org.eclipse.core.runtime.CoreException;
+import org.eclipse.core.runtime.IPath;
+import org.eclipse.core.runtime.NullProgressMonitor;
+import org.spoofax.interpreter.terms.IStrategoString;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.imp.generator.construct_textual_change_4_0;
+import org.strategoxt.imp.runtime.dynamicloading.BadDescriptorException;
+import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
+import org.strategoxt.imp.runtime.dynamicloading.RefactoringFactory;
+import org.strategoxt.imp.runtime.parser.SGLRParseController;
+import org.strategoxt.imp.runtime.stratego.SourceAttachment;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+/**
+ * @author Oskar van Rest
+ */
+public class TextReplacer implements ITextReplacer {
+
+	private Descriptor descriptor;
+	private SGLRParseController controller;
+	
+	public TextReplacer(Descriptor descriptor, SGLRParseController controller) {
+		this.descriptor = descriptor;
+		this.controller = controller;
+	}
+
+	public void replaceText(IStrategoTerm resultTuple) {		
+		IStrategoTerm textreplace = null;
+		try {
+			File file = SourceAttachment.getFile(controller.getCurrentAst());
+			StrategoObserver observer = descriptor.createService(StrategoObserver.class, controller);
+			textreplace = construct_textual_change_4_0.instance.invoke(
+					observer.getRuntime().getCompiledContext(), 
+					resultTuple, 
+					createStrategy(RefactoringFactory.getPPStrategy(descriptor), file, observer),
+					createStrategy(RefactoringFactory.getParenthesizeStrategy(descriptor), file, observer),
+					createStrategy(RefactoringFactory.getOverrideReconstructionStrategy(descriptor), file, observer),
+					createStrategy(RefactoringFactory.getResugarStrategy(descriptor), file, observer)
+				);
+		} catch (BadDescriptorException e) {
+			e.printStackTrace();
+		}
+		
+		writeToFile((IStrategoString) textreplace.getSubterm(0).getSubterm(2));
+		queueAnalysisAffectedFile();
+	}
+	
+	private Strategy createStrategy(final String sname, final File file, final StrategoObserver observer) {
+		return new Strategy() {
+			@Override
+			public IStrategoTerm invoke(Context context, IStrategoTerm current) {
+				if (sname!=null)
+					return observer.invokeSilent(sname, current, file);
+				return null;
+			}
+		};
+	}
+	
+	// does this method exists already somewhere?
+	private void writeToFile(IStrategoString term) {
+		try {
+			File file = SourceAttachment.getFile(controller.getCurrentAst());
+			FileWriter fstream = new FileWriter(file);
+			BufferedWriter out = new BufferedWriter(fstream);
+			out.write(term.stringValue());
+			out.close();
+		} catch (IOException e) {
+			e.printStackTrace();
+		}
+		
+		IResource resource = controller.getResource();
+		try {
+			resource.refreshLocal(IResource.DEPTH_ZERO, new NullProgressMonitor());
+		} catch (CoreException e) {
+			e.printStackTrace();
+		}
+	}
+	
+	private void queueAnalysisAffectedFile() {
+		IPath path = controller.getResource().getProjectRelativePath();
+		IProject project = controller.getEditor().getProject().getRawProject();
+		StrategoAnalysisQueueFactory.getInstance().queueAnalysis(path, project, true);
+	}
+}

From oskarvanrest at gmail.com  Mon May 21 02:16:56 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 00:16:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24834 -
	text2model/branches/graphical-editor
Message-ID: <20120521001656.076227F8005@mx1.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 00:16:55 2012
New Revision: 24834
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24834&sc=1

Log:
Branch: want to use containment URI as identifier instead of uuid

Added:
   text2model/branches/graphical-editor/
      - copied from r24833, text2model/trunk/org.spoofax.text2model.bridges.API/

From oskarvanrest at gmail.com  Mon May 21 05:37:16 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 03:37:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24835 -
	text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java
Message-ID: <20120521033716.2EFF37F800E@mx1.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 03:37:14 2012
New Revision: 24835
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24835&sc=1

Log:
Use URI as identifier if this is the first EObject registered with URI. Generate UUID otherwise.

Modified:
   text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EObjectRegistry.java
   text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EcoreAPI.java

Modified: text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EObjectRegistry.java
==============================================================================
--- text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EObjectRegistry.java	Mon May 21 00:16:55 2012	(r24834)
+++ text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EObjectRegistry.java	Mon May 21 03:37:14 2012	(r24835)
@@ -11,6 +11,7 @@
 import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;
 import org.eclipse.emf.ecore.util.EcoreUtil;
 import org.eclipse.emf.ecore.xmi.impl.XMIResourceFactoryImpl;
+import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 
@@ -43,9 +44,13 @@
 		return resource;
 	}
 	
-	public String register(EObject o) {
+	public String register(EObject o, IStrategoList URI) {
 
-		String id = EcoreUtil.generateUUID();
+		String id = URI.toString();
+		
+		if (containsKey(id)) {
+			id = EcoreUtil.generateUUID();
+		}
 		
 		put(id, o);
 		

Modified: text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EcoreAPI.java
==============================================================================
--- text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EcoreAPI.java	Mon May 21 00:16:55 2012	(r24834)
+++ text2model/branches/graphical-editor/src/org/spoofax/text2model/bridges/API/java/EcoreAPI.java	Mon May 21 03:37:14 2012	(r24835)
@@ -21,6 +21,7 @@
 import org.eclipse.emf.ecore.resource.Resource;
 import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoInt;
+import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoReal;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
@@ -33,7 +34,7 @@
 public class EcoreAPI {
 
 	public static IStrategoString createInstance(
-			ITermFactory factory, IStrategoString packName, IStrategoString className) {
+			ITermFactory factory, IStrategoString packName, IStrategoString className, IStrategoList URI) {
 		
 		EPackage p = EPackage.Registry.INSTANCE.getEPackage(packName.stringValue());
 		
@@ -46,8 +47,8 @@
 			return null;
 		
 		EObject o = p.getEFactoryInstance().create(c);		
-
-		return factory.makeString(EObjectRegistry.INSTANCE.register(o));	
+		
+		return factory.makeString(EObjectRegistry.INSTANCE.register(o, URI));	
 	}
 	
 	public static IStrategoString setAttribute(

From oskarvanrest at gmail.com  Mon May 21 05:39:34 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 03:39:34 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24836 - in
	experimental/graphical-editor/EntityLang/EntityLang: META-INF
	editor editor/java/EntityLang/GMF
	editor/java/EntityLang/strategies trans
Message-ID: <20120521033934.01B3F2B8003@mx2.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 03:39:33 2012
New Revision: 24836
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24836&sc=1

Log:
Support for non-unique namespaces when transforming text to model.

Added:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/clear_EObjectRegistry_0_0.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_2.java
      - copied, changed from r24773, experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_1.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java
      - copied, changed from r24827, experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
Deleted:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_1.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java
Modified:
   experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
   experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/set_attribute_0_2.java
   experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str
   experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
   experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Mon May 21 03:39:33 2012	(r24836)
@@ -4,7 +4,8 @@
 Bundle-SymbolicName: EntityLang; singleton:=true
 Bundle-Version: 1.0.0
 Bundle-Activator: EntityLang.Activator
-Import-Package: org.osgi.framework;version="1.3.0"
+Import-Package: org.eclipse.ui.part,
+ org.osgi.framework;version="1.3.0"
 Require-Bundle: org.eclipse.core.runtime,
  org.eclipse.core.resources,
  org.eclipse.imp.runtime,
@@ -20,7 +21,8 @@
  org.eclipse.emf.transaction;bundle-version="1.4.0",
  org.eclipse.gmf.runtime.diagram.ui;bundle-version="1.5.0",
  org.spoofax.text2model.bridges.API;bundle-version="1.0.0",
- org.eclipse.gmf.runtime.diagram.ui.resources.editor;bundle-version="1.4.1"
+ org.eclipse.gmf.runtime.diagram.ui.resources.editor;bundle-version="1.4.1",
+ org.eclipse.ltk.core.refactoring;bundle-version="3.5.201"
 Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Bundle-ActivationPolicy: lazy
 Export-Package: EntityLang

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/EntityLang-Builders.esv	Mon May 21 03:39:33 2012	(r24836)
@@ -16,9 +16,9 @@
   observer : editor-analyze
                                                                                                                           
   builder  : "Generate Java code (for selection)"            = generate-java (openeditor) (realtime)                      
-  builder  : "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (meta) (source)     
-  builder  : "Show analyzed abstract syntax (for selection)" = generate-analyzed (openeditor) (realtime) (meta) (source)                                                                                                                           
-
+  builder  : "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (source)     
+  builder  : "Show analyzed abstract syntax (for selection)" = generate-analyzed (openeditor) (realtime) (source)                                                                                                                           
+  
 refactorings
 
   pretty-print : pp-entitylang-string
@@ -31,6 +31,10 @@
   refactoring ID : "Add Entity" = add-entity (source) (cursor)
     input
       identifier : "name" = ""
+
+  refactoring ID : "Add Property" = add-property (source) (cursor)
+    input
+      identifier : "name" = ""
       
   refactoring ID : "Remove Entity" = remove-entity (source) (cursor)
  

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Mon May 21 03:39:33 2012	(r24836)
@@ -1,45 +1,218 @@
 package EntityLang.GMF;
 
+import org.eclipse.core.resources.IFile;
+import org.eclipse.core.resources.ResourcesPlugin;
+import org.eclipse.core.runtime.IPath;
+import org.eclipse.core.runtime.Path;
+import org.eclipse.emf.common.notify.Notification;
+import org.eclipse.emf.common.util.EList;
 import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.EStructuralFeature;
 import org.eclipse.emf.ecore.resource.Resource;
 import org.eclipse.emf.ecore.resource.ResourceSet;
+import org.eclipse.emf.ecore.util.EContentAdapter;
 import org.eclipse.emf.transaction.TransactionalEditingDomain;
 import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramEditor;
+import org.eclipse.ui.IEditorInput;
+import org.eclipse.ui.IEditorPart;
 import org.eclipse.ui.IEditorReference;
 import org.eclipse.ui.IWorkbench;
 import org.eclipse.ui.IWorkbenchPage;
 import org.eclipse.ui.IWorkbenchWindow;
 import org.eclipse.ui.PlatformUI;
+import org.eclipse.ui.part.FileEditorInput;
+import org.spoofax.interpreter.terms.IStrategoList;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.terms.TermFactory;
+import org.strategoxt.imp.runtime.EditorState;
+import org.strategoxt.imp.runtime.dynamicloading.BadDescriptorException;
+import org.strategoxt.imp.runtime.services.ITextReplacer;
+
+import EntityLangModel.Module;
 
 public class GMFUtils {
 
 	/**
-	 * @param the EMF package name
-	 * @return diagram editor belonging to active Spoofax editor
+	 * Hardcoded for now
 	 */
-	public static DiagramEditor getDiagramEditor(String packName) {
+	public static DiagramEditor findDiagramEditor(String packName) {
+		return (DiagramEditor) findEditor("Test\\example.entitylangmodel_diagram", (packName + ".diagram.part." + packName + "DiagramEditorID"));
+	}
+	
+	/**
+	 * Hardcode for now
+	 */
+	public static IEditorPart findTextEditor() {
+		return findEditor("Test\\example.ent", "org.eclipse.imp.runtime.impEditor");
+	}
+
+	
+	private static IEditorPart findEditor(String path, String editorId) {
 		IWorkbench wb = PlatformUI.getWorkbench();
-		IWorkbenchWindow win = wb.getWorkbenchWindows()[0]; //what if multiple windows? (getActiveWorkbenchWindow doesn't work somehow)
+		IWorkbenchWindow win = wb.getWorkbenchWindows()[0]; // getActiveWorkbenchWindow doesn't work
 		IWorkbenchPage page = win.getActivePage();
-		IEditorReference[] editors = page.getEditorReferences();
-		DiagramEditor diagramEditor = null;
-		String editorID = (packName + ".diagram.part." + packName + "DiagramEditorID");
+
+		IPath iPath = new Path(path); 
+		IFile iFile = ResourcesPlugin.getWorkspace().getRoot().getFile(iPath);	
+		IEditorInput editorInput = new FileEditorInput(iFile);
+		
+		IEditorPart editor = null;
+		
+		IEditorReference[] editors = page.findEditors(editorInput, null, IWorkbenchPage.MATCH_INPUT);
 		for (int i = 0; i < editors.length; i++) {
-			if (editors[i].getId().equals(editorID)) {
-				diagramEditor = (DiagramEditor) editors[i].getEditor(false);
+			if (editors[i].getId().equals(editorId)) {
+				editor = editors[i].getEditor(false);
 			}
 		}
-		return diagramEditor;
+		
+		return editor;
 	}
 	
-	public static EObject getSemanticModel(DiagramEditor diagramEditor) {
-		Resource semanticModelResource = getSemanticModelResource(diagramEditor);
-		return semanticModelResource.getContents().get(0);
+
+	public static IStrategoTerm getCurrentAST() {
+		return EditorState.getEditorFor(findTextEditor()).getCurrentAst();
 	}
-	
+
 	public static Resource getSemanticModelResource(DiagramEditor diagramEditor) {
 		TransactionalEditingDomain editingDomain = diagramEditor.getEditingDomain();
 		ResourceSet diagramEditorResourceSet = editingDomain.getResourceSet();
 		return diagramEditorResourceSet.getResources().get(1);
 	}
+	
+	public static EObject getSemanticModel(DiagramEditor diagramEditor) {
+		Resource semanticModelResource = getSemanticModelResource(diagramEditor);
+		if (semanticModelResource.getContents().size() != 0)
+			return semanticModelResource.getContents().get(0);
+		else
+			return null;
+	}
+
+	private static Module module;
+	private static ContentAdapter contentAdapter = new ContentAdapter(null);
+
+	public static void addContentAdapter() {
+		DiagramEditor diagramEditor = GMFUtils.findDiagramEditor("EntityLangModel");
+		if (diagramEditor != null) {
+			module = (Module) GMFUtils.getSemanticModel(diagramEditor);
+			if (module != null) {
+				module.eAdapters().add(contentAdapter);
+			}
+		}
+	}
+
+	public static void removeContentAdapter() {
+		if (module != null) {
+			if (module.eAdapters().contains(contentAdapter)) {
+				module.eAdapters().remove(contentAdapter);
+			}
+		}
+	}
+
+	public static IStrategoTerm EMF2Term() {
+		EObject module = getSemanticModel(findDiagramEditor("EntityLangModel"));
+		return EMF2Term(module);
+	}
+
+	public static TermFactory f = new TermFactory();
+
+	public static IStrategoTerm EMF2Term(EObject object) {
+		if (object.eClass().getName().equals("Module")) {
+			EStructuralFeature feature = object.eClass().getEStructuralFeature("identifier");
+			IStrategoTerm name = f.makeString("Module");
+			if (object.eGet(feature) != null) {
+				name = f.makeString(object.eGet(feature).toString());
+			}
+	
+			EList<?> definitions = (EList<?>) object.eGet(object.eClass().getEStructuralFeature("definitions"));
+			IStrategoList entities = f.makeList();
+			for (int i = definitions.size() - 1; i >= 0; i--) {
+				entities = f.makeListCons(EMF2Term((EObject) definitions.get(i)), entities);
+			}
+			return f.makeAppl(f.makeConstructor("Module", 2), name, entities);
+		} else if (object.eClass().getName().equals("Entity")) {
+			EStructuralFeature feature = object.eClass().getEStructuralFeature("identifier");
+			IStrategoTerm name = f.makeString("Entity");
+			if (object.eGet(feature) != null) {
+				name = f.makeString(object.eGet(feature).toString());
+			}
+			
+			EList<?> props = (EList<?>) object.eGet(object.eClass().getEStructuralFeature("properties"));
+			IStrategoList properties = f.makeList();
+			for (int i = props.size() - 1; i >= 0; i--) {
+				properties = f.makeListCons(EMF2Term((EObject) props.get(i)), properties);
+			}
+			
+			return f.makeAppl(f.makeConstructor("Entity", 2), name, properties);
+		} else if (object.eClass().getName().equals("Property")) {
+			EStructuralFeature feature = object.eClass().getEStructuralFeature("identifier");
+			IStrategoTerm name = f.makeString("Property");
+			if (object.eGet(feature) != null) {
+				name = f.makeString(object.eGet(feature).toString());
+			}
+
+			EStructuralFeature feature2 = object.eClass().getEStructuralFeature("type");
+			IStrategoTerm propertyType = f.makeString("Type");
+			if (object.eGet(feature2) != null) {
+				EObject type = (EObject) object.eGet(feature2);
+				EStructuralFeature feature3 = type.eClass().getEStructuralFeature("identifier");
+				propertyType = f.makeString(type.eGet(feature3).toString());
+			}
+
+			IStrategoTerm type = f.makeAppl(f.makeConstructor("Type", 1), propertyType);
+			return f.makeAppl(f.makeConstructor("Property", 2), name, type);
+		}
+		return null;
+	}
+
+}
+
+class ContentAdapter extends EContentAdapter {
+
+	private IEditorPart editor;
+	
+	public ContentAdapter(IEditorPart editor) {
+		this.editor = editor;
+	}
+	
+	public void notifyChanged(Notification n) {
+		super.notifyChanged(n);
+
+		if (n.getEventType() != Notification.REMOVING_ADAPTER) {
+			IStrategoTerm currentTerm = GMFUtils.getCurrentAST();
+			IStrategoTerm newTerm = GMFUtils.EMF2Term();
+			TermFactory f = new TermFactory();
+			EditorState editor = EditorState.getEditorFor(GMFUtils.findTextEditor());
+			ITextReplacer textReplacer = null;
+			try {
+				textReplacer = editor.getDescriptor().createService(ITextReplacer.class, editor.getParseController());
+			} catch (BadDescriptorException e) {
+				e.printStackTrace();
+			}
+			textReplacer.replaceText(f.makeList(f.makeTuple(currentTerm, newTerm)));
+//			IStrategoTerm tuple = ((IStrategoList) textReplacement).head();
+//			IStrategoString replacement = (IStrategoString) tuple.getSubterm(2);
+//
+//			try {
+//	
+////				URI uri = URI.create(arg0)
+//				File file = new File("D:\\runtime-New_configuration_4\\Test\\example.ent");
+//				IPath path = new Path(file.getAbsolutePath()); 
+//				IFile iFile = ResourcesPlugin.getWorkspace().getRoot().getFile(path); 
+//				System.out.println(iFile!=null?"exists":"doesn't exist");
+//				System.out.println(path.toString());
+//				
+//				FileWriter fstream = new FileWriter(file);
+//				BufferedWriter out = new BufferedWriter(fstream);
+//				out.write(replacement.stringValue());
+//				out.close();
+////				iFile.touch(new NullProgressMonitor());
+////				iFile.refreshLocal(IResource.DEPTH_INFINITE, new NullProgressMonitor());
+//				
+//			} catch (Exception e) {
+//				e.printStackTrace();
+//			}
+
+		}
+	}
+
 }

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/InteropRegisterer.java	Mon May 21 03:39:33 2012	(r24836)
@@ -11,11 +11,12 @@
   public InteropRegisterer() {
     super(new Strategy[] { 
     		java_strategy_0_0.instance,
-    		create_instance_0_1.instance,
+    		clear_EObjectRegistry_0_0.instance,
+    		create_instance_0_2.instance,
     		set_attribute_0_2.instance,
     		set_reference_0_2.instance,
     		serialise_0_1.instance,
-    		replace_gmf_resource_0_1.instance
+    		replace_gmf_resource_0_2.instance
     });
   }
 }

Added: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/clear_EObjectRegistry_0_0.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/clear_EObjectRegistry_0_0.java	Mon May 21 03:39:33 2012	(r24836)
@@ -0,0 +1,18 @@
+package EntityLang.strategies;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.text2model.bridges.API.java.EObjectRegistry;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+public class clear_EObjectRegistry_0_0 extends Strategy {
+
+	public static clear_EObjectRegistry_0_0 instance = new clear_EObjectRegistry_0_0();
+
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current) {
+		EObjectRegistry.INSTANCE.clear();
+		return current;
+	}
+
+}

Copied and modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_2.java (from r24773, experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_1.java)
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_1.java	Wed May  2 23:35:15 2012	(r24773, copy source)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/create_instance_0_2.java	Mon May 21 03:39:33 2012	(r24836)
@@ -1,18 +1,19 @@
 package EntityLang.strategies;
 
+import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.text2model.bridges.API.java.EcoreAPI;
 import org.strategoxt.lang.Context;
 import org.strategoxt.lang.Strategy;
 
-public class create_instance_0_1 extends Strategy {
+public class create_instance_0_2 extends Strategy {
 
-	public static create_instance_0_1 instance = new create_instance_0_1();
+	public static create_instance_0_2 instance = new create_instance_0_2();
 
 	@Override
-	public IStrategoTerm invoke(Context context, IStrategoTerm className, IStrategoTerm packName) {
-		return EcoreAPI.createInstance(context.getFactory(), (IStrategoString) packName, (IStrategoString) className);
+	public IStrategoTerm invoke(Context context, IStrategoTerm className, IStrategoTerm packName, IStrategoTerm URI) {
+		return EcoreAPI.createInstance(context.getFactory(), (IStrategoString) packName, (IStrategoString) className, (IStrategoList) URI);
 	}
 
 }

Copied and modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java (from r24827, experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java)
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_1.java	Sun May 13 23:56:36 2012	(r24827, copy source)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Mon May 21 03:39:33 2012	(r24836)
@@ -6,15 +6,8 @@
 import java.util.Collections;
 
 import org.eclipse.emf.ecore.resource.Resource;
-import org.eclipse.emf.ecore.resource.ResourceSet;
-import org.eclipse.emf.transaction.TransactionalEditingDomain;
 import org.eclipse.gmf.runtime.diagram.ui.parts.DiagramEditor;
 import org.eclipse.ui.IEditorInput;
-import org.eclipse.ui.IEditorReference;
-import org.eclipse.ui.IWorkbench;
-import org.eclipse.ui.IWorkbenchPage;
-import org.eclipse.ui.IWorkbenchWindow;
-import org.eclipse.ui.PlatformUI;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.lang.Context;
@@ -24,23 +17,26 @@
 import EntityLangModel.diagram.part.EntityLangModelDiagramEditorPlugin;
 import EntityLangModel.diagram.part.EntityLangModelDocumentProvider;
 
-public class replace_gmf_resource_0_1 extends Strategy {
+public class replace_gmf_resource_0_2 extends Strategy {
 
-	public static replace_gmf_resource_0_1 instance = new replace_gmf_resource_0_1();
+	public static replace_gmf_resource_0_2 instance = new replace_gmf_resource_0_2();
 
 	public static String lastSerialisedModel = "";
 	
 	@Override
-	public IStrategoTerm invoke(Context context, IStrategoTerm serialisedModel, IStrategoTerm packName) {
-		if (((IStrategoString) serialisedModel).stringValue().equals(lastSerialisedModel)) {
-			System.out.println("No change since last update");
-			return context.getFactory().makeString("0");
-		}
-		else {
-			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
-		}
+	public IStrategoTerm invoke(Context context, IStrategoTerm serialisedModel, IStrategoTerm packName, IStrategoTerm filename) {
+//		if (((IStrategoString) serialisedModel).stringValue().equals(lastSerialisedModel)) {
+//			System.out.println("No change since last update");
+//			return context.getFactory().makeString("0");
+//		}
+//		else {
+//			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
+//		}
+		System.out.println(filename.toString());
+		
+		GMFUtils.removeContentAdapter();
 		
-		DiagramEditor diagramEditor = GMFUtils.getDiagramEditor(((IStrategoString) packName).stringValue());
+		DiagramEditor diagramEditor = GMFUtils.findDiagramEditor(((IStrategoString) packName).stringValue());
 
 		if (diagramEditor == null) {
 			System.out.println("GMF editor not found. Please open it manually");
@@ -63,6 +59,8 @@
 					}
 					documentProvider.fireElementContentReplaced(editorInput);
 					documentProvider.setCanSaveDocument(editorInput);
+					
+					GMFUtils.addContentAdapter();
 				}
 			}
 		});

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/set_attribute_0_2.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/set_attribute_0_2.java	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/set_attribute_0_2.java	Mon May 21 03:39:33 2012	(r24836)
@@ -12,6 +12,8 @@
 
 	@Override
 	public IStrategoTerm invoke(Context context, IStrategoTerm value, IStrategoTerm element, IStrategoTerm featureName) {
+		
+		
 		return EcoreAPI.setAttribute((IStrategoString) element, (IStrategoString) featureName, value);
 	    
 	}

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Mon May 21 03:39:33 2012	(r24836)
@@ -6,87 +6,67 @@
 
 strategies
 	
-	to-emf(|path) = topdown(try(create-object(|path))); topdown(try(set-structural-features))
-	serialise-model(|path) = lookup-identifier; serialise(|path)
+	to-emf(|path) = clear-EObjectRegistry; topdown(try(create-object(|path))); topdown(try(set-structural-features))
+	serialise-model(|path) = get-identifier; serialise(|path)
 
 rules
 	
 	create-object(|path):
-		e at Module(name, entities) -> e
+		Module(name, entities) -> Module(identifier, name, entities)
 		with
-			identifier := <create-instance(|<packName>)> "Module";
-			<map-identifier(|path)> (name, identifier)
+			[URI] := <get-annos> name;
+			identifier := <create-instance(|<packName>, URI)> "Module"
 	 	
 	create-object(|path):
-		e at Entity(name, properties) -> e
+		Entity(name, properties) -> Entity(identifier, name, properties)
 		with
-			identifier := <create-instance(|<packName>)> "Entity";
-			<map-identifier(|path)> (name, identifier)
+			[URI] := <get-annos> name;
+			identifier := <create-instance(|<packName>, URI)> "Entity"
 			
 	create-object(|path):
-		e at Property(name, Type(typeRef)) -> e
+		Property(name, type) -> Property(identifier, name, type)
 		with
-			identifier := <create-instance(|<packName>)> "Property";
-			<map-identifier(|path)> (name, identifier)
-			
+			[URI] := <get-annos> name;
+			identifier := <create-instance(|<packName>, URI)> "Property"
+
 rules
 
 	set-structural-features:
-		e at Module(name, entities) -> e
+		e at Module(identifier, name, entities) -> e
 		with
-			identifier := <lookup-identifier> e;
 			<set-attribute(|identifier, "identifier")> name;
-			entities' := <map(lookup-identifier)> entities;
+			entities' := <map(get-identifier)> entities;
 			<set-reference(|identifier, "definitions")> entities'
 	 	
 	set-structural-features:
-		e at Entity(name, properties) -> e
+		e at Entity(identifier, name, properties) -> e
 		with
-			identifier := <lookup-identifier> e;
 			<set-attribute(|identifier, "identifier")> name;			
-			properties' := <map(lookup-identifier)> properties;
+			properties' := <map(get-identifier)> properties;
 			<set-reference(|identifier, "properties")> properties'
 			
 	set-structural-features:
-		e at Property(name, Type(typeRef)) -> e
+		e at Property(identifier, name, Type(typeRef)) -> e
 		with
-			identifier := <lookup-identifier> e;
 			<set-attribute(|identifier, "identifier")> name;
-			typeRef_identifier := <lookup-identifier> typeRef;
-			<set-reference(|identifier, "type")> typeRef_identifier	
+			[URI] := <get-annos> typeRef;
+			<set-reference(|identifier, "type")> <write-to-string> URI
 
 rules
 	
-	map-identifier(|path):
-		(namespaceDef, identifier) -> identifier
-		with
-			[URI] := <get-annos> namespaceDef;
-			<index-add-all(|path)> [DefData(URI, EMFObject(), identifier)]
-
-	lookup-identifier:
-		Module(name, entities) -> identifier
-		with
-			identifier := <lookup-identifier> name
+	get-identifier:
+		Module(identifier, _, _) -> identifier
 
-	lookup-identifier:
-		Entity(name, properties) -> identifier
-		with
-			identifier := <lookup-identifier> name
-			
-	lookup-identifier:
-		Property(name, Type(typeRef)) -> identifier
-		with
-			identifier := <lookup-identifier> name
+	get-identifier:
+		Entity(identifier, _, _) -> identifier
 
-	lookup-identifier:
-		namespaceDef -> identifier
-		where
-			[URI] := <get-annos> namespaceDef;
-			identifier := <indexlib-get-value> DefData(URI, EMFObject(), ())
+	get-identifier:
+		Property(identifier, _, _) -> identifier	
 			
 rules
 	
-	external create-instance(|packName)
+	external clear-EObjectRegistry(|)
+	external create-instance(|packName, URI)
 	external set-attribute(|element, featureName)
 	external set-reference(|element, featureName)
 	external serialise(|resourceURI)
@@ -98,4 +78,7 @@
 signature constructors
 
 	EMFObject			: Namespace
+	Module				: identifier * name * entities -> Module
+	Entity				: identifier * name * properties -> Entity
+	Property			: identifier * name * type -> Property
 	
\ No newline at end of file

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Mon May 21 03:39:33 2012	(r24836)
@@ -69,15 +69,12 @@
 
   generate-emf:
     ([ast'], path) -> result
-    with      
-      // EMF stuff below
-      fileExtension := <lower-case> <packName>;
-      filename := <guarantee-extension(|fileExtension)> path;
-      // <initialize-emf-package> <packName>;
+    where      
+      GMFFileExtension := <conc-strings> (<lower-case> <packName>, "_diagram");
+      GMFFile := <guarantee-extension(|GMFFileExtension)> path;
       ast''  := <to-emf(|path)> ast';
       result := <serialise-model(|path)> ast'';
-      <replace-gmf-resource(|<packName>)> result//;
-     // create-listener
+      <replace-gmf-resource(|<packName>, GMFFile)> result
       
   save-emf:
   	(selected, position, ast, path, project-path) -> None()
@@ -85,7 +82,7 @@
   	// 	<save> ast
   
   // external initialize-emf-package(|)
-  external replace-gmf-resource(|packName)
+  external replace-gmf-resource(|packName, fileName)
   // external save(|)
   external create-listener(|)
 

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str	Mon May 21 03:37:14 2012	(r24835)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/refactor.str	Mon May 21 03:39:33 2012	(r24836)
@@ -45,6 +45,22 @@
 		where
 			entities' := <conc> (entities, [Entity(name, [])])
 
+	add-property:
+		(name, selected-name, position, ast, path, project-path) -> ([(ast, new-ast)], fatal-errors, errors, warnings)
+		with
+			new-ast  := <topdown(try(add-property(|selected-name, name)))> ast; 
+			(errors, warnings) := <semantic-constraint-issues> (ast, new-ast);
+			fatal-errors := [] 
+ 
+	add-property(|selected-name, name):
+		Entity(entityName, properties) -> Entity(entityName, properties')
+		where
+			<debug> (selected-name, entityName);
+			<eq> (selected-name, entityName);
+			<debug> "equal";
+			properties' := <conc> (properties, [Property(name, Type(entityName))])
+
+
 rules
 	    
   semantic-constraint-issues:

From oskarvanrest at gmail.com  Mon May 21 05:56:56 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 03:56:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24837 -
	experimental/graphical-editor/EntityLang/EntityLang/trans
Message-ID: <20120521035656.EA6657F8012@mx1.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 03:56:56 2012
New Revision: 24837
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24837&sc=1

Log:
Bug fix: text2model failed when there was an unresolved reference

Modified:
   experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Mon May 21 03:39:33 2012	(r24836)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Mon May 21 03:56:56 2012	(r24837)
@@ -50,7 +50,9 @@
 		with
 			<set-attribute(|identifier, "identifier")> name;
 			[URI] := <get-annos> typeRef;
-			<set-reference(|identifier, "type")> <write-to-string> URI
+			if not (<?Unresolved(_)> <index(|1)> URI)
+				then <set-reference(|identifier, "type")> <write-to-string> URI
+			end
 
 rules
 	

From oskarvanrest at gmail.com  Mon May 21 06:06:13 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 04:06:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24838 - in
	experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang:
	GMF strategies
Message-ID: <20120521040613.594E42B8011@mx2.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 04:06:13 2012
New Revision: 24838
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24838&sc=1

Log:
Trigger doSave(..) for text editor before changing its resource.

Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Mon May 21 03:56:56 2012	(r24837)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Mon May 21 04:06:13 2012	(r24838)
@@ -3,6 +3,7 @@
 import org.eclipse.core.resources.IFile;
 import org.eclipse.core.resources.ResourcesPlugin;
 import org.eclipse.core.runtime.IPath;
+import org.eclipse.core.runtime.NullProgressMonitor;
 import org.eclipse.core.runtime.Path;
 import org.eclipse.emf.common.notify.Notification;
 import org.eclipse.emf.common.util.EList;
@@ -178,6 +179,8 @@
 		super.notifyChanged(n);
 
 		if (n.getEventType() != Notification.REMOVING_ADAPTER) {
+			GMFUtils.findTextEditor().doSave(new NullProgressMonitor());
+			
 			IStrategoTerm currentTerm = GMFUtils.getCurrentAST();
 			IStrategoTerm newTerm = GMFUtils.EMF2Term();
 			TermFactory f = new TermFactory();

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Mon May 21 03:56:56 2012	(r24837)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Mon May 21 04:06:13 2012	(r24838)
@@ -25,14 +25,13 @@
 	
 	@Override
 	public IStrategoTerm invoke(Context context, IStrategoTerm serialisedModel, IStrategoTerm packName, IStrategoTerm filename) {
-//		if (((IStrategoString) serialisedModel).stringValue().equals(lastSerialisedModel)) {
-//			System.out.println("No change since last update");
-//			return context.getFactory().makeString("0");
-//		}
-//		else {
-//			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
-//		}
-		System.out.println(filename.toString());
+		if (((IStrategoString) serialisedModel).stringValue().equals(lastSerialisedModel)) {
+			System.out.println("No change since last update");
+			return context.getFactory().makeString("0");
+		}
+		else {
+			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
+		}
 		
 		GMFUtils.removeContentAdapter();
 		

From oskarvanrest at gmail.com  Mon May 21 13:47:12 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 11:47:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24839 - in
	experimental/graphical-editor/combe: . branches tags trunk
Message-ID: <20120521114712.CDDE42B800C@mx2.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 11:47:10 2012
New Revision: 24839
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24839&sc=1

Log:
Set-up for ComBE (Combined editor for Behavior Engineering)

Added:
   experimental/graphical-editor/combe/
   experimental/graphical-editor/combe/branches/
   experimental/graphical-editor/combe/tags/
   experimental/graphical-editor/combe/trunk/

From oskarvanrest at gmail.com  Mon May 21 13:59:40 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 11:59:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24840 -
	experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual
Message-ID: <20120521115940.5BF0BCC09D@mx4.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 11:59:38 2012
New Revision: 24840
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24840&sc=1

Log:
Initial import.

Added:
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/

From oskarvanrest at gmail.com  Mon May 21 14:01:45 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Mon, 21 May 2012 12:01:45 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24841 - in
	experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual:
	. .externalToolBuilders .settings META-INF editor editor/java
	editor/java/org e...
Message-ID: <20120521120145.73F63108C017@mx3.tudelft.nl>

Author: OskarVanRest
Date: Mon May 21 12:01:45 2012
New Revision: 24841
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24841&sc=1

Log:
Set-up for ComBE (Combined editor for Behavior Engineering)

Added:
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.classpath
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.externalToolBuilders/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.externalToolBuilders/ComBE build.main.xml.launch
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.project
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.settings/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.settings/org.eclipse.jdt.core.prefs
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/META-INF/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/META-INF/MANIFEST.MF
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.generated.xml
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.main.xml
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.properties
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Builders.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Colorer.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Completions.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Folding.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Outliner.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-References.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Syntax.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE.main.esv
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/Activator.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEParseController.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEParseControllerGenerated.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEValidator.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/InteropRegisterer.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/Main.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/java_strategy_0_0.java
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-auto.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-library-internal.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-library.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/compilation-library.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/editor-common.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/index-library.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/refactor-common.generated.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/plugin.xml
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.generated.pp
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.pp
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.sdf
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/Common.sdf
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/test/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/test/example.bt
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/analysis-manual.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/check.str
   experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/combe.str

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.classpath
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.classpath	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<classpath>
+	<classpathentry kind="src" excluding="trans/**" path="editor/java"/>
+	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/J2SE-1.5"/>
+	<classpathentry kind="con" path="org.eclipse.pde.core.requiredPlugins"/>
+	<classpathentry kind="con" path="org.eclipse.jdt.junit.JUNIT_CONTAINER/4"/>
+	<classpathentry kind="output" path="bin"/>
+</classpath>
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.externalToolBuilders/ComBE build.main.xml.launch
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.externalToolBuilders/ComBE build.main.xml.launch	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,23 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no"?>
+<launchConfiguration type="org.eclipse.ant.AntLaunchConfigurationType">
+<stringAttribute key="bad_container_name" value=".externalToolBuilders"/>
+<booleanAttribute key="org.eclipse.ant.ui.DEFAULT_VM_INSTALL" value="false"/>
+<listAttribute key="org.eclipse.debug.core.MAPPED_RESOURCE_PATHS"/>
+<listAttribute key="org.eclipse.debug.core.MAPPED_RESOURCE_TYPES"/>
+<booleanAttribute key="org.eclipse.debug.ui.ATTR_LAUNCH_IN_BACKGROUND" value="false"/>
+<listAttribute key="org.eclipse.jdt.launching.CLASSPATH">
+<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#10;&lt;runtimeClasspathEntry containerPath=&quot;org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/java-1.5.0-sun-1.5.0.18&quot; path=&quot;1&quot; type=&quot;4&quot;/&gt;&#10;"/>
+<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#10;&lt;runtimeClasspathEntry id=&quot;org.eclipse.ant.ui.classpathentry.antHome&quot;&gt;&#10;&lt;memento default=&quot;true&quot;/&gt;&#10;&lt;/runtimeClasspathEntry&gt;&#10;"/>
+<listEntry value="&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;&#10;&lt;runtimeClasspathEntry id=&quot;org.eclipse.ant.ui.classpathentry.extraClasspathEntries&quot;&gt;&#10;&lt;memento/&gt;&#10;&lt;/runtimeClasspathEntry&gt;&#10;"/>
+</listAttribute>
+<stringAttribute key="org.eclipse.jdt.launching.CLASSPATH_PROVIDER" value="org.eclipse.ant.ui.AntClasspathProvider"/>
+<booleanAttribute key="org.eclipse.jdt.launching.DEFAULT_CLASSPATH" value="false"/>
+<stringAttribute key="org.eclipse.jdt.launching.PROJECT_ATTR" value=""/>
+<stringAttribute key="org.eclipse.jdt.launching.SOURCE_PATH_PROVIDER" value="org.eclipse.ant.ui.AntClasspathProvider"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_ANT_TARGETS" value="all,"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_LAUNCH_CONFIGURATION_BUILD_SCOPE" value="${none}"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_LOCATION" value="${workspace_loc:/org.behaviorengineering.combe.textual/build.main.xml}"/>
+<booleanAttribute key="org.eclipse.ui.externaltools.ATTR_TRIGGERS_CONFIGURED" value="true"/>
+<stringAttribute key="org.eclipse.ui.externaltools.ATTR_WORKING_DIRECTORY" value="${workspace_loc:/org.behaviorengineering.combe.textual}"/>
+<stringAttribute key="process_factory_id" value="org.eclipse.ant.ui.remoteAntProcessFactory"/>
+</launchConfiguration>

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.project
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.project	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<projectDescription>
+      <name>org.behaviorengineering.combe.textual</name>
+      <comment></comment>
+      <buildSpec>
+        <buildCommand>
+          <name>org.eclipse.jdt.core.javabuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+        <buildCommand>
+            <name>org.eclipse.ui.externaltools.ExternalToolBuilder</name>
+            <triggers>full,incremental,</triggers>
+            <arguments>
+                <dictionary>
+                    <key>LaunchConfigHandle</key>
+                    <value>&lt;project&gt;/.externalToolBuilders/ComBE build.main.xml.launch</value>
+                </dictionary>
+            </arguments>
+        </buildCommand>
+        <buildCommand>
+          <name>org.eclipse.pde.ManifestBuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+        <buildCommand>
+          <name>org.eclipse.pde.SchemaBuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+      </buildSpec>
+      <natures>
+        <nature>org.eclipse.pde.PluginNature</nature>
+        <nature>org.eclipse.jdt.core.javanature</nature>
+      </natures>
+    </projectDescription>
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.settings/org.eclipse.jdt.core.prefs
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/.settings/org.eclipse.jdt.core.prefs	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,11 @@
+eclipse.preferences.version=1
+org.eclipse.jdt.core.compiler.codegen.inlineJsrBytecode=enabled
+org.eclipse.jdt.core.compiler.codegen.targetPlatform=1.5
+org.eclipse.jdt.core.compiler.codegen.unusedLocal=preserve
+org.eclipse.jdt.core.compiler.compliance=1.5
+org.eclipse.jdt.core.compiler.debug.lineNumber=generate
+org.eclipse.jdt.core.compiler.debug.localVariable=generate
+org.eclipse.jdt.core.compiler.debug.sourceFile=generate
+org.eclipse.jdt.core.compiler.problem.assertIdentifier=error
+org.eclipse.jdt.core.compiler.problem.enumIdentifier=error
+org.eclipse.jdt.core.compiler.source=1.5

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/META-INF/MANIFEST.MF
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/META-INF/MANIFEST.MF	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,22 @@
+Manifest-Version: 1.0
+Bundle-ManifestVersion: 2
+Bundle-Name: ComBE Plug-in
+Bundle-SymbolicName: org.behaviorengineering.combe.textual; singleton:=true
+Bundle-Version: 1.0.0
+Bundle-Activator: org.behaviorengineering.combe.textual.Activator
+Import-Package: org.osgi.framework;version="1.3.0"
+Require-Bundle: org.eclipse.core.runtime,
+  org.eclipse.core.resources,
+  org.eclipse.imp.runtime,
+  org.eclipse.ui,
+  lpg.runtime,
+  org.eclipse.jface.text,
+  org.eclipse.ui.editors,
+  org.eclipse.ui.workbench.texteditor,
+  org.strategoxt.imp.runtime,
+  org.spoofax.jsglr,
+  org.strategoxt.strj
+Bundle-RequiredExecutionEnvironment: J2SE-1.5
+Bundle-ActivationPolicy: lazy
+Export-Package: org.behaviorengineering.combe.textual
+Eclipse-RegisterBuddy: org.strategoxt.imp.runtime

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.generated.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.generated.xml	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,640 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<project name="build.generated">
+
+        <target name="spoofaximp.default" depends="spoofaximp.default.ctree"/>
+        <target name="spoofaximp.default.ctree" depends="check-classpath,init,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,java.jar,stratego.ctree,sdf2imp,refresh"/>
+        <target name="spoofaximp.default.jar" depends="check-classpath,init,sdf2table,meta-sdf2table,ppgen,pppack,stratego.aster,java.jar,stratego.jar.helper,sdf2imp,refresh"/>
+    
+        <!-- Initialization -->
+        <available file="${src-gen}/org/behaviorengineering/combe/textual/strategies/Main.java" property="java.jar.enabled"/>
+        <condition property="java.jar.import" value="-la org.behaviorengineering.combe.textual.strategies" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <condition property="java.jar.classpath" value=":${include}/${strmodule}-java.jar" else="">
+            <isset property="java.jar.enabled"/>
+        </condition>
+        <available file="${trans}/${strmodule}.str" property="build.stratego.enabled"/>
+        <dirname property="externaldefdir" file="${externaldef}"/>
+        <condition property="externaldefimport" value="-I &quot;${externaldefdir}&quot;" else="">
+            <isset property="externaldef"/>
+        </condition>
+        <condition property="externaljarimport1" value=":${externaljar}" else="">
+            <isset property="externaljar"/>
+        </condition>
+        <condition property="externaljarimport2" value=":${externaljarx}" else="">
+            <isset property="externaljarx"/>
+        </condition>
+        <condition property="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter">
+            <isset property="eclipse.running"/>
+        </condition>
+        <condition property="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter">
+            <available classname="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+        </condition>
+        <condition property="externaljarflags" value="${externaljarflags}" else="">
+            <isset property="externaljarflags"/>
+        </condition>
+        <condition property="metasdfmodule.available" value="1">
+            <available file="${syntax}/${metasdfmodule}.sdf"/>
+        </condition>
+        
+        <fail unless="build" message="Please use build.main.xml to build this project or configure the required properties manually"/>
+        <mkdir dir="${build}"/>
+        <mkdir dir="${src-gen}"/>
+        <mkdir dir="${dist}"/>
+        <mkdir dir="${include}"/>
+        <mkdir dir="${lib}"/>
+        <mkdir dir="${syntax}"/>
+
+        <target name="sdf2imp" depends="sdf2table,sdf2imp.eclipse,sdf2imp.standalone,sdf2parenthesize"/>
+        
+        <target name="sdf2imp.eclipse" if="eclipse.running" depends="sdf2rtg">
+            <java classname="org.strategoxt.imp.metatooling.building.AntDescriptorBuilder" failonerror="true">
+                <arg value="${include}/${esvmodule}.packed.esv"/>
+            </java>
+        </target>
+        
+        <target name="refresh" if="eclipse.running">
+            <eclipse.convertPath fileSystemPath="${basedir}" property="projectdir"/>
+            <eclipse.convertPath fileSystemPath="${syntax}" property="syntaxdir"/>
+            <eclipse.convertPath fileSystemPath="${lib}" property="libdir"/>
+            <eclipse.refreshLocal resource="${libdir}" depth="infinite"/>
+            <eclipse.refreshLocal resource="${syntaxdir}/${sdfmodule}.pp.generated" depth="infinite"/>
+            <eclipse.refreshLocal resource="${libdir}/editor-common.generated.str" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/build.generated.xml" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Builders.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Colorer.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Completions.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Folding.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-References.generated.esv" depth="infinite"/>
+            <eclipse.refreshLocal resource="${projectdir}/editor/${sdfmodule}-Syntax.generated.esv" depth="infinite"/>
+            <eclipse.convertPath fileSystemPath="${src-gen}" property="eclipse.path.src-gen"/>
+            <eclipse.refreshLocal resource="${eclipse.path.src-gen}" depth="infinite"/>
+            <eclipse.convertPath fileSystemPath="${build}" property="eclipse.path.build"/>
+            <eclipse.refreshLocal resource="${eclipse.path.build}" depth="infinite"/>
+            <!-- Might cause the editor to be reloaded?
+            <eclipse.refreshLocal resource="${projectdir}/include" depth="infinite" />
+            -->
+        </target>
+        
+        <target name="sdf2imp.standalone" unless="eclipse.running" depends="sdf2rtg">
+            <java classname="org.strategoxt.imp.generator.sdf2imp" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${basedir}/editor/${esvmodule}.main.esv"/>
+                <arg value="-p"/>
+                <arg value="${include}/${sdfmodule}.tbl"/>
+            </java>
+        </target>
+        
+        <target name="check-classpath">
+            <available classname="org.strategoxt.imp.generator.sdf2imp" property="check-classpath.available"/>
+            <antcall target="check-classpath.helper"/>  
+        </target>
+        
+        <target name="init" if="eclipse.running">
+            <!-- refresh one file/dir in the project to trigger an Ant rebuild with the next build command -->
+            <java classname="org.strategoxt.imp.metatooling.building.AntForceRefreshScheduler" failonerror="false">
+                <arg value="${include}"/>
+            </java>
+        </target>
+  
+        <target name="check-classpath.helper" unless="check-classpath.available">
+            <echo level="error" message="Could not load the Spoofax plugin loading classes."/>
+            <echo level="error" message="Make sure it is on the class path."/>
+            <echo level="error" message=""/>               
+            <echo level="error" message="In Eclipse, make sure the Ant builder is configured properly:"/>
+            <echo level="error" message="right-click on build.main.xml, go to Run as, Ant build..., JRE tab,"/>
+            <echo level="error" message="and ensure Run in the same JRE as the workspace is selected"/>
+            <echo level="error" message="alternatively, build the project using Build Project in the Project menu"/>
+            <fail/>
+        </target>
+    
+        <target name="sdf2table" depends="make-permissive">
+            <apply executable="${build.strategoxt.sdf}sdf2table" dest="${include}" failonerror="true">
+                <arg value="-i"/>
+                <srcfile/>
+                <arg value="-o"/>
+                <targetfile/>
+                <arg value="-m"/>
+                <arg value="${sdfmodule}"/>
+                
+                <fileset file="${include}/${sdfmodule}-Permissive.def"/>
+                <mapper type="glob" from="*-Permissive.def" to="*.tbl"/>
+            </apply>
+        </target>
+        
+        <target name="meta-sdf2table" if="metasdfmodule.available">
+            <fail unless="eclipse.spoofaximp.jars" message="Property eclipse.spoofaximp.jars must point to the directory containing StrategoMix.def"/>
+            <antcall target="sdf2table">
+                <param name="sdfmodule" value="${metasdfmodule}"/>
+                <param name="build.sdf.imports" value="-Idef &quot;${eclipse.spoofaximp.jars}/StrategoMix.def&quot; ${build.sdf.imports}"/>
+            </antcall>
+            <antcall target="meta-sdf2table.helper"/>
+        </target>
+        
+        <target name="meta-sdf2table.helper" if="eclipse.running">
+           <eclipse.convertPath fileSystemPath="${include}" property="includeresource"/>
+           <eclipse.refreshLocal resource="${includeresource}/${metasdfmodule}.tbl" depth="infinite"/>
+        </target>
+        
+        <target name="make-permissive" depends="pack-sdf,copy-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${include}/${sdfmodule}-Permissive.def"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}-Permissive.def" property="permissive-grammar.available"/>
+            <antcall target="make-permissive.helper"/>
+        </target>
+    
+        <target name="make-permissive.helper" unless="permissive-grammar.available">
+            <java classname="org.strategoxt.permissivegrammars.make_permissive" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}-Permissive.def"/>
+                <arg line="--optimize on"/>
+            </java>
+        </target>
+
+        <target name="utils-files"> <!-- only useful for builds outside of Eclipse -->
+            <mkdir dir="utils"/>
+            <copy file="${eclipse.spoofaximp.jars}/make_permissive.jar" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.jars}/sdf2imp.jar" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.jars}/aster.jar" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.strategojar}" todir="utils" failonerror="false"/>
+        </target>
+    
+        <target name="pack-sdf" unless="externaldef">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.sdf"/>
+                </srcfileset>
+                <srcfileset dir="${lib}">
+                    <include name="**/*.def"/>
+                </srcfileset>
+                <targetfileset file="${include}/${sdfmodule}.def"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.def" property="pack-sdf.available"/>
+            <antcall target="pack-sdf.helper"/>
+        </target>
+    
+        <target name="pack-sdf.helper" unless="pack-sdf.available">
+            <condition property="utils-include" value="-I ${utils}" else="">
+                <available file="${utils}"/>
+            </condition>
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-pack-sdf"/>
+                <arg value="-i"/>
+                <arg value="${syntax}/${sdfmodule}.sdf"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-I"/>
+                <arg value="${syntax}"/>
+                <arg value="-I"/>
+                <arg value="${lib}"/>
+                <arg line="${utils-include}"/>
+                <arg line="${build.sdf.imports}"/>
+            </java>
+        </target>
+    
+        <target name="copy-sdf" if="externaldef">
+            <copy file="${externaldef}" tofile="${include}/${sdfmodule}.def" preservelastmodified="true"/>
+        </target>
+    
+        <target name="copy-jar" if="externaljar">
+            <copy file="${externaljar}" todir="${include}" preservelastmodified="true"/>
+        </target>
+    
+        <target name="rtg2sig" if="build.stratego.enabled" depends="sdf2rtg">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.rtg"/>
+                <targetfileset file="${include}/${sdfmodule}.str"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.str" property="rtg2sig.available"/>
+            <antcall target="rtg2sig.helper"/>
+        </target>
+    
+        <target name="rtg2sig.helper" unless="rtg2sig.available">
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-rtg2sig"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.rtg"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.str"/>
+                <arg value="--module"/>
+                <arg value="${sdfmodule}"/>
+            </java>
+        </target>
+        
+        <target name="sdf2rtg" depends="pack-sdf,copy-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${include}/${sdfmodule}.rtg"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.rtg" property="sdf2rtg.available"/>
+            <antcall target="sdf2rtg.helper"/>
+        </target>
+    
+        <target name="sdf2rtg.helper" unless="sdf2rtg.available">
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-sdf2rtg"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-m"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.rtg"/>
+                <arg value="--ignore-missing-cons"/>
+                <arg value="-Xnativepath"/>
+                <arg value="${build.strategoxt.sdf}"/>
+            </java>
+        </target>
+        
+        <target name="sdf2parenthesize" depends="pack-sdf,copy-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${include}/${sdfmodule}-parenthesize.str"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}-parenthesize.str" property="sdf2parenthesize.available"/>
+            <antcall target="sdf2parenthesize.helper"/>
+            <available file="${include}/${sdfmodule}-parenthesize.str" property="sdf2parenthesize.available"/>
+            <antcall target="sdf2parenthesize.helper.fallback"/>
+        </target>
+
+        <target name="sdf2parenthesize.helper" unless="sdf2parenthesize.available">
+            <java classname="run" failonerror="false">
+                <arg value="org.strategoxt.tools.main-sdf2parenthesize"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-m"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}-parenthesize.str"/>
+                <arg value="--omod"/>
+                <arg value="include/${sdfmodule}-parenthesize"/>
+                <arg value="--main-strategy"/>
+                <arg value="io-${sdfmodule}-parenthesize"/>
+                <arg value="--lang"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="--rule-prefix"/>
+                <arg value="${sdfmodule}"/>
+                <arg value="--sig-module"/>
+                <arg value="include/${sdfmodule}"/>
+            </java>
+        </target>
+
+    	<target name="sdf2parenthesize.helper.fallback" unless="sdf2parenthesize.available">
+        	<echo file="${include}/${sdfmodule}-parenthesize.str" message="module include/${sdfmodule}-parenthesize rules parenthesize-${sdfmodule} = id"/>
+    	</target>
+        
+        <target name="ppgen" if="build.stratego.enabled" depends="pack-sdf">
+            <dependset>
+                <srcfileset file="${include}/${sdfmodule}.def"/>
+                <targetfileset file="${syntax}/${sdfmodule}.generated.pp"/>
+                <targetfileset file="${include}/${sdfmodule}.generated.pp.af"/>
+            </dependset>
+            <available file="${include}/${sdfmodule}.generated.pp.af" property="ppgen.available"/>
+            <antcall target="ppgen.helper"/>
+            <available file="${include}/${sdfmodule}.generated.pp.af" property="ppgen.available"/>
+            <antcall target="ppgen.helper.fallback"/>
+        </target>
+    
+        <target name="ppgen.helper" unless="ppgen.available">
+            <!-- Any failures here are ignored; they are only a problem when imported from Stratego -->
+            <java classname="run" failonerror="false">
+                <arg value="org.strategoxt.tools.main-ppgen"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.def"/>
+                <arg value="-t"/>
+                <arg value="-b"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.generated.pp.af"/>
+            </java>
+            <java classname="run" failonerror="false">
+                <arg value="org.strategoxt.tools.main-pp-pp-table"/>
+                <arg value="-i"/>
+                <arg value="${include}/${sdfmodule}.generated.pp.af"/>
+                <arg value="-o"/>
+                <arg value="${syntax}/${sdfmodule}.generated.pp"/>
+            </java>
+        </target>
+    
+        <target name="ppgen.helper.fallback" unless="ppgen.available">
+            <echo file="${include}/${sdfmodule}.generated.pp.af" message="PP-Table([])"/>
+        </target>
+        
+        <target name="pppack" if="build.stratego.enabled" depends="pack-sdf">
+            <dependset>
+                <srcfileset file="${syntax}/${sdfmodule}.pp"/>
+                <targetfileset file="${include}/${sdfmodule}.pp.af"/>
+            </dependset>
+            <available file="${syntax}/${sdfmodule}.pp" property="pppack.source-available"/>
+            <available file="${include}/${sdfmodule}.pp.af" property="pppack.available"/>
+            <antcall target="pppack.helper"/>
+            <available file="${include}/${sdfmodule}.pp.af" property="pppack.available"/>
+            <antcall target="pppack.helper.fallback"/>
+        </target>
+    
+        <target name="pppack.helper" unless="pppack.available" if="pppack.source-available">
+            <java classname="run" failonerror="true">
+                <arg value="org.strategoxt.tools.main-parse-pp-table"/>
+                <arg value="-i"/>
+                <arg value="${syntax}/${sdfmodule}.pp"/>
+                <arg value="-o"/>
+                <arg value="${include}/${sdfmodule}.pp.af"/>
+            </java>
+        </target>
+    
+        <target name="pppack.helper.fallback" unless="pppack.available">
+            <echo file="${include}/${sdfmodule}.pp.af" message="PP-Table([])"/>
+        </target>
+    
+        <!-- Aster to Stratego -->
+        <target name="stratego.aster">
+            <available file="${trans}/${strmodule}.rtree" property="aster-output.available"/>
+            <fileset dir="${basedir}" id="aster-input-set">
+              <include name="**/*.astr"/>
+            </fileset>
+            <pathconvert pathsep=" " setonempty="false" property="aster-input" refid="aster-input-set"/>
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.astr"/>
+                </srcfileset>
+                <targetfileset file="${trans}/${strmodule}.rtree"/>
+            </dependset>
+            <condition property="aster-output.uptodate">
+                <and>
+                    <isset property="aster-output.available"/>
+                    <available file="${trans}/${strmodule}.rtree"/>
+                </and>
+            </condition>
+            <available file="${trans}/${strmodule}.rtree" property="aster-output.uptodate"/>
+            <antcall target="stratego.aster.helper"/>
+        </target>
+    
+        <target name="stratego.aster.helper" if="aster-input" unless="aster-output.uptodate">
+            <java classname="org.strategoxt.aster.Main" failonerror="true">
+                <arg value="-i"/>
+                <arg line="${aster-input}"/>
+            </java>
+        </target>
+        
+        <target name="java.jar" if="java.jar.enabled">
+            <jar basedir="${build}" excludes="trans/**" update="true" destfile="${include}/${strmodule}-java.jar"/>
+        </target>
+    
+        <!-- Stratego to Java interpreter -->
+        <target name="stratego.ctree" depends="rtg2sig">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.str"/>
+                    <include name="**/*.astr"/>
+                    <exclude name="lib/*.generated.str"/>
+                </srcfileset>
+                <targetfileset file="${include}/${strmodule}.ctree"/>
+            </dependset>
+            <available file="${include}/${strmodule}.ctree" property="strc-java.available"/>
+            <antcall target="copy-jar"/>
+            <antcall target="stratego.jvm.helper">
+                <param name="build.stratego.outputfile" value="${include}/${strmodule}.ctree"/>
+                <param name="build.stratego.extraargs" value="-F"/>
+            </antcall>
+        </target>
+    
+        <!-- Stratego to Java compiler -->
+        <target name="stratego.jar" depends="rtg2sig,utils-files">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.str"/>
+                    <include name="**/*.astr"/>
+                    <exclude name="lib/*.generated.str"/>
+                </srcfileset>
+                <targetfileset file="${src-gen}/trans/Main.java"/>
+            </dependset>
+            <available file="${src-gen}/trans/Main.java" property="strc-java.available"/>
+            <antcall target="copy-jar"/>
+            <antcall target="stratego.jar.deletehelper"/>
+            <antcall target="stratego.jvm.helper">
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
+            </antcall>
+            <javac classpath="utils/strategoxt.jar:${src-gen}${externaljarimport1}${externaljarimport2}${java.jar.classpath}" srcdir="${src-gen}" includes="trans/**" destdir="${build}" source="1.5" target="1.5" debug="on"/>
+            <!-- copy imported terms -->
+            <copy todir="${build}/trans">
+                <fileset dir="${src-gen}/trans" excludes="**/*.java"/>
+            </copy>
+            <jar basedir="${build}" includes="trans/**" destfile="${include}/${strmodule}.tmp.jar"/>
+            <move file="${include}/${strmodule}.tmp.jar" tofile="${include}/${strmodule}.jar"/>
+            <delete><fileset dir="${build}" includes="trans/**"/></delete>
+        </target>
+        
+        <target name="stratego.jar.deletehelper" unless="strc-java.available">
+            <delete>
+                <fileset dir="${src-gen}" includes="trans/**"/>
+                <fileset dir="${build}" includes="trans/**"/>
+            </delete>
+        </target>
+            
+        <target name="stratego.jvm.helper" unless="strc-java.available" if="build.stratego.enabled">
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <java classname="org.strategoxt.strj.Main" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${trans}/${strmodule}.str"/>
+                <arg value="-o"/>
+                <arg value="${build.stratego.outputfile}"/>
+                <arg value="-p"/>
+                <arg value="trans"/>
+                <arg value="--library"/>
+                <arg value="--clean"/>
+                <arg line="${build.stratego.args}"/>
+                <arg line="${build.stratego.extraargs}"/>
+                <arg line="${externaljarflags}"/>
+                <arg line="${externaldefimport}"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+            </java>
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <mkdir dir="${build}/trans"/>
+        </target>
+                
+        <!-- begin: targets used for adding debugging instrumentation to stratego -->
+        
+        <!-- 
+            if "debug.the.debug.transformer" is set, debug the debug instrumentation, do not output rtree-files, but str-files
+            Only used by stratego.jvm.helper.debug 
+        -->
+        <condition property="transformer-output" value="" else="--output-rtree">
+            <isset property="debug.the.debug.transformer"/>
+        </condition>
+        
+        <!-- 
+            if debug.the.debug.transformer is set then the debug.transformer outputs str files, so the strj-compiler should accept a str-file.
+            if debug.the.debug.transformer is NOT set then the debug.transformer outputs rtree files (much faster generated), so the strj-compiler should accept a rtree-file
+            Only used by stratego.jvm.helper.debug
+        -->
+        <condition property="strj.input.file.type" value="str" else="rtree">
+            <isset property="debug.the.debug.transformer"/>
+        </condition>
+        
+        <!-- value determines which target will be executed.
+            If the file ".debugmode" can be found in the project root call stratego.jar.debug
+            else call stratego.jar
+        -->
+        <condition property="stratego.jar.target" value="call.stratego.jar.debug" else="call.stratego.jar">
+            <available file=".debugmode"/>
+        </condition>
+        
+        <!-- will save the stratego files with debug info in this folder -->
+        <property name="trans-debug" location="trans-debug"/>
+        
+        <!-- this helper target determines what target to call, based on debug.build.enabled -->
+        <target name="stratego.jar.helper">
+            <antcall target="${stratego.jar.target}"/>
+        </target>
+        
+        <!-- call stratego.jar unless debug.build.enabled property is set --> 
+        <target name="call.stratego.jar" depends="stratego.jar">
+            <echo message="call.stratego.jar - ${stratego.jar.target}"/>
+        </target>
+        
+        <!-- call stratego.jar.debug when debug.build.enabled property is set -->
+        <target name="call.stratego.jar.debug" depends="stratego.jar.debug">
+            <echo message="call.stratego.jar.debug - ${stratego.jar.target}"/>
+        </target>
+        
+        <!-- copy stratego runtime jars to utils folder -->
+        <target name="utils-files-debug" depends="utils-files">
+            <copy file="${eclipse.spoofaximp.stratego-debug-runtime-jar}" todir="utils" failonerror="false"/>
+            <copy file="${eclipse.spoofaximp.stratego-debug-runtime-java-jar}" todir="utils" failonerror="false"/>
+        </target>
+        
+        <!-- Stratego to Java compiler with debugging capabilities -->
+        <target name="stratego.jar.debug" depends="rtg2sig,utils-files-debug">
+            <dependset>
+                <srcfileset dir="${basedir}">
+                    <include name="**/*.str"/>
+                    <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
+                </srcfileset>
+                <targetfileset file="${src-gen}/trans/Main.java"/>
+            </dependset>
+            <available file="${src-gen}/trans/Main.java" property="strc-java.available"/>
+            <antcall target="copy-jar"/>
+            <antcall target="stratego.jar.deletehelper"/>
+            <!-- compile stratego to java -->
+            <antcall target="stratego.jvm.helper.debug">
+                <param name="build.stratego.outputfile" value="${src-gen}/trans/Main.java"/>
+                <param name="build.stratego.extraargs" value="-la java-front ${java.jar.import}"/>
+            </antcall>
+            <!-- compile java to class -->
+            <javac destdir="${build}" source="1.5" target="1.5" debug="on">
+                <!-- attribute in javac: srcdir="${src-gen}" -->
+                <src path="${src-gen}"/>
+                <!-- attribute in javac: classpath="utils/strategoxt.jar:${src-gen}${externaljarimport1}${externaljarimport2}${java.jar.classpath}"  -->
+                <classpath>
+                    <pathelement path="utils/strategoxt.jar:${src-gen}${externaljarimport1}${externaljarimport2}${java.jar.classpath}"/> <!-- the path attribute accepts colon- or semicolon-separated lists of locations -->
+                    <pathelement location="utils/stratego-debug-runtime.jar"/> <!-- The location attribute specifies a single file or directory relative to the project's base directory (or an absolute filename) -->
+                    <pathelement location="utils/stratego-debug-runtime-java.jar"/>
+                </classpath>
+                <!-- attribute in javac: includes="trans/**"  -->
+                <include name="trans/**"/>
+            </javac>
+            <!-- copy imported terms -->
+            <copy todir="${build}/trans">
+                <fileset dir="${src-gen}/trans" excludes="**/*.java"/>
+            </copy>
+            <!-- create a jar from the class files -->
+            <jar basedir="${build}" includes="trans/**" destfile="${include}/${strmodule}.tmp.jar"/>
+            <move file="${include}/${strmodule}.tmp.jar" tofile="${include}/${strmodule}.jar"/>
+            <delete><fileset dir="${build}" includes="trans/**"/></delete>
+        </target>
+        
+        <!-- instrument the stratego program and compile it to java -->
+        <target name="stratego.jvm.helper.debug" unless="strc-java.available" if="build.stratego.enabled">
+            <echo message="generate stratego with debug information"/>
+            <echo message="${basedir}"/>
+            <available classname="org.strategoxt.imp.debug.stratego.transformer.trans.Main" property="transformer.available"/>
+            <!-- add debug information -->
+              <java classname="org.strategoxt.imp.debug.stratego.transformer.trans.Main" failonerror="true" fork="true">
+                   <classpath>
+                    <pathelement location="${eclipse.spoofaximp.stratego-transformer-jar}"/>
+                       <pathelement location="${eclipse.spoofaximp.stratego-transformer-java-jar}"/>
+                       <pathelement location="${eclipse.spoofaximp.strategojar}"/>
+                   </classpath>
+                  <arg value="-i"/>
+                  <arg value="${trans}/${strmodule}.str"/>
+                  <arg value="--gen-dir"/>
+                  <arg value="${trans-debug}"/>
+                  <arg value="--base-dir"/> <!-- set the basedir to the project dir -->
+                  <arg value="${basedir}"/>
+                  <!-- "arg line='val'" val should contain space-separated arguments --> 
+                  <arg line="--charoffset-converter --fail-catch ${transformer-output}"/>
+                  
+                  <!-- arguments should start with two '-'-characters -->
+                  <!-- <arg value="-charoffset-converter"/> --> <!-- create charoffset table -->
+                  <!-- <arg value="-fail-catch"/>  --> <!-- catch failures in where/with-clauses in rules -->
+                  <!-- <arg value="-output-rtree"/> --> 
+            </java>
+            <!-- now compile instrumented stratego to java -->
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <java classname="org.strategoxt.strj.Main" failonerror="true">
+                <arg value="-i"/>
+                <arg value="${trans-debug}/trans/${strmodule}.${strj.input.file.type}"/>
+                <arg value="-o"/>
+                <arg value="${build.stratego.outputfile}"/>
+                <arg value="-p"/>
+                <arg value="trans"/>
+                <arg value="--library"/>
+                <arg value="--clean"/>
+                <arg line="${build.stratego.args}"/>
+                <arg line="${build.stratego.extraargs}"/>
+                <arg line="${externaljarflags}"/>
+                <arg line="${externaldefimport}"/>
+                <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+                <!-- put strategodebuglib.rtree on the include path -->
+                <arg line="-I &quot;${eclipse.spoofaximp.strategodebuglib-folder}&quot;"/>
+                <arg line="-la org.strategoxt.imp.debug.stratego.runtime.trans"/>
+            </java>
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
+            <mkdir dir="${build}/trans"/>
+        </target>
+        
+        
+        <!-- end: targets used for adding debugging instrumentation to stratego -->
+
+
+        <!-- Stratego to C-based native executable -->
+        <target name="stratego.c">
+            <antcall target="stratego.c.helper">
+                <param name="build.stratego.outputpath" value="${basedir}/include"/>
+                <param name="build.stratego.extraargs" value=""/>
+                <param name="build.stratego.extension" value=""/>
+                <param name="build.stratego.compiler" value="strc"/>
+            </antcall>
+        </target>
+        
+        <!-- Helper target for calling the stratego compiler -->
+        <target name="stratego.c.helper" depends="rtg2sig" if="build.stratego.enabled">
+            <apply executable="${build.strategoxt.stratego}/${build.stratego.compiler}" dest="${build.stratego.outputpath}" failonerror="true">
+                <arg value="-i"/>
+                <srcfile/>
+                <arg value="-o"/>
+                <targetfile/>
+                <arg line="${build.stratego.args}"/>
+                <arg line="${build.stratego.extraargs}"/>
+                <arg line="${externaldefimport}"/>
+                <arg line="-I &quot;${lib}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
+                
+                <fileset file="${trans}/${strmodule}.str"/>
+                <mapper type="glob" from="*.str" to="*.${build.stratego.extension}"/>
+            </apply>
+        </target>
+        
+        <target name="clean" description="Selective clean up">
+            <delete dir="${build}"/>
+            <delete file="${include}/${sdfmodule}.def"/>
+            <delete file="${include}/${strmodule}.rtree"/>
+            <delete file="${include}/${strmodule}.ctree"/>
+            <delete file="${include}/${strmodule}.jar"/>
+            <delete dir="${src-gen}/trans"/>
+        </target>
+    </project>
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.main.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.main.xml	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,44 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<project name="ComBE" default="all">
+        
+        <!-- Key input modules -->
+        <property name="sdfmodule" value="ComBE"/>
+        <property name="metasdfmodule" value="Stratego-ComBE"/>
+        <property name="esvmodule" value="ComBE"/>
+        <property name="strmodule" value="combe"/>
+    
+        <!-- Project directories -->
+        <property name="trans" location="trans"/>
+        <property name="src-gen" location="editor/java"/>
+        <property name="syntax" location="syntax"/>
+        <property name="include" location="include"/>
+        <property name="lib" location="lib"/>
+        <property name="build" location="bin"/>
+        <property name="dist" location="bin/dist"/>
+        
+        <!-- Imports -->
+        <property name="build.sdf.imports" value=""/>
+        <property name="build.stratego.args" value="
+                        --library
+                        -I &quot;${trans}&quot;
+                        -I &quot;${basedir}&quot;
+                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
+        
+        <!-- Optional: external .def and .jar locations
+        <property name="externaldef" location="syntax/${sdfmodule}.def"/>
+        <property name="externaljar" value="../lib.jar"/>
+        <property name="externaljarflags" value="-la org.lib"/>
+        -->
+    
+        <!-- Environment configuration for command-line builds -->
+        <condition property="build.strategoxt.sdf" value="${eclipse.spoofaximp.nativeprefix}" else="">
+            <isset property="eclipse.spoofaximp.nativeprefix"/>
+        </condition>
+        <property name="build.strategoxt.stratego" location="${user.home}/.nix-profile/bin"/>
+    
+        <import file="build.generated.xml"/>
+    
+        <!-- Main target -->
+        <target name="all" depends="spoofaximp.default.ctree"/>
+    </project>
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.properties
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/build.properties	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+source.. = editor/java/
+output.. = bin/
+bin.includes = META-INF/,\
+               plugin.xml,\
+               include/,\
+               bin/,\
+               lib/,\
+               .
+bin.excludes = trans/

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Builders.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Builders.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,20 @@
+module ComBE-Builders
+
+imports ComBE-Builders.generated
+
+builders
+                                                                                   
+  // This file can be used for custom analysis, builder and refactoring rules.     
+  //                                                                               
+  // See the imported file for a brief introduction and examples.                  
+
+builders
+                                                                                                                          
+  provider : include/combe.ctree                                                                                          
+  provider : include/combe-java.jar                                                                                       
+                                                                                                                          
+  observer : editor-analyze                                                                                               
+                                                                                                                          
+  builder  : "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (meta) (source)     
+  builder  : "Show analyzed abstract syntax (for selection)" = generate-analyzed (openeditor) (realtime) (meta) (source)  
+                                                                                                                          
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Colorer.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Colorer.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+module ComBE-Colorer
+
+imports ComBE-Colorer.generated
+
+colorer
+                                                                      
+  // This file can be used for custom colorer rules.                  
+  //                                                                  
+  // See the imported file for a brief introduction and examples.     
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Completions.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Completions.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,16 @@
+module ComBE-Completions
+
+imports ComBE-Completions.generated
+
+completions
+                                                                   
+  // This file is used to define content completion.               
+  //                                                               
+  // See the imported file for a brief introduction and examples.     
+
+completions
+  // Semantic (identifier) completion:   
+                                         
+  completion proposer                  : editor-complete
+                                         
+  completion trigger                   : ":"
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Folding.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Folding.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+module ComBE-Folding
+
+imports ComBE-Folding.generated
+
+folding
+  
+  // This file can be used for custom folding rules.
+  //
+  // See the imported file for a brief introduction and examples.
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Outliner.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Outliner.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+module ComBE-Outliner
+
+imports ComBE-Outliner.generated
+
+outliner
+  
+  // This file can be used for custom outliner rules.
+  //
+  // See the imported file for a brief introduction and examples.
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-References.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-References.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,15 @@
+module ComBE-References
+
+imports ComBE-References.generated
+
+references
+                                                                                                   
+  // This file can be used to specify reference resolving and hover help, and content completion.  
+  //                                                                                               
+  // See the imported file for a brief introduction and examples.                                  
+                                                                                                   
+
+references
+                
+  reference _ : editor-resolve
+  hover _     : editor-hover
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Syntax.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE-Syntax.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+module ComBE-Syntax
+
+imports ComBE-Syntax.generated
+
+language
+                                                                   
+  // This file can be used for custom syntax rules.                
+  //                                                               
+  // See the imported file for a brief introduction and examples.  
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE.main.esv
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/ComBE.main.esv	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,16 @@
+module ComBE.main
+
+imports ComBE-Builders ComBE-Colorer ComBE-Completions ComBE-Folding ComBE-Outliner ComBE-References ComBE-Syntax
+
+language General properties
+                  
+  name          : ComBE
+  id            : org.behaviorengineering.combe.textual
+  extends       : Root
+                  
+  description   : "Spoofax/IMP-generated editor for Behavior Engineering"
+  url           : http://www.behaviorengineering.org/
+                  
+  extensions    : bt
+  table         : include/ComBE.tbl
+  start symbols : Start
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/Activator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/Activator.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,44 @@
+package org.behaviorengineering.combe.textual;
+
+import org.eclipse.imp.preferences.PreferencesService;
+import org.eclipse.imp.runtime.PluginBase;
+import org.osgi.framework.BundleContext;
+
+public class Activator extends PluginBase 
+{ 
+  public static final String kPluginID = "ComBE";
+
+  public static final String kLanguageName = "ComBE";
+
+  protected static Activator sPlugin;
+
+  public static Activator getInstance()
+  { 
+    if(sPlugin == null)
+      return new Activator();
+    return sPlugin;
+  }
+
+  public Activator () 
+  { 
+    super();
+    sPlugin = this;
+  }
+
+  @Override public void start(BundleContext context) throws Exception
+  { 
+    super.start(context);
+  }
+
+  @Override public String getID()
+  { 
+    return kPluginID;
+  }
+
+  @Override public String getLanguageID()
+  { 
+    return kLanguageName;
+  }
+
+  protected static PreferencesService preferencesService = null;
+}
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEParseController.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEParseController.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,4 @@
+package org.behaviorengineering.combe.textual;
+
+public class ComBEParseController extends ComBEParseControllerGenerated 
+{ }
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEParseControllerGenerated.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEParseControllerGenerated.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,108 @@
+package org.behaviorengineering.combe.textual;
+
+import java.io.InputStream;
+import java.io.IOException;
+import java.io.File;
+import java.io.FileInputStream;
+import org.eclipse.core.runtime.Path;
+import org.eclipse.imp.parser.IParseController;
+import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.imp.runtime.dynamicloading.BadDescriptorException;
+import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
+import org.strategoxt.imp.runtime.dynamicloading.DescriptorFactory;
+import org.strategoxt.imp.runtime.dynamicloading.DynamicParseController;
+
+public class ComBEParseControllerGenerated extends DynamicParseController 
+{ 
+  public static final String LANGUAGE = new String("ComBE");
+
+  private static final String TABLE = "/include/" + LANGUAGE + ".tbl";
+
+  private static final String DESCRIPTOR = "/include/" + LANGUAGE + ".packed.esv";
+
+  private static volatile Descriptor descriptor;
+
+  private static Throwable notLoadingCause;
+
+  public static synchronized Descriptor getDescriptor()
+  { 
+    if(notLoadingCause != null)
+      throw new RuntimeException(notLoadingCause);
+    if(descriptor == null)
+      createDescriptor();
+    return descriptor;
+  }
+
+  protected static synchronized void setDescriptor(Descriptor descriptor)
+  { 
+    ComBEParseControllerGenerated.descriptor = descriptor;
+  }
+
+  protected static void createDescriptor()
+  { 
+    try
+    { 
+      InputStream descriptorStream = ComBEParseControllerGenerated.class.getResourceAsStream(DESCRIPTOR);
+      InputStream table = ComBEParseControllerGenerated.class.getResourceAsStream(TABLE);
+      boolean filesystem = false;
+      if(descriptorStream == null && new File("./" + DESCRIPTOR).exists())
+      { 
+        descriptorStream = new FileInputStream("./" + DESCRIPTOR);
+        filesystem = true;
+      }
+      if(table == null && new File("./" + TABLE).exists())
+      { 
+        table = new FileInputStream("./" + TABLE);
+        filesystem = true;
+      }
+      if(descriptorStream == null)
+        throw new BadDescriptorException("Could not load descriptor file from " + DESCRIPTOR + " (not found in plugin: " + getPluginLocation() + ")");
+      if(table == null)
+        throw new BadDescriptorException("Could not load parse table from " + TABLE + " (not found in plugin: " + getPluginLocation() + ")");
+      descriptor = DescriptorFactory.load(descriptorStream, table, filesystem ? Path.fromPortableString("./") : null);
+      descriptor.setAttachmentProvider(ComBEParseControllerGenerated.class);
+    }
+    catch(BadDescriptorException exc)
+    { 
+      notLoadingCause = exc;
+      Environment.logException("Bad descriptor for " + LANGUAGE + " plugin", exc);
+      throw new RuntimeException("Bad descriptor for " + LANGUAGE + " plugin", exc);
+    }
+    catch(IOException exc)
+    { 
+      notLoadingCause = exc;
+      Environment.logException("I/O problem loading descriptor for " + LANGUAGE + " plugin", exc);
+      throw new RuntimeException("I/O problem loading descriptor for " + LANGUAGE + " plugin", exc);
+    }
+  }
+
+  private static String getPluginLocation()
+  { 
+    return ComBEParseController.class.getProtectionDomain().getCodeSource().getLocation().getFile();
+  }
+
+  @Override public IParseController getWrapped()
+  { 
+    if(!isInitialized())
+    { 
+      if(notLoadingCause != null)
+        throw new RuntimeException(notLoadingCause);
+      try
+      { 
+        initialize(this, getDescriptor().getLanguage());
+      }
+      catch(BadDescriptorException exc)
+      { 
+        notLoadingCause = exc;
+        throw new RuntimeException(exc);
+      }
+    }
+    return super.getWrapped();
+  }
+
+  @Override protected void setNotLoadingCause(Throwable value)
+  { 
+    notLoadingCause = value;
+    super.setNotLoadingCause(value);
+  }
+}
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEValidator.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/ComBEValidator.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,12 @@
+package org.behaviorengineering.combe.textual;
+
+import org.strategoxt.imp.runtime.dynamicloading.Descriptor;
+import org.strategoxt.imp.runtime.services.MetaFileLanguageValidator;
+
+public class ComBEValidator extends MetaFileLanguageValidator 
+{ 
+  @Override public Descriptor getDescriptor()
+  { 
+    return ComBEParseController.getDescriptor();
+  }
+}
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/InteropRegisterer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/InteropRegisterer.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,14 @@
+package org.behaviorengineering.combe.textual.strategies;
+
+import org.strategoxt.lang.JavaInteropRegisterer;
+import org.strategoxt.lang.Strategy;
+
+/**
+ * Helper class for {@link java_strategy_0_0}.
+ */
+public class InteropRegisterer extends JavaInteropRegisterer {
+
+  public InteropRegisterer() {
+    super(new Strategy[] { java_strategy_0_0.instance });
+  }
+}

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/Main.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/Main.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,11 @@
+package org.behaviorengineering.combe.textual.strategies;
+
+import org.strategoxt.lang.Context;
+
+public class Main {
+  
+  public static void init(Context context) {
+    // Called when the editor is being initialized
+  }
+
+}

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/java_strategy_0_0.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/editor/java/org/behaviorengineering/combe/textual/strategies/java_strategy_0_0.java	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,32 @@
+package org.behaviorengineering.combe.textual.strategies;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.interpreter.terms.ITermFactory;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.Strategy;
+
+/**
+ * Example Java strategy implementation.
+ *
+ * This strategy can be used by editor services and can be called
+ * in Stratego modules by declaring it as an external strategy
+ * as follows:
+ *
+ * <code>
+ *  external java-strategy(|)
+ * </code>
+ *
+ * @see InteropRegisterer  This class registers java_strategy_0_0 for use.
+ */
+public class java_strategy_0_0 extends Strategy {
+  
+  public static java_strategy_0_0 instance = new java_strategy_0_0();
+
+  @Override
+  public IStrategoTerm invoke(Context context, IStrategoTerm current) {
+    context.getIOAgent().printError("Input for java-strategy: " + current);
+    ITermFactory factory = context.getFactory();
+    return factory.makeString("Regards from java-strategy");
+  }
+
+}

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-auto.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-auto.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,13 @@
+module lib/analysis-auto.generated
+
+signature
+  constructors
+    
+
+
+imports
+  include/ComBE
+
+
+rules
+

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-library-internal.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-library-internal.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,725 @@
+module lib/analysis-library-internal.generated
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library.generated
+  lib/index-library.generated
+  
+signature constructors
+  
+  // Analysis
+  Results         : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
+  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
+  
+  // Namespaces
+  Diff            : Namespace
+  ASTDiff         : Namespace
+  
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
+   */
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
+    with
+      // Init
+      index-setup(|language, [project-path], full-path);
+      revision := <index-start-transaction>
+    with
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
+    with
+      {| Index-UnresolvedSet:
+        unresolvedSet := <new-iset>;
+        rules(Index-UnresolvedSet: _ -> unresolvedSet);
+        
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+        (asts, _) := <unzip> astFilePairs4
+      |}
+    with
+      index-end-transaction
+    with
+      // Schedule re-analysis of dependent files (if current file is not testing language file)
+      // HACK: Depends on file extension, could be other languages with .spt extension?
+      if Editor() := phase; not(<is-test-file> full-path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
+        
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
+        // Store files that have changed in the index
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
+      end
+    with
+      <list-loop(analyze-top-store-ast)> astFilePairs4
+      
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
+    with
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
+      
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Gather all data for each definition.
+        ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|[<index-file-to-string> file, "ast"])> ast
+      
+  /**
+   * Identifies all definitions in the tree and annotates them with their URI.
+   * Also annotates uses with a preliminary "Unresolved(_)" URI.
+   *
+   * @internal
+   */
+  analyze-defs = analyze-defs(|Anon(), Anon())
+  /** @internal */
+  analyze-defs(|head-scope, head-scope-ns):
+    ast -> (ast', defs')
+    with
+      if def := <nam-get-definition> ast then
+        Def(def-path)                     := def;
+        [head-scope-ns', head-scope' | _] := def-path
+      else
+        def-path       := INTERNAL_ERROR();
+        head-scope-ns' := head-scope-ns;
+        head-scope'    := head-scope
+      end;
+      if scope-types := <nam-get-scope-types> ast then
+        {| IndexPath:
+          <list-loop(update-index-path(|head-scope', head-scope-ns', ast))> scope-types;
+          // <balanced-update-path> head-scope';
+          (ast', defs) := <analyze-defs-recurse(|Anon(), Anon(), def-path)> ast
+        |}
+      else
+        (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
+      end;
+      defs' := <![def | defs] <+ !defs>
+      
+  /** @internal */
+  analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
+    ast -> (ast'', defs)
+    where
+      analyzed      := <all(analyze-defs(|head-scope, head-scope-ns))> ast;
+      (ast', defs)  := <unzip-analyzed> analyzed;
+      ast''         := <try(nam-annotate-names(|def-path))> ast'
+ 
+  /** @internal */
+  update-index-path(|head-scope, head-scope-ns, ast):
+    scope-type -> scope-type
+    where
+      if !head-scope-ns => Anon() then
+        path  := <IndexPath <+ ![]> scope-type;
+        path' := <do-adjusted-index-path(|scope-type, path, Anon(<new>))> ast
+      else
+        path  := <IndexPath <+ ![]> head-scope-ns;
+        path' := <do-adjusted-index-path(|scope-type, path, head-scope)> ast
+      end;
+      rules(IndexPath: scope-type -> path')
+ 
+  /* TODO: consider using simple-update-def-path
+   *       which uses "balanced" path scopes
+   *       e.g. when Entity doesn't scope Function
+   *       then it's hard to access properties from a function
+  balanced-update-index-path:
+    head-scope -> head-scope
+    where
+      if !head-scope => Anon() then
+        head-scope' := Anon(<new>)
+      else
+        head-scope' := head-scope
+      end;
+      (something with do-adjust-path)
+      rules(IndexPath := [head-scope' | <IndexPath <+ ![]> ()])
+  */
+ 
+  /**
+   * Analyze all uses, changing their preliminary "Unresolved(_)" URI to a definite URI of their definition.
+   *
+   * @internal
+   */
+  analyze-uses:
+    ast -> (ast'', uses')
+    with
+      analyzed     := <all(analyze-uses)> ast;
+      (ast', uses) := <unzip-analyzed> analyzed;
+      if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
+        if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
+          ast'' := ast{def-uri};
+          uses' := [Use(def-uri) | uses]
+        else
+          ast'' := ast';
+          uses' := [BadUse([namespace, x]) | uses]
+        end
+      else
+        ast'' := ast';
+        uses' := uses
+      end
+ 
+  /**
+   * Collects all index data (e.g. types of definitions).
+   *
+   * @internal
+   */
+  analyze-tree-data:
+    tree -> data
+    where
+      set := <new-iset>;
+      <topdown(analyze-tree-data-part(|set))> tree;
+      data := <iset-elements> set
+      
+  /** @internal */
+  analyze-tree-data-part(|set):
+    tree -> tree
+    where
+      if def-term := <nam-get-definition-key> then
+        _{[namespace | path]} := def-term;
+        if result := <adjust-index-def-data(store-index-data-results(|set) |namespace, path)> tree then
+          <fatal-err(|"Unexpected result from adjust-index-def-data; should call <store-results>")> result
+        end
+      end
+  
+  /** @internal */
+  store-index-data-results(|set):
+    t -> <fail>
+    where
+      if is-list then
+        <iset-addlist(|t)> set
+      else
+        <iset-add(|t)> set
+      end
+      
+rules // Parallel analysis
+  
+  /** @internal */
+  index-parallel-analyze(analyze):
+    files -> allResults
+    with
+      map(index-parse-file); // Parsing cannot be done in parallel.
+      map(\(ast, file) -> (ast, file, <project-path>)\);
+      parallel-unordered(all(index-analyze(analyze)));
+      ?results;
+      with(<eq> (<length> results, <length> files) | "Input size not equal to output size");
+      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
+      if not([] := filesToAnalyze) then
+        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
+      else
+        allResults := results
+      end
+  
+  /** @internal */   
+  index-parse-file:
+    file -> (ast, file)
+    with
+    if <file-exists> file then
+      ast := <parse-file> file
+    else
+      ast := ()
+    end
+   
+  /** @internal */   
+  index-set-markers:
+    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
+    with
+      <set-markers(|ast)> (ast', errors, warnings, notes)
+      
+  /** @internal */
+  index-analyze(analyze):
+    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
+    with
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      if [] := filesToAnalyze then
+        complete-work-unit
+      end
+      
+/** @internal */
+rules // Splitter
+  
+  /** @internal */
+  index-split = fail
+  /** @internal */
+  index-is-toplevel = fail
+  /** @internal */
+  index-is-qualifier = fail
+  /** @internal */
+  index-qualifier-subelements = fail
+  /** @internal */
+  index-create-qualifier(|qualifier) = fail
+  
+  /** @internal */
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  /** @internal */
+  index-toplevel-split-internal:
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, <index-uri> <nam-get-definition-key> node)]
+        otherwise:
+          units := [(node, [])]
+      end
+      
+  /** @internal */
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      qualifier := <index-create-qualifier(|node)> elem
+
+/** @internal */
+rules // Diffs
+  
+  /** @internal */
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+    
+  /** @internal */
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
+    with
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      
+      // Files to analyze
+      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
+      analyzeFiles' := analyzeFiles;
+      
+      // Files to compile
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      <map(analyze-add-compilediff)> compileFiles
+      
+  /** 
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
+   *
+   * @internal
+   */
+  analyze-astdiff:
+    (ast, file) -> file
+    where
+      name := [<index-file-to-string> file, "ast-checksum"];
+      newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-global(|name)> then
+        <index-set-global(|name)> newChecksum;
+        not(<eq> (oldChecksum, newChecksum))
+      else
+        <index-set-global(|name)> newChecksum
+      end
+      
+  /** 
+   * Adds given file to the list of files to compile.
+   *
+   * @internal
+   */
+  analyze-add-compilediff = index-add-global(|"compile-diff")
+  
+  /** 
+   * Gets the list of files to compile, and then clear it.
+   *
+   * @internal
+   */
+  analyze-get-compilediffs = index-get-all-globals(|"compile-diff"); index-clear-global(|"compile-diff")
+  
+rules // Index lookup rules (that take into account adjust-index-lookup)
+  
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> def
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      if <?StopLookup()> candidates then
+        fail
+      else
+        def        := <index-select(|namespace, path, x)>
+      <+
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
+      end
+
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> defs'
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      defs       := <index-select-all(|namespace, path, x)>;
+      // TODO: optimize: try not to call do-adjust-index-lookup from here
+      if [_ | path'] := path then
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
+        defs' := <conc> (defs, defs2)
+      else
+        defs' := defs
+      end
+      
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   * @internal
+   */
+  index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> def
+    where
+      // TODO: optimize: just like index-lookup
+      [_ | path'] := path;
+      def         := <index-lookup-outermost(is-adjust-lookup-enabled |namespace, path', prefix)> x
+    <+
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      def        := <index-select(|namespace, path, x)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
+    x{_} -> defs
+    with
+      is-adjusted-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        defs := StopLookup()
+      else
+        mapconcat(\d at Def(p) -> [d]\
+          <+ \[namespace' | path'] -> <index-lookup-one-level(fail |namespace', path', prefix)> x\
+          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?defs
+      end
+    <+
+      defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
+    x{_} -> all-defs
+    with
+      is-adjust-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        all-defs := []
+      else
+        mapconcat(\d at Def(p) -> [d]\
+            <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
+            <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?all-defs
+      end
+    <+
+      one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
+      if [_ | path'] := path then
+        all-defs := <concat> [one-level, <index-lookup-all-levels(fail |namespace, path', prefix)> x]
+      else
+        all-defs := one-level
+      end
+      
+/** @internal */
+rules // URI and value projections
+       
+  /** @internal */
+  index-uri-impl:
+    Def(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Use(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Read(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
+ 
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
+  index-uri-impl:
+    ReadWildcard(uri, _) -> uri
+
+  /** @internal */
+  index-value-impl:
+    Def(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Use(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Read(value) -> value
+  
+  /** @internal */
+  index-value-impl:
+    ReadWildcard(_, value) -> value
+       
+/** @internal */
+rules // Internal helpers
+
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\(a, _) -> a\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
+       
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+    string-ends-with(|".spt")
+  /** @internal */
+  is-test-language = 
+    ?"Spoofax-Testing"
+  /** @internal */
+  is-test-input(|language, path) = 
+    <is-test-language> language <+ <is-test-file> path
+      
+  /** @internal */
+  fake-file = 
+    is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+    Fst; string-replace(|$[[<project-path>]/], "")
+  
+  /** @internal */
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uriStr))
+    with
+      (<index-uri-to-string> uri <+ !"") => uriStr
+  
+  /** @internal */     
+  index-is-name-substring(|name):
+    template -> <id>
+    with
+      [_, uri-name | _] := <index-uri>
+    where
+      <is-substring(!name)> uri-name
+   
+  /** @internal */    
+  index-readwildcard-substring(|prefix):
+    ReadWildcard(_, name) -> <id>
+    where <is-substring(!prefix)> name
+  
+  /** @internal */  
+  store-wildcard-read(|namespace, path, prefix):
+    children -> <id>
+    with
+      if set := <Index-ReadSet> then
+        if 1 := <length> children then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix))> set
+        end
+      end
+  
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
+  index-file-dependent-construct: 
+    uri -> <conc> (uses, reads)
+    with
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+ 
+  /** @internal */
+  do-adjust-index-lookup(|namespace, path, use, prefix) =
+    repeat-until(
+      prim("SSL_EXT_get_parent", <id>)
+    , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
+    )
+ 
+  /** @internal */
+  index-select(|namespace, path, use) =
+    getfirst(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  index-select-all(|namespace, path, use) =
+    filter(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  do-adjusted-index-path(|namespace, path, def) =
+    adjust-index-path(origin-equal(|def) |namespace, path)
+  <+
+    ![def | path]
+ 
+  /** @internal */
+  index-eq(|namespace, expected) =
+    where(
+      ?Def([_, name | _]);
+      <SRTS-EXT-eq-ignore-annos(|expected)> name
+    )
+  
+  /** @internal */
+  external SRTS-EXT-eq-ignore-annos(|t)
+  
+  /** @internal */
+  index-key-unwrap = 
+    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
+    
+/** @internal */
+rules // Interface for generated code
+ 
+  /** @internal */
+  nam-get-def(|namespace):
+    x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
+  
+  /** @internal */ 
+  nam-annotate-use(|namespace):
+    t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
+  
+  /** @internal */ 
+  nam-get-scope-types = fail
+  /** @internal */
+  nam-get-definition = fail
+  /** @internal */
+  nam-get-definition-key = fail
+  /** @internal */
+  nam-annotate-names(|def-path) = fail

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/analysis-library.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,563 @@
+module lib/analysis-library.generated
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library-internal.generated
+  lib/index-library.generated
+ 
+signature constructors
+ 
+  // Analyze constructors
+  Editor      : AnalysisPhase
+  Compile     : AnalysisPhase
+ 
+  // Index elements
+  Def          : List(UriPart) -> Summary
+  Use          : List(UriPart) -> Summary
+  BadUse       : List(UriPart) -> Summary
+  Read         : List(UriPart) -> Summary
+  ReadWildcard : List(UriPart) * String -> Summary
+  Diff         : List(UriPart) * List(Summary) -> Summary
+  
+  // Adjust lookup actions
+  StopLookup   : LookupAction
+  
+rules // Index analysis extension points
+ 
+  /**
+   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
+   *
+   * The overriden rule must return a list that contains any of the following items:
+   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
+   *                        use site to this definition.
+   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
+   * 
+   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
+   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
+   * will be used.
+   *
+   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
+   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
+   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
+   * lookups that will always fail anyway.
+   *
+   * Extension example:
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     PropAccess(exp, name) -> properties
+   *     where
+   *       <check-target-name> name
+   *     with
+   *       if TYPE(type{_}) := <type-of> exp then
+   *         properties := <index-lookup-children(|Property(), prefix)> type
+   *       else
+   *         properties := StopLookup()
+   *       end
+   *
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     Var(name) -> [[Var() | path], [Property() | path]]
+   *     where
+   *       <check-target-name> name
+   *
+   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
+   *                            lookup algorithm is looking for.
+   * @param namespace           The namespace of the element that should be looked up.
+   * @param path                The path the lookup algorithm is currently looking at for the element.
+   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
+   *                            full name of the element, but could be a partial prefix during content completion.
+   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
+   */
+  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
+  
+  /** 
+   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
+   * a (list of) data that must be stored in the index.
+   *
+   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
+   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
+   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
+   * rule fail if you are doing a <filter(store-results)> for example.
+   *
+   * Extension example:
+   *   adjust-index-def-data(store-results|namespace, path):
+   *     def -> <store-results> Type([namespace|path], type)
+   *     where
+   *       type := <type-of> def
+   *
+   * @param store-results Call this on the data you want to store in the index.
+   * @param namespace     The namespace of the definition that the rule is being called on.
+   * @param path          The path of the definition that the rule is being called on.
+   * @type def -> fail 
+   */
+  adjust-index-def-data(store-results|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
+   * use sites. Should return a path that will be assigned to the definition or use site.
+   *
+   * Extension example:
+   *   adjust-index-path(check-target-definition|namespace, path):
+   *     Start(_, _) -> [<string-replace(|<project-path>, "")> <Fst> <index-get-current-file>]
+   *
+   *
+   * @param check-target-definition 
+   * @param namespace               The namespace that would be given to the current definition or use site.
+   * @param path                    The path that would be given to the current definition or use site.
+   * @type def -> uri@[namespace|path]
+   */
+  adjust-index-path(check-target-definition|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
+   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
+   *
+   * Extension example:
+   *   index-diff-constructors = ?Type(_, _)
+   *
+   * @type a -> ?a
+   *
+   * @see index-diff-compare
+   */
+  index-diff-constructors = 
+    ?Def(_)
+  
+  /**
+   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
+   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
+   * compared.
+   *
+   * Extension example:
+   *   index-diff-compare:
+   *     (Type(u1, v1), Type(u2, v2)) -> <id>
+   *     where
+   *       <index-uri-eq> (u1, u2);
+   *       <eq> (v1, v2)
+   *
+   * @type (a, b) -> ?(a, b)
+   *
+   * @see index-diff-constructors
+   */
+  index-diff-compare:
+    (Def(u1), Def(u2)) -> <id>
+    where
+       <index-uri-eq> (u1, u2)
+ 
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Defaults to Editor() phase.
+   *
+   * @param language  The name of the language that is being analysed.
+   *
+   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top(|phase, language)
+   */
+  analyze-top(|language):
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
+   
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @param phase         The type of analysis phase. There are 2 phases to choose from:
+   *                      - Editor():   File dependencies are analysed.
+   *                      - Compile():  File dependencies are not analysed.
+   * @param language      The name of the language that is being analysed.
+   * @param path          The path of the file to analyze relative to project-path.
+   * @param project-path  The path of the directory that contains all the source files.
+   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top-internal(|phase, language, project-path, full-path)
+   */
+  analyze-top(|phase, language, path, project-path):
+    ast -> (ast', filesToAnalyze)
+    with
+      full-path := $[[project-path]/[path]];
+      if index-split then
+        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
+        asts := <index-toplevel-split> ast;
+        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
+      else
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, ""))]
+      end
+  
+rules // Parallel analysis
+  
+  /**
+   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
+   * analysis of dependent files that have changed during the analysis.
+   *
+   * Example:
+   *   <index-parallel-analyze-files(analyze)> ["text/file1.ext", "text/file2.ext"]
+   *
+   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
+   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
+   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @type List((file, subfile) or file) -> None()
+   */
+  index-parallel-analyze-files(analyze):
+    files -> None()
+    with
+      length; 
+      set-total-work-units
+    with
+      index-parallel-analyze(analyze);
+      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
+ 
+rules // Query primitives
+ 
+  /**
+   * Gets all DefData entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data(|Type())> Def([Entity(), "Bar"]) => [DefData([Entity(), "Bar"], Type(), TYPE("Bar")), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(DefData(uri, kind, value))
+   */
+  index-get-data(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
+      
+  /**
+   * Gets all data entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(value)
+   */
+  index-get-data-all(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
+     
+  /**
+   * Gets all Use entries that match the URI in given definition.
+   *
+   * Example:
+   *   <index-get-uses-all> Def([Entity(), "M", "Bar"]) => [Use([Entity(), "M", "Bar"]), ...]
+   *
+   * @type Def(uri) -> List(Use(uri))
+   */
+  index-get-uses-all:
+    <with(?Def(uri) | "Def expected")> -> <index-get-all> Use(uri)
+     
+  /**
+   * Gets all Read or ReadWildcard entries that match the given template.
+   *
+   * Example:
+   *   <index-get-reads-all> [Property(), "Bar", "p"] => [Read([Property(), "Bar", "p"]), ...]
+   *
+   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
+   */
+  index-get-reads-all:
+    template -> <conc> (reads, readwildcards')
+    where
+      uri   := <index-uri> template;
+      reads := <index-get-all> Read(uri);
+      if !uri => [namespace, prefix | path-parent] then
+        readwildcards  := <index-get-all> ReadWildcard([namespace | path-parent], ());
+        readwildcards' := <filter(index-readwildcard-substring(|prefix))> readwildcards
+      else
+        readwildcards' := []
+      end
+ 
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  index-get-all:
+    template -> <indexlib-get-all> template
+      with
+       if set := <Index-ReadSet> then
+         uri := <index-uri>;
+         <iset-add(|Read(uri))> set
+       end
+       
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  index-get-all-values:
+    template -> <map(index-value)> <index-get-all> template
+       
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
+   */
+  index-get:
+    template -> <?[<id>|_]> <index-get-all> template
+      
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  index-get-value:
+    template -> <index-value> <?[<id>|_]> <index-get-all> template
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field())> Def([Entity(), "Baz"]) => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field())> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field())> [Entity(), "Baz"] => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace) = 
+    index-get-children(\uri -> Def(uri)\|namespace)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children
+    with
+      template  := <construct-template> [namespace | path];
+      children  := <prim("LANG_index_get_children", template)>;
+      <store-wildcard-read(|namespace, path, "")> children
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field(), "fo")> Def([Entity(), "Baz"]) => [Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field(), "ba")> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), ...]
+   *   <index-get-children(|Field(), "ze")> [Entity(), "Baz"] => [...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace, prefix) = 
+    index-get-children(\uri -> Def(uri)\|namespace, prefix)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
+   * using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @param prefix              Only child elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace, prefix):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children'
+    with
+      prefix'   := <strip-annos> prefix;
+      template  := <construct-template> [namespace | path];
+      children  := <prim("LANG_index_get_children", template)>;
+      children' := <filter(index-is-name-substring(|prefix'))> children;
+      <store-wildcard-read(|namespace, path, prefix')> children'
+
+  /**
+   * Gets a set of all files that have a reference to the given index entries.
+   *
+   * Example:
+   *   <index-get-referenced-files(\uri -> [Read(uri), Use(uri, [])]\)> [Def([Entity(), "Bar"]), ...] => 
+   *     [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
+   *                            constructs from all given entries, such as \uri -> [Read(uri), Use(uri, [])]\
+   * @type List(elem) -> List((file, subfile))
+   */
+  index-get-referenced-files(construct-from-uri):
+    entries -> files
+    where
+      uris        := <filter(index-uri)> entries;
+      referenced  := <concat> <filter(construct-from-uri)> uris;
+      files       := <iset-elements> <iset-addlist(|<mapconcat(index-get-files-of)> referenced)> <new-iset>
+ 
+  /**
+   * Convenience function for finding files with Read and Use dependencies to the given definitions.
+   *
+   * Example:
+   *   <index-get-dependent-files> [Def([Entity(), "Bar"]), ...] => [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @type List(elem) -> List((file, subfile))
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
+   */
+  index-get-dependent-files = 
+    index-get-referenced-files(index-file-dependent-construct)
+     
+rules // Index lookup rules (that take into account adjust-index-lookup)
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning its Def.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup:
+    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   * 
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all:
+    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup-outermost(|prefix):
+    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, returns Defs that have the same parent URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-one-level(|prefix):
+    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(|prefix):
+    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-one-level(id|namespace, def-path, prefix)> x
+      else
+        defs := <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      end
+    <+
+      defs := []
+      
+rules // Index utilities
+  
+  /**
+   * Gets the namespace part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-namespace> "Bar"{[Entity(), "Bar", "Baz"]} => Entity()
+   *
+   * @type "name"{uri@[namespace|path]} -> namespace
+   */
+  index-uri-namespace:
+    x{[namespace|path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   *
+   * Example:
+   *   <index-uri-path> "Bar"{[Entity(), "Bar", "Baz"]} => ["Bar", "Baz"]
+   *
+   * @type "name"{uri@[namespace|path]} -> path'
+   */
+  index-uri-path:
+    x{[namespace|path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+      
+  /**
+   * Gets the name part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-name> "Bar"{[Entity(), "Bar", "Baz"] => "Bar"
+   *
+   * @type "name"{uri@[namespace|[name|restPath]]} -> name
+   */ 
+  index-uri-name:
+    x{[_|[name|_]]} -> name
+    
+  /**
+   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
+   *
+   * Example:
+   *   <index-uri-name> Def([Entity(), "Bar", "Baz"]) => "Bar"
+   *   <index-uri-name> Type("Foo") => fail
+   *   <index-uri-name> Read([Entity()]) => fail
+   *
+   * @type x -> name
+   */   
+  index-uri-name:
+    x -> <index-uri-name> <index-uri> x
+    where
+      not(<has-annos> x)
+    
+  /**
+   * Determines if a given AST node is a definition site, according to the syntax.
+   *
+   * FIXME: Also succeeds on use sites.
+   *
+   * @type def -> ?def
+   */
+  index-is-definition =
+    where(nam-get-definition-key)
+    
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
+   *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
+   *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
+   *
+   * @type (k1, k2) -> ?(k1, k2)
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/compilation-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/compilation-library.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,192 @@
+module lib/compilation-library.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+  lib/analysis-library-internal.generated
+  
+rules // Extension points
+  
+  /**
+   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
+   *
+   * Extension example:
+   *   index-desugar-ast:
+   *     ast -> <desugar> ast
+   *
+   * @type ast -> ast'
+   */
+  index-desugar-ast = fail
+    
+  /**
+   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
+   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
+   * compilation.
+   *
+   * Extensions example:
+   *   index-compile-ast(|file, subfile):
+   *     ast -> None()
+   *     with
+   *       java := <to-java> ast;
+   *       full-path := <dirname> file;
+   *       filename := <guarantee-extension(|"java")> <base-filename> file;
+   *       writePath := $[[full-path]/java/];
+   *       writeFile :=  $[[writePath][filename]];
+   *       try(<mkdir> writePath);
+   *       <fclose> <fputs> (java, <fopen> (writeFile, "w"))
+   *
+   * @param file    The file that must be compiled.
+   * @param subfile The subfile that must be compiled ("" if there is no subfile).
+   * @type ast -> None()
+   */
+  index-compile-ast(|file, subfile) = fail
+  
+rules // Compilation
+  
+  /**
+   * Schedules compilation in the background of all files that have changed since the last compilation.
+   *
+   * @type x -> x
+   */
+  index-schedule-compilation:
+    _ -> None()
+    with
+      queue-strategy(|"index-compilation", "Compiling files")
+  
+  /** @internal */
+  index-compilation:
+    language -> None()
+    with
+      // Init
+      project-path := <project-path>;
+      index-setup(|language, [project-path], ".")
+    with
+      // Determine the files to compile by looking at changed files
+      diffs         := <analyze-get-compilediffs>;
+      files         := <map(index-compilation-restore-read-file)> diffs;
+      filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
+      
+      // Clean compile time reads
+      <filter(index-compilation-clean-reads)> filteredFiles;
+      
+      // Set total work units to number of files to compile for visual indication
+      <set-total-work-units> <length> filteredFiles;
+      
+      // Compile the files
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
+
+  /** @internal */
+  index-compilation-file(|language, project-path):
+    (path, subfile) -> None()
+    with
+      // Parse and analyze ast.
+      ast                              := <parse-file> path;
+      ast'                             := <try(index-desugar-ast)> ast;
+      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
+    with
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Compile file
+        <try(index-compile-ast(|path, subfile))> ast'';
+        
+        // Store compile-time reads.
+        reads := <iset-elements> readSet;
+        <index-add-all(|<index-compilation-file-tuple> (path, subfile))> reads
+      |}
+
+  /** @internal */
+  index-compilation-filter-file:
+    (file, subfile) -> (file, subfile)
+    where
+      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
+    
+rules // On save handling
+  
+  /**
+   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
+   *
+   * @see trigger-commit-and-compile
+   *
+   * @internal
+   */
+  commit-and-compile:
+    language -> None()
+    with
+      index-commit
+    with
+      index-schedule-compilation
+
+  /**
+   * Triggers commit and compilation, requires target language as current term.
+   * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
+   * enable-commit-and-compile is called.
+   *
+   * @type language -> ?language
+   *
+   * @see enable-commit-and-compile
+   * @see disable-commit-and-compile
+   */
+  trigger-commit-and-compile:
+    language -> <id>
+    with
+      if not(index-is-global-enabled(|"delay-compile")) then
+        commit-and-compile
+      else
+        index-enable-global(|"trigger-compile")
+      end
+  
+  /**
+   * Delays commit and compilation until enable-commit-and-compile is called.
+   *
+   * @type x -> x
+   *
+   * @see enable-commit-and-compile
+   */
+  disable-commit-and-compile = 
+    index-enable-global(|"delay-compile")
+  
+  /**
+   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
+   * is triggered now.
+   *
+   * @type x -> x
+   *
+   * @see disable-commit-and-compile
+   */
+  enable-commit-and-compile:
+    language -> <id>
+    with
+      if index-is-global-enabled(|"trigger-compile") then
+        commit-and-compile
+      end;
+      index-disable-global(|"delay-compile")
+      
+/** @internal */
+rules // Compile time reads
+
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
+    where
+      file' := <string-replace(|<index-compilation-read-path>, "")> file
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file, subfile)
+    where
+      not(<string-replace(|<index-compilation-read-path>, "")> file)
+      
+  /** @internal */
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+      
+  /** @internal */
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  /** @internal */
+  index-compilation-read-path =
+    !"/.internal/reads/compile"

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/editor-common.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/editor-common.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,266 @@
+module lib/editor-common.generated
+
+imports
+  libstratego-lib
+  libstratego-sglr
+  libstratego-gpp
+
+strategies
+
+  parse-file = parse-combe-file
+  parse-combe-file =
+    parse-file(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/ComBE.tbl)>
+    )
+
+  parse-string = parse-combe-string
+  parse-combe-string =
+    parse-string(
+      strsglr-report-parse-error
+    | <import-term(include/ComBE.tbl)>
+    )
+  
+  parse-stream = parse-combe-stream
+  parse-combe-stream =
+    parse-stream(
+      strsglr-report-parse-error
+    | <import-term(include/ComBE.tbl)>
+    )
+
+  pp-combe-string =
+    ast2abox(|[<import-term(include/ComBE.generated.pp.af)>,
+               <import-term(include/ComBE.pp.af)>]);
+    box2text-string(|100)
+    
+  language = !"ComBE"
+
+strategies
+  
+  /**
+   * Processes an import during semantic analysis.
+   * Ensures proper caching of files and prevents
+   * processing duplicate imports more than once.
+   *
+   * @param resolve-path  Resolves the filesystem path of this import
+   * @param parse-file    Parses a file (optionally removing definition bodies
+   *                      so only signatures are stored in the cache)
+   * @param record-declarations
+   *                      Performs semantic analysis on a tree
+   */
+  open-import(resolve-path, parse-file, record-declarations):
+    import -> import
+    where
+      if not(!import => COMPLETION(_)) then
+        path       := <resolve-path> import;
+        cache-path := <import-cache-path> path;
+        if not(<IsImported> path) then
+          rules(
+            IsImported: path
+          );
+          ( <is-newer> (cache-path, path);
+            file := <ReadFromFile> cache-path
+          <+
+            file := <parse-file> path;
+            if <file-exists> path then
+              // Only cache if on filesystem (e.g., ignore libstratego-lib)
+              <WriteToBinaryFile> (cache-path, file)
+            end        
+          );
+          {| CurrentFile:
+            rules(CurrentFile := path);
+            <record-declarations> file
+          |}
+        end
+      end
+
+  open-wildcard-import(resolve-path, parse-file, record-declarations, is-source-file):
+    import -> import
+    where
+      if not(!import => COMPLETION(_)) then
+        path := <resolve-path> import;
+        readdir;
+        list-loop(
+          if is-source-file then
+            <open-import(id, parse-file, record-declarations)>
+              $[[path]/[<id>]]
+          <+
+            try(?one-failed)
+          end
+        );
+        not(!one-failed)
+      end
+  
+  import-cache-path:
+    full-path -> cache-path
+    with
+      project-path := <project-path>;
+      cache-dir    := <file-exists <+ mkdir> $[[project-path]/.cache];
+      full-path'   := <string-replace(|"/", "+"); string-replace(|"\\", "+"); string-replace(|":", "+")> full-path;
+      cache-path   := $[[cache-dir]/[full-path'].sig]
+
+  project-path = prim("SSL_EXT_projectpath")
+  
+  plugin-path = prim("SSL_EXT_pluginpath")
+  
+  candidate-sorts = prim("SSL_EXT_candidatesorts")
+
+  is-newer:
+    (file1, file2) -> <id>
+    where
+      <gt> (<file-exists; modification-time> file1, <file-exists; modification-time> file2) 
+
+strategies
+  
+  editor-init =
+    // Ensure all dynamic rules are properly scoped
+    try(dr-scope-all-end);
+    dr-scope-all-start
+  
+  refresh-workspace-file:
+    path -> <prim("SSL_EXT_refreshresource", path)>
+  
+  string-starts-with-capital =
+    explode-string; Hd; is-upper
+
+strategies
+  
+  origin-term      = prim("SSL_EXT_origin_term", <id>)
+  origin-text      = prim("SSL_EXT_origin_text", <id>)
+  origin-offset    = prim("SSL_EXT_origin_offset", <id>)
+  origin-location  = prim("SSL_EXT_origin_location", <id>)
+  origin-line      = origin-location => (<id>, _, _, _)
+  origin-column    = origin-location => (_, <id>, _, _)
+  origin-file      = prim("SSL_EXT_origin_file", <id>)
+  origin-strip     = prim("SSL_EXT_origin_strip", <id>)
+  origin-equal(|t) = prim("SSL_EXT_origin_equal", <id>, t)
+
+  origin-language =
+    prim("SSL_EXT_origin_language", <id>)
+  
+  origin-surrounding-comments =
+    prim("SSL_EXT_origin_surrounding_comments", "ComBE", <id>)
+    
+  origin-documentation-comment =
+    origin-surrounding-comments;
+    filter(string-as-chars(documentation-comment-chars));
+    concat-strings
+  
+  documentation-comment-chars:
+    ['*' | c*] -> <ltrim(' ' + '\t' + '\n' + '\r')> c*
+  
+  origin-track-forced(s) =
+    ![<id>]; all(s); ?[<id>]
+
+strategies
+
+  desugar-position(desugar|ast):
+    position -> position'
+    where
+      ast'  := <at-position(!<id>{MARKER()}|position)> ast;
+      ast'' := <topdown(repeat(preserve-annos({?x; desugar; not(?x)})))> ast';
+      position' := <position-of-term({?_{a*}; <one(?MARKER())> a*})> ast''
+   
+  at-position(s|position):
+    c#(t*) -> t'
+    where
+      !position => [i | position']
+    where
+      t' := c#(<at-index(at-position(s|position'))> (i, t*))
+
+  at-position(s|position):
+    t -> t'
+    where
+      !position => [];
+      t' := <s> t
+
+  position-of-term(is-term):
+    t -> []
+    where
+      is-term
+  
+  position-of-term(is-term):
+    _#(t*) -> <position-of-term(is-term|0)> t*
+  
+  position-of-term(is-term|start-index):
+    [t | t*] -> position
+    where
+      if i* := <position-of-term(is-term)> t then
+        position := [start-index | i*]
+      else
+        position := <position-of-term(is-term | <inc> start-index)> t*
+      end
+
+  term-at-position(|position):
+    t -> t'
+    where
+      at-position(?t'|position) 
+
+  parent-at-position(|position):
+    t -> t'
+    where
+      !position => [i, _];
+      t' := <subterm-at(|i)> t
+  
+  parent-at-position(|position):
+    t -> <parent-at-position(|position')> t'
+    where
+      !position => [i | position' @ [_, _ | _]];
+      t' := <subterm-at(|i)> t
+
+  subterm-at(|index):
+    _#(t*) -> <index(|<inc> index)> t*
+  
+signature constructors
+
+  COMPLETION : String -> Term
+  NOCONTEXT  : Term   -> Term
+  MARKER     : Term
+  True       : Term
+
+  // Below are copies of the signatures of the terms used in example
+  // trans/combe.str file. These definitions should also be automatically 
+  // generated in the imported include/ComBE.str module. However,
+  // to ensure that the example transformation doesn't break when the
+  // syntax is changed, we also hard-coded them here.
+          
+  Module   : ID * List(Entity)   -> Module
+  Entity   : ID * List(Property) -> Entity
+  Property : ID * Type           -> Property
+  Type     : ID                  -> Type
+
+strategies
+  
+  // Set markers for a given file. Use when checking files from a queued strategy.
+  // Current term: (ast-desugared, errors, warnings, notes) tuple
+  // ast: the root node of the file to set markers on 
+  set-markers(|ast) = prim("SSL_EXT_set_markers", ast)
+
+  // Indicate that one or more files need analysis. 
+  // Current term: ss a list of absolute file paths, or a single absolute file path to analyze
+  queue-analysis = 
+       (is-list; list-loop(queue-analysis))
+    <+ prim("SSL_EXT_queue_analysis")
+    
+  // Gets the number of background analyses for currenct project and language.
+  // Current term: ignored
+  analysis-count = prim("SSL_EXT_queue_analysis_count")
+
+  // Set the total number of work units to complete. Can be called multiple times. 
+  // Current term: number of work units (int).
+  set-total-work-units = prim("SSL_EXT_set_total_work_units")
+  
+  // Complete one work unit and update progress monitors.
+  // Current term: ignored
+  complete-work-unit = prim("SSL_EXT_complete_work_unit")
+  
+  // Queue a strategy for background processing with a progress indicator.
+  // Current term: the term to pass to the background strategy
+  // s: the strategy, as string
+  // description: name of the task (will be shown in progress view)
+  queue-strategy(|s,description) = prim("SSL_EXT_queue_strategy", s, description)
+  
+  // Return the result of this strategy to indicate a non-completed (backgrounded) analysis.
+  // Editor services (hover, resolve) will be delayed until a complete analysis is performed. 
+  set-analysis-backgrounded = !"BACKGROUNDED"
+  

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/index-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/index-library.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,655 @@
+module lib/index-library.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  
+signature constructors
+  
+  // Index elements
+  DefData      : List(UriPart) * DefDataType * Term -> Summary
+    
+  // URI header
+  Namespace      : UriPart
+  Unresolved     : Namespace -> UriPart
+  INTERNAL_ERROR : UriPart
+  Timestamp      : UriPart
+ 
+  // Remainder of URI
+  String : UriPart
+  Anon   : Int -> UriPart
+  Anon   : UriPart
+  
+  FileEntries : Term * Term -> Term
+  
+  // Globals
+  Global : Namespace
+  Global : List(UriPart) -> Summary
+  Global : List(UriPart) * List(Summary) -> Summary
+  
+rules // Index management
+   
+  /**
+   * Sets up the index library for given language and project paths.
+   * Must be called once before doing anything with the library.
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   *
+   * @obsolete
+   * @type x -> x
+   */
+  index-setup(|language, project-paths) =
+    obsolete(!"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)");
+    index-setup(|language, project-paths, ".")
+    
+  /**
+   * Sets up the index library for given language, project paths and current file.
+   * Must be called once before doing anything with the library.
+   *
+   * Example:
+   *   <index-setup(|"MiniJava", [<project-path>], "test/test.mjv")
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
+   *                      Can also be changed later using index-set-current-file.
+   * @type x -> x
+   */
+  index-setup(|language, project-paths, current-file) =
+    prim("LANG_index_setup", language, project-paths, current-file)
+    
+  /**
+   * Sets the current file the index (analysis) is operating on to the given file.
+   *
+   * Example:
+   *   <index-set-current-file> "fullpath/file.ext"
+   *   <index-set-current-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
+   */
+  index-set-current-file = 
+    prim("LANG_index_set_current_file", <id>)
+
+  /**
+   * Adds given element to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add(|"fullpath/file.ext")> Def([Entity(), "Bar"])
+   *   <index-add(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   *
+   * @param file  The file (and subfile) to add the element to.
+   * @type x -> ?x
+   */
+  index-add(|file) =
+    prim("LANG_index_add", <id>, file)
+
+  /**
+   * Adds all given elements to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to add the elements to.
+   * @type List(x) -> ?List(x)
+   */
+  index-add-all(|file) =
+    list-loop(with(index-add(|file)))
+    
+  /**
+   * Removes given element from the index that is contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove(|"fullpath/file.ext")> Def([Entity(), "Bar"])
+   *   <index-remove(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   * 
+   * @param file  The file (and subfile) to remove the element from.
+   * @type x -> ?x
+   */
+  index-remove(|file) =
+    prim("LANG_index_remove", <id>, file)
+    
+  /**
+   * Removes all given elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to remove the elements from.
+   * @type List(x) -> ?List(x)
+   */
+  index-remove-all(|file) =
+    list-loop(with(index-remove(|file)))
+    
+  /**
+   * Removes all elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-clear-file> "fullpath/file.ext"
+   *   <index-clear-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
+   */
+  index-clear-file = 
+    prim("LANG_index_clear_file", <id>)
+    
+  /**
+   * Clears all elements from the index.
+   *
+   * @type x -> x
+   */
+  index-clear = 
+    prim("LANG_index_clear_all")
+   
+  /**
+   * Commits index to a file on disk.
+   *
+   * @type x -> x
+   */
+  index-commit = 
+    prim("LANG_index_commit")
+
+  /**
+   * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
+   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
+   *
+   * @type x -> x
+   */
+  index-start-transaction = 
+    prim("LANG_index_start_transaction")
+  
+  /**
+   * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
+   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
+   * this call.
+   *
+   * @type x -> x
+   */
+  index-end-transaction = 
+    prim("LANG_index_end_transaction")
+  
+  /**
+   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
+   * strategy are thread safe.
+   * 
+   * @param s The strategy to apply.
+   * @type x -> x'
+   *
+   * @see index-start-transaction
+   * @see index-end-transaction
+   */
+  index-transaction(s) = 
+    prim("LANG_index_start_transaction"); s; prim("LANG_index_end_transaction")
+  
+rules // Index querying
+  
+  /**
+   * Gets the file that the analysis is currently in.
+   *
+   * @type x -> (file, subfile)
+   *
+   * @see index-setup(|language, project-paths, current-file)
+   * @see index-set-current-file
+   */
+  index-get-current-file =
+    prim("LANG_index_get_current_file")
+  
+  /**
+   * Gets a list of all files and subfiles for current project.
+   *
+   * Example:
+   *   <index-get-all-files> => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type x -> List((file, subfile))
+   */   
+  index-get-all-files =
+    prim("LANG_index_all_files")
+  
+  /**
+   * Gets all index entries for the given file path and optionally subfile.
+   *
+   * Examples:
+   *   <index-get-all-in-file> "fullpath/file.ext" => [Def([Entity(), "Bar"]), ...]
+   *   <index-get-all-in-file> ("fullpath/file.ext", "subfile") => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type file or (file, subfile) -> List(elem)
+   */  
+  index-get-all-in-file:
+    filepath -> entries
+    with
+      entries := <prim("LANG_index_get_all_in_file", filepath)>
+   
+  /**
+   * Gets index entries in some namespace for the given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-get-all-in-file(|Import())> "fullpath/file.ext" => [Def([Import(), "Bar"]), ...]
+   *   <index-get-all-in-file(|Import())> ("fullpath/file.ext", "subfile") => [Def([Import(), "Bar"]), ...]
+   *
+   * @param namespace Only index entries from this namespace are retrieved.
+   * @type file or (file, subfile) -> List(elem)
+   */  
+  index-get-all-in-file(|namespace):
+    filepath -> entries
+    with
+      // TODO: Optimize -- add an argument to LANG_index_get_all_in_file to do this filtering
+      entries := <prim("LANG_index_get_all_in_file", filepath)>;
+      filter(where(index-uri => [namespace | _]))
+    
+  /**
+   * Gets the revision of a file and optionally subfile.
+   *
+   * Example:
+   *   <index-get-file-revision> "fullpath/file.ext" => 13
+   *   <index-get-file-revision> ("fullpath/file.ext", "subfile") => 37
+   *
+   * @type file or (file, subfile) -> Int
+   */
+  index-get-file-revision:
+    file -> <prim("LANG_index_get_file_revision", file)>
+    
+  /**
+   * Gets the containing files and subfiles of index entry with given template.
+   *
+   * Example:
+   *   <index-get-files-of> Def([Entity(), "Bar"]) => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type template -> List((file, subfile))
+   */  
+  index-get-files-of:
+    template -> <prim("LANG_index_get_files_of", template)>
+    
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  indexlib-get-all:
+    template -> <prim("LANG_index_get", template)>
+    
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  indexlib-get-all-values:
+    template -> <map(index-value)> <indexlib-get-all> template
+ 
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
+   */
+  indexlib-get:
+    template -> <?[<id>|_]> <indexlib-get-all> template
+   
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  indexlib-get-value:
+    template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
+    
+rules // Index globals
+    
+  /**
+   * Gets the 'fake' path where globals are stored in the index.
+   *
+   * @internal
+   */
+  index-globals-path = 
+    !"/.internal/globals"
+    
+  /**
+   * Gets the URI where globals are stored in the index for given name or names.
+   *
+   * @internal
+   * @type name or List(name) -> uri
+   */
+  index-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["globals", ".internal"]]
+      else
+        uri := [Global(), names, "global", ".internal"]
+      end
+    
+  /**
+   * Gets the first value in global storage with given name, or fail.
+   *
+   * Example:
+   *   index-get-global(|"last-compile") => Timestamp(1334322856)
+   *   index-get-global(|["last-compile", "file.str"]) => Timestamp(1334322856)
+   * 
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> ?value
+   */
+  index-get-global(|name):
+    _ -> value
+    where
+      value := <indexlib-get-value> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Gets all values in global storage with given name.
+   *
+   * Example:
+   *   index-get-global(|"last-compile") => [Timestamp(1334322856), ...]
+   *   index-get-global(|["last-compile", "file.str"]) => [Timestamp(1334322856), ...]
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> List(value)
+   */ 
+  index-get-all-globals(|name):
+    _ -> values
+    with
+      values := <indexlib-get-all-values> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Add value to global storage with given name.
+   *
+   * Example:
+   *   <index-add-global(|"last-compile")> Timestamp(1334322856)
+   *   <index-add-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-add-global(|name):
+    value -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-globals-uri> name, value)
+      
+  /**
+   * Overwrites value in global storage with given value.
+   *
+   * Example:
+   *   <index-set-global(|"last-compile")> Timestamp(1334322856)
+   *   <index-set-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-set-global(|name):
+    value -> <id>
+    with
+      index-clear-global(|name);
+      <index-add-global(|name)> value
+    
+  /**
+   * Removes all values from global storage with given name.
+   *
+   * Example:
+   *   index-clear-global(|"last-compile")
+   *   index-clear-global(|["last-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-clear-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-globals-uri> name, ())
+      
+  /**
+   * Gets the URI where boolean globals are stored in the index for given name or names.
+   *
+   * @internal
+   */
+  index-boolean-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["boolean", "globals", ".internal"]]
+      else
+        uri := [Global(), names, "boolean", "global", ".internal"]
+      end
+      
+  /**
+   * Sets boolean value true to global boolean storage with given name.
+   *
+   * Example:
+   *   index-enable-global(|"can-compile")
+   *   index-enable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-enable-global(|name):
+    _ -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Sets boolean value false to global boolean storage with given name.
+   *
+   * Example:
+   *   index-disable-global(|"can-compile")
+   *   index-disable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-disable-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Query for boolean value true in global boolean storage with given name.
+   *
+   * Example:
+   *   index-is-global-enabled(|"can-compile")
+   *   index-is-global-enabled(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> ?x
+   */   
+  index-is-global-enabled(|name):
+    _ -> <id>
+    where
+      <indexlib-get> Global(<index-boolean-globals-uri> name)
+
+rules // Index utility
+  
+  /**
+   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
+   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
+   * given term.
+   *
+   * Example:
+   *   <index-uri> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => [Entity(), "Bar", "Baz"]
+   *
+   * @type elem -> ?uri
+   *
+   * @see index-uri-impl
+   * @see index-uri-generic
+   */ 
+  index-uri = 
+    index-uri-impl <+ index-uri-generic
+  
+  /**
+   * Gets the namespace part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => Entity()
+   *
+   * @type uri@[namespace|path] -> namespace
+   */ 
+  index-uri-namespace =
+    ?[<id>|_]
+  
+  /**
+   * Gets the path part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => ["Bar", "Baz"]
+   *   <index-uri-path> [Entity()] => []
+   *
+   * @type uri@[namespace|path] -> path
+   */ 
+  index-uri-path =
+    ?[_|<id>]
+    
+  /**
+   * Gets the name part of the given URI or fail if there is no name.
+   *
+   * Example:
+   *   <index-uri-name> [Entity(), "Bar", "Baz"] => "Bar"
+   *   <index-uri-name> [Entity()] => fail
+   *
+   * @type uri@[namespace|[name|restPath]] -> ?name
+   */ 
+  index-uri-name =
+    ?[_|[<id>|_]]
+  
+  /**
+   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
+   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
+   * from the given term.
+   *
+   * Example:
+   *   <index-value> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => TYPE("Bar")
+   *
+   * @type elem -> ?value
+   *
+   * @see index-value-impl
+   * @see index-value-generic
+   */  
+  index-value = 
+    index-value-impl <+ index-value-generic
+  
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   *
+   * @type x -> ?x
+   */
+  index-is-fake-file = 
+    string-starts-with(|"/.internal")
+  
+  /**
+   * Checks if given URI's are equal. Discards anonymous scopes if necessary.
+   *
+   * Example:
+   *   <index-uri-eq> ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"]) => 
+   *     ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"])
+   *   <index-uri-eq> ([Entity(), "Foo"], [Entity(), "Bar"]) => fail
+   *
+   * @type (u1, u2) -> ?(u1, u2)
+   */
+  index-uri-eq:
+    (u1, u2) -> <id>
+    where
+      u1' := <index-uri-unwrap> u1;
+      u2' := <index-uri-unwrap> u2;
+      (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
+  
+  /**
+   * Finds the first key (term{uri} element) for given term, or fail. 
+   *
+   * @type x -> ?name{uri}
+   */
+  index-find-key:
+    x -> key
+    where
+      key := <collect-one(?_{_})> x
+      
+  /**
+   * Converts a URI to a string.
+   *
+   * Example:
+   *   <index-uri-to-string> [Entity(), "Bar", "Baz"] => "Entity://Bar.Baz"
+   *
+   * @type uri -> str
+   */
+  index-uri-to-string:
+    [ns|path] -> <concat-strings> [nsStr, "://", pathStr]
+    with
+      pathStr := <take-until(?Anon(_)); reverse; separate-by(|"."); concat-strings> path;
+      nsStr := <?<id>#(_)> ns
+  
+  /**
+   * Converts a file to a string.
+   *
+   * Example:
+   *   <index-file-to-string> "fullpath/file.ext" => "fullpath/file.ext"
+   *
+   * @type file -> file
+   */
+  index-file-to-string:
+    file -> file
+    where
+      not(<is-tuple> file)
+  
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   *
+   * @type (file, "") -> file
+   */
+  index-file-to-string:
+    (file, "") -> file
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
+   *
+   * @type (file, subfile) -> str
+   */
+  index-file-to-string:
+    (file, subfile) -> <concat-strings> [file, "@", subfile]
+    where
+      not("" := subfile)
+      
+/** @internal */
+rules // URI and value projections
+  
+  /** @internal */
+  index-uri-impl:
+    DefData(uri, _, _) -> uri
+
+  /** @internal */
+  index-uri-generic:
+    term -> <?_#(<?[<id>|_]>)> term
+  
+  /** @internal */
+  index-value-impl:
+    DefData(_, _, value) -> value
+    
+  /** @internal */
+  index-value-generic:
+    term -> <?_#(<?[_, <id>|_]> )> term
+     
+/** @internal */ 
+rules // Internal helpers
+  
+  /** @internal */
+  index-namespace-unwrap =
+    \Unresolved(n) -> n\ <+ id
+    
+  /** @internal */
+  index-uri-unwrap =
+    \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/refactor-common.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/lib/refactor-common.generated.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,67 @@
+module lib/refactor-common.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  
+
+strategies //transformation
+
+/**
+ * Replaces elements in a list (once, starting from the right)
+ * @param match strategy for partial list
+ * @param new elements List(b)
+ * @type List(a) -> List(a,b)
+ */
+replace-sublist(match-sublist|new-elems): 
+  list -> <
+    at-suffix(match-sublist;!new-elems) <+
+    (
+      init; 
+      replace-sublist(match-sublist|new-elems);
+      at-end(![<last> list])
+    )
+  > list 
+
+/**
+ * Inserts an element at a given AST position
+ * @param List(Int), denoting an AST position
+ * @param inserted list element 
+ * @type Term -> Term
+ */
+insert-elem(|pos, elem)=
+  insert-sublist(|pos, [elem])
+
+/**
+ * Inserts a list of elements at a given AST position
+ * @param List(Int), denoting an AST position
+ * @param inserted list elements 
+ * @type Term -> Term
+ */	
+insert-sublist(|pos, elems)=
+  at-position(
+    split-at(|<last> pos);
+    ?(prefix, suffix);
+    <concat>[prefix, elems, suffix]
+    |<init> pos
+  )
+
+
+strategies //user-input
+
+/**
+ * Opens an input dialog for one string value that represents an identifier
+ * The language is used to check if the input value matches the identifier pattern
+ * @type (String, String, String, String) -> String
+ */
+input-dialog:
+  (language, title, label, default-value) -> <prim("SSL_EXT_newnamedialog", language, title, label, default-value)>
+  
+input-dialog:
+  (title, label, default-value) -> <input-dialog>("", title, label, default-value)
+
+strategies //pp-table
+	
+get-pp-table=
+  import-term(include/ComBE.generated.pp.af)
+	

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/plugin.xml
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/plugin.xml	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+<?eclipse version="3.0"?>
+
+<plugin>
+       <extension point="org.eclipse.imp.runtime.languageDescription">
+          <language extensions="bt" description="ComBE" language="ComBE" derivedFrom="DynamicRoot" validator="org.behaviorengineering.combe.textual.ComBEValidator" validatorClass="org.behaviorengineering.combe.textual.ComBEValidator"></language>
+       </extension>
+       <extension id="org.behaviorengineering.combe.textual.parser" name="ComBE Parser" point="org.eclipse.imp.runtime.parser">
+          <parser class="org.behaviorengineering.combe.textual.ComBEParseController" language="ComBE">
+          </parser>
+       </extension>    
+    </plugin>
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.generated.pp
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.generated.pp	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,3 @@
+[
+   Start -- KW[""]
+]
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.pp
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.pp	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,2 @@
+%% Pretty printing table (see also ComBE.generated.pp)
+[]

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/ComBE.sdf	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,15 @@
+%% Grammar for the ComBE language
+%% By default, based on an example "entities" syntax
+module ComBE
+
+imports Common
+
+exports
+
+  context-free start-symbols
+  
+    Start
+
+  context-free syntax
+  
+    ""       -> Start {"Start"}
\ No newline at end of file

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/Common.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/syntax/Common.sdf	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,46 @@
+module Common
+
+exports
+
+  lexical syntax
+  
+    [a-zA-Z][a-zA-Z0-9]* -> ID
+    "-"? [0-9]+          -> INT
+    
+    "\"" StringChar* "\"" -> STRING
+    ~[\"\n]               -> StringChar
+    "\\\""                -> StringChar
+    BackSlashChar         -> StringChar
+    "\\"                  -> BackSlashChar
+    
+    [\ \t\n\r] -> LAYOUT
+    
+    [\*]                             -> CommentChar
+    "/*" (~[\*] | CommentChar)* "*/" -> LAYOUT
+    "//" ~[\n\r]* ([\n\r] | EOF)     -> LAYOUT
+    
+    -> EOF
+  
+  lexical restrictions
+  
+    %% Ensure greedy matching for lexicals
+  
+    CommentChar   -/- [\/]
+    INT           -/- [0-9]
+    ID            -/- [a-zA-Z0-9\_]
+    
+    %% EOF may not be followed by any char
+    
+    EOF           -/- ~[]
+
+    %% Backslash chars in strings may not be followed by " 
+    
+    BackSlashChar -/- [\"]
+
+  context-free restrictions
+  
+    %% Ensure greedy matching for comments
+
+    LAYOUT? -/- [\ \t\n\r]
+    LAYOUT? -/- [\/].[\/]
+    LAYOUT? -/- [\/].[\*]

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/test/example.bt
==============================================================================

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/analysis-manual.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/analysis-manual.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,9 @@
+module analysis-manual
+
+imports
+  include/ComBE
+  lib/analysis-auto.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+
+rules // Adjust lookup

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/check.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/check.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,14 @@
+module check
+
+imports
+  libstratego-lib
+  include/ComBE
+  lib/editor-common.generated
+  lib/analysis-auto.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+
+rules // Resolving
+  
+  constraint-error:
+    x{[Unresolved(t) | _]} -> (x, $[Unable to resolve.])

Added: experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/combe.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/combe/trunk/org.behaviorengineering.combe.textual/trans/combe.str	Mon May 21 12:01:45 2012	(r24841)
@@ -0,0 +1,152 @@
+module combe
+
+imports
+  libstratego-lib
+  libstratego-gpp
+  libstratego-aterm
+  include/ComBE
+  lib/editor-common.generated
+  lib/analysis-auto.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+  lib/analysis-library-internal.generated
+  lib/compilation-library.generated
+  analysis-manual
+  check
+
+rules // Analysis
+  
+  // Analyzes the current program, returning a tuple with the analyzed AST, errors, warnings, notes and
+  // files that should be re-analyzed.
+  analyze:
+    (ast, path, project-path) -> (ast'', errors, warnings, notes, filesToAnalyze')
+    with
+      ast'                    := <id> ast; // Optional AST desugaring
+      (ast'', filesToAnalyze) := <analyze-top(|<language>)> (ast', path, project-path);
+      index-transaction(
+        errors                := [];
+        warnings              := [];
+        notes                 := []
+      );
+      filesToAnalyze'         := <make-set> <map(index-filepair-to-file)> filesToAnalyze
+
+  // Main entry point for analyzes, called when a single file is opened in the editor.
+  editor-analyze:
+    (ast, path, project-path) -> (ast', errors, warnings, notes)
+    with
+      editor-init;
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze> (ast, path, project-path);
+      <try(editor-queue-analysis)> filesToAnalyze
+      
+  // Main entry point for analyzes, called when multiple files have changed. 
+  editor-analyze:
+    files -> None()
+    where
+      not(is-tuple)
+    with
+      index-setup(|<language>, [<project-path>], ".");
+      disable-commit-and-compile // Disable compilation during analysis.
+    with
+      editor-queue-analysis
+    with
+      // Enable and trigger compilation after all files have been analysed.
+      <enable-commit-and-compile> <language>;
+      <trigger-commit-and-compile> <language>
+      
+  // Called when current file is saved.
+  editor-save:
+    (_, _, _, _, _) -> None()
+    with
+      index-setup(|<language>, [<project-path>], ".");
+      <trigger-commit-and-compile> <language>
+
+rules // Editor services
+  
+  // Resolves a reference when the user control-clicks or presses F3 in the editor.
+  editor-resolve:
+    (node, position, ast, path, project-path) -> target
+    where
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-transaction(
+        target := <index-lookup> node
+      )
+
+  // Returns "hover help" information for a particular node in the editor.
+  // For references, this rule is invoked using the resolved term.
+  editor-hover:
+    (target, position, ast, path, project-path) -> $[[uriString]]
+    where
+      uriString := <index-uri-to-string> <index-uri> <index-find-key> target
+
+  // Completes an identifier when the user presses control-space
+  // (the completion identifier in the AST provides additional context information)
+  editor-complete:
+    (node, position, ast, path, project-path) -> proposals'
+    where
+      editor-init;
+      (ast', _) := <analyze-top(|<language>)> (ast, path, project-path);
+      item at COMPLETION(name) := <collect-one(?COMPLETION(_))> ast';
+      index-transaction(
+        (<index-lookup-all-levels(|name)> item <+ ![]) => proposals
+      );
+      proposals' := <map(index-uri-name)> proposals
+
+rules // Debugging
+  
+  // Prints the abstract syntax ATerm of a selection.
+  generate-aterm:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := selected
+      
+  // Prints the analyzed annotated abstract syntax ATerm of a selection.
+  generate-analyzed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      editor-init;
+      filename := <guarantee-extension(|"analyzed.aterm")> path;
+      result   := <analyze-top(|<language>)> (selected, path, project-path)   
+      
+  // Prints the definition annotated abstract syntax ATerm of a selection.
+  generate-deffed:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"aterm")> path;
+      result   := <analyze-defs(|Anon(), Anon())> selected
+      
+  // Prints the entries in the index of the current file.
+  index-currentfile:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"index.currentfile.aterm")> path;
+      result   := <index-get-all-in-file> path
+      
+  // Prints the entries in the index of all files.
+  index-allfiles:
+    (selected, position, ast, path, project-path) -> (filename, result)
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      filename := <guarantee-extension(|"index.allfiles.aterm")> path;
+      result   := <map(\filename -> (filename, <index-get-all-in-file> filename)\)> <index-get-all-files>
+      
+  // Cleans all data from the index.
+  index-cleanall:
+    (selected, position, ast, path, project-path)  -> None()
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-clear
+    
+rules // Utility
+  
+  // Queue parallel analysis for given list of files.
+  editor-queue-analysis = 
+    not(?[]); queue-strategy(|"editor-parallel-analyze", "Analyzing files")
+      
+  // Executes parallel analysis using the index library.
+  editor-parallel-analyze:
+    files -> None()
+    with
+      index-parallel-analyze-files(analyze)

From andre.s.d.vieira at gmail.com  Mon May 21 14:14:13 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Mon, 21 May 2012 12:14:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24842 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed
Message-ID: <20120521121413.6A6D6CC09D@mx4.tudelft.nl>

Author: AndreVieira
Date: Mon May 21 12:14:13 2012
New Revision: 24842
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24842&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/AST.aterm	Mon May 21 12:14:13 2012	(r24842)
@@ -0,0 +1 @@
+ApplicationDefs(Qualified(Qualified("T","pM_7c_"),"yU_NK__"),[Action(True,"u2V25U__SoC",[Arg("n46_",RefSort(SimpleSort("l_"))),Arg("n46_",GenericSort("IY_O",[SimpleSort("F")]))],Block([ScheduleNoFor(ThisCall("IY_O",[])),IfNoElse(FunctionRefCall(FunctionRef("q",[FunctionSort([],GenericSort("n46_",[SimpleSort("U2Xp95__52_"),SimpleSort("U2Xp95__52_")])),GenericSort("N__ABO7WFp8",[RefSort(SimpleSort("I"))])],[]),[TypedListCreation(FunctionSort([UnnamedArg(SimpleSort("l_"))],SimpleSort("H_271E")),[True])]),Block([]))])),InitAction(Block([Case(RenderTemplateFunctionCall(ValidationErrors("O_tH7_Kd72P")),[CaseAlt(Float("163.f"),Block([ScheduleNoFor(Call(RegexPattern(SingleBranch(Pieces([QuantifiedAtom(PositiveLookahead(SingleBranch(Pieces([QuantifiedAtom(LineStart,ReluctantOneOrMore)]))),PossessiveZeroOrMore),SingleAtom(PositiveLookbehind(SingleBranch(Pieces([QuantifiedAtom(AtomCharacter(Newline),PossessiveZeroOrMore)]))))]))),"n46_",[True]))])),CaseAlt(Long("-55L"),Block([ForCountS
 tmt("pM_7c_",LargerThan(EventCall("d_Wc5",[]),ExternalScopeVar("T")),ValidateTemplateFunctionCall(TemplateCall("W_1p5__n1f",[],[PropertySubmit("onkeyup",ActionCall("d_Wc5",[])),PropertyAssignment("u2V25U__SoC",GlobalVar("Q"))],TemplateBody([RequestScopeTemplate(VarDeclInit("q",SimpleSort("F"),EventCall("F",[])))]))),Block([ReturnEmpty])),ValidateStatement(SmallerThanOrEqual(True,SetCreation([])),And(SetCreation([]),SetCreation([OrForExp(ForExpNoFilter(Var("N__ABO7WFp8"),"yU_NK__",FunctionSort([],SimpleSort("d_Wc5")),MapCreation([]))),Add(True,True)])))]))]),AjaxStatement(AjaxRelocate(PageCall("n46_",[Highlight(True,SendEmailFunctionCall(EmailCall("pM_7c_",[])),"FY3_E__46P_.O_52_.wDC5fR_wy43")])))])),DefinePage([],"root",[],None([]),[])],[AccessControlDefinition([],[Predicate("I",[],SetCreation([ExternalScopeVar("F"),And(True,True)]))])])
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/program.app	Mon May 21 12:14:13 2012	(r24842)
@@ -0,0 +1,91 @@
+application T.pM_7c_.yU_NK__
+
+action true u2V25U__SoC ( n46_ : Ref<l_>, n46_ : IY_O<F> )
+{
+  schedule
+  IY_O()
+  if ( function.q(function():n46_<U2Xp95__52_,U2Xp95__52_>,N__ABO7WFp8<Ref<I>>):(List<function ( l_ ) : H_271E>(true)) )
+  {
+  }
+}
+
+init
+{
+  case ( rendertemplate ( validationErrors ( O_tH7_Kd72P ) ) ) {
+    163.f
+    {
+      schedule
+      /(?=^+?)*+(?<=\n*+)/.n46_(true)
+    }
+    -55L
+    {
+      for
+      (
+      pM_7c_
+      :
+      Int
+      from
+      event
+      (
+      d_Wc5
+      ,
+      [
+      ]
+      )
+      >
+      externalscope
+      .
+      T
+      to
+      validatetemplate
+      (
+      W_1p5__n1f()[onkeyup:d_Wc5(), u2V25U__SoC := global.Q]{
+        request
+        var q : F := event ( F , [ ] ) ;
+      }
+      )
+      )
+      {
+        return ;
+      }
+      validate
+      (
+      true
+      <=
+      {}
+      ,
+      {}
+      &&
+      {Or[ N__ABO7WFp8 | yU_NK__ : function ( ) : d_Wc5 in [
+                                                           ] ], true + true}
+      )
+      ;
+    }
+  }
+  relocate
+  (
+  n46_(highlight true for sendemail ( pM_7c_ ( ) ) on FY3_E__46P_.O_52_.wDC5fR_wy43)
+  )
+  ;
+}
+
+page
+
+root
+
+(
+
+)
+
+{
+
+}
+
+access control rules
+  predicate
+  I
+  (
+  )
+  {
+  {externalscope.F, true && true}
+  }
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/y_31740crashed/strategyResult.txt	Mon May 21 12:14:13 2012	(r24842)
@@ -0,0 +1,62 @@
+
+Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	rename_top_0_0
+	log_time_1_1
+	map_toplevel_2_0
+	alltd_1_0
+	map_1_0
+	with_toplevel_name_1_0
+	with_toplevel_name_1_1
+	dr_scope_1_1
+	rename_all_0_0
+	with_origin_1_1
+	alltd_1_0
+	rename_0_0
+	rename_0_0
+	rename_ui_0_0
+	rename_ui_0_0_fragment_2
+	dr_scope_1_1
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'rename-ui'
+           Define([Page],"root",[],None([]),[]){TopLevelName("topdef6")}Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze3_0_0
+	editor_analyze3_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	rename_top_0_0
+	log_time_1_1
+	map_toplevel_2_0
+	alltd_1_0
+	map_1_0
+	with_toplevel_name_1_0
+	with_toplevel_name_1_1
+	dr_scope_1_1
+	rename_all_0_0
+	with_origin_1_1
+	alltd_1_0
+	rename_0_0
+	rename_0_0
+	rename_ui_0_0
+	rename_ui_0_0_fragment_2
+	dr_scope_1_1
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'rename-ui'
+           Define([Page],"root",[],None([]),[]){TopLevelName("topdef6")}
\ No newline at end of file

From andre.s.d.vieira at gmail.com  Mon May 21 14:50:06 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Mon, 21 May 2012 12:50:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24843 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed
Message-ID: <20120521125006.73846108C006@mx3.tudelft.nl>

Author: AndreVieira
Date: Mon May 21 12:50:04 2012
New Revision: 24843
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24843&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/AST.aterm	Mon May 21 12:50:04 2012	(r24843)
@@ -0,0 +1 @@
+Application("it__4",[ACPolicy(PolicyAnd(Name("S"),Name("s77M8_"))),Section("rootFixSection",DefinePage([],"root",[],None,[]))])
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/program.app	Mon May 21 12:50:04 2012	(r24843)
@@ -0,0 +1,27 @@
+application it__4
+
+access
+
+control
+
+policy
+
+S
+
+AND
+
+s77M8_
+
+section rootFixSection .
+
+  page
+
+  root
+
+  (
+
+  )
+
+  {
+
+  }
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/c_19842crashed/strategyResult.txt	Mon May 21 12:50:04 2012	(r24843)
@@ -0,0 +1,52 @@
+
+Analyzing: TestFolder2/program.app
+rename: 0.000 s
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	catch_errors_editor_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	constraint_error_all_0_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	try_1_0
+	constraint_error_0_0
+	constraint_error_ui_0_0
+	filter_1_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'constraint-error-ui'
+           Section("rootFixSection",DefinePage([],"root",[],None,[]))Analyzing: TestFolder2/program.app
+rename: 0.000 s
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	catch_errors_editor_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	constraint_error_all_0_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	try_1_0
+	constraint_error_0_0
+	constraint_error_ui_0_0
+	filter_1_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'constraint-error-ui'
+           Section("rootFixSection",DefinePage([],"root",[],None,[]))
\ No newline at end of file

From chrismelman at hotmail.com  Tue May 22 13:20:08 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Tue, 22 May 2012 11:20:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24844 - hydra
Message-ID: <20120522112008.8B4BACC0E3@mx4.tudelft.nl>

Author: ChrisMelman
Date: Tue May 22 11:20:08 2012
New Revision: 24844
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24844&sc=1

Log:
a try to get the log to the output

Modified:
   hydra/spoofax-fun.nix

Modified: hydra/spoofax-fun.nix
==============================================================================
--- hydra/spoofax-fun.nix	Mon May 21 12:50:04 2012	(r24843)
+++ hydra/spoofax-fun.nix	Tue May 22 11:20:08 2012	(r24844)
@@ -149,6 +149,7 @@
     tar cvzf $out/${name}.tar.gz site        
     echo "file tar $out/${name}.tar.gz" >> $out/nix-support/hydra-build-products
     echo "file site $out/site" >> $out/nix-support/hydra-build-products
+    echo "file txt mobl/log.txt" >>  $out/nix-support/hydra-build-products
   '';
           
   __noChroot = true;

From gabrielkonat at gmail.com  Tue May 22 14:04:10 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 22 May 2012 12:04:10 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24845 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120522120410.4E44D2B801F@mx2.tudelft.nl>

Author: gkonat
Date: Tue May 22 12:04:08 2012
New Revision: 24845
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24845&sc=1

Log:
Updated generated index files.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May 22 11:20:08 2012	(r24844)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May 22 12:04:08 2012	(r24845)
@@ -101,6 +101,9 @@
   Global : List(UriPart) -> Summary
   Global : List(UriPart) * List(Summary) -> Summary
   
+  // None namespace
+  None   : Namespace
+  
 rules // Index management
    
   /**
@@ -678,25 +681,62 @@
    * Converts a file ((file, subfile) tuple) to a string.
    *
    * Example:
-   *   <index-file-to-string> (\"fullpath/file.ext\", \"\") => \"fullpath/file.ext\"
+   *   <index-file-to-string> (\"fullpath/file.ext\", []) => \"fullpath/file.ext\"
    *
-   * @type (file, \"\") -> file
+   * @type (file, []) -> file
    */
   index-file-to-string:
-    (file, \"\") -> file
+    (file, []) -> file
     
   /**
    * Converts a file ((file, subfile) tuple) to a string.
    *
    * Example:
-   *   <index-file-to-string> (\"fullpath/file.ext\", \"subfile\") => \"fullpath/file.ext at subfile\"
+   *   <index-file-to-string> (\"fullpath/file.ext\", [Entity(), \"Foo\" \"Bar\"]) => \"fullpath/file.ext at Entity://Foo.Bar\"
    *
    * @type (file, subfile) -> str
    */
   index-file-to-string:
-    (file, subfile) -> <concat-strings> [file, \"@\", subfile]
+    (file, subfile) -> <concat-strings> [file, \"@\", <index-uri-to-string> subfile]
+    where
+      not([] := subfile)
+
+  /**
+   * Converts a file to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> \"fullpath/file.ext\" => [None(), \"fullpath/file.ext\"]
+   *
+   * @type file -> uri
+   */      
+  index-file-to-uri:
+    file -> [None(), file]
+    where
+      not(<is-tuple> file)
+      
+  /**
+   * Converts a file ((file, subfile) tuple) to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> (\"fullpath/file.ext\", []) => [None(), \"fullpath/file.ext]
+   *
+   * @type (file, subfile) -> uri
+   */      
+  index-file-to-uri:
+    (file, []) -> [None(), file]
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> (\"fullpath/file.ext\", [Entity(), \"Foo\" \"Bar\"]) => [Entity(), \"Foo\", \"Bar\", \"fullpath/file.ext\"]
+   *
+   * @type (file, subfile) -> uri
+   */      
+  index-file-to-uri:
+    (file, subfile) -> <conc> ([file], subfile)
     where
-      not(\"\" := subfile)
+      not([] := subfile)
       
 /** @internal */
 rules // URI and value projections
@@ -917,7 +957,7 @@
           <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
       else
         Results(ast', _, _, _, _, _, filesToAnalyze) := 
-          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, \"\"))]
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, []))]
       end
   
 rules // Parallel analysis
@@ -1446,7 +1486,7 @@
   analyze-top-store-ast:
     (ast, file) -> <id>
     with
-      <index-set-global(|[<index-file-to-string> file, \"ast\"])> ast
+      <index-set-global(|<conc> (<index-file-to-uri> file, [\"ast\"]))> ast
       
   /**
    * Identifies all definitions in the tree and annotates them with their URI.
@@ -1678,6 +1718,14 @@
       // Files to analyze
       analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
       analyzeFiles' := analyzeFiles;
+      // TODO: Is this extra check needed?
+      /*if <getfirst(index-get-file-revision; \\r -> (r, revision)\\; gt)> analyzeFiles then
+        // Add current file if the current file has read information from another file with a higher revision.
+        // This indicates that potentially outdated information was read.
+        analyzeFiles' := [file|analyzeFiles]
+      else
+        analyzeFiles' := analyzeFiles
+      end;*/
       
       // Files to compile
       changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
@@ -1693,7 +1741,7 @@
   analyze-astdiff:
     (ast, file) -> file
     where
-      name := [<index-file-to-string> file, \"ast-checksum\"];
+      name := <conc> (<index-file-to-uri> file, [\"ast-checksum\"]);
       newChecksum := <checksum> ast;
       if oldChecksum := <index-get-global(|name)> then
         <index-set-global(|name)> newChecksum;
@@ -1914,9 +1962,7 @@
   
   /** @internal */
   ast-uri-to-ast-file(|full-path):
-    (ast, uri) -> (ast, (full-path, uriStr))
-    with
-      (<index-uri-to-string> uri <+ !\"\") => uriStr
+    (ast, uri) -> (ast, (full-path, uri))
   
   /** @internal */     
   index-is-name-substring(|name):
@@ -2107,23 +2153,19 @@
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> <debug(!\"Files to compile: \")> filteredFiles
 
   /** @internal */
   index-compilation-file(|language, project-path):
     (path, subfile) -> None()
     with
-      // Parse and analyze ast.
-      ast                              := <parse-file> path;
-      ast'                             := <try(index-desugar-ast)> ast;
-      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
-    with
+      ast := <index-get-global(|<conc> (<index-file-to-uri> (path, subfile), [\"ast\"]))>;
       {| Index-ReadSet:
         readSet := <new-iset>;
         rules(Index-ReadSet: _ -> readSet);
         
         // Compile file
-        <try(index-compile-ast(|path, subfile))> ast'';
+        <try(index-compile-ast(|path, subfile))> ast;
         
         // Store compile-time reads.
         reads := <iset-elements> readSet;
@@ -2157,7 +2199,7 @@
    * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
    * enable-commit-and-compile is called.
    *
-   * @type language -> ?language
+   * @type language -> language
    *
    * @see enable-commit-and-compile
    * @see disable-commit-and-compile
@@ -2182,10 +2224,10 @@
     index-enable-global(|\"delay-compile\")
   
   /**
-   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
-   * is triggered now.
+   * Cancels the commit and compilation delay, requires target language as current term. 
+   * If commit and compilation was triggered during the delay, it is triggered now.
    *
-   * @type x -> x
+   * @type language -> language
    *
    * @see disable-commit-and-compile
    */

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May 22 11:20:08 2012	(r24844)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May 22 12:04:08 2012	(r24845)
@@ -121,7 +121,7 @@
    * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
    * enable-commit-and-compile is called.
    *
-   * @type language -> ?language
+   * @type language -> language
    *
    * @see enable-commit-and-compile
    * @see disable-commit-and-compile
@@ -146,10 +146,10 @@
     index-enable-global(|"delay-compile")
   
   /**
-   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
-   * is triggered now.
+   * Cancels the commit and compilation delay, requires target language as current term. 
+   * If commit and compilation was triggered during the delay, it is triggered now.
    *
-   * @type x -> x
+   * @type language -> language
    *
    * @see disable-commit-and-compile
    */

From gabrielkonat at gmail.com  Tue May 22 14:43:46 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 22 May 2012 12:43:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24846 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services
Message-ID: <20120522124346.163382B8005@mx2.tudelft.nl>

Author: gkonat
Date: Tue May 22 12:43:44 2012
New Revision: 24846
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24846&sc=1

Log:
Added index debugging builders to generated spoofax project.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	Tue May 22 12:04:08 2012	(r24845)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	Tue May 22 12:43:44 2012	(r24846)
@@ -35,15 +35,16 @@
           builder: "Generate Java code (for selection)"            = generate-java  (openeditor) (realtime)
           builder: "Show abstract syntax (for selection)"          = generate-aterm (openeditor) (realtime) (meta) (source)
           builder: "Show analyzed abstract syntax (for selection)" = generate-analyzed (openeditor) (realtime) (meta) (source)
+          builder: "Show index entries for current file"           = index-currentfile (openeditor) (realtime) (meta) (source)
+          builder: "Show index entries for all files"              = index-allfiles (openeditor) (realtime) (meta) (source)
+          builder: "Clear index"                                   = index-cleanall (meta) (source)
           ~~
-           
         refactorings
           pretty-print: ~pp-strategy
           refactoring ID: "Rename Entity" = rename-entity (source) (cursor)
           shortcut: "org.eclipse.jdt.ui.edit.text.java.rename.element"
           input
           	identifier: "new name" = ""
-          ~~
           on save: editor-save
       ]|
     );

From gabrielkonat at gmail.com  Tue May 22 15:44:18 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 22 May 2012 13:44:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24847 - in
	spoofax-imp/trunk: org.strategoxt.imp.editors.sdf/trans
	org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <20120522134418.6BFA0CC137@mx4.tudelft.nl>

Author: gkonat
Date: Tue May 22 13:44:16 2012
New Revision: 24847
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24847&sc=1

Log:
Add editor-common.generated import to SDF name annotations generated stratego file.
Fix missing import in generated check.str.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Tue May 22 12:43:44 2012	(r24846)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Tue May 22 13:44:16 2012	(r24847)
@@ -60,9 +60,9 @@
   
   language-imports =
     if lang := <spt-get-default-language> then
-      !Imports([Import($[include/[lang]])])
+      !Imports([Import("lib/editor-common.generated"), Import($[include/[lang]])])
     else
-      !Imports([])
+      !Imports([Import("lib/editor-common.generated")])
     end
   
   spt-get-default-language =

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	Tue May 22 12:43:44 2012	(r24846)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	Tue May 22 13:44:16 2012	(r24847)
@@ -196,8 +196,7 @@
       writePath := $[[full-path]/];
       writeFile :=  $[[writePath][filename]];
       try(<mkdir> writePath);
-      <fclose> <fputs> (java, <fopen> (writeFile, "w"));
-      <debug> $[Compiling to [writeFile]]
+      <fclose> <fputs> (java, <fopen> (writeFile, "w"))
 
 rules // Transformation to java strings.
 
@@ -254,6 +253,7 @@
   lib/analysis-auto.generated
   lib/index-library.generated
   lib/analysis-library.generated
+  lib/analysis-library-internal.generated
 
 rules // Resolving
   
@@ -295,6 +295,7 @@
   lib/analysis-auto.generated
   lib/index-library.generated
   lib/analysis-library.generated
+  lib/analysis-library-internal.generated
 
 rules // Adjust lookup
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May 22 12:43:44 2012	(r24846)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May 22 13:44:16 2012	(r24847)
@@ -2153,7 +2153,7 @@
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> <debug(!\"Files to compile: \")> filteredFiles
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
 
   /** @internal */
   index-compilation-file(|language, project-path):

From gabrielkonat at gmail.com  Tue May 22 15:59:17 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 22 May 2012 13:59:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24848 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib
Message-ID: <20120522135917.E4DCACC142@mx4.tudelft.nl>

Author: gkonat
Date: Tue May 22 13:59:17 2012
New Revision: 24848
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24848&sc=1

Log:
Added try to index-transaction to ensure that transactions end even if the given strategy fails.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May 22 13:44:16 2012	(r24847)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-index-libraries.str	Tue May 22 13:59:17 2012	(r24848)
@@ -251,14 +251,14 @@
    * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
    * strategy are thread safe.
    * 
-   * @param s The strategy to apply.
+   * @param s The strategy to apply. Transaction will still properly end if strategy fails.
    * @type x -> x'
    *
    * @see index-start-transaction
    * @see index-end-transaction
    */
   index-transaction(s) = 
-    prim(\"LANG_index_start_transaction\"); s; prim(\"LANG_index_end_transaction\")
+    prim(\"LANG_index_start_transaction\"); try(s); prim(\"LANG_index_end_transaction\")
   
 rules // Index querying
   

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May 22 13:44:16 2012	(r24847)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/compilation-library.str	Tue May 22 13:59:17 2012	(r24848)
@@ -75,7 +75,7 @@
       <set-total-work-units> <length> filteredFiles;
       
       // Compile the files
-      <filter(index-compilation-file(|language, project-path); complete-work-unit)> <debug(!"Files to compile: ")> filteredFiles
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
 
   /** @internal */
   index-compilation-file(|language, project-path):

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May 22 13:44:16 2012	(r24847)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.language/src/main/stratego/lib/index-library.str	Tue May 22 13:59:17 2012	(r24848)
@@ -177,14 +177,14 @@
    * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
    * strategy are thread safe.
    * 
-   * @param s The strategy to apply.
+   * @param s The strategy to apply. Transaction will still properly end if strategy fails.
    * @type x -> x'
    *
    * @see index-start-transaction
    * @see index-end-transaction
    */
   index-transaction(s) = 
-    prim("LANG_index_start_transaction"); s; prim("LANG_index_end_transaction")
+    prim("LANG_index_start_transaction"); try(s); prim("LANG_index_end_transaction")
   
 rules // Index querying
   

From gabrielkonat at gmail.com  Tue May 22 16:18:26 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 22 May 2012 14:18:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24849 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <20120522141826.B5297CC083@mx4.tudelft.nl>

Author: gkonat
Date: Tue May 22 14:18:26 2012
New Revision: 24849
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24849&sc=1

Log:


Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str	Tue May 22 13:59:17 2012	(r24848)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-common-trans.str	Tue May 22 14:18:26 2012	(r24849)
@@ -241,6 +241,9 @@
   Entity   : ID * List(Property) -> Entity
   Property : ID * Type           -> Property
   Type     : ID                  -> Type
+  
+  Type     : Namespace
+  Property : Namespace
 
 strategies
   

From oskarvanrest at gmail.com  Wed May 23 04:38:35 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 23 May 2012 02:38:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24850 - in
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf:
	. trans
Message-ID: <20120523023835.0D45ACC108@mx4.tudelft.nl>

Author: OskarVanRest
Date: Wed May 23 02:38:33 2012
New Revision: 24850
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24850&sc=1

Log:
Merged with trunk

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/   (props changed)
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Tue May 22 14:18:26 2012	(r24849)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Wed May 23 02:38:33 2012	(r24850)
@@ -60,9 +60,9 @@
   
   language-imports =
     if lang := <spt-get-default-language> then
-      !Imports([Import($[include/[lang]])])
+      !Imports([Import("lib/editor-common.generated"), Import($[include/[lang]])])
     else
-      !Imports([])
+      !Imports([Import("lib/editor-common.generated")])
     end
   
   spt-get-default-language =

From oskarvanrest at gmail.com  Wed May 23 07:01:20 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 23 May 2012 05:01:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24851 - in
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf:
	lib test/emf trans/emf
Message-ID: <20120523050120.E8C442B8045@mx2.tudelft.nl>

Author: OskarVanRest
Date: Wed May 23 05:01:19 2012
New Revision: 24851
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24851&sc=1

Log:
Big refactor

Added:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/Common.sdf
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf
Deleted:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/lib/namespacelib.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/BehaviorTrees.sdf
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/entity-lang.sdf
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/map.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/namespaces.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/projections.str
Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/main.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str

Added: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/Common.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/Common.sdf	Wed May 23 05:01:19 2012	(r24851)
@@ -0,0 +1,46 @@
+module Common
+
+exports
+
+  lexical syntax
+  
+    [a-zA-Z][a-zA-Z0-9]* -> ID
+    "-"? [0-9]+          -> INT
+    
+    "\"" StringChar* "\"" -> STRING
+    ~[\"\n]               -> StringChar
+    "\\\""                -> StringChar
+    BackSlashChar         -> StringChar
+    "\\"                  -> BackSlashChar
+    
+    [\ \t\n\r] -> LAYOUT
+    
+    [\*]                             -> CommentChar
+    "/*" (~[\*] | CommentChar)* "*/" -> LAYOUT
+    "//" ~[\n\r]* ([\n\r] | EOF)     -> LAYOUT
+    
+    -> EOF
+  
+  lexical restrictions
+  
+    %% Ensure greedy matching for lexicals
+  
+    CommentChar   -/- [\/]
+    INT           -/- [0-9]
+    ID            -/- [a-zA-Z0-9\_]
+    
+    %% EOF may not be followed by any char
+    
+    EOF           -/- ~[]
+
+    %% Backslash chars in strings may not be followed by " 
+    
+    BackSlashChar -/- [\"]
+
+  context-free restrictions
+  
+    %% Ensure greedy matching for comments
+
+    LAYOUT? -/- [\ \t\n\r]
+    LAYOUT? -/- [\/].[\/]
+    LAYOUT? -/- [\/].[\*]

Added: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf	Wed May 23 05:01:19 2012	(r24851)
@@ -0,0 +1,17 @@
+%% Grammar for the EntityLang language
+%% By default, based on an example "entities" syntax
+module EntityLang
+
+imports Common
+
+exports
+
+  context-free start-symbols
+  
+    Start
+
+  context-free syntax
+
+    "module" Module@=ID Type*				-> Start {"Module", scope(Type)}
+    "entity" Type@=ID "{" Property* "}"		-> Type {"Entity", scope(Property)}
+    Property@=ID ":" Type at Type				-> Property {"Property"}

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/main.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/main.str	Wed May 23 02:38:33 2012	(r24850)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/main.str	Wed May 23 05:01:19 2012	(r24851)
@@ -4,12 +4,11 @@
 	trans/emf/sdf-to-ecore
 	trans/emf/ecore-to-xml
 	trans/emf/pp-xml
-	trans/emf/map
 
 rules
-	spx-to-xml-stage1 = map-all; sdf-to-ecore
-	spx-to-xml-stage2 = map-all; sdf-to-ecore; ecore-to-xml
-	spx-to-xml-stage3 = map-all; sdf-to-ecore; ecore-to-xml; pp-xml
+	spx-to-xml-stage1 = sdf-to-ecore
+	spx-to-xml-stage2 = sdf-to-ecore; ecore-to-xml
+	spx-to-xml-stage3 = sdf-to-ecore; ecore-to-xml; pp-xml
 
 
       

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Wed May 23 02:38:33 2012	(r24850)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Wed May 23 05:01:19 2012	(r24851)
@@ -3,149 +3,96 @@
 imports
 	include/SDF
 	lib/ecore-signatures
-	lib/namespacelib
-	emf/namespaces
-	emf/projections
 	
 strategies
-	sdf-to-ecore = topdown(try(remove-textual-sugar)); topdown(try(to-ecore)); create-superclasses; collapse-classes; topdown(try(remove-textual-sugar))
+	
+	sdf-to-ecore = to-ecore
 
 rules
+	
 	to-ecore:
-		'module(unparameterized(moduleName), _, exports*)	-> EPackage(properties, children)
+		'module(unparameterized(moduleName), _, exports*)	-> EPackage(properties, classes')
 	where
 		properties := [Name(moduleName)];
-		children := <collect-om(?prod(_, _, _))> <collect-om(?context-free-syntax(_))> exports*
-
-	to-ecore:
-		prod(lhs, sort, attrs(attributes)) -> EClass(properties, children)
-		where 
-			constructor := <getfirst(?Constructor(_))> attributes;
-			classname := <to-unique-classname> (sort, constructor);
-			name := Name(classname);
-			properties := <try(add-super-type(|sort))> [name];
-			children := <remove-all(?lit(_) + ?ci-lit(_))> lhs	
-			
-	to-ecore:
-		sort(primitiveType) -> EAttribute(properties)
-		where 
-			name := Name(<first-char-to-lowercase> primitiveType);
-			type := Type(<type-to-ecore> primitiveType);
-			properties := [name, type]
+		productions := <collect-om(?prod(_, _, _))> <collect-om(?context-free-syntax(_))> exports*;
+		classes := <map(to-ecore)> productions;
+		superclasses := <create-superclasses> productions;
+		classes' := <remove-all(?[])> <conc>(classes, superclasses)
+
+	to-ecore:
+		prod(lhs, sort(s), attributes) -> EClass(properties, structuralFeatures')
+		where
+			cons := <get-constr> attributes;
+			name := Name(cons);
+			if <eq> (s, cons) then eSuperType := [] else eSuperType := ESuperType(s) end;
+			properties := <remove-all(?[])> [name, eSuperType];
+			structuralFeatures := <remove-all(?lit(_) + ?ci-lit(_))> lhs;
+			structuralFeatures' := <map(set-containment; set-bounds; set-structuralFeature)> structuralFeatures
 
-	to-ecore:
-		namespacedef(_, sort(primitiveType)) -> EAttribute(properties)
-		where 
-			name := Name("identifier");
-			type := Type(<type-to-ecore> primitiveType);
-			properties := [name, type]
+	set-containment:
+		namespacedef(_, sort) -> (sort, [Containment(True())])
 
-	// to-ecore:
-	// 	namespacedef(_, x) -> EReference(properties')
-	// 	where 
-	// 		properties := <get-properties> x;
-	// 		properties' := <map((Name(_) -> Name("name2")) <+ id)> properties
-	
-	// containment = true 
-	to-ecore:
-		x -> EReference(properties)
-		where
-			properties := <get-properties> x
-
-	containment = false
-	to-ecore:
-		namespaceref2(namespace, _) ->  EReference(properties)
-		where
-			type := <project-declaration(get-constr|Namespacedef())> namespace;
-			name := Name(<first-char-to-lowercase> namespace);
-			type' := Type(type);
-			containment := Containment(False());
-			properties := [name, type', containment]
-
-	//TODO: extract these from lexical syntax
-	type-to-ecore:
-		"ID" -> EString()
+	set-containment:
+		namespaceref2(_, sort) -> (sort, [Containment(False())])
 		
-	type-to-ecore:
-		"INT" -> EInt()
-
+	set-containment:
+		sort -> (sort, [Containment(True())])
+			where
+				not ( <?namespacedef(_, _)> sort + <?namespaceref2(_, _)> sort)
+
+	set-bounds:
+		(sort(s), properties) -> (s, properties')
+		where
+			properties' := <conc> (properties, [LowerBound(1), UpperBound(1)])
+
+	set-bounds:
+		(iter(sort(s)), properties) -> (s, properties')
+		where
+			properties' := <conc> (properties, [LowerBound(1), UpperBound(-1)])
+	
+	set-bounds:
+		(iter-star(sort(s)), properties) -> (s, properties')
+		where
+			properties' := <conc> (properties, [LowerBound(0), UpperBound(-1)])
+	
+	set-structuralFeature:
+		(s, properties) -> eStructuralFeature
+		where
+			name := Name(<first-char-to-lowercase> s);
+			if
+				<int-or-string> s
+			then
+				type := Type(<int-or-string> s);
+				properties' := <conc> (properties, [name, type]);
+				properties'' := <remove-all(?Containment(_))> properties';
+				eStructuralFeature := EAttribute(properties'')
+			else
+				type := Type(s);
+				properties'' := <conc> (properties, [name, type]);
+				eStructuralFeature := EReference(properties'')
+			end
 
-	type-to-ecore:
-		"StateID" -> EString()
-	type-to-ecore:
-		"OpLabel" -> EString()
-	type-to-ecore:
-		"Value" -> EString()
+	int-or-string:
+		"INT" -> EInt()
+		
+	int-or-string:
+		"ID" -> EString()
 
 rules
 	
-	add-super-type(|sort):
-		properties -> properties'
-		where
-			s := <get-sort> sort;
-			not ( <get-unique-declaration(|Sort())> s );
-			properties' := <conc> (properties, [ESuperType(s)])
-			
-	to-unique-classname:
-		(sort(s), Constructor(c)) -> constructor
-		where
-			constructor := <un-double-quote> c
+	create-superclasses:
+		productions -> classes
 		where
-			<get-unique-declaration(|Sort())> s
-			+ not ( <equal> (s, constructor) )
+			classes := <make-set> <filter(create-superclass)> productions
 			
-	to-unique-classname:
-		(sort(s), Constructor(c)) -> <concat-strings> [constructor, "_", <new>]
-		where
-			constructor := <un-double-quote> c;
-			not ( <get-unique-declaration(|Sort())> s );
-			<equal> (s, constructor)
-
-	get-properties:
-		opt(x) -> properties'
-		where
-			properties := <get-properties> x;
-			properties' := <map((LowerBound(1) -> LowerBound(0)) <+ id)> properties
-
-	get-properties:
-		sort(s) -> [Name(name), Type(type), LowerBound(1), UpperBound(1), Containment(containment)]
-		where
-			name := <first-char-to-lowercase> s;
-			type := <get-type> s;
-			containment := <containment> s
-	get-properties:
-		iter(sort(s)) -> [Name(name), Type(type), LowerBound(1), UpperBound(-1), Containment(containment)]
-		where
-			name := <first-char-to-lowercase> s;
-			type := <get-type> s;
-			containment := <containment> s
-	get-properties:
-		iter-star(sort(s)) -> [Name(name), Type(type), LowerBound(0), UpperBound(-1), Containment(containment)]
+	create-superclass:
+		prod(_, sort(s), attributes) -> EClass([Name(s)], [])
 		where
-			name := <make-plural> <first-char-to-lowercase> s;
-			type := <get-type> s;
-			containment := <containment> s
+			cons := <get-constr> attributes;
+			not ( <eq> (s, cons) )
 			
-	get-type:
-		s -> type
-		where 
-			<get-unique-declaration(|Sort())> s;
-			type := <project-declaration(get-constr|Sort())> s
-
-	get-type:  // super type
-		s -> s
-		where 
-			<get-declaration(|Sort())> s;
-			not ( <get-unique-declaration(|Sort())> s )
-
-	get-type:
-		s -> type
-		where 
-			not ( <get-declaration(|Sort())> s );
-			type := EString() //TODO make EInt, EFloat or EString of this depending on the lexical syntax
-
-
-rules
+	
+rules // Utils
 
 	first-char-to-lowercase:
 		string -> string'	
@@ -157,127 +104,17 @@
 	make-plural:
 		string -> string'
 		where
-			not ( <string-ends-with(|"y")> string );
-			string' := <conc-strings> (string, "s")
-			
-	make-plural:
-		string -> string'
-		where
-			<string-ends-with(|"y")> string;
-			init := <implode-string> <init> <explode-string> string;
-			string' := <conc-strings> (init, "ies")
-
-	add-dot:
-		string -> <conc-strings> (string, ".")
-
-
-rules
-	
-	containment:
-		namespaceref2(_, _) -> False()
-			
-	containment:
-		sort -> False()
-		where
-			<sort-has-refs> sort;
-			not ( <sort-has-defs> sort )
-			
-	containment:
-		sort -> True()
-		where not ( 
-			<sort-has-refs> sort;
-			not ( <sort-has-defs> sort )
-		 )
-		
-	sort-has-refs:
-		sort -> sort
-		where
-			productions := <get-declarations(|Sort())> sort;
-			<oncetd(?namespaceref2(_, _))> productions
-
-	sort-has-defs:
-		sort -> sort
-		where
-			productions := <get-declarations(|Sort())> sort;
-			<oncetd(?namespacedef(_, _))> productions
-
-rules
-
-	create-superclasses:
-		EPackage(properties, classes) -> EPackage(properties, classes')
-		where
-			non-unique-sorts := <make-set> <remove-all(get-unique-declaration(|Sort()))> <project-all-declarations(get-sort|Sort())>;
-			super-classes := <map(create-superclass)> non-unique-sorts;
-			classes' := <conc> (classes, super-classes)
+			if
+				<string-ends-with(|"y")> string
+			then 
+				init := <implode-string> <init> <explode-string> string;
+				string' := <conc-strings> (init, "ies")
+			else
+				string' := <conc-strings> (string, "s")
+			end
 			
-	create-superclass:
-		sort ->  EClass(properties, children)
-		where
-			name := Name(sort);
-			abstract := Abstract(True());
-			properties := [name, abstract];
-			children := []			
-			
-rules
-	
-	collapse-classes:
-		EPackage(properties, classes) -> EPackage(properties, classes'')
-		where
-			classes-with-one-ref := <filter(?EClass(_, [EReference(_)]))> classes; //TODO: only take classes that extend another class
-			classes' := <diff> (classes, classes-with-one-ref);			
-			classes'' := <map(collapse-class(|classes-with-one-ref) <+ id)> classes'
-		
-	collapse-class(|classes-with-one-ref):
-		EClass(properties, children) -> EClass(properties', children)
-		where
-			<fetch(?Name(constructor))> properties;
-			namespacedef := <project-declaration(get-namespacedef|Constructor())> constructor;
-			class := <fetch-elem(collapse-class(|constructor))> classes-with-one-ref;
-			eSuperType := <get-eSuperType> class;
-			properties' := <conc> (properties, [ESuperType(eSuperType)])
-	
-	collapse-class(|sort):
-		c at EClass(_, [eReference]) -> c
+	get-constr:
+		attrs(attributes) -> cons
 		where
-			namespaceref := <get-reference-type> eReference;
-			<equal> (sort, namespaceref)
-		
-rules
-	
-	remove-textual-sugar:
-		context-free-syntax(productions)	-> context-free-syntax(productions')
-		where
-			productions' := <remove-all(?prod([sort(x)], _, _))> productions;
-			<type-to-ecore> x
-	
-	remove-textual-sugar:
-		r at EReference(properties) -> EReference(properties')
-		where
-			refType := <get-reference-type> r;
-			prod([sort(type)], _, _) := <get-declaration(|Sort())> refType;
-			primType := <type-to-ecore> type;
-			properties' := <map(replace-type(|primType) <+ id)> properties			
-			
-	replace-type(|y):
-		Type(x) -> Type(y)
-		
-// rules
-// 	
-// 	collapse-classes2:
-// 		EPackage(name, classes) -> EPackage(name, classes')
-// 		where
-// 			to-be-collapsed := <map(get-reference-type)> <collect-om(collapse-class2)> classes;
-// 			classes' :=
-// 			
-// 	collapse-classes2:		
-// 		EClass(attributes, children) -> EClass(attributes, children')
-// 		where
-// 			children' := <remove-all(collapse-class2 <+ id)> children
-// 	
-// 	collapse-class2:
-// 		e at EReference(properties) -> e
-// 		where
-// 			<oncetd(?LowerBound(1))> properties;
-// 			<oncetd(?UpperBound(1))> properties;
-// 			<oncetd(?Containment(True()))> properties
-			
+			Constructor(c) := <getfirst(?Constructor(_))> attributes;
+			cons := <un-double-quote> c
\ No newline at end of file

From oskarvanrest at gmail.com  Wed May 23 07:04:41 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 23 May 2012 05:04:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24852 -
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf
Message-ID: <20120523050441.671C92B8045@mx2.tudelft.nl>

Author: OskarVanRest
Date: Wed May 23 05:04:41 2012
New Revision: 24852
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24852&sc=1

Log:
Don't put "Start" in the .ecore

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Wed May 23 05:01:19 2012	(r24851)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Wed May 23 05:04:41 2012	(r24852)
@@ -24,7 +24,7 @@
 		where
 			cons := <get-constr> attributes;
 			name := Name(cons);
-			if <eq> (s, cons) then eSuperType := [] else eSuperType := ESuperType(s) end;
+			if <eq> (s, cons) + <eq> (s, "Start") then eSuperType := [] else eSuperType := ESuperType(s) end;
 			properties := <remove-all(?[])> [name, eSuperType];
 			structuralFeatures := <remove-all(?lit(_) + ?ci-lit(_))> lhs;
 			structuralFeatures' := <map(set-containment; set-bounds; set-structuralFeature)> structuralFeatures
@@ -89,7 +89,8 @@
 		prod(_, sort(s), attributes) -> EClass([Name(s)], [])
 		where
 			cons := <get-constr> attributes;
-			not ( <eq> (s, cons) )
+			not ( <eq> (s, cons) );
+			not ( <eq> (s, "Start" ))
 			
 	
 rules // Utils

From chrismelman at hotmail.com  Wed May 23 10:56:06 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 08:56:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24853 - hydra/webdsl
Message-ID: <20120523085606.B6DAA2B800D@mx2.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 08:56:06 2012
New Revision: 24853
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24853&sc=1

Log:
adding test if installing of plugin works

Modified:
   hydra/webdsl/editor.nix

Modified: hydra/webdsl/editor.nix
==============================================================================
--- hydra/webdsl/editor.nix	Wed May 23 05:04:41 2012	(r24852)
+++ hydra/webdsl/editor.nix	Wed May 23 08:56:06 2012	(r24853)
@@ -25,7 +25,18 @@
         sed 's|@@webdsl@@|${webdslJava}|' webdsl.editor/import.webdsl.from-install-dir.properties > webdsl.editor/import.webdsl.properties
       '';
     };
-
+	  tests = {      
+	   	install = eclipseFun {        
+	   		name = "eclipse-webdsl-install-test";        
+	   		src =  pkgs.fetchurl {          
+	   			url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+	   			sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";        
+	   		};        
+	   		updatesites = [ "file://${jobs.updatesite}/site" ];        
+	   		installIUs = [ "org.webdsl.feature.feature.group" ];        
+	   		dontInstall = true;             
+	   	};          
+	  };
   };
 
 in jobs

From chrismelman at hotmail.com  Wed May 23 11:08:27 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 09:08:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24854 - hydra/webdsl
Message-ID: <20120523090827.E1905CC0F1@mx4.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 09:08:27 2012
New Revision: 24854
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24854&sc=1

Log:
change UI id to correct one of webdsl

Modified:
   hydra/webdsl/editor.nix

Modified: hydra/webdsl/editor.nix
==============================================================================
--- hydra/webdsl/editor.nix	Wed May 23 08:56:06 2012	(r24853)
+++ hydra/webdsl/editor.nix	Wed May 23 09:08:27 2012	(r24854)
@@ -33,7 +33,7 @@
 	   			sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";        
 	   		};        
 	   		updatesites = [ "file://${jobs.updatesite}/site" ];        
-	   		installIUs = [ "org.webdsl.feature.feature.group" ];        
+	   		installIUs = [ "webdsl.editor.feature.group" ];        
 	   		dontInstall = true;             
 	   	};          
 	  };

From chrismelman at hotmail.com  Wed May 23 11:38:04 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 09:38:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24855 - hydra/webdsl
Message-ID: <20120523093804.4CEC0CC102@mx4.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 09:38:04 2012
New Revision: 24855
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24855&sc=1

Log:
it seems that webdsl is a feature feature, whatever that means

Modified:
   hydra/webdsl/editor.nix

Modified: hydra/webdsl/editor.nix
==============================================================================
--- hydra/webdsl/editor.nix	Wed May 23 09:08:27 2012	(r24854)
+++ hydra/webdsl/editor.nix	Wed May 23 09:38:04 2012	(r24855)
@@ -33,7 +33,7 @@
 	   			sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";        
 	   		};        
 	   		updatesites = [ "file://${jobs.updatesite}/site" ];        
-	   		installIUs = [ "webdsl.editor.feature.group" ];        
+	   		installIUs = [ "webdsl.editor.feature.feature.group" ];        
 	   		dontInstall = true;             
 	   	};          
 	  };

From andre.s.d.vieira at gmail.com  Wed May 23 11:41:17 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Wed, 23 May 2012 09:41:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24856 - in
	spoofax-imp/branches/spoofax-testing-automation/include: . webdsl
Message-ID: <20120523094117.21C6B2B8046@mx2.tudelft.nl>

Author: AndreVieira
Date: Wed May 23 09:41:15 2012
New Revision: 24856
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24856&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/include/
   spoofax-imp/branches/spoofax-testing-automation/include/webdsl/
   spoofax-imp/branches/spoofax-testing-automation/include/webdsl/WebDSL-pretty2.pp

Added: spoofax-imp/branches/spoofax-testing-automation/include/webdsl/WebDSL-pretty2.pp
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/include/webdsl/WebDSL-pretty2.pp	Wed May 23 09:41:15 2012	(r24856)
@@ -0,0 +1,73 @@
+[
+	ServiceFunction 					-- V vs=1[H[KW["service"] _1 KW["("] _2 KW[")"] ] _3 ],
+	ServiceFunction.2:iter-star-sep     -- H hs=0[_1 KW[","]],
+	CollationAnno						-- H hs=0[KW["collation"]KW["("] _1 KW[")"]],
+	RecommendConfig						-- V vs=1[H[KW["recommend"] _1 KW["{"]] _2  KW["}"]],
+	RecommendConfig.2:iter-star			-- _1,
+	RecommendArgument					-- _1 KW["="] _2,
+	
+	DownloadLink						--	V vs=1[H[KW["downloadlink"] _1 KW["["] _2 KW[ "]"] KW["{"]] _3 KW["}"]],
+	DownloadLink.2:iter-star-sep		--	H hs=0[_1 KW[","]],
+	DownloadLink.3:iter-star			--	_1,
+	AllFacetResults						--	KW["get"] KW["all"] KW["facets"] KW["("] _1 KW[","] _2 KW[")"],
+	Highlight							--	KW["highlight"] _1 KW["for"] _2 KW["on"] _3,
+	EventCall							--  KW["event"] KW["("] _1 KW[","] KW["["] _2 KW["]"] KW[")"],                
+	EventCall.2:iter-star-sep			--  H hs=0[_1 KW[","]],
+	DeleteStatement						--  KW["delete"] _1 _2,
+	DeleteStatement.2:opt				--	_1,
+	PredicateInEntity					--	V vs=1[H[KW["predicate"] _1 KW["("] _2 KW[")"] KW["{"]] _3 KW["}"]],
+	PredicateInEntity.2:iter-star-sep	--	_1 KW[","],
+	IncompleteObjectPropertyAssignment	--	_1,
+	EventArg							--	_1 KW[":="] _2,
+	CachedEntity						--	KW["cache"],
+	RecommendConfigStaticOrder			--	V vs=1[H[KW["recommenderStaticOrder"] _1 KW["{"]] _2 _3 _4 _5 _6 _7 _8 _9 KW["}"]],
+	RecommendUser						--	_1,
+	RecommendItem						--	_1,
+	RecommendValue						--	_1,
+	RecommendAlgorithm					--	_1,
+	RecommendNeighborAlg				--	_1,
+	RecommendNeighborSize				--	_1,
+	RecommendType						--	_1,
+	RecommendSchedule					--	_1,
+	SuggestTerm							--	KW["matching"] _1 _2,
+	IndexAnno							-- KW["index"] KW["("] KW[")"],
+	IndexAnno							-- KW["index"] KW["("] _1 KW[")"],
+	SimpleAnno							-- _1,
+	InverseAnno							-- KW["inverse"] KW["="] _1 KW["."] _2,
+	IncompleteInverseAnno				-- KW["inverse"] KW["="] _1,   
+	InverseSlaveAnno					-- KW["inverseSlave"] KW["="] _1 KW["."] _2,
+	InlineAnno							-- KW["inline"] KW["("] _1 KW[")"],
+	InlineAnno.1:iter-star				-- _1 KW[","],
+	SelectAnno							-- KW["select"] KW["="] _1,
+	NotNullAnno							-- KW["not null"],
+	NotEmptyAnno						-- KW["not empty"],
+	AllowedAnno							-- KW["allowed"] KW["="] _1,
+	DefaultAnno							-- KW["default"] KW["="] _1,
+    LengthAnno							-- KW["length"] KW["="] _1,
+    FormatAnno							-- KW["format"] KW["="] _1,
+    IndexAnno							-- KW["index"] KW["("] KW[")"],
+    IndexAnno							-- KW["index"] KW["("] _1 KW[")"],
+    CollationAnno						-- KW["collation"] KW["("] _1 KW[")"],
+    IdErrorAnno							-- KW["iderror"] KW["="] _1,
+    IdEmptyErrorAnno					-- KW["idemptyerror"] KW["="] _1,
+    GroupDef							-- _1 KW["("] _2 KW[")"],
+    GroupDef.1:opt						-- _1,
+    GroupDef.2:iter-sep					-- H hs=0[_1 KW[","]], 
+   	TermDef								-- _1 _2 _3,
+   	TermDef.1:opt						-- _1,
+   	TermDef.3:opt						-- _1,
+    RangeDef							-- _1  KW["("] _2 KW["to"] _3 KW[")"],
+   	RangeDef.1:opt						-- _1,
+	Must								-- KW["+"],
+	MustNot								-- KW["-"],
+	IncompleteInverseAnno				-- KW["inverse"] KW["="] _1,
+	AjaxRefresh							-- KW["refresh"] KW["("] KW[")"],
+	None								-- _1,
+	FacetResults						-- KW["get"] KW["facets"] KW["("] _1 KW[","] _2 KW[")"],
+	FieldsConstraint					-- _1 KW[":"],
+	FieldsConstraint.1:iter-sep			-- _1 KW[","]	
+	
+	
+
+ ]
+ 

From chrismelman at hotmail.com  Wed May 23 11:53:40 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 09:53:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24857 - hydra/webdsl
Message-ID: <20120523095340.64FB8CC07F@mx4.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 09:53:40 2012
New Revision: 24857
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24857&sc=1

Log:
it needs some extra update sites and also newer version of eclipse to test is a good idea

Modified:
   hydra/webdsl/editor.nix

Modified: hydra/webdsl/editor.nix
==============================================================================
--- hydra/webdsl/editor.nix	Wed May 23 09:41:15 2012	(r24856)
+++ hydra/webdsl/editor.nix	Wed May 23 09:53:40 2012	(r24857)
@@ -29,10 +29,13 @@
 	   	install = eclipseFun {        
 	   		name = "eclipse-webdsl-install-test";        
 	   		src =  pkgs.fetchurl {          
-	   			url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
-	   			sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";        
+	   			url = http://download.springsource.com/release/ECLIPSE/indigo/SR2/eclipse-SDK-3.7.2-linux-gtk.tar.gz ;
+      			sha256 = "f2cce7db448fa1209452605a653d82b7db17a844a86ed3bdb07e265a483c56c7";
 	   		};        
-	   		updatesites = [ "file://${jobs.updatesite}/site" ];        
+	   		updatesites = [ 
+	   			"file://${jobs.updatesite}/site" 
+	   			"http://download.eclipse.org/releases/indigo"
+	   		];        
 	   		installIUs = [ "webdsl.editor.feature.feature.group" ];        
 	   		dontInstall = true;             
 	   	};          

From chrismelman at hotmail.com  Wed May 23 13:23:19 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 11:23:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24858 - hydra/webdsl
Message-ID: <20120523112319.D19862B8046@mx2.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 11:23:18 2012
New Revision: 24858
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24858&sc=1

Log:
added the yellowgrass branch to tests

Modified:
   hydra/webdsl/tests-separate-compilation.nix
   hydra/webdsl/tests.nix

Modified: hydra/webdsl/tests-separate-compilation.nix
==============================================================================
--- hydra/webdsl/tests-separate-compilation.nix	Wed May 23 09:53:40 2012	(r24857)
+++ hydra/webdsl/tests-separate-compilation.nix	Wed May 23 11:23:18 2012	(r24858)
@@ -59,6 +59,7 @@
   researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc [];
+  yellowgrass(webservices) = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass(webservices)" yellowgrasswebservicesSrc [];
   feedback    = { feedbackSrc ? { outPath = ../../feedback; rev = 1234; } }       : build "feedback" feedbackSrc [];
 
   webcheck =

Modified: hydra/webdsl/tests.nix
==============================================================================
--- hydra/webdsl/tests.nix	Wed May 23 09:53:40 2012	(r24857)
+++ hydra/webdsl/tests.nix	Wed May 23 11:23:18 2012	(r24858)
@@ -56,6 +56,7 @@
   researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ["chrismelman at hotmail.com""s.d.vermolen at tudelft.nl"] ;
+  yellowgrass(webservices) = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass(webservices)" yellowgrasswebservicesSrc [];
   feedback    = { feedbackSrc ? { outPath = ../../feedback; rev = 1234; } }       : build "evaluaties" feedbackSrc ["chrismelman at hotmail.com"];
   webcheck =
     { webdslSrc ? {outPath = ../../webdsl; rev = 1234;}

From chrismelman at hotmail.com  Wed May 23 13:27:43 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 11:27:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24859 - hydra/webdsl
Message-ID: <20120523112743.9AE5C7F8047@mx1.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 11:27:43 2012
New Revision: 24859
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24859&sc=1

Log:
() not allowed so replaces by _

Modified:
   hydra/webdsl/tests-separate-compilation.nix
   hydra/webdsl/tests.nix

Modified: hydra/webdsl/tests-separate-compilation.nix
==============================================================================
--- hydra/webdsl/tests-separate-compilation.nix	Wed May 23 11:23:18 2012	(r24858)
+++ hydra/webdsl/tests-separate-compilation.nix	Wed May 23 11:27:43 2012	(r24859)
@@ -59,7 +59,7 @@
   researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc [];
-  yellowgrass(webservices) = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass(webservices)" yellowgrasswebservicesSrc [];
+  yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass_webservices" yellowgrasswebservicesSrc [];
   feedback    = { feedbackSrc ? { outPath = ../../feedback; rev = 1234; } }       : build "feedback" feedbackSrc [];
 
   webcheck =

Modified: hydra/webdsl/tests.nix
==============================================================================
--- hydra/webdsl/tests.nix	Wed May 23 11:23:18 2012	(r24858)
+++ hydra/webdsl/tests.nix	Wed May 23 11:27:43 2012	(r24859)
@@ -56,7 +56,7 @@
   researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ["chrismelman at hotmail.com""s.d.vermolen at tudelft.nl"] ;
-  yellowgrass(webservices) = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass(webservices)" yellowgrasswebservicesSrc [];
+  yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass_webservices" yellowgrasswebservicesSrc [];
   feedback    = { feedbackSrc ? { outPath = ../../feedback; rev = 1234; } }       : build "evaluaties" feedbackSrc ["chrismelman at hotmail.com"];
   webcheck =
     { webdslSrc ? {outPath = ../../webdsl; rev = 1234;}

From chrismelman at hotmail.com  Wed May 23 13:30:59 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Wed, 23 May 2012 11:30:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24860 - hydra/webdsl
Message-ID: <20120523113059.0450A2B8049@mx2.tudelft.nl>

Author: ChrisMelman
Date: Wed May 23 11:30:58 2012
New Revision: 24860
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24860&sc=1

Log:
wrong parameter for build given

Modified:
   hydra/webdsl/tests-separate-compilation.nix
   hydra/webdsl/tests.nix

Modified: hydra/webdsl/tests-separate-compilation.nix
==============================================================================
--- hydra/webdsl/tests-separate-compilation.nix	Wed May 23 11:27:43 2012	(r24859)
+++ hydra/webdsl/tests-separate-compilation.nix	Wed May 23 11:30:58 2012	(r24860)
@@ -59,7 +59,7 @@
   researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc [];
-  yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass_webservices" yellowgrasswebservicesSrc [];
+  yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrasswebservicesSrc [];
   feedback    = { feedbackSrc ? { outPath = ../../feedback; rev = 1234; } }       : build "feedback" feedbackSrc [];
 
   webcheck =

Modified: hydra/webdsl/tests.nix
==============================================================================
--- hydra/webdsl/tests.nix	Wed May 23 11:27:43 2012	(r24859)
+++ hydra/webdsl/tests.nix	Wed May 23 11:30:58 2012	(r24860)
@@ -56,7 +56,7 @@
   researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ["chrismelman at hotmail.com""s.d.vermolen at tudelft.nl"] ;
-  yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass_webservices" yellowgrasswebservicesSrc [];
+  yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrasswebservicesSrc [];
   feedback    = { feedbackSrc ? { outPath = ../../feedback; rev = 1234; } }       : build "evaluaties" feedbackSrc ["chrismelman at hotmail.com"];
   webcheck =
     { webdslSrc ? {outPath = ../../webdsl; rev = 1234;}

From oskarvanrest at gmail.com  Wed May 23 13:35:05 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 23 May 2012 11:35:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24861 - in
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans:
	. emf
Message-ID: <20120523113505.489E8CC125@mx4.tudelft.nl>

Author: OskarVanRest
Date: Wed May 23 11:35:05 2012
New Revision: 24861
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24861&sc=1

Log:
Added: support for labels

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Wed May 23 11:30:58 2012	(r24860)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Wed May 23 11:35:05 2012	(r24861)
@@ -27,18 +27,31 @@
 			if <eq> (s, cons) + <eq> (s, "Start") then eSuperType := [] else eSuperType := ESuperType(s) end;
 			properties := <remove-all(?[])> [name, eSuperType];
 			structuralFeatures := <remove-all(?lit(_) + ?ci-lit(_))> lhs;
-			structuralFeatures' := <map(set-containment; set-bounds; set-structuralFeature)> structuralFeatures
+			structuralFeatures' := <map(set-name; set-containment; set-bounds; set-structuralFeature)> structuralFeatures
+
+	set-name:
+		label(unquoted(name), x) -> (x, [Name(name)])
+		
+	set-name:
+		x -> (x, [])
+		where
+			not ( <?label(_, _)> x )
 
 	set-containment:
-		namespacedef(_, sort) -> (sort, [Containment(True())])
+		(namespacedef(_, sort), properties) -> (sort, properties')
+		where
+			properties' := <remove-all(?[])> <conc> (properties, [Containment(True())])
 
 	set-containment:
-		namespaceref2(_, sort) -> (sort, [Containment(False())])
+		(namespaceref2(_, sort), properties) -> (sort, properties')
+		where
+			properties' := <remove-all(?[])> <conc> (properties, [Containment(False())])
 		
 	set-containment:
-		sort -> (sort, [Containment(True())])
-			where
-				not ( <?namespacedef(_, _)> sort + <?namespaceref2(_, _)> sort)
+		(sort, properties) -> (sort, properties')
+		where
+			not ( <?namespacedef(_, _)> sort + <?namespaceref2(_, _)> sort);
+			properties' := <remove-all(?[])> <conc> (properties, [Containment(False())])
 
 	set-bounds:
 		(sort(s), properties) -> (s, properties')
@@ -58,20 +71,34 @@
 	set-structuralFeature:
 		(s, properties) -> eStructuralFeature
 		where
-			name := Name(<first-char-to-lowercase> s);
+			properties' := <add-name> (s, properties);
+			
 			if
 				<int-or-string> s
 			then
 				type := Type(<int-or-string> s);
-				properties' := <conc> (properties, [name, type]);
-				properties'' := <remove-all(?Containment(_))> properties';
-				eStructuralFeature := EAttribute(properties'')
+				properties'' := <conc> (properties', [type]);
+				properties''' := <remove-all(?Containment(_))> properties';
+				eStructuralFeature := EAttribute(properties''')
 			else
 				type := Type(s);
-				properties'' := <conc> (properties, [name, type]);
+				properties'' := <conc> (properties', [type]);
 				eStructuralFeature := EReference(properties'')
 			end
 
+	add-name:
+		(s, properties) -> properties'
+		where
+			if <fetch(?Name(_))> properties
+			then properties' := properties
+			else
+				if <fetch(?UpperBound(-1))> properties
+				then name := Name(<lower-case; make-plural> s)
+				else name := Name(<lower-case> s)
+				end;
+				properties' := <conc> (properties, [name])
+			end
+
 	int-or-string:
 		"INT" -> EInt()
 		
@@ -95,13 +122,6 @@
 	
 rules // Utils
 
-	first-char-to-lowercase:
-		string -> string'	
-		where
-			(head, tail) := <split-Cons> <explode-string> string;
-			head' := <to-lower> head;
-			string' := <implode-string> <conc> ([head'], tail)
-	
 	make-plural:
 		string -> string'
 		where

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Wed May 23 11:30:58 2012	(r24860)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Wed May 23 11:35:05 2012	(r24861)
@@ -27,7 +27,8 @@
       index-setup(|"SDF", [<project-path>], path);
       filename  := $[[project-path]/[ANALYSIS_GENERATED].rtree];
       filename' := $[[project-path]/[ANALYSIS_GENERATED].str];
-      result    := <generate-name-analysis> ast;
+      ast'		:= <alltd(remove-labels)> ast;
+      result    := <generate-name-analysis> ast';
       result'   := <pp-stratego-string> result
       // <WriteToBinaryFile> (filename, result)
 
@@ -203,3 +204,9 @@
 
   fetch-scope-names:
     term(default(appl(unquoted("scope"), [fun(quoted(scopes))]))) -> scopes
+
+rules
+	
+	remove-labels:
+		label(_, x) -> x
+		
\ No newline at end of file

From oskarvanrest at gmail.com  Wed May 23 13:37:04 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Wed, 23 May 2012 11:37:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24862 -
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf
Message-ID: <20120523113704.8DEBC7F8047@mx1.tudelft.nl>

Author: OskarVanRest
Date: Wed May 23 11:37:04 2012
New Revision: 24862
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24862&sc=1

Log:
Merged with trunk

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/   (props changed)

From andre.s.d.vieira at gmail.com  Wed May 23 14:07:02 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Wed, 23 May 2012 12:07:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24863 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed
Message-ID: <20120523120702.F2911CC085@mx4.tudelft.nl>

Author: AndreVieira
Date: Wed May 23 12:07:02 2012
New Revision: 24863
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24863&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/AST.aterm	Wed May 23 12:07:02 2012	(r24863)
@@ -0,0 +1 @@
+ApplicationDefs(Qualified("c7_T_2t","mn"),[Procedure("J7E5",Arg("t3_",RefSort(GenericSort("nQG3H",[SimpleSort("V__1")]))),[ProcedureDone(Block([])),ProcedureDisabled(Block([])),ProcedureView([]),ProcedureProcess(ProcRepeatUntil(ProcIfNoElse(Call(RegexPattern(SingleBranch(Pieces([SingleAtom(SingleCharacter)]))),"eb",[]),ProcRepeatUntil(ProcCall("J7E5",NotEq(RenderEmailFunctionCall(EmailCall("J7E5",[])),SmallerThan(SearcherInit("X_",[]),EmailFunctionCall(EmailCall("NL_K3_2",[]))))),ProcCall("t3_",ObjectCreation(FunctionSort([],[]),[])))),ProcCall("N6_j",SmallerThanOrEqual(Eq(NotEq(True,ExternalScopeVar("B")),AndForExp(ForExpNoFilter(EventCall("z",[]),"VqG",RefSort(SimpleSort("i2")),ExternalScopeVar("IVf_")))),ThisCall("V__1",[]))))),ProcedureWho(FunctionRefCallPartial(FunctionRef("B",[],RefSort(GenericSort("gC2y1_S",[SimpleSort("B")]))),[])),ProcedureProcess(ProcAnd(ProcCall("kC1Q_l7_N",ThisCall("WjS1YR",[])),ProcPlus(ProcXor(ProcCall("gC2y1_S",Null),ProcCall("z",Highlight(Sma
 llerThanOrEqual(HighlightTags(True,ThisCall("IVf_",[]),"t7t___29T9.Z_4GPcM2_",EventCall("U6",[]),True),IsA(ThisCall("N6_j",[]),SimpleSort("gC2y1_S"))),Assignment(MapCreation([]),FunctionRefCall(FunctionRef("gC2y1_S",[],[]),[])),"p3_GG5Lj_8x"))),ProcWhile(SearchTimeSec(ExternalScopeVar("kC1Q_l7_N")),ProcCall("mn",Int("0")))))),ProcedureProcess(ProcSeq(ProcIf(FieldAccess(EmailFunctionCall(EmailCall("NL_K3_2",[])),"i2"),ProcAnd(ProcCall("WjS1YR",Sub(Int("3"),False)),ProcCall("nQG3H",EventCall("r6MQ8VD2__9",[]))),ProcSeq(ProcCall("J7E5",EventCall("VqG",[])),ProcCall("gC2y1_S",Eq(FunctionRef("eb",[],RefSort(SimpleSort("NL_K3_2"))),Not(ForExp(False,"D7T9DJ_167P",RefSort(SimpleSort("i2")),ThisCall("U6",[]),Filter(GlobalVar("J7E5"),OrderAscending(SetCreation([])),LimitNoLimit(Var("VqG"))))))))),ProcIf(ObjectCreation(FunctionSort([],RefSort(SimpleSort("D7T9DJ_167P"))),[]),ProcPlus(ProcCall("i2",Or(EventCall("mn",[]),SetCreation([]))),ProcCall("i2",FunctionRefCallPartial(FunctionRef("
 z",[],[]),[]))),ProcCall("i2",EventCall("kC1Q_l7_N",[]))))),Procedure ("z")),[ProcedureWho(SearchResults(SearchResultsSize(Or(SetCreation([]),ExternalScopeVar("kC1Q_l7_N"))))),ProcedureWho(EmailFunctionCall(EmailCall("V__1",[]))),ProcedureView([]),ProcedureView([])]),RecommendConfigStaticOrder("kC1Q_l7_N",RecommendUser("eb"),RecommendItem("r6MQ8VD2__9"),RecommendValue("IVf_"),RecommendAlgorithm("N6_j"),RecommendNeighborAlg("D7T9DJ_167P"),RecommendNeighborSize("VqG"),RecommendType("eb"),RecommendSchedule("D7T9DJ_167P")),Block([]),Test("t3_",Block([Block([]),Return(LargerThan(MapCreation([]),ExternalScopeVar("IVf_"))),AjaxStatement(AjaxRelocate(PageCall("r6MQ8VD2__9",[]))),IfNoElse(SearchTimeString(AndForExp(ForExp(SearchResultsSize(GlobalVar("gC2y1_S")),"t3_",RefSort(SimpleSort("VqG")),MapCreation([]),FilterNoLimit(AndForExp(ForExpNoFilter(MapCreation([]),"V__1",FunctionSort([],[]),CollectionIndex(AndForExp(ForExp(ExternalScopeVar("NL_K3_2"),"kC1Q_l7_N",FunctionSort([],[]),ValidateTemplateFunctionCall(TemplateCallPropsNoArgs("O",[],TemplateWith
 ([]))),FilterNoOrderBy(ListCreation([]),LimitNoLimit(False)))),ExternalScopeVar("V__1")))),OrderAscending(IfExp(GlobalVar("B"),False,Var("B" rchTimeString(FunctionRef("t3_",[],FunctionSort([],SimpleSort("i2")))))),AccessControlPrincipal("NL_K3_2",["eb"]),AccessControlPointcut("c7_T_2t",[],[])]),AccessControlDefinition([],[]),AccessControlDefinition("c7_T_2t",[Predicate("N6_j",[],SetCreation([])),AccessControlPrincipal("D7T9DJ_167P",["eb"]),AccessControlRule("r6MQ8VD2__9","Qww",MatchArgs([],[]),Mul(FunctionRefCallPartial(FunctionRef("D7T9DJ_167P",[],[]),[]),Mod(RenderEmailFunctionCall(EmailCall("eb",[])),ForExpNoFilter(Var("IVf_"),"V__1",SimpleSort("VqG"),GlobalVar("r6MQ8VD2__9")))),[]),AccessControlPointcut("r6MQ8VD2__9",[],[]),AccessControlRule("i2","*",MatchArgs([],"*"),Mul(SearchResults(FunctionRefCallPartial(FunctionRef("N6_j",[],SimpleSort("VqG")),[])),ExternalScopeVar("WjS1YR")),[]),Predicate("mn",[],IsA(FunctionExp([],GenericSort("D7T9DJ_167P",[SimpleSort("NL_K3_2")]),Block([])),GenericSort("t3_",[SimpleSort("mn")]))),AccessControlPrincipal("mn",["U6"]),SpecialAccessControlRule("i2",TypedSetCreation(Generi
 cSort("kC1Q_l7_N",[SimpleSort("J7E5")]),[])),AccessControlPrincipal("eb",["U6"])]),ACPolicy(Name("B"))])
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/program.app	Wed May 23 12:07:02 2012	(r24863)
@@ -0,0 +1,324 @@
+application c7_T_2t.mn
+
+procedure J7E5 ( t3_ : Ref<nQG3H<V__1>> ) {
+  done {
+    {
+    }
+  }
+  disabled {
+    {
+    }
+  }
+  view {
+  }
+  process { repeat { if ( /./.eb() ) repeat { J7E5 ( renderemail ( J7E5 ( ) ) != search X_ < email ( NL_K3_2 ( ) ) ) } until t3_ ( function():{} ) } until N6_j ( true != externalscope . B == And [ event ( z , [ ] ) | VqG : Ref<i2> in externalscope . IVf_ ] <= V__1() )
+  }
+  who {
+    function.B():Ref<gC2y1_S<B>>(*,)
+  }
+  process { kC1Q_l7_N ( WjS1YR() ) and gC2y1_S ( null ) xor z ( highlight highlight true for IVf_() on t7t___29T9.Z_4GPcM2_ surround with ( event ( U6 , [ ] ) , true ) <= N6_j() is a gC2y1_S for [
+                                                                                                                                                                                                   ] := function.gC2y1_S():() on p3_GG5Lj_8x ) + while ( get searchtimesec( externalscope . kC1Q_l7_N ) ) { mn ( 0 ) }
+  }
+  process { if ( email(NL_K3_2()).i2 ) { WjS1YR ( 3 - false ) and nQG3H ( event ( r6MQ8VD2__9 , [ ] ) ) } else { J7E5 ( event ( VqG , [ ] ) ) ; gC2y1_S ( function. eb ( ) : Ref<NL_K3_2> == ! [ false | D7T9DJ_167P : Ref<i2> in U6() where global.J7E5 order by {} asc offset VqG ] ) } ; if ( function():Ref<D7T9DJ_167P>{} ) { i2 ( event ( mn , [ ] ) || {} ) + i2 ( function.z():(*,) ) } else { i2 ( event ( kC1Q_l7_N , [ ] ) ) }
+  }
+  do {
+    {
+    }
+  }
+  enabled {
+    {
+    }
+  }
+}
+
+test
+
+D7T9DJ_167P
+
+{
+}
+
+var IVf_ : NL_K3_2 ;
+
+native function IVf_ ( ) : z<V__1<kC1Q_l7_N>,Ref<function():>> ;
+
+globals
+
+{
+
+function r6MQ8VD2__9 ( ) :
+{
+}
+
+extend
+
+extend
+
+extend
+
+function V__1 ( ) : WjS1YR<t3_>
+{
+}
+
+var
+
+D7T9DJ_167P
+
+:=
+
+get
+
+all
+
+facets
+
+(
+
+get size( function.kC1Q_l7_N():(*,) )
+
+,
+
+i.P8_564H___P.A9
+
+)
+
+;
+
+var c7_T_2t : nQG3H ;
+
+var c7_T_2t : Ref<function():> ;
+
+var
+
+eb
+
+:=
+
+[]
+
+;
+
+function mn ( ) :
+{
+}
+
+var r6MQ8VD2__9 : function ( ) : ;
+
+extend
+
+extend
+
+extend
+
+function eb ( ) : N6_j<V__1>
+{
+}
+
+}
+
+procedure t3_ ( V__1 : z ) {
+  who {
+    results from get size( {} || externalscope . kC1Q_l7_N )
+  }
+  who {
+    email
+    (
+    V__1
+    (
+    )
+    )
+  }
+  view {
+  }
+  view {
+  }
+}
+
+recommenderStaticOrder
+
+kC1Q_l7_N
+
+{
+
+eb
+
+r6MQ8VD2__9
+
+IVf_
+
+N6_j
+
+D7T9DJ_167P
+
+VqG
+
+eb
+
+D7T9DJ_167P
+
+}
+
+{
+}
+
+test
+
+t3_
+
+{
+  {
+  }
+  return [
+         ] > externalscope . IVf_;
+  relocate
+  (
+  r6MQ8VD2__9()
+  )
+  ;
+  if ( get searchtime( And [ get size( global.gC2y1_S ) | t3_ : Ref<VqG> in [
+                                                                            ] where And [ [
+                                                                                          ] | V__1 : function ( ) : in And [ externalscope . NL_K3_2 | kC1Q_l7_N : function ( ) : in validatetemplate ( O[]{with { }} ) where [] offset false ] [ externalscope . V__1 ] ] order by if ( global.B ) false else B asc ] ) )
+  {
+  }
+}
+
+session z {
+}
+
+access control rules
+  V__1
+  pointcut
+  r6MQ8VD2__9
+  (
+  )
+  {
+  }
+  pointcut
+  kC1Q_l7_N
+  (
+  )
+  {
+  }
+  pointcut
+  nQG3H
+  (
+  )
+  {
+  }
+  principal
+  is
+  J7E5
+  with
+  credentials
+  D7T9DJ_167P
+  predicate
+  t3_
+  (
+  )
+  {
+  externalscope
+  .
+  J7E5
+  }
+  rule mn z_18* (  ) {
+    Or [ {} && [ true | mn : WjS1YR<nQG3H> in renderemail ( J7E5 ( ) ) where event ( VqG , [ ] ) [ externalscope . NL_K3_2 ] [ true.WjS1YR() ] order by !true.c7_T_2t() desc ] | J7E5 : nQG3H in 38L ]
+  }
+  predicate
+  nQG3H
+  (
+  )
+  {
+  email
+  (
+  V__1
+  (
+  )
+  )
+  >=
+  nQG3H()
+  +
+  []
+  <=
+  get searchtime( function. t3_ ( ) : function ( ) : i2 )
+  }
+  principal
+  is
+  NL_K3_2
+  with
+  credentials
+  eb
+  pointcut
+  c7_T_2t
+  (
+  )
+  {
+  }
+
+access control rules
+
+access control rules
+  c7_T_2t
+  predicate
+  N6_j
+  (
+  )
+  {
+  {}
+  }
+  principal
+  is
+  D7T9DJ_167P
+  with
+  credentials
+  eb
+  rule r6MQ8VD2__9 Qww (  ) {
+    function.D7T9DJ_167P():(*,) * renderemail ( eb ( ) ) % [ IVf_ | V__1 : VqG in global.r6MQ8VD2__9 ]
+  }
+  pointcut
+  r6MQ8VD2__9
+  (
+  )
+  {
+  }
+  rule i2 * ( * ) {
+    results from function.N6_j():VqG(*,) * externalscope . WjS1YR
+  }
+  predicate
+  mn
+  (
+  )
+  {
+  function
+  (
+  )
+  :
+  D7T9DJ_167P<NL_K3_2>
+  {
+  }
+  is
+  a
+  t3_<mn>
+  }
+  principal
+  is
+  mn
+  with
+  credentials
+  U6
+  rule i2 {
+    Set<kC1Q_l7_N<J7E5>>()
+  }
+  principal
+  is
+  eb
+  with
+  credentials
+  U6
+
+access
+
+control
+
+policy
+
+B
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/o_28635crashed/strategyResult.txt	Wed May 23 12:07:02 2012	(r24863)
@@ -0,0 +1,38 @@
+
+Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	declare_globals_0_0
+	typecheck_declare_0_0
+	log_time_1_1
+	declare_all_0_0
+	dr_scope_1_1
+	alltd_1_0
+	declare_0_0
+	declare_procedure_0_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in strategy 'declare-procedure'
+           Procedure("J7E5",Arg("t3_",RefSort(GenericSort("nQG3H",[SimpleSort("V__1")]))),[ProcedureDone(Block([])),ProcedureDisabled(Block([])),ProcedureView([]),ProcedureProcess(ProcRepeatUntil(ProcIfNoElse(Call(RegexPattern(SingleBranch(Pieces([SingleAtom(SingleCharacter)]))),"eb",[]),ProcRepeatUntil(ProcCall("J7E5",NotEq(RenderEmailFunctionCall(EmailCall("J7E5",[])),SmallerThan(SearcherInit("X_",[]),EmailFunctionCall(EmailCall("NL_K3_2",[]))))),ProcCall("t3_",ObjectCreation(FunctionSort([],[]),[])))),ProcCall("N6_j",SmallerThanOrEqual(Eq(NotEq(True,ExternalScopeVar("B")),AndForExp(ForExp(EventCall("z",[]),"VqG",RefSort(SimpleSort("i2")),ExternalScopeVar("IVf_"),None))),ThisCall("V__1",[]))))),ProcedureWho(FunctionRefCallPartial(FunctionRef("B",[],RefSort(GenericSort("gC2y1_S",[SimpleSort("B")]))),[])),ProcedureProcess(ProcAnd(ProcCall("kC1Q_l7_N",ThisCall("WjS1YR",[])),ProcPlus(ProcXor(ProcCall("gC2y1_S",Null),ProcCall("z",Highlight(SmallerThanOrEqual(HighlightTags(True,
 ThisCall("IVf_",[]),"t7t___29T9.Z_4GPcM2_",EventCall("U6",[]),True),IsA(ThisCall("N6_j",[]),SimpleSort("gC2y1_S"))),Assignment(MapCreation([]),FunctionRefCall(FunctionRef("gC2y1_S",[],[]),[])),"p3_GG5Lj_8x"))),ProcWhile(SearchTimeSec(ExternalScopeVar("kC1Q_l7_N")),ProcCall("mn",Int("0")))))),ProcedureProcess(ProcSeq(ProcIf(FieldAccess(EmailFunctionCall(EmailCall("NL_K3_2",[])),"i2"),ProcAnd(ProcCall("WjS1YR",Sub(Int("3"),False)),ProcCall("nQG3H",EventCall("r6MQ8VD2__9",[]))),ProcSeq(ProcCall("J7E5",EventCall("VqG",[])),ProcCall("gC2y1_S",Eq(FunctionRef("eb",[],RefSort(SimpleSort("NL_K3_2"))),Not(ForExp(False,"D7T9DJ_167P",RefSort(SimpleSort("i2")),ThisCall("U6",[]),Filter(GlobalVar("J7E5"),OrderAscending(SetCreation([])),LimitNoLimit(Var("VqG"))))))))),ProcIf(ObjectCreation(FunctionSort([],RefSort(SimpleSort("D7T9DJ_167P"))),[]),ProcPlus(ProcCall("i2",Or(EventCall("mn",[]),SetCreation([]))),ProcCall("i2",FunctionRefCallPartial(FunctionRef("z",[],[]),[]))),ProcCall("i2",Event
 Call("kC1Q_l7_N",[]))))),ProcedureDo(Block([])),ProcedureEnabled(Bloc+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	declare_globals_0_0
+	typecheck_declare_0_0
+	log_time_1_1
+	declare_all_0_0
+	dr_scope_1_1
+	alltd_1_0
+	declare_0_0
+	declare_procedure_0_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in strategy 'declare-procedure'
+           Procedure("J7E5",Arg("t3_",RefSort(GenericSort("nQG3H",[SimpleSort("V__1")]))),[ProcedureDone(Block([])),ProcedureDisabled(Block([])),ProcedureView([]),ProcedureProcess(ProcRepeatUntil(ProcIfNoElse(Call(RegexPattern(SingleBranch(Pieces([SingleAtom(SingleCharacter)]))),"eb",[]),ProcRepeatUntil(ProcCall("J7E5",NotEq(RenderEmailFunctionCall(EmailCall("J7E5",[])),SmallerThan(SearcherInit("X_",[]),EmailFunctionCall(EmailCall("NL_K3_2",[]))))),ProcCall("t3_",ObjectCreation(FunctionSort([],[]),[])))),ProcCall("N6_j",SmallerThanOrEqual(Eq(NotEq(True,ExternalScopeVar("B")),AndForExp(ForExp(EventCall("z",[]),"VqG",RefSort(SimpleSort("i2")),ExternalScopeVar("IVf_"),None))),ThisCall("V__1",[]))))),ProcedureWho(FunctionRefCallPartial(FunctionRef("B",[],RefSort(GenericSort("gC2y1_S",[SimpleSort("B")]))),[])),ProcedureProcess(ProcAnd(ProcCall("kC1Q_l7_N",ThisCall("WjS1YR",[])),ProcPlus(ProcXor(ProcCall("gC2y1_S",Null),ProcCall("z",Highlight(SmallerThanOrEqual(HighlightTags(True,
 ThisCall("IVf_",[]),"t7t___29T9.Z_4GPcM2_",EventCall("U6",[]),True),IsA(ThisCall("N6_j",[]),SimpleSort("gC2y1_S"))),Assignment(MapCreation([]),FunctionRefCall(FunctionRef("gC2y1_S",[],[]),[])),"p3_GG5Lj_8x"))),ProcWhile(SearchTimeSec(ExternalScopeVar("kC1Q_l7_N")),ProcCall("mn",Int("0")))))),ProcedureProcess(ProcSeq(ProcIf(FieldAccess(EmailFunctionCall(EmailCall("NL_K3_2",[])),"i2"),ProcAnd(ProcCall("WjS1YR",Sub(Int("3"),False)),ProcCall("nQG3H",EventCall("r6MQ8VD2__9",[]))),ProcSeq(ProcCall("J7E5",EventCall("VqG",[])),ProcCall("gC2y1_S",Eq(FunctionRef("eb",[],RefSort(SimpleSort("NL_K3_2"))),Not(ForExp(False,"D7T9DJ_167P",RefSort(SimpleSort("i2")),ThisCall("U6",[]),Filter(GlobalVar("J7E5"),OrderAscending(SetCreation([])),LimitNoLimit(Var("VqG"))))))))),ProcIf(ObjectCreation(FunctionSort([],RefSort(SimpleSort("D7T9DJ_167P"))),[]),ProcPlus(ProcCall("i2",Or(EventCall("mn",[]),SetCreation([]))),ProcCall("i2",FunctionRefCallPartial(FunctionRef("z",[],[]),[]))),ProcCall("i2",Event
 Call("kC1Q_l7_N",[]))))),ProcedureDo(Block([])),ProcedureEnabled(Bloc\ No newline at end of file

From andre.s.d.vieira at gmail.com  Wed May 23 15:10:53 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Wed, 23 May 2012 13:10:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24864 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed
Message-ID: <20120523131053.B120ACC138@mx4.tudelft.nl>

Author: AndreVieira
Date: Wed May 23 13:10:52 2012
New Revision: 24864
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24864&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/AST.aterm	Wed May 23 13:10:52 2012	(r24864)
@@ -0,0 +1 @@
+ApplicationDefs("ln_8B98",[Define([Page,TemplateModInline],"F_X4",[Arg("GPn__98_Bi_",SimpleSort("T")),Arg("jH_",RefSort(GenericSort("r4",[SimpleSort("g1_X")]))),Arg("H_X_4mC___",SimpleSort("ln_8B98")),Arg("r4",GenericSort("F_X4",[SimpleSort("H_X_4mC___")])),Arg("jH_",GenericSort("F_X4",[SimpleSort("HZ")])),Arg("pH_z___",GenericSort("W10BKz_a9",[SimpleSort("ln_8B98")]))],None,[NavigateCall(PageCall("je_WNCLk_4_",[]),[],[]),Dispatch([],None),IfTempl(FunctionRefCallPartial(FunctionRef("c852_5D",[],[]),[]),[PagedForNoFilter("W10BKz_a9",FunctionSort([],SimpleSort("GPn__98_Bi_")),Null,EmailFunctionCall(EmailCall("g1_X",[])),[]),PagedForAllNoFilter("g1_X",FunctionSort([],[]),Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]),"E_.xYRV_8_jE.p02_q10__5N"),[]),Placeholder(True,[]),XMLEmptyElement("_",[]),PlaceholderWithAjaxCall(Add(IfExp(IfExp(Null,MapCreation([]),Var("F_X4")),SearchTimeMS(ListCreation([])),Func
 tionRef("F",[],GenericSort("jH_",[SimpleSort("W10BKz_a9")]))),AndForExp(ForExpNoFilter(TypedSetCreation(GenericSort("e__9",[SimpleSort("jt17_5_wMx4")]),[]),"cVL",RefSort(RefSort(FunctionSort([],[]))),SearchTimeString(Null)))),TemplateCallPropsNoArgs("D_31GD568q_",[],TemplateBody([]))),SubmitLink(Highlight(Long("1576L"),Eq(True,MapCreation([])),"t.GL.L8g_Ew"),InlineAction(Block([])),[])],[]),InitAction(Block([])),NavigateCall(PageCall("g1_X",[]),[],[]),ForCount("GPn__98_Bi_",ForExpNoFilter(Call(Assignment(GlobalVar("H_X_4mC___"),Var("e__9")),"c8o_c1P",[]),"T",GenericSort("HZ",[SimpleSort("je_WNCLk_4_")]),Add(Assignment(ThisCall("HZ",[]),Var("r4")),SearchTimeMS(GlobalVar("pH_z___")))),EmailFunctionCall(EmailCall("pH_z___",[])),[],ForSeparator([])),PagedFor("jH_",SimpleSort("je_WNCLk_4_"),RenderTemplateFunctionCall(TemplateCallNoBody("U1RG1_",[])),Filter(Not(ExternalScopeVar("jt17_5_wMx4")),OrderAscending(Mul(ForExpNoFilter(SendEmailFunctionCall(EmailCall("HZ",[])),"F",GenericS
 ort("GPn__98_Bi_",[SimpleSort("T")]),TypedSetCreation(SimpleSort("H_X ze(FunctionRef("c8o_c1P",[],[])),Block([])),ValidateStatement(Assignment(Mod(IsA(False,RefSort(SimpleSort("c8o_c1P"))),FunctionRef("c8o_c1P",[],GenericSort("c8o_c1P",[SimpleSort("W10BKz_a9")]))),And(SmallerThan(ExternalScopeVar("T"),MapCreation([])),SendEmailFunctionCall(EmailCall("ln_8B98",[])))),SearcherInit("G8_PL_",[])),Case(Long("4641615L"),[]),ForStmt("r4",SimpleSort("r4"),SmallerThanOrEqual(IsA(Or(False,ListCreation([])),SimpleSort("g1_X")),LargerThan(IfExp(Null,ThisCall("GPn__98_Bi_",[]),False),Float("-4E2105D"))),FilterNoWhereNoLimit(OrderNonSpecific(Div(Cast(MapCreation([]),RefSort(GenericSort("g1_X",[SimpleSort("V6___U_y5U")]))),Sub(NotEq(Null,ExternalScopeVar("c852_5D")),LargerThan(MapCreation([]),ExternalScopeVar("pH_z___")))))),Block([])),ForAllStmtNoFilter("W10BKz_a9",FunctionSort([],[]),Block([])),Return(MapCreation([])),ForStmtNoFilter("jH_",SimpleSort("e__9"),NotEq(LargerThanOrEqual(RenderTemplateFunctionCall(TemplateCallProps("y_",[])),RenderTemplateFuncti
 onCall(ValidationContext([]))),MapCreation([])),Block([])),ForStmt("F",RefSort(SimpleSort("jH_")),Call(RegexPattern(TupleBranch(TupleBranch( [],"c8o_c1P",[]),SearchNamespaceMapping("cVL"),SearchFieldMapping("+","e__9",[]),SearchFieldMapping("+","y_fFiX_",[]),SearchFieldMapping([],"c8o_c1P",[])]),Action([ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation,ActionModifierIgnoreValidation],"cVL",[Arg("pH_z___",SimpleSort("r4")),Arg("c852_5D",GenericSort("c852_5D",[FunctionSort([],[]),RefSort(FunctionSort([],SimpleSort("ln_8B98"))),SimpleSort("c852_5D"),SimpleSort("jH_"),RefSort(GenericSort("jt17_5_wMx4",[SimpleSort("e__9")])),FunctionSort([],[]),RefSort(FunctionSort([],SimpleSort("T")))])),Arg("cVL",FunctionSort([],FunctionSort([],[])))],Block([ReturnEmpty,AjaxStatement(AjaxRestyle(Call(RegexPattern(SingleBranch(Pieces([SingleAtom(AtomLiteral("/"))]))),"c8o_c1P",[]),LargerThanOrEqual(ListCreati
 on([]),ThisCall("jt17_5_wMx4",[])))),ValidateStatement(HighlightTags(SearcherRefMod(LargerThanOrEqual(MapCreation([]),ThisCall("c852_5D",[])),[SearchAttributes([])]),RenderTemplateFunctionCall(ThrowTemplate([Fal pleSort("cVL")]),FilterNoWhere(OrderAscending(Eq(FieldAccess(OrForExp(ForExpNoFilter(ListCreation([]),"r4",FunctionSort([],SimpleSort("H_X_4mC___")),GlobalVar("ln_8B98"))),"W10BKz_a9"),IfExp(ObjectCreation(RefSort(SimpleSort("jt17_5_wMx4")),[]),IsA(ThisCall("GPn__98_Bi_",[]),FunctionSort([],SimpleSort("y_fFiX_"))),CollectionIndex(ListCreation([]),MapCreation([]))))),Limit(FunctionRefCall(FunctionRef("r4",[],[]),[]),HighlightTags(Mul(FunctionRef("jH_",[],[]),LargerThan(Var("F"),True)),CollectionIndex(Call(RegexPattern(SingleBranch(Pieces([QuantifiedAtom(RegexCapture(TupleBranch(SingleBranch(Pieces([QuantifiedAtom(AtomLiteral("!"),PossessiveExactBound("23"))])),TupleBranch(SingleBranch(Pieces([SingleAtom(Empty)])),SingleBranch(Pieces([SingleAtom(AtomLiteral("/"))])))),RegexId("IX$")),GreedyZeroOrMore)]))),"c8o_c1P",[]),Eq(ListCreation([]),ListCreation([]))),"TN_M_L3Mv9.y_n9277_7__",Mul(Call(RegexPattern(SingleBranch(Pieces([SingleAtom(AtomLiteral("/"))]))),"W10BKz_a9",[]),Func
 tionRefCall(FunctionRef("HZ",[],[]),[])),Mod(NotEq(ExternalScopeVar("T"),ThisCall("je_WNCLk_4_",[])),SearcherRefMod(Var("T"),[SearchAttributes([])]))))),Block([])),Return(AndForExp(ForExpNoFilter(FacetResults(IfExp(Null,SetCreation([]),True),"e9w"),"W10BKz_a9",GenericSort("pH_z___" ,[]),LargerThanOrEqual(SearcherRefMod(SearchTimeString(SetCreation([])),[SearchAttributes([])]),ExternalScopeVar("H_X_4mC___")),[]),AccessControlPrincipal("GPn__98_Bi_",["GPn__98_Bi_"]),AccessControlPrincipal("F",["ln_8B98"]),AccessControlPointcut("r4",[],[]),AccessControlPointcut("c8o_c1P",[],[]),AccessControlPointcut("F",[],[]),AccessControlRule("F_X4","*",MatchArgs([],[]),Mod(Eq(IsA(ThisCall("c8o_c1P",[]),GenericSort("HZ",[SimpleSort("ln_8B98")])),CollectionIndex(ListCreation([]),GlobalVar("pH_z___"))),FunctionRefCallPartial(FunctionRef("jt17_5_wMx4",[],[]),[])),[]),AccessControlPointcut("HZ",[],[])]),AccessControlDefinition("jH_",[AccessControlPointcut("c8o_c1P",[],[]),AccessControlPointcut("GPn__98_Bi_",[],[]),Predicate("pH_z___",[],Mod(ExternalScopeVar("HZ"),False)),AccessControlRule("je_WNCLk_4_","*",MatchArgs([],[]),SearchTimeMS(OrForExp(ForExp(FunctionRefCall(FunctionRef("H_X_4mC___",[],RefSort(SimpleSort("F_X4"))),[]),"e__9",FunctionSort([],FunctionSort([],[])),Typ
 edListCreation(SimpleSort("y_fFiX_"),[]),FilterNoWhereNoLimit(OrderDescending(Mod(ListCreation([]),False)))))),[]),AccessControlPrincipal("g1_X",["HZ"]),Predicate("HZ",[],Suggest("kX",AutoComplete,[SuggestTerm(FieldsConstraint(["h5M44__6___"]),SmallerThan(Mod(ExternalScopeVar("F_X4"),ListCreation([])),CollectionIndex(MapCreation([]),Var("GPn__98_Bi_")\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/program.app	Wed May 23 13:10:52 2012	(r24864)
@@ -0,0 +1,582 @@
+application ln_8B98
+
+define
+
+page
+
+inline
+
+F_X4
+
+(
+
+GPn__98_Bi_ : T,
+
+jH_ : Ref<r4<g1_X>>,
+
+H_X_4mC___ : ln_8B98,
+
+r4 : F_X4<H_X_4mC___>,
+
+jH_ : F_X4<HZ>,
+
+pH_z___ : W10BKz_a9<ln_8B98>
+
+)
+
+{
+
+navigate
+
+je_WNCLk_4_()
+
+[
+
+]
+
+{
+
+}
+
+dispatch
+
+{
+
+}
+
+if ( function.c852_5D():(*,) ) {
+  for
+  (
+  W10BKz_a9
+  :
+  function
+  (
+  )
+  :
+  GPn__98_Bi_
+  in
+  null
+  per
+  email
+  (
+  g1_X
+  (
+  )
+  )
+  )
+  {
+  }
+  for
+  (
+  g1_X
+  :
+  function
+  (
+  )
+  :
+  per
+  highlight
+  function.H_X_4mC___():(*,)
+  for
+  Set<function ( ) : F_X4>()
+  on
+  E_.xYRV_8_jE.p02_q10__5N
+  )
+  {
+  }
+  placeholder
+  true
+  {
+  }
+  <
+  _
+  />
+  placeholder
+  if
+  (
+  if
+  (
+  null
+  )
+  [
+  ]
+  else
+  F_X4
+  )
+  get searchtimems( [] )
+  else
+  function.
+  F
+  (
+  )
+  :
+  jH_<W10BKz_a9>
+  +
+  And
+  [ Set<e__9<jt17_5_wMx4>>() | cVL : Ref<Ref<function():>> in get searchtime( null ) ]
+  D_31GD568q_[]{}
+  submitlink
+  (
+  highlight
+  1576L
+  for
+  true
+  ==
+  [
+  ]
+  on
+  t.GL.L8g_Ew
+  ,
+  action
+  {
+  }
+  )
+  [
+  ]
+}
+else
+{
+}
+
+init
+{
+}
+
+navigate
+
+g1_X()
+
+[
+
+]
+
+{
+
+}
+
+for
+
+(
+
+GPn__98_Bi_
+
+:
+
+Int
+
+from
+
+[ global.H_X_4mC___ := e__9.c8o_c1P() | T : HZ<je_WNCLk_4_> in HZ() := r4 + get searchtimems( global.pH_z___ ) ]
+
+to
+
+email
+
+(
+
+pH_z___
+
+(
+
+)
+
+)
+
+)
+
+{
+
+}
+
+separated-by
+
+{
+
+}
+
+for
+
+(
+
+jH_
+
+:
+
+je_WNCLk_4_
+
+in
+
+rendertemplate
+
+(
+
+U1RG1_()
+
+)
+
+where
+
+!
+
+externalscope
+
+.
+
+jt17_5_wMx4
+
+order
+
+by
+
+[ sendemail ( HZ ( ) ) | F : GPn__98_Bi_<T> in Set<H_X_4mC___>() ]
+
+*
+
+je_WNCLk_4_().je_WNCLk_4_()
+
+asc
+
+limit
+
+rendertemplate
+
+(
+
+validationErrors
+
+(
+
+jt17_5_wMx4
+
+)
+
+)
+
+offset
+
+/\uCfFd{38711}?/.W10BKz_a9()
+
+per
+
+true
+
+>
+
+And
+
+[ HZ - [
+       ] | g1_X : r4 in {} * externalscope . F order by get searchtimesec( [
+                                                                           ] ) desc offset function.y_fFiX_():je_WNCLk_4_() ]
+
+)
+
+{
+
+}
+
+navigate
+
+GPn__98_Bi_()
+
+[
+
+]
+
+{
+
+}
+
+submit
+
+(
+
+[]
+
++
+
+Or[ [
+    ] | r4 : function ( ) : H_X_4mC___ in c8o_c1P ].je_WNCLk_4_()
+
+,
+
+F_X4()
+
+)
+
+[
+
+]
+
+if ( [] := H_X_4mC___().pH_z___ ) {
+}
+
+}
+
+{
+  while
+  (
+  get size( function. c8o_c1P ( ) : )
+  )
+  {
+  }
+  validate
+  (
+  false is a Ref<c8o_c1P> % function. c8o_c1P ( ) : c8o_c1P<W10BKz_a9> := externalscope . T < [
+                                                                                              ] && sendemail ( ln_8B98 ( ) )
+  ,
+  search G8_PL_
+  )
+  ;
+  case ( 4641615L ) {
+  }
+  for ( r4 : r4 in false || [] is a g1_X <= if ( null ) GPn__98_Bi_() else false > -4E2105D order by [
+                                                                                                     ] as Ref<g1_X<V6___U_y5U>> / null != externalscope . c852_5D - [
+                                                                                                                                                                    ] > externalscope . pH_z___ )
+  {
+  }
+  for ( W10BKz_a9 : function ( ) : )
+  {
+  }
+  return [
+         ];
+  for ( jH_ : e__9 in rendertemplate ( y_[] ) >= rendertemplate ( validationContext { } ) != [
+                                                                                             ] )
+  {
+  }
+  for ( F : Ref<jH_> in /empty{43],7}+|\Q"\E|!|\Q"\E|^+|^|^|empty/.F() order by if ( sendemail ( g1_X ( ) ) ) function.jt17_5_wMx4():() >= true else true )
+  {
+  }
+}
+
+searchmapping r4 {
+  + jH_
+  + y_fFiX_
+  + HZ
+   c8o_c1P
+  namespace by cVL
+  + e__9
+  + y_fFiX_
+   c8o_c1P
+}
+
+action ignore-validation ignore-validation ignore-validation ignore-validation ignore-validation ignore-validation ignore-validation ignore-validation ignore-validation ignore-validation cVL ( pH_z___ : r4, c852_5D : c852_5D<function():,Ref<function():ln_8B98>,c852_5D,jH_,Ref<jt17_5_wMx4<e__9>>,function():,Ref<function():T>>, cVL : function ( ) : function ( ) : )
+{
+  return ;
+  restyle
+  (
+  ///.c8o_c1P()
+  ,
+  []
+  >=
+  jt17_5_wMx4()
+  )
+  ;
+  validate
+  (
+  highlight
+  ~ [
+    ] >= c852_5D() [ ]
+  for
+  rendertemplate
+  (
+  throw
+  false
+  )
+  on
+  n_6.eP2_6N53F_M
+  surround
+  with
+  (
+  email
+  (
+  r4
+  (
+  )
+  )
+  ,
+  email
+  (
+  jt17_5_wMx4
+  (
+  )
+  )
+  )
+  ,
+  sendemail
+  (
+  W10BKz_a9
+  (
+  )
+  )
+  )
+  ;
+  while
+  (
+  function.
+  F_X4
+  (
+  )
+  :
+  <
+  true
+  +
+  externalscope.W10BKz_a9inexternalscope.cVL.y_fFiX_()
+  )
+  {
+  }
+  for ( c8o_c1P : Ref<g1_X<r4>> in search X8 )
+  {
+  }
+  for ( GPn__98_Bi_ : Ref<function():HZ<r4>> in externalscope . F_X4 limit get searchtime( [] ).r4() )
+  {
+  }
+  for ( F : function ( ) : Ref<Ref<Ref<je_WNCLk_4_>>> )
+  {
+  }
+  for ( GPn__98_Bi_ : HZ<cVL> order by Or[ [] | r4 : function ( ) : H_X_4mC___ in global.ln_8B98 ].W10BKz_a9 == if ( Ref<jt17_5_wMx4>{} ) GPn__98_Bi_() is a function ( ) : y_fFiX_ else [] [ [
+                                                                                                                                                                                              ] ] asc limit function.r4():() offset highlight function. jH_ ( ) : * F > true for /(!{23}+|empty|/)@{IX$}*/.c8o_c1P() [ [] == [] ] on TN_M_L3Mv9.y_n9277_7__ surround with ( ///.W10BKz_a9() * function.HZ():() , externalscope . T != je_WNCLk_4_() % ~ T [ ] ) )
+  {
+  }
+  return And [ get facets ( if ( null ) {} else true , e9w ) | W10BKz_a9 : pH_z___<cVL> in [] == global.je_WNCLk_4_ || global.g1_X ];
+}
+
+access
+
+control
+
+policy
+
+je_WNCLk_4_
+
+OR
+
+F
+
+access
+
+control
+
+policy
+
+W10BKz_a9
+
+access control rules
+  pH_z___
+
+access control rules
+  rule e__9 * (  ) {
+    Set<y_fFiX_>()
+  }
+  rule cVL {
+    /${52],313564355}?/.V6___U_y5U()
+  }
+
+access control rules
+  jH_
+
+access
+
+control
+
+policy
+
+c8o_c1P
+
+AND
+
+ln_8B98
+
+OR
+
+je_WNCLk_4_
+
+OR
+
+e__9
+
+access control rules
+  rule jH_ f_* (  ) {
+    ~ get searchtime( {} ) [ ] >= externalscope . H_X_4mC___
+  }
+  principal
+  is
+  GPn__98_Bi_
+  with
+  credentials
+  GPn__98_Bi_
+  principal
+  is
+  F
+  with
+  credentials
+  ln_8B98
+  pointcut
+  r4
+  (
+  )
+  {
+  }
+  pointcut
+  c8o_c1P
+  (
+  )
+  {
+  }
+  pointcut
+  F
+  (
+  )
+  {
+  }
+  rule F_X4 * (  ) {
+    c8o_c1P() is a HZ<ln_8B98> == [] [ global.pH_z___ ] % function.jt17_5_wMx4():(*,)
+  }
+  pointcut
+  HZ
+  (
+  )
+  {
+  }
+
+access control rules
+  jH_
+  pointcut
+  c8o_c1P
+  (
+  )
+  {
+  }
+  pointcut
+  GPn__98_Bi_
+  (
+  )
+  {
+  }
+  predicate
+  pH_z___
+  (
+  )
+  {
+  externalscope
+  .
+  HZ
+  %
+  false
+  }
+  rule je_WNCLk_4_ * (  ) {
+    get searchtimems( Or [ function.H_X_4mC___():Ref<F_X4>() | e__9 : function ( ) : function ( ) : in List<y_fFiX_>() order by [] % false desc ] )
+  }
+  principal
+  is
+  g1_X
+  with
+  credentials
+  HZ
+  predicate
+  HZ
+  (
+  )
+  {
+  kX completions matching h5M44__6___ : externalscope . F_X4 % [] < [
+                                                                    ] [ GPn__98_Bi_ ]
+  }
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/r_4264crashed/strategyResult.txt	Wed May 23 13:10:52 2012	(r24864)
@@ -0,0 +1,182 @@
+
+Analyzing: TestFolder2/program.app
+rename: 0.040 s
+
+* : error: Type not defined: T
+T
+* : error: Type not defined: g1_X
+g1_X
+* : error: Generic type not defined: r4<g1_X>
+r4<g1_X>
+* : error: Type not defined: ln_8B98
+ln_8B98
+* : error: Type not defined: H_X_4mC___
+H_X_4mC___
+* : error: Generic type not defined: F_X4<H_X_4mC___>
+F_X4<H_X_4mC___>
+* : error: Type not defined: HZ
+HZ
+* : error: Generic type not defined: F_X4<HZ>
+F_X4<HZ>
+* : error: Type not defined: ln_8B98
+ln_8B98
+* : error: Generic type not defined: W10BKz_a9<ln_8B98>
+W10BKz_a9<ln_8B98>
+* : error: There is no page with signature je_WNCLk_4_().
+je_WNCLk_4_()
+* : error: Type not defined: GPn__98_Bi_
+GPn__98_Bi_
+* : error: No email definition for g1_X ( ).
+g1_X ( )
+* : error: Paged 'for' not supported in this version.
+for ( W10BKz_a9 : function ( ) : GPn__98_Bi_ in null per email ( g1_X ( ) ) ) {
+}
+* : error: Type not defined: F_X4
+F_X4
+[ WebDSL | error ] No pp entry found for: (3,["Highlight"])
+[ WebDSL | error ] Cannot rewrite to box: 
+        Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]){ClosureInAnno([Var("pH_z___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__pH_z___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_1"}),Var("r4"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__r40"}),Var("H_X_4mC___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__H_X_4mC___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_0"}),Var("GPn__98_Bi_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__GPn__98_Bi_0"})])},"E_.xYRV_8_jE.p02_q10__5N")
+[ WebDSL | error ] Cannot rewrite to box: 
+        PagedForAllNoFilter("g1_X"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__g1_X0"},FunctionSort([],[]),Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]){ClosureInAnno([Var("pH_z___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__pH_z___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_1"}),Var("r4"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__r40"}),Var("H_X_4mC___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__H_X_4mC___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_0"}),Var("GPn__98_Bi_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__GPn__98_Bi_0"})])},"E_.xYRV_8_jE.p02_q10__5N"),[])
+* : error: Paged 'for' not supported in this version.
+PagedForAllNoFilter("g1_X",FunctionSort([],[]),Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]),"E_.xYRV_8_jE.p02_q10__5N"),[])
+* : error: expression null should be of type Bool
+if ( null ) [
+            ] else F_X4
+* : error: Type cannot be determined for empty untyped list creation.
+[]
+* : error: Generic type not defined: EntityTypeNamed<W10BKz_a9>
+EntityTypeNamed<W10BKz_a9>
+* : error: Generic type not defined: jH_<EntityTypeNamed<W10BKz_a9>>
+jH_<EntityTypeNamed<W10BKz_a9>>
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	catch_errors_editor_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	constraint_error_all_0_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	try_1_0
+	constraint_error_0_0
+	constraint_error_action_0_0
+	constraint_error_action_0_0_fragment_1
+	constraint_error_action_0_0_fragment_0
+	pp_type_0_0
+	pp_type_aux_0_0
+	pp_type_0_0
+	pp_type_aux_0_0
+	pp_type_0_0
+	pp_type_aux_0_0
+	pp_type_0_0
+	pp_type_aux_0_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'pp-type'
+           "W10BKz_a9"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__W10BKz_a90"}Analyzing: TestFolder2/program.app
+rename: 0.040 s
+
+* : error: Type not defined: T
+T
+* : error: Type not defined: g1_X
+g1_X
+* : error: Generic type not defined: r4<g1_X>
+r4<g1_X>
+* : error: Type not defined: ln_8B98
+ln_8B98
+* : error: Type not defined: H_X_4mC___
+H_X_4mC___
+* : error: Generic type not defined: F_X4<H_X_4mC___>
+F_X4<H_X_4mC___>
+* : error: Type not defined: HZ
+HZ
+* : error: Generic type not defined: F_X4<HZ>
+F_X4<HZ>
+* : error: Type not defined: ln_8B98
+ln_8B98
+* : error: Generic type not defined: W10BKz_a9<ln_8B98>
+W10BKz_a9<ln_8B98>
+* : error: There is no page with signature je_WNCLk_4_().
+je_WNCLk_4_()
+* : error: Type not defined: GPn__98_Bi_
+GPn__98_Bi_
+* : error: No email definition for g1_X ( ).
+g1_X ( )
+* : error: Paged 'for' not supported in this version.
+for ( W10BKz_a9 : function ( ) : GPn__98_Bi_ in null per email ( g1_X ( ) ) ) {
+}
+* : error: Type not defined: F_X4
+F_X4
+[ WebDSL | error ] No pp entry found for: (3,["Highlight"])
+[ WebDSL | error ] Cannot rewrite to box: 
+        Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]){ClosureInAnno([Var("pH_z___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__pH_z___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_1"}),Var("r4"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__r40"}),Var("H_X_4mC___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__H_X_4mC___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_0"}),Var("GPn__98_Bi_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__GPn__98_Bi_0"})])},"E_.xYRV_8_jE.p02_q10__5N")
+[ WebDSL | error ] Cannot rewrite to box: 
+        PagedForAllNoFilter("g1_X"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__g1_X0"},FunctionSort([],[]),Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]){ClosureInAnno([Var("pH_z___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__pH_z___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_1"}),Var("r4"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__r40"}),Var("H_X_4mC___"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__H_X_4mC___0"}),Var("jH_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__jH_0"}),Var("GPn__98_Bi_"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__GPn__98_Bi_0"})])},"E_.xYRV_8_jE.p02_q10__5N"),[])
+* : error: Paged 'for' not supported in this version.
+PagedForAllNoFilter("g1_X",FunctionSort([],[]),Highlight(FunctionRefCallPartial(FunctionRef("H_X_4mC___",[],[]),[]),TypedSetCreation(FunctionSort([],SimpleSort("F_X4")),[]),"E_.xYRV_8_jE.p02_q10__5N"),[])
+* : error: expression null should be of type Bool
+if ( null ) [
+            ] else F_X4
+* : error: Type cannot be determined for empty untyped list creation.
+[]
+* : error: Generic type not defined: EntityTypeNamed<W10BKz_a9>
+EntityTypeNamed<W10BKz_a9>
+* : error: Generic type not defined: jH_<EntityTypeNamed<W10BKz_a9>>
+jH_<EntityTypeNamed<W10BKz_a9>>
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	editor_check_0_1
+	dr_scope_1_1
+	dr_scope_1_1
+	dbg_time_1_1
+	catch_errors_editor_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	constraint_error_all_0_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	bottomup_1_0
+	try_1_0
+	constraint_error_0_0
+	constraint_error_action_0_0
+	constraint_error_action_0_0_fragment_1
+	constraint_error_action_0_0_fragment_0
+	pp_type_0_0
+	pp_type_aux_0_0
+	pp_type_0_0
+	pp_type_aux_0_0
+	pp_type_0_0
+	pp_type_aux_0_0
+	pp_type_0_0
+	pp_type_aux_0_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'pp-type'
+           "W10BKz_a9"{"F_X4T__r4_g1_X___ln_8B98__F_X4_H_X_4mC______F_X4_HZ___W10BKz_a9_ln_8B98__W10BKz_a90"}
\ No newline at end of file

From m.dejonge at tudelft.nl  Wed May 23 16:47:02 2012
From: m.dejonge at tudelft.nl (Maartje de Jonge)
Date: Wed, 23 May 2012 14:47:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24865 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util
Message-ID: <20120523144702.566F22B8051@mx2.tudelft.nl>

Author: MaartjeDeJonge
Date: Wed May 23 14:47:00 2012
New Revision: 24865
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24865&sc=1

Log:
bugfix

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/layout-adaption.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/layout-adaption.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/layout-adaption.str	Wed May 23 13:10:52 2012	(r24864)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/layout-adaption.str	Wed May 23 14:47:00 2012	(r24865)
@@ -248,7 +248,7 @@
 assert-no-overlap:
 	txt-changes@[(start-offset, end-offset, _), (start-offset', _, _)|_] -> txt-changes
 	with
-		<lt> (start-offset, start-offset');
+		<leq> (start-offset, start-offset');
 		<leq> (end-offset, start-offset');
 		<at-tail(assert-no-overlap)> txt-changes
 		

From gabrielkonat at gmail.com  Thu May 24 17:10:32 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 24 May 2012 15:10:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24866 - in
	spoofax-imp/trunk/org.strategoxt.imp.editors.sdf: . editor lib trans
Message-ID: <20120524151032.C2F1E7F800F@mx1.tudelft.nl>

Author: gkonat
Date: Thu May 24 15:10:31 2012
New Revision: 24866
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24866&sc=1

Log:
Use generated index library in SDF editor.
Added builder for clearing the SDF index.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	Wed May 23 14:47:00 2012	(r24865)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	Thu May 24 15:10:31 2012	(r24866)
@@ -20,7 +20,7 @@
         <property name="build.sdf.imports" value="-Idef &quot;${basedir}/lib/SDF.def&quot;"/>
         <property name="build.stratego.args" value="--library
                         -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
-                        -la strc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm
+                        -la strc -la stratego-lib -la stratego-parallel -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm
                         -la stratego-sdf"/>
         
 	      <!-- External .def and .jar locations

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv	Wed May 23 14:47:00 2012	(r24865)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv	Thu May 24 15:10:31 2012	(r24866)
@@ -26,6 +26,9 @@
 
   builder : "Generate name analysis" =
     generate-name-analysis (realtime) (openeditor)
+    
+  builder : "Clean name analysis index" = 
+    index-cleanall (realtime) (openeditor)
 
   on save :
     generate-name-analysis
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	Wed May 23 14:47:00 2012	(r24865)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	Thu May 24 15:10:31 2012	(r24866)
@@ -32,6 +32,8 @@
     ast2abox(|[<import-term(include/SDF.generated.pp.af)>,
                <import-term(include/SDF.pp.af)>]);
     box2text-string(|100)
+    
+  language = !"SDF"
 
 strategies
   
@@ -214,6 +216,7 @@
   COMPLETION : String -> Term
   NOCONTEXT  : Term   -> Term
   MARKER     : Term
+  True       : Term
 
   // Below are copies of the signatures of the terms used in example
   // trans/sdf.str file. These definitions should also be automatically 
@@ -225,6 +228,9 @@
   Entity   : ID * List(Property) -> Entity
   Property : ID * Type           -> Property
   Type     : ID                  -> Type
+  
+  Type     : Namespace
+  Property : Namespace
 
 strategies
   

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Wed May 23 14:47:00 2012	(r24865)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Thu May 24 15:10:31 2012	(r24866)
@@ -6,7 +6,8 @@
   sdf
   analysis
   lib/attributes
-  lib/index-library-core
+  lib/index-library.generated
+  lib/analysis-library.generated
 
 overlays
   
@@ -20,11 +21,18 @@
 
 rules
   
+  // Cleans all data from the index.
+  index-cleanall:
+    (selected, position, ast, path, project-path)  -> None()
+    with
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
+      index-clear
+  
   // TODO: write str to disk first to ensure proper timestamp
   generate-name-analysis:
     (selected, position, ast, path, project-path) -> (filename', result')
     with
-      index-setup(|"SDF", [<project-path>], path);
+      index-setup(|<language>, [project-path], $[[project-path]/[path]]);
       filename  := $[[project-path]/[ANALYSIS_GENERATED].rtree];
       filename' := $[[project-path]/[ANALYSIS_GENERATED].str];
       result    := <generate-name-analysis> ast;

From gabrielkonat at gmail.com  Thu May 24 17:23:01 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 24 May 2012 15:23:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24867 -
	spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans
Message-ID: <20120524152301.1A7582B8025@mx2.tudelft.nl>

Author: gkonat
Date: Thu May 24 15:23:00 2012
New Revision: 24867
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24867&sc=1

Log:


Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Thu May 24 15:10:31 2012	(r24866)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/to-name-analysis.str	Thu May 24 15:23:00 2012	(r24867)
@@ -22,7 +22,7 @@
 rules
   
   // Cleans all data from the index.
-  index-cleanall:
+  index-cleanall: 
     (selected, position, ast, path, project-path)  -> None()
     with
       index-setup(|<language>, [project-path], $[[project-path]/[path]]);

From richard at vogelij.nl  Fri May 25 04:24:02 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Fri, 25 May 2012 02:24:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24868 - in
	spoofax-ace/trunk/spoofax-ace: resources/ace/src
	resources/html resources/javascript
	resources/javascript/aceworker resources/javascript/diff
	src/spoofax/ace/ge...
Message-ID: <20120525022402.7EB1ACC0D9@mx4.tudelft.nl>

Author: rvogelij
Date: Fri May 25 02:24:00 2012
New Revision: 24868
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24868&sc=1

Log:
-Implemented a patch generator to minimize bandwidth usage by only sening changes of the source code while editing.
-Implemented a diffable+patchable token layout which also only sends changes in stead of the entire ast+tokens.
-Added fucntions to apply the DIFF patches on both ends and convert them into bespion (ace) tokens
-Implmenented a crude version of a client<>server partitioning alg which will determine the optimum performance, and pass the work to either of the following three analysis strategies: 

	Str2Js implementation - locally calc everything when for instance no internet connection is available
	Raw data S2A Server<>Client - bandwidth heavy but cpu light
	Diff+Patch+Apply data - bandwidth light but cpu heavy

Added:
   spoofax-ace/trunk/spoofax-ace/resources/javascript/diff/
   spoofax-ace/trunk/spoofax-ace/resources/javascript/diff/diff_match_patch.js
Modified:
   spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js
   spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html
   spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html
   spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js
   spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js
   spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java

Modified: spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/ace/src/mode-spoofax2ace.js	Fri May 25 02:24:00 2012	(r24868)
@@ -19,9 +19,14 @@
             var d = new i(["ace", "pilot"], "worker-spoofax2ace.js", "ace/mode/spoofax2ace_worker", "SpoofaxToAceWorker");
             console.log("Creating worker 2"), d.call("setValue", [c.getValue()]), console.log("Creating worker 3");
             var e = function (a) {
+            	
                     var c = a.data,
-                        e = a.data.range;
-                    c.action === "insertText" && c.text === "\n" && b.shiftTokens(e.start.row, 1), c.action === "insertLines" && b.shiftTokens(e.start.row, c.lines.length), c.action === "removeText" && c.text === "\n" && b.unshiftTokens(e.start.row, 1), c.action === "removeLines" && b.unshiftTokens(e.start.row, c.lines.length), d.emit("change", a)
+                    e = a.data.range;
+                    c.action === "insertText" && c.text === "\n" && b.shiftTokens(e.start.row, 1), 
+                    c.action === "insertLines" && b.shiftTokens(e.start.row, c.lines.length), 
+                    c.action === "removeText" && c.text === "\n" && b.unshiftTokens(e.start.row, 1), 
+                    c.action === "removeLines" && b.unshiftTokens(e.start.row, c.lines.length), 
+                    d.emit("change", a)
                 };
             return c.on("change", e), this.debugWorker && (d.on("log", function (a) {
                 console.log("worker:" + a.data)

Modified: spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/html/editor_append.html	Fri May 25 02:24:00 2012	(r24868)
@@ -1,15 +1,16 @@
- </pre>
+ </div>
 <script src="src/ace-uncompressed.js" type="text/javascript" charset="utf-8"></script>
 <script src="src/theme-dawn.js" type="text/javascript" charset="utf-8"></script>
 <script src="src/mode-spoofax2ace.js" type="text/javascript" charset="utf-8"></script>
 <script src="require.js" type="text/javascript" charset="utf-8"></script>
 
 <script>
+var editorinstance;
 window.onload = function() {
-    var editor = ace.edit("editor");
-    editor.setTheme("ace/theme/dawn");
+    editorinstance = ace.edit("editor");
+    editorinstance.setTheme("ace/theme/dawn");
     var S2AMode = require("ace/mode/spoofax2ace").Mode;
-    editor.getSession().setMode(new S2AMode());
+    editorinstance.getSession().setMode(new S2AMode());
 };
 </script>
 </body>

Modified: spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/html/editor_prepend.html	Fri May 25 02:24:00 2012	(r24868)
@@ -9,7 +9,7 @@
         overflow: hidden;
     }
     
-    #editor { 
+    #editor2 { 
         margin: 0;
         position: absolute;
         top: 0;
@@ -21,4 +21,5 @@
 </head>
 <body>
 <input type=checkbox id='local'>
-<pre id="editor">
+<input type=checkbox id='bla'>
+<div id="editor" style="height: 100%; width: 100%;">
\ No newline at end of file

Modified: spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/aceworker/worker-spoofax2ace-prepend-new.js	Fri May 25 02:24:00 2012	(r24868)
@@ -140,7 +140,7 @@
 // -- kriskowal Kris Kowal Copyright (C) 2009-2010 MIT License
 // -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
 // -- dantman Daniel Friesen Copyright(C) 2010 XXX No License Specified
-// -- fschaefer Florian Sch?fer Copyright (C) 2010 MIT License
+// -- fschaefer Florian Sch???fer Copyright (C) 2010 MIT License
 // -- Irakli Gozalishvili Copyright (C) 2010 MIT License
 
 /*!
@@ -263,7 +263,7 @@
 // -- kriskowal Kris Kowal Copyright (C) 2009-2011 MIT License
 // -- tlrobinson Tom Robinson Copyright (C) 2009-2010 MIT License (Narwhal Project)
 // -- dantman Daniel Friesen Copyright (C) 2010 XXX TODO License or CLA
-// -- fschaefer Florian Sch?fer Copyright (C) 2010 MIT License
+// -- fschaefer Florian Sch???fer Copyright (C) 2010 MIT License
 // -- Gozala Irakli Gozalishvili Copyright (C) 2010 MIT License
 // -- kitcambridge Kit Cambridge Copyright (C) 2011 MIT License
 // -- kossnocorp Sasha Koss XXX TODO License or CLA
@@ -1528,7 +1528,8 @@
         
 		this.onUpdate = function()
 		{
-			this.delegateWork();
+			//this.delegateWork();
+			Partitioner.delegateWork(this.doc);
 		}
 
 

Added: spoofax-ace/trunk/spoofax-ace/resources/javascript/diff/diff_match_patch.js
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/diff/diff_match_patch.js	Fri May 25 02:24:00 2012	(r24868)
@@ -0,0 +1,49 @@
+(function(){function diff_match_patch(){this.Diff_Timeout=1;this.Diff_EditCost=4;this.Match_Threshold=0.5;this.Match_Distance=1E3;this.Patch_DeleteThreshold=0.5;this.Patch_Margin=4;this.Match_MaxBits=32}
+diff_match_patch.prototype.diff_main=function(a,b,c,d){"undefined"==typeof d&&(d=0>=this.Diff_Timeout?Number.MAX_VALUE:(new Date).getTime()+1E3*this.Diff_Timeout);if(null==a||null==b)throw Error("Null input. (diff_main)");if(a==b)return a?[[0,a]]:[];"undefined"==typeof c&&(c=!0);var e=c,f=this.diff_commonPrefix(a,b),c=a.substring(0,f),a=a.substring(f),b=b.substring(f),f=this.diff_commonSuffix(a,b),g=a.substring(a.length-f),a=a.substring(0,a.length-f),b=b.substring(0,b.length-f),a=this.diff_compute_(a,
+b,e,d);c&&a.unshift([0,c]);g&&a.push([0,g]);this.diff_cleanupMerge(a);return a};
+diff_match_patch.prototype.diff_compute_=function(a,b,c,d){if(!a)return[[1,b]];if(!b)return[[-1,a]];var e=a.length>b.length?a:b,f=a.length>b.length?b:a,g=e.indexOf(f);if(-1!=g)return c=[[1,e.substring(0,g)],[0,f],[1,e.substring(g+f.length)]],a.length>b.length&&(c[0][0]=c[2][0]=-1),c;if(1==f.length)return[[-1,a],[1,b]];return(e=this.diff_halfMatch_(a,b))?(f=e[0],a=e[1],g=e[2],b=e[3],e=e[4],f=this.diff_main(f,g,c,d),c=this.diff_main(a,b,c,d),f.concat([[0,e]],c)):c&&100<a.length&&100<b.length?this.diff_lineMode_(a,
+b,d):this.diff_bisect_(a,b,d)};
+diff_match_patch.prototype.diff_lineMode_=function(a,b,c){var d=this.diff_linesToChars_(a,b),a=d.chars1,b=d.chars2,d=d.lineArray,a=this.diff_main(a,b,!1,c);this.diff_charsToLines_(a,d);this.diff_cleanupSemantic(a);a.push([0,""]);for(var e=d=b=0,f="",g="";b<a.length;){switch(a[b][0]){case 1:e++;g+=a[b][1];break;case -1:d++;f+=a[b][1];break;case 0:if(1<=d&&1<=e){a.splice(b-d-e,d+e);b=b-d-e;d=this.diff_main(f,g,!1,c);for(e=d.length-1;0<=e;e--)a.splice(b,0,d[e]);b+=d.length}d=e=0;g=f=""}b++}a.pop();return a};
+diff_match_patch.prototype.diff_bisect_=function(a,b,c){for(var d=a.length,e=b.length,f=Math.ceil((d+e)/2),g=f,h=2*f,j=Array(h),i=Array(h),k=0;k<h;k++)j[k]=-1,i[k]=-1;j[g+1]=0;i[g+1]=0;for(var k=d-e,p=0!=k%2,q=0,s=0,o=0,v=0,u=0;u<f&&!((new Date).getTime()>c);u++){for(var n=-u+q;n<=u-s;n+=2){var l=g+n,m;m=n==-u||n!=u&&j[l-1]<j[l+1]?j[l+1]:j[l-1]+1;for(var r=m-n;m<d&&r<e&&a.charAt(m)==b.charAt(r);)m++,r++;j[l]=m;if(m>d)s+=2;else if(r>e)q+=2;else if(p&&(l=g+k-n,0<=l&&l<h&&-1!=i[l])){var t=d-i[l];if(m>=
+t)return this.diff_bisectSplit_(a,b,m,r,c)}}for(n=-u+o;n<=u-v;n+=2){l=g+n;t=n==-u||n!=u&&i[l-1]<i[l+1]?i[l+1]:i[l-1]+1;for(m=t-n;t<d&&m<e&&a.charAt(d-t-1)==b.charAt(e-m-1);)t++,m++;i[l]=t;if(t>d)v+=2;else if(m>e)o+=2;else if(!p&&(l=g+k-n,0<=l&&l<h&&-1!=j[l]&&(m=j[l],r=g+m-l,t=d-t,m>=t)))return this.diff_bisectSplit_(a,b,m,r,c)}}return[[-1,a],[1,b]]};
+diff_match_patch.prototype.diff_bisectSplit_=function(a,b,c,d,e){var f=a.substring(0,c),g=b.substring(0,d),a=a.substring(c),b=b.substring(d),f=this.diff_main(f,g,!1,e),e=this.diff_main(a,b,!1,e);return f.concat(e)};
+diff_match_patch.prototype.diff_linesToChars_=function(a,b){function c(a){for(var b="",c=0,f=-1,g=d.length;f<a.length-1;){f=a.indexOf("\n",c);-1==f&&(f=a.length-1);var q=a.substring(c,f+1),c=f+1;(e.hasOwnProperty?e.hasOwnProperty(q):void 0!==e[q])?b+=String.fromCharCode(e[q]):(b+=String.fromCharCode(g),e[q]=g,d[g++]=q)}return b}var d=[],e={};d[0]="";var f=c(a),g=c(b);return{chars1:f,chars2:g,lineArray:d}};
+diff_match_patch.prototype.diff_charsToLines_=function(a,b){for(var c=0;c<a.length;c++){for(var d=a[c][1],e=[],f=0;f<d.length;f++)e[f]=b[d.charCodeAt(f)];a[c][1]=e.join("")}};diff_match_patch.prototype.diff_commonPrefix=function(a,b){if(!a||!b||a.charAt(0)!=b.charAt(0))return 0;for(var c=0,d=Math.min(a.length,b.length),e=d,f=0;c<e;)a.substring(f,e)==b.substring(f,e)?f=c=e:d=e,e=Math.floor((d-c)/2+c);return e};
+diff_match_patch.prototype.diff_commonSuffix=function(a,b){if(!a||!b||a.charAt(a.length-1)!=b.charAt(b.length-1))return 0;for(var c=0,d=Math.min(a.length,b.length),e=d,f=0;c<e;)a.substring(a.length-e,a.length-f)==b.substring(b.length-e,b.length-f)?f=c=e:d=e,e=Math.floor((d-c)/2+c);return e};
+diff_match_patch.prototype.diff_commonOverlap_=function(a,b){var c=a.length,d=b.length;if(0==c||0==d)return 0;c>d?a=a.substring(c-d):c<d&&(b=b.substring(0,c));c=Math.min(c,d);if(a==b)return c;for(var d=0,e=1;;){var f=a.substring(c-e),f=b.indexOf(f);if(-1==f)return d;e+=f;if(0==f||a.substring(c-e)==b.substring(0,e))d=e,e++}};
+diff_match_patch.prototype.diff_halfMatch_=function(a,b){function c(a,b,c){for(var d=a.substring(c,c+Math.floor(a.length/4)),e=-1,g="",h,j,n,l;-1!=(e=b.indexOf(d,e+1));){var m=f.diff_commonPrefix(a.substring(c),b.substring(e)),r=f.diff_commonSuffix(a.substring(0,c),b.substring(0,e));g.length<r+m&&(g=b.substring(e-r,e)+b.substring(e,e+m),h=a.substring(0,c-r),j=a.substring(c+m),n=b.substring(0,e-r),l=b.substring(e+m))}return 2*g.length>=a.length?[h,j,n,l,g]:null}if(0>=this.Diff_Timeout)return null;
+var d=a.length>b.length?a:b,e=a.length>b.length?b:a;if(4>d.length||2*e.length<d.length)return null;var f=this,g=c(d,e,Math.ceil(d.length/4)),d=c(d,e,Math.ceil(d.length/2)),h;if(!g&&!d)return null;h=d?g?g[4].length>d[4].length?g:d:d:g;var j;a.length>b.length?(g=h[0],d=h[1],e=h[2],j=h[3]):(e=h[0],j=h[1],g=h[2],d=h[3]);h=h[4];return[g,d,e,j,h]};
+diff_match_patch.prototype.diff_cleanupSemantic=function(a){for(var b=!1,c=[],d=0,e=null,f=0,g=0,h=0,j=0,i=0;f<a.length;)0==a[f][0]?(c[d++]=f,g=j,h=i,i=j=0,e=a[f][1]):(1==a[f][0]?j+=a[f][1].length:i+=a[f][1].length,e&&e.length<=Math.max(g,h)&&e.length<=Math.max(j,i)&&(a.splice(c[d-1],0,[-1,e]),a[c[d-1]+1][0]=1,d--,d--,f=0<d?c[d-1]:-1,i=j=h=g=0,e=null,b=!0)),f++;b&&this.diff_cleanupMerge(a);this.diff_cleanupSemanticLossless(a);for(f=1;f<a.length;){if(-1==a[f-1][0]&&1==a[f][0]){b=a[f-1][1];c=a[f][1];
+d=this.diff_commonOverlap_(b,c);e=this.diff_commonOverlap_(c,b);if(d>=e){if(d>=b.length/2||d>=c.length/2)a.splice(f,0,[0,c.substring(0,d)]),a[f-1][1]=b.substring(0,b.length-d),a[f+1][1]=c.substring(d),f++}else if(e>=b.length/2||e>=c.length/2)a.splice(f,0,[0,b.substring(0,e)]),a[f-1][0]=1,a[f-1][1]=c.substring(0,c.length-e),a[f+1][0]=-1,a[f+1][1]=b.substring(e),f++;f++}f++}};
+diff_match_patch.prototype.diff_cleanupSemanticLossless=function(a){function b(a,b){if(!a||!b)return 6;var c=a.charAt(a.length-1),d=b.charAt(0),e=c.match(diff_match_patch.nonAlphaNumericRegex_),f=d.match(diff_match_patch.nonAlphaNumericRegex_),g=e&&c.match(diff_match_patch.whitespaceRegex_),h=f&&d.match(diff_match_patch.whitespaceRegex_),c=g&&c.match(diff_match_patch.linebreakRegex_),d=h&&d.match(diff_match_patch.linebreakRegex_),i=c&&a.match(diff_match_patch.blanklineEndRegex_),j=d&&b.match(diff_match_patch.blanklineStartRegex_);
+return i||j?5:c||d?4:e&&!g&&h?3:g||h?2:e||f?1:0}for(var c=1;c<a.length-1;){if(0==a[c-1][0]&&0==a[c+1][0]){var d=a[c-1][1],e=a[c][1],f=a[c+1][1],g=this.diff_commonSuffix(d,e);if(g)var h=e.substring(e.length-g),d=d.substring(0,d.length-g),e=h+e.substring(0,e.length-g),f=h+f;for(var g=d,h=e,j=f,i=b(d,e)+b(e,f);e.charAt(0)===f.charAt(0);){var d=d+e.charAt(0),e=e.substring(1)+f.charAt(0),f=f.substring(1),k=b(d,e)+b(e,f);k>=i&&(i=k,g=d,h=e,j=f)}a[c-1][1]!=g&&(g?a[c-1][1]=g:(a.splice(c-1,1),c--),a[c][1]=
+h,j?a[c+1][1]=j:(a.splice(c+1,1),c--))}c++}};diff_match_patch.nonAlphaNumericRegex_=/[^a-zA-Z0-9]/;diff_match_patch.whitespaceRegex_=/\s/;diff_match_patch.linebreakRegex_=/[\r\n]/;diff_match_patch.blanklineEndRegex_=/\n\r?\n$/;diff_match_patch.blanklineStartRegex_=/^\r?\n\r?\n/;
+diff_match_patch.prototype.diff_cleanupEfficiency=function(a){for(var b=!1,c=[],d=0,e=null,f=0,g=!1,h=!1,j=!1,i=!1;f<a.length;){if(0==a[f][0])a[f][1].length<this.Diff_EditCost&&(j||i)?(c[d++]=f,g=j,h=i,e=a[f][1]):(d=0,e=null),j=i=!1;else if(-1==a[f][0]?i=!0:j=!0,e&&(g&&h&&j&&i||e.length<this.Diff_EditCost/2&&3==g+h+j+i))a.splice(c[d-1],0,[-1,e]),a[c[d-1]+1][0]=1,d--,e=null,g&&h?(j=i=!0,d=0):(d--,f=0<d?c[d-1]:-1,j=i=!1),b=!0;f++}b&&this.diff_cleanupMerge(a)};
+diff_match_patch.prototype.diff_cleanupMerge=function(a){a.push([0,""]);for(var b=0,c=0,d=0,e="",f="",g;b<a.length;)switch(a[b][0]){case 1:d++;f+=a[b][1];b++;break;case -1:c++;e+=a[b][1];b++;break;case 0:1<c+d?(0!==c&&0!==d&&(g=this.diff_commonPrefix(f,e),0!==g&&(0<b-c-d&&0==a[b-c-d-1][0]?a[b-c-d-1][1]+=f.substring(0,g):(a.splice(0,0,[0,f.substring(0,g)]),b++),f=f.substring(g),e=e.substring(g)),g=this.diff_commonSuffix(f,e),0!==g&&(a[b][1]=f.substring(f.length-g)+a[b][1],f=f.substring(0,f.length-
+g),e=e.substring(0,e.length-g))),0===c?a.splice(b-d,c+d,[1,f]):0===d?a.splice(b-c,c+d,[-1,e]):a.splice(b-c-d,c+d,[-1,e],[1,f]),b=b-c-d+(c?1:0)+(d?1:0)+1):0!==b&&0==a[b-1][0]?(a[b-1][1]+=a[b][1],a.splice(b,1)):b++,c=d=0,f=e=""}""===a[a.length-1][1]&&a.pop();c=!1;for(b=1;b<a.length-1;)0==a[b-1][0]&&0==a[b+1][0]&&(a[b][1].substring(a[b][1].length-a[b-1][1].length)==a[b-1][1]?(a[b][1]=a[b-1][1]+a[b][1].substring(0,a[b][1].length-a[b-1][1].length),a[b+1][1]=a[b-1][1]+a[b+1][1],a.splice(b-1,1),c=!0):a[b][1].substring(0,
+a[b+1][1].length)==a[b+1][1]&&(a[b-1][1]+=a[b+1][1],a[b][1]=a[b][1].substring(a[b+1][1].length)+a[b+1][1],a.splice(b+1,1),c=!0)),b++;c&&this.diff_cleanupMerge(a)};diff_match_patch.prototype.diff_xIndex=function(a,b){var c=0,d=0,e=0,f=0,g;for(g=0;g<a.length;g++){1!==a[g][0]&&(c+=a[g][1].length);-1!==a[g][0]&&(d+=a[g][1].length);if(c>b)break;e=c;f=d}return a.length!=g&&-1===a[g][0]?f:f+(b-e)};
+diff_match_patch.prototype.diff_prettyHtml=function(a){for(var b=[],c=/&/g,d=/</g,e=/>/g,f=/\n/g,g=0;g<a.length;g++){var h=a[g][0],j=a[g][1],j=j.replace(c,"&amp;").replace(d,"&lt;").replace(e,"&gt;").replace(f,"&para;<br>");switch(h){case 1:b[g]='<ins style="background:#e6ffe6;">'+j+"</ins>";break;case -1:b[g]='<del style="background:#ffe6e6;">'+j+"</del>";break;case 0:b[g]="<span>"+j+"</span>"}}return b.join("")};
+diff_match_patch.prototype.diff_text1=function(a){for(var b=[],c=0;c<a.length;c++)1!==a[c][0]&&(b[c]=a[c][1]);return b.join("")};diff_match_patch.prototype.diff_text2=function(a){for(var b=[],c=0;c<a.length;c++)-1!==a[c][0]&&(b[c]=a[c][1]);return b.join("")};diff_match_patch.prototype.diff_levenshtein=function(a){for(var b=0,c=0,d=0,e=0;e<a.length;e++){var f=a[e][0],g=a[e][1];switch(f){case 1:c+=g.length;break;case -1:d+=g.length;break;case 0:b+=Math.max(c,d),d=c=0}}return b+=Math.max(c,d)};
+diff_match_patch.prototype.diff_toDelta=function(a){for(var b=[],c=0;c<a.length;c++)switch(a[c][0]){case 1:b[c]="+"+encodeURI(a[c][1]);break;case -1:b[c]="-"+a[c][1].length;break;case 0:b[c]="="+a[c][1].length}return b.join("\t").replace(/%20/g," ")};
+diff_match_patch.prototype.diff_fromDelta=function(a,b){for(var c=[],d=0,e=0,f=b.split(/\t/g),g=0;g<f.length;g++){var h=f[g].substring(1);switch(f[g].charAt(0)){case "+":try{c[d++]=[1,decodeURI(h)]}catch(j){throw Error("Illegal escape in diff_fromDelta: "+h);}break;case "-":case "=":var i=parseInt(h,10);if(isNaN(i)||0>i)throw Error("Invalid number in diff_fromDelta: "+h);h=a.substring(e,e+=i);"="==f[g].charAt(0)?c[d++]=[0,h]:c[d++]=[-1,h];break;default:if(f[g])throw Error("Invalid diff operation in diff_fromDelta: "+
+f[g]);}}if(e!=a.length)throw Error("Delta length ("+e+") does not equal source text length ("+a.length+").");return c};diff_match_patch.prototype.match_main=function(a,b,c){if(null==a||null==b||null==c)throw Error("Null input. (match_main)");c=Math.max(0,Math.min(c,a.length));return a==b?0:a.length?a.substring(c,c+b.length)==b?c:this.match_bitap_(a,b,c):-1};
+diff_match_patch.prototype.match_bitap_=function(a,b,c){function d(a,d){var e=a/b.length,g=Math.abs(c-d);return!f.Match_Distance?g?1:e:e+g/f.Match_Distance}if(b.length>this.Match_MaxBits)throw Error("Pattern too long for this browser.");var e=this.match_alphabet_(b),f=this,g=this.Match_Threshold,h=a.indexOf(b,c);-1!=h&&(g=Math.min(d(0,h),g),h=a.lastIndexOf(b,c+b.length),-1!=h&&(g=Math.min(d(0,h),g)));for(var j=1<<b.length-1,h=-1,i,k,p=b.length+a.length,q,s=0;s<b.length;s++){i=0;for(k=p;i<k;)d(s,c+
+k)<=g?i=k:p=k,k=Math.floor((p-i)/2+i);p=k;i=Math.max(1,c-k+1);var o=Math.min(c+k,a.length)+b.length;k=Array(o+2);for(k[o+1]=(1<<s)-1;o>=i;o--){var v=e[a.charAt(o-1)];k[o]=0===s?(k[o+1]<<1|1)&v:(k[o+1]<<1|1)&v|(q[o+1]|q[o])<<1|1|q[o+1];if(k[o]&j&&(v=d(s,o-1),v<=g))if(g=v,h=o-1,h>c)i=Math.max(1,2*c-h);else break}if(d(s+1,c)>g)break;q=k}return h};
+diff_match_patch.prototype.match_alphabet_=function(a){for(var b={},c=0;c<a.length;c++)b[a.charAt(c)]=0;for(c=0;c<a.length;c++)b[a.charAt(c)]|=1<<a.length-c-1;return b};
+diff_match_patch.prototype.patch_addContext_=function(a,b){if(0!=b.length){for(var c=b.substring(a.start2,a.start2+a.length1),d=0;b.indexOf(c)!=b.lastIndexOf(c)&&c.length<this.Match_MaxBits-this.Patch_Margin-this.Patch_Margin;)d+=this.Patch_Margin,c=b.substring(a.start2-d,a.start2+a.length1+d);d+=this.Patch_Margin;(c=b.substring(a.start2-d,a.start2))&&a.diffs.unshift([0,c]);(d=b.substring(a.start2+a.length1,a.start2+a.length1+d))&&a.diffs.push([0,d]);a.start1-=c.length;a.start2-=c.length;a.length1+=
+c.length+d.length;a.length2+=c.length+d.length}};
+diff_match_patch.prototype.patch_make=function(a,b,c){var d;if("string"==typeof a&&"string"==typeof b&&"undefined"==typeof c)d=a,b=this.diff_main(d,b,!0),2<b.length&&(this.diff_cleanupSemantic(b),this.diff_cleanupEfficiency(b));else if(a&&"object"==typeof a&&"undefined"==typeof b&&"undefined"==typeof c)b=a,d=this.diff_text1(b);else if("string"==typeof a&&b&&"object"==typeof b&&"undefined"==typeof c)d=a;else if("string"==typeof a&&"string"==typeof b&&c&&"object"==typeof c)d=a,b=c;else throw Error("Unknown call format to patch_make.");
+if(0===b.length)return[];for(var c=[],a=new diff_match_patch.patch_obj,e=0,f=0,g=0,h=d,j=0;j<b.length;j++){var i=b[j][0],k=b[j][1];if(!e&&0!==i)a.start1=f,a.start2=g;switch(i){case 1:a.diffs[e++]=b[j];a.length2+=k.length;d=d.substring(0,g)+k+d.substring(g);break;case -1:a.length1+=k.length;a.diffs[e++]=b[j];d=d.substring(0,g)+d.substring(g+k.length);break;case 0:k.length<=2*this.Patch_Margin&&e&&b.length!=j+1?(a.diffs[e++]=b[j],a.length1+=k.length,a.length2+=k.length):k.length>=2*this.Patch_Margin&&
+e&&(this.patch_addContext_(a,h),c.push(a),a=new diff_match_patch.patch_obj,e=0,h=d,f=g)}1!==i&&(f+=k.length);-1!==i&&(g+=k.length)}e&&(this.patch_addContext_(a,h),c.push(a));return c};diff_match_patch.prototype.patch_deepCopy=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=new diff_match_patch.patch_obj;e.diffs=[];for(var f=0;f<d.diffs.length;f++)e.diffs[f]=d.diffs[f].slice();e.start1=d.start1;e.start2=d.start2;e.length1=d.length1;e.length2=d.length2;b[c]=e}return b};
+diff_match_patch.prototype.patch_apply=function(a,b){if(0==a.length)return[b,[]];var a=this.patch_deepCopy(a),c=this.patch_addPadding(a),b=c+b+c;this.patch_splitMax(a);for(var d=0,e=[],f=0;f<a.length;f++){var g=a[f].start2+d,h=this.diff_text1(a[f].diffs),j,i=-1;if(h.length>this.Match_MaxBits){if(j=this.match_main(b,h.substring(0,this.Match_MaxBits),g),-1!=j&&(i=this.match_main(b,h.substring(h.length-this.Match_MaxBits),g+h.length-this.Match_MaxBits),-1==i||j>=i))j=-1}else j=this.match_main(b,h,g);
+if(-1==j)e[f]=!1,d-=a[f].length2-a[f].length1;else if(e[f]=!0,d=j-g,g=-1==i?b.substring(j,j+h.length):b.substring(j,i+this.Match_MaxBits),h==g)b=b.substring(0,j)+this.diff_text2(a[f].diffs)+b.substring(j+h.length);else if(g=this.diff_main(h,g,!1),h.length>this.Match_MaxBits&&this.diff_levenshtein(g)/h.length>this.Patch_DeleteThreshold)e[f]=!1;else{this.diff_cleanupSemanticLossless(g);for(var h=0,k,i=0;i<a[f].diffs.length;i++){var p=a[f].diffs[i];0!==p[0]&&(k=this.diff_xIndex(g,h));1===p[0]?b=b.substring(0,
+j+k)+p[1]+b.substring(j+k):-1===p[0]&&(b=b.substring(0,j+k)+b.substring(j+this.diff_xIndex(g,h+p[1].length)));-1!==p[0]&&(h+=p[1].length)}}}b=b.substring(c.length,b.length-c.length);return[b,e]};
+diff_match_patch.prototype.patch_addPadding=function(a){for(var b=this.Patch_Margin,c="",d=1;d<=b;d++)c+=String.fromCharCode(d);for(d=0;d<a.length;d++)a[d].start1+=b,a[d].start2+=b;var d=a[0],e=d.diffs;if(0==e.length||0!=e[0][0])e.unshift([0,c]),d.start1-=b,d.start2-=b,d.length1+=b,d.length2+=b;else if(b>e[0][1].length){var f=b-e[0][1].length;e[0][1]=c.substring(e[0][1].length)+e[0][1];d.start1-=f;d.start2-=f;d.length1+=f;d.length2+=f}d=a[a.length-1];e=d.diffs;0==e.length||0!=e[e.length-1][0]?(e.push([0,
+c]),d.length1+=b,d.length2+=b):b>e[e.length-1][1].length&&(f=b-e[e.length-1][1].length,e[e.length-1][1]+=c.substring(0,f),d.length1+=f,d.length2+=f);return c};
+diff_match_patch.prototype.patch_splitMax=function(a){for(var b=this.Match_MaxBits,c=0;c<a.length;c++)if(!(a[c].length1<=b)){var d=a[c];a.splice(c--,1);for(var e=d.start1,f=d.start2,g="";0!==d.diffs.length;){var h=new diff_match_patch.patch_obj,j=!0;h.start1=e-g.length;h.start2=f-g.length;if(""!==g)h.length1=h.length2=g.length,h.diffs.push([0,g]);for(;0!==d.diffs.length&&h.length1<b-this.Patch_Margin;){var g=d.diffs[0][0],i=d.diffs[0][1];1===g?(h.length2+=i.length,f+=i.length,h.diffs.push(d.diffs.shift()),
+j=!1):-1===g&&1==h.diffs.length&&0==h.diffs[0][0]&&i.length>2*b?(h.length1+=i.length,e+=i.length,j=!1,h.diffs.push([g,i]),d.diffs.shift()):(i=i.substring(0,b-h.length1-this.Patch_Margin),h.length1+=i.length,e+=i.length,0===g?(h.length2+=i.length,f+=i.length):j=!1,h.diffs.push([g,i]),i==d.diffs[0][1]?d.diffs.shift():d.diffs[0][1]=d.diffs[0][1].substring(i.length))}g=this.diff_text2(h.diffs);g=g.substring(g.length-this.Patch_Margin);i=this.diff_text1(d.diffs).substring(0,this.Patch_Margin);""!==i&&
+(h.length1+=i.length,h.length2+=i.length,0!==h.diffs.length&&0===h.diffs[h.diffs.length-1][0]?h.diffs[h.diffs.length-1][1]+=i:h.diffs.push([0,i]));j||a.splice(++c,0,h)}}};diff_match_patch.prototype.patch_toText=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=a[c];return b.join("")};
+diff_match_patch.prototype.patch_fromText=function(a){var b=[];if(!a)return b;for(var a=a.split("\n"),c=0,d=/^@@ -(\d+),?(\d*) \+(\d+),?(\d*) @@$/;c<a.length;){var e=a[c].match(d);if(!e)throw Error("Invalid patch string: "+a[c]);var f=new diff_match_patch.patch_obj;b.push(f);f.start1=parseInt(e[1],10);""===e[2]?(f.start1--,f.length1=1):"0"==e[2]?f.length1=0:(f.start1--,f.length1=parseInt(e[2],10));f.start2=parseInt(e[3],10);""===e[4]?(f.start2--,f.length2=1):"0"==e[4]?f.length2=0:(f.start2--,f.length2=
+parseInt(e[4],10));for(c++;c<a.length;){e=a[c].charAt(0);try{var g=decodeURI(a[c].substring(1))}catch(h){throw Error("Illegal escape in patch_fromText: "+g);}if("-"==e)f.diffs.push([-1,g]);else if("+"==e)f.diffs.push([1,g]);else if(" "==e)f.diffs.push([0,g]);else if("@"==e)break;else if(""!==e)throw Error('Invalid patch mode "'+e+'" in: '+g);c++}}return b};diff_match_patch.patch_obj=function(){this.diffs=[];this.start2=this.start1=null;this.length2=this.length1=0};
+diff_match_patch.patch_obj.prototype.toString=function(){var a,b;a=0===this.length1?this.start1+",0":1==this.length1?this.start1+1:this.start1+1+","+this.length1;b=0===this.length2?this.start2+",0":1==this.length2?this.start2+1:this.start2+1+","+this.length2;a=["@@ -"+a+" +"+b+" @@\n"];var c;for(b=0;b<this.diffs.length;b++){switch(this.diffs[b][0]){case 1:c="+";break;case -1:c="-";break;case 0:c=" "}a[b+1]=c+encodeURI(this.diffs[b][1])+"\n"}return a.join("").replace(/%20/g," ")};
+this.diff_match_patch=diff_match_patch;this.DIFF_DELETE=-1;this.DIFF_INSERT=1;this.DIFF_EQUAL=0;})()

Modified: spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/partitioner.js	Fri May 25 02:24:00 2012	(r24868)
@@ -2,10 +2,154 @@
  * This contains logic to decide whether to calc stuff locally or remotely.
  */
 
-this.delegateWork = function()
+var Partitioner = {};
+
+Partitioner.partitionerIsRunningAJob = false;
+Partitioner.delegatedMode = -1;
+Partitioner.startTimerunningAJob;
+
+Partitioner.S2A_LOCAL_MODE=0;
+Partitioner.S2A_CLIENT_MODE_LOW_CPU_HIGH_BANDWIDTH=1;
+Partitioner.S2A_CLIENT_MODE_HIGH_CPU_LOW_BANDWIDTH=2;
+
+Partitioner.S2A_RUNCOUNT = [];
+Partitioner.S2A_RUNCOUNT[Partitioner.S2A_LOCAL_MODE] = 1;
+Partitioner.S2A_RUNCOUNT[Partitioner.S2A_CLIENT_MODE_LOW_CPU_HIGH_BANDWIDTH] = 1;
+Partitioner.S2A_RUNCOUNT[Partitioner.S2A_CLIENT_MODE_HIGH_CPU_LOW_BANDWIDTH] = 1;
+Partitioner.S2A_RUNTIME = [];
+Partitioner.S2A_RUNTIME[Partitioner.S2A_LOCAL_MODE] = 1;
+Partitioner.S2A_RUNTIME[Partitioner.S2A_CLIENT_MODE_LOW_CPU_HIGH_BANDWIDTH] = 1;
+Partitioner.S2A_RUNTIME[Partitioner.S2A_CLIENT_MODE_HIGH_CPU_LOW_BANDWIDTH] = 1;
+
+
+Partitioner.delegateWork = function(doc)
 {
-	if (false)
-		this.s2alocal();
+	var DEBUG = false;
+	if (!DEBUG)
+	{
+		Partitioner.handleDelegationOfWork(doc);
+	}
 	else
-		this.s2aclient();
+	{
+		Partitioner.partitionerIsRunningAJob = true;
+		Partitioner.delegatedMode = 0;
+		
+		//Comment out a line here to make sure only that strategy is used in stead of letting the client-server-partitioner determine the fastest.
+		//S2ALocal.s2alocal(doc);
+		//S2AClient.s2aclient(doc, false);
+		S2AClient.s2aclient(doc, true);
+	}
+}
+
+
+Partitioner.handleDelegationOfWork = function(doc)
+{
+	console.log("delegateWork");
+	if (Partitioner.partitionerIsRunningAJob)
+	{
+		console.log("Busy with last request");
+		return;
+	}
+	Partitioner.partitionerIsRunningAJob = true;
+	Partitioner.startTimerunningAJob = new Date().getTime();
+	Partitioner.delegatedMode = Partitioner.determineMode(); 
+	try
+	{
+		console.log("Client/Server Partitioner will run mode: " + Partitioner.delegatedMode);
+		switch (Partitioner.delegatedMode)
+		{
+			case Partitioner.S2A_LOCAL_MODE:
+				S2ALocal.s2alocal(doc);
+				Partitioner.WorkIsDone();//synchronous
+				break;
+			case Partitioner.S2A_CLIENT_MODE_LOW_CPU_HIGH_BANDWIDTH:
+				S2AClient.s2aclient(doc, false);//asynchronous
+				break;
+			case Partitioner.S2A_CLIENT_MODE_HIGH_CPU_LOW_BANDWIDTH:
+				S2AClient.s2aclient(doc, true);//asynchronous
+				break;
+			default:
+				throw "Mode: '"+mode+"' not defined " + S2A_CLIENT_MODE_HIGH_CPU_LOW_BANDWIDTH;
+		}
+	} catch (err)
+	{
+		console.log("ERROR");
+		console.log(err);
+		
+		Partitioner.S2A_RUNTIME[Partitioner.delegatedMode] += 9999; //penalty for crashing methods
+		Partitioner.partitionerIsRunningAJob = false;
+	}
+}
+
+Partitioner.ModeCrashed = function()
+{
+	console.log("ModeCrashed ; working=" + Partitioner.partitionerIsRunningAJob );
+	if (Partitioner.partitionerIsRunningAJob === false)
+	{
+		console.log("ModeCrashed called but not in a working state!");
+		return;
+	}
+	Partitioner.S2A_RUNTIME[Partitioner.delegatedMode] += 200; //penalty for crashing. won't use for some time.
+	Partitioner.S2A_RUNCOUNT[Partitioner.delegatedMode]++;
+	Partitioner.partitionerIsRunningAJob = false;
+}
+
+Partitioner.StillLoading = function()
+{
+	console.log("StillLoading ; working=" + Partitioner.partitionerIsRunningAJob );
+	if (Partitioner.partitionerIsRunningAJob === false)
+	{
+		console.log("StillLoading called but not in a working state!");
+		return;
+	}
+	Partitioner.S2A_RUNTIME[Partitioner.delegatedMode] += 100;
+	Partitioner.S2A_RUNCOUNT[Partitioner.delegatedMode]++;
+	Partitioner.partitionerIsRunningAJob = false;
+}
+
+Partitioner.WorkIsDone = function()
+{
+	console.log("WorkIsDone ; working=" + Partitioner.partitionerIsRunningAJob );
+	if (!Partitioner.partitionerIsRunningAJob)
+	{
+		console.log("WorkIsDone called but not in a working state!");
+		return;
+	}
+	
+	var elapsed = (new Date().getTime()) - Partitioner.startTimerunningAJob;
+	
+	if (Partitioner.S2A_RUNCOUNT[Partitioner.delegatedMode] === 1)
+	{
+		Partitioner.S2A_RUNCOUNT[Partitioner.delegatedMode] = 2;
+		Partitioner.S2A_RUNTIME[Partitioner.delegatedMode] = 2;
+	} else
+	{
+		//Ignore first go to make sure there is no penalty for a parse table cache etc.
+		Partitioner.S2A_RUNCOUNT[Partitioner.delegatedMode]++;
+		Partitioner.S2A_RUNTIME[Partitioner.delegatedMode] += elapsed;
+	}
+	Partitioner.delegatedMode = -1;
+	Partitioner.partitionerIsRunningAJob = false;	
+}
+
+Partitioner.determineMode = function()
+{
+	//get best average speed - also vaporizes previous results so occasionally each option gets a try
+	var result;
+	var bestAvg = Infinity;
+	for (mode in Partitioner.S2A_RUNCOUNT)
+	{
+		if (Partitioner.S2A_RUNTIME[mode] > 1000)
+			Partitioner.S2A_RUNTIME[mode] -= 100;
+		
+		var avg = Number(Partitioner.S2A_RUNTIME[mode]) / Number(Partitioner.S2A_RUNCOUNT[mode]);
+		if (avg <= bestAvg)
+		{
+			bestAvg = avg;
+			result = mode;
+		}
+		console.log("Mode:"+ mode + " " + avg + "/" + bestAvg + " Current result: " + result);
+	}
+	console.log("determineMode -> " + result);
+	return Number(result);
 }
\ No newline at end of file

Modified: spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/s2aclient.js	Fri May 25 02:24:00 2012	(r24868)
@@ -1,64 +1,183 @@
 
-var s2aclient_loading=false;
-var s2aclient_loaded=false;
-var s2aclient_start;
-
-this.s2aclient = function() {
-	console.log("s2aclient");
-	if (!s2aclient_loaded)
-	{
-		sender.emit("log", "Not yet loaded...");
-		if (!s2aclient_loading)
-		{
-			s2aclient_loading = true;
-			s2awebsocket.connect();
-			s2aclient_loaded = true;
-			s2aclient_loading = false;
+var S2AClient = {};
+S2AClient.S2A_FULL_MESSAGE = "0";
+S2AClient.S2A_DIFF_PATCH_MESSAGE = "1";
+S2AClient.s2aclient_loading=false;
+S2AClient.s2aclient_loaded=false;
+S2AClient.s2aclient_start;
+S2AClient.dmp;
+S2AClient.s2aclient_lastknownsrc="";
+S2AClient.s2aclient_lastknowntokenstring="";
+
+//debuglog = function(str) { console.log(str); }
+debuglog = function(str) {}
+
+
+
+S2AClient.s2aclient = function(pDoc, lowBandWidth) {
+	debuglog("s2aclient");
+	if (!S2AClient.s2aclient_loaded || !S2AClient.s2awebsocket.connected())
+	{
+		sender.emit("log", "Loading or reconnecting");
+		if (!S2AClient.s2aclient_loading)
+		{
+			S2AClient.s2aclient_loading = true;
+			S2AClient.dmp = new diff_match_patch();
+			S2AClient.s2awebsocket.connect(S2AClient.ProcessS2AServerRawResponse);
+			S2AClient.s2aclient_lastknownsrc = "";
+			S2AClient.s2aclient_lastknowntokenstring = "";
+			S2AClient.s2aclient_loaded = true;
+			S2AClient.s2aclient_loading = false;
 		}
+		Partitioner.StillLoading();
 		return;
 	}
-    	if (working)
-    	{
-	        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
-    		goAgain = true; 
-    		return;
-    	}
-    	working = true;
-	var value = this.doc.getValue();
-	s2aclient_start = new Date().getTime();
+	var value = pDoc.getValue();
+	S2AClient.s2aclient_start = new Date().getTime();
 	
-	s2awebsocket.send(value);
-
-	working = false;
-	if (goAgain)
-		onUpdate();
+	if (!lowBandWidth)
+	{
+		S2AClient.s2awebsocket.send(S2AClient.S2A_FULL_MESSAGE+value);
+	}
+	else
+	{
+		var patch_text = '';
+		var diff = S2AClient.dmp.diff_main(S2AClient.s2aclient_lastknownsrc, value, true);
+		var patch_list = S2AClient.dmp.patch_make(S2AClient.s2aclient_lastknownsrc, value, diff);
+		patch_text = S2AClient.dmp.patch_toText(patch_list);
+		S2AClient.s2awebsocket.send(S2AClient.S2A_DIFF_PATCH_MESSAGE+patch_text);
+		S2AClient.s2aclient_lastknownsrc = value;
+	}
 }
 
-var updateTokens = function(x)
+S2AClient.updateTokens = function(x)
 {
   sender.emit("jsglr", x);
-  var elapsed = (new Date().getTime() - s2aclient_start);
+  var elapsed = (new Date().getTime() - S2AClient.s2aclient_start);
   sender.emit("log", "Full client-server cycle took: " +  elapsed + "ms");
-
 }
 
+S2AClient.ProcessS2AServerRawResponse = function(pResponseMsg)
+{
+	debuglog('ProcessS2AServerRawResponse');
+	if (!pResponseMsg.data)
+		return;
+	var pResponse = pResponseMsg.data;
+	
+	debuglog('Size of recieved message !: ' + pResponse.length);
+	//process recieved data
+	
+	var responseType = pResponse.substring(0, 1);
+	var response = pResponse.substring(1, pResponse.length);
 
+	var obj = {};
+	if (responseType === S2AClient.S2A_FULL_MESSAGE)
+	{
+		try
+		{
+			debuglog("response=" + response);
+			if (response == "Parse Error")
+			{
+				debuglog("Parse error");
+				Partitioner.ModeCrashed();
+				return;
+			}
+			obj = JSON.parse(response);
+		} catch (exception)
+		{
+			debuglog("json parse error in FULL Message");
+			debuglog(response);
+			debuglog(exception);
+		}
+	} else if (responseType === S2AClient.S2A_DIFF_PATCH_MESSAGE)
+	{
+		response = S2AClient.dmp.patch_apply(S2AClient.dmp.patch_fromText(response), S2AClient.s2aclient_lastknowntokenstring)[0];
+		S2AClient.s2aclient_lastknowntokenstring = response;
+		try
+		{
+			debuglog("response2=" + response);
+			if (response == "Parse Error")
+			{
+				debuglog("Parse error");
+				Partitioner.ModeCrashed();
+				return;
+			}
+			obj = JSON.parse(response);
+		} catch (exception)
+		{
+			debuglog("json parse error in Patched Message");
+			debuglog(response); 
+			debuglog(exception);
+			Partitioner.ModeCrashed();
+			return;
+		}
+		obj.parsed = [];
+		
+		var tokenLines = obj.parseme.split("\n");
+		//debuglog(lollo);
+		var start = new Date().getTime();
+		for (tokenLineID in tokenLines)
+		{
+			var tokenLine = tokenLines[tokenLineID];
+			var tokens = tokenLine.split(/\r\r/);
+			if (tokens.length === 0)
+				continue;
+				
+			obj.parsed[tokenLineID] = {};
+			obj.parsed[tokenLineID].text = "";
+			obj.parsed[tokenLineID].tokens = [];
+			
+			
+			for (tokenId in tokens)
+			{
+				var token = tokens[tokenId];
+				var tokenItems = token.split(/\r/);
+				if (tokenItems[1] === undefined)
+					continue;
+				obj.parsed[tokenLineID].text = obj.parsed[tokenLineID].text + tokenItems[0];
+				var x = 
+				{
+					 value:tokenItems[0],
+			         type:tokenItems[1],
+					 start:tokenItems[2],
+					 end:tokenItems[3],
+					 line:String(Number(tokenLineID)+1)
+				}
+				obj.parsed[tokenLineID].tokens.push(x);
+			}
+		}
+		debuglog("Time to traverse token string: " + ( new Date().getTime() - start));
+	} else
+	{
+		throw "Unrecognised message";
+	}
+	//debuglog(obj);
+	S2AClient.updateTokens(obj);
+	Partitioner.WorkIsDone();
+}
 
-var s2awebsocket = {
+var s2awebsocket_connected = false;
+S2AClient.s2awebsocket = {
+	connected : function() {
+		debuglog("Connected: "+ s2awebsocket_connected);
+		return (s2awebsocket_connected);
+	},
 	msgIdx : 0,
-	s2aserverurl : 'ws://richard.vogelij.nl:8080/s2aserver',
 	measuretimetoanswer : function() {
 		time = new Date().getTime();
 	},
-	connect : function() {
-		var location = s2awebsocket.s2aserverurl;
-		this._ws = new WebSocket(location);
+	connect : function(datacallback) {
+		debuglog("Connecting...");
+		var location = 'ws://richard.vogelij.nl:8080/s2aserver';
+		this._ws = ("undefined" !== typeof MozWebSocket) ? new MozWebSocket(location) : new WebSocket(location);//new WebSocket(location);
 		this._ws.onopen = this._onopen;
-		this._ws.onmessage = this._onmessage;
+		this._ws.onmessage = datacallback;//S2AClient._onmessage;
 		this._ws.onclose = this._onclose;
 	},
 	_onopen : function() {
-		s2awebsocket._send('websockets are open for communications!');
+		//s2awebsocket._send('websockets are open for communications!');
+		debuglog("Connected!");
+		s2awebsocket_connected = true;
 	},
 	_send : function(message) {
 		this.msgIdx++;
@@ -68,7 +187,6 @@
 		var length = message.length;
 		var fragmentcount = Math.ceil(length / MAXLEN);
 		var curfragment = 1;
-		
 		if (fragmentcount > 9999)
 		{
 			alert('data too large for protocol');
@@ -77,9 +195,9 @@
 		for (curfragment=1; curfragment < fragmentcount+1; curfragment++)
 		{
 			fragment = 
-				s2awebsocket.lz(this.msgIdx,4)+
-				s2awebsocket.lz(curfragment,4)+
-				s2awebsocket.lz(fragmentcount,4)+
+				this.lz(this.msgIdx,4)+
+				this.lz(curfragment,4)+
+				this.lz(fragmentcount,4)+
 				message.substring((curfragment-1)*MAXLEN, (curfragment)*MAXLEN);
 			if (this._ws)
 			{
@@ -89,38 +207,23 @@
 	},
 
 	send : function(text) {
-		
 		if (text != null && text.length > 0)
 		{
-			s2awebsocket._send(text);
+			this._send(text);
 		}
 	},
 
 	_onmessage : function(m) {
 		if (m.data) {
-			console.log('Size of recieved message: ' + m.data.length);
-			//process recieved data
-			if (m.data == "Parse Error")
-			{
-				console.log("Parse error");
-				return;
-			}
-				
-			var obj;
-			try
-			{
-				obj = JSON.parse(m.data);
-			} catch (exception)
-			{
-				console.log("json parse error");
-				console.log(m.data);
-				console.log(exception);
-			}
-			updateTokens(obj);
+			
+			//ProcessS2AServerRawResponse(m.data);
 		}
 	},
 	_onclose : function(m) {
 		this._ws = null;
+		debuglog("Disconnected!");
+		
+		s2awebsocket_connected = false;
 	},
 	lz : function(number, length) {
 			var str = '' + number;

Modified: spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/resources/javascript/s2alocal.js	Fri May 25 02:24:00 2012	(r24868)
@@ -1,48 +1,54 @@
+var S2ALocal = {};
+S2ALocal.s2alocal_loading=false;
+S2ALocal.s2alocal_loaded=false;
+S2ALocal.s2alocal_analyzer=null;
 
-var s2alocal_loading=false;
-var s2alocal_loaded=false;
-var s2alocal_analyzer=null;
-
-this.s2alocal = function() {
+S2ALocal.s2alocal = function(doc) {
 	console.log("s2alocal");
-    if (!s2alocal_loaded)
+    if (!S2ALocal.s2alocal_loaded)
     {
+    	Partitioner.StillLoading();
 		sender.emit("log", "Not yet loaded...");
-		if (!s2alocal_loading)
+		if (!S2ALocal.s2alocal_loading)
 		{
-			s2alocal_loading = true;
-			var start = new Date().getTime();
-			s2alocal_analyzer = StrategoJS.init();
-			s2alocal_loaded = true;
-			s2alocal_loading = false;
-			var elapsed = (new Date().getTime() - start);
-		    sender.emit("log", "loaded. (" +  elapsed + ")");
-		    this.s2alocal();
+			sender.emit("log", "Loading..");
+			try
+			{
+				S2ALocal.s2alocal_loading = true;
+				var start = new Date().getTime();
+				S2ALocal.s2alocal_analyzer = StrategoJS.init();
+				S2ALocal.s2alocal_loaded = true;
+				S2ALocal.s2alocal_loading = false;
+				var elapsed = (new Date().getTime() - start);
+			    sender.emit("log", "loaded. (" +  elapsed + ")");
+			} catch (err) {}
 		}
+		sender.emit("log", "WAT!");
+	}
+	if (working)
+	{
+        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
+		goAgain = true; 
 		return;
 	}
-    	if (working)
-    	{
-	        sender.emit("log", "spoofax2ace_worker.onUpdate Busy with last task. finishing...");
-    		goAgain = true; 
-    		return;
-    	}
-    	working = true;
-    	goAgain = false;
+	working = true;
+	goAgain = false;
 	sender.emit("log", "spoofax2ace_worker.onUpdate enter");
 	var analyze_start = new Date().getTime();
-	var value = this.doc.getValue();
+	var value = doc.getValue();
 	value = value.replace(/^#!.*\n/, "\n");
 	var result = null;
 	try
 	{
-		result = s2alocal_analyzer.main(["aap", value]);
+		result = S2ALocal.s2alocal_analyzer.main(["aap", value]);
 	}
 	catch (exception)
 	{
 		sender.emit("log", "Error while analyzing: " + exception.message);
 		sender.emit("log", "Stack: " + exception.stack);
-		debugger;
+		working = false;
+		Partitioner.ModeCrashed();
+		return;
 	}
 
 
@@ -74,5 +80,5 @@
 	sender.emit("log", "spoofax2ace_worker.onUpdate exit");
 	working = false;
 	if (goAgain)
-		this.s2alocal();
+		S2ALocal.s2alocal();
 }

Modified: spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java
==============================================================================
--- spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java	Thu May 24 15:23:00 2012	(r24867)
+++ spoofax-ace/trunk/spoofax-ace/src/spoofax/ace/generate/javascript/S2AJSGenerator.java	Fri May 25 02:24:00 2012	(r24868)
@@ -157,6 +157,7 @@
 			S2AUtils.WriteResourceToStream(getClass(), "/javascript/aceworker/worker-spoofax2ace-prepend-new.js", wrappedAceWorkerStrm);
 			S2AUtils.WriteResourceToStream(getClass(), "/javascript/partitioner.js", wrappedAceWorkerStrm);
 			S2AUtils.WriteResourceToStream(getClass(), "/javascript/s2aclient.js", wrappedAceWorkerStrm);
+			S2AUtils.WriteResourceToStream(getClass(), "/javascript/diff/diff_match_patch.js", wrappedAceWorkerStrm);			
 			S2AUtils.WriteResourceToStream(getClass(), "/javascript/s2alocal.js", wrappedAceWorkerStrm);
 			S2AUtils.WriteResourceToStream(getClass(), "/javascript/stats.js", wrappedAceWorkerStrm);
 			S2AUtils.WriteFileToStream(wrappedStrprog, wrappedAceWorkerStrm);


From gabrielkonat at gmail.com  Fri May 25 11:23:46 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 25 May 2012 09:23:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24869 -
	spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib
Message-ID: <20120525092346.6E8C77F8026@mx1.tudelft.nl>

Author: gkonat
Date: Fri May 25 09:23:46 2012
New Revision: 24869
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24869&sc=1

Log:
Add generated files.

Added:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-library-internal.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-library.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/compilation-library.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/index-library.generated.str

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-auto.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-auto.generated.str	Fri May 25 09:23:46 2012	(r24869)
@@ -0,0 +1,18 @@
+module lib/analysis-auto.generated
+
+signature
+  constructors
+    
+
+
+imports
+  include/SDF
+
+
+rules
+
+  nam-get-def(|n) =
+    fail
+
+  nam-annotate-use(|n) =
+    fail
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-library-internal.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-library-internal.generated.str	Fri May 25 09:23:46 2012	(r24869)
@@ -0,0 +1,731 @@
+module lib/analysis-library-internal.generated
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library.generated
+  lib/index-library.generated
+  
+signature constructors
+  
+  // Analysis
+  Results         : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
+  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
+  
+  // Namespaces
+  Diff            : Namespace
+  ASTDiff         : Namespace
+  
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
+   */
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
+    with
+      // Init
+      index-setup(|language, [project-path], full-path);
+      revision := <index-start-transaction>
+    with
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
+    with
+      {| Index-UnresolvedSet:
+        unresolvedSet := <new-iset>;
+        rules(Index-UnresolvedSet: _ -> unresolvedSet);
+        
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+        (asts, _) := <unzip> astFilePairs4
+      |}
+    with
+      index-end-transaction
+    with
+      // Schedule re-analysis of dependent files (if current file is not testing language file)
+      // HACK: Depends on file extension, could be other languages with .spt extension?
+      if Editor() := phase; not(<is-test-file> full-path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
+        
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
+        // Store files that have changed in the index
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
+      end
+    with
+      <list-loop(analyze-top-store-ast)> astFilePairs4
+      
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
+    with
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> Some(ast); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
+      
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Gather all data for each definition.
+        ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|<conc> (<index-file-to-uri> file, ["ast"]))> ast
+      
+  /**
+   * Identifies all definitions in the tree and annotates them with their URI.
+   * Also annotates uses with a preliminary "Unresolved(_)" URI.
+   *
+   * @internal
+   */
+  analyze-defs = analyze-defs(|Anon(), Anon())
+  /** @internal */
+  analyze-defs(|head-scope, head-scope-ns):
+    ast -> (ast', defs')
+    with
+      if def := <nam-get-definition> ast then
+        Def(def-path)                     := def;
+        [head-scope-ns', head-scope' | _] := def-path
+      else
+        def-path       := INTERNAL_ERROR();
+        head-scope-ns' := head-scope-ns;
+        head-scope'    := head-scope
+      end;
+      if scope-types := <nam-get-scope-types> ast then
+        {| IndexPath:
+          <list-loop(update-index-path(|head-scope', head-scope-ns', ast))> scope-types;
+          // <balanced-update-path> head-scope';
+          (ast', defs) := <analyze-defs-recurse(|Anon(), Anon(), def-path)> ast
+        |}
+      else
+        (ast', defs) := <analyze-defs-recurse(|head-scope', head-scope-ns', def-path)> ast
+      end;
+      defs' := <![def | defs] <+ !defs>
+      
+  /** @internal */
+  analyze-defs-recurse(|head-scope, head-scope-ns, def-path):
+    ast -> (ast'', defs)
+    where
+      analyzed      := <all(analyze-defs(|head-scope, head-scope-ns))> ast;
+      (ast', defs)  := <unzip-analyzed> analyzed;
+      ast''         := <try(nam-annotate-names(|def-path))> ast'
+ 
+  /** @internal */
+  update-index-path(|head-scope, head-scope-ns, ast):
+    scope-type -> scope-type
+    where
+      if !head-scope-ns => Anon() then
+        path  := <IndexPath <+ ![]> scope-type;
+        path' := <do-adjusted-index-path(|scope-type, path, Anon(<new>))> ast
+      else
+        path  := <IndexPath <+ ![]> head-scope-ns;
+        path' := <do-adjusted-index-path(|scope-type, path, head-scope)> ast
+      end;
+      rules(IndexPath: scope-type -> path')
+ 
+  /* TODO: consider using simple-update-def-path
+   *       which uses "balanced" path scopes
+   *       e.g. when Entity doesn't scope Function
+   *       then it's hard to access properties from a function
+  balanced-update-index-path:
+    head-scope -> head-scope
+    where
+      if !head-scope => Anon() then
+        head-scope' := Anon(<new>)
+      else
+        head-scope' := head-scope
+      end;
+      (something with do-adjust-path)
+      rules(IndexPath := [head-scope' | <IndexPath <+ ![]> ()])
+  */
+ 
+  /**
+   * Analyze all uses, changing their preliminary "Unresolved(_)" URI to a definite URI of their definition.
+   *
+   * @internal
+   */
+  analyze-uses:
+    ast -> (ast'', uses')
+    with
+      analyzed     := <all(analyze-uses)> ast;
+      (ast', uses) := <unzip-analyzed> analyzed;
+      if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
+        if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
+          ast'' := ast{def-uri};
+          uses' := [Use(def-uri) | uses]
+        else
+          ast'' := ast';
+          uses' := [BadUse([namespace, x]) | uses]
+        end
+      else
+        ast'' := ast';
+        uses' := uses
+      end
+ 
+  /**
+   * Collects all index data (e.g. types of definitions).
+   *
+   * @internal
+   */
+  analyze-tree-data:
+    tree -> data
+    where
+      set := <new-iset>;
+      <topdown(analyze-tree-data-part(|set))> tree;
+      data := <iset-elements> set
+      
+  /** @internal */
+  analyze-tree-data-part(|set):
+    tree -> tree
+    where
+      if def-term := <nam-get-definition-key> then
+        _{[namespace | path]} := def-term;
+        if result := <adjust-index-def-data(store-index-data-results(|set) |namespace, path)> tree then
+          <fatal-err(|"Unexpected result from adjust-index-def-data; should call <store-results>")> result
+        end
+      end
+  
+  /** @internal */
+  store-index-data-results(|set):
+    t -> <fail>
+    where
+      if is-list then
+        <iset-addlist(|t)> set
+      else
+        <iset-add(|t)> set
+      end
+      
+rules // Parallel analysis
+  
+  /** @internal */
+  index-parallel-analyze(analyze):
+    files -> allResults
+    with
+      map(index-parse-file); // Parsing cannot be done in parallel.
+      map(\(ast, file) -> (ast, file, <project-path>)\);
+      parallel-unordered(all(index-analyze(analyze)));
+      ?results;
+      with(<eq> (<length> results, <length> files) | "Input size not equal to output size");
+      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
+      if not([] := filesToAnalyze) then
+        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
+      else
+        allResults := results
+      end
+  
+  /** @internal */   
+  index-parse-file:
+    file -> (ast, file)
+    with
+    if <file-exists> file then
+      ast := <parse-file> file
+    else
+      ast := ()
+    end
+   
+  /** @internal */   
+  index-set-markers:
+    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
+    with
+      <set-markers(|ast)> (ast', errors, warnings, notes)
+      
+  /** @internal */
+  index-analyze(analyze):
+    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
+    with
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      if [] := filesToAnalyze then
+        complete-work-unit
+      end
+      
+/** @internal */
+rules // Splitter
+  
+  /** @internal */
+  index-split = fail
+  /** @internal */
+  index-is-toplevel = fail
+  /** @internal */
+  index-is-qualifier = fail
+  /** @internal */
+  index-qualifier-subelements = fail
+  /** @internal */
+  index-create-qualifier(|qualifier) = fail
+  
+  /** @internal */
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  /** @internal */
+  index-toplevel-split-internal:
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, <index-uri> <nam-get-definition-key> node)]
+        otherwise:
+          units := [(node, [])]
+      end
+      
+  /** @internal */
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      qualifier := <index-create-qualifier(|node)> elem
+
+/** @internal */
+rules // Diffs
+  
+  /** @internal */
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+    
+  /** @internal */
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
+    with
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      
+      // Files to analyze
+      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
+      analyzeFiles' := analyzeFiles;
+      // TODO: Is this extra check needed?
+      /*if <getfirst(index-get-file-revision; \r -> (r, revision)\; gt)> analyzeFiles then
+        // Add current file if the current file has read information from another file with a higher revision.
+        // This indicates that potentially outdated information was read.
+        analyzeFiles' := [file|analyzeFiles]
+      else
+        analyzeFiles' := analyzeFiles
+      end;*/
+      
+      // Files to compile
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      <map(analyze-add-compilediff)> compileFiles
+      
+  /** 
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
+   *
+   * @internal
+   */
+  analyze-astdiff:
+    (ast, file) -> file
+    where
+      name := <conc> (<index-file-to-uri> file, ["ast-checksum"]);
+      newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-global(|name)> then
+        <index-set-global(|name)> newChecksum;
+        not(<eq> (oldChecksum, newChecksum))
+      else
+        <index-set-global(|name)> newChecksum
+      end
+      
+  /** 
+   * Adds given file to the list of files to compile.
+   *
+   * @internal
+   */
+  analyze-add-compilediff = index-add-global(|"compile-diff")
+  
+  /** 
+   * Gets the list of files to compile, and then clear it.
+   *
+   * @internal
+   */
+  analyze-get-compilediffs = index-get-all-globals(|"compile-diff"); index-clear-global(|"compile-diff")
+  
+rules // Index lookup rules (that take into account adjust-index-lookup)
+  
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> def
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      if <?StopLookup()> candidates then
+        fail
+      else
+        def        := <index-select(|namespace, path, x)>
+      <+
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        def         := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
+      end
+
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> defs'
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      defs       := <index-select-all(|namespace, path, x)>;
+      // TODO: optimize: try not to call do-adjust-index-lookup from here
+      if [_ | path'] := path then
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
+        defs' := <conc> (defs, defs2)
+      else
+        defs' := defs
+      end
+      
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   * @internal
+   */
+  index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> def
+    where
+      // TODO: optimize: just like index-lookup
+      [_ | path'] := path;
+      def         := <index-lookup-outermost(is-adjust-lookup-enabled |namespace, path', prefix)> x
+    <+
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      def        := <index-select(|namespace, path, x)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
+    x{_} -> defs
+    with
+      is-adjusted-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        defs := StopLookup()
+      else
+        mapconcat(\d at Def(p) -> [d]\
+          <+ \[namespace' | path'] -> <index-lookup-one-level(fail |namespace', path', prefix)> x\
+          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?defs
+      end
+    <+
+      defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
+    x{_} -> all-defs
+    with
+      is-adjust-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        all-defs := []
+      else
+        mapconcat(\d at Def(p) -> [d]\
+            <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
+            <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?all-defs
+      end
+    <+
+      one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
+      if [_ | path'] := path then
+        all-defs := <concat> [one-level, <index-lookup-all-levels(fail |namespace, path', prefix)> x]
+      else
+        all-defs := one-level
+      end
+      
+/** @internal */
+rules // URI and value projections
+       
+  /** @internal */
+  index-uri-impl:
+    Def(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Use(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Read(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
+ 
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
+  index-uri-impl:
+    ReadWildcard(uri, _) -> uri
+
+  /** @internal */
+  index-value-impl:
+    Def(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Use(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Read(value) -> value
+  
+  /** @internal */
+  index-value-impl:
+    ReadWildcard(_, value) -> value
+       
+/** @internal */
+rules // Internal helpers
+
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\(a, _) -> a\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
+       
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+    string-ends-with(|".spt")
+  /** @internal */
+  is-test-language = 
+    ?"Spoofax-Testing"
+  /** @internal */
+  is-test-input(|language, path) = 
+    <is-test-language> language <+ <is-test-file> path
+      
+  /** @internal */
+  fake-file = 
+    is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+    Fst; string-replace(|$[[<project-path>]/], "")
+  
+  /** @internal */
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uri))
+  
+  /** @internal */     
+  index-is-name-substring(|name):
+    template -> <id>
+    with
+      [_, uri-name | _] := <index-uri>
+    where
+      <is-substring(!name)> uri-name
+   
+  /** @internal */    
+  index-readwildcard-substring(|prefix):
+    ReadWildcard(_, name) -> <id>
+    where <is-substring(!prefix)> name
+  
+  /** @internal */  
+  store-wildcard-read(|namespace, path, prefix):
+    children -> <id>
+    with
+      if set := <Index-ReadSet> then
+        if 1 := <length> children then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix))> set
+        end
+      end
+  
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
+  index-file-dependent-construct: 
+    uri -> <conc> (uses, reads)
+    with
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+ 
+  /** @internal */
+  do-adjust-index-lookup(|namespace, path, use, prefix) =
+    repeat-until(
+      prim("SSL_EXT_get_parent", <id>)
+    , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
+    )
+ 
+  /** @internal */
+  index-select(|namespace, path, use) =
+    getfirst(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  index-select-all(|namespace, path, use) =
+    filter(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  do-adjusted-index-path(|namespace, path, def) =
+    adjust-index-path(origin-equal(|def) |namespace, path)
+  <+
+    ![def | path]
+ 
+  /** @internal */
+  index-eq(|namespace, expected) =
+    where(
+      ?Def([_, name | _]);
+      <SRTS-EXT-eq-ignore-annos(|expected)> name
+    )
+  
+  /** @internal */
+  external SRTS-EXT-eq-ignore-annos(|t)
+  
+  /** @internal */
+  index-key-unwrap = 
+    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
+    
+/** @internal */
+rules // Interface for generated code
+ 
+  /** @internal */
+  nam-get-def(|namespace):
+    x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
+  
+  /** @internal */ 
+  nam-annotate-use(|namespace):
+    t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
+  
+  /** @internal */ 
+  nam-get-scope-types = fail
+  /** @internal */
+  nam-get-definition = fail
+  /** @internal */
+  nam-get-definition-key = fail
+  /** @internal */
+  nam-annotate-names(|def-path) = fail

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/analysis-library.generated.str	Fri May 25 09:23:46 2012	(r24869)
@@ -0,0 +1,563 @@
+module lib/analysis-library.generated
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library-internal.generated
+  lib/index-library.generated
+ 
+signature constructors
+ 
+  // Analyze constructors
+  Editor      : AnalysisPhase
+  Compile     : AnalysisPhase
+ 
+  // Index elements
+  Def          : List(UriPart) -> Summary
+  Use          : List(UriPart) -> Summary
+  BadUse       : List(UriPart) -> Summary
+  Read         : List(UriPart) -> Summary
+  ReadWildcard : List(UriPart) * String -> Summary
+  Diff         : List(UriPart) * List(Summary) -> Summary
+  
+  // Adjust lookup actions
+  StopLookup   : LookupAction
+  
+rules // Index analysis extension points
+ 
+  /**
+   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
+   *
+   * The overriden rule must return a list that contains any of the following items:
+   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
+   *                        use site to this definition.
+   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
+   * 
+   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
+   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
+   * will be used.
+   *
+   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
+   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
+   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
+   * lookups that will always fail anyway.
+   *
+   * Extension example:
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     PropAccess(exp, name) -> properties
+   *     where
+   *       <check-target-name> name
+   *     with
+   *       if TYPE(type{_}) := <type-of> exp then
+   *         properties := <index-lookup-children(|Property(), prefix)> type
+   *       else
+   *         properties := StopLookup()
+   *       end
+   *
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     Var(name) -> [[Var() | path], [Property() | path]]
+   *     where
+   *       <check-target-name> name
+   *
+   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
+   *                            lookup algorithm is looking for.
+   * @param namespace           The namespace of the element that should be looked up.
+   * @param path                The path the lookup algorithm is currently looking at for the element.
+   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
+   *                            full name of the element, but could be a partial prefix during content completion.
+   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
+   */
+  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
+  
+  /** 
+   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
+   * a (list of) data that must be stored in the index.
+   *
+   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
+   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
+   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
+   * rule fail if you are doing a <filter(store-results)> for example.
+   *
+   * Extension example:
+   *   adjust-index-def-data(store-results|namespace, path):
+   *     def -> <store-results> Type([namespace|path], type)
+   *     where
+   *       type := <type-of> def
+   *
+   * @param store-results Call this on the data you want to store in the index.
+   * @param namespace     The namespace of the definition that the rule is being called on.
+   * @param path          The path of the definition that the rule is being called on.
+   * @type def -> fail 
+   */
+  adjust-index-def-data(store-results|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
+   * use sites. Should return a path that will be assigned to the definition or use site.
+   *
+   * Extension example:
+   *   adjust-index-path(check-target-definition|namespace, path):
+   *     Start(_, _) -> [<string-replace(|<project-path>, "")> <Fst> <index-get-current-file>]
+   *
+   *
+   * @param check-target-definition 
+   * @param namespace               The namespace that would be given to the current definition or use site.
+   * @param path                    The path that would be given to the current definition or use site.
+   * @type def -> uri@[namespace|path]
+   */
+  adjust-index-path(check-target-definition|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
+   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
+   *
+   * Extension example:
+   *   index-diff-constructors = ?Type(_, _)
+   *
+   * @type a -> ?a
+   *
+   * @see index-diff-compare
+   */
+  index-diff-constructors = 
+    ?Def(_)
+  
+  /**
+   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
+   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
+   * compared.
+   *
+   * Extension example:
+   *   index-diff-compare:
+   *     (Type(u1, v1), Type(u2, v2)) -> <id>
+   *     where
+   *       <index-uri-eq> (u1, u2);
+   *       <eq> (v1, v2)
+   *
+   * @type (a, b) -> ?(a, b)
+   *
+   * @see index-diff-constructors
+   */
+  index-diff-compare:
+    (Def(u1), Def(u2)) -> <id>
+    where
+       <index-uri-eq> (u1, u2)
+ 
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Defaults to Editor() phase.
+   *
+   * @param language  The name of the language that is being analysed.
+   *
+   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top(|phase, language)
+   */
+  analyze-top(|language):
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
+   
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @param phase         The type of analysis phase. There are 2 phases to choose from:
+   *                      - Editor():   File dependencies are analysed.
+   *                      - Compile():  File dependencies are not analysed.
+   * @param language      The name of the language that is being analysed.
+   * @param path          The path of the file to analyze relative to project-path.
+   * @param project-path  The path of the directory that contains all the source files.
+   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top-internal(|phase, language, project-path, full-path)
+   */
+  analyze-top(|phase, language, path, project-path):
+    ast -> (ast', filesToAnalyze)
+    with
+      full-path := $[[project-path]/[path]];
+      if index-split then
+        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
+        asts := <index-toplevel-split> ast;
+        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
+      else
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, (full-path, []))]
+      end
+  
+rules // Parallel analysis
+  
+  /**
+   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
+   * analysis of dependent files that have changed during the analysis.
+   *
+   * Example:
+   *   <index-parallel-analyze-files(analyze)> ["text/file1.ext", "text/file2.ext"]
+   *
+   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
+   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
+   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @type List((file, subfile) or file) -> None()
+   */
+  index-parallel-analyze-files(analyze):
+    files -> None()
+    with
+      length; 
+      set-total-work-units
+    with
+      index-parallel-analyze(analyze);
+      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
+ 
+rules // Query primitives
+ 
+  /**
+   * Gets all DefData entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data(|Type())> Def([Entity(), "Bar"]) => [DefData([Entity(), "Bar"], Type(), TYPE("Bar")), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(DefData(uri, kind, value))
+   */
+  index-get-data(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
+      
+  /**
+   * Gets all data entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(value)
+   */
+  index-get-data-all(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
+     
+  /**
+   * Gets all Use entries that match the URI in given definition.
+   *
+   * Example:
+   *   <index-get-uses-all> Def([Entity(), "M", "Bar"]) => [Use([Entity(), "M", "Bar"]), ...]
+   *
+   * @type Def(uri) -> List(Use(uri))
+   */
+  index-get-uses-all:
+    <with(?Def(uri) | "Def expected")> -> <index-get-all> Use(uri)
+     
+  /**
+   * Gets all Read or ReadWildcard entries that match the given template.
+   *
+   * Example:
+   *   <index-get-reads-all> [Property(), "Bar", "p"] => [Read([Property(), "Bar", "p"]), ...]
+   *
+   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
+   */
+  index-get-reads-all:
+    template -> <conc> (reads, readwildcards')
+    where
+      uri   := <index-uri> template;
+      reads := <index-get-all> Read(uri);
+      if !uri => [namespace, prefix | path-parent] then
+        readwildcards  := <index-get-all> ReadWildcard([namespace | path-parent], ());
+        readwildcards' := <filter(index-readwildcard-substring(|prefix))> readwildcards
+      else
+        readwildcards' := []
+      end
+ 
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  index-get-all:
+    template -> <indexlib-get-all> template
+      with
+       if set := <Index-ReadSet> then
+         uri := <index-uri>;
+         <iset-add(|Read(uri))> set
+       end
+       
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  index-get-all-values:
+    template -> <map(index-value)> <index-get-all> template
+       
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
+   */
+  index-get:
+    template -> <?[<id>|_]> <index-get-all> template
+      
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  index-get-value:
+    template -> <index-value> <?[<id>|_]> <index-get-all> template
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field())> Def([Entity(), "Baz"]) => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field())> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field())> [Entity(), "Baz"] => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace) = 
+    index-get-children(\uri -> Def(uri)\|namespace)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children
+    with
+      template  := <construct-template> [namespace | path];
+      children  := <prim("LANG_index_get_children", template)>;
+      <store-wildcard-read(|namespace, path, "")> children
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field(), "fo")> Def([Entity(), "Baz"]) => [Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field(), "ba")> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), ...]
+   *   <index-get-children(|Field(), "ze")> [Entity(), "Baz"] => [...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace, prefix) = 
+    index-get-children(\uri -> Def(uri)\|namespace, prefix)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
+   * using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @param prefix              Only child elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace, prefix):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children'
+    with
+      prefix'   := <strip-annos> prefix;
+      template  := <construct-template> [namespace | path];
+      children  := <prim("LANG_index_get_children", template)>;
+      children' := <filter(index-is-name-substring(|prefix'))> children;
+      <store-wildcard-read(|namespace, path, prefix')> children'
+
+  /**
+   * Gets a set of all files that have a reference to the given index entries.
+   *
+   * Example:
+   *   <index-get-referenced-files(\uri -> [Read(uri), Use(uri, [])]\)> [Def([Entity(), "Bar"]), ...] => 
+   *     [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
+   *                            constructs from all given entries, such as \uri -> [Read(uri), Use(uri, [])]\
+   * @type List(elem) -> List((file, subfile))
+   */
+  index-get-referenced-files(construct-from-uri):
+    entries -> files
+    where
+      uris        := <filter(index-uri)> entries;
+      referenced  := <concat> <filter(construct-from-uri)> uris;
+      files       := <iset-elements> <iset-addlist(|<mapconcat(index-get-files-of)> referenced)> <new-iset>
+ 
+  /**
+   * Convenience function for finding files with Read and Use dependencies to the given definitions.
+   *
+   * Example:
+   *   <index-get-dependent-files> [Def([Entity(), "Bar"]), ...] => [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @type List(elem) -> List((file, subfile))
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
+   */
+  index-get-dependent-files = 
+    index-get-referenced-files(index-file-dependent-construct)
+     
+rules // Index lookup rules (that take into account adjust-index-lookup)
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning its Def.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup:
+    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   * 
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all:
+    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup-outermost(|prefix):
+    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, returns Defs that have the same parent URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-one-level(|prefix):
+    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(|prefix):
+    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-one-level(id|namespace, def-path, prefix)> x
+      else
+        defs := <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      end
+    <+
+      defs := []
+      
+rules // Index utilities
+  
+  /**
+   * Gets the namespace part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-namespace> "Bar"{[Entity(), "Bar", "Baz"]} => Entity()
+   *
+   * @type "name"{uri@[namespace|path]} -> namespace
+   */
+  index-uri-namespace:
+    x{[namespace|path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   *
+   * Example:
+   *   <index-uri-path> "Bar"{[Entity(), "Bar", "Baz"]} => ["Bar", "Baz"]
+   *
+   * @type "name"{uri@[namespace|path]} -> path'
+   */
+  index-uri-path:
+    x{[namespace|path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+      
+  /**
+   * Gets the name part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-name> "Bar"{[Entity(), "Bar", "Baz"] => "Bar"
+   *
+   * @type "name"{uri@[namespace|[name|restPath]]} -> name
+   */ 
+  index-uri-name:
+    x{[_|[name|_]]} -> name
+    
+  /**
+   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
+   *
+   * Example:
+   *   <index-uri-name> Def([Entity(), "Bar", "Baz"]) => "Bar"
+   *   <index-uri-name> Type("Foo") => fail
+   *   <index-uri-name> Read([Entity()]) => fail
+   *
+   * @type x -> name
+   */   
+  index-uri-name:
+    x -> <index-uri-name> <index-uri> x
+    where
+      not(<has-annos> x)
+    
+  /**
+   * Determines if a given AST node is a definition site, according to the syntax.
+   *
+   * FIXME: Also succeeds on use sites.
+   *
+   * @type def -> ?def
+   */
+  index-is-definition =
+    where(nam-get-definition-key)
+    
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
+   *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
+   *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
+   *
+   * @type (k1, k2) -> ?(k1, k2)
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/compilation-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/compilation-library.generated.str	Fri May 25 09:23:46 2012	(r24869)
@@ -0,0 +1,188 @@
+module lib/compilation-library.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  lib/index-library.generated
+  lib/analysis-library.generated
+  lib/analysis-library-internal.generated
+  
+rules // Extension points
+  
+  /**
+   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
+   *
+   * Extension example:
+   *   index-desugar-ast:
+   *     ast -> <desugar> ast
+   *
+   * @type ast -> ast'
+   */
+  index-desugar-ast = fail
+    
+  /**
+   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
+   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
+   * compilation.
+   *
+   * Extensions example:
+   *   index-compile-ast(|file, subfile):
+   *     ast -> None()
+   *     with
+   *       java := <to-java> ast;
+   *       full-path := <dirname> file;
+   *       filename := <guarantee-extension(|"java")> <base-filename> file;
+   *       writePath := $[[full-path]/java/];
+   *       writeFile :=  $[[writePath][filename]];
+   *       try(<mkdir> writePath);
+   *       <fclose> <fputs> (java, <fopen> (writeFile, "w"))
+   *
+   * @param file    The file that must be compiled.
+   * @param subfile The subfile that must be compiled ("" if there is no subfile).
+   * @type ast -> None()
+   */
+  index-compile-ast(|file, subfile) = fail
+  
+rules // Compilation
+  
+  /**
+   * Schedules compilation in the background of all files that have changed since the last compilation.
+   *
+   * @type x -> x
+   */
+  index-schedule-compilation:
+    _ -> None()
+    with
+      queue-strategy(|"index-compilation", "Compiling files")
+  
+  /** @internal */
+  index-compilation:
+    language -> None()
+    with
+      // Init
+      project-path := <project-path>;
+      index-setup(|language, [project-path], ".")
+    with
+      // Determine the files to compile by looking at changed files
+      diffs         := <analyze-get-compilediffs>;
+      files         := <map(index-compilation-restore-read-file)> diffs;
+      filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
+      
+      // Clean compile time reads
+      <filter(index-compilation-clean-reads)> filteredFiles;
+      
+      // Set total work units to number of files to compile for visual indication
+      <set-total-work-units> <length> filteredFiles;
+      
+      // Compile the files
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
+
+  /** @internal */
+  index-compilation-file(|language, project-path):
+    (path, subfile) -> None()
+    with
+      ast := <index-get-global(|<conc> (<index-file-to-uri> (path, subfile), ["ast"]))>;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Compile file
+        <try(index-compile-ast(|path, subfile))> ast;
+        
+        // Store compile-time reads.
+        reads := <iset-elements> readSet;
+        <index-add-all(|<index-compilation-file-tuple> (path, subfile))> reads
+      |}
+
+  /** @internal */
+  index-compilation-filter-file:
+    (file, subfile) -> (file, subfile)
+    where
+      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
+    
+rules // On save handling
+  
+  /**
+   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
+   *
+   * @see trigger-commit-and-compile
+   *
+   * @internal
+   */
+  commit-and-compile:
+    language -> None()
+    with
+      index-commit
+    with
+      index-schedule-compilation
+
+  /**
+   * Triggers commit and compilation, requires target language as current term.
+   * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
+   * enable-commit-and-compile is called.
+   *
+   * @type language -> language
+   *
+   * @see enable-commit-and-compile
+   * @see disable-commit-and-compile
+   */
+  trigger-commit-and-compile:
+    language -> <id>
+    with
+      if not(index-is-global-enabled(|"delay-compile")) then
+        commit-and-compile
+      else
+        index-enable-global(|"trigger-compile")
+      end
+  
+  /**
+   * Delays commit and compilation until enable-commit-and-compile is called.
+   *
+   * @type x -> x
+   *
+   * @see enable-commit-and-compile
+   */
+  disable-commit-and-compile = 
+    index-enable-global(|"delay-compile")
+  
+  /**
+   * Cancels the commit and compilation delay, requires target language as current term. 
+   * If commit and compilation was triggered during the delay, it is triggered now.
+   *
+   * @type language -> language
+   *
+   * @see disable-commit-and-compile
+   */
+  enable-commit-and-compile:
+    language -> <id>
+    with
+      if index-is-global-enabled(|"trigger-compile") then
+        commit-and-compile
+      end;
+      index-disable-global(|"delay-compile")
+      
+/** @internal */
+rules // Compile time reads
+
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
+    where
+      file' := <string-replace(|<index-compilation-read-path>, "")> file
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file, subfile)
+    where
+      not(<string-replace(|<index-compilation-read-path>, "")> file)
+      
+  /** @internal */
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+      
+  /** @internal */
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  /** @internal */
+  index-compilation-read-path =
+    !"/.internal/reads/compile"

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/index-library.generated.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/index-library.generated.str	Fri May 25 09:23:46 2012	(r24869)
@@ -0,0 +1,695 @@
+module lib/index-library.generated
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  
+signature constructors
+  
+  // Index elements
+  DefData      : List(UriPart) * DefDataType * Term -> Summary
+    
+  // URI header
+  Namespace      : UriPart
+  Unresolved     : Namespace -> UriPart
+  INTERNAL_ERROR : UriPart
+  Timestamp      : UriPart
+ 
+  // Remainder of URI
+  String : UriPart
+  Anon   : Int -> UriPart
+  Anon   : UriPart
+  
+  FileEntries : Term * Term -> Term
+  
+  // Globals
+  Global : Namespace
+  Global : List(UriPart) -> Summary
+  Global : List(UriPart) * List(Summary) -> Summary
+  
+  // None namespace
+  None   : Namespace
+  
+rules // Index management
+   
+  /**
+   * Sets up the index library for given language and project paths.
+   * Must be called once before doing anything with the library.
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   *
+   * @obsolete
+   * @type x -> x
+   */
+  index-setup(|language, project-paths) =
+    obsolete(!"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)");
+    index-setup(|language, project-paths, ".")
+    
+  /**
+   * Sets up the index library for given language, project paths and current file.
+   * Must be called once before doing anything with the library.
+   *
+   * Example:
+   *   <index-setup(|"MiniJava", [<project-path>], "test/test.mjv")
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
+   *                      Can also be changed later using index-set-current-file.
+   * @type x -> x
+   */
+  index-setup(|language, project-paths, current-file) =
+    prim("LANG_index_setup", language, project-paths, current-file)
+    
+  /**
+   * Sets the current file the index (analysis) is operating on to the given file.
+   *
+   * Example:
+   *   <index-set-current-file> "fullpath/file.ext"
+   *   <index-set-current-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
+   */
+  index-set-current-file = 
+    prim("LANG_index_set_current_file", <id>)
+
+  /**
+   * Adds given element to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add(|"fullpath/file.ext")> Def([Entity(), "Bar"])
+   *   <index-add(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   *
+   * @param file  The file (and subfile) to add the element to.
+   * @type x -> ?x
+   */
+  index-add(|file) =
+    prim("LANG_index_add", <id>, file)
+
+  /**
+   * Adds all given elements to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to add the elements to.
+   * @type List(x) -> ?List(x)
+   */
+  index-add-all(|file) =
+    list-loop(with(index-add(|file)))
+    
+  /**
+   * Removes given element from the index that is contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove(|"fullpath/file.ext")> Def([Entity(), "Bar"])
+   *   <index-remove(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   * 
+   * @param file  The file (and subfile) to remove the element from.
+   * @type x -> ?x
+   */
+  index-remove(|file) =
+    prim("LANG_index_remove", <id>, file)
+    
+  /**
+   * Removes all given elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to remove the elements from.
+   * @type List(x) -> ?List(x)
+   */
+  index-remove-all(|file) =
+    list-loop(with(index-remove(|file)))
+    
+  /**
+   * Removes all elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-clear-file> "fullpath/file.ext"
+   *   <index-clear-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
+   */
+  index-clear-file = 
+    prim("LANG_index_clear_file", <id>)
+    
+  /**
+   * Clears all elements from the index.
+   *
+   * @type x -> x
+   */
+  index-clear = 
+    prim("LANG_index_clear_all")
+   
+  /**
+   * Commits index to a file on disk.
+   *
+   * @type x -> x
+   */
+  index-commit = 
+    prim("LANG_index_commit")
+
+  /**
+   * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
+   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
+   *
+   * @type x -> x
+   */
+  index-start-transaction = 
+    prim("LANG_index_start_transaction")
+  
+  /**
+   * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
+   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
+   * this call.
+   *
+   * @type x -> x
+   */
+  index-end-transaction = 
+    prim("LANG_index_end_transaction")
+  
+  /**
+   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
+   * strategy are thread safe.
+   * 
+   * @param s The strategy to apply. Transaction will still properly end if strategy fails.
+   * @type x -> x'
+   *
+   * @see index-start-transaction
+   * @see index-end-transaction
+   */
+  index-transaction(s) = 
+    prim("LANG_index_start_transaction"); try(s); prim("LANG_index_end_transaction")
+  
+rules // Index querying
+  
+  /**
+   * Gets the file that the analysis is currently in.
+   *
+   * @type x -> (file, subfile)
+   *
+   * @see index-setup(|language, project-paths, current-file)
+   * @see index-set-current-file
+   */
+  index-get-current-file =
+    prim("LANG_index_get_current_file")
+  
+  /**
+   * Gets a list of all files and subfiles for current project.
+   *
+   * Example:
+   *   <index-get-all-files> => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type x -> List((file, subfile))
+   */   
+  index-get-all-files =
+    prim("LANG_index_all_files")
+  
+  /**
+   * Gets all index entries for the given file path and optionally subfile.
+   *
+   * Examples:
+   *   <index-get-all-in-file> "fullpath/file.ext" => [Def([Entity(), "Bar"]), ...]
+   *   <index-get-all-in-file> ("fullpath/file.ext", "subfile") => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type file or (file, subfile) -> List(elem)
+   */  
+  index-get-all-in-file:
+    filepath -> entries
+    with
+      entries := <prim("LANG_index_get_all_in_file", filepath)>
+   
+  /**
+   * Gets index entries in some namespace for the given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-get-all-in-file(|Import())> "fullpath/file.ext" => [Def([Import(), "Bar"]), ...]
+   *   <index-get-all-in-file(|Import())> ("fullpath/file.ext", "subfile") => [Def([Import(), "Bar"]), ...]
+   *
+   * @param namespace Only index entries from this namespace are retrieved.
+   * @type file or (file, subfile) -> List(elem)
+   */  
+  index-get-all-in-file(|namespace):
+    filepath -> entries
+    with
+      // TODO: Optimize -- add an argument to LANG_index_get_all_in_file to do this filtering
+      entries := <prim("LANG_index_get_all_in_file", filepath)>;
+      filter(where(index-uri => [namespace | _]))
+    
+  /**
+   * Gets the revision of a file and optionally subfile.
+   *
+   * Example:
+   *   <index-get-file-revision> "fullpath/file.ext" => 13
+   *   <index-get-file-revision> ("fullpath/file.ext", "subfile") => 37
+   *
+   * @type file or (file, subfile) -> Int
+   */
+  index-get-file-revision:
+    file -> <prim("LANG_index_get_file_revision", file)>
+    
+  /**
+   * Gets the containing files and subfiles of index entry with given template.
+   *
+   * Example:
+   *   <index-get-files-of> Def([Entity(), "Bar"]) => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type template -> List((file, subfile))
+   */  
+  index-get-files-of:
+    template -> <prim("LANG_index_get_files_of", template)>
+    
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  indexlib-get-all:
+    template -> <prim("LANG_index_get", template)>
+    
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  indexlib-get-all-values:
+    template -> <map(index-value)> <indexlib-get-all> template
+ 
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
+   */
+  indexlib-get:
+    template -> <?[<id>|_]> <indexlib-get-all> template
+   
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  indexlib-get-value:
+    template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
+    
+rules // Index globals
+    
+  /**
+   * Gets the 'fake' path where globals are stored in the index.
+   *
+   * @internal
+   */
+  index-globals-path = 
+    !"/.internal/globals"
+    
+  /**
+   * Gets the URI where globals are stored in the index for given name or names.
+   *
+   * @internal
+   * @type name or List(name) -> uri
+   */
+  index-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["globals", ".internal"]]
+      else
+        uri := [Global(), names, "global", ".internal"]
+      end
+    
+  /**
+   * Gets the first value in global storage with given name, or fail.
+   *
+   * Example:
+   *   index-get-global(|"last-compile") => Timestamp(1334322856)
+   *   index-get-global(|["last-compile", "file.str"]) => Timestamp(1334322856)
+   * 
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> ?value
+   */
+  index-get-global(|name):
+    _ -> value
+    where
+      value := <indexlib-get-value> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Gets all values in global storage with given name.
+   *
+   * Example:
+   *   index-get-global(|"last-compile") => [Timestamp(1334322856), ...]
+   *   index-get-global(|["last-compile", "file.str"]) => [Timestamp(1334322856), ...]
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> List(value)
+   */ 
+  index-get-all-globals(|name):
+    _ -> values
+    with
+      values := <indexlib-get-all-values> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Add value to global storage with given name.
+   *
+   * Example:
+   *   <index-add-global(|"last-compile")> Timestamp(1334322856)
+   *   <index-add-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-add-global(|name):
+    value -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-globals-uri> name, value)
+      
+  /**
+   * Overwrites value in global storage with given value.
+   *
+   * Example:
+   *   <index-set-global(|"last-compile")> Timestamp(1334322856)
+   *   <index-set-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-set-global(|name):
+    value -> <id>
+    with
+      index-clear-global(|name);
+      <index-add-global(|name)> value
+    
+  /**
+   * Removes all values from global storage with given name.
+   *
+   * Example:
+   *   index-clear-global(|"last-compile")
+   *   index-clear-global(|["last-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-clear-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-globals-uri> name, ())
+      
+  /**
+   * Gets the URI where boolean globals are stored in the index for given name or names.
+   *
+   * @internal
+   */
+  index-boolean-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["boolean", "globals", ".internal"]]
+      else
+        uri := [Global(), names, "boolean", "global", ".internal"]
+      end
+      
+  /**
+   * Sets boolean value true to global boolean storage with given name.
+   *
+   * Example:
+   *   index-enable-global(|"can-compile")
+   *   index-enable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-enable-global(|name):
+    _ -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Sets boolean value false to global boolean storage with given name.
+   *
+   * Example:
+   *   index-disable-global(|"can-compile")
+   *   index-disable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-disable-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Query for boolean value true in global boolean storage with given name.
+   *
+   * Example:
+   *   index-is-global-enabled(|"can-compile")
+   *   index-is-global-enabled(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> ?x
+   */   
+  index-is-global-enabled(|name):
+    _ -> <id>
+    where
+      <indexlib-get> Global(<index-boolean-globals-uri> name)
+
+rules // Index utility
+  
+  /**
+   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
+   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
+   * given term.
+   *
+   * Example:
+   *   <index-uri> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => [Entity(), "Bar", "Baz"]
+   *
+   * @type elem -> ?uri
+   *
+   * @see index-uri-impl
+   * @see index-uri-generic
+   */ 
+  index-uri = 
+    index-uri-impl <+ index-uri-generic
+  
+  /**
+   * Gets the namespace part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => Entity()
+   *
+   * @type uri@[namespace|path] -> namespace
+   */ 
+  index-uri-namespace =
+    ?[<id>|_]
+  
+  /**
+   * Gets the path part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => ["Bar", "Baz"]
+   *   <index-uri-path> [Entity()] => []
+   *
+   * @type uri@[namespace|path] -> path
+   */ 
+  index-uri-path =
+    ?[_|<id>]
+    
+  /**
+   * Gets the name part of the given URI or fail if there is no name.
+   *
+   * Example:
+   *   <index-uri-name> [Entity(), "Bar", "Baz"] => "Bar"
+   *   <index-uri-name> [Entity()] => fail
+   *
+   * @type uri@[namespace|[name|restPath]] -> ?name
+   */ 
+  index-uri-name =
+    ?[_|[<id>|_]]
+  
+  /**
+   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
+   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
+   * from the given term.
+   *
+   * Example:
+   *   <index-value> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => TYPE("Bar")
+   *
+   * @type elem -> ?value
+   *
+   * @see index-value-impl
+   * @see index-value-generic
+   */  
+  index-value = 
+    index-value-impl <+ index-value-generic
+  
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   *
+   * @type x -> ?x
+   */
+  index-is-fake-file = 
+    string-starts-with(|"/.internal")
+  
+  /**
+   * Checks if given URI's are equal. Discards anonymous scopes if necessary.
+   *
+   * Example:
+   *   <index-uri-eq> ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"]) => 
+   *     ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"])
+   *   <index-uri-eq> ([Entity(), "Foo"], [Entity(), "Bar"]) => fail
+   *
+   * @type (u1, u2) -> ?(u1, u2)
+   */
+  index-uri-eq:
+    (u1, u2) -> <id>
+    where
+      u1' := <index-uri-unwrap> u1;
+      u2' := <index-uri-unwrap> u2;
+      (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
+  
+  /**
+   * Finds the first key (term{uri} element) for given term, or fail. 
+   *
+   * @type x -> ?name{uri}
+   */
+  index-find-key:
+    x -> key
+    where
+      key := <collect-one(?_{_})> x
+      
+  /**
+   * Converts a URI to a string.
+   *
+   * Example:
+   *   <index-uri-to-string> [Entity(), "Bar", "Baz"] => "Entity://Bar.Baz"
+   *
+   * @type uri -> str
+   */
+  index-uri-to-string:
+    [ns|path] -> <concat-strings> [nsStr, "://", pathStr]
+    with
+      pathStr := <take-until(?Anon(_)); reverse; separate-by(|"."); concat-strings> path;
+      nsStr := <?<id>#(_)> ns
+  
+  /**
+   * Converts a file to a string.
+   *
+   * Example:
+   *   <index-file-to-string> "fullpath/file.ext" => "fullpath/file.ext"
+   *
+   * @type file -> file
+   */
+  index-file-to-string:
+    file -> file
+    where
+      not(<is-tuple> file)
+  
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", []) => "fullpath/file.ext"
+   *
+   * @type (file, []) -> file
+   */
+  index-file-to-string:
+    (file, []) -> file
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", [Entity(), "Foo" "Bar"]) => "fullpath/file.ext at Entity://Foo.Bar"
+   *
+   * @type (file, subfile) -> str
+   */
+  index-file-to-string:
+    (file, subfile) -> <concat-strings> [file, "@", <index-uri-to-string> subfile]
+    where
+      not([] := subfile)
+
+  /**
+   * Converts a file to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> "fullpath/file.ext" => [None(), "fullpath/file.ext"]
+   *
+   * @type file -> uri
+   */      
+  index-file-to-uri:
+    file -> [None(), file]
+    where
+      not(<is-tuple> file)
+      
+  /**
+   * Converts a file ((file, subfile) tuple) to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> ("fullpath/file.ext", []) => [None(), "fullpath/file.ext]
+   *
+   * @type (file, subfile) -> uri
+   */      
+  index-file-to-uri:
+    (file, []) -> [None(), file]
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a URI.
+   *
+   * Example:
+   *   <index-file-to-uri> ("fullpath/file.ext", [Entity(), "Foo" "Bar"]) => [Entity(), "Foo", "Bar", "fullpath/file.ext"]
+   *
+   * @type (file, subfile) -> uri
+   */      
+  index-file-to-uri:
+    (file, subfile) -> <conc> ([file], subfile)
+    where
+      not([] := subfile)
+      
+/** @internal */
+rules // URI and value projections
+  
+  /** @internal */
+  index-uri-impl:
+    DefData(uri, _, _) -> uri
+
+  /** @internal */
+  index-uri-generic:
+    term -> <?_#(<?[<id>|_]>)> term
+  
+  /** @internal */
+  index-value-impl:
+    DefData(_, _, value) -> value
+    
+  /** @internal */
+  index-value-generic:
+    term -> <?_#(<?[_, <id>|_]> )> term
+     
+/** @internal */ 
+rules // Internal helpers
+  
+  /** @internal */
+  index-namespace-unwrap =
+    \Unresolved(n) -> n\ <+ id
+    
+  /** @internal */
+  index-uri-unwrap =
+    \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id

From chrismelman at hotmail.com  Fri May 25 15:14:12 2012
From: chrismelman at hotmail.com (Chris Melman)
Date: Fri, 25 May 2012 13:14:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24870 - hydra/webdsl
Message-ID: <20120525131412.14EC4108C02F@mx3.tudelft.nl>

Author: ChrisMelman
Date: Fri May 25 13:14:11 2012
New Revision: 24870
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24870&sc=1

Log:
added requestlog=true to defualt application.ini

Modified:
   hydra/webdsl/application.ini

Modified: hydra/webdsl/application.ini
==============================================================================
--- hydra/webdsl/application.ini	Fri May 25 09:23:46 2012	(r24869)
+++ hydra/webdsl/application.ini	Fri May 25 13:14:11 2012	(r24870)
@@ -12,3 +12,4 @@
 export SMTPPASS=
 export SMTPSSL=false
 export SMTPTLS=false
+export requestlog=true

From andre.s.d.vieira at gmail.com  Fri May 25 15:37:25 2012
From: andre.s.d.vieira at gmail.com (Andre Vieira)
Date: Fri, 25 May 2012 13:37:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24871 -
	spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed
Message-ID: <20120525133725.803C27F802B@mx1.tudelft.nl>

Author: AndreVieira
Date: Fri May 25 13:37:25 2012
New Revision: 24871
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24871&sc=1

Log:


Added:
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/AST.aterm
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/program.app
   spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/strategyResult.txt

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/AST.aterm
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/AST.aterm	Fri May 25 13:37:25 2012	(r24871)
@@ -0,0 +1,134 @@
+ApplicationDefs(
+  "D"
+, [ SearchMapping(
+      "T"
+    , [ SearchNamespaceMapping("clClFYR7_CX")
+      , SearchNamespaceMapping("U_")
+      , SearchFieldMapping(
+          "+"
+        , "WW__CDU7GU"
+        , [ EmbeddedDepth("-4")
+          , EmbeddedDepth("-4")
+          , EmbeddedDepth("40")
+          , Boost(".F")
+          , AnalyzerName("T")
+          , Boost("8d")
+          ]
+        )
+      ]
+    )
+  , Imports("_-__WR/46J-61_p6Z")
+  , RecommendConfig(
+      "UJU9_T3_"
+    , [ RecommendArgument("schedule", "-6")
+      , RecommendArgument("neighborhoodalg", "40")
+      , RecommendArgument("neighborhoodalg", "iU")
+      , RecommendArgument("algorithm", TimeInterval([]))
+      , RecommendArgument("type", "kDh3q8_")
+      , RecommendArgument("schedule", TimeInterval([]))
+      ]
+    )
+  , Imports("_-__WR/46J-61_p6Z")
+  , Test(
+      "wX_24m830__"
+    , Block(
+        [ ForCountStmt(
+            "kDh3q8_"
+          , SearcherRefMod(
+              SearchResultsSize(FieldAccess(ExternalScopeVar("gHSQn20_6p4"), "W_222D_6_L_"))
+            , [QueryDef([])]
+            )
+          , SetCreation([])
+          , Block([])
+          )
+        , If(
+            Suggest("jYgtv4Y22_8", AutoComplete(), [Similarity(MapCreation([]))])
+          , Block([])
+          , Block([])
+          )
+        , Case(Var("FJ"), [])
+        , Case(
+            SmallerThan(
+              TypedListCreation(RefSort(SimpleSort("WW__CDU7GU")), [])
+            , RenderEmailFunctionCall(EmailCall("U_", []))
+            )
+          , []
+          )
+        , ScheduleNoFor(
+            SmallerThan(
+              SetCreation([])
+            , AndForExp(
+                ForExp(
+                  LargerThan(MapCreation([]), True())
+                , "WW__CDU7GU"
+                , GenericSort("D", [SimpleSort("iU")])
+                , ThisCall("W_222D_6_L_", [])
+                , FilterNoOrderBy(
+                    ObjectCreation(GenericSort("wX_24m830__", [SimpleSort("iIQOmx")]), [])
+                  , LimitNoLimit(Or(ThisCall("D___M___5_0", []), GlobalVar("Q")))
+                  )
+                )
+              )
+            )
+          )
+        , Case(Eq(EmailFunctionCall(EmailCall("clClFYR7_CX", [])), True()), [])
+        , ForAllStmtNoFilter(
+            "W_222D_6_L_"
+          , RefSort(GenericSort("WW__CDU7GU", [SimpleSort("D")]))
+          , Block([])
+          )
+        ]
+      )
+    )
+  , Description(["o~wpvpLlqo", "p", "os", "sosqp-susl"])
+  ]
+, [ AccessControlDefinition(
+      "T"
+    , [ AccessControlPrincipal("W_222D_6_L_", ["y"])
+      , AccessControlPointcut("D___M___5_0", [], [])
+      , AccessControlPointcut("S_", [], [])
+      , AccessControlPointcut("T", [], [])
+      , AccessControlPointcut("iU", [], [])
+      , Predicate(
+          "iIQOmx"
+        , []
+        , Add(
+            LargerThan(
+              Highlight(ExternalScopeVar("iU"), SetCreation([]), "UNMi670d_24.FE78.U2I")
+            , ListCreation([])
+            )
+          , Eq(
+              NotEq(GlobalVar("D___M___5_0"), ListCreation([]))
+            , ForExp(
+                SetCreation([])
+              , "D"
+              , GenericSort("iU", [SimpleSort("iIQOmx")])
+              , ThisCall("iIQOmx", [])
+              , FilterNoOrderBy(ListCreation([]), Limit(ListCreation([]), ExternalScopeVar("W_222D_6_L_")))
+              )
+            )
+          )
+        )
+      , AccessControlPrincipal("wX_24m830__", ["U_"])
+      , AccessControlPointcut("wX_24m830__", [], [])
+      , SpecialAccessControlRule(
+          "WW__CDU7GU"
+        , Div(
+            Mul(
+              Mul(ThisCall("W_222D_6_L_", []), MapCreation([]))
+            , SendEmailFunctionCall(EmailCall("iU", []))
+            )
+          , SearcherInit("p3b_2E_7P__", [])
+          )
+        )
+      , SpecialAccessControlRule(
+          "iU"
+        , LargerThanOrEqual(
+            And(RenderEmailFunctionCall(EmailCall("gHSQn20_6p4", [])), AllFacetResults("pG14P5XiPP6.Cv.Y31xB6_txV_.h31S8", False()))
+          , Not(EmailFunctionCall(EmailCall("Q", [])))
+          )
+        )
+      ]
+    )
+  ]
+)
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/program.app
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/program.app	Fri May 25 13:37:25 2012	(r24871)
@@ -0,0 +1,163 @@
+application D
+
+search mapping T {
+  namespace by clClFYR7_CX
+  namespace by U_
+  + WW__CDU7GU with depth -4 with depth -4 with depth 40 ^ .F using T ^ 8d
+}
+
+imports _-__WR/46J-61_p6Z
+
+recommend
+
+UJU9_T3_
+
+{
+
+schedule
+
+=
+
+-6
+
+neighborhoodalg
+
+=
+
+40
+
+neighborhoodalg
+
+=
+
+iU
+
+algorithm
+
+=
+
+type
+
+=
+
+kDh3q8_
+
+schedule
+
+=
+
+}
+
+imports _-__WR/46J-61_p6Z
+
+test
+
+wX_24m830__
+
+{
+  for
+  (
+  kDh3q8_
+  :
+  Int
+  from
+  ~ count from externalscope.gHSQn20_6p4.W_222D_6_L_ matching
+  to
+  {}
+  )
+  {
+  }
+  if ( jYgtv4Y22_8 completions similarity [
+                                          ] )
+  {
+  }
+  else
+  {
+  }
+  case ( FJ ) {
+  }
+  case ( List<Ref<WW__CDU7GU>>() < renderemail ( U_ ( ) ) ) {
+  }
+  schedule
+  {}
+  <
+  And
+  [ [
+    ] > true | WW__CDU7GU : D<iU> in W_222D_6_L_() where wX_24m830__<iIQOmx>{} offset D___M___5_0() || global.Q ]
+  case ( email ( clClFYR7_CX ( ) ) == true ) {
+  }
+  for ( W_222D_6_L_ : Ref<WW__CDU7GU<D>> )
+  {
+  }
+}
+
+description {
+  o~wpvpLlqo p os sosqp-susl
+}
+
+access control rules
+  T
+  principal
+  is
+  W_222D_6_L_
+  with
+  credentials
+  y
+  pointcut
+  D___M___5_0
+  (
+  )
+  {
+  }
+  pointcut
+  S_
+  (
+  )
+  {
+  }
+  pointcut
+  T
+  (
+  )
+  {
+  }
+  pointcut
+  iU
+  (
+  )
+  {
+  }
+  predicate
+  iIQOmx
+  (
+  )
+  {
+  highlight externalscope . iU for {} on UNMi670d_24.FE78.U2I
+  >
+  []
+  +
+  global.D___M___5_0
+  !=
+  []
+  ==
+  [ {} | D : iU<iIQOmx> in iIQOmx() where [] limit [] offset externalscope . W_222D_6_L_ ]
+  }
+  principal
+  is
+  wX_24m830__
+  with
+  credentials
+  U_
+  pointcut
+  wX_24m830__
+  (
+  )
+  {
+  }
+  rule WW__CDU7GU {
+    W_222D_6_L_() * [
+                    ] * sendemail ( iU ( ) ) / search p3b_2E_7P__
+  }
+  rule iU {
+    renderemail ( gHSQn20_6p4 ( ) ) && all pG14P5XiPP6.Cv.Y31xB6_txV_.h31S8 facets from false >= ! email ( Q ( ) )
+  }
\ No newline at end of file

Added: spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/strategyResult.txt
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/spoofax-testing-automation/Errors/Webdsl/h_30162crashed/strategyResult.txt	Fri May 25 13:37:25 2012	(r24871)
@@ -0,0 +1,42 @@
+
+Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	declare_globals_0_0
+	typecheck_declare_0_0
+	log_time_1_1
+	declare_all_0_0
+	dr_scope_1_1
+	alltd_1_0
+	declare_0_0
+	declare_recommend_0_0
+	normalize_recommend_0_0
+	fetch_elem_1_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'normalize-recommend'
+           RecommendConfig("UJU9_T3_",[RecommendArgument("schedule","-6"),RecommendArgument("neighborhoodalg","40"),RecommendArgument("neighborhoodalg","iU"),RecommendArgument("algorithm",TimeInterval([])),RecommendArgument("type","kDh3q8_"),RecommendArgument("schedule",TimeInterval([]))])Analyzing: TestFolder2/program.app
+WebDSL: rewriting failed, trace:
+	editor_analyze1_0_0
+	editor_analyze1_0_0
+	editor_analyze_0_0
+	editor_analyze_work_0_0
+	in_typechecking_phase_1_0
+	dr_scope_1_1
+	dr_scope_1_1
+	declare_globals_0_0
+	typecheck_declare_0_0
+	log_time_1_1
+	declare_all_0_0
+	dr_scope_1_1
+	alltd_1_0
+	declare_0_0
+	declare_recommend_0_0
+	normalize_recommend_0_0
+	fetch_elem_1_0
+[ WebDSL | critical ] Internal error: with clause failed unexpectedly in rule 'normalize-recommend'
+           RecommendConfig("UJU9_T3_",[RecommendArgument("schedule","-6"),RecommendArgument("neighborhoodalg","40"),RecommendArgument("neighborhoodalg","iU"),RecommendArgument("algorithm",TimeInterval([])),RecommendArgument("type","kDh3q8_"),RecommendArgument("schedule",TimeInterval([]))])
\ No newline at end of file

From oskarvanrest at gmail.com  Tue May 29 08:30:08 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Tue, 29 May 2012 06:30:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24872 - in
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf:
	test/emf trans/emf
Message-ID: <20120529063008.08B48108C014@mx3.tudelft.nl>

Author: OskarVanRest
Date: Tue May 29 06:30:07 2012
New Revision: 24872
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24872&sc=1

Log:
fetch-cons-name (was already defined in lib/attributes)

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf	Fri May 25 13:37:25 2012	(r24871)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf	Tue May 29 06:30:07 2012	(r24872)
@@ -14,4 +14,5 @@
 
     "module" Module@=ID Type*				-> Start {"Module", scope(Type)}
     "entity" Type@=ID "{" Property* "}"		-> Type {"Entity", scope(Property)}
+	"primitive" Type @=ID					-> Type {"Primitive"}
     Property@=ID ":" Type at Type				-> Property {"Property"}

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Fri May 25 13:37:25 2012	(r24871)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Tue May 29 06:30:07 2012	(r24872)
@@ -3,6 +3,7 @@
 imports
 	include/SDF
 	lib/ecore-signatures
+	lib/attributes
 	
 strategies
 	
@@ -22,7 +23,7 @@
 	to-ecore:
 		prod(lhs, sort(s), attributes) -> EClass(properties, structuralFeatures')
 		where
-			cons := <get-constr> attributes;
+			cons := <fetch-cons-name> attributes;
 			name := Name(cons);
 			if <eq> (s, cons) + <eq> (s, "Start") then eSuperType := [] else eSuperType := ESuperType(s) end;
 			properties := <remove-all(?[])> [name, eSuperType];
@@ -115,7 +116,7 @@
 	create-superclass:
 		prod(_, sort(s), attributes) -> EClass([Name(s)], [])
 		where
-			cons := <get-constr> attributes;
+			cons := <fetch-cons-name> attributes;
 			not ( <eq> (s, cons) );
 			not ( <eq> (s, "Start" ))
 			
@@ -133,9 +134,4 @@
 			else
 				string' := <conc-strings> (string, "s")
 			end
-			
-	get-constr:
-		attrs(attributes) -> cons
-		where
-			Constructor(c) := <getfirst(?Constructor(_))> attributes;
-			cons := <un-double-quote> c
\ No newline at end of file
+			
\ No newline at end of file

From oskarvanrest at gmail.com  Tue May 29 08:32:53 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Tue, 29 May 2012 06:32:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24873 - in
	experimental/graphical-editor/EntityLang/EntityLang:
	editor/java/EntityLang/GMF trans
Message-ID: <20120529063253.9914FCC061@mx4.tudelft.nl>

Author: OskarVanRest
Date: Tue May 29 06:32:53 2012
New Revision: 24873
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24873&sc=1

Log:


Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
   experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Tue May 29 06:30:07 2012	(r24872)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Tue May 29 06:32:53 2012	(r24873)
@@ -192,29 +192,6 @@
 				e.printStackTrace();
 			}
 			textReplacer.replaceText(f.makeList(f.makeTuple(currentTerm, newTerm)));
-//			IStrategoTerm tuple = ((IStrategoList) textReplacement).head();
-//			IStrategoString replacement = (IStrategoString) tuple.getSubterm(2);
-//
-//			try {
-//	
-////				URI uri = URI.create(arg0)
-//				File file = new File("D:\\runtime-New_configuration_4\\Test\\example.ent");
-//				IPath path = new Path(file.getAbsolutePath()); 
-//				IFile iFile = ResourcesPlugin.getWorkspace().getRoot().getFile(path); 
-//				System.out.println(iFile!=null?"exists":"doesn't exist");
-//				System.out.println(path.toString());
-//				
-//				FileWriter fstream = new FileWriter(file);
-//				BufferedWriter out = new BufferedWriter(fstream);
-//				out.write(replacement.stringValue());
-//				out.close();
-////				iFile.touch(new NullProgressMonitor());
-////				iFile.refreshLocal(IResource.DEPTH_INFINITE, new NullProgressMonitor());
-//				
-//			} catch (Exception e) {
-//				e.printStackTrace();
-//			}
-
 		}
 	}
 

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Tue May 29 06:30:07 2012	(r24872)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/entitylang.str	Tue May 29 06:32:53 2012	(r24873)
@@ -16,7 +16,7 @@
   generate
   refactor
 imports
-  trans/emf
+	emf
 
 rules // Analysis
   
@@ -57,35 +57,6 @@
       // Enable and trigger compilation after all files have been analysed.
       <enable-commit-and-compile> <language>;
       <trigger-commit-and-compile> <language>
-      
-  // Called when current file is saved.
-  editor-save:
-    (_, _, _, _, _) -> None()
-    with
-      index-setup(|<language>, [<project-path>], ".");
-      <trigger-commit-and-compile> <language>
-
-rules // EMF
-
-  generate-emf:
-    ([ast'], path) -> result
-    where      
-      GMFFileExtension := <conc-strings> (<lower-case> <packName>, "_diagram");
-      GMFFile := <guarantee-extension(|GMFFileExtension)> path;
-      ast''  := <to-emf(|path)> ast';
-      result := <serialise-model(|path)> ast'';
-      <replace-gmf-resource(|<packName>, GMFFile)> result
-      
-  save-emf:
-  	(selected, position, ast, path, project-path) -> None()
-  	// where
-  	// 	<save> ast
-  
-  // external initialize-emf-package(|)
-  external replace-gmf-resource(|packName, fileName)
-  // external save(|)
-  external create-listener(|)
-
 
 rules // Editor services
   
@@ -177,3 +148,26 @@
     files -> None()
     with
       index-parallel-analyze-files(analyze)
+
+
+rules // EMF
+
+  generate-emf:
+    ([ast'], path) -> result
+    where      
+      GMFFileExtension := <conc-strings> (<lower-case> <packName>, "_diagram");
+      GMFFile := <guarantee-extension(|GMFFileExtension)> path;
+      ast''  := <to-emf(|path)> ast';
+      result := <serialise-model(|path)> ast'';
+      <replace-gmf-resource(|<packName>, GMFFile)> result
+      
+  save-emf:
+  	(selected, position, ast, path, project-path) -> None()
+  	// where
+  	// 	<save> ast
+  
+  // external initialize-emf-package(|)
+  external replace-gmf-resource(|packName, fileName)
+  // external save(|)
+  external create-listener(|)
+

From richard at vogelij.nl  Tue May 29 17:35:50 2012
From: richard at vogelij.nl (Richard Vogelij)
Date: Tue, 29 May 2012 15:35:50 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24874 - in
	spoofax-ace/trunk/spoofax-ace-server: . src src/name
	src/name/fraser src/name/fraser/neil
	src/name/fraser/neil/plaintext src/spoofax/ace/tokenize
Message-ID: <20120529153551.01EED108C025@mx3.tudelft.nl>

Author: rvogelij
Date: Tue May 29 15:35:50 2012
New Revision: 24874
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24874&sc=1

Log:
added tokenizer which produces a diff-friendly representation of a stratego term
actually diffing+sending the diff result over a websocket in diffpatch-enabled transfer-mode

Added:
   spoofax-ace/trunk/spoofax-ace-server/src/name/
   spoofax-ace/trunk/spoofax-ace-server/src/name/fraser/
   spoofax-ace/trunk/spoofax-ace-server/src/name/fraser/neil/
   spoofax-ace/trunk/spoofax-ace-server/src/name/fraser/neil/plaintext/
   spoofax-ace/trunk/spoofax-ace-server/src/name/fraser/neil/plaintext/diff_match_patch.java
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/BespinJSONTokenizer.java
   spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/S2ATokenizer.java
Modified:
   spoofax-ace/trunk/spoofax-ace-server/.classpath
   spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java
   spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java

Modified: spoofax-ace/trunk/spoofax-ace-server/.classpath
==============================================================================
--- spoofax-ace/trunk/spoofax-ace-server/.classpath	Tue May 29 06:32:53 2012	(r24873)
+++ spoofax-ace/trunk/spoofax-ace-server/.classpath	Tue May 29 15:35:50 2012	(r24874)
@@ -10,5 +10,6 @@
 	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/mobl-java.jar"/>
 	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/prog.jar"/>
 	<classpathentry kind="lib" path="/home/richard/Thesis/svnrepo/spoofax-ace/s2aserver/strategoxt.jar"/>
+	<classpathentry kind="lib" path="json-simple-1.1.1.jar"/>
 	<classpathentry kind="output" path="bin"/>
 </classpath>

Modified: spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java
==============================================================================
--- spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java	Tue May 29 06:32:53 2012	(r24873)
+++ spoofax-ace/trunk/spoofax-ace-server/src/AceWebSocketServlet.java	Tue May 29 15:35:50 2012	(r24874)
@@ -1,7 +1,10 @@
 
 
+import java.io.BufferedWriter;
+import java.io.FileWriter;
 import java.io.IOException;
 import java.util.Date;
+import java.util.LinkedList;
 import java.util.Set;
 import java.util.concurrent.CopyOnWriteArraySet;
 import javax.servlet.ServletException;
@@ -9,14 +12,22 @@
 import org.eclipse.jetty.websocket.WebSocket;
 import org.eclipse.jetty.websocket.WebSocketServlet;
 import org.spoofax.interpreter.terms.IStrategoTerm;
+import name.fraser.neil.plaintext.diff_match_patch;
+import name.fraser.neil.plaintext.diff_match_patch.Patch;
 
 
-import spoofax.ace.tokenize.Tokenizer;
+
+import spoofax.ace.tokenize.BespinJSONTokenizer;
+import spoofax.ace.tokenize.S2ATokenizer;
 
 public class AceWebSocketServlet extends WebSocketServlet{
+	
+	private static final String FULL_MESSAGE = "0";
+	private static final String DIFF_PATCH_MESSAGE = "1";
 	private static final long serialVersionUID = 1075580262818559087L;
 	private final Set<Editor> _editorInstances = new CopyOnWriteArraySet<Editor>();
-
+	private static int ClientNo = 0;
+	private static diff_match_patch diff = new diff_match_patch();
 	
 	@Override
 	public void init() throws ServletException
@@ -27,17 +38,24 @@
 	
 	@Override
 	public WebSocket doWebSocketConnect(HttpServletRequest arg0, String arg1) {
-		return new Editor();
+		return new Editor(ClientNo++);
 	}
 	
-	class Editor implements WebSocket.OnTextMessage {
+	private class Editor implements WebSocket.OnTextMessage {
 		private Connection _connection;
 		private StringBuilder _message;
 		
+		private String _lastSource = "";
+		private String _lastTokenRepresentation = ""; 
 		private int _curmessage = -1;
 		private int _lastFrameIdx;
 		private int _msgFrameCount;
+		private final int _id;
 		
+		public Editor(int id)
+		{
+			_id = id;
+		}
 
 		@Override
 		public void onClose(int msgCode, String msg) {
@@ -102,15 +120,42 @@
 		
 		private void ProcessPayload(String data)
 		{
-			System.out.println("################################");
-			//System.out.println(data.replace('\n', ' ').replace('\r', ' '));
+			if (data.startsWith(FULL_MESSAGE))
+			{
+				ProcessAnalysis(data.substring(1), false);
+			} else if (data.startsWith(DIFF_PATCH_MESSAGE))
+			{
+				Object[] results = diff.patch_apply((LinkedList<Patch>) diff.patch_fromText(data.substring(1)), _lastSource);
+				String source = (String) results[0];
+				_lastSource = source;
+				ProcessAnalysis(source,true);
+			}
+		}
+		
+		//Runs the processors to create either plain bespin tokens, or a patch (diff patch from previous sent response) 
+		private void ProcessAnalysis(String data, boolean patchInSteadOfFull)
+		{
+			System.out.println("#############"+_id+"############### ");
 			long start = new Date().getTime();
 			IStrategoTerm term = StrategoWorker.RunAnalysis(data);
-			//System.out.println(term.toString());
 			System.out.println("Analyzed: " + (new Date().getTime() - start));
-			start = new Date().getTime();
-			String response = Tokenizer.Tokenize(term, data);
-			System.out.println("Tokenized: " + (new Date().getTime() - start));
+			
+			String response = "";
+			if (!patchInSteadOfFull) {
+				start = new Date().getTime();
+				response = FULL_MESSAGE+BespinJSONTokenizer.Tokenize(term, data);
+				System.out.println("Tokenized Normal: " + (new Date().getTime() - start));
+			} else	{
+				start = new Date().getTime();
+				response = S2ATokenizer.TokenizeDiffable(term, data);
+				System.out.println("Tokenized Diffable: " + (new Date().getTime() - start));
+				//WriteStringDebug(response);
+				start = new Date().getTime();
+				response = DIFF_PATCH_MESSAGE+CreateDiffPatch(response);
+				System.out.println("Diff patch generated: " + (new Date().getTime() - start));
+				//System.out.println(response);
+			}
+			
 			start = new Date().getTime();
 			try {
 				_connection.sendMessage(response);
@@ -120,10 +165,26 @@
 			System.out.println("Sent response: " + (new Date().getTime() - start));
 			System.out.println("################################");
 		}
-		
-		public boolean isOpen() {
-			return _connection.isOpen();
+		private String CreateDiffPatch(String tokenRepresentationStr)
+		{
+			String patch = diff.patch_toText(diff.patch_make(_lastTokenRepresentation, tokenRepresentationStr));
+			_lastTokenRepresentation = tokenRepresentationStr;
+			return patch;
 		}
+		
+	
+		private void WriteStringDebug(String str)
+		{
+			try {
+				BufferedWriter out = new BufferedWriter(new FileWriter("/tmp/s2astrdump.txt"));
+				out.write(str);
+				out.close();
+			}
+			catch (IOException e)
+			{
+				System.out.println("Exception ");
+			}
+		}		
 	}	
 
 }

Modified: spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java
==============================================================================
--- spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java	Tue May 29 06:32:53 2012	(r24873)
+++ spoofax-ace/trunk/spoofax-ace-server/src/StrategoWorker.java	Tue May 29 15:35:50 2012	(r24874)
@@ -9,8 +9,12 @@
 		  param[0] = sourcecode;
 		  Context context = jbuild.init();
 		  context.setStandAlone(true);
-		  IStrategoTerm result;
-		  result = context.invokeStrategyCLI(jbuild.main_0_0.instance, "jbuild", param);
+		  IStrategoTerm result = null;
+		  try
+		  {
+			  result = context.invokeStrategyCLI(jbuild.main_0_0.instance, "jbuild", param);
+		  } 
+		  catch (Exception e) {}
 		  return result;
 	}
 }

Added: spoofax-ace/trunk/spoofax-ace-server/src/name/fraser/neil/plaintext/diff_match_patch.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/name/fraser/neil/plaintext/diff_match_patch.java	Tue May 29 15:35:50 2012	(r24874)
@@ -0,0 +1,2474 @@
+/*
+ * Diff Match and Patch
+ *
+ * Copyright 2006 Google Inc.
+ * http://code.google.com/p/google-diff-match-patch/
+ *
+ * Licensed under the Apache License, Version 2.0 (the "License");
+ * you may not use this file except in compliance with the License.
+ * You may obtain a copy of the License at
+ *
+ *   http://www.apache.org/licenses/LICENSE-2.0
+ *
+ * Unless required by applicable law or agreed to in writing, software
+ * distributed under the License is distributed on an "AS IS" BASIS,
+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
+ * See the License for the specific language governing permissions and
+ * limitations under the License.
+ */
+
+package name.fraser.neil.plaintext;
+
+import java.io.UnsupportedEncodingException;
+import java.net.URLEncoder;
+import java.net.URLDecoder;
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.HashMap;
+import java.util.LinkedList;
+import java.util.List;
+import java.util.ListIterator;
+import java.util.Map;
+import java.util.Stack;
+import java.util.regex.Matcher;
+import java.util.regex.Pattern;
+
+/*
+ * Functions for diff, match and patch.
+ * Computes the difference between two texts to create a patch.
+ * Applies the patch onto another text, allowing for errors.
+ *
+ * @author fraser at google.com (Neil Fraser)
+ */
+
+/**
+ * Class containing the diff, match and patch methods.
+ * Also contains the behaviour settings.
+ */
+public class diff_match_patch {
+
+  // Defaults.
+  // Set these on your diff_match_patch instance to override the defaults.
+
+  /**
+   * Number of seconds to map a diff before giving up (0 for infinity).
+   */
+  public float Diff_Timeout = 1.0f;
+  /**
+   * Cost of an empty edit operation in terms of edit characters.
+   */
+  public short Diff_EditCost = 4;
+  /**
+   * At what point is no match declared (0.0 = perfection, 1.0 = very loose).
+   */
+  public float Match_Threshold = 0.5f;
+  /**
+   * How far to search for a match (0 = exact location, 1000+ = broad match).
+   * A match this many characters away from the expected location will add
+   * 1.0 to the score (0.0 is a perfect match).
+   */
+  public int Match_Distance = 1000;
+  /**
+   * When deleting a large block of text (over ~64 characters), how close do
+   * the contents have to be to match the expected contents. (0.0 = perfection,
+   * 1.0 = very loose).  Note that Match_Threshold controls how closely the
+   * end points of a delete need to match.
+   */
+  public float Patch_DeleteThreshold = 0.5f;
+  /**
+   * Chunk size for context length.
+   */
+  public short Patch_Margin = 4;
+
+  /**
+   * The number of bits in an int.
+   */
+  private short Match_MaxBits = 32;
+
+  /**
+   * Internal class for returning results from diff_linesToChars().
+   * Other less paranoid languages just use a three-element array.
+   */
+  protected static class LinesToCharsResult {
+    protected String chars1;
+    protected String chars2;
+    protected List<String> lineArray;
+
+    protected LinesToCharsResult(String chars1, String chars2,
+        List<String> lineArray) {
+      this.chars1 = chars1;
+      this.chars2 = chars2;
+      this.lineArray = lineArray;
+    }
+  }
+
+
+  //  DIFF FUNCTIONS
+
+
+  /**
+   * The data structure representing a diff is a Linked list of Diff objects:
+   * {Diff(Operation.DELETE, "Hello"), Diff(Operation.INSERT, "Goodbye"),
+   *  Diff(Operation.EQUAL, " world.")}
+   * which means: delete "Hello", add "Goodbye" and keep " world."
+   */
+  public enum Operation {
+    DELETE, INSERT, EQUAL
+  }
+
+  /**
+   * Find the differences between two texts.
+   * Run a faster, slightly less optimal diff.
+   * This method allows the 'checklines' of diff_main() to be optional.
+   * Most of the time checklines is wanted, so default to true.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @return Linked List of Diff objects.
+   */
+  public LinkedList<Diff> diff_main(String text1, String text2) {
+    return diff_main(text1, text2, true);
+  }
+
+  /**
+   * Find the differences between two texts.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @param checklines Speedup flag.  If false, then don't run a
+   *     line-level diff first to identify the changed areas.
+   *     If true, then run a faster slightly less optimal diff.
+   * @return Linked List of Diff objects.
+   */
+  public LinkedList<Diff> diff_main(String text1, String text2,
+                                    boolean checklines) {
+    // Set a deadline by which time the diff must be complete.
+    long deadline;
+    if (Diff_Timeout <= 0) {
+      deadline = Long.MAX_VALUE;
+    } else {
+      deadline = System.currentTimeMillis() + (long) (Diff_Timeout * 1000);
+    }
+    return diff_main(text1, text2, checklines, deadline);
+  }
+
+  /**
+   * Find the differences between two texts.  Simplifies the problem by
+   * stripping any common prefix or suffix off the texts before diffing.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @param checklines Speedup flag.  If false, then don't run a
+   *     line-level diff first to identify the changed areas.
+   *     If true, then run a faster slightly less optimal diff.
+   * @param deadline Time when the diff should be complete by.  Used
+   *     internally for recursive calls.  Users should set DiffTimeout instead.
+   * @return Linked List of Diff objects.
+   */
+  private LinkedList<Diff> diff_main(String text1, String text2,
+                                     boolean checklines, long deadline) {
+    // Check for null inputs.
+    if (text1 == null || text2 == null) {
+      throw new IllegalArgumentException("Null inputs. (diff_main)");
+    }
+
+    // Check for equality (speedup).
+    LinkedList<Diff> diffs;
+    if (text1.equals(text2)) {
+      diffs = new LinkedList<Diff>();
+      if (text1.length() != 0) {
+        diffs.add(new Diff(Operation.EQUAL, text1));
+      }
+      return diffs;
+    }
+
+    // Trim off common prefix (speedup).
+    int commonlength = diff_commonPrefix(text1, text2);
+    String commonprefix = text1.substring(0, commonlength);
+    text1 = text1.substring(commonlength);
+    text2 = text2.substring(commonlength);
+
+    // Trim off common suffix (speedup).
+    commonlength = diff_commonSuffix(text1, text2);
+    String commonsuffix = text1.substring(text1.length() - commonlength);
+    text1 = text1.substring(0, text1.length() - commonlength);
+    text2 = text2.substring(0, text2.length() - commonlength);
+
+    // Compute the diff on the middle block.
+    diffs = diff_compute(text1, text2, checklines, deadline);
+
+    // Restore the prefix and suffix.
+    if (commonprefix.length() != 0) {
+      diffs.addFirst(new Diff(Operation.EQUAL, commonprefix));
+    }
+    if (commonsuffix.length() != 0) {
+      diffs.addLast(new Diff(Operation.EQUAL, commonsuffix));
+    }
+
+    diff_cleanupMerge(diffs);
+    return diffs;
+  }
+
+  /**
+   * Find the differences between two texts.  Assumes that the texts do not
+   * have any common prefix or suffix.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @param checklines Speedup flag.  If false, then don't run a
+   *     line-level diff first to identify the changed areas.
+   *     If true, then run a faster slightly less optimal diff.
+   * @param deadline Time when the diff should be complete by.
+   * @return Linked List of Diff objects.
+   */
+  private LinkedList<Diff> diff_compute(String text1, String text2,
+                                        boolean checklines, long deadline) {
+    LinkedList<Diff> diffs = new LinkedList<Diff>();
+
+    if (text1.length() == 0) {
+      // Just add some text (speedup).
+      diffs.add(new Diff(Operation.INSERT, text2));
+      return diffs;
+    }
+
+    if (text2.length() == 0) {
+      // Just delete some text (speedup).
+      diffs.add(new Diff(Operation.DELETE, text1));
+      return diffs;
+    }
+
+    {
+      // New scope so as to garbage collect longtext and shorttext.
+      String longtext = text1.length() > text2.length() ? text1 : text2;
+      String shorttext = text1.length() > text2.length() ? text2 : text1;
+      int i = longtext.indexOf(shorttext);
+      if (i != -1) {
+        // Shorter text is inside the longer text (speedup).
+        Operation op = (text1.length() > text2.length()) ?
+                       Operation.DELETE : Operation.INSERT;
+        diffs.add(new Diff(op, longtext.substring(0, i)));
+        diffs.add(new Diff(Operation.EQUAL, shorttext));
+        diffs.add(new Diff(op, longtext.substring(i + shorttext.length())));
+        return diffs;
+      }
+  
+      if (shorttext.length() == 1) {
+        // Single character string.
+        // After the previous speedup, the character can't be an equality.
+        diffs.add(new Diff(Operation.DELETE, text1));
+        diffs.add(new Diff(Operation.INSERT, text2));
+        return diffs;
+      }
+    }
+
+    // Check to see if the problem can be split in two.
+    String[] hm = diff_halfMatch(text1, text2);
+    if (hm != null) {
+      // A half-match was found, sort out the return data.
+      String text1_a = hm[0];
+      String text1_b = hm[1];
+      String text2_a = hm[2];
+      String text2_b = hm[3];
+      String mid_common = hm[4];
+      // Send both pairs off for separate processing.
+      LinkedList<Diff> diffs_a = diff_main(text1_a, text2_a,
+                                           checklines, deadline);
+      LinkedList<Diff> diffs_b = diff_main(text1_b, text2_b,
+                                           checklines, deadline);
+      // Merge the results.
+      diffs = diffs_a;
+      diffs.add(new Diff(Operation.EQUAL, mid_common));
+      diffs.addAll(diffs_b);
+      return diffs;
+    }
+
+    if (checklines && text1.length() > 100 && text2.length() > 100) {
+      return diff_lineMode(text1, text2, deadline);
+    }
+
+    return diff_bisect(text1, text2, deadline);
+  }
+
+  /**
+   * Do a quick line-level diff on both strings, then rediff the parts for
+   * greater accuracy.
+   * This speedup can produce non-minimal diffs.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @param deadline Time when the diff should be complete by.
+   * @return Linked List of Diff objects.
+   */
+  private LinkedList<Diff> diff_lineMode(String text1, String text2,
+                                         long deadline) {
+    // Scan the text on a line-by-line basis first.
+    LinesToCharsResult b = diff_linesToChars(text1, text2);
+    text1 = b.chars1;
+    text2 = b.chars2;
+    List<String> linearray = b.lineArray;
+
+    LinkedList<Diff> diffs = diff_main(text1, text2, false, deadline);
+
+    // Convert the diff back to original text.
+    diff_charsToLines(diffs, linearray);
+    // Eliminate freak matches (e.g. blank lines)
+    diff_cleanupSemantic(diffs);
+
+    // Rediff any replacement blocks, this time character-by-character.
+    // Add a dummy entry at the end.
+    diffs.add(new Diff(Operation.EQUAL, ""));
+    int count_delete = 0;
+    int count_insert = 0;
+    String text_delete = "";
+    String text_insert = "";
+    ListIterator<Diff> pointer = diffs.listIterator();
+    Diff thisDiff = pointer.next();
+    while (thisDiff != null) {
+      switch (thisDiff.operation) {
+      case INSERT:
+        count_insert++;
+        text_insert += thisDiff.text;
+        break;
+      case DELETE:
+        count_delete++;
+        text_delete += thisDiff.text;
+        break;
+      case EQUAL:
+        // Upon reaching an equality, check for prior redundancies.
+        if (count_delete >= 1 && count_insert >= 1) {
+          // Delete the offending records and add the merged ones.
+          pointer.previous();
+          for (int j = 0; j < count_delete + count_insert; j++) {
+            pointer.previous();
+            pointer.remove();
+          }
+          for (Diff newDiff : diff_main(text_delete, text_insert, false,
+              deadline)) {
+            pointer.add(newDiff);
+          }
+        }
+        count_insert = 0;
+        count_delete = 0;
+        text_delete = "";
+        text_insert = "";
+        break;
+      }
+      thisDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+    diffs.removeLast();  // Remove the dummy entry at the end.
+
+    return diffs;
+  }
+
+  /**
+   * Find the 'middle snake' of a diff, split the problem in two
+   * and return the recursively constructed diff.
+   * See Myers 1986 paper: An O(ND) Difference Algorithm and Its Variations.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @param deadline Time at which to bail if not yet complete.
+   * @return LinkedList of Diff objects.
+   */
+  protected LinkedList<Diff> diff_bisect(String text1, String text2,
+      long deadline) {
+    // Cache the text lengths to prevent multiple calls.
+    int text1_length = text1.length();
+    int text2_length = text2.length();
+    int max_d = (text1_length + text2_length + 1) / 2;
+    int v_offset = max_d;
+    int v_length = 2 * max_d;
+    int[] v1 = new int[v_length];
+    int[] v2 = new int[v_length];
+    for (int x = 0; x < v_length; x++) {
+      v1[x] = -1;
+      v2[x] = -1;
+    }
+    v1[v_offset + 1] = 0;
+    v2[v_offset + 1] = 0;
+    int delta = text1_length - text2_length;
+    // If the total number of characters is odd, then the front path will
+    // collide with the reverse path.
+    boolean front = (delta % 2 != 0);
+    // Offsets for start and end of k loop.
+    // Prevents mapping of space beyond the grid.
+    int k1start = 0;
+    int k1end = 0;
+    int k2start = 0;
+    int k2end = 0;
+    for (int d = 0; d < max_d; d++) {
+      // Bail out if deadline is reached.
+      if (System.currentTimeMillis() > deadline) {
+        break;
+      }
+
+      // Walk the front path one step.
+      for (int k1 = -d + k1start; k1 <= d - k1end; k1 += 2) {
+        int k1_offset = v_offset + k1;
+        int x1;
+        if (k1 == -d || (k1 != d && v1[k1_offset - 1] < v1[k1_offset + 1])) {
+          x1 = v1[k1_offset + 1];
+        } else {
+          x1 = v1[k1_offset - 1] + 1;
+        }
+        int y1 = x1 - k1;
+        while (x1 < text1_length && y1 < text2_length
+               && text1.charAt(x1) == text2.charAt(y1)) {
+          x1++;
+          y1++;
+        }
+        v1[k1_offset] = x1;
+        if (x1 > text1_length) {
+          // Ran off the right of the graph.
+          k1end += 2;
+        } else if (y1 > text2_length) {
+          // Ran off the bottom of the graph.
+          k1start += 2;
+        } else if (front) {
+          int k2_offset = v_offset + delta - k1;
+          if (k2_offset >= 0 && k2_offset < v_length && v2[k2_offset] != -1) {
+            // Mirror x2 onto top-left coordinate system.
+            int x2 = text1_length - v2[k2_offset];
+            if (x1 >= x2) {
+              // Overlap detected.
+              return diff_bisectSplit(text1, text2, x1, y1, deadline);
+            }
+          }
+        }
+      }
+
+      // Walk the reverse path one step.
+      for (int k2 = -d + k2start; k2 <= d - k2end; k2 += 2) {
+        int k2_offset = v_offset + k2;
+        int x2;
+        if (k2 == -d || (k2 != d && v2[k2_offset - 1] < v2[k2_offset + 1])) {
+          x2 = v2[k2_offset + 1];
+        } else {
+          x2 = v2[k2_offset - 1] + 1;
+        }
+        int y2 = x2 - k2;
+        while (x2 < text1_length && y2 < text2_length
+               && text1.charAt(text1_length - x2 - 1)
+               == text2.charAt(text2_length - y2 - 1)) {
+          x2++;
+          y2++;
+        }
+        v2[k2_offset] = x2;
+        if (x2 > text1_length) {
+          // Ran off the left of the graph.
+          k2end += 2;
+        } else if (y2 > text2_length) {
+          // Ran off the top of the graph.
+          k2start += 2;
+        } else if (!front) {
+          int k1_offset = v_offset + delta - k2;
+          if (k1_offset >= 0 && k1_offset < v_length && v1[k1_offset] != -1) {
+            int x1 = v1[k1_offset];
+            int y1 = v_offset + x1 - k1_offset;
+            // Mirror x2 onto top-left coordinate system.
+            x2 = text1_length - x2;
+            if (x1 >= x2) {
+              // Overlap detected.
+              return diff_bisectSplit(text1, text2, x1, y1, deadline);
+            }
+          }
+        }
+      }
+    }
+    // Diff took too long and hit the deadline or
+    // number of diffs equals number of characters, no commonality at all.
+    LinkedList<Diff> diffs = new LinkedList<Diff>();
+    diffs.add(new Diff(Operation.DELETE, text1));
+    diffs.add(new Diff(Operation.INSERT, text2));
+    return diffs;
+  }
+
+  /**
+   * Given the location of the 'middle snake', split the diff in two parts
+   * and recurse.
+   * @param text1 Old string to be diffed.
+   * @param text2 New string to be diffed.
+   * @param x Index of split point in text1.
+   * @param y Index of split point in text2.
+   * @param deadline Time at which to bail if not yet complete.
+   * @return LinkedList of Diff objects.
+   */
+  private LinkedList<Diff> diff_bisectSplit(String text1, String text2,
+                                            int x, int y, long deadline) {
+    String text1a = text1.substring(0, x);
+    String text2a = text2.substring(0, y);
+    String text1b = text1.substring(x);
+    String text2b = text2.substring(y);
+
+    // Compute both diffs serially.
+    LinkedList<Diff> diffs = diff_main(text1a, text2a, false, deadline);
+    LinkedList<Diff> diffsb = diff_main(text1b, text2b, false, deadline);
+
+    diffs.addAll(diffsb);
+    return diffs;
+  }
+
+  /**
+   * Split two texts into a list of strings.  Reduce the texts to a string of
+   * hashes where each Unicode character represents one line.
+   * @param text1 First string.
+   * @param text2 Second string.
+   * @return An object containing the encoded text1, the encoded text2 and
+   *     the List of unique strings.  The zeroth element of the List of
+   *     unique strings is intentionally blank.
+   */
+  protected LinesToCharsResult diff_linesToChars(String text1, String text2) {
+    List<String> lineArray = new ArrayList<String>();
+    Map<String, Integer> lineHash = new HashMap<String, Integer>();
+    // e.g. linearray[4] == "Hello\n"
+    // e.g. linehash.get("Hello\n") == 4
+
+    // "\x00" is a valid character, but various debuggers don't like it.
+    // So we'll insert a junk entry to avoid generating a null character.
+    lineArray.add("");
+
+    String chars1 = diff_linesToCharsMunge(text1, lineArray, lineHash);
+    String chars2 = diff_linesToCharsMunge(text2, lineArray, lineHash);
+    return new LinesToCharsResult(chars1, chars2, lineArray);
+  }
+
+  /**
+   * Split a text into a list of strings.  Reduce the texts to a string of
+   * hashes where each Unicode character represents one line.
+   * @param text String to encode.
+   * @param lineArray List of unique strings.
+   * @param lineHash Map of strings to indices.
+   * @return Encoded string.
+   */
+  private String diff_linesToCharsMunge(String text, List<String> lineArray,
+                                        Map<String, Integer> lineHash) {
+    int lineStart = 0;
+    int lineEnd = -1;
+    String line;
+    StringBuilder chars = new StringBuilder();
+    // Walk the text, pulling out a substring for each line.
+    // text.split('\n') would would temporarily double our memory footprint.
+    // Modifying text would create many large strings to garbage collect.
+    while (lineEnd < text.length() - 1) {
+      lineEnd = text.indexOf('\n', lineStart);
+      if (lineEnd == -1) {
+        lineEnd = text.length() - 1;
+      }
+      line = text.substring(lineStart, lineEnd + 1);
+      lineStart = lineEnd + 1;
+
+      if (lineHash.containsKey(line)) {
+        chars.append(String.valueOf((char) (int) lineHash.get(line)));
+      } else {
+        lineArray.add(line);
+        lineHash.put(line, lineArray.size() - 1);
+        chars.append(String.valueOf((char) (lineArray.size() - 1)));
+      }
+    }
+    return chars.toString();
+  }
+
+  /**
+   * Rehydrate the text in a diff from a string of line hashes to real lines of
+   * text.
+   * @param diffs LinkedList of Diff objects.
+   * @param lineArray List of unique strings.
+   */
+  protected void diff_charsToLines(LinkedList<Diff> diffs,
+                                  List<String> lineArray) {
+    StringBuilder text;
+    for (Diff diff : diffs) {
+      text = new StringBuilder();
+      for (int y = 0; y < diff.text.length(); y++) {
+        text.append(lineArray.get(diff.text.charAt(y)));
+      }
+      diff.text = text.toString();
+    }
+  }
+
+  /**
+   * Determine the common prefix of two strings
+   * @param text1 First string.
+   * @param text2 Second string.
+   * @return The number of characters common to the start of each string.
+   */
+  public int diff_commonPrefix(String text1, String text2) {
+    // Performance analysis: http://neil.fraser.name/news/2007/10/09/
+    int n = Math.min(text1.length(), text2.length());
+    for (int i = 0; i < n; i++) {
+      if (text1.charAt(i) != text2.charAt(i)) {
+        return i;
+      }
+    }
+    return n;
+  }
+
+  /**
+   * Determine the common suffix of two strings
+   * @param text1 First string.
+   * @param text2 Second string.
+   * @return The number of characters common to the end of each string.
+   */
+  public int diff_commonSuffix(String text1, String text2) {
+    // Performance analysis: http://neil.fraser.name/news/2007/10/09/
+    int text1_length = text1.length();
+    int text2_length = text2.length();
+    int n = Math.min(text1_length, text2_length);
+    for (int i = 1; i <= n; i++) {
+      if (text1.charAt(text1_length - i) != text2.charAt(text2_length - i)) {
+        return i - 1;
+      }
+    }
+    return n;
+  }
+
+  /**
+   * Determine if the suffix of one string is the prefix of another.
+   * @param text1 First string.
+   * @param text2 Second string.
+   * @return The number of characters common to the end of the first
+   *     string and the start of the second string.
+   */
+  protected int diff_commonOverlap(String text1, String text2) {
+    // Cache the text lengths to prevent multiple calls.
+    int text1_length = text1.length();
+    int text2_length = text2.length();
+    // Eliminate the null case.
+    if (text1_length == 0 || text2_length == 0) {
+      return 0;
+    }
+    // Truncate the longer string.
+    if (text1_length > text2_length) {
+      text1 = text1.substring(text1_length - text2_length);
+    } else if (text1_length < text2_length) {
+      text2 = text2.substring(0, text1_length);
+    }
+    int text_length = Math.min(text1_length, text2_length);
+    // Quick check for the worst case.
+    if (text1.equals(text2)) {
+      return text_length;
+    }
+
+    // Start by looking for a single character match
+    // and increase length until no match is found.
+    // Performance analysis: http://neil.fraser.name/news/2010/11/04/
+    int best = 0;
+    int length = 1;
+    while (true) {
+      String pattern = text1.substring(text_length - length);
+      int found = text2.indexOf(pattern);
+      if (found == -1) {
+        return best;
+      }
+      length += found;
+      if (found == 0 || text1.substring(text_length - length).equals(
+          text2.substring(0, length))) {
+        best = length;
+        length++;
+      }
+    }
+  }
+
+  /**
+   * Do the two texts share a substring which is at least half the length of
+   * the longer text?
+   * This speedup can produce non-minimal diffs.
+   * @param text1 First string.
+   * @param text2 Second string.
+   * @return Five element String array, containing the prefix of text1, the
+   *     suffix of text1, the prefix of text2, the suffix of text2 and the
+   *     common middle.  Or null if there was no match.
+   */
+  protected String[] diff_halfMatch(String text1, String text2) {
+    if (Diff_Timeout <= 0) {
+      // Don't risk returning a non-optimal diff if we have unlimited time.
+      return null;
+    }
+    String longtext = text1.length() > text2.length() ? text1 : text2;
+    String shorttext = text1.length() > text2.length() ? text2 : text1;
+    if (longtext.length() < 4 || shorttext.length() * 2 < longtext.length()) {
+      return null;  // Pointless.
+    }
+
+    // First check if the second quarter is the seed for a half-match.
+    String[] hm1 = diff_halfMatchI(longtext, shorttext,
+                                   (longtext.length() + 3) / 4);
+    // Check again based on the third quarter.
+    String[] hm2 = diff_halfMatchI(longtext, shorttext,
+                                   (longtext.length() + 1) / 2);
+    String[] hm;
+    if (hm1 == null && hm2 == null) {
+      return null;
+    } else if (hm2 == null) {
+      hm = hm1;
+    } else if (hm1 == null) {
+      hm = hm2;
+    } else {
+      // Both matched.  Select the longest.
+      hm = hm1[4].length() > hm2[4].length() ? hm1 : hm2;
+    }
+
+    // A half-match was found, sort out the return data.
+    if (text1.length() > text2.length()) {
+      return hm;
+      //return new String[]{hm[0], hm[1], hm[2], hm[3], hm[4]};
+    } else {
+      return new String[]{hm[2], hm[3], hm[0], hm[1], hm[4]};
+    }
+  }
+
+  /**
+   * Does a substring of shorttext exist within longtext such that the
+   * substring is at least half the length of longtext?
+   * @param longtext Longer string.
+   * @param shorttext Shorter string.
+   * @param i Start index of quarter length substring within longtext.
+   * @return Five element String array, containing the prefix of longtext, the
+   *     suffix of longtext, the prefix of shorttext, the suffix of shorttext
+   *     and the common middle.  Or null if there was no match.
+   */
+  private String[] diff_halfMatchI(String longtext, String shorttext, int i) {
+    // Start with a 1/4 length substring at position i as a seed.
+    String seed = longtext.substring(i, i + longtext.length() / 4);
+    int j = -1;
+    String best_common = "";
+    String best_longtext_a = "", best_longtext_b = "";
+    String best_shorttext_a = "", best_shorttext_b = "";
+    while ((j = shorttext.indexOf(seed, j + 1)) != -1) {
+      int prefixLength = diff_commonPrefix(longtext.substring(i),
+                                           shorttext.substring(j));
+      int suffixLength = diff_commonSuffix(longtext.substring(0, i),
+                                           shorttext.substring(0, j));
+      if (best_common.length() < suffixLength + prefixLength) {
+        best_common = shorttext.substring(j - suffixLength, j)
+            + shorttext.substring(j, j + prefixLength);
+        best_longtext_a = longtext.substring(0, i - suffixLength);
+        best_longtext_b = longtext.substring(i + prefixLength);
+        best_shorttext_a = shorttext.substring(0, j - suffixLength);
+        best_shorttext_b = shorttext.substring(j + prefixLength);
+      }
+    }
+    if (best_common.length() * 2 >= longtext.length()) {
+      return new String[]{best_longtext_a, best_longtext_b,
+                          best_shorttext_a, best_shorttext_b, best_common};
+    } else {
+      return null;
+    }
+  }
+
+  /**
+   * Reduce the number of edits by eliminating semantically trivial equalities.
+   * @param diffs LinkedList of Diff objects.
+   */
+  public void diff_cleanupSemantic(LinkedList<Diff> diffs) {
+    if (diffs.isEmpty()) {
+      return;
+    }
+    boolean changes = false;
+    Stack<Diff> equalities = new Stack<Diff>();  // Stack of qualities.
+    String lastequality = null; // Always equal to equalities.lastElement().text
+    ListIterator<Diff> pointer = diffs.listIterator();
+    // Number of characters that changed prior to the equality.
+    int length_insertions1 = 0;
+    int length_deletions1 = 0;
+    // Number of characters that changed after the equality.
+    int length_insertions2 = 0;
+    int length_deletions2 = 0;
+    Diff thisDiff = pointer.next();
+    while (thisDiff != null) {
+      if (thisDiff.operation == Operation.EQUAL) {
+        // Equality found.
+        equalities.push(thisDiff);
+        length_insertions1 = length_insertions2;
+        length_deletions1 = length_deletions2;
+        length_insertions2 = 0;
+        length_deletions2 = 0;
+        lastequality = thisDiff.text;
+      } else {
+        // An insertion or deletion.
+        if (thisDiff.operation == Operation.INSERT) {
+          length_insertions2 += thisDiff.text.length();
+        } else {
+          length_deletions2 += thisDiff.text.length();
+        }
+        // Eliminate an equality that is smaller or equal to the edits on both
+        // sides of it.
+        if (lastequality != null && (lastequality.length()
+            <= Math.max(length_insertions1, length_deletions1))
+            && (lastequality.length()
+                <= Math.max(length_insertions2, length_deletions2))) {
+          //System.out.println("Splitting: '" + lastequality + "'");
+          // Walk back to offending equality.
+          while (thisDiff != equalities.lastElement()) {
+            thisDiff = pointer.previous();
+          }
+          pointer.next();
+
+          // Replace equality with a delete.
+          pointer.set(new Diff(Operation.DELETE, lastequality));
+          // Insert a corresponding an insert.
+          pointer.add(new Diff(Operation.INSERT, lastequality));
+
+          equalities.pop();  // Throw away the equality we just deleted.
+          if (!equalities.empty()) {
+            // Throw away the previous equality (it needs to be reevaluated).
+            equalities.pop();
+          }
+          if (equalities.empty()) {
+            // There are no previous equalities, walk back to the start.
+            while (pointer.hasPrevious()) {
+              pointer.previous();
+            }
+          } else {
+            // There is a safe equality we can fall back to.
+            thisDiff = equalities.lastElement();
+            while (thisDiff != pointer.previous()) {
+              // Intentionally empty loop.
+            }
+          }
+
+          length_insertions1 = 0;  // Reset the counters.
+          length_insertions2 = 0;
+          length_deletions1 = 0;
+          length_deletions2 = 0;
+          lastequality = null;
+          changes = true;
+        }
+      }
+      thisDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+
+    // Normalize the diff.
+    if (changes) {
+      diff_cleanupMerge(diffs);
+    }
+    diff_cleanupSemanticLossless(diffs);
+
+    // Find any overlaps between deletions and insertions.
+    // e.g: <del>abcxxx</del><ins>xxxdef</ins>
+    //   -> <del>abc</del>xxx<ins>def</ins>
+    // e.g: <del>xxxabc</del><ins>defxxx</ins>
+    //   -> <ins>def</ins>xxx<del>abc</del>
+    // Only extract an overlap if it is as big as the edit ahead or behind it.
+    pointer = diffs.listIterator();
+    Diff prevDiff = null;
+    thisDiff = null;
+    if (pointer.hasNext()) {
+      prevDiff = pointer.next();
+      if (pointer.hasNext()) {
+        thisDiff = pointer.next();
+      }
+    }
+    while (thisDiff != null) {
+      if (prevDiff.operation == Operation.DELETE &&
+          thisDiff.operation == Operation.INSERT) {
+        String deletion = prevDiff.text;
+        String insertion = thisDiff.text;
+        int overlap_length1 = this.diff_commonOverlap(deletion, insertion);
+        int overlap_length2 = this.diff_commonOverlap(insertion, deletion);
+        if (overlap_length1 >= overlap_length2) {
+          if (overlap_length1 >= deletion.length() / 2.0 ||
+              overlap_length1 >= insertion.length() / 2.0) {
+            // Overlap found.  Insert an equality and trim the surrounding edits.
+            pointer.previous();
+            pointer.add(new Diff(Operation.EQUAL,
+                                 insertion.substring(0, overlap_length1)));
+            prevDiff.text =
+                deletion.substring(0, deletion.length() - overlap_length1);
+            thisDiff.text = insertion.substring(overlap_length1);
+            // pointer.add inserts the element before the cursor, so there is
+            // no need to step past the new element.
+          }
+        } else {
+          if (overlap_length2 >= deletion.length() / 2.0 ||
+              overlap_length2 >= insertion.length() / 2.0) {
+            // Reverse overlap found.
+            // Insert an equality and swap and trim the surrounding edits.
+            pointer.previous();
+            pointer.add(new Diff(Operation.EQUAL,
+                                 deletion.substring(0, overlap_length2)));
+            prevDiff.operation = Operation.INSERT;
+            prevDiff.text =
+              insertion.substring(0, insertion.length() - overlap_length2);
+            thisDiff.operation = Operation.DELETE;
+            thisDiff.text = deletion.substring(overlap_length2);
+            // pointer.add inserts the element before the cursor, so there is
+            // no need to step past the new element.
+          }
+        }
+        thisDiff = pointer.hasNext() ? pointer.next() : null;
+      }
+      prevDiff = thisDiff;
+      thisDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+  }
+
+  /**
+   * Look for single edits surrounded on both sides by equalities
+   * which can be shifted sideways to align the edit to a word boundary.
+   * e.g: The c<ins>at c</ins>ame. -> The <ins>cat </ins>came.
+   * @param diffs LinkedList of Diff objects.
+   */
+  public void diff_cleanupSemanticLossless(LinkedList<Diff> diffs) {
+    String equality1, edit, equality2;
+    String commonString;
+    int commonOffset;
+    int score, bestScore;
+    String bestEquality1, bestEdit, bestEquality2;
+    // Create a new iterator at the start.
+    ListIterator<Diff> pointer = diffs.listIterator();
+    Diff prevDiff = pointer.hasNext() ? pointer.next() : null;
+    Diff thisDiff = pointer.hasNext() ? pointer.next() : null;
+    Diff nextDiff = pointer.hasNext() ? pointer.next() : null;
+    // Intentionally ignore the first and last element (don't need checking).
+    while (nextDiff != null) {
+      if (prevDiff.operation == Operation.EQUAL &&
+          nextDiff.operation == Operation.EQUAL) {
+        // This is a single edit surrounded by equalities.
+        equality1 = prevDiff.text;
+        edit = thisDiff.text;
+        equality2 = nextDiff.text;
+
+        // First, shift the edit as far left as possible.
+        commonOffset = diff_commonSuffix(equality1, edit);
+        if (commonOffset != 0) {
+          commonString = edit.substring(edit.length() - commonOffset);
+          equality1 = equality1.substring(0, equality1.length() - commonOffset);
+          edit = commonString + edit.substring(0, edit.length() - commonOffset);
+          equality2 = commonString + equality2;
+        }
+
+        // Second, step character by character right, looking for the best fit.
+        bestEquality1 = equality1;
+        bestEdit = edit;
+        bestEquality2 = equality2;
+        bestScore = diff_cleanupSemanticScore(equality1, edit)
+            + diff_cleanupSemanticScore(edit, equality2);
+        while (edit.length() != 0 && equality2.length() != 0
+            && edit.charAt(0) == equality2.charAt(0)) {
+          equality1 += edit.charAt(0);
+          edit = edit.substring(1) + equality2.charAt(0);
+          equality2 = equality2.substring(1);
+          score = diff_cleanupSemanticScore(equality1, edit)
+              + diff_cleanupSemanticScore(edit, equality2);
+          // The >= encourages trailing rather than leading whitespace on edits.
+          if (score >= bestScore) {
+            bestScore = score;
+            bestEquality1 = equality1;
+            bestEdit = edit;
+            bestEquality2 = equality2;
+          }
+        }
+
+        if (!prevDiff.text.equals(bestEquality1)) {
+          // We have an improvement, save it back to the diff.
+          if (bestEquality1.length() != 0) {
+            prevDiff.text = bestEquality1;
+          } else {
+            pointer.previous(); // Walk past nextDiff.
+            pointer.previous(); // Walk past thisDiff.
+            pointer.previous(); // Walk past prevDiff.
+            pointer.remove(); // Delete prevDiff.
+            pointer.next(); // Walk past thisDiff.
+            pointer.next(); // Walk past nextDiff.
+          }
+          thisDiff.text = bestEdit;
+          if (bestEquality2.length() != 0) {
+            nextDiff.text = bestEquality2;
+          } else {
+            pointer.remove(); // Delete nextDiff.
+            nextDiff = thisDiff;
+            thisDiff = prevDiff;
+          }
+        }
+      }
+      prevDiff = thisDiff;
+      thisDiff = nextDiff;
+      nextDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+  }
+
+  /**
+   * Given two strings, compute a score representing whether the internal
+   * boundary falls on logical boundaries.
+   * Scores range from 6 (best) to 0 (worst).
+   * @param one First string.
+   * @param two Second string.
+   * @return The score.
+   */
+  private int diff_cleanupSemanticScore(String one, String two) {
+    if (one.length() == 0 || two.length() == 0) {
+      // Edges are the best.
+      return 6;
+    }
+
+    // Each port of this function behaves slightly differently due to
+    // subtle differences in each language's definition of things like
+    // 'whitespace'.  Since this function's purpose is largely cosmetic,
+    // the choice has been made to use each language's native features
+    // rather than force total conformity.
+    char char1 = one.charAt(one.length() - 1);
+    char char2 = two.charAt(0);
+    boolean nonAlphaNumeric1 = !Character.isLetterOrDigit(char1);
+    boolean nonAlphaNumeric2 = !Character.isLetterOrDigit(char2);
+    boolean whitespace1 = nonAlphaNumeric1 && Character.isWhitespace(char1);
+    boolean whitespace2 = nonAlphaNumeric2 && Character.isWhitespace(char2);
+    boolean lineBreak1 = whitespace1
+        && Character.getType(char1) == Character.CONTROL;
+    boolean lineBreak2 = whitespace2
+        && Character.getType(char2) == Character.CONTROL;
+    boolean blankLine1 = lineBreak1 && BLANKLINEEND.matcher(one).find();
+    boolean blankLine2 = lineBreak2 && BLANKLINESTART.matcher(two).find();
+
+    if (blankLine1 || blankLine2) {
+      // Five points for blank lines.
+      return 5;
+    } else if (lineBreak1 || lineBreak2) {
+      // Four points for line breaks.
+      return 4;
+    } else if (nonAlphaNumeric1 && !whitespace1 && whitespace2) {
+      // Three points for end of sentences.
+      return 3;
+    } else if (whitespace1 || whitespace2) {
+      // Two points for whitespace.
+      return 2;
+    } else if (nonAlphaNumeric1 || nonAlphaNumeric2) {
+      // One point for non-alphanumeric.
+      return 1;
+    }
+    return 0;
+  }
+
+  // Define some regex patterns for matching boundaries.
+  private Pattern BLANKLINEEND
+      = Pattern.compile("\\n\\r?\\n\\Z", Pattern.DOTALL);
+  private Pattern BLANKLINESTART
+      = Pattern.compile("\\A\\r?\\n\\r?\\n", Pattern.DOTALL);
+
+  /**
+   * Reduce the number of edits by eliminating operationally trivial equalities.
+   * @param diffs LinkedList of Diff objects.
+   */
+  public void diff_cleanupEfficiency(LinkedList<Diff> diffs) {
+    if (diffs.isEmpty()) {
+      return;
+    }
+    boolean changes = false;
+    Stack<Diff> equalities = new Stack<Diff>();  // Stack of equalities.
+    String lastequality = null; // Always equal to equalities.lastElement().text
+    ListIterator<Diff> pointer = diffs.listIterator();
+    // Is there an insertion operation before the last equality.
+    boolean pre_ins = false;
+    // Is there a deletion operation before the last equality.
+    boolean pre_del = false;
+    // Is there an insertion operation after the last equality.
+    boolean post_ins = false;
+    // Is there a deletion operation after the last equality.
+    boolean post_del = false;
+    Diff thisDiff = pointer.next();
+    Diff safeDiff = thisDiff;  // The last Diff that is known to be unsplitable.
+    while (thisDiff != null) {
+      if (thisDiff.operation == Operation.EQUAL) {
+        // Equality found.
+        if (thisDiff.text.length() < Diff_EditCost && (post_ins || post_del)) {
+          // Candidate found.
+          equalities.push(thisDiff);
+          pre_ins = post_ins;
+          pre_del = post_del;
+          lastequality = thisDiff.text;
+        } else {
+          // Not a candidate, and can never become one.
+          equalities.clear();
+          lastequality = null;
+          safeDiff = thisDiff;
+        }
+        post_ins = post_del = false;
+      } else {
+        // An insertion or deletion.
+        if (thisDiff.operation == Operation.DELETE) {
+          post_del = true;
+        } else {
+          post_ins = true;
+        }
+        /*
+         * Five types to be split:
+         * <ins>A</ins><del>B</del>XY<ins>C</ins><del>D</del>
+         * <ins>A</ins>X<ins>C</ins><del>D</del>
+         * <ins>A</ins><del>B</del>X<ins>C</ins>
+         * <ins>A</del>X<ins>C</ins><del>D</del>
+         * <ins>A</ins><del>B</del>X<del>C</del>
+         */
+        if (lastequality != null
+            && ((pre_ins && pre_del && post_ins && post_del)
+                || ((lastequality.length() < Diff_EditCost / 2)
+                    && ((pre_ins ? 1 : 0) + (pre_del ? 1 : 0)
+                        + (post_ins ? 1 : 0) + (post_del ? 1 : 0)) == 3))) {
+          //System.out.println("Splitting: '" + lastequality + "'");
+          // Walk back to offending equality.
+          while (thisDiff != equalities.lastElement()) {
+            thisDiff = pointer.previous();
+          }
+          pointer.next();
+
+          // Replace equality with a delete.
+          pointer.set(new Diff(Operation.DELETE, lastequality));
+          // Insert a corresponding an insert.
+          pointer.add(thisDiff = new Diff(Operation.INSERT, lastequality));
+
+          equalities.pop();  // Throw away the equality we just deleted.
+          lastequality = null;
+          if (pre_ins && pre_del) {
+            // No changes made which could affect previous entry, keep going.
+            post_ins = post_del = true;
+            equalities.clear();
+            safeDiff = thisDiff;
+          } else {
+            if (!equalities.empty()) {
+              // Throw away the previous equality (it needs to be reevaluated).
+              equalities.pop();
+            }
+            if (equalities.empty()) {
+              // There are no previous questionable equalities,
+              // walk back to the last known safe diff.
+              thisDiff = safeDiff;
+            } else {
+              // There is an equality we can fall back to.
+              thisDiff = equalities.lastElement();
+            }
+            while (thisDiff != pointer.previous()) {
+              // Intentionally empty loop.
+            }
+            post_ins = post_del = false;
+          }
+
+          changes = true;
+        }
+      }
+      thisDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+
+    if (changes) {
+      diff_cleanupMerge(diffs);
+    }
+  }
+
+  /**
+   * Reorder and merge like edit sections.  Merge equalities.
+   * Any edit section can move as long as it doesn't cross an equality.
+   * @param diffs LinkedList of Diff objects.
+   */
+  public void diff_cleanupMerge(LinkedList<Diff> diffs) {
+    diffs.add(new Diff(Operation.EQUAL, ""));  // Add a dummy entry at the end.
+    ListIterator<Diff> pointer = diffs.listIterator();
+    int count_delete = 0;
+    int count_insert = 0;
+    String text_delete = "";
+    String text_insert = "";
+    Diff thisDiff = pointer.next();
+    Diff prevEqual = null;
+    int commonlength;
+    while (thisDiff != null) {
+      switch (thisDiff.operation) {
+      case INSERT:
+        count_insert++;
+        text_insert += thisDiff.text;
+        prevEqual = null;
+        break;
+      case DELETE:
+        count_delete++;
+        text_delete += thisDiff.text;
+        prevEqual = null;
+        break;
+      case EQUAL:
+        if (count_delete + count_insert > 1) {
+          boolean both_types = count_delete != 0 && count_insert != 0;
+          // Delete the offending records.
+          pointer.previous();  // Reverse direction.
+          while (count_delete-- > 0) {
+            pointer.previous();
+            pointer.remove();
+          }
+          while (count_insert-- > 0) {
+            pointer.previous();
+            pointer.remove();
+          }
+          if (both_types) {
+            // Factor out any common prefixies.
+            commonlength = diff_commonPrefix(text_insert, text_delete);
+            if (commonlength != 0) {
+              if (pointer.hasPrevious()) {
+                thisDiff = pointer.previous();
+                assert thisDiff.operation == Operation.EQUAL
+                       : "Previous diff should have been an equality.";
+                thisDiff.text += text_insert.substring(0, commonlength);
+                pointer.next();
+              } else {
+                pointer.add(new Diff(Operation.EQUAL,
+                    text_insert.substring(0, commonlength)));
+              }
+              text_insert = text_insert.substring(commonlength);
+              text_delete = text_delete.substring(commonlength);
+            }
+            // Factor out any common suffixies.
+            commonlength = diff_commonSuffix(text_insert, text_delete);
+            if (commonlength != 0) {
+              thisDiff = pointer.next();
+              thisDiff.text = text_insert.substring(text_insert.length()
+                  - commonlength) + thisDiff.text;
+              text_insert = text_insert.substring(0, text_insert.length()
+                  - commonlength);
+              text_delete = text_delete.substring(0, text_delete.length()
+                  - commonlength);
+              pointer.previous();
+            }
+          }
+          // Insert the merged records.
+          if (text_delete.length() != 0) {
+            pointer.add(new Diff(Operation.DELETE, text_delete));
+          }
+          if (text_insert.length() != 0) {
+            pointer.add(new Diff(Operation.INSERT, text_insert));
+          }
+          // Step forward to the equality.
+          thisDiff = pointer.hasNext() ? pointer.next() : null;
+        } else if (prevEqual != null) {
+          // Merge this equality with the previous one.
+          prevEqual.text += thisDiff.text;
+          pointer.remove();
+          thisDiff = pointer.previous();
+          pointer.next();  // Forward direction
+        }
+        count_insert = 0;
+        count_delete = 0;
+        text_delete = "";
+        text_insert = "";
+        prevEqual = thisDiff;
+        break;
+      }
+      thisDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+    if (diffs.getLast().text.length() == 0) {
+      diffs.removeLast();  // Remove the dummy entry at the end.
+    }
+
+    /*
+     * Second pass: look for single edits surrounded on both sides by equalities
+     * which can be shifted sideways to eliminate an equality.
+     * e.g: A<ins>BA</ins>C -> <ins>AB</ins>AC
+     */
+    boolean changes = false;
+    // Create a new iterator at the start.
+    // (As opposed to walking the current one back.)
+    pointer = diffs.listIterator();
+    Diff prevDiff = pointer.hasNext() ? pointer.next() : null;
+    thisDiff = pointer.hasNext() ? pointer.next() : null;
+    Diff nextDiff = pointer.hasNext() ? pointer.next() : null;
+    // Intentionally ignore the first and last element (don't need checking).
+    while (nextDiff != null) {
+      if (prevDiff.operation == Operation.EQUAL &&
+          nextDiff.operation == Operation.EQUAL) {
+        // This is a single edit surrounded by equalities.
+        if (thisDiff.text.endsWith(prevDiff.text)) {
+          // Shift the edit over the previous equality.
+          thisDiff.text = prevDiff.text
+              + thisDiff.text.substring(0, thisDiff.text.length()
+                                           - prevDiff.text.length());
+          nextDiff.text = prevDiff.text + nextDiff.text;
+          pointer.previous(); // Walk past nextDiff.
+          pointer.previous(); // Walk past thisDiff.
+          pointer.previous(); // Walk past prevDiff.
+          pointer.remove(); // Delete prevDiff.
+          pointer.next(); // Walk past thisDiff.
+          thisDiff = pointer.next(); // Walk past nextDiff.
+          nextDiff = pointer.hasNext() ? pointer.next() : null;
+          changes = true;
+        } else if (thisDiff.text.startsWith(nextDiff.text)) {
+          // Shift the edit over the next equality.
+          prevDiff.text += nextDiff.text;
+          thisDiff.text = thisDiff.text.substring(nextDiff.text.length())
+              + nextDiff.text;
+          pointer.remove(); // Delete nextDiff.
+          nextDiff = pointer.hasNext() ? pointer.next() : null;
+          changes = true;
+        }
+      }
+      prevDiff = thisDiff;
+      thisDiff = nextDiff;
+      nextDiff = pointer.hasNext() ? pointer.next() : null;
+    }
+    // If shifts were made, the diff needs reordering and another shift sweep.
+    if (changes) {
+      diff_cleanupMerge(diffs);
+    }
+  }
+
+  /**
+   * loc is a location in text1, compute and return the equivalent location in
+   * text2.
+   * e.g. "The cat" vs "The big cat", 1->1, 5->8
+   * @param diffs LinkedList of Diff objects.
+   * @param loc Location within text1.
+   * @return Location within text2.
+   */
+  public int diff_xIndex(LinkedList<Diff> diffs, int loc) {
+    int chars1 = 0;
+    int chars2 = 0;
+    int last_chars1 = 0;
+    int last_chars2 = 0;
+    Diff lastDiff = null;
+    for (Diff aDiff : diffs) {
+      if (aDiff.operation != Operation.INSERT) {
+        // Equality or deletion.
+        chars1 += aDiff.text.length();
+      }
+      if (aDiff.operation != Operation.DELETE) {
+        // Equality or insertion.
+        chars2 += aDiff.text.length();
+      }
+      if (chars1 > loc) {
+        // Overshot the location.
+        lastDiff = aDiff;
+        break;
+      }
+      last_chars1 = chars1;
+      last_chars2 = chars2;
+    }
+    if (lastDiff != null && lastDiff.operation == Operation.DELETE) {
+      // The location was deleted.
+      return last_chars2;
+    }
+    // Add the remaining character length.
+    return last_chars2 + (loc - last_chars1);
+  }
+
+  /**
+   * Convert a Diff list into a pretty HTML report.
+   * @param diffs LinkedList of Diff objects.
+   * @return HTML representation.
+   */
+  public String diff_prettyHtml(LinkedList<Diff> diffs) {
+    StringBuilder html = new StringBuilder();
+    for (Diff aDiff : diffs) {
+      String text = aDiff.text.replace("&", "&amp;").replace("<", "&lt;")
+          .replace(">", "&gt;").replace("\n", "&para;<br>");
+      switch (aDiff.operation) {
+      case INSERT:
+        html.append("<ins style=\"background:#e6ffe6;\">").append(text)
+            .append("</ins>");
+        break;
+      case DELETE:
+        html.append("<del style=\"background:#ffe6e6;\">").append(text)
+            .append("</del>");
+        break;
+      case EQUAL:
+        html.append("<span>").append(text).append("</span>");
+        break;
+      }
+    }
+    return html.toString();
+  }
+
+  /**
+   * Compute and return the source text (all equalities and deletions).
+   * @param diffs LinkedList of Diff objects.
+   * @return Source text.
+   */
+  public String diff_text1(LinkedList<Diff> diffs) {
+    StringBuilder text = new StringBuilder();
+    for (Diff aDiff : diffs) {
+      if (aDiff.operation != Operation.INSERT) {
+        text.append(aDiff.text);
+      }
+    }
+    return text.toString();
+  }
+
+  /**
+   * Compute and return the destination text (all equalities and insertions).
+   * @param diffs LinkedList of Diff objects.
+   * @return Destination text.
+   */
+  public String diff_text2(LinkedList<Diff> diffs) {
+    StringBuilder text = new StringBuilder();
+    for (Diff aDiff : diffs) {
+      if (aDiff.operation != Operation.DELETE) {
+        text.append(aDiff.text);
+      }
+    }
+    return text.toString();
+  }
+
+  /**
+   * Compute the Levenshtein distance; the number of inserted, deleted or
+   * substituted characters.
+   * @param diffs LinkedList of Diff objects.
+   * @return Number of changes.
+   */
+  public int diff_levenshtein(LinkedList<Diff> diffs) {
+    int levenshtein = 0;
+    int insertions = 0;
+    int deletions = 0;
+    for (Diff aDiff : diffs) {
+      switch (aDiff.operation) {
+      case INSERT:
+        insertions += aDiff.text.length();
+        break;
+      case DELETE:
+        deletions += aDiff.text.length();
+        break;
+      case EQUAL:
+        // A deletion and an insertion is one substitution.
+        levenshtein += Math.max(insertions, deletions);
+        insertions = 0;
+        deletions = 0;
+        break;
+      }
+    }
+    levenshtein += Math.max(insertions, deletions);
+    return levenshtein;
+  }
+
+  /**
+   * Crush the diff into an encoded string which describes the operations
+   * required to transform text1 into text2.
+   * E.g. =3\t-2\t+ing  -> Keep 3 chars, delete 2 chars, insert 'ing'.
+   * Operations are tab-separated.  Inserted text is escaped using %xx notation.
+   * @param diffs Array of Diff objects.
+   * @return Delta text.
+   */
+  public String diff_toDelta(LinkedList<Diff> diffs) {
+    StringBuilder text = new StringBuilder();
+    for (Diff aDiff : diffs) {
+      switch (aDiff.operation) {
+      case INSERT:
+        try {
+          text.append("+").append(URLEncoder.encode(aDiff.text, "UTF-8")
+                                            .replace('+', ' ')).append("\t");
+        } catch (UnsupportedEncodingException e) {
+          // Not likely on modern system.
+          throw new Error("This system does not support UTF-8.", e);
+        }
+        break;
+      case DELETE:
+        text.append("-").append(aDiff.text.length()).append("\t");
+        break;
+      case EQUAL:
+        text.append("=").append(aDiff.text.length()).append("\t");
+        break;
+      }
+    }
+    String delta = text.toString();
+    if (delta.length() != 0) {
+      // Strip off trailing tab character.
+      delta = delta.substring(0, delta.length() - 1);
+      delta = unescapeForEncodeUriCompatability(delta);
+    }
+    return delta;
+  }
+
+  /**
+   * Given the original text1, and an encoded string which describes the
+   * operations required to transform text1 into text2, compute the full diff.
+   * @param text1 Source string for the diff.
+   * @param delta Delta text.
+   * @return Array of Diff objects or null if invalid.
+   * @throws IllegalArgumentException If invalid input.
+   */
+  public LinkedList<Diff> diff_fromDelta(String text1, String delta)
+      throws IllegalArgumentException {
+    LinkedList<Diff> diffs = new LinkedList<Diff>();
+    int pointer = 0;  // Cursor in text1
+    String[] tokens = delta.split("\t");
+    for (String token : tokens) {
+      if (token.length() == 0) {
+        // Blank tokens are ok (from a trailing \t).
+        continue;
+      }
+      // Each token begins with a one character parameter which specifies the
+      // operation of this token (delete, insert, equality).
+      String param = token.substring(1);
+      switch (token.charAt(0)) {
+      case '+':
+        // decode would change all "+" to " "
+        param = param.replace("+", "%2B");
+        try {
+          param = URLDecoder.decode(param, "UTF-8");
+        } catch (UnsupportedEncodingException e) {
+          // Not likely on modern system.
+          throw new Error("This system does not support UTF-8.", e);
+        } catch (IllegalArgumentException e) {
+          // Malformed URI sequence.
+          throw new IllegalArgumentException(
+              "Illegal escape in diff_fromDelta: " + param, e);
+        }
+        diffs.add(new Diff(Operation.INSERT, param));
+        break;
+      case '-':
+        // Fall through.
+      case '=':
+        int n;
+        try {
+          n = Integer.parseInt(param);
+        } catch (NumberFormatException e) {
+          throw new IllegalArgumentException(
+              "Invalid number in diff_fromDelta: " + param, e);
+        }
+        if (n < 0) {
+          throw new IllegalArgumentException(
+              "Negative number in diff_fromDelta: " + param);
+        }
+        String text;
+        try {
+          text = text1.substring(pointer, pointer += n);
+        } catch (StringIndexOutOfBoundsException e) {
+          throw new IllegalArgumentException("Delta length (" + pointer
+              + ") larger than source text length (" + text1.length()
+              + ").", e);
+        }
+        if (token.charAt(0) == '=') {
+          diffs.add(new Diff(Operation.EQUAL, text));
+        } else {
+          diffs.add(new Diff(Operation.DELETE, text));
+        }
+        break;
+      default:
+        // Anything else is an error.
+        throw new IllegalArgumentException(
+            "Invalid diff operation in diff_fromDelta: " + token.charAt(0));
+      }
+    }
+    if (pointer != text1.length()) {
+      throw new IllegalArgumentException("Delta length (" + pointer
+          + ") smaller than source text length (" + text1.length() + ").");
+    }
+    return diffs;
+  }
+
+
+  //  MATCH FUNCTIONS
+
+
+  /**
+   * Locate the best instance of 'pattern' in 'text' near 'loc'.
+   * Returns -1 if no match found.
+   * @param text The text to search.
+   * @param pattern The pattern to search for.
+   * @param loc The location to search around.
+   * @return Best match index or -1.
+   */
+  public int match_main(String text, String pattern, int loc) {
+    // Check for null inputs.
+    if (text == null || pattern == null) {
+      throw new IllegalArgumentException("Null inputs. (match_main)");
+    }
+
+    loc = Math.max(0, Math.min(loc, text.length()));
+    if (text.equals(pattern)) {
+      // Shortcut (potentially not guaranteed by the algorithm)
+      return 0;
+    } else if (text.length() == 0) {
+      // Nothing to match.
+      return -1;
+    } else if (loc + pattern.length() <= text.length()
+        && text.substring(loc, loc + pattern.length()).equals(pattern)) {
+      // Perfect match at the perfect spot!  (Includes case of null pattern)
+      return loc;
+    } else {
+      // Do a fuzzy compare.
+      return match_bitap(text, pattern, loc);
+    }
+  }
+
+  /**
+   * Locate the best instance of 'pattern' in 'text' near 'loc' using the
+   * Bitap algorithm.  Returns -1 if no match found.
+   * @param text The text to search.
+   * @param pattern The pattern to search for.
+   * @param loc The location to search around.
+   * @return Best match index or -1.
+   */
+  protected int match_bitap(String text, String pattern, int loc) {
+    assert (Match_MaxBits == 0 || pattern.length() <= Match_MaxBits)
+        : "Pattern too long for this application.";
+
+    // Initialise the alphabet.
+    Map<Character, Integer> s = match_alphabet(pattern);
+
+    // Highest score beyond which we give up.
+    double score_threshold = Match_Threshold;
+    // Is there a nearby exact match? (speedup)
+    int best_loc = text.indexOf(pattern, loc);
+    if (best_loc != -1) {
+      score_threshold = Math.min(match_bitapScore(0, best_loc, loc, pattern),
+          score_threshold);
+      // What about in the other direction? (speedup)
+      best_loc = text.lastIndexOf(pattern, loc + pattern.length());
+      if (best_loc != -1) {
+        score_threshold = Math.min(match_bitapScore(0, best_loc, loc, pattern),
+            score_threshold);
+      }
+    }
+
+    // Initialise the bit arrays.
+    int matchmask = 1 << (pattern.length() - 1);
+    best_loc = -1;
+
+    int bin_min, bin_mid;
+    int bin_max = pattern.length() + text.length();
+    // Empty initialization added to appease Java compiler.
+    int[] last_rd = new int[0];
+    for (int d = 0; d < pattern.length(); d++) {
+      // Scan for the best match; each iteration allows for one more error.
+      // Run a binary search to determine how far from 'loc' we can stray at
+      // this error level.
+      bin_min = 0;
+      bin_mid = bin_max;
+      while (bin_min < bin_mid) {
+        if (match_bitapScore(d, loc + bin_mid, loc, pattern)
+            <= score_threshold) {
+          bin_min = bin_mid;
+        } else {
+          bin_max = bin_mid;
+        }
+        bin_mid = (bin_max - bin_min) / 2 + bin_min;
+      }
+      // Use the result from this iteration as the maximum for the next.
+      bin_max = bin_mid;
+      int start = Math.max(1, loc - bin_mid + 1);
+      int finish = Math.min(loc + bin_mid, text.length()) + pattern.length();
+
+      int[] rd = new int[finish + 2];
+      rd[finish + 1] = (1 << d) - 1;
+      for (int j = finish; j >= start; j--) {
+        int charMatch;
+        if (text.length() <= j - 1 || !s.containsKey(text.charAt(j - 1))) {
+          // Out of range.
+          charMatch = 0;
+        } else {
+          charMatch = s.get(text.charAt(j - 1));
+        }
+        if (d == 0) {
+          // First pass: exact match.
+          rd[j] = ((rd[j + 1] << 1) | 1) & charMatch;
+        } else {
+          // Subsequent passes: fuzzy match.
+          rd[j] = (((rd[j + 1] << 1) | 1) & charMatch)
+              | (((last_rd[j + 1] | last_rd[j]) << 1) | 1) | last_rd[j + 1];
+        }
+        if ((rd[j] & matchmask) != 0) {
+          double score = match_bitapScore(d, j - 1, loc, pattern);
+          // This match will almost certainly be better than any existing
+          // match.  But check anyway.
+          if (score <= score_threshold) {
+            // Told you so.
+            score_threshold = score;
+            best_loc = j - 1;
+            if (best_loc > loc) {
+              // When passing loc, don't exceed our current distance from loc.
+              start = Math.max(1, 2 * loc - best_loc);
+            } else {
+              // Already passed loc, downhill from here on in.
+              break;
+            }
+          }
+        }
+      }
+      if (match_bitapScore(d + 1, loc, loc, pattern) > score_threshold) {
+        // No hope for a (better) match at greater error levels.
+        break;
+      }
+      last_rd = rd;
+    }
+    return best_loc;
+  }
+
+  /**
+   * Compute and return the score for a match with e errors and x location.
+   * @param e Number of errors in match.
+   * @param x Location of match.
+   * @param loc Expected location of match.
+   * @param pattern Pattern being sought.
+   * @return Overall score for match (0.0 = good, 1.0 = bad).
+   */
+  private double match_bitapScore(int e, int x, int loc, String pattern) {
+    float accuracy = (float) e / pattern.length();
+    int proximity = Math.abs(loc - x);
+    if (Match_Distance == 0) {
+      // Dodge divide by zero error.
+      return proximity == 0 ? accuracy : 1.0;
+    }
+    return accuracy + (proximity / (float) Match_Distance);
+  }
+
+  /**
+   * Initialise the alphabet for the Bitap algorithm.
+   * @param pattern The text to encode.
+   * @return Hash of character locations.
+   */
+  protected Map<Character, Integer> match_alphabet(String pattern) {
+    Map<Character, Integer> s = new HashMap<Character, Integer>();
+    char[] char_pattern = pattern.toCharArray();
+    for (char c : char_pattern) {
+      s.put(c, 0);
+    }
+    int i = 0;
+    for (char c : char_pattern) {
+      s.put(c, s.get(c) | (1 << (pattern.length() - i - 1)));
+      i++;
+    }
+    return s;
+  }
+
+
+  //  PATCH FUNCTIONS
+
+
+  /**
+   * Increase the context until it is unique,
+   * but don't let the pattern expand beyond Match_MaxBits.
+   * @param patch The patch to grow.
+   * @param text Source text.
+   */
+  protected void patch_addContext(Patch patch, String text) {
+    if (text.length() == 0) {
+      return;
+    }
+    String pattern = text.substring(patch.start2, patch.start2 + patch.length1);
+    int padding = 0;
+
+    // Look for the first and last matches of pattern in text.  If two different
+    // matches are found, increase the pattern length.
+    while (text.indexOf(pattern) != text.lastIndexOf(pattern)
+        && pattern.length() < Match_MaxBits - Patch_Margin - Patch_Margin) {
+      padding += Patch_Margin;
+      pattern = text.substring(Math.max(0, patch.start2 - padding),
+          Math.min(text.length(), patch.start2 + patch.length1 + padding));
+    }
+    // Add one chunk for good luck.
+    padding += Patch_Margin;
+
+    // Add the prefix.
+    String prefix = text.substring(Math.max(0, patch.start2 - padding),
+        patch.start2);
+    if (prefix.length() != 0) {
+      patch.diffs.addFirst(new Diff(Operation.EQUAL, prefix));
+    }
+    // Add the suffix.
+    String suffix = text.substring(patch.start2 + patch.length1,
+        Math.min(text.length(), patch.start2 + patch.length1 + padding));
+    if (suffix.length() != 0) {
+      patch.diffs.addLast(new Diff(Operation.EQUAL, suffix));
+    }
+
+    // Roll back the start points.
+    patch.start1 -= prefix.length();
+    patch.start2 -= prefix.length();
+    // Extend the lengths.
+    patch.length1 += prefix.length() + suffix.length();
+    patch.length2 += prefix.length() + suffix.length();
+  }
+
+  /**
+   * Compute a list of patches to turn text1 into text2.
+   * A set of diffs will be computed.
+   * @param text1 Old text.
+   * @param text2 New text.
+   * @return LinkedList of Patch objects.
+   */
+  public LinkedList<Patch> patch_make(String text1, String text2) {
+    if (text1 == null || text2 == null) {
+      throw new IllegalArgumentException("Null inputs. (patch_make)");
+    }
+    // No diffs provided, compute our own.
+    LinkedList<Diff> diffs = diff_main(text1, text2, true);
+    if (diffs.size() > 2) {
+      diff_cleanupSemantic(diffs);
+      diff_cleanupEfficiency(diffs);
+    }
+    return patch_make(text1, diffs);
+  }
+
+  /**
+   * Compute a list of patches to turn text1 into text2.
+   * text1 will be derived from the provided diffs.
+   * @param diffs Array of Diff objects for text1 to text2.
+   * @return LinkedList of Patch objects.
+   */
+  public LinkedList<Patch> patch_make(LinkedList<Diff> diffs) {
+    if (diffs == null) {
+      throw new IllegalArgumentException("Null inputs. (patch_make)");
+    }
+    // No origin string provided, compute our own.
+    String text1 = diff_text1(diffs);
+    return patch_make(text1, diffs);
+  }
+
+  /**
+   * Compute a list of patches to turn text1 into text2.
+   * text2 is ignored, diffs are the delta between text1 and text2.
+   * @param text1 Old text
+   * @param text2 Ignored.
+   * @param diffs Array of Diff objects for text1 to text2.
+   * @return LinkedList of Patch objects.
+   * @deprecated Prefer patch_make(String text1, LinkedList<Diff> diffs).
+   */
+  public LinkedList<Patch> patch_make(String text1, String text2,
+      LinkedList<Diff> diffs) {
+    return patch_make(text1, diffs);
+  }
+
+  /**
+   * Compute a list of patches to turn text1 into text2.
+   * text2 is not provided, diffs are the delta between text1 and text2.
+   * @param text1 Old text.
+   * @param diffs Array of Diff objects for text1 to text2.
+   * @return LinkedList of Patch objects.
+   */
+  public LinkedList<Patch> patch_make(String text1, LinkedList<Diff> diffs) {
+    if (text1 == null || diffs == null) {
+      throw new IllegalArgumentException("Null inputs. (patch_make)");
+    }
+
+    LinkedList<Patch> patches = new LinkedList<Patch>();
+    if (diffs.isEmpty()) {
+      return patches;  // Get rid of the null case.
+    }
+    Patch patch = new Patch();
+    int char_count1 = 0;  // Number of characters into the text1 string.
+    int char_count2 = 0;  // Number of characters into the text2 string.
+    // Start with text1 (prepatch_text) and apply the diffs until we arrive at
+    // text2 (postpatch_text). We recreate the patches one by one to determine
+    // context info.
+    String prepatch_text = text1;
+    String postpatch_text = text1;
+    for (Diff aDiff : diffs) {
+      if (patch.diffs.isEmpty() && aDiff.operation != Operation.EQUAL) {
+        // A new patch starts here.
+        patch.start1 = char_count1;
+        patch.start2 = char_count2;
+      }
+
+      switch (aDiff.operation) {
+      case INSERT:
+        patch.diffs.add(aDiff);
+        patch.length2 += aDiff.text.length();
+        postpatch_text = postpatch_text.substring(0, char_count2)
+            + aDiff.text + postpatch_text.substring(char_count2);
+        break;
+      case DELETE:
+        patch.length1 += aDiff.text.length();
+        patch.diffs.add(aDiff);
+        postpatch_text = postpatch_text.substring(0, char_count2)
+            + postpatch_text.substring(char_count2 + aDiff.text.length());
+        break;
+      case EQUAL:
+        if (aDiff.text.length() <= 2 * Patch_Margin
+            && !patch.diffs.isEmpty() && aDiff != diffs.getLast()) {
+          // Small equality inside a patch.
+          patch.diffs.add(aDiff);
+          patch.length1 += aDiff.text.length();
+          patch.length2 += aDiff.text.length();
+        }
+
+        if (aDiff.text.length() >= 2 * Patch_Margin) {
+          // Time for a new patch.
+          if (!patch.diffs.isEmpty()) {
+            patch_addContext(patch, prepatch_text);
+            patches.add(patch);
+            patch = new Patch();
+            // Unlike Unidiff, our patch lists have a rolling context.
+            // http://code.google.com/p/google-diff-match-patch/wiki/Unidiff
+            // Update prepatch text & pos to reflect the application of the
+            // just completed patch.
+            prepatch_text = postpatch_text;
+            char_count1 = char_count2;
+          }
+        }
+        break;
+      }
+
+      // Update the current character count.
+      if (aDiff.operation != Operation.INSERT) {
+        char_count1 += aDiff.text.length();
+      }
+      if (aDiff.operation != Operation.DELETE) {
+        char_count2 += aDiff.text.length();
+      }
+    }
+    // Pick up the leftover patch if not empty.
+    if (!patch.diffs.isEmpty()) {
+      patch_addContext(patch, prepatch_text);
+      patches.add(patch);
+    }
+
+    return patches;
+  }
+
+  /**
+   * Given an array of patches, return another array that is identical.
+   * @param patches Array of Patch objects.
+   * @return Array of Patch objects.
+   */
+  public LinkedList<Patch> patch_deepCopy(LinkedList<Patch> patches) {
+    LinkedList<Patch> patchesCopy = new LinkedList<Patch>();
+    for (Patch aPatch : patches) {
+      Patch patchCopy = new Patch();
+      for (Diff aDiff : aPatch.diffs) {
+        Diff diffCopy = new Diff(aDiff.operation, aDiff.text);
+        patchCopy.diffs.add(diffCopy);
+      }
+      patchCopy.start1 = aPatch.start1;
+      patchCopy.start2 = aPatch.start2;
+      patchCopy.length1 = aPatch.length1;
+      patchCopy.length2 = aPatch.length2;
+      patchesCopy.add(patchCopy);
+    }
+    return patchesCopy;
+  }
+
+  /**
+   * Merge a set of patches onto the text.  Return a patched text, as well
+   * as an array of true/false values indicating which patches were applied.
+   * @param patches Array of Patch objects
+   * @param text Old text.
+   * @return Two element Object array, containing the new text and an array of
+   *      boolean values.
+   */
+  public Object[] patch_apply(LinkedList<Patch> patches, String text) {
+    if (patches.isEmpty()) {
+      return new Object[]{text, new boolean[0]};
+    }
+
+    // Deep copy the patches so that no changes are made to originals.
+    patches = patch_deepCopy(patches);
+
+    String nullPadding = patch_addPadding(patches);
+    text = nullPadding + text + nullPadding;
+    patch_splitMax(patches);
+
+    int x = 0;
+    // delta keeps track of the offset between the expected and actual location
+    // of the previous patch.  If there are patches expected at positions 10 and
+    // 20, but the first patch was found at 12, delta is 2 and the second patch
+    // has an effective expected position of 22.
+    int delta = 0;
+    boolean[] results = new boolean[patches.size()];
+    for (Patch aPatch : patches) {
+      int expected_loc = aPatch.start2 + delta;
+      String text1 = diff_text1(aPatch.diffs);
+      int start_loc;
+      int end_loc = -1;
+      if (text1.length() > this.Match_MaxBits) {
+        // patch_splitMax will only provide an oversized pattern in the case of
+        // a monster delete.
+        start_loc = match_main(text,
+            text1.substring(0, this.Match_MaxBits), expected_loc);
+        if (start_loc != -1) {
+          end_loc = match_main(text,
+              text1.substring(text1.length() - this.Match_MaxBits),
+              expected_loc + text1.length() - this.Match_MaxBits);
+          if (end_loc == -1 || start_loc >= end_loc) {
+            // Can't find valid trailing context.  Drop this patch.
+            start_loc = -1;
+          }
+        }
+      } else {
+        start_loc = match_main(text, text1, expected_loc);
+      }
+      if (start_loc == -1) {
+        // No match found.  :(
+        results[x] = false;
+        // Subtract the delta for this failed patch from subsequent patches.
+        delta -= aPatch.length2 - aPatch.length1;
+      } else {
+        // Found a match.  :)
+        results[x] = true;
+        delta = start_loc - expected_loc;
+        String text2;
+        if (end_loc == -1) {
+          text2 = text.substring(start_loc,
+              Math.min(start_loc + text1.length(), text.length()));
+        } else {
+          text2 = text.substring(start_loc,
+              Math.min(end_loc + this.Match_MaxBits, text.length()));
+        }
+        if (text1.equals(text2)) {
+          // Perfect match, just shove the replacement text in.
+          text = text.substring(0, start_loc) + diff_text2(aPatch.diffs)
+              + text.substring(start_loc + text1.length());
+        } else {
+          // Imperfect match.  Run a diff to get a framework of equivalent
+          // indices.
+          LinkedList<Diff> diffs = diff_main(text1, text2, false);
+          if (text1.length() > this.Match_MaxBits
+              && diff_levenshtein(diffs) / (float) text1.length()
+              > this.Patch_DeleteThreshold) {
+            // The end points match, but the content is unacceptably bad.
+            results[x] = false;
+          } else {
+            diff_cleanupSemanticLossless(diffs);
+            int index1 = 0;
+            for (Diff aDiff : aPatch.diffs) {
+              if (aDiff.operation != Operation.EQUAL) {
+                int index2 = diff_xIndex(diffs, index1);
+                if (aDiff.operation == Operation.INSERT) {
+                  // Insertion
+                  text = text.substring(0, start_loc + index2) + aDiff.text
+                      + text.substring(start_loc + index2);
+                } else if (aDiff.operation == Operation.DELETE) {
+                  // Deletion
+                  text = text.substring(0, start_loc + index2)
+                      + text.substring(start_loc + diff_xIndex(diffs,
+                      index1 + aDiff.text.length()));
+                }
+              }
+              if (aDiff.operation != Operation.DELETE) {
+                index1 += aDiff.text.length();
+              }
+            }
+          }
+        }
+      }
+      x++;
+    }
+    // Strip the padding off.
+    text = text.substring(nullPadding.length(), text.length()
+        - nullPadding.length());
+    return new Object[]{text, results};
+  }
+
+  /**
+   * Add some padding on text start and end so that edges can match something.
+   * Intended to be called only from within patch_apply.
+   * @param patches Array of Patch objects.
+   * @return The padding string added to each side.
+   */
+  public String patch_addPadding(LinkedList<Patch> patches) {
+    short paddingLength = this.Patch_Margin;
+    String nullPadding = "";
+    for (short x = 1; x <= paddingLength; x++) {
+      nullPadding += String.valueOf((char) x);
+    }
+
+    // Bump all the patches forward.
+    for (Patch aPatch : patches) {
+      aPatch.start1 += paddingLength;
+      aPatch.start2 += paddingLength;
+    }
+
+    // Add some padding on start of first diff.
+    Patch patch = patches.getFirst();
+    LinkedList<Diff> diffs = patch.diffs;
+    if (diffs.isEmpty() || diffs.getFirst().operation != Operation.EQUAL) {
+      // Add nullPadding equality.
+      diffs.addFirst(new Diff(Operation.EQUAL, nullPadding));
+      patch.start1 -= paddingLength;  // Should be 0.
+      patch.start2 -= paddingLength;  // Should be 0.
+      patch.length1 += paddingLength;
+      patch.length2 += paddingLength;
+    } else if (paddingLength > diffs.getFirst().text.length()) {
+      // Grow first equality.
+      Diff firstDiff = diffs.getFirst();
+      int extraLength = paddingLength - firstDiff.text.length();
+      firstDiff.text = nullPadding.substring(firstDiff.text.length())
+          + firstDiff.text;
+      patch.start1 -= extraLength;
+      patch.start2 -= extraLength;
+      patch.length1 += extraLength;
+      patch.length2 += extraLength;
+    }
+
+    // Add some padding on end of last diff.
+    patch = patches.getLast();
+    diffs = patch.diffs;
+    if (diffs.isEmpty() || diffs.getLast().operation != Operation.EQUAL) {
+      // Add nullPadding equality.
+      diffs.addLast(new Diff(Operation.EQUAL, nullPadding));
+      patch.length1 += paddingLength;
+      patch.length2 += paddingLength;
+    } else if (paddingLength > diffs.getLast().text.length()) {
+      // Grow last equality.
+      Diff lastDiff = diffs.getLast();
+      int extraLength = paddingLength - lastDiff.text.length();
+      lastDiff.text += nullPadding.substring(0, extraLength);
+      patch.length1 += extraLength;
+      patch.length2 += extraLength;
+    }
+
+    return nullPadding;
+  }
+
+  /**
+   * Look through the patches and break up any which are longer than the
+   * maximum limit of the match algorithm.
+   * Intended to be called only from within patch_apply.
+   * @param patches LinkedList of Patch objects.
+   */
+  public void patch_splitMax(LinkedList<Patch> patches) {
+    short patch_size = Match_MaxBits;
+    String precontext, postcontext;
+    Patch patch;
+    int start1, start2;
+    boolean empty;
+    Operation diff_type;
+    String diff_text;
+    ListIterator<Patch> pointer = patches.listIterator();
+    Patch bigpatch = pointer.hasNext() ? pointer.next() : null;
+    while (bigpatch != null) {
+      if (bigpatch.length1 <= Match_MaxBits) {
+        bigpatch = pointer.hasNext() ? pointer.next() : null;
+        continue;
+      }
+      // Remove the big old patch.
+      pointer.remove();
+      start1 = bigpatch.start1;
+      start2 = bigpatch.start2;
+      precontext = "";
+      while (!bigpatch.diffs.isEmpty()) {
+        // Create one of several smaller patches.
+        patch = new Patch();
+        empty = true;
+        patch.start1 = start1 - precontext.length();
+        patch.start2 = start2 - precontext.length();
+        if (precontext.length() != 0) {
+          patch.length1 = patch.length2 = precontext.length();
+          patch.diffs.add(new Diff(Operation.EQUAL, precontext));
+        }
+        while (!bigpatch.diffs.isEmpty()
+            && patch.length1 < patch_size - Patch_Margin) {
+          diff_type = bigpatch.diffs.getFirst().operation;
+          diff_text = bigpatch.diffs.getFirst().text;
+          if (diff_type == Operation.INSERT) {
+            // Insertions are harmless.
+            patch.length2 += diff_text.length();
+            start2 += diff_text.length();
+            patch.diffs.addLast(bigpatch.diffs.removeFirst());
+            empty = false;
+          } else if (diff_type == Operation.DELETE && patch.diffs.size() == 1
+              && patch.diffs.getFirst().operation == Operation.EQUAL
+              && diff_text.length() > 2 * patch_size) {
+            // This is a large deletion.  Let it pass in one chunk.
+            patch.length1 += diff_text.length();
+            start1 += diff_text.length();
+            empty = false;
+            patch.diffs.add(new Diff(diff_type, diff_text));
+            bigpatch.diffs.removeFirst();
+          } else {
+            // Deletion or equality.  Only take as much as we can stomach.
+            diff_text = diff_text.substring(0, Math.min(diff_text.length(),
+                patch_size - patch.length1 - Patch_Margin));
+            patch.length1 += diff_text.length();
+            start1 += diff_text.length();
+            if (diff_type == Operation.EQUAL) {
+              patch.length2 += diff_text.length();
+              start2 += diff_text.length();
+            } else {
+              empty = false;
+            }
+            patch.diffs.add(new Diff(diff_type, diff_text));
+            if (diff_text.equals(bigpatch.diffs.getFirst().text)) {
+              bigpatch.diffs.removeFirst();
+            } else {
+              bigpatch.diffs.getFirst().text = bigpatch.diffs.getFirst().text
+                  .substring(diff_text.length());
+            }
+          }
+        }
+        // Compute the head context for the next patch.
+        precontext = diff_text2(patch.diffs);
+        precontext = precontext.substring(Math.max(0, precontext.length()
+            - Patch_Margin));
+        // Append the end context for this patch.
+        if (diff_text1(bigpatch.diffs).length() > Patch_Margin) {
+          postcontext = diff_text1(bigpatch.diffs).substring(0, Patch_Margin);
+        } else {
+          postcontext = diff_text1(bigpatch.diffs);
+        }
+        if (postcontext.length() != 0) {
+          patch.length1 += postcontext.length();
+          patch.length2 += postcontext.length();
+          if (!patch.diffs.isEmpty()
+              && patch.diffs.getLast().operation == Operation.EQUAL) {
+            patch.diffs.getLast().text += postcontext;
+          } else {
+            patch.diffs.add(new Diff(Operation.EQUAL, postcontext));
+          }
+        }
+        if (!empty) {
+          pointer.add(patch);
+        }
+      }
+      bigpatch = pointer.hasNext() ? pointer.next() : null;
+    }
+  }
+
+  /**
+   * Take a list of patches and return a textual representation.
+   * @param patches List of Patch objects.
+   * @return Text representation of patches.
+   */
+  public String patch_toText(List<Patch> patches) {
+    StringBuilder text = new StringBuilder();
+    for (Patch aPatch : patches) {
+      text.append(aPatch);
+    }
+    return text.toString();
+  }
+
+  /**
+   * Parse a textual representation of patches and return a List of Patch
+   * objects.
+   * @param textline Text representation of patches.
+   * @return List of Patch objects.
+   * @throws IllegalArgumentException If invalid input.
+   */
+  public List<Patch> patch_fromText(String textline)
+      throws IllegalArgumentException {
+    List<Patch> patches = new LinkedList<Patch>();
+    if (textline.length() == 0) {
+      return patches;
+    }
+    List<String> textList = Arrays.asList(textline.split("\n"));
+    LinkedList<String> text = new LinkedList<String>(textList);
+    Patch patch;
+    Pattern patchHeader
+        = Pattern.compile("^@@ -(\\d+),?(\\d*) \\+(\\d+),?(\\d*) @@$");
+    Matcher m;
+    char sign;
+    String line;
+    while (!text.isEmpty()) {
+      m = patchHeader.matcher(text.getFirst());
+      if (!m.matches()) {
+        throw new IllegalArgumentException(
+            "Invalid patch string: " + text.getFirst());
+      }
+      patch = new Patch();
+      patches.add(patch);
+      patch.start1 = Integer.parseInt(m.group(1));
+      if (m.group(2).length() == 0) {
+        patch.start1--;
+        patch.length1 = 1;
+      } else if (m.group(2).equals("0")) {
+        patch.length1 = 0;
+      } else {
+        patch.start1--;
+        patch.length1 = Integer.parseInt(m.group(2));
+      }
+
+      patch.start2 = Integer.parseInt(m.group(3));
+      if (m.group(4).length() == 0) {
+        patch.start2--;
+        patch.length2 = 1;
+      } else if (m.group(4).equals("0")) {
+        patch.length2 = 0;
+      } else {
+        patch.start2--;
+        patch.length2 = Integer.parseInt(m.group(4));
+      }
+      text.removeFirst();
+
+      while (!text.isEmpty()) {
+        try {
+          sign = text.getFirst().charAt(0);
+        } catch (IndexOutOfBoundsException e) {
+          // Blank line?  Whatever.
+          text.removeFirst();
+          continue;
+        }
+        line = text.getFirst().substring(1);
+        line = line.replace("+", "%2B");  // decode would change all "+" to " "
+        try {
+          line = URLDecoder.decode(line, "UTF-8");
+        } catch (UnsupportedEncodingException e) {
+          // Not likely on modern system.
+          throw new Error("This system does not support UTF-8.", e);
+        } catch (IllegalArgumentException e) {
+          // Malformed URI sequence.
+          throw new IllegalArgumentException(
+              "Illegal escape in patch_fromText: " + line, e);
+        }
+        if (sign == '-') {
+          // Deletion.
+          patch.diffs.add(new Diff(Operation.DELETE, line));
+        } else if (sign == '+') {
+          // Insertion.
+          patch.diffs.add(new Diff(Operation.INSERT, line));
+        } else if (sign == ' ') {
+          // Minor equality.
+          patch.diffs.add(new Diff(Operation.EQUAL, line));
+        } else if (sign == '@') {
+          // Start of next patch.
+          break;
+        } else {
+          // WTF?
+          throw new IllegalArgumentException(
+              "Invalid patch mode '" + sign + "' in: " + line);
+        }
+        text.removeFirst();
+      }
+    }
+    return patches;
+  }
+
+
+  /**
+   * Class representing one diff operation.
+   */
+  public static class Diff {
+    /**
+     * One of: INSERT, DELETE or EQUAL.
+     */
+    public Operation operation;
+    /**
+     * The text associated with this diff operation.
+     */
+    public String text;
+
+    /**
+     * Constructor.  Initializes the diff with the provided values.
+     * @param operation One of INSERT, DELETE or EQUAL.
+     * @param text The text being applied.
+     */
+    public Diff(Operation operation, String text) {
+      // Construct a diff with the specified operation and text.
+      this.operation = operation;
+      this.text = text;
+    }
+
+    /**
+     * Display a human-readable version of this Diff.
+     * @return text version.
+     */
+    public String toString() {
+      String prettyText = this.text.replace('\n', '\u00b6');
+      return "Diff(" + this.operation + ",\"" + prettyText + "\")";
+    }
+
+    /**
+     * Create a numeric hash value for a Diff.
+     * This function is not used by DMP.
+     * @return Hash value.
+     */
+    @Override
+    public int hashCode() {
+      final int prime = 31;
+      int result = (operation == null) ? 0 : operation.hashCode();
+      result += prime * ((text == null) ? 0 : text.hashCode());
+      return result;
+    }
+
+    /**
+     * Is this Diff equivalent to another Diff?
+     * @param obj Another Diff to compare against.
+     * @return true or false.
+     */
+    @Override
+    public boolean equals(Object obj) {
+      if (this == obj) {
+        return true;
+      }
+      if (obj == null) {
+        return false;
+      }
+      if (getClass() != obj.getClass()) {
+        return false;
+      }
+      Diff other = (Diff) obj;
+      if (operation != other.operation) {
+        return false;
+      }
+      if (text == null) {
+        if (other.text != null) {
+          return false;
+        }
+      } else if (!text.equals(other.text)) {
+        return false;
+      }
+      return true;
+    }
+  }
+
+
+  /**
+   * Class representing one patch operation.
+   */
+  public static class Patch {
+    public LinkedList<Diff> diffs;
+    public int start1;
+    public int start2;
+    public int length1;
+    public int length2;
+
+    /**
+     * Constructor.  Initializes with an empty list of diffs.
+     */
+    public Patch() {
+      this.diffs = new LinkedList<Diff>();
+    }
+
+    /**
+     * Emmulate GNU diff's format.
+     * Header: @@ -382,8 +481,9 @@
+     * Indicies are printed as 1-based, not 0-based.
+     * @return The GNU diff string.
+     */
+    public String toString() {
+      String coords1, coords2;
+      if (this.length1 == 0) {
+        coords1 = this.start1 + ",0";
+      } else if (this.length1 == 1) {
+        coords1 = Integer.toString(this.start1 + 1);
+      } else {
+        coords1 = (this.start1 + 1) + "," + this.length1;
+      }
+      if (this.length2 == 0) {
+        coords2 = this.start2 + ",0";
+      } else if (this.length2 == 1) {
+        coords2 = Integer.toString(this.start2 + 1);
+      } else {
+        coords2 = (this.start2 + 1) + "," + this.length2;
+      }
+      StringBuilder text = new StringBuilder();
+      text.append("@@ -").append(coords1).append(" +").append(coords2)
+          .append(" @@\n");
+      // Escape the body of the patch with %xx notation.
+      for (Diff aDiff : this.diffs) {
+        switch (aDiff.operation) {
+        case INSERT:
+          text.append('+');
+          break;
+        case DELETE:
+          text.append('-');
+          break;
+        case EQUAL:
+          text.append(' ');
+          break;
+        }
+        try {
+          text.append(URLEncoder.encode(aDiff.text, "UTF-8").replace('+', ' '))
+              .append("\n");
+        } catch (UnsupportedEncodingException e) {
+          // Not likely on modern system.
+          throw new Error("This system does not support UTF-8.", e);
+        }
+      }
+      return unescapeForEncodeUriCompatability(text.toString());
+    }
+  }
+
+  /**
+   * Unescape selected chars for compatability with JavaScript's encodeURI.
+   * In speed critical applications this could be dropped since the
+   * receiving application will certainly decode these fine.
+   * Note that this function is case-sensitive.  Thus "%3f" would not be
+   * unescaped.  But this is ok because it is only called with the output of
+   * URLEncoder.encode which returns uppercase hex.
+   *
+   * Example: "%3F" -> "?", "%24" -> "$", etc.
+   *
+   * @param str The string to escape.
+   * @return The escaped string.
+   */
+  private static String unescapeForEncodeUriCompatability(String str) {
+    return str.replace("%21", "!").replace("%7E", "~")
+        .replace("%27", "'").replace("%28", "(").replace("%29", ")")
+        .replace("%3B", ";").replace("%2F", "/").replace("%3F", "?")
+        .replace("%3A", ":").replace("%40", "@").replace("%26", "&")
+        .replace("%3D", "=").replace("%2B", "+").replace("%24", "$")
+        .replace("%2C", ",").replace("%23", "#");
+  }
+}

Added: spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/BespinJSONTokenizer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/BespinJSONTokenizer.java	Tue May 29 15:35:50 2012	(r24874)
@@ -0,0 +1,195 @@
+package spoofax.ace.tokenize;
+
+import java.util.Hashtable;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.jsglr.client.imploder.IToken;
+import org.spoofax.jsglr.client.imploder.ITokenizer;
+import org.spoofax.jsglr.client.imploder.ImploderAttachment;
+
+public class BespinJSONTokenizer {
+	/*
+	 * S2A Tokenizer 
+	 * 
+	 * This implementation creates a (JSON) String containing all tokens in the IStrategoTerm
+	 * The JSON String is crafted to work with bespin tokens (Ace)
+	 * 
+	 */
+	
+	private static boolean AddTermInfoToEditorTokensHash(Hashtable<IToken,String> list, IStrategoTerm term, String msg)
+	{
+		//System.out.println(term.toString());
+		ImploderAttachment ia = term.getAttachment(ImploderAttachment.TYPE);
+		if (ia != null)
+		{
+			list.put(ia.getLeftToken(), msg);
+			list.put(ia.getRightToken(), msg);
+			return true;
+		} else {
+			if (term.getSubtermCount() > 0)
+				for (IStrategoTerm x : term.getAllSubterms())
+					if (AddTermInfoToEditorTokensHash(list, x, msg))
+						return true;
+		}
+		return false;
+	}
+	
+	public static String Tokenize(IStrategoTerm result, String sourcecode)
+	{
+		if (result == null)
+			return "Parse Error";
+		  String[] sourceLines = sourcecode.split("\r\n|\r|\n"); 
+		  int sourceLength = sourceLines.length+1;
+		  
+		  IStrategoTerm ast = result.getSubterm(0);
+		  IStrategoTerm list = result.getSubterm(1);
+		  IStrategoTerm err = list.getSubterm(0);
+		  IStrategoTerm warn = list.getSubterm(1);
+		  IStrategoTerm note = list.getSubterm(2);
+		  
+		  Hashtable<IToken,String> errorTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< err.getSubtermCount(); i++)
+			  if (err.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(errorTokens, err.getSubterm(i).getSubterm(0), err.getSubterm(i).getSubterm(1).toString());
+		  
+		  Hashtable<IToken,String> warningTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< warn.getSubtermCount(); i++)
+			  if (warn.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(warningTokens, warn.getSubterm(i).getSubterm(0), warn.getSubterm(i).getSubterm(1).toString());
+
+		  
+		  Hashtable<IToken,String> noteTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< note.getSubtermCount(); i++)
+			  if (note.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(noteTokens, note.getSubterm(i).getSubterm(0), note.getSubterm(i).getSubterm(1).toString());
+
+		  IToken lefttoken = ImploderAttachment.getLeftToken(ast);
+		  ITokenizer tokenizer = lefttoken.getTokenizer();
+		  
+		  StringBuilder errors = new StringBuilder();
+		  errors.append("");
+		  
+		  StringBuilder[] tokens = new StringBuilder[sourceLength+1];
+		  for (int i = 0; i < sourceLength; i++)
+			  tokens[i] = new StringBuilder();
+		  
+		  
+		  //bespintokens in an array per LOC
+		  for(int i = 0; i < tokenizer.getTokenCount(); i++) {
+				final IToken x = tokenizer.getTokenAt(i);
+				final int start = x.getColumn();
+				final int end = x.getEndOffset() - x.getStartOffset() + start + 1;
+				
+				String bespinType = convertTokenType(x.getKind());
+				//System.out.println(x.getKind() + "  -  " + x.toString());
+				if (noteTokens.containsKey(x))
+				{
+					errors.append(createInfoToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.deprecated";
+				} 				
+				if (warningTokens.containsKey(x))
+				{
+					errors.append(createWarningToken(x.getLine()-1, x.getColumn(), warningTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.deprecated";
+				} 	
+				if (errorTokens.containsKey(x))
+				{
+					errors.append(createErrorToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.illegal";
+				} 
+				tokens[x.getLine()-1].append("  " + createBespinToken(x.toString(), bespinType, start, end, x.getLine()) + "\n,");
+		  }
+		  
+		  StringBuilder json = new StringBuilder();
+		  json.append("{\"parsed\": [\n");
+		  for (int i = 0; i < sourceLines.length; i++)
+		  {
+			  String safeJson = sourceLines[i].replaceAll("\"", "\\\\\"");
+			  safeJson = safeJson.replaceAll("	", "\\\\\\t");
+					  
+			  json.append("{\"text\":\""+safeJson+"\",\"tokens\":[\n");
+			  if (tokens[i].length() > 0)
+				  json.append("  "+tokens[i].substring(0, tokens[i].length() -1 ) + "\n");
+			  json.append("]},\n");
+		  }
+		  
+		  json.deleteCharAt(json.length()-2);
+		  if (errors.length() > 0)
+			  errors.deleteCharAt(errors.length()-2);
+		  
+		  json.append("], \"errors\": [");
+		  json.append(errors);
+		  json.append("] }\n");
+		  
+		  
+	  
+		  
+		  
+		  return json.toString();
+	}
+	
+	
+	private static String createBespinToken(String value, String tokentype, int startColumn, int endColumn, int lineNumber) {
+		String safeJson = value.replace('\n', ' ').replaceAll("\"", "\\\\\"");
+		safeJson = safeJson.replaceAll("	", "\\\\\\t");
+		String x = ""; 
+	     x += " {";
+         x += "   \"type\": \""+tokentype+"\",";
+         x += "	  \"value\": \""+safeJson+"\"," ;
+		 x += "   \"start\": \""+startColumn+"\"," ;
+		 x += "   \"end\": \""+endColumn+"\"," ;
+		 x += "   \"line\": \""+lineNumber+"\"" ;
+		 x += "  }";
+	      return x;
+	}
+	private static String createErrorToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"error\"" ;
+		 x += "  }";
+	      return x;
+	}
+	
+	private static String createWarningToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"warning\"" ;
+		 x += "  }";
+	      return x;
+	}
+	
+	private static String createInfoToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"info\"" ;
+		 x += "  }";
+	      return x;
+	}		
+	
+	
+	private static String convertTokenType(int kind) {
+		switch(kind) {
+		case IToken.TK_LAYOUT: return "comment";
+		case IToken.TK_NUMBER: return "constant";
+		case IToken.TK_OPERATOR: return "keyword.operator";
+		case IToken.TK_KEYWORD: return "keyword";
+		case IToken.TK_STRING: return "string";
+		case IToken.TK_IDENTIFIER: return "variable";
+		case IToken.TK_ERROR_KEYWORD: return "invalid.illegal";
+		
+		default: return "plain";
+		}
+	}
+
+
+}
+

Added: spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/S2ATokenizer.java
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-ace/trunk/spoofax-ace-server/src/spoofax/ace/tokenize/S2ATokenizer.java	Tue May 29 15:35:50 2012	(r24874)
@@ -0,0 +1,188 @@
+package spoofax.ace.tokenize;
+
+
+import java.util.Hashtable;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.spoofax.jsglr.client.imploder.IToken;
+import org.spoofax.jsglr.client.imploder.ITokenizer;
+import org.spoofax.jsglr.client.imploder.ImploderAttachment;
+
+public class S2ATokenizer {
+	/*
+	 * S2A Tokenizer 
+	 * 
+	 * Creates a string which can be parsed client side. Intended goal 
+	 * of this approach is to be able to DIFF+Patch this result.
+	 * 
+	 */
+	
+	private final static String DIFFABLE_LINE_SEPERATOR = "\\"+"n";
+	
+	private static boolean AddTermInfoToEditorTokensHash(Hashtable<IToken,String> list, IStrategoTerm term, String msg)
+	{
+		//System.out.println(term.toString());
+		ImploderAttachment ia = term.getAttachment(ImploderAttachment.TYPE);
+		if (ia != null)
+		{
+			list.put(ia.getLeftToken(), msg);
+			list.put(ia.getRightToken(), msg);
+			return true;
+		} else {
+			if (term.getSubtermCount() > 0)
+				for (IStrategoTerm x : term.getAllSubterms())
+					if (AddTermInfoToEditorTokensHash(list, x, msg))
+						return true;
+		}
+		return false;
+	}
+	
+	public static String TokenizeDiffable(IStrategoTerm result, String sourcecode)
+	{
+		if (result == null)
+			return "Parse Error";
+		  String[] sourceLines = sourcecode.split("\r\n|\r|\n"); 
+		  int sourceLength = sourceLines.length+1;
+		  
+		  IStrategoTerm ast = result.getSubterm(0);
+		  IStrategoTerm list = result.getSubterm(1);
+		  IStrategoTerm err = list.getSubterm(0);
+		  IStrategoTerm warn = list.getSubterm(1);
+		  IStrategoTerm note = list.getSubterm(2);
+		  
+		  Hashtable<IToken,String> errorTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< err.getSubtermCount(); i++)
+			  if (err.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(errorTokens, err.getSubterm(i).getSubterm(0), err.getSubterm(i).getSubterm(1).toString());
+		  
+		  Hashtable<IToken,String> warningTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< warn.getSubtermCount(); i++)
+			  if (warn.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(warningTokens, warn.getSubterm(i).getSubterm(0), warn.getSubterm(i).getSubterm(1).toString());
+
+		  
+		  Hashtable<IToken,String> noteTokens = new Hashtable<IToken,String>();
+		  for (int i=0; i< note.getSubtermCount(); i++)
+			  if (note.getSubterm(i).getSubtermCount() != 0)
+				  AddTermInfoToEditorTokensHash(noteTokens, note.getSubterm(i).getSubterm(0), note.getSubterm(i).getSubterm(1).toString());
+
+		  IToken lefttoken = ImploderAttachment.getLeftToken(ast);
+		  ITokenizer tokenizer = lefttoken.getTokenizer();
+		  
+		  StringBuilder errors = new StringBuilder();
+		  errors.append("");
+		  
+		  StringBuilder[] tokens = new StringBuilder[sourceLength+1];
+		  for (int i = 0; i < sourceLength; i++)
+			  tokens[i] = new StringBuilder();
+		  
+		  
+		  //bespintokens in an array per LOC
+		  for(int i = 0; i < tokenizer.getTokenCount(); i++) {
+				final IToken x = tokenizer.getTokenAt(i);
+				final int start = x.getColumn();
+				final int end = x.getEndOffset() - x.getStartOffset() + start + 1;
+				
+				String bespinType = convertTokenType(x.getKind());
+				//System.out.println(x.getKind() + "  -  " + x.toString());
+				if (noteTokens.containsKey(x))
+				{
+					errors.append(createInfoToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.deprecated";
+				} 				
+				if (warningTokens.containsKey(x))
+				{
+					errors.append(createWarningToken(x.getLine()-1, x.getColumn(), warningTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.deprecated";
+				} 	
+				if (errorTokens.containsKey(x))
+				{
+					errors.append(createErrorToken(x.getLine()-1, x.getColumn(), errorTokens.get(x))+ ",\n") ;
+					bespinType = "invalid.illegal";
+				} 
+				
+				
+				tokens[x.getLine()-1].append(createBespinToken(x.toString(), bespinType, start, end, x.getLine()));
+		  }
+		  
+		  StringBuilder json = new StringBuilder();
+		  json.append("{\"parseme\": \"");
+		  for (int i = 0; i < sourceLines.length; i++)
+		  {
+			  if (tokens[i].length() > 0)
+				  json.append(tokens[i]+DIFFABLE_LINE_SEPERATOR);
+		  }
+		  json.append("\"");
+		  if (errors.length() > 0)
+			  errors.deleteCharAt(errors.length()-2);
+		  
+		  json.append(", \"errors\": [");
+		  json.append(errors);
+		  json.append("] }\n");
+		  
+		  return json.toString();
+		
+	}
+	
+	private static String createBespinToken(String value, String tokentype, int startColumn, int endColumn, int lineNumber) {
+		String x = "";
+		String t = "\\" + "r";
+		String e = t + t;
+		value = value.replaceAll("\n|\r", "");
+		value = value.replaceAll("\"", "\\\\\"");
+		value = value.replaceAll("	", "\\\\\\t");
+		x = value+t+tokentype+t+startColumn+t+endColumn+e;
+		return x;
+	}
+	
+	
+	private static String createErrorToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"error\"" ;
+		 x += "  }";
+	      return x;
+	}
+	
+	private static String createWarningToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"warning\"" ;
+		 x += "  }";
+	      return x;
+	}
+	
+	private static String createInfoToken(int row, int column, String text) {
+		String x = ""; 
+	     x += " {";
+         x += "   \"row\": "+row+",";
+         x += "	  \"column\": "+column+"," ;
+		 x += "   \"text\": "+text+"," ;
+		 x += "   \"type\": "+"\"info\"" ;
+		 x += "  }";
+	      return x;
+	}		
+	
+	
+	private static String convertTokenType(int kind) {
+		switch(kind) {
+		case IToken.TK_LAYOUT: return "comment";
+		case IToken.TK_NUMBER: return "constant";
+		case IToken.TK_OPERATOR: return "keyword.operator";
+		case IToken.TK_KEYWORD: return "keyword";
+		case IToken.TK_STRING: return "string";
+		case IToken.TK_IDENTIFIER: return "variable";
+		case IToken.TK_ERROR_KEYWORD: return "invalid.illegal";
+		
+		default: return "plain";
+		}
+	}
+
+
+}
+

From gabrielkonat at gmail.com  Tue May 29 23:24:54 2012
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Tue, 29 May 2012 21:24:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24875 - in
	spoofax-contrib/separate-compilation-examples:
	c-without-macros/lib csharp-partial-classses/lib
	csharp-partial-classses/syntax csharp-partial-classses/test csha...
Message-ID: <20120529212454.24E587F804B@mx1.tudelft.nl>

Author: gkonat
Date: Tue May 29 21:24:53 2012
New Revision: 24875
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24875&sc=1

Log:
Added some extra features to C# example.

Modified:
   spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/syntax/CSharpPartialClassses.sdf
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example2.csh
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/analysis-manual.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/check.str
   spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/types.str
   spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str

Modified: spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/c-without-macros/lib/editor-common.generated.str	Tue May 29 21:24:53 2012	(r24875)
@@ -228,6 +228,9 @@
   Entity   : ID * List(Property) -> Entity
   Property : ID * Type           -> Property
   Type     : ID                  -> Type
+  
+  Type     : Namespace
+  Property : Namespace
 
 strategies
   

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/lib/editor-common.generated.str	Tue May 29 21:24:53 2012	(r24875)
@@ -228,6 +228,9 @@
   Entity   : ID * List(Property) -> Entity
   Property : ID * Type           -> Property
   Type     : ID                  -> Type
+  
+  Type     : Namespace
+  Property : Namespace
 
 strategies
   

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/syntax/CSharpPartialClassses.sdf
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/syntax/CSharpPartialClassses.sdf	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/syntax/CSharpPartialClassses.sdf	Tue May 29 21:24:53 2012	(r24875)
@@ -22,7 +22,7 @@
 		
 		%% Class members
 		Type Field@=ID ";"                    -> ClassBodyDecl {"Field"}
-		Type Method@=ID "(" ")" "{" Stmt* "}" -> ClassBodyDecl {"Method"} 
+		Type Method@=ID "(" {Param ","}* ")" "{" Stmt* "}" -> ClassBodyDecl {"Method", scope(Var)} 
 		
 		%% Types
 		Type at ID   -> Type {"Type"}
@@ -31,10 +31,31 @@
 		"void"    -> Type {"VoidType", prefer}
 		
 		%% Statements
-		"return" Expr ";" -> Stmt {"Return"}   
+		"return" Expr ";"         -> Stmt {"Return", prefer}
+	  Type Var@=ID ";"          -> Stmt {"VarDecl"}
+    Type Var@=ID "=" Expr ";" -> Stmt {"VarDecl"}
+    "if" "(" Expr ")" Block   -> Stmt {"If", scope(Var)}
+    "if" "(" Expr ")" Block "else" Block -> Stmt {"IfElse", scope(Var)}
 		 
-		%% Expressions
-		Field at ID                    -> Expr {"FieldRef"}
-		Expr "." Field at ID           -> Expr {"FieldAccess"}
-		Expr "." Method at ID "(" ")"  -> Expr {"MethodCall"}
-		Method at ID "(" ")"           -> Expr {"ThisMethodCall"}
+		%% Expressions
+		INT                         -> Expr {"IntLit"}
+		Var at ID                      -> Expr {"VarRef"}
+		Expr "." Field at ID           -> Expr {"Access"}
+		Expr "." Method at ID "(" {Expr ","}* ")"  -> Expr {"MethodCall"}
+		Method at ID "(" {Expr ","}* ")"           -> Expr {"ThisMethodCall"}
+		
+		Expr "+" Expr               -> Expr {"Add"}
+		Expr "-" Expr               -> Expr {"Sub"}
+    Expr "*" Expr               -> Expr {"Mul"}
+    Expr "/" Expr               -> Expr {"Div"}
+    Expr "==" Expr              -> Expr {"Eq"}
+    Expr "<" Expr               -> Expr {"Lt"}
+    Expr "<=" Expr              -> Expr {"Lte"}
+    Expr ">" Expr               -> Expr {"Gt"}
+    Expr ">=" Expr              -> Expr {"Gte"}
+		
+		%% Other
+		"{" Stmt* "}" -> Block {"Block"}
+		Stmt          -> Block
+		
+		Type Var@=ID -> Param {"Param"}

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example.csh	Tue May 29 21:24:53 2012	(r24875)
@@ -1,5 +1,5 @@
 namespace Web {
 	partial class URL {
-		//string location;
+		string location;
 	}
 }
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example2.csh
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example2.csh	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/test/example2.csh	Tue May 29 21:24:53 2012	(r24875)
@@ -19,11 +19,26 @@
 		string body;
 		
 		URL Homepage() {
-		  return poster.homepage;
+		  URL l;
+		  return l;
 		}
 		
 		string Location() {
 			return Homepage().GetLocation();
 		}
+
+		int dec(int num) {
+		  return num - 1;
+		}
+		
+		int factorial(int num) {
+		  if(num <= 1) {
+		    int fac = 1;
+		    return fac;
+		  }
+		  
+	    int fac = num * factorial(dec(num));
+	    return fac;
+		}
 	}
 }
\ No newline at end of file

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/analysis-manual.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/analysis-manual.str	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/analysis-manual.str	Tue May 29 21:24:53 2012	(r24875)
@@ -16,7 +16,7 @@
   
   // Return a list of fields in the class on the left hand side.
   adjust-index-lookup(target |namespace, path, prefix):
-    FieldAccess(e, <target>) -> f*
+    Access(e, <target>) -> f*
     with
 	    if TYPE(e-type{_}) := <type-of> e then
         f* := <index-lookup-children(|Field(), prefix)> e-type
@@ -24,9 +24,13 @@
         f* := StopLookup()
       end
       
+  // Return both local variables and fields.
+  adjust-index-lookup(target |namespace, path, prefix):
+    VarRef(<target>) -> [[Var() | path], [Field() | path]]
+      
   // Return a list of methods in the class on the left hand side.
   adjust-index-lookup(target |namespace, path, prefix):
-    MethodCall(e, <target>) -> m*
+    MethodCall(e, <target>, _) -> m*
     with
 	    if TYPE(e-type{_}) := <type-of> e then
         m* := <index-lookup-children(|Method(), prefix)> e-type

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/check.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/check.str	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/check.str	Tue May 29 21:24:53 2012	(r24875)
@@ -49,7 +49,7 @@
 rules // Types
   
   constraint-error:
-    Method(type, _, statement) -> errors
+    Method(type, _, _, statement) -> errors
     where
       <collect-one(?Return(_))> statement; // At least one return statement can be found.
     	methodType := <type-of> type;
@@ -62,7 +62,7 @@
       not(<is-assignable-to> (methodType, type))
     	
   constraint-error:
-    Method(type, _, statement) -> (type, $[Method of type [<print-type> type1] does not return a value.])
+    Method(type, _, _, statement) -> (type, $[Method of type [<print-type> type1] does not return a value.])
     where
       type1 := <type-of> type;
       not(<is-assignable-to> (type1, <type-of> VoidType()));

Modified: spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/types.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/types.str	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/csharp-partial-classses/trans/types.str	Tue May 29 21:24:53 2012	(r24875)
@@ -23,7 +23,7 @@
     Class(x, _) -> TYPE(x)
     
   type-of:
-  	Method(x, _, _) -> <type-of> x
+  	Method(x, _, _, _) -> <type-of> x
     
   type-of:
   	Type(x) -> TYPE(x)
@@ -32,6 +32,15 @@
     Return(e) -> <type-of> e	
   
   type-of:
+    VarDecl(t, _) -> <type-of> t
+    
+  type-of:
+    VarDecl(t, _, _) -> <type-of> t
+    
+  type-of:
+    Param(t, _) -> <type-of> t
+  
+  type-of:
   	StringType() -> TYPE("string")
   	
   type-of:
@@ -39,18 +48,21 @@
   	
   type-of:
   	VoidType() -> TYPE("void")
+  	
+	type-of:
+	  IntLit(_) -> <type-of> IntType()
   
   type-of:
-    FieldRef(f) -> <type-of> <index-lookup> f
+    VarRef(f) -> <type-of> <index-lookup> f
   
   type-of:
-    FieldAccess(e, f) -> <type-of> <index-lookup> f
+    Access(e, f) -> <type-of> <index-lookup> f
     
   type-of:
-    MethodCall(e, m) -> <type-of> <index-lookup> m
+    MethodCall(e, m, _) -> <type-of> <index-lookup> m
     
   type-of:
-    ThisMethodCall(m) -> <type-of> <index-lookup> m
+    ThisMethodCall(m, _) -> <type-of> <index-lookup> m
 
   type-of:
     Def(uri) -> <index-get-value> Type(uri, ())

Modified: spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str
==============================================================================
--- spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str	Tue May 29 15:35:50 2012	(r24874)
+++ spoofax-contrib/separate-compilation-examples/entity-with-aspects/lib/editor-common.generated.str	Tue May 29 21:24:53 2012	(r24875)
@@ -228,6 +228,9 @@
   Entity   : ID * List(Property) -> Entity
   Property : ID * Type           -> Property
   Type     : ID                  -> Type
+  
+  Type     : Namespace
+  Property : Namespace
 
 strategies
   

From oskarvanrest at gmail.com  Thu May 31 03:33:36 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 01:33:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24876 - in
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf:
	test/emf trans/emf
Message-ID: <20120531013336.214262B8005@mx2.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 01:33:34 2012
New Revision: 24876
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24876&sc=1

Log:
Refactor + bugfixes

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf	Tue May 29 21:24:53 2012	(r24875)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/test/emf/EntityLang.sdf	Thu May 31 01:33:34 2012	(r24876)
@@ -15,4 +15,4 @@
     "module" Module@=ID Type*				-> Start {"Module", scope(Type)}
     "entity" Type@=ID "{" Property* "}"		-> Type {"Entity", scope(Property)}
 	"primitive" Type @=ID					-> Type {"Primitive"}
-    Property@=ID ":" Type at Type				-> Property {"Property"}
+    Property@=ID ":" Type at ID				-> Property {"Property"}

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Tue May 29 21:24:53 2012	(r24875)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Thu May 31 01:33:34 2012	(r24876)
@@ -21,12 +21,12 @@
 		classes' := <remove-all(?[])> <conc>(classes, superclasses)
 
 	to-ecore:
-		prod(lhs, sort(s), attributes) -> EClass(properties, structuralFeatures')
+		prod(lhs, sort(s), attributes) -> EClass(properties', structuralFeatures')
 		where
 			cons := <fetch-cons-name> attributes;
 			name := Name(cons);
-			if <eq> (s, cons) + <eq> (s, "Start") then eSuperType := [] else eSuperType := ESuperType(s) end;
-			properties := <remove-all(?[])> [name, eSuperType];
+			if <eq> (s, cons) + <eq> (s, "Start") then properties := [] else properties := [ESuperType(s)] end;
+			properties' := <add-property> (name, properties);
 			structuralFeatures := <remove-all(?lit(_) + ?ci-lit(_))> lhs;
 			structuralFeatures' := <map(set-name; set-containment; set-bounds; set-structuralFeature)> structuralFeatures
 
@@ -41,65 +41,65 @@
 	set-containment:
 		(namespacedef(_, sort), properties) -> (sort, properties')
 		where
-			properties' := <remove-all(?[])> <conc> (properties, [Containment(True())])
-
+			properties' := <add-property> (Containment(True()), properties)
+	
+	// for namespaceref2, also set name and type
 	set-containment:
-		(namespaceref2(_, sort), properties) -> (sort, properties')
+		(namespaceref2(namespace, sort), properties) -> (sort, properties')
 		where
-			properties' := <remove-all(?[])> <conc> (properties, [Containment(False())])
+			name := Name(<lower-case> namespace);
+			type := Type(namespace);
+			containment := Containment(False());
+			properties' := <add-properties> ([name, type, containment], properties)
 		
 	set-containment:
 		(sort, properties) -> (sort, properties')
 		where
 			not ( <?namespacedef(_, _)> sort + <?namespaceref2(_, _)> sort);
-			properties' := <remove-all(?[])> <conc> (properties, [Containment(False())])
+			properties' := <add-property> (Containment(False()), properties)
+
+	set-bounds:
+		(opt(sort(s)), properties) -> (s, properties')
+		where
+			properties' := <add-properties> ([LowerBound(0), UpperBound(1)], properties)
 
 	set-bounds:
 		(sort(s), properties) -> (s, properties')
 		where
-			properties' := <conc> (properties, [LowerBound(1), UpperBound(1)])
+			properties' := <add-properties> ([LowerBound(1), UpperBound(1)], properties)
 
 	set-bounds:
 		(iter(sort(s)), properties) -> (s, properties')
 		where
-			properties' := <conc> (properties, [LowerBound(1), UpperBound(-1)])
+			properties' := <add-properties> ([LowerBound(1), UpperBound(-1)], properties)
 	
 	set-bounds:
 		(iter-star(sort(s)), properties) -> (s, properties')
 		where
-			properties' := <conc> (properties, [LowerBound(0), UpperBound(-1)])
+			properties' := <add-properties> ([LowerBound(0), UpperBound(-1)], properties)
 	
 	set-structuralFeature:
 		(s, properties) -> eStructuralFeature
-		where
-			properties' := <add-name> (s, properties);
+		where			
+			if <fetch(?UpperBound(-1))> properties
+			then name := Name(<lower-case; make-plural> s)
+			else name := Name(<lower-case> s)
+			end;
+			properties' := <add-property> (name, properties);
 			
 			if
 				<int-or-string> s
 			then
 				type := Type(<int-or-string> s);
-				properties'' := <conc> (properties', [type]);
-				properties''' := <remove-all(?Containment(_))> properties';
+				properties'' := <add-property> (type, properties');
+				properties''' := <remove-all(?Containment(_))> properties'';
 				eStructuralFeature := EAttribute(properties''')
 			else
 				type := Type(s);
-				properties'' := <conc> (properties', [type]);
+				properties'' := <add-property> (type, properties');
 				eStructuralFeature := EReference(properties'')
 			end
 
-	add-name:
-		(s, properties) -> properties'
-		where
-			if <fetch(?Name(_))> properties
-			then properties' := properties
-			else
-				if <fetch(?UpperBound(-1))> properties
-				then name := Name(<lower-case; make-plural> s)
-				else name := Name(<lower-case> s)
-				end;
-				properties' := <conc> (properties, [name])
-			end
-
 	int-or-string:
 		"INT" -> EInt()
 		
@@ -121,7 +121,22 @@
 			not ( <eq> (s, "Start" ))
 			
 	
-rules // Utils
+rules // utils
+
+	// add property with constructor cons to list if list doesn't contain a property with constructor cons yet 
+	add-property:
+		(property, list) -> list'
+		where
+			cons := <get-constructor> property;
+			if 	<fetch(<eq> (cons, <get-constructor>))> list
+			then list' := list
+			else list' := <conc> (list, [property])
+			end
+			
+	add-properties:
+		(properties, list) -> list'
+		where
+			list' := <foldl(add-property)> (properties, list)
 
 	make-plural:
 		string -> string'

From g.h.wachsmuth at tudelft.nl  Thu May 31 04:31:53 2012
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Thu, 31 May 2012 02:31:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24877 - in
	spoofax-imp/trunk/org.strategoxt.imp.names: lib syntax trans
Message-ID: <20120531023153.D36957F800B@mx1.tudelft.nl>

Author: GuidoWachsmuth
Date: Thu May 31 02:31:53 2012
New Revision: 24877
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24877&sc=1

Log:
intermediate version

Added:
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library-internal.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/compilation-library.str
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/index-library.str
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
   spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
   spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May 31 01:33:34 2012	(r24876)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-auto.generated.str	Thu May 31 02:31:53 2012	(r24877)
@@ -28,19 +28,16 @@
     Namespace(x) -> <nam-get-def(|Namespace())> x
 
   nam-annotate-names(|def-path):
-    Naming(t_488116, u_488116, v_488116, w_488116) -> Naming(t_488116{def-path}, u_488116, v_488116, w_488116)
+    Naming(j_10682, k_10682, l_10682, m_10682) -> Naming(j_10682{def-path}, k_10682, l_10682, m_10682)
 
   nam-annotate-names(|def-path):
-    Import(s_488116) -> Import(<nam-annotate-use(|Module())> s_488116)
+    Import(i_10682) -> Import(<nam-annotate-use(|Module())> i_10682)
 
   nam-annotate-names(|def-path):
-    Namespace(r_488116) -> Namespace(r_488116{def-path})
+    Namespace(h_10682) -> Namespace(h_10682{def-path})
 
   nam-annotate-names(|def-path):
-    NsRef(q_488116) -> NsRef(<nam-annotate-use(|Namespace())> q_488116)
-
-  nam-get-scope-types :
-    Naming(_, _, _, _) -> [Namespace()]
+    NsRef(g_10682) -> NsRef(<nam-annotate-use(|Namespace())> g_10682)
 
   nam-get-def(|n) =
     fail

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library-internal.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library-internal.str	Thu May 31 02:31:53 2012	(r24877)
@@ -0,0 +1,755 @@
+module lib/analysis-library-internal
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library
+  lib/index-library
+  
+signature constructors
+  
+  // Analysis
+  Results         : AST * List(Def) * List(Use) * List(DefData) * List(Def) * List(Def) * List(File) -> Results
+  ParallelResults : AST * AST * List(Error) * List(Warning) * List(Note) * List(File) -> ParallelResults
+  
+  // Namespaces
+  Diff            : Namespace
+  ASTDiff         : Namespace
+  
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @internal
+   * @type List((ast, (file, subfile))) -> Results(List(ast), List(def), List(use), List(data), List(addedElem), 
+   *                                       List(removedElem), List(fileToAnalyze@(file, subfile))))
+   */
+  analyze-top-internal(|phase, language, project-path, full-path):
+    astFilePairs -> Results(asts, defs, uses, data, added, removed, filesToAnalyze)
+    with
+      // Init
+      index-setup(|language, [project-path], full-path);
+      revision := <index-start-transaction>
+    with
+      // Store old elements
+      oldElems := <filter(index-diff-constructors)> <index-get-all-in-file> full-path;
+      <index-clear-file> full-path
+    with
+      {| Index-UnresolvedSet:
+        unresolvedSet := <new-iset>;
+        rules(Index-UnresolvedSet: _ -> unresolvedSet);
+        
+        (astFilePairs2, defsList) := <unzip> <map(analyze-top-defs)> astFilePairs;
+        defs := <concat> defsList;
+        (astFilePairs3, dataList) := <unzip> <map(analyze-top-data(|language, full-path))> astFilePairs2;
+        data := <concat> dataList;
+        (astFilePairs4, usesList) := <unzip> <map(analyze-top-uses(|language, full-path))> astFilePairs3;
+        uses := <concat> usesList;
+        (asts, _) := <unzip> astFilePairs4
+      |}
+    with
+      index-end-transaction
+    with
+      // Schedule re-analysis of dependent files (if current file is not testing language file)
+      // HACK: Depends on file extension, could be other languages with .spt extension?
+      if Editor() := phase; not(<is-test-file> full-path) then
+        newElems := <conc> (defs, <filter(index-diff-constructors)> data);
+        
+        // Find added and removed definitions
+        (added, removed) := <analyze-diff> (oldElems, newElems);
+        changed := <conc> (added, removed);
+        
+        // Store files that have changed in the index
+        index-transaction(
+          filesToAnalyze := <analyze-store-diff(|changed, revision)> astFilePairs4
+        )
+      else
+        (added, removed) := ([], []);
+        filesToAnalyze := []
+      end
+    with
+      <list-loop(analyze-top-store-ast)> astFilePairs4
+      
+  /**
+   * Add URI annotations to each definition and unresolved URI annotations to each use site.
+   *
+   * @internal
+   */
+  analyze-top-defs:
+    (ast, file) -> ((ast2, file), defs)
+    with
+      <index-set-current-file> file;
+      (Some(ast2), defs) := <analyze-defs> (Some(ast), []); // HACK: force origin tracking with Some()... // TODO: still needed?
+      <index-add-all(|file)> defs
+      
+  /**
+   * Gathers all data for each definition.
+   *
+   * @internal
+   */
+  analyze-top-data(|language, full-path):
+    (ast, file) -> ((ast2, file), data2)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Gather all data for each definition.
+        ast2 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast; // Parent pointers needed.
+        data := <origin-track-forced(analyze-tree-data)> ast2;
+        
+        // Resolve all references in gathered data.
+        (data2, _) := <analyze-uses> data; // Ignoring data uses, have not found a use-case for them yet.
+        <index-add-all(|file)> data2;
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Resolves all unresolved references for each use site.
+   *
+   * @internal
+   */
+  analyze-top-uses(|language, full-path):
+    (ast, file) -> ((ast3, file), uses)
+    with
+      <index-set-current-file> file;
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Resolve all unresolved references for each use site.
+        (ast2, uses) := <analyze-uses> ast;
+        <index-add-all(|file)> uses;
+        
+        ast3 := <prim("SSL_EXT_clone_and_set_parents", <id>)> ast2; // AST changed, reset parent pointers.
+        
+        // Store reads into the index (if not testing language)
+        if not(is-test-input(|language, full-path)) then
+          <index-add-all(|file)> <iset-elements> readSet
+        end
+      |}
+      
+  /**
+   * Stores AST from file to the index.
+   *
+   * @internal
+   */   
+  analyze-top-store-ast:
+    (ast, file) -> <id>
+    with
+      <index-set-global(|[<index-file-to-string> file, "ast"])> ast
+      
+  /**
+   * Identifies all definitions in the tree and annotates them with their URI.
+   * Also annotates uses with a preliminary "Unresolved(_)" URI.
+   *
+   * @internal
+   */
+  analyze-defs = analyze-defs(|Anon(<new>), Anon(), [])
+  
+  /** @internal */
+  analyze-defs(|head-scope, head-scope-ns, ns-path*):
+    (ast, def*) -> (ast'', def''*)
+    with
+    	<debug(!"hs: ")> head-scope;
+    	<debug(!"hs-ns: ")> head-scope-ns
+    with
+      if 
+        def'*          := <nam-get-definitions> ast ; 
+        [definition|_] := def'* 
+      then
+      	def-uri        := <index-uri> definition ;
+        head-scope-ns' := <index-uri-namespace> def-uri;
+        head-scope'    := <index-uri-name> def-uri;
+        def''*         := [def*, def'*]
+      else
+        def-uri        := INTERNAL_ERROR();
+        head-scope-ns' := head-scope-ns;
+        head-scope'    := head-scope;
+        def''*         := def*
+      end;
+      {| IndexPath:
+      	<debug(!"enter ")> ast ;
+        if scope-types := <nam-get-scope-types> ast then
+          <list-loop(update-index-path(|head-scope', head-scope-ns', ast))> scope-types;
+          //ns-path'*       := ns-path* ; //<foldl(new-update-index-path(|head-scope', head-scope-ns', ast))> (scope-types, ns-path*) ;
+          head-scope-ns'' := Anon();
+          head-scope''    := Anon()
+        else
+      	  head-scope-ns'' := head-scope-ns';
+          head-scope''    := head-scope'
+          //ns-path'*       := ns-path*
+        end;
+        (ast', def'''*) := <thread-replacement(analyze-defs(|head-scope'', head-scope-ns'', ns-path*))> (ast, def''*) ;
+        ast''           := <try(nam-annotate-names(|def-uri))> ast' ;
+        <debug(!"leave ")> ast
+      |}   
+        
+  /** @internal */
+  update-index-path(|head-scope, head-scope-ns, ast):
+    scope-type -> scope-type
+    where
+      if !head-scope-ns => Anon() then
+        path  := <IndexPath <+ ![]> scope-type;
+        path' := <do-adjusted-index-path(|scope-type, path, Anon(<new>))> ast
+      else
+        path  := <IndexPath <+ ![]> head-scope-ns;
+        path' := <do-adjusted-index-path(|scope-type, path, head-scope)> ast
+      end;
+      <debug(!"path: ")> (scope-type, path') ;
+      rules(IndexPath: scope-type -> path')
+ 
+  /* TODO: consider using simple-update-def-path
+   *       which uses "balanced" path scopes
+   *       e.g. when Entity doesn't scope Function
+   *       then it's hard to access properties from a function
+  balanced-update-index-path:
+    head-scope -> head-scope
+    where
+      if !head-scope => Anon() then
+        head-scope' := Anon(<new>)
+      else
+        head-scope' := head-scope
+      end;
+      (something with do-adjust-path)
+      rules(IndexPath := [head-scope' | <IndexPath <+ ![]> ()])
+  */
+ 
+  /**
+   * Analyze all uses, changing their preliminary "Unresolved(_)" URI to a definite URI of their definition.
+   *
+   * @internal
+   */
+  analyze-uses:
+    ast -> (ast'', uses')
+    with
+      analyzed     := <all(analyze-uses)> ast;
+      (ast', uses) := <unzip-analyzed> analyzed;
+      if !ast' => _{unresolved@[Unresolved(namespace), x | path]} then
+        if Def(def-uri) := <index-lookup(id |namespace, path, <strip-annos> ast')> ast' then
+          ast'' := ast{def-uri};
+          uses' := [Use(def-uri) | uses]
+        else
+          ast'' := ast';
+          uses' := [BadUse([namespace, x]) | uses]
+        end
+      else
+        ast'' := ast';
+        uses' := uses
+      end
+ 
+  /**
+   * Collects all index data (e.g. types of definitions).
+   *
+   * @internal
+   */
+  analyze-tree-data:
+    tree -> data
+    where
+      set := <new-iset>;
+      <topdown(analyze-tree-data-part(|set))> tree;
+      data := <iset-elements> set
+      
+  /** @internal */
+  analyze-tree-data-part(|set):
+    tree -> tree
+    where
+      if key* := <nam-get-definition-keys> then
+        <list-loop(do-adjust-index-def-data(|tree, set))> key*
+      end
+  
+  /** @internal */
+  do-adjust-index-def-data(|tree, set):
+  	_{[namespace | path]} -> <id>
+  	where 
+  		if result := <adjust-index-def-data(store-index-data-results(|set)|namespace, path)> tree then
+          <fatal-err(|"Unexpected result from adjust-index-def-data; should call <store-results>")> result
+        end
+        
+  /** @internal */
+  store-index-data-results(|set):
+    t -> <fail>
+    where
+      if is-list then
+        <iset-addlist(|t)> set
+      else
+        <iset-add(|t)> set
+      end
+      
+rules // Parallel analysis
+  
+  /** @internal */
+  index-parallel-analyze(analyze):
+    files -> allResults
+    with
+      map(index-parse-file); // Parsing cannot be done in parallel.
+      map(\(ast, file) -> (ast, file, <project-path>)\);
+      parallel-unordered(all(index-analyze(analyze)));
+      ?results;
+      with(<eq> (<length> results, <length> files) | "Input size not equal to output size");
+      filesToAnalyze := <make-set> <mapconcat(?ParallelResults(_, _, _, _, _, <id>))> results;
+      if not([] := filesToAnalyze) then
+        allResults := <concat> [results, <index-parallel-analyze(analyze)> filesToAnalyze]
+      else
+        allResults := results
+      end
+  
+  /** @internal */   
+  index-parse-file:
+    file -> (ast, file)
+    with
+    if <file-exists> file then
+      ast := <parse-file> file
+    else
+      ast := ()
+    end
+   
+  /** @internal */   
+  index-set-markers:
+    ParallelResults(ast, ast', errors, warnings, notes, diffs) -> <id>
+    with
+      <set-markers(|ast)> (ast', errors, warnings, notes)
+      
+  /** @internal */
+  index-analyze(analyze):
+    (ast, path, project-path) -> ParallelResults(ast, ast', errors, warnings, notes, filesToAnalyze)
+    with
+      (ast', errors, warnings, notes, filesToAnalyze) := <analyze>;
+      if [] := filesToAnalyze then
+        complete-work-unit
+      end
+      
+/** @internal */
+rules // Splitter
+  
+  /** @internal */
+  index-split = fail
+  /** @internal */
+  index-is-toplevel = fail
+  /** @internal */
+  index-is-qualifier = fail
+  /** @internal */
+  index-qualifier-subelements = fail
+  /** @internal */
+  index-create-qualifier(|qualifier) = fail
+  
+  /** @internal */
+  index-toplevel-split:
+    ast -> asts'
+    with
+      (ast', _) := <analyze-defs> ast;
+      asts      := <index-toplevel-split-internal> ast';
+      asts'     := <strip-annos> asts
+      
+  /** @internal */
+  index-toplevel-split-internal:
+    node -> units
+    with
+      switch id
+        case ?():
+          units := [((), [])]
+        case index-is-qualifier:
+          elems := <mapconcat(index-toplevel-split-internal)> <index-qualifier-subelements> node;
+          units := <map(index-transform-qualifier(|node))> elems
+        case index-is-toplevel:
+          units := [(node, <index-uri> <nam-get-definition-keys ; Hd> node)]
+        otherwise:
+          units := [(node, [])]
+      end
+      
+  /** @internal */
+  index-transform-qualifier(|node):
+    (elem, subfileName) -> (qualifier, subfileName)
+    with
+      qualifier := <index-create-qualifier(|node)> elem
+
+/** @internal */
+rules // Diffs
+  
+  /** @internal */
+  analyze-diff:
+    (defs1, defs2) -> (added, removed)
+    with
+      added   := <diff(index-diff-compare)> (defs2, defs1);
+      removed := <diff(index-diff-compare)> (defs1, defs2)
+    
+  /** @internal */
+  analyze-store-diff(|changedEntries, revision): 
+    astFilePairs -> analyzeFiles'
+    with
+      changedFiles    := <mapconcat(index-get-files-of)> changedEntries;
+      dependentFiles  := <index-get-dependent-files> changedEntries;
+      
+      // Files to analyze
+      analyzeFiles := <make-set> <remove-all(fake-file)> dependentFiles;
+      analyzeFiles' := analyzeFiles;
+      // TODO: Is this extra check needed?
+      /*if <getfirst(index-get-file-revision; \r -> (r, revision)\; gt)> analyzeFiles then
+        // Add current file if the current file has read information from another file with a higher revision.
+        // This indicates that potentially outdated information was read.
+        analyzeFiles' := [file|analyzeFiles]
+      else
+        analyzeFiles' := analyzeFiles
+      end;*/
+      
+      // Files to compile
+      changedAstFiles := <filter(analyze-astdiff)> astFilePairs;
+      compileFiles := <make-set> <concat> [analyzeFiles', changedFiles, changedAstFiles];
+      // TODO: Optimize so that there are no duplicate files stored in the index, use iset?
+      <map(analyze-add-compilediff)> compileFiles
+      
+  /** 
+   * Checks if ast for given file has changed. Succeeds if old ASTDiff is not found or if ASTDiff is different.
+   *
+   * @internal
+   */
+  analyze-astdiff:
+    (ast, file) -> file
+    where
+      name := [<index-file-to-string> file, "ast-checksum"];
+      newChecksum := <checksum> ast;
+      if oldChecksum := <index-get-global(|name)> then
+        <index-set-global(|name)> newChecksum;
+        not(<eq> (oldChecksum, newChecksum))
+      else
+        <index-set-global(|name)> newChecksum
+      end
+      
+  /** 
+   * Adds given file to the list of files to compile.
+   *
+   * @internal
+   */
+  analyze-add-compilediff = index-add-global(|"compile-diff")
+  
+  /** 
+   * Gets the list of files to compile, and then clear it.
+   *
+   * @internal
+   */
+  analyze-get-compilediffs = index-get-all-globals(|"compile-diff"); index-clear-global(|"compile-diff")
+  
+rules // Index lookup rules (that take into account adjust-index-lookup)
+  
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> definition
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      if <?StopLookup()> candidates then
+        fail
+      else
+        definition       := <index-select(|namespace, path, x)>
+      <+
+        // TODO: optimize: try not to call do-adjust-index-lookup from here
+        [_ | path'] := path;
+        definition        := <index-lookup(is-adjust-lookup-enabled|namespace, path', prefix)> x
+      end
+
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-all(is-adjust-lookup-enabled|namespace, path, prefix):
+    x -> defs'
+    where
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      defs       := <index-select-all(|namespace, path, x)>;
+      // TODO: optimize: try not to call do-adjust-index-lookup from here
+      if [_ | path'] := path then
+        defs2 := <index-lookup-all(is-adjust-lookup-enabled|namespace, path', prefix)> x;
+        defs' := <conc> (defs, defs2)
+      else
+        defs' := defs
+      end
+      
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   * @internal
+   */
+  index-lookup-outermost(is-adjust-lookup-enabled |namespace, path, prefix):
+    x -> definition
+    where
+      // TODO: optimize: just like index-lookup
+      [_ | path'] := path;
+      definition        := <index-lookup-outermost(is-adjust-lookup-enabled |namespace, path', prefix)> x
+    <+
+      candidates := <index-lookup-one-level(is-adjust-lookup-enabled|namespace, path, prefix)>;
+      definition       := <index-select(|namespace, path, x)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   *
+   * @type "name"{uri} -> List(Def(uri'))
+   * @internal
+   */
+  index-lookup-one-level(is-adjusted-lookup-enabled|namespace, path, prefix):
+    x{_} -> defs
+    with
+      is-adjusted-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        defs := StopLookup()
+      else
+        mapconcat(\d at Def(p) -> [d]\
+          <+ \[namespace' | path'] -> <index-lookup-one-level(fail |namespace', path', prefix)> x\
+          <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?defs
+      end
+    <+
+      defs := <index-get-children(|namespace, prefix)> Def([namespace | path])
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   *
+   * @internal
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(is-adjust-lookup-enabled |namespace, path, prefix):
+    x{_} -> all-defs
+    with
+      is-adjust-lookup-enabled;
+      do-adjust-index-lookup(|namespace, path, x, prefix);
+      if ?StopLookup() then
+        all-defs := []
+      else
+        mapconcat(\d at Def(p) -> [d]\
+            <+ \[namespace' | path'] -> <index-lookup-all-levels(fail |namespace', path', prefix)> x\
+            <+ fatal-err(|"Unexpected result from adjust-index-lookup, should be a list Def(_) or [namespace | path] or StopLookup() to stop the lookup"));
+        ?all-defs
+      end
+    <+
+      one-level := <index-get-children(|namespace, prefix)> Def([namespace | path]);
+      if [_ | path'] := path then
+        all-defs := <concat> [one-level, <index-lookup-all-levels(fail |namespace, path', prefix)> x]
+      else
+        all-defs := one-level
+      end
+      
+/** @internal */
+rules // URI and value projections
+       
+  /** @internal */
+  index-uri-impl:
+    Def(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Use(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    Read(uri) -> uri
+    
+  /** @internal */  
+  index-uri-impl:
+    x{[namespace | path]} -> [<index-namespace-unwrap> namespace | path]
+ 
+  /**
+   * TODO: Should second part of ReadWildcard be included in the URI, between namespace and path?
+   * 
+   * @internal 
+   */
+  index-uri-impl:
+    ReadWildcard(uri, _) -> uri
+
+  /** @internal */
+  index-value-impl:
+    Def(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Use(value) -> value
+
+  /** @internal */
+  index-value-impl:
+    Read(value) -> value
+  
+  /** @internal */
+  index-value-impl:
+    ReadWildcard(_, value) -> value
+       
+/** @internal */
+rules // Internal helpers
+
+  /**
+   * Transforms a term C( (a1, [b1]), (a2, [b2, b3]) ) to a tuple (C(a1, a2), [b1, b2, b3]).
+   *
+   * @internal
+   */
+  unzip-analyzed:
+    appl -> (appl', unzipped-parts)
+    with
+      appl'          := <all(\(a, _) -> a\)> appl;
+      unzipped-parts := <concat> <get-appl-arguments(\(_, b) -> b\) <+ map(\(_, b) -> b\) <+ ![]> appl
+       
+  /**
+   * Tests if the current file is just a testing language input
+   *
+   * @internal
+   */
+  is-test-file = 
+    string-ends-with(|".spt")
+  /** @internal */
+  is-test-language = 
+    ?"Spoofax-Testing"
+  /** @internal */
+  is-test-input(|language, path) = 
+    <is-test-language> language <+ <is-test-file> path
+      
+  /** @internal */
+  fake-file = 
+    is-test-file <+ index-is-fake-file
+  
+  /** @internal */    
+  index-filepair-to-file = 
+    Fst; string-replace(|$[[<project-path>]/], "")
+  
+  /** @internal */
+  ast-uri-to-ast-file(|full-path):
+    (ast, uri) -> (ast, (full-path, uriStr))
+    with
+      (<index-uri-to-string> uri <+ !"") => uriStr
+  
+  /** @internal */     
+  index-is-name-substring(|name):
+    template -> <id>
+    with
+      [_, uri-name | _] := <index-uri>
+    where
+      <is-substring(!name)> uri-name
+   
+  /** @internal */    
+  index-readwildcard-substring(|prefix):
+    ReadWildcard(_, name) -> <id>
+    where <is-substring(!prefix)> name
+  
+  /** @internal */  
+  store-wildcard-read(|namespace, path, prefix):
+    children -> <id>
+    with
+      if set := <Index-ReadSet> then
+        if 1 := <length> children then
+          // HACK: This solves the problem of ReadWildcards making too many files re-analyze, but this should
+          // be handled in the index primitives instead.
+          <iset-add(|Read([namespace | path]))> set
+        else
+          <iset-add(|ReadWildcard([namespace | path], prefix))> set
+        end
+      end
+  
+  /** @internal */    
+  index-is-unresolved(|x, uri) = 
+    Index-UnresolvedSet; (iset-contains(|(x, uri)) <+ fail)
+  /** @internal */
+  index-add-unresolved(|x, uri) = 
+    (Index-UnresolvedSet; iset-add(|(x, uri))) <+ id
+  
+  /** @internal */
+  index-file-dependent-construct: 
+    uri -> <conc> (uses, reads)
+    with
+      uses := <index-get-uses-all> Def(uri);
+      reads := <index-get-reads-all> Def(uri)
+  
+  /** @internal */  
+  index-file-dependency-filter = 
+    ?Read(_) <+ ?ReadWildcard(_, _) <+ ?Use(_)
+ 
+  /** @internal */
+  do-adjust-index-lookup(|namespace, path, use, prefix) =
+    repeat-until(
+      prim("SSL_EXT_get_parent", <id>)
+    , adjust-index-lookup(origin-equal(|use) |namespace, path, prefix) 
+    )
+ 
+  /** @internal */
+  index-select(|namespace, path, use) =
+    getfirst(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  index-select-all(|namespace, path, use) =
+    filter(
+      where(
+        ?Def([_, <SRTS-EXT-eq-ignore-annos(|use)> | _])
+      )
+    )
+ 
+  /** @internal */
+  do-adjusted-index-path(|namespace, path, definition) =
+    adjust-index-path(origin-equal(|definition) |namespace, path)
+  <+
+    ![definition | path]
+ 
+  /** @internal */
+  index-eq(|namespace, expected) =
+    where(
+      ?Def([_, name | _]);
+      <SRTS-EXT-eq-ignore-annos(|expected)> name
+    )
+  
+  /** @internal */
+  external SRTS-EXT-eq-ignore-annos(|t)
+  
+  /** @internal */
+  index-key-unwrap = 
+    \key{uri} -> key{<index-uri-unwrap> uri}\ <+ id
+    
+/** @internal */
+rules // Interface for generated code
+ 
+  /** @internal */
+  nam-get-def(|namespace):
+    x -> Def([namespace, x | <IndexPath <+ ![]> namespace])
+ 
+  /** @internal */ 
+  nam-annotate-def(|uri):
+    t -> t{uri}
+  
+  /** @internal */ 
+  nam-annotate-use(|namespace):
+    t -> t{[Unresolved(namespace), t | <IndexPath <+ ![]> namespace]}
+  
+  /** @internal */ 
+  nam-get-scope-types = fail
+  /** @internal */
+  nam-get-definitions = nam-get-definition; MkSingleton
+  nam-get-definition = fail
+  /** @internal */
+  nam-get-definition-keys = nam-get-definition-key; MkSingleton
+  nam-get-definition-key = fail
+  /** @internal */
+  nam-annotate-names(|def-path) = fail
+
+

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/analysis-library.str	Thu May 31 02:31:53 2012	(r24877)
@@ -0,0 +1,593 @@
+module lib/analysis-library
+ 
+imports
+  libstratego-lib
+  libstratego-parallel
+  lib/editor-common.generated
+  lib/analysis-library-internal
+  lib/index-library
+ 
+signature constructors
+ 
+  // Analyze constructors
+  Editor      : AnalysisPhase
+  Compile     : AnalysisPhase
+ 
+  // Index elements
+  Def          : List(UriPart) -> Summary
+  Use          : List(UriPart) -> Summary
+  BadUse       : List(UriPart) -> Summary
+  Read         : List(UriPart) -> Summary
+  ReadWildcard : List(UriPart) * String -> Summary
+  Diff         : List(UriPart) * List(Summary) -> Summary
+  
+  // Adjust lookup actions
+  StopLookup   : LookupAction
+  
+rules // Index analysis extension points
+ 
+  /**
+   * Extension point. Override this rule to adjust how the index analysis looks up use sites to definitions.
+   *
+   * The overriden rule must return a list that contains any of the following items:
+   *   - Def(uri)         : A definition with exactly this URI has been found. This tells the lookup to resolve the
+   *                        use site to this definition.
+   *   - [namespace|path] : This tells the lookup to do a new lookup at the given namespace and path.
+   * 
+   * Returning multiple of these in the list is allowed, these will all show up during content completion and possibly
+   * other custom strategies. If multiple items are returned during reference resolving for example, the first item
+   * will be used.
+   *
+   * If the lookup has failed, for example your custom rule cannot find any definitions, you can also return 
+   * StopLookup() instead of a list. This tells the lookup algorithm to stop any further lookups for this use site.
+   * This can be useful to stop lookups for recursive expressions like property access, preventing a lot of useless
+   * lookups that will always fail anyway.
+   *
+   * Extension example:
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     PropAccess(exp, name) -> properties
+   *     where
+   *       <check-target-name> name
+   *     with
+   *       if TYPE(type{_}) := <type-of> exp then
+   *         properties := <index-lookup-children(|Property(), prefix)> type
+   *       else
+   *         properties := StopLookup()
+   *       end
+   *
+   *   adjust-index-lookup(check-target-name|namespace, path, prefix):
+   *     Var(name) -> [[Var() | path], [Property() | path]]
+   *     where
+   *       <check-target-name> name
+   *
+   * @param check-target-name   A strategy that should be used to check if the name of the current element is what the
+   *                            lookup algorithm is looking for.
+   * @param namespace           The namespace of the element that should be looked up.
+   * @param path                The path the lookup algorithm is currently looking at for the element.
+   * @param prefix              The prefix name of the element the lookup algorithm is looking for. This is usually the
+   *                            full name of the element, but could be a partial prefix during content completion.
+   * @type def -> List(Def(uri) or [namespace|path]) or StopLookup()
+   */
+  adjust-index-lookup(check-target-name|namespace, path, prefix) = fail
+  
+  /** 
+   * Extension point. Override this rule to store data about definitions in the index. Should call <store-results> on 
+   * a (list of) data that must be stored in the index.
+   *
+   * Note that store-results always fails, this is a trick to make every adjust-index-def-data override always fail so 
+   * that every overriden rule is called once for each definition. This can lead to unexpected behaviour when trying to 
+   * store multiple items by calling store-results in a map or filter! Be sure to always let your adjust-index-def-data 
+   * rule fail if you are doing a <filter(store-results)> for example.
+   *
+   * Extension example:
+   *   adjust-index-def-data(store-results|namespace, path):
+   *     def -> <store-results> Type([namespace|path], type)
+   *     where
+   *       type := <type-of> def
+   *
+   * @param store-results Call this on the data you want to store in the index.
+   * @param namespace     The namespace of the definition that the rule is being called on.
+   * @param path          The path of the definition that the rule is being called on.
+   * @type def -> fail 
+   */
+  adjust-index-def-data(store-results|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to adjust how the index assigns a namespace and path (URI) to definitions and
+   * use sites. Should return a path that will be assigned to the definition or use site.
+   *
+   * Extension example:
+   *   adjust-index-path(check-target-definition|namespace, path):
+   *     Start(_, _) -> [<string-replace(|<project-path>, "")> <Fst> <index-get-current-file>]
+   *
+   *
+   * @param check-target-definition 
+   * @param namespace               The namespace that would be given to the current definition or use site.
+   * @param path                    The path that would be given to the current definition or use site.
+   * @type def -> uri@[namespace|path]
+   */
+  adjust-index-path(check-target-definition|namespace, path) = fail
+  
+  /**
+   * Extension point. Override this rule to define index-stored constructors to check for difference during analysis.
+   * The index-diff-compare extension point is used to do the actual comparison. Defaults to Def constructs.
+   *
+   * Extension example:
+   *   index-diff-constructors = ?Type(_, _)
+   *
+   * @type a -> ?a
+   *
+   * @see index-diff-compare
+   */
+  index-diff-constructors = 
+    ?Def(_)
+  
+  /**
+   * Extension point. Override this rule to define a custom comparison of two index elements. It should fail if they 
+   * are not equal and return the indentity if they are equal. Only constructors defined by index-diff-constructors are
+   * compared.
+   *
+   * Extension example:
+   *   index-diff-compare:
+   *     (Type(u1, v1), Type(u2, v2)) -> <id>
+   *     where
+   *       <index-uri-eq> (u1, u2);
+   *       <eq> (v1, v2)
+   *
+   * @type (a, b) -> ?(a, b)
+   *
+   * @see index-diff-constructors
+   */
+  index-diff-compare:
+    (Def(u1), Def(u2)) -> <id>
+    where
+       <index-uri-eq> (u1, u2)
+ 
+rules // Analysis traversals
+  
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   * Defaults to Editor() phase.
+   *
+   * @param language  The name of the language that is being analysed.
+   *
+   * @type (ast, path, project-path) -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top(|phase, language)
+   */
+  analyze-top(|language):
+    (ast, path, project-path) -> <analyze-top(|Editor(), language, path, project-path)> ast
+   
+  /**
+   * Analyses given AST and annotates definition and use sites found in the AST with URIs.
+   *
+   * @param phase         The type of analysis phase. There are 2 phases to choose from:
+   *                      - Editor():   File dependencies are analysed.
+   *                      - Compile():  File dependencies are not analysed.
+   * @param language      The name of the language that is being analysed.
+   * @param path          The path of the file to analyze relative to project-path.
+   * @param project-path  The path of the directory that contains all the source files.
+   * @type ast -> (ast', List(fileToAnalyze@(file, subfile)))
+   *
+   * @see analyze-top-internal(|phase, language, project-path, full-path)
+   */
+  analyze-top(|phase, language, path, project-path):
+    ast -> (ast', filesToAnalyze)
+    with
+      full-path := $[[project-path]/[path]];
+      if index-split then
+        index-setup(|language, [project-path], full-path); // Set up the index, splitting may require index calls.
+        asts := <index-toplevel-split> ast;
+        astsFilePairs := <map(ast-uri-to-ast-file(|full-path))> asts;
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> astsFilePairs
+      else
+        Results(ast', _, _, _, _, _, filesToAnalyze) := 
+          <analyze-top-internal(|phase, language, project-path, full-path)> [(ast, full-path)]
+      end
+  
+rules // Parallel analysis
+  
+  /**
+   * Does a parallel analysis of given files using the specified analysis strategy. Automatically does parallel
+   * analysis of dependent files that have changed during the analysis.
+   *
+   * Example:
+   *   <index-parallel-analyze-files(analyze)> ["text/file1.ext", "text/file2.ext"]
+   *
+   * @param analyze (ast, path, project-path) -> (ast', errors, warnings, notes, filesToAnalyze). Strategy that 
+   *                analyzes a file using the index. Gets a (ast, path, project-path) tuple as input and must return 
+   *                a (ast', errors, warnings, notes, filesToAnalyze) tuple as output.
+   * @type List((file, subfile) or file) -> None()
+   */
+  index-parallel-analyze-files(analyze):
+    files -> None()
+    with
+      length; 
+      set-total-work-units
+    with
+      index-parallel-analyze(analyze);
+      filter(not(?ParallelResults((), (), _, _, _, _) <+ ?ParallelResults((), [()], _, _, _, _)); index-set-markers)
+ 
+rules // Query primitives
+ 
+  /**
+   * Gets all DefData entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data(|Type())> Def([Entity(), "Bar"]) => [DefData([Entity(), "Bar"], Type(), TYPE("Bar")), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(DefData(uri, kind, value))
+   */
+  index-get-data(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-value> DefData(uri, kind, ())
+      
+  /**
+   * Gets all data entries that match the kind of data and URI in given definition.
+   *
+   * Example:
+   *   <index-get-data-all(|Type())> Def([Entity(), "Bar"]) => [TYPE("Bar"), ...]
+   *
+   * @param kind Only data of this kind is returned.
+   * @type Def(uri) -> List(value)
+   */
+  index-get-data-all(|kind):
+    <with(?Def(uri) | "Def expected")> -> <index-get-all-values> DefData(uri, kind, ())
+     
+  /**
+   * Gets all Use entries that match the URI in given definition.
+   *
+   * Example:
+   *   <index-get-uses-all> Def([Entity(), "M", "Bar"]) => [Use([Entity(), "M", "Bar"]), ...]
+   *
+   * @type Def(uri) -> List(Use(uri))
+   */
+  index-get-uses-all:
+    <with(?Def(uri) | "Def expected")> -> <index-get-all> Use(uri)
+     
+  /**
+   * Gets all Read or ReadWildcard entries that match the given template.
+   *
+   * Example:
+   *   <index-get-reads-all> [Property(), "Bar", "p"] => [Read([Property(), "Bar", "p"]), ...]
+   *
+   * @type Def(uri) -> List(Read(uri) or ReadWildcard(uri, prefix))
+   */
+  index-get-reads-all:
+    template -> <conc> (reads, readwildcards')
+    where
+      uri   := <index-uri> template;
+      reads := <index-get-all> Read(uri);
+      if !uri => [namespace, prefix | path-parent] then
+        readwildcards  := <index-get-all> ReadWildcard([namespace | path-parent], ());
+        readwildcards' := <filter(index-readwildcard-substring(|prefix))> readwildcards
+      else
+        readwildcards' := []
+      end
+ 
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  index-get-all:
+    template -> <indexlib-get-all> template
+      with
+       if set := <Index-ReadSet> then
+         uri := <index-uri>;
+         <iset-add(|Read(uri))> set
+       end
+       
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <index-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  index-get-all-values:
+    template -> <map(index-value)> <index-get-all> template
+       
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
+   */
+  index-get:
+    template -> <?[<id>|_]> <index-get-all> template
+      
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <index-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  index-get-value:
+    template -> <index-value> <?[<id>|_]> <index-get-all> template
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field())> Def([Entity(), "Baz"]) => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field())> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field())> [Entity(), "Baz"] => [Def([Field(), "Bar"]), Def([Field(), "Foo"]), ...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace) = 
+    index-get-children(\uri -> Def(uri)\|namespace)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children
+    with
+      template  := <construct-template> [namespace | path];
+      children  := <prim("LANG_index_get_children", template)>;
+      <store-wildcard-read(|namespace, path, "")> children
+
+  /**
+   * Gets all Def children elements of an URI in a certain namespace where the name starts with a prefix.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * Example:
+   *   <index-get-children(|Field(), "fo")> Def([Entity(), "Baz"]) => [Def([Field(), "Foo"]), ...]
+   *   <index-get-children(|Field(), "ba")> "Foo"{[Entity(), "Baz"]} => [Def([Field(), "Bar"]), ...]
+   *   <index-get-children(|Field(), "ze")> [Entity(), "Baz"] => [...]
+   *
+   * @param namespace Only child Def elements in this namespace are returned.
+   * @param prefix    Only child Def elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(|namespace, prefix) = 
+    index-get-children(\uri -> Def(uri)\|namespace, prefix)
+  
+  /**
+   * Gets all children elements of an URI in a certain namespace where the name starts with a prefix
+   * using custom templates.
+   * URI can be contained in a Def(uri), key (term{uri} element) or the uri itself.
+   *
+   * @param construct-template  uri -> template. Should create a template to match index entries with, given an URI.
+   * @param namespace           Only child elements in this namespace are returned.
+   * @param prefix              Only child elements where the name starts with this prefix are returned.
+   * @type Def(uri) or "name"{uri} or uri@[namespace|path] -> List(Def(uri))
+   */
+  index-get-children(construct-template|namespace, prefix):
+    <with(?Def([parent-ns | path]) <+ ?_{[parent-ns | path]} <+ ?[parent-ns | path] | "Def, key or uri expected")> -> children'
+    with
+      prefix'   := <strip-annos> prefix;
+      template  := <construct-template> [namespace | path];
+      children  := <prim("LANG_index_get_children", template)>;
+      children' := <filter(index-is-name-substring(|prefix'))> children;
+      <store-wildcard-read(|namespace, path, prefix')> children'
+
+  /**
+   * Gets a set of all files that have a reference to the given index entries.
+   *
+   * Example:
+   *   <index-get-referenced-files(\uri -> [Read(uri), Use(uri, [])]\)> [Def([Entity(), "Bar"]), ...] => 
+   *     [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @param construct-from-uri  uri -> List(elements). Construction strategy that creates a list of reference 
+   *                            constructs from all given entries, such as \uri -> [Read(uri), Use(uri, [])]\
+   * @type List(elem) -> List((file, subfile))
+   */
+  index-get-referenced-files(construct-from-uri):
+    entries -> files
+    where
+      uris        := <filter(index-uri)> entries;
+      referenced  := <concat> <filter(construct-from-uri)> uris;
+      files       := <iset-elements> <iset-addlist(|<mapconcat(index-get-files-of)> referenced)> <new-iset>
+ 
+  /**
+   * Convenience function for finding files with Read and Use dependencies to the given definitions.
+   *
+   * Example:
+   *   <index-get-dependent-files> [Def([Entity(), "Bar"]), ...] => [("fullpath/otherfile.ext", "subfile"), ...]
+   *
+   * @type List(elem) -> List((file, subfile))
+   *
+   * @see index-get-referenced-files(construct-from-uri)
+   * @see index-file-dependent-construct
+   */
+  index-get-dependent-files = 
+    index-get-referenced-files(index-file-dependent-construct)
+     
+rules // Index lookup rules (that take into account adjust-index-lookup)
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning its Def.
+   *
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup:
+    x{[namespace|path]} -> <index-lookup(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, returning all its Defs.
+   * 
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all:
+    x{[namespace|path]} -> <index-lookup-all(id|<index-namespace-unwrap> namespace, path, <strip-annos> x)>
+ 
+  /**
+   * Given an annotated AST node, returns the outermost Def with a corresponding URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> ?Def(uri')
+   */
+  index-lookup-outermost(|prefix):
+    x{[namespace|path]} -> <index-lookup-outermost(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, returns Defs that have the same parent URI.
+   *
+   * @param prefix  Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-one-level(|prefix):
+    x{[namespace|path]} -> <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      
+  /**
+   * Given an annotated AST node, resolves it, and returns all possibly matching Defs with a common ancestor URI. 
+   *
+   * @param namespace Only Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-all-levels(|prefix):
+    x{[namespace|path]} -> <index-lookup-all-levels(id|<index-namespace-unwrap> namespace, path, prefix)>
+ 
+  /**
+   * Given an annotated AST node, resolves it, and returns all child Defs of its definition.
+   *
+   * @param namespace Only child Defs with this namespace are returned.
+   * @param prefix    Only Defs with a name that starts with this string are returned.
+   * @type "name"{uri} -> List(Def(uri'))
+   */
+  index-lookup-children(|namespace, prefix): // TODO: how does this compare w/ index-lookup-one-level?
+    x{[ns | path]} -> defs
+    with
+      if !ns => Unresolved(_) then
+        Def([_ | def-path]) := <index-lookup>;
+        defs := <index-lookup-one-level(id|namespace, def-path, prefix)> x
+      else
+        defs := <index-lookup-one-level(id|<index-namespace-unwrap> namespace, path, prefix)>
+      end
+    <+
+      defs := []
+      
+rules // Index utilities
+  
+  /**
+   * Gets the namespace part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-namespace> "Bar"{[Entity(), "Bar", "Baz"]} => Entity()
+   *
+   * @type "name"{uri@[namespace|path]} -> namespace
+   */
+  index-uri-namespace:
+    x{[namespace|path]} -> <index-namespace-unwrap> namespace
+
+  /**
+   * Gets the path part of the URI for given key (term{uri} element). Resolves it if unresolved.
+   *
+   * Example:
+   *   <index-uri-path> "Bar"{[Entity(), "Bar", "Baz"]} => ["Bar", "Baz"]
+   *
+   * @type "name"{uri@[namespace|path]} -> path'
+   */
+  index-uri-path:
+    x{[namespace|path]} -> path'
+    where
+      if !namespace => Unresolved(namespace) then
+        Def(path') := <index-lookup>
+      else
+        path' := path
+      end
+      
+  /**
+   * Gets the name part of the URI for given key (term{uri} element).
+   *
+   * Example:
+   *   <index-uri-name> "Bar"{[Entity(), "Bar", "Baz"] => "Bar"
+   *
+   * @type "name"{uri@[namespace|[name|restPath]]} -> name
+   */ 
+  index-uri-name:
+    x{[_|[name|_]]} -> name
+    
+   /**
+   * Tries to get the namespace part of the URI for given term or fail if given term does not have an URI.
+   *
+   * Example:
+   *   <index-uri-namespace> Def([Entity(), "Bar", "Baz"]) => Entity()
+   *   <index-uri-namespace> Type("Foo") => fail
+   *   <index-uri-namespace> Read([Entity()]) => Entity()
+   *
+   * @type x -> name
+   */   
+  index-uri-namespace:
+    x -> <index-uri-namespace> <index-uri> x
+    where
+      not(<has-annos> x)
+ 
+  /**
+   * Tries to get the name part of the URI for given term or fail if given term does not have an URI or name.
+   *
+   * Example:
+   *   <index-uri-name> Def([Entity(), "Bar", "Baz"]) => "Bar"
+   *   <index-uri-name> Type("Foo") => fail
+   *   <index-uri-name> Read([Entity()]) => fail
+   *
+   * @type x -> name
+   */   
+  index-uri-name:
+    x -> <index-uri-name> <index-uri> x
+    where
+      not(<has-annos> x)
+      
+   /**
+   * Tries to get the path part of the URI for given term or fail if given term does not have an URI or path.
+   *
+   * Example:
+   *   <index-uri-path> Def([Entity(), "Bar", "Baz"]) => ["Bar", "Baz"]
+   *   <index-uri-path> Type("Foo") => fail
+   *   <index-uri-path> Read([Entity()]) => fail
+   *
+   * @type x -> name
+   */   
+  index-uri-path:
+    x -> <index-uri-path> <index-uri> x
+    where
+      not(<has-annos> x)
+  /**
+   * Determines if a given AST node is a definition site, according to the syntax.
+   *
+   * FIXME: Also succeeds on use sites.
+   *
+   * @type def -> ?def
+   */
+  index-is-definition =
+    where(nam-get-definition-keys ; Hd)
+    
+  /**
+   * Checks if given keys (term{uri} elements) are equal. Discards unresolved URI's.
+   *
+   * Example:
+   *   <index-key-eq> ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]}) => 
+   *     ("Bar"{[Entity(), "Bar"]}, "Bar"{[Unresolved(Entity()), "Bar"]})
+   *   <index-key-eq> ("Foo"{[Entity(), "Foo"]}, "Bar"{[Entity(), "Bar"]}) => fail
+   *
+   * @type (k1, k2) -> ?(k1, k2)
+   */      
+  index-key-eq:
+    (k1, k2) -> <id>
+    where
+      <eq> (<index-key-unwrap> k1, <index-key-unwrap> k2)
+      
\ No newline at end of file

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/compilation-library.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/compilation-library.str	Thu May 31 02:31:53 2012	(r24877)
@@ -0,0 +1,186 @@
+module lib/compilation-library
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  lib/index-library
+  lib/analysis-library
+  
+rules // Extension points
+  
+  /**
+   * Extension point. Override this rule to define a desugaring that is applied to AST before analyzing and compiling.
+   *
+   * Extension example:
+   *   index-desugar-ast:
+   *     ast -> <desugar> ast
+   *
+   * @type ast -> ast'
+   */
+  index-desugar-ast = fail
+    
+  /**
+   * Extension point. Override this rule to define a compilation or transformation to some other target language. The
+   * index manages which files have to be compiled and calls this rule for each AST that has changed since the last
+   * compilation.
+   *
+   * Extensions example:
+   *   index-compile-ast(|file, subfile):
+   *     ast -> None()
+   *     with
+   *       java := <to-java> ast;
+   *       full-path := <dirname> file;
+   *       filename := <guarantee-extension(|"java")> <base-filename> file;
+   *       writePath := $[[full-path]/java/];
+   *       writeFile :=  $[[writePath][filename]];
+   *       try(<mkdir> writePath);
+   *       <fclose> <fputs> (java, <fopen> (writeFile, "w"))
+   *
+   * @param file    The file that must be compiled.
+   * @param subfile The subfile that must be compiled ("" if there is no subfile).
+   * @type ast -> None()
+   */
+  index-compile-ast(|file, subfile) = fail
+  
+rules // Compilation
+  
+  /**
+   * Schedules compilation in the background of all files that have changed since the last compilation.
+   *
+   * @type x -> x
+   */
+  index-schedule-compilation:
+    _ -> None()
+    with
+      queue-strategy(|"index-compilation", "Compiling files")
+  
+  /** @internal */
+  index-compilation:
+    language -> None()
+    with
+      // Init
+      project-path := <project-path>;
+      index-setup(|language, [project-path], ".")
+    with
+      // Determine the files to compile by looking at changed files
+      diffs         := <analyze-get-compilediffs>;
+      files         := <map(index-compilation-restore-read-file)> diffs;
+      filteredFiles := <make-set> <remove-all(index-compilation-filter-file)> files;
+      
+      // Clean compile time reads
+      <filter(index-compilation-clean-reads)> filteredFiles;
+      
+      // Set total work units to number of files to compile for visual indication
+      <set-total-work-units> <length> filteredFiles;
+      
+      // Compile the files
+      <filter(index-compilation-file(|language, project-path); complete-work-unit)> filteredFiles
+
+  /** @internal */
+  index-compilation-file(|language, project-path):
+    (path, subfile) -> None()
+    with
+      // Parse and analyze ast.
+      ast                              := <parse-file> path;
+      ast'                             := <try(index-desugar-ast)> ast;
+      Results(ast'', _, _, _, _, _, _) := <analyze-top-internal(|Compile(), language, project-path, path)> [(ast', (path, subfile))]
+    with
+      {| Index-ReadSet:
+        readSet := <new-iset>;
+        rules(Index-ReadSet: _ -> readSet);
+        
+        // Compile file
+        <index-compile-ast(|path, subfile)> ast'';
+        
+        // Store compile-time reads.
+        reads := <iset-elements> readSet;
+        <index-add-all(|<index-compilation-file-tuple> (path, subfile))> reads
+      |}
+
+  /** @internal */
+  index-compilation-filter-file:
+    (file, subfile) -> (file, subfile)
+    where
+      <is-test-file <+ index-is-fake-file <+ not(file-exists)> file
+    
+rules // On save handling
+  
+  /**
+   * Commits the index to disk and schedules compilation. Use trigger-commit-and-compile instead of this strategy.
+   *
+   * @see trigger-commit-and-compile
+   *
+   * @internal
+   */
+  commit-and-compile:
+    language -> None()
+    with
+      index-commit
+    with
+      index-schedule-compilation
+
+  /**
+   * Triggers commit and compilation, requires target language as current term.
+   * Compilation can be delayed by using disable-commit-and-compile. Compilation will be triggered when 
+   * enable-commit-and-compile is called.
+   *
+   * @type language -> ?language
+   *
+   * @see enable-commit-and-compile
+   * @see disable-commit-and-compile
+   */
+  trigger-commit-and-compile:
+    language -> <id>
+    with
+      if not(index-is-global-enabled(|"delay-compile")) then
+        commit-and-compile
+      else
+        index-enable-global(|"trigger-compile")
+      end
+  
+  /**
+   * Delays commit and compilation until enable-commit-and-compile is called.
+   *
+   * @type x -> x
+   *
+   * @see enable-commit-and-compile
+   */
+  disable-commit-and-compile = 
+    index-enable-global(|"delay-compile")
+  
+  /**
+   * Cancels the commit and compilation delay. If commit and compilation was triggered during the delay, it
+   * is triggered now.
+   *
+   * @type x -> x
+   *
+   * @see disable-commit-and-compile
+   */
+  enable-commit-and-compile:
+    language -> <id>
+    with
+      if index-is-global-enabled(|"trigger-compile") then
+        commit-and-compile
+      end;
+      index-disable-global(|"delay-compile")
+      
+/** @internal */
+rules // Compile time reads
+
+  /** @internal */
+  index-compilation-restore-read-file:
+    (file, subfile) -> (file', subfile)
+    with
+      file' := <string-replace(|<index-compilation-read-path>, "")> file
+      
+  /** @internal */
+  index-compilation-clean-reads = 
+    ?(file, subfile); index-compilation-file-tuple; index-clear-file
+      
+  /** @internal */
+  index-compilation-file-tuple:
+    (file, subfile) -> ($[[<index-compilation-read-path>]/[file]], subfile)
+    
+  /** @internal */
+  index-compilation-read-path =
+    !"/.internal/reads/compile"

Added: spoofax-imp/trunk/org.strategoxt.imp.names/lib/index-library.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/lib/index-library.str	Thu May 31 02:31:53 2012	(r24877)
@@ -0,0 +1,655 @@
+module lib/index-library
+
+imports
+  libstratego-lib
+  lib/editor-common.generated
+  
+signature constructors
+  
+  // Index elements
+  DefData      : List(UriPart) * DefDataType * Term -> Summary
+    
+  // URI header
+  Namespace      : UriPart
+  Unresolved     : Namespace -> UriPart
+  INTERNAL_ERROR : UriPart
+  Timestamp      : UriPart
+ 
+  // Remainder of URI
+  String : UriPart
+  Anon   : Int -> UriPart
+  Anon   : UriPart
+  
+  FileEntries : Term * Term -> Term
+  
+  // Globals
+  Global : Namespace
+  Global : List(UriPart) -> Summary
+  Global : List(UriPart) * List(Summary) -> Summary
+  
+rules // Index management
+   
+  /**
+   * Sets up the index library for given language and project paths.
+   * Must be called once before doing anything with the library.
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   *
+   * @obsolete
+   * @type x -> x
+   */
+  index-setup(|language, project-paths) =
+    obsolete(!"index-setup(|language, project-paths); use index-setup(|language, project-paths, current-file)");
+    index-setup(|language, project-paths, ".")
+    
+  /**
+   * Sets up the index library for given language, project paths and current file.
+   * Must be called once before doing anything with the library.
+   *
+   * Example:
+   *   <index-setup(|"MiniJava", [<project-path>], "test/test.mjv")
+   *
+   * @param language      The language to set the index up for.
+   * @param project-path  The project paths that contain all source files to analyse and compile.
+   * @param current-file  The current file that is being analysed. Can be retrieved later using index-get-current-file.
+   *                      Can also be changed later using index-set-current-file.
+   * @type x -> x
+   */
+  index-setup(|language, project-paths, current-file) =
+    prim("LANG_index_setup", language, project-paths, current-file)
+    
+  /**
+   * Sets the current file the index (analysis) is operating on to the given file.
+   *
+   * Example:
+   *   <index-set-current-file> "fullpath/file.ext"
+   *   <index-set-current-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
+   */
+  index-set-current-file = 
+    prim("LANG_index_set_current_file", <id>)
+
+  /**
+   * Adds given element to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add(|"fullpath/file.ext")> Def([Entity(), "Bar"])
+   *   <index-add(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   *
+   * @param file  The file (and subfile) to add the element to.
+   * @type x -> ?x
+   */
+  index-add(|file) =
+    prim("LANG_index_add", <id>, file)
+
+  /**
+   * Adds all given elements to the index with given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-add-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-add-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to add the elements to.
+   * @type List(x) -> ?List(x)
+   */
+  index-add-all(|file) =
+    list-loop(with(index-add(|file)))
+    
+  /**
+   * Removes given element from the index that is contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove(|"fullpath/file.ext")> Def([Entity(), "Bar"])
+   *   <index-remove(|("fullpath/file.ext", "subfile"))> Def([Entity(), "Bar"])
+   * 
+   * @param file  The file (and subfile) to remove the element from.
+   * @type x -> ?x
+   */
+  index-remove(|file) =
+    prim("LANG_index_remove", <id>, file)
+    
+  /**
+   * Removes all given elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-remove-all(|"fullpath/file.ext")> [Def([Entity(), "Bar"]), ...]
+   *   <index-remove-all(|("fullpath/file.ext", "subfile"))> [Def([Entity(), "Bar"]), ...]
+   *
+   * @param file  The file (and subfile) to remove the elements from.
+   * @type List(x) -> ?List(x)
+   */
+  index-remove-all(|file) =
+    list-loop(with(index-remove(|file)))
+    
+  /**
+   * Removes all elements from the index that are contained in given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-clear-file> "fullpath/file.ext"
+   *   <index-clear-file> ("fullpath/file.ext", "subfile")
+   *
+   * @type x -> ?x
+   */
+  index-clear-file = 
+    prim("LANG_index_clear_file", <id>)
+    
+  /**
+   * Clears all elements from the index.
+   *
+   * @type x -> x
+   */
+  index-clear = 
+    prim("LANG_index_clear_all")
+   
+  /**
+   * Commits index to a file on disk.
+   *
+   * @type x -> x
+   */
+  index-commit = 
+    prim("LANG_index_commit")
+
+  /**
+   * Starts a transaction on the index for the current file. Additions to the index are not visible to other files 
+   * until index-end-transaction is called. Operations on the index are only thread safe during a transaction.
+   *
+   * @type x -> x
+   */
+  index-start-transaction = 
+    prim("LANG_index_start_transaction")
+  
+  /**
+   * Ends a transaction on the index for the current file. Additions made to the index during the transaction are
+   * added to the global index visible for other files. Operations on the index are not thread safe any more after 
+   * this call.
+   *
+   * @type x -> x
+   */
+  index-end-transaction = 
+    prim("LANG_index_end_transaction")
+  
+  /**
+   * Starts a transaction, applies given strategy and ends the transaction. All index operations used from the given
+   * strategy are thread safe.
+   * 
+   * @param s The strategy to apply.
+   * @type x -> x'
+   *
+   * @see index-start-transaction
+   * @see index-end-transaction
+   */
+  index-transaction(s) = 
+    prim("LANG_index_start_transaction"); s; prim("LANG_index_end_transaction")
+  
+rules // Index querying
+  
+  /**
+   * Gets the file that the analysis is currently in.
+   *
+   * @type x -> (file, subfile)
+   *
+   * @see index-setup(|language, project-paths, current-file)
+   * @see index-set-current-file
+   */
+  index-get-current-file =
+    prim("LANG_index_get_current_file")
+  
+  /**
+   * Gets a list of all files and subfiles for current project.
+   *
+   * Example:
+   *   <index-get-all-files> => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type x -> List((file, subfile))
+   */   
+  index-get-all-files =
+    prim("LANG_index_all_files")
+  
+  /**
+   * Gets all index entries for the given file path and optionally subfile.
+   *
+   * Examples:
+   *   <index-get-all-in-file> "fullpath/file.ext" => [Def([Entity(), "Bar"]), ...]
+   *   <index-get-all-in-file> ("fullpath/file.ext", "subfile") => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type file or (file, subfile) -> List(elem)
+   */  
+  index-get-all-in-file:
+    filepath -> entries
+    with
+      entries := <prim("LANG_index_get_all_in_file", filepath)>
+   
+  /**
+   * Gets index entries in some namespace for the given file path and optionally subfile.
+   *
+   * Example:
+   *   <index-get-all-in-file(|Import())> "fullpath/file.ext" => [Def([Import(), "Bar"]), ...]
+   *   <index-get-all-in-file(|Import())> ("fullpath/file.ext", "subfile") => [Def([Import(), "Bar"]), ...]
+   *
+   * @param namespace Only index entries from this namespace are retrieved.
+   * @type file or (file, subfile) -> List(elem)
+   */  
+  index-get-all-in-file(|namespace):
+    filepath -> entries
+    with
+      // TODO: Optimize -- add an argument to LANG_index_get_all_in_file to do this filtering
+      entries := <prim("LANG_index_get_all_in_file", filepath)>;
+      filter(where(index-uri => [namespace | _]))
+    
+  /**
+   * Gets the revision of a file and optionally subfile.
+   *
+   * Example:
+   *   <index-get-file-revision> "fullpath/file.ext" => 13
+   *   <index-get-file-revision> ("fullpath/file.ext", "subfile") => 37
+   *
+   * @type file or (file, subfile) -> Int
+   */
+  index-get-file-revision:
+    file -> <prim("LANG_index_get_file_revision", file)>
+    
+  /**
+   * Gets the containing files and subfiles of index entry with given template.
+   *
+   * Example:
+   *   <index-get-files-of> Def([Entity(), "Bar"]) => [("fullpath/file.ext", "subfile"), ...]
+   *
+   * @type template -> List((file, subfile))
+   */  
+  index-get-files-of:
+    template -> <prim("LANG_index_get_files_of", template)>
+    
+  /**
+   * Get all index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all> Def([Entity(), "Bar"]) => [Def([Entity(), "Bar"]), ...]
+   *
+   * @type template -> List(elem)
+   */
+  indexlib-get-all:
+    template -> <prim("LANG_index_get", template)>
+    
+  /**
+   * Get all values of index entries that match the given template.
+   *
+   * Example:
+   *   <indexlib-get-all-values> DefData([Property(), "s"], Type(), ()) => [TYPE("String"), ...]
+   *
+   * @type template -> List(value)
+   *
+   * @see index-value
+   */
+  indexlib-get-all-values:
+    template -> <map(index-value)> <indexlib-get-all> template
+ 
+  /**
+   * Get the first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get> Def([Entity(), "Bar"]) => Def([Entity(), "Bar"])
+   *
+   * @type template -> ?elem
+   */
+  indexlib-get:
+    template -> <?[<id>|_]> <indexlib-get-all> template
+   
+  /**
+   * Get the value of first index entry that matches the given template, or fail.
+   *
+   * Example:
+   *   <indexlib-get-value> DefData([Entity(), "Bar"], Type(), ()) => TYPE("Bar")
+   *
+   * @type template -> ?value
+   *
+   * @see index-value
+   */
+  indexlib-get-value:
+    template -> <index-value> <?[<id>|_]> <indexlib-get-all> template
+    
+rules // Index globals
+    
+  /**
+   * Gets the 'fake' path where globals are stored in the index.
+   *
+   * @internal
+   */
+  index-globals-path = 
+    !"/.internal/globals"
+    
+  /**
+   * Gets the URI where globals are stored in the index for given name or names.
+   *
+   * @internal
+   * @type name or List(name) -> uri
+   */
+  index-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["globals", ".internal"]]
+      else
+        uri := [Global(), names, "global", ".internal"]
+      end
+    
+  /**
+   * Gets the first value in global storage with given name, or fail.
+   *
+   * Example:
+   *   index-get-global(|"last-compile") => Timestamp(1334322856)
+   *   index-get-global(|["last-compile", "file.str"]) => Timestamp(1334322856)
+   * 
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> ?value
+   */
+  index-get-global(|name):
+    _ -> value
+    where
+      value := <indexlib-get-value> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Gets all values in global storage with given name.
+   *
+   * Example:
+   *   index-get-global(|"last-compile") => [Timestamp(1334322856), ...]
+   *   index-get-global(|["last-compile", "file.str"]) => [Timestamp(1334322856), ...]
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type _ -> List(value)
+   */ 
+  index-get-all-globals(|name):
+    _ -> values
+    with
+      values := <indexlib-get-all-values> Global(<index-globals-uri> name, ())
+    
+  /**
+   * Add value to global storage with given name.
+   *
+   * Example:
+   *   <index-add-global(|"last-compile")> Timestamp(1334322856)
+   *   <index-add-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-add-global(|name):
+    value -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-globals-uri> name, value)
+      
+  /**
+   * Overwrites value in global storage with given value.
+   *
+   * Example:
+   *   <index-set-global(|"last-compile")> Timestamp(1334322856)
+   *   <index-set-global(|["last-compile", "file.str"])> Timestamp(1334322856)
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-set-global(|name):
+    value -> <id>
+    with
+      index-clear-global(|name);
+      <index-add-global(|name)> value
+    
+  /**
+   * Removes all values from global storage with given name.
+   *
+   * Example:
+   *   index-clear-global(|"last-compile")
+   *   index-clear-global(|["last-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global value.
+   * @type x -> x
+   */   
+  index-clear-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-globals-uri> name, ())
+      
+  /**
+   * Gets the URI where boolean globals are stored in the index for given name or names.
+   *
+   * @internal
+   */
+  index-boolean-globals-uri:
+    names -> uri
+    with
+      if is-list then
+        uri := <concat> [[Global()], names, ["boolean", "globals", ".internal"]]
+      else
+        uri := [Global(), names, "boolean", "global", ".internal"]
+      end
+      
+  /**
+   * Sets boolean value true to global boolean storage with given name.
+   *
+   * Example:
+   *   index-enable-global(|"can-compile")
+   *   index-enable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-enable-global(|name):
+    _ -> <id>
+    with
+      <index-add(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Sets boolean value false to global boolean storage with given name.
+   *
+   * Example:
+   *   index-disable-global(|"can-compile")
+   *   index-disable-global(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> x
+   */   
+  index-disable-global(|name):
+    _ -> <id>
+    with
+      <index-remove(|<index-globals-path>)> Global(<index-boolean-globals-uri> name)
+      
+  /**
+   * Query for boolean value true in global boolean storage with given name.
+   *
+   * Example:
+   *   index-is-global-enabled(|"can-compile")
+   *   index-is-global-enabled(|["can-compile", "file.str"])
+   *
+   * @param name  The name or list of names to identify the global boolean value.
+   * @type x -> ?x
+   */   
+  index-is-global-enabled(|name):
+    _ -> <id>
+    where
+      <indexlib-get> Global(<index-boolean-globals-uri> name)
+
+rules // Index utility
+  
+  /**
+   * Gets the URI part for given term. Can be extended by defining a index-uri-impl rule. If no index-uri-impl rule
+   * is defined for the given term the first subterm is used as the URI. Fails if no URI can be retrieved from the
+   * given term.
+   *
+   * Example:
+   *   <index-uri> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => [Entity(), "Bar", "Baz"]
+   *
+   * @type elem -> ?uri
+   *
+   * @see index-uri-impl
+   * @see index-uri-generic
+   */ 
+  index-uri = 
+    index-uri-impl <+ index-uri-generic
+  
+  /**
+   * Gets the namespace part of the given URI.
+   *
+   * Example:
+   *   <index-uri-namespace> [Entity(), "Bar", "Baz"] => Entity()
+   *
+   * @type uri@[namespace|path] -> namespace
+   */ 
+  index-uri-namespace =
+    ?[<id>|_]
+  
+  /**
+   * Gets the path part of the given URI.
+   *
+   * Example:
+   *   <index-uri-path> [Entity(), "Bar", "Baz"] => ["Bar", "Baz"]
+   *   <index-uri-path> [Entity()] => []
+   *
+   * @type uri@[namespace|path] -> path
+   */ 
+  index-uri-path =
+    ?[_|<id>]
+    
+  /**
+   * Gets the name part of the given URI or fail if there is no name.
+   *
+   * Example:
+   *   <index-uri-name> [Entity(), "Bar", "Baz"] => "Bar"
+   *   <index-uri-name> [Entity()] => fail
+   *
+   * @type uri@[namespace|[name|restPath]] -> ?name
+   */ 
+  index-uri-name =
+    ?[_|[<id>|_]]
+  
+  /**
+   * Gets the value part for given term. Can be extended by defining a index-value-impl rule. If no index-value-impl 
+   * rule is defined for the given term the second subterm is used as the value. Fails if no value can be retrieved
+   * from the given term.
+   *
+   * Example:
+   *   <index-value> DefData([Entity(), "Bar", "Baz"], Type(), TYPE("Bar")) => TYPE("Bar")
+   *
+   * @type elem -> ?value
+   *
+   * @see index-value-impl
+   * @see index-value-generic
+   */  
+  index-value = 
+    index-value-impl <+ index-value-generic
+  
+  /**
+   * Queries if given index file is a 'fake' file for storing internal data.
+   *
+   * @type x -> ?x
+   */
+  index-is-fake-file = 
+    string-starts-with(|"/.internal")
+  
+  /**
+   * Checks if given URI's are equal. Discards anonymous scopes if necessary.
+   *
+   * Example:
+   *   <index-uri-eq> ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"]) => 
+   *     ([Entity(), Anon("a"), "Bar"], [Entity(), Anon("b"), "Bar"])
+   *   <index-uri-eq> ([Entity(), "Foo"], [Entity(), "Bar"]) => fail
+   *
+   * @type (u1, u2) -> ?(u1, u2)
+   */
+  index-uri-eq:
+    (u1, u2) -> <id>
+    where
+      u1' := <index-uri-unwrap> u1;
+      u2' := <index-uri-unwrap> u2;
+      (<eq> (u1', u2') <+ <eq> (<remove-all(?Anon(_))> u1', <remove-all(?Anon(_))> u2'))
+  
+  /**
+   * Finds the first key (term{uri} element) for given term, or fail. 
+   *
+   * @type x -> ?name{uri}
+   */
+  index-find-key:
+    x -> key
+    where
+      key := <collect-one(?_{_})> x
+      
+  /**
+   * Converts a URI to a string.
+   *
+   * Example:
+   *   <index-uri-to-string> [Entity(), "Bar", "Baz"] => "Entity://Bar.Baz"
+   *
+   * @type uri -> str
+   */
+  index-uri-to-string:
+    [ns|path] -> <concat-strings> [nsStr, "://", pathStr]
+    with
+      pathStr := <take-until(?Anon(_)); reverse; separate-by(|"."); concat-strings> path;
+      nsStr := <?<id>#(_)> ns
+  
+  /**
+   * Converts a file to a string.
+   *
+   * Example:
+   *   <index-file-to-string> "fullpath/file.ext" => "fullpath/file.ext"
+   *
+   * @type file -> file
+   */
+  index-file-to-string:
+    file -> file
+    where
+      not(<is-tuple> file)
+  
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", "") => "fullpath/file.ext"
+   *
+   * @type (file, "") -> file
+   */
+  index-file-to-string:
+    (file, "") -> file
+    
+  /**
+   * Converts a file ((file, subfile) tuple) to a string.
+   *
+   * Example:
+   *   <index-file-to-string> ("fullpath/file.ext", "subfile") => "fullpath/file.ext at subfile"
+   *
+   * @type (file, subfile) -> str
+   */
+  index-file-to-string:
+    (file, subfile) -> <concat-strings> [file, "@", subfile]
+    where
+      not("" := subfile)
+      
+/** @internal */
+rules // URI and value projections
+  
+  /** @internal */
+  index-uri-impl:
+    DefData(uri, _, _) -> uri
+
+  /** @internal */
+  index-uri-generic:
+    term -> <?_#(<?[<id>|_]>)> term
+  
+  /** @internal */
+  index-value-impl:
+    DefData(_, _, value) -> value
+    
+  /** @internal */
+  index-value-generic:
+    term -> <?_#(<?[_, <id>|_]> )> term
+     
+/** @internal */ 
+rules // Internal helpers
+  
+  /** @internal */
+  index-namespace-unwrap =
+    \Unresolved(n) -> n\ <+ id
+    
+  /** @internal */
+  index-uri-unwrap =
+    \[ns|xs] -> [<index-namespace-unwrap> ns|xs]\ <+ id
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Thu May 31 01:33:34 2012	(r24876)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.generated.pp	Thu May 31 02:31:53 2012	(r24877)
@@ -25,7 +25,8 @@
    ND-Rule.3:iter-star      -- _1,
    ND-Def                   -- KW["defines"] _1 _2 _3 _4,
    ND-Ref                   -- KW["refers"] KW["to"] _1 _2 _3 _4,
-   ND-Scope                 -- _1 KW["scope"] KW["for"] _2 _3,
+   ND-Scope                 -- _1 KW["scope"] _2 KW["for"] _3 _4,
+   ND-Anon-Scope            -- _1 KW["scope"] KW["for"] _2 _3,
    ND-Type                  -- KW["has"] KW["type"] _1,
    Where                    -- KW["where"] _1 _2,
    TypeCheck                -- KW["has"] KW["type"] _1,

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Thu May 31 01:33:34 2012	(r24876)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/syntax/NameDefinitionLanguage.sdf	Thu May 31 02:31:53 2012	(r24877)
@@ -29,10 +29,11 @@
 										-> NamingRules {ast("[]")}
 	Term ":" NamingPart+ WhereClause*	-> NamingRule  {"ND-Rule"}
 	
-	"defines" NamespaceRef Term TypePart DefScopePart		-> NamingPart {"ND-Def"}
-	"refers" "to" NamespaceRef Term TypePart RefScopePart	-> NamingPart {"ND-Ref"}
-	OrderedPart "scope" "for" NamespaceRef IncludingPart	-> NamingPart {"ND-Scope"}
-	"has" "type" Term										-> NamingPart {"ND-Type"}
+	"defines" NamespaceRef Term TypePart DefScopePart			-> NamingPart {"ND-Def"}
+	"refers" "to" NamespaceRef Term TypePart RefScopePart		-> NamingPart {"ND-Ref"}
+	OrderedPart "scope" Term "for" NamespaceRef IncludingPart	-> NamingPart {"ND-Scope"}
+	OrderedPart "scope" "for" NamespaceRef IncludingPart		-> NamingPart {"ND-Anon-Scope"}
+	"has" "type" Term											-> NamingPart {"ND-Type"}
 	
 	"where" Term Condition 									-> WhereClause {"Where"}
 	"has" "type" Term 								 	 	-> Condition {"TypeCheck"}

Modified: spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May 31 01:33:34 2012	(r24876)
+++ spoofax-imp/trunk/org.strategoxt.imp.names/trans/generate.str	Thu May 31 02:31:53 2012	(r24877)
@@ -22,14 +22,24 @@
 	
 	TERM(o, args) = NoAnnoList(Op(o, args))
 	TERM(o)       = NoAnnoList(Op(o, []))
+	TUPLE(args)   = NoAnnoList(Tuple(args))
+	LIST(elems)   = NoAnnoList(List(elems))
 	CALL(c)       = CallNoArgs(SVar(c))
 	CALL(c, t)    = CallT(SVar(c), [], [t])
 
 	RULE(n, lhs, rhs, clauses) = RDefNoArgs(n, Rule(lhs, rhs, clauses))
-		
+
+	ANON()        = TERM("Anon")
+			
 overlays
 	
-	GEN_IMPORTS      = Imports([Import("lib/analysis-library.generated"), Import("lib/index-library.generated")])
+	GEN_IMPORTS = 
+		Imports(
+			[ Import("lib/analysis-library")
+			, Import("lib/analysis-library-internal")
+			, Import("lib/index-library") 
+			]
+		)
 	GEN_CONSTRUCTORS = Constructors([CONS_DECL("Type", "DefDataKind")])
 		
 	CONS_DECL(c, t) = OpDecl(c, ConstType(SortNoArgs(t)))
@@ -52,9 +62,9 @@
 		Naming(name, import*, namespace*, rule*) -> 
 		Module(
 			  name
-			, [ GEN_IMPORTS
+			, [ GEN_IMPORTS()
 			  , Imports(import*)
-			  , Signature([GEN_CONSTRUCTORS, Constructors(<map(to-opdecl)> namespace*)])
+			  , Signature([GEN_CONSTRUCTORS(), Constructors(<map(to-opdecl)> namespace*)])
 			  | <filter(to-rules)> rule*
 			  ]
 			)
@@ -65,13 +75,11 @@
 	to-rules:
 		ND-Rule(term, part*, cond*) -> Rules(<not(?[])> [scope-rule*, definition-rule*, annotate-rule*, type-rule*])
 		where
-			<debug> term 
-		where
 			clause1*         := <filter(to-clauses)> part* ;
 			clause2*         := <filter(to-clauses)> cond* ; 
 			clause*          := <conc> (clause1*, clause2*) ;
 			scope-rule*      := <to-scope-rules(|term, clause*)> part* ;
-			definition-rule* := <filter(to-definition-rules(|term, clause*)) ; concat> part* ;
+			definition-rule* := <filter(to-definition-parts) ; unzip ; to-definition-rules(|term, clause*)> part* ;
 			annotate-rule*   := <to-annotate-rules(|term, clause*)> part* ;
 			type-rule*       := <filter(to-type-rules(|term, clause*)) ; concat> part*
 
@@ -102,15 +110,25 @@
 			end
 	
 	to-scope:
-		ND-Scope(_, NsRef(namespace), _) -> TERM(namespace)
+		ND-Scope(_, term, NsRef(namespace), _) -> TUPLE([TERM(namespace), term])
+	
+	to-scope:
+		ND-Anon-Scope(_, NsRef(namespace), _) -> TUPLE([TERM(namespace), ANON()])
 			
 rules
 			
+	to-definition-parts:
+		ND-Def(NsRef(namespace), name, _, None()) -> (name, TUPLE([TERM(namespace), name]))
+	
 	to-definition-rules(|term, clause*):
-		ND-Def(NsRef(namespace), name, _, None()) ->
-		[ RULE("nam-get-definition-key", term, name, clause*)
-		, RULE("nam-get-definition", term, App(CALL("nam-get-def", TERM(namespace)), name), clause*) ]
+		(key-part*, def-part*) ->
+		[ RULE("nam-get-definition-keys", term, LIST(<make-set> key-part*), clause*)
+		, RULE("nam-get-definitions",     term, LIST(<make-set> def-part*), clause*) ]
+		where
+			<Hd> key-part* ; <Hd> def-part*
 
+	to-definition-rules(|term, clause*):
+		([], []) -> []
 rules
 	
 	to-annotate-rules(|term, clause*):
@@ -120,11 +138,11 @@
 			if <?[]> replacement* then
 				result := [] 
 			else
-				result := [SDefT("nam-annotate-names", [], [DefaultVarDec("path")], <alltd(replace(|replacement*) <+ introduce-id)> term)]
+				result := [SDefNoArgs("nam-annotate-names", <alltd(replace(|replacement*) <+ introduce-id)> term)]
 			end
 		
 	to-annotate-replacement:
-		ND-Def(_, name, _, None())-> (name, CALL("nam-annotate-def", Var("path")))
+		ND-Def(NsRef(namespace), name, _, None())-> (name, CALL("nam-annotate-def", TERM(namespace)))
 			
 	to-annotate-replacement:
 		ND-Ref(NsRef(namespace), name, _, None()) -> (name, CALL("nam-annotate-use", TERM(namespace)))

From oskarvanrest at gmail.com  Thu May 31 07:22:28 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 05:22:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24878 -
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf
Message-ID: <20120531052228.C784DCC11F@mx4.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 05:22:27 2012
New Revision: 24878
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24878&sc=1

Log:
2 bugfixes

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Thu May 31 02:31:53 2012	(r24877)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Thu May 31 05:22:27 2012	(r24878)
@@ -18,7 +18,7 @@
 		productions := <collect-om(?prod(_, _, _))> <collect-om(?context-free-syntax(_))> exports*;
 		classes := <map(to-ecore)> productions;
 		superclasses := <create-superclasses> productions;
-		classes' := <remove-all(?[])> <conc>(classes, superclasses)
+		classes' := <conc>(classes, superclasses)
 
 	to-ecore:
 		prod(lhs, sort(s), attributes) -> EClass(properties', structuralFeatures')
@@ -56,7 +56,7 @@
 		(sort, properties) -> (sort, properties')
 		where
 			not ( <?namespacedef(_, _)> sort + <?namespaceref2(_, _)> sort);
-			properties' := <add-property> (Containment(False()), properties)
+			properties' := <add-property> (Containment(True()), properties)
 
 	set-bounds:
 		(opt(sort(s)), properties) -> (s, properties')
@@ -88,7 +88,7 @@
 			properties' := <add-property> (name, properties);
 			
 			if
-				<int-or-string> s
+				not ( <fetch(?Containment(False()))> properties ); <int-or-string> s
 			then
 				type := Type(<int-or-string> s);
 				properties'' := <add-property> (type, properties');

From oskarvanrest at gmail.com  Thu May 31 07:50:53 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 05:50:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24879 - in
	experimental/graphical-editor/EntityLang/EntityLang: META-INF
	editor/java/EntityLang/GMF editor/java/EntityLang/strategies
	syntax trans
Message-ID: <20120531055053.9626A7F800B@mx1.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 05:50:52 2012
New Revision: 24879
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24879&sc=1

Log:
Refactor

Added:
   experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore
Modified:
   experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java
   experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.generated.pp
   experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.sdf
   experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Thu May 31 05:22:27 2012	(r24878)
+++ experimental/graphical-editor/EntityLang/EntityLang/META-INF/MANIFEST.MF	Thu May 31 05:50:52 2012	(r24879)
@@ -17,12 +17,12 @@
  org.strategoxt.imp.runtime,
  org.spoofax.jsglr,
  org.strategoxt.strj,
- EntityLangEMF.diagram;bundle-version="1.0.0",
  org.eclipse.emf.transaction;bundle-version="1.4.0",
  org.eclipse.gmf.runtime.diagram.ui;bundle-version="1.5.0",
  org.spoofax.text2model.bridges.API;bundle-version="1.0.0",
  org.eclipse.gmf.runtime.diagram.ui.resources.editor;bundle-version="1.4.1",
- org.eclipse.ltk.core.refactoring;bundle-version="3.5.201"
+ org.eclipse.ltk.core.refactoring;bundle-version="3.5.201",
+ EntityLangModel.diagram;bundle-version="1.0.0"
 Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Bundle-ActivationPolicy: lazy
 Export-Package: EntityLang

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Thu May 31 05:22:27 2012	(r24878)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Thu May 31 05:50:52 2012	(r24879)
@@ -29,7 +29,7 @@
 import org.strategoxt.imp.runtime.dynamicloading.BadDescriptorException;
 import org.strategoxt.imp.runtime.services.ITextReplacer;
 
-import EntityLangModel.Module;
+import EntityLang.Module;
 
 public class GMFUtils {
 
@@ -37,7 +37,7 @@
 	 * Hardcoded for now
 	 */
 	public static DiagramEditor findDiagramEditor(String packName) {
-		return (DiagramEditor) findEditor("Test\\example.entitylangmodel_diagram", (packName + ".diagram.part." + packName + "DiagramEditorID"));
+		return (DiagramEditor) findEditor("Test\\example.entitylang_diagram", (packName + ".diagram.part." + packName + "DiagramEditorID"));
 	}
 	
 	/**
@@ -92,7 +92,7 @@
 	private static ContentAdapter contentAdapter = new ContentAdapter(null);
 
 	public static void addContentAdapter() {
-		DiagramEditor diagramEditor = GMFUtils.findDiagramEditor("EntityLangModel");
+		DiagramEditor diagramEditor = GMFUtils.findDiagramEditor("EntityLang");
 		if (diagramEditor != null) {
 			module = (Module) GMFUtils.getSemanticModel(diagramEditor);
 			if (module != null) {
@@ -110,7 +110,7 @@
 	}
 
 	public static IStrategoTerm EMF2Term() {
-		EObject module = getSemanticModel(findDiagramEditor("EntityLangModel"));
+		EObject module = getSemanticModel(findDiagramEditor("EntityLang"));
 		return EMF2Term(module);
 	}
 
@@ -118,20 +118,20 @@
 
 	public static IStrategoTerm EMF2Term(EObject object) {
 		if (object.eClass().getName().equals("Module")) {
-			EStructuralFeature feature = object.eClass().getEStructuralFeature("identifier");
+			EStructuralFeature feature = object.eClass().getEStructuralFeature("id");
 			IStrategoTerm name = f.makeString("Module");
 			if (object.eGet(feature) != null) {
 				name = f.makeString(object.eGet(feature).toString());
 			}
 	
-			EList<?> definitions = (EList<?>) object.eGet(object.eClass().getEStructuralFeature("definitions"));
-			IStrategoList entities = f.makeList();
-			for (int i = definitions.size() - 1; i >= 0; i--) {
-				entities = f.makeListCons(EMF2Term((EObject) definitions.get(i)), entities);
+			EList<?> eTypes = (EList<?>) object.eGet(object.eClass().getEStructuralFeature("types"));
+			IStrategoList types = f.makeList();
+			for (int i = eTypes.size() - 1; i >= 0; i--) {
+				types = f.makeListCons(EMF2Term((EObject) eTypes.get(i)), types);
 			}
-			return f.makeAppl(f.makeConstructor("Module", 2), name, entities);
+			return f.makeAppl(f.makeConstructor("Module", 2), name, types);
 		} else if (object.eClass().getName().equals("Entity")) {
-			EStructuralFeature feature = object.eClass().getEStructuralFeature("identifier");
+			EStructuralFeature feature = object.eClass().getEStructuralFeature("id");
 			IStrategoTerm name = f.makeString("Entity");
 			if (object.eGet(feature) != null) {
 				name = f.makeString(object.eGet(feature).toString());
@@ -145,7 +145,7 @@
 			
 			return f.makeAppl(f.makeConstructor("Entity", 2), name, properties);
 		} else if (object.eClass().getName().equals("Property")) {
-			EStructuralFeature feature = object.eClass().getEStructuralFeature("identifier");
+			EStructuralFeature feature = object.eClass().getEStructuralFeature("id");
 			IStrategoTerm name = f.makeString("Property");
 			if (object.eGet(feature) != null) {
 				name = f.makeString(object.eGet(feature).toString());
@@ -155,12 +155,11 @@
 			IStrategoTerm propertyType = f.makeString("Type");
 			if (object.eGet(feature2) != null) {
 				EObject type = (EObject) object.eGet(feature2);
-				EStructuralFeature feature3 = type.eClass().getEStructuralFeature("identifier");
+				EStructuralFeature feature3 = type.eClass().getEStructuralFeature("id");
 				propertyType = f.makeString(type.eGet(feature3).toString());
 			}
 
-			IStrategoTerm type = f.makeAppl(f.makeConstructor("Type", 1), propertyType);
-			return f.makeAppl(f.makeConstructor("Property", 2), name, type);
+			return f.makeAppl(f.makeConstructor("Property", 2), name, propertyType);
 		}
 		return null;
 	}

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Thu May 31 05:22:27 2012	(r24878)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Thu May 31 05:50:52 2012	(r24879)
@@ -14,8 +14,8 @@
 import org.strategoxt.lang.Strategy;
 
 import EntityLang.GMF.GMFUtils;
-import EntityLangModel.diagram.part.EntityLangModelDiagramEditorPlugin;
-import EntityLangModel.diagram.part.EntityLangModelDocumentProvider;
+import EntityLang.diagram.part.EntityLangDiagramEditorPlugin;
+import EntityLang.diagram.part.EntityLangDocumentProvider;
 
 public class replace_gmf_resource_0_2 extends Strategy {
 
@@ -44,7 +44,7 @@
 
 		final Resource semanticModelResource = GMFUtils.getSemanticModelResource(diagramEditor);
 		final InputStream is = new ByteArrayInputStream(((IStrategoString) serialisedModel).stringValue().getBytes());
-		final EntityLangModelDocumentProvider documentProvider = EntityLangModelDiagramEditorPlugin.getInstance().getDocumentProvider();
+		final EntityLangDocumentProvider documentProvider = EntityLangDiagramEditorPlugin.getInstance().getDocumentProvider();
 		final IEditorInput editorInput = diagramEditor.getEditorInput();
 
 		diagramEditor.getSite().getShell().getDisplay().asyncExec(new Runnable() {

Added: experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore	Thu May 31 05:50:52 2012	(r24879)
@@ -0,0 +1,33 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<ecore:EPackage xmi:version="2.0"
+    xmlns:xmi="http://www.omg.org/XMI" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
+    xmlns:ecore="http://www.eclipse.org/emf/2002/Ecore" name="EntityLang"
+    nsURI="EntityLang" nsPrefix="EntityLang">
+  <eClassifiers xsi:type="ecore:EClass" name="Module">
+    <eAnnotations source="gmf.diagram"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="types" upperBound="-1"
+        eType="#//Type" containment="true"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Entity" eSuperTypes="#//Type">
+    <eAnnotations source="gmf.node">
+      <details key="label" value="id"/>
+    </eAnnotations>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="properties" upperBound="-1"
+        eType="#//Property" containment="true">
+      <eAnnotations source="gmf.compartment"/>
+    </eStructuralFeatures>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Primitive" eSuperTypes="#//Type">
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Property">
+    <eAnnotations source="gmf.node">
+      <details key="label" value="id"/>
+    </eAnnotations>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EReference" name="type" lowerBound="1" eType="#//Type"/>
+  </eClassifiers>
+  <eClassifiers xsi:type="ecore:EClass" name="Type"/>
+</ecore:EPackage>

Modified: experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.generated.pp
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.generated.pp	Thu May 31 05:22:27 2012	(r24878)
+++ experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.generated.pp	Thu May 31 05:50:52 2012	(r24879)
@@ -3,6 +3,6 @@
    Module.2:iter-star -- _1,
    Entity             -- KW["entity"] _1 KW["{"] _2 KW["}"],
    Entity.2:iter-star -- _1,
-   Property           -- _1 KW[":"] _2,
-   Type               -- _1
+   Primitive          -- KW["primitive"] _1,
+   Property           -- _1 KW[":"] _2
 ]
\ No newline at end of file

Modified: experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.sdf
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.sdf	Thu May 31 05:22:27 2012	(r24878)
+++ experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.sdf	Thu May 31 05:50:52 2012	(r24879)
@@ -12,7 +12,7 @@
 
   context-free syntax
   
-    "module" Module@=ID Definition*       -> Start {"Module", scope(Type)}
-    "entity" Type@=ID "{" Property* "}"   -> Definition {"Entity", scope(Property)}
-    Property@=ID ":" Type                 -> Property {"Property"}
-    Type at ID                               -> Type {"Type"}
+    "module" Module@=ID Type*				-> Start {"Module", scope(Type)}
+    "entity" Type@=ID "{" Property* "}"		-> Type {"Entity", scope(Property)}
+	"primitive" Type @=ID					-> Type {"Primitive"}
+    Property@=ID ":" Type at ID				-> Property {"Property"}

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Thu May 31 05:22:27 2012	(r24878)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/emf.str	Thu May 31 05:50:52 2012	(r24879)
@@ -7,63 +7,77 @@
 strategies
 	
 	to-emf(|path) = clear-EObjectRegistry; topdown(try(create-object(|path))); topdown(try(set-structural-features))
-	serialise-model(|path) = get-identifier; serialise(|path)
+	serialise-model(|path) = get-uid; serialise(|path)
 
 rules
 	
 	create-object(|path):
-		Module(name, entities) -> Module(identifier, name, entities)
+		Module(ID, types) -> Module(uid, ID, types)
 		with
-			[URI] := <get-annos> name;
-			identifier := <create-instance(|<packName>, URI)> "Module"
+			[URI] := <get-annos> ID;
+			uid := <create-instance(|<packName>, URI)> "Module"
 	 	
 	create-object(|path):
-		Entity(name, properties) -> Entity(identifier, name, properties)
+		Entity(ID, properties) -> Entity(uid, ID, properties)
 		with
-			[URI] := <get-annos> name;
-			identifier := <create-instance(|<packName>, URI)> "Entity"
+			[URI] := <get-annos> ID;
+			uid := <create-instance(|<packName>, URI)> "Entity"
+	
+	create-object(|path):
+		Primitive(ID) -> Primitive(uid, ID)
+		with
+			[URI] := <get-annos> ID;
+			uid := <create-instance(|<packName>, URI)> "Primitive"
 			
 	create-object(|path):
-		Property(name, type) -> Property(identifier, name, type)
+		Property(ID, type) -> Property(uid, ID, type)
 		with
-			[URI] := <get-annos> name;
-			identifier := <create-instance(|<packName>, URI)> "Property"
+			[URI] := <get-annos> ID;
+			uid := <create-instance(|<packName>, URI)> "Property"
 
 rules
 
 	set-structural-features:
-		e at Module(identifier, name, entities) -> e
+		e at Module(uid, ID, types) -> e
 		with
-			<set-attribute(|identifier, "identifier")> name;
-			entities' := <map(get-identifier)> entities;
-			<set-reference(|identifier, "definitions")> entities'
+			<set-attribute(|uid, "id")> ID;
+			types' := <map(get-uid)> types;
+			<set-reference(|uid, "types")> types'
 	 	
 	set-structural-features:
-		e at Entity(identifier, name, properties) -> e
+		e at Entity(uid, ID, properties) -> e
 		with
-			<set-attribute(|identifier, "identifier")> name;			
-			properties' := <map(get-identifier)> properties;
-			<set-reference(|identifier, "properties")> properties'
+			<set-attribute(|uid, "id")> ID;			
+			properties' := <map(get-uid)> properties;
+			<set-reference(|uid, "properties")> properties'
+	
+	set-structural-features:
+		e at Primitive(uid, ID) -> e
+		with
+			<set-attribute(|uid, "id")> ID
 			
 	set-structural-features:
-		e at Property(identifier, name, Type(typeRef)) -> e
+		e at Property(uid, ID, type) -> e
 		with
-			<set-attribute(|identifier, "identifier")> name;
-			[URI] := <get-annos> typeRef;
-			if not (<?Unresolved(_)> <index(|1)> URI)
-				then <set-reference(|identifier, "type")> <write-to-string> URI
+			<set-attribute(|uid, "id")> ID;
+			[type-URI] := <get-annos> type;
+			if not (<?Unresolved(_)> <index(|1)> type-URI)
+				then <set-reference(|uid, "type")> <write-to-string> type-URI
 			end
 
 rules
 	
-	get-identifier:
-		Module(identifier, _, _) -> identifier
+	get-uid:
+		Module(uid, _, _) -> uid
+
+	get-uid:
+		Entity(uid, _, _) -> uid
 
-	get-identifier:
-		Entity(identifier, _, _) -> identifier
+	get-uid:
+		Primitive(uid, _) -> uid
 
-	get-identifier:
-		Property(identifier, _, _) -> identifier	
+	get-uid:
+		Property(uid, _, _) -> uid	
 			
 rules
 	
@@ -75,12 +89,13 @@
 	
 rules
 	
-	packName = <conc-strings> (<get-config> "program", "Model")
+	packName = <get-config> "program"
 	
 signature constructors
 
 	EMFObject			: Namespace
-	Module				: identifier * name * entities -> Module
-	Entity				: identifier * name * properties -> Entity
-	Property			: identifier * name * type -> Property
+	Module				: uid * ID * types -> Module
+	Entity				: uid * ID * properties -> Entity
+	Primitive			: uid * ID -> Primitive
+	Property			: uid * ID * type -> Property
 	
\ No newline at end of file

From oskarvanrest at gmail.com  Thu May 31 15:03:32 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 13:03:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24880 - in
	experimental/graphical-editor/EntityLang/EntityLang:
	editor/java/EntityLang/GMF syntax trans
Message-ID: <20120531130332.526047F8063@mx1.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 13:03:32 2012
New Revision: 24880
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24880&sc=1

Log:
Made the model2term generic, such that it can deal with any metamodel.

Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
   experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore
   experimental/graphical-editor/EntityLang/EntityLang/trans/analysis-manual.str

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Thu May 31 05:50:52 2012	(r24879)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Thu May 31 13:03:32 2012	(r24880)
@@ -1,5 +1,9 @@
 package EntityLang.GMF;
 
+import java.util.ArrayList;
+import java.util.Collection;
+import java.util.Iterator;
+
 import org.eclipse.core.resources.IFile;
 import org.eclipse.core.resources.ResourcesPlugin;
 import org.eclipse.core.runtime.IPath;
@@ -7,7 +11,9 @@
 import org.eclipse.core.runtime.Path;
 import org.eclipse.emf.common.notify.Notification;
 import org.eclipse.emf.common.util.EList;
+import org.eclipse.emf.ecore.EAttribute;
 import org.eclipse.emf.ecore.EObject;
+import org.eclipse.emf.ecore.EReference;
 import org.eclipse.emf.ecore.EStructuralFeature;
 import org.eclipse.emf.ecore.resource.Resource;
 import org.eclipse.emf.ecore.resource.ResourceSet;
@@ -22,6 +28,7 @@
 import org.eclipse.ui.IWorkbenchWindow;
 import org.eclipse.ui.PlatformUI;
 import org.eclipse.ui.part.FileEditorInput;
+import org.spoofax.interpreter.terms.IStrategoConstructor;
 import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.terms.TermFactory;
@@ -111,59 +118,61 @@
 
 	public static IStrategoTerm EMF2Term() {
 		EObject module = getSemanticModel(findDiagramEditor("EntityLang"));
-		return EMF2Term(module);
+		return Model2Term(module);
 	}
 
 	public static TermFactory f = new TermFactory();
 
-	public static IStrategoTerm EMF2Term(EObject object) {
-		if (object.eClass().getName().equals("Module")) {
-			EStructuralFeature feature = object.eClass().getEStructuralFeature("id");
-			IStrategoTerm name = f.makeString("Module");
-			if (object.eGet(feature) != null) {
-				name = f.makeString(object.eGet(feature).toString());
-			}
-	
-			EList<?> eTypes = (EList<?>) object.eGet(object.eClass().getEStructuralFeature("types"));
-			IStrategoList types = f.makeList();
-			for (int i = eTypes.size() - 1; i >= 0; i--) {
-				types = f.makeListCons(EMF2Term((EObject) eTypes.get(i)), types);
-			}
-			return f.makeAppl(f.makeConstructor("Module", 2), name, types);
-		} else if (object.eClass().getName().equals("Entity")) {
-			EStructuralFeature feature = object.eClass().getEStructuralFeature("id");
-			IStrategoTerm name = f.makeString("Entity");
-			if (object.eGet(feature) != null) {
-				name = f.makeString(object.eGet(feature).toString());
-			}
-			
-			EList<?> props = (EList<?>) object.eGet(object.eClass().getEStructuralFeature("properties"));
-			IStrategoList properties = f.makeList();
-			for (int i = props.size() - 1; i >= 0; i--) {
-				properties = f.makeListCons(EMF2Term((EObject) props.get(i)), properties);
-			}
-			
-			return f.makeAppl(f.makeConstructor("Entity", 2), name, properties);
-		} else if (object.eClass().getName().equals("Property")) {
-			EStructuralFeature feature = object.eClass().getEStructuralFeature("id");
-			IStrategoTerm name = f.makeString("Property");
-			if (object.eGet(feature) != null) {
-				name = f.makeString(object.eGet(feature).toString());
-			}
-
-			EStructuralFeature feature2 = object.eClass().getEStructuralFeature("type");
-			IStrategoTerm propertyType = f.makeString("Type");
-			if (object.eGet(feature2) != null) {
-				EObject type = (EObject) object.eGet(feature2);
-				EStructuralFeature feature3 = type.eClass().getEStructuralFeature("id");
-				propertyType = f.makeString(type.eGet(feature3).toString());
-			}
+	
+	public static IStrategoTerm Model2Term(EObject eObject) {
+		String className = eObject.eClass().getName();
+		EList<EStructuralFeature> eStructuralFeatures = eObject.eClass().getEStructuralFeatures();
 
-			return f.makeAppl(f.makeConstructor("Property", 2), name, propertyType);
+		IStrategoConstructor constructor = f.makeConstructor(className, eStructuralFeatures.size());
+		ArrayList<IStrategoTerm> kids = new ArrayList<IStrategoTerm>();
+		
+		for (EStructuralFeature eSructuralFeature : eStructuralFeatures) {
+			Object value = eObject.eGet(eSructuralFeature);
+			if (value == null) {
+				kids.add(f.makeString(eSructuralFeature.getName()));
+			}
+			else if (eSructuralFeature instanceof EAttribute) {
+				kids.add(f.makeString(value.toString()));
+			}
+			else if (eSructuralFeature instanceof EReference) {
+				EReference eReference = (EReference) eSructuralFeature;
+				if (eReference.isContainment()) {
+					if (value instanceof EObject) {
+						kids.add(Model2Term((EObject) value));
+					}
+					else if (value instanceof EList) {
+						EList<?> eListElements = (EList<?>) value;
+						ArrayList<IStrategoTerm> result = new ArrayList<IStrategoTerm>();
+						for (Object eListElement : eListElements) {
+							result.add(Model2Term((EObject) eListElement));
+						}
+						kids.add(f.makeList(result));
+					}
+				}
+				else {
+					if (value instanceof EObject) {
+						kids.add(f.makeString(getReference((EObject) value)));
+					}
+				}
+			}
 		}
+		return f.makeAppl(constructor, f.makeList(kids));
+	}
+	
+	public static String getReference(EObject object) {
+		EList<EAttribute> eAttributes = object.eClass().getEAllAttributes();
+		for (EAttribute eAttribute : eAttributes) {
+			if (eAttribute.isID()) {
+				return object.eGet(eAttribute).toString();
+			}
+		}		
 		return null;
 	}
-
 }
 
 class ContentAdapter extends EContentAdapter {

Modified: experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore	Thu May 31 05:50:52 2012	(r24879)
+++ experimental/graphical-editor/EntityLang/EntityLang/syntax/EntityLang.ecore	Thu May 31 13:03:32 2012	(r24880)
@@ -5,7 +5,8 @@
     nsURI="EntityLang" nsPrefix="EntityLang">
   <eClassifiers xsi:type="ecore:EClass" name="Module">
     <eAnnotations source="gmf.diagram"/>
-    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
     <eStructuralFeatures xsi:type="ecore:EReference" name="types" upperBound="-1"
         eType="#//Type" containment="true"/>
   </eClassifiers>
@@ -13,20 +14,23 @@
     <eAnnotations source="gmf.node">
       <details key="label" value="id"/>
     </eAnnotations>
-    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
     <eStructuralFeatures xsi:type="ecore:EReference" name="properties" upperBound="-1"
         eType="#//Property" containment="true">
       <eAnnotations source="gmf.compartment"/>
     </eStructuralFeatures>
   </eClassifiers>
   <eClassifiers xsi:type="ecore:EClass" name="Primitive" eSuperTypes="#//Type">
-    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
   </eClassifiers>
   <eClassifiers xsi:type="ecore:EClass" name="Property">
     <eAnnotations source="gmf.node">
       <details key="label" value="id"/>
     </eAnnotations>
-    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"/>
+    <eStructuralFeatures xsi:type="ecore:EAttribute" name="id" lowerBound="1" eType="ecore:EDataType http://www.eclipse.org/emf/2002/Ecore#//EString"
+        iD="true"/>
     <eStructuralFeatures xsi:type="ecore:EReference" name="type" lowerBound="1" eType="#//Type"/>
   </eClassifiers>
   <eClassifiers xsi:type="ecore:EClass" name="Type"/>

Modified: experimental/graphical-editor/EntityLang/EntityLang/trans/analysis-manual.str
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/trans/analysis-manual.str	Thu May 31 05:50:52 2012	(r24879)
+++ experimental/graphical-editor/EntityLang/EntityLang/trans/analysis-manual.str	Thu May 31 13:03:32 2012	(r24880)
@@ -8,6 +8,6 @@
 
 rules // Adjust lookup
 
-  // Add primitive types to type lookup.
-  adjust-index-lookup(target |namespace, path, prefix): 
-    Type(<target>) ->  [Def([Type(), "Int"]), Def([Type(), "String"]), [Type() | path]]
+  // // Add primitive types to type lookup.
+  // adjust-index-lookup(target |namespace, path, prefix): 
+  //   Type(<target>) ->  [Def([Type(), "Int"]), Def([Type(), "String"]), [Type() | path]]

From oskarvanrest at gmail.com  Thu May 31 15:18:35 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 13:18:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24881 -
	experimental/graphical-editor/Ecore/syntax
Message-ID: <20120531131835.4585E108C010@mx3.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 13:18:35 2012
New Revision: 24881
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24881&sc=1

Log:
Fixed 'ID' property

Modified:
   experimental/graphical-editor/Ecore/syntax/Ecore.sdf

Modified: experimental/graphical-editor/Ecore/syntax/Ecore.sdf
==============================================================================
--- experimental/graphical-editor/Ecore/syntax/Ecore.sdf	Thu May 31 13:03:32 2012	(r24880)
+++ experimental/graphical-editor/Ecore/syntax/Ecore.sdf	Thu May 31 13:18:35 2012	(r24881)
@@ -34,32 +34,29 @@
     %%
 
 	%% EPackage properties
-	Id								-> EPackageProperty
 	Name							-> EPackageProperty
 
 	%% EClass properties
-	Id								-> EClassProperty
 	Name							-> EClassProperty
 	ESuperType						-> EClassProperty
 	Abstract						-> EClassProperty
 
 	%% EAttribute properties
-	Id								-> EAttributeProperty
 	Name							-> EAttributeProperty
 	Type							-> EAttributeProperty
 	UpperBound						-> EAttributeProperty
 	LowerBound						-> EAttributeProperty
+	ID								-> EAttributeProperty
 
 	%% EReference properties
-	Id								-> EReferenceProperty
 	Name							-> EReferenceProperty
 	Type							-> EReferenceProperty
 	UpperBound						-> EReferenceProperty
 	LowerBound						-> EReferenceProperty
 	Containment						-> EReferenceProperty
+	ID								-> EReferenceProperty
 	
 	%% Properties
-	"Id" "=" ID						-> Id {cons("Id")}
 	"Name" "=" ID					-> Name {cons("Name")}
 	"Type" "=" Type					-> Type {cons("Type")}
 	"ESuper" "Type" "=" Type		-> ESuperType {cons("ESuperType")}
@@ -67,6 +64,7 @@
 	"Lower" "Bound" "=" INT			-> LowerBound {cons("LowerBound")}
 	"Containment" "=" Boolean		-> Containment {cons("Containment")}
 	"Abstract" "=" Boolean			-> Abstract {cons("Abstract")}
+	"ID" "=" Boolean				-> ID {cons("ID")}
 
     %%
     %% TYPES

From oskarvanrest at gmail.com  Thu May 31 15:20:30 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 13:20:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24882 - in
	spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf:
	lib trans/emf
Message-ID: <20120531132030.2FCC7108C012@mx3.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 13:20:29 2012
New Revision: 24882
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24882&sc=1

Log:
namespacedef -> EAttributes: added property ID = true (false in all other cases)

Modified:
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/lib/ecore-signatures.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/ecore-to-xml.str
   spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/lib/ecore-signatures.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/lib/ecore-signatures.str	Thu May 31 13:18:35 2012	(r24881)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/lib/ecore-signatures.str	Thu May 31 13:20:29 2012	(r24882)
@@ -14,24 +14,21 @@
                 : ID -> Type
     Type        : Type -> Type
     Name        : ID -> Name
-    Id          : ID -> Id
+                : ID -> EReferenceProperty
                 : Containment -> EReferenceProperty
                 : LowerBound -> EReferenceProperty
                 : UpperBound -> EReferenceProperty
                 : Type -> EReferenceProperty
                 : Name -> EReferenceProperty
-                : Id -> EReferenceProperty
+                : ID -> EAttributeProperty
                 : LowerBound -> EAttributeProperty
                 : UpperBound -> EAttributeProperty
                 : Type -> EAttributeProperty
                 : Name -> EAttributeProperty
-                : Id -> EAttributeProperty
                 : Abstract -> EClassProperty
                 : ESuperType -> EClassProperty
                 : Name -> EClassProperty
-                : Id -> EClassProperty
                 : Name -> EPackageProperty
-                : Id -> EPackageProperty
                 : EReference -> EClassChild
                 : EAttribute -> EClassChild
                 : EClass -> EPackageChild
@@ -40,6 +37,7 @@
     EClass      : List(EClassProperty) * List(EClassChild) -> EClass
     EPackage    : List(EPackageProperty) * List(EPackageChild) -> Start
                 : String -> INT
+    ID          : Boolean -> ID
                 : String -> ID
 
 

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/ecore-to-xml.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/ecore-to-xml.str	Thu May 31 13:18:35 2012	(r24881)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/ecore-to-xml.str	Thu May 31 13:20:29 2012	(r24882)
@@ -89,5 +89,5 @@
 	to-xml: Containment(False())-> XMLAttribute("containment", "false")
 	to-xml: Abstract(True())	-> XMLAttribute("abstract", "true")
 	to-xml: Abstract(False())	-> XMLAttribute("abstract", "false")
-	
-			
\ No newline at end of file
+	to-xml: ID(True())			-> XMLAttribute("iD", "true")
+	to-xml: ID(False())			-> XMLAttribute("iD", "false")			
\ No newline at end of file

Modified: spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str
==============================================================================
--- spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Thu May 31 13:18:35 2012	(r24881)
+++ spoofax-imp/branches/graphical-editor/org.strategoxt.imp.editors.sdf/trans/emf/sdf-to-ecore.str	Thu May 31 13:20:29 2012	(r24882)
@@ -37,11 +37,14 @@
 		x -> (x, [])
 		where
 			not ( <?label(_, _)> x )
-
+	
+	// for namespacedef, also set identifier
 	set-containment:
 		(namespacedef(_, sort), properties) -> (sort, properties')
 		where
-			properties' := <add-property> (Containment(True()), properties)
+			containment := Containment(True());
+			ID := ID(True());
+			properties' := <add-properties> ([containment, ID], properties)
 	
 	// for namespaceref2, also set name and type
 	set-containment:

From oskarvanrest at gmail.com  Thu May 31 15:39:11 2012
From: oskarvanrest at gmail.com (Oskar van Rest)
Date: Thu, 31 May 2012 13:39:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r24883 - in
	experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang:
	GMF strategies
Message-ID: <20120531133911.4A8892B8025@mx2.tudelft.nl>

Author: OskarVanRest
Date: Thu May 31 13:39:10 2012
New Revision: 24883
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=24883&sc=1

Log:
Don't execute text2model transformation as a result of a model2text transformation.

Modified:
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
   experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Thu May 31 13:20:29 2012	(r24882)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/GMF/GMFUtils.java	Thu May 31 13:39:10 2012	(r24883)
@@ -37,6 +37,7 @@
 import org.strategoxt.imp.runtime.services.ITextReplacer;
 
 import EntityLang.Module;
+import EntityLang.strategies.replace_gmf_resource_0_2;
 
 public class GMFUtils {
 
@@ -188,6 +189,7 @@
 
 		if (n.getEventType() != Notification.REMOVING_ADAPTER) {
 			GMFUtils.findTextEditor().doSave(new NullProgressMonitor());
+			replace_gmf_resource_0_2.model2text = true;
 			
 			IStrategoTerm currentTerm = GMFUtils.getCurrentAST();
 			IStrategoTerm newTerm = GMFUtils.EMF2Term();

Modified: experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java
==============================================================================
--- experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Thu May 31 13:20:29 2012	(r24882)
+++ experimental/graphical-editor/EntityLang/EntityLang/editor/java/EntityLang/strategies/replace_gmf_resource_0_2.java	Thu May 31 13:39:10 2012	(r24883)
@@ -22,9 +22,16 @@
 	public static replace_gmf_resource_0_2 instance = new replace_gmf_resource_0_2();
 
 	public static String lastSerialisedModel = "";
+	public static Boolean model2text = false;
 	
 	@Override
 	public IStrategoTerm invoke(Context context, IStrategoTerm serialisedModel, IStrategoTerm packName, IStrategoTerm filename) {
+		if (model2text) {
+			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
+			model2text = false;
+			return context.getFactory().makeString("0");
+		}
+		
 		if (((IStrategoString) serialisedModel).stringValue().equals(lastSerialisedModel)) {
 			System.out.println("No change since last update");
 			return context.getFactory().makeString("0");
@@ -32,6 +39,7 @@
 		else {
 			lastSerialisedModel = ((IStrategoString) serialisedModel).stringValue();
 		}
+		System.out.println("text2model");
 		
 		GMFUtils.removeContentAdapter();
 		

