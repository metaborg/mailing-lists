From R.B.Vermaas at tudelft.nl  Thu Oct  1 09:27:51 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 07:27:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20051 - rob - hydra
Message-ID: <200910010727.n917RpBp010061@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 07:27:51 +0000 (Thu, 01 Oct 2009)
New Revision: 20051

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20051&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-09-30 13:58:09 UTC (rev 20050)
+++ hydra/build.nix	2009-10-01 07:27:51 UTC (rev 20051)
@@ -106,9 +106,11 @@
     version ? null,
     subdirSrc ? ""}:
 
-    pkgsDefault.releaseTools.makeSourceTarball rec {
+    pkgsDefault.stdenv.mkDerivation rec {
+      name = packageName + "-docs" ;
       src = checkout;
       inherit (pkgsDefault) stdenv;
+      inherit officialRelease ;
 
       xdocFlags =
           (if apiDocs then " --api " else "")
@@ -116,6 +118,9 @@
         + (pkgsDefault.lib.concatMapStrings (dir : " -I ${dir}  ") xdocIncludes)
         + (if includeSrc then " -I ${packageName} " else "");
 
+      autoconfPhase = '' 
+      '';
+
       buildPhase = ''
         ensureDir $out/docs/html
         chmod -R 777 $out/docs
@@ -130,7 +135,7 @@
         chmod -R 755 $out/docs
       '';
 
-      distPhase = 
+      installPhase = 
         let tarversion =
               if version == null then
                 if src ? rev
@@ -143,6 +148,8 @@
         cd $out
         ln -s docs ${packageName}-${tarversion}
         tar chvfz $out/tarballs/${packageName}-${tarversion}.tar.gz ${packageName}-${tarversion}
+
+        ensureDir $out/nix-support
         echo "doc manual $out/docs" > $out/nix-support/hydra-build-products
       '';
 
@@ -154,13 +161,13 @@
   /**
    * Build Debian package from tarball
    */
-   easyDebBuildFromTarball = pkgs : spec : tarball : diskImage : prio : version :
-
+   easyDebBuildFromTarball = pkgs : spec : tarball : diskImageFun : prio : version :
     let specpkgs = spec pkgs ;
+        diskImage = diskImageFun (pkgs.lib.attrByPath ["extraVirtualDebs" version] [] specpkgs) ;
     in 
     with pkgs;
 
-    releaseTools.debBuild {
+    releaseTools.debBuild ( {
       name = specpkgs.packageName + "-" + version + "-deb";
       src = tarball;
       diskImage = diskImage;
@@ -175,19 +182,20 @@
       doCheck =
         if specpkgs ? checkSupported then specpkgs.checkSupported else true;
 
-      extraDebs = map (s : ( import (debToNix (easyDebBuildFromTarball pkgs s (easyTarball pkgs s) diskImage prio version))).deb ) (spec pkgs).requires;
+      extraDebs = map (s : easyDebBuildFromTarball pkgs s (easyTarball pkgs s) diskImageFun prio version) (spec pkgs).requires;
 
       # Hack - swap checkPhase and installPhase (otherwise Stratego and SDF barf).
       phases = "installExtraDebsPhase sysInfoPhase unpackPhase patchPhase configurePhase buildPhase installPhase checkPhase fixupPhase distPhase";
       dontDisableStatic = true;
-    };
+    } // ( if (builtins.substring 0 6 diskImage.name) == "ubuntu" then { NIX_CFLAGS_COMPILE = "-fno-stack-protector" ; } else {} ) );
 
   /**
    * Build RPM package from tarball
    */
-   easyRPMBuildFromTarball = pkgs : spec : tarball : diskImage : prio : version :
+   easyRPMBuildFromTarball = pkgs : spec : tarball : diskImageFun : prio : version :
 
     let specpkgs = spec pkgs ;
+        diskImage = diskImageFun  (pkgs.lib.attrByPath ["extraVirtualRPMs" version] [] specpkgs) ;
     in 
     with pkgs;
 
@@ -206,7 +214,7 @@
       doCheck =
         if specpkgs ? checkSupported then specpkgs.checkSupported else true;
 
-      extraRPMs = map (s : ( import (rpmToNix (easyRPMBuildFromTarball pkgs s (easyTarball pkgs s) diskImage prio version))).bin ) (spec pkgs).requires;
+      extraRPMs = map (s : easyRPMBuildFromTarball pkgs s (easyTarball pkgs s) diskImageFun prio version) (spec pkgs).requires;
       dontDisableStatic = true;
     };
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 09:49:18 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 07:49:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20052 - rob - hydra
Message-ID: <200910010749.n917nIxL010543@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 07:49:18 +0000 (Thu, 01 Oct 2009)
New Revision: 20052

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20052&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-01 07:27:51 UTC (rev 20051)
+++ hydra/build.nix	2009-10-01 07:49:18 UTC (rev 20052)
@@ -272,7 +272,7 @@
          }" > $out
        '' ;
 
-  deb = pkgs : version : spec : tarball: easyDebBuildFromTarball pkgs spec tarball (builtins.getAttr version pkgs.vmTools.diskImages) 50 version ;
+  deb = pkgs : version : spec : tarball: easyDebBuildFromTarball pkgs spec tarball (builtins.getAttr version pkgs.vmTools.diskImageExtraFuns) 50 version ;
   debs = pkgs : spec : tb : builtins.listToAttrs ( map (version : { name = version ; value = {tarball ? tb} : deb pkgs version spec tarball; } ) deb_variants ) ;
 
   rpm = pkgs : version : spec : tarball : easyRPMBuildFromTarball pkgs spec (easyTarball pkgsDefault spec) (builtins.getAttr version pkgs.vmTools.diskImages) 50 version ;



From R.B.Vermaas at tudelft.nl  Thu Oct  1 09:51:00 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 07:51:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20053 - rob - hydra
Message-ID: <200910010751.n917p0QB010564@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 07:50:59 +0000 (Thu, 01 Oct 2009)
New Revision: 20053

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20053&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-01 07:49:18 UTC (rev 20052)
+++ hydra/build.nix	2009-10-01 07:50:59 UTC (rev 20053)
@@ -275,7 +275,7 @@
   deb = pkgs : version : spec : tarball: easyDebBuildFromTarball pkgs spec tarball (builtins.getAttr version pkgs.vmTools.diskImageExtraFuns) 50 version ;
   debs = pkgs : spec : tb : builtins.listToAttrs ( map (version : { name = version ; value = {tarball ? tb} : deb pkgs version spec tarball; } ) deb_variants ) ;
 
-  rpm = pkgs : version : spec : tarball : easyRPMBuildFromTarball pkgs spec (easyTarball pkgsDefault spec) (builtins.getAttr version pkgs.vmTools.diskImages) 50 version ;
+  rpm = pkgs : version : spec : tarball : easyRPMBuildFromTarball pkgs spec (easyTarball pkgsDefault spec) (builtins.getAttr version pkgs.vmTools.diskImageExtraFuns) 50 version ;
   rpms = pkgs : spec : tb : builtins.listToAttrs ( map (version : { name = version ; value = {tarball ? tb} : rpm pkgs version spec tarball; } ) rpm_variants ) ;
 
 }



From R.B.Vermaas at tudelft.nl  Thu Oct  1 10:23:56 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 08:23:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20054 - rob -
	hydra/strategoxt
Message-ID: <200910010823.n918NuIG011269@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 08:23:56 +0000 (Thu, 01 Oct 2009)
New Revision: 20054

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20054&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 07:50:59 UTC (rev 20053)
+++ hydra/strategoxt/packages.nix	2009-10-01 08:23:56 UTC (rev 20054)
@@ -277,7 +277,7 @@
       };
 
       svnBuildInputs = autotools pkgs;
-      svnRequires = [strategoxt sdf2Bundle aterm];
+      svnRequires = [aterm sdf2Bundle strategoxt];
       svnConfigureFlags = "--enable-bootstrap";
 
       makeDistRequiresInstall = true;



From R.B.Vermaas at tudelft.nl  Thu Oct  1 13:12:48 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 11:12:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20055 - rob - hydra
Message-ID: <200910011112.n91BCmhM013574@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 11:12:48 +0000 (Thu, 01 Oct 2009)
New Revision: 20055

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20055&view=rev

Modified:
   hydra/baseline.nix

Log:
typo

Changes:

Modified: hydra/baseline.nix
===================================================================
--- hydra/baseline.nix	2009-10-01 08:23:56 UTC (rev 20054)
+++ hydra/baseline.nix	2009-10-01 11:12:48 UTC (rev 20055)
@@ -10,6 +10,6 @@
   strategoxtTarball = pkgs.strategoPackages018.strategoxt.src ;
 
   javaFront        = pkgs.strategoPackages018.javafront ;
-  javaFrontTarball = pkgs.strategoPackages018.javafront ;
+  javaFrontTarball = pkgs.strategoPackages018.javafront.src ;
 }
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 13:43:14 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 11:43:14 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20056 - rob - hydra
Message-ID: <200910011143.n91BhEgX013769@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 11:43:14 +0000 (Thu, 01 Oct 2009)
New Revision: 20056

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20056&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-01 11:12:48 UTC (rev 20055)
+++ hydra/build.nix	2009-10-01 11:43:14 UTC (rev 20056)
@@ -2,8 +2,8 @@
   pkgsDefault 
 , officialRelease ? false 
 , baseline ? {}
-, makeDebs ? false
-, makeRPMs ? false
+, makeDebs ? true
+, makeRPMs ? true
 , ...
 } @ inputs : rec {
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 13:58:56 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 11:58:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20057 - rob - hydra
Message-ID: <200910011158.n91Bwu8k014016@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 11:58:56 +0000 (Thu, 01 Oct 2009)
New Revision: 20057

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20057&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-01 11:43:14 UTC (rev 20056)
+++ hydra/build.nix	2009-10-01 11:58:56 UTC (rev 20057)
@@ -2,8 +2,8 @@
   pkgsDefault 
 , officialRelease ? false 
 , baseline ? {}
-, makeDebs ? true
-, makeRPMs ? true
+, makeDebs ? false
+, makeRPMs ? false
 , ...
 } @ inputs : rec {
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 15:28:47 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 13:28:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20058 - rob - in hydra:
	jobs strategoxt
Message-ID: <200910011328.n91DSlbY015259@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 13:28:47 +0000 (Thu, 01 Oct 2009)
New Revision: 20058

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20058&view=rev

Added:
   hydra/jobs/pil.nix
Modified:
   hydra/strategoxt/packages.nix

Log:
adding pil

Changes:

Added: hydra/jobs/pil.nix
===================================================================
--- hydra/jobs/pil.nix	                        (rev 0)
+++ hydra/jobs/pil.nix	2009-10-01 13:28:47 UTC (rev 20058)
@@ -0,0 +1,26 @@
+{ nixpkgs ? ../../nixpkgs
+, officialRelease ? false
+, hydraConfig ? ../. 
+, baselineNix ? ../baseline.nix
+, pilCheckout ? { outPath = ../../pil ; rev = 1234 ; }
+, javaFront ? (import ./java-front.nix {}).build {}
+} :
+
+let
+  specs = import (hydraConfig + "/strategoxt/packages.nix") ; 
+  jobs = 
+    import (hydraConfig + "/job.nix" ) { 
+      inputs = { 
+        inherit officialRelease ; 
+        inherit pilCheckout ;
+        inherit javaFront ;
+        inherit hydraConfig ;
+        inherit baselineNix ;
+        inherit nixpkgs; 
+      } ; 
+   
+      spec = specs.pil ; 
+    } ;
+
+in jobs
+

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 11:58:56 UTC (rev 20057)
+++ hydra/strategoxt/packages.nix	2009-10-01 13:28:47 UTC (rev 20058)
@@ -564,6 +564,20 @@
     };
 
   /**
+   * PIL
+   */
+  pil =
+    pkgs : rec {
+      fullName = "pil";
+      packageName = "pil";
+      attrPrefix = "pil";
+      svnBuildInputs = buildInputs ++ (autotools pkgs);
+      svnRequires = [aterm sdf2Bundle strategoxt javaFront];
+      buildInputs = [pkgs.pkgconfig];
+      requires = svnRequires;
+    };
+
+  /**
    * ECMAScript model.
    */
   ecmascriptModel =



From R.B.Vermaas at tudelft.nl  Thu Oct  1 15:33:19 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 13:33:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20059 - rob - hydra/jobs
Message-ID: <200910011333.n91DXJBJ015310@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 13:33:19 +0000 (Thu, 01 Oct 2009)
New Revision: 20059

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20059&view=rev

Modified:
   hydra/jobs/pil.nix

Log:


Changes:

Modified: hydra/jobs/pil.nix
===================================================================
--- hydra/jobs/pil.nix	2009-10-01 13:28:47 UTC (rev 20058)
+++ hydra/jobs/pil.nix	2009-10-01 13:33:19 UTC (rev 20059)
@@ -3,7 +3,6 @@
 , hydraConfig ? ../. 
 , baselineNix ? ../baseline.nix
 , pilCheckout ? { outPath = ../../pil ; rev = 1234 ; }
-, javaFront ? (import ./java-front.nix {}).build {}
 } :
 
 let
@@ -13,7 +12,6 @@
       inputs = { 
         inherit officialRelease ; 
         inherit pilCheckout ;
-        inherit javaFront ;
         inherit hydraConfig ;
         inherit baselineNix ;
         inherit nixpkgs; 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 15:38:13 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 13:38:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20060 - rob -
	hydra/strategoxt
Message-ID: <200910011338.n91DcDM6015363@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 13:38:13 +0000 (Thu, 01 Oct 2009)
New Revision: 20060

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20060&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 13:33:19 UTC (rev 20059)
+++ hydra/strategoxt/packages.nix	2009-10-01 13:38:13 UTC (rev 20060)
@@ -571,7 +571,12 @@
       fullName = "pil";
       packageName = "pil";
       attrPrefix = "pil";
-      svnBuildInputs = buildInputs ++ (autotools pkgs);
+      svnBuildInputs = buildInputs ++ [
+      pkgs.autoconf
+      pkgs.automake110x
+      pkgs.libtool_1_5
+      pkgs.pkgconfig
+    ]; #(autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
       buildInputs = [pkgs.pkgconfig];
       requires = svnRequires;



From R.B.Vermaas at tudelft.nl  Thu Oct  1 15:42:42 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 13:42:42 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20061 - rob -
	hydra/strategoxt
Message-ID: <200910011342.n91DggMu015439@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 13:42:42 +0000 (Thu, 01 Oct 2009)
New Revision: 20061

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20061&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 13:38:13 UTC (rev 20060)
+++ hydra/strategoxt/packages.nix	2009-10-01 13:42:42 UTC (rev 20061)
@@ -578,7 +578,7 @@
       pkgs.pkgconfig
     ]; #(autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig];
+      buildInputs = [pkgs.pkgconfig pkgs.ant pkgs.jdk];
       requires = svnRequires;
     };
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 16:02:01 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 14:02:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20062 - rob -
	hydra/strategoxt
Message-ID: <200910011402.n91E21QD015814@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 14:02:01 +0000 (Thu, 01 Oct 2009)
New Revision: 20062

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20062&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 13:42:42 UTC (rev 20061)
+++ hydra/strategoxt/packages.nix	2009-10-01 14:02:01 UTC (rev 20062)
@@ -578,7 +578,7 @@
       pkgs.pkgconfig
     ]; #(autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig pkgs.ant pkgs.jdk];
+      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux apacheAnt;
       requires = svnRequires;
     };
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 16:03:26 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 14:03:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20063 - rob -
	hydra/strategoxt
Message-ID: <200910011403.n91E3PT7015826@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 14:03:25 +0000 (Thu, 01 Oct 2009)
New Revision: 20063

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20063&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 14:02:01 UTC (rev 20062)
+++ hydra/strategoxt/packages.nix	2009-10-01 14:03:25 UTC (rev 20063)
@@ -578,7 +578,7 @@
       pkgs.pkgconfig
     ]; #(autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux apacheAnt;
+      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt;
       requires = svnRequires;
     };
 



From R.B.Vermaas at tudelft.nl  Thu Oct  1 16:10:48 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 14:10:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20064 - rob -
	hydra/strategoxt
Message-ID: <200910011410.n91EAm78015871@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 14:10:48 +0000 (Thu, 01 Oct 2009)
New Revision: 20064

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20064&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
turn off make check for darwin build of pil for now

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 14:03:25 UTC (rev 20063)
+++ hydra/strategoxt/packages.nix	2009-10-01 14:10:48 UTC (rev 20064)
@@ -572,14 +572,15 @@
       packageName = "pil";
       attrPrefix = "pil";
       svnBuildInputs = buildInputs ++ [
-      pkgs.autoconf
-      pkgs.automake110x
-      pkgs.libtool_1_5
-      pkgs.pkgconfig
-    ]; #(autotools pkgs);
+          pkgs.autoconf
+          pkgs.automake110x
+          pkgs.libtool_1_5
+          pkgs.pkgconfig
+        ]; 
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
       buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt;
       requires = svnRequires;
+      checkSupported = pkgs.stdenv.isLinux pkgs;
     };
 
   /**



From R.B.Vermaas at tudelft.nl  Thu Oct  1 16:12:25 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 01 Oct 2009 14:12:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20065 - rob - hydra
Message-ID: <200910011412.n91ECP51015888@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-01 14:12:25 +0000 (Thu, 01 Oct 2009)
New Revision: 20065

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20065&view=rev

Modified:
   hydra/build.nix

Log:
propagate checksupported attribute

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-01 14:10:48 UTC (rev 20064)
+++ hydra/build.nix	2009-10-01 14:12:25 UTC (rev 20065)
@@ -38,6 +38,8 @@
           if (spec pkgs) ? makeDistRequiresInstall then !((spec pkgs).makeDistRequiresInstall) else true;
         distTarget =
           if (spec pkgs) ? makeDistcheckSupported then "distcheck" else "dist";  
+        doCheck =
+          if (spec pkgs) ? checkSupported then (spec pkgs).checkSupported else true;
  
         tarballs = "*.tar.gz";
       });



From R.B.Vermaas at tudelft.nl  Fri Oct  2 09:56:10 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 07:56:10 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20066 - rob -
	hydra/strategoxt
Message-ID: <200910020756.n927uAZg027661@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 07:56:10 +0000 (Fri, 02 Oct 2009)
New Revision: 20066

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20066&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
added openjdk to deps on debian builds for pil

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-01 14:12:25 UTC (rev 20065)
+++ hydra/strategoxt/packages.nix	2009-10-02 07:56:10 UTC (rev 20066)
@@ -581,6 +581,27 @@
       buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt;
       requires = svnRequires;
       checkSupported = pkgs.stdenv.isLinux pkgs;
+
+      extraVirtualDebs =
+       let vdebs = [ "openjdk-6-jdk" ] ; in
+       {
+         debian40i386 = vdebs ;
+         debian50i386 = vdebs ;
+         ubuntu804i386 = vdebs ;
+         ubuntu810i386 = vdebs ;
+         ubuntu904i386 = vdebs ;
+       };
+
+      extraVirtualRPMs =
+       let vrpms = [ ] ; in
+       {
+         fedora5i386 = vrpms ;
+         fedora9i386 = vrpms ;
+         fedora10i386 = vrpms ;
+         fedora11i386 = vrpms ;
+         opensuse103i386 = vrpms ;
+         opensuse110i386 = vrpms ;
+       };
     };
 
   /**



From R.B.Vermaas at tudelft.nl  Fri Oct  2 09:57:23 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 07:57:23 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20067 - rob - hydra/jobs
Message-ID: <200910020757.n927vNh9027668@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 07:57:23 +0000 (Fri, 02 Oct 2009)
New Revision: 20067

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20067&view=rev

Modified:
   hydra/jobs/pil.nix

Log:
enable debian builds for pil

Changes:

Modified: hydra/jobs/pil.nix
===================================================================
--- hydra/jobs/pil.nix	2009-10-02 07:56:10 UTC (rev 20066)
+++ hydra/jobs/pil.nix	2009-10-02 07:57:23 UTC (rev 20067)
@@ -15,6 +15,8 @@
         inherit hydraConfig ;
         inherit baselineNix ;
         inherit nixpkgs; 
+        makeDebs = true;
+#        makeRPMs = true;
       } ; 
    
       spec = specs.pil ; 



From R.B.Vermaas at tudelft.nl  Fri Oct  2 10:03:07 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 08:03:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20068 - rob -
	hydra/strategoxt
Message-ID: <200910020803.n92837nx027920@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 08:03:06 +0000 (Fri, 02 Oct 2009)
New Revision: 20068

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20068&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
use jdk 5 on debian for pil debian build

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 07:57:23 UTC (rev 20067)
+++ hydra/strategoxt/packages.nix	2009-10-02 08:03:06 UTC (rev 20068)
@@ -585,7 +585,7 @@
       extraVirtualDebs =
        let vdebs = [ "openjdk-6-jdk" ] ; in
        {
-         debian40i386 = vdebs ;
+         debian40i386 = [ "sun-java5-jdk" ] ;
          debian50i386 = vdebs ;
          ubuntu804i386 = vdebs ;
          ubuntu810i386 = vdebs ;



From R.B.Vermaas at tudelft.nl  Fri Oct  2 10:07:03 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 08:07:03 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20069 - rob -
	hydra/strategoxt
Message-ID: <200910020807.n92873PH027941@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 08:07:03 +0000 (Fri, 02 Oct 2009)
New Revision: 20069

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20069&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
use jdk 6 on debian for pil debian build >= 4.0

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 08:03:06 UTC (rev 20068)
+++ hydra/strategoxt/packages.nix	2009-10-02 08:07:03 UTC (rev 20069)
@@ -583,7 +583,7 @@
       checkSupported = pkgs.stdenv.isLinux pkgs;
 
       extraVirtualDebs =
-       let vdebs = [ "openjdk-6-jdk" ] ; in
+       let vdebs = [ "sun-java6-jdk" ] ; in
        {
          debian40i386 = [ "sun-java5-jdk" ] ;
          debian50i386 = vdebs ;



From R.B.Vermaas at tudelft.nl  Fri Oct  2 10:11:47 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 08:11:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20070 - rob -
	hydra/strategoxt
Message-ID: <200910020811.n928BlcB027980@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 08:11:47 +0000 (Fri, 02 Oct 2009)
New Revision: 20070

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20070&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 08:07:03 UTC (rev 20069)
+++ hydra/strategoxt/packages.nix	2009-10-02 08:11:47 UTC (rev 20070)
@@ -580,10 +580,10 @@
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
       buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt;
       requires = svnRequires;
-      checkSupported = pkgs.stdenv.isLinux pkgs;
+#      checkSupported = pkgs.stdenv.isLinux pkgs;
 
       extraVirtualDebs =
-       let vdebs = [ "sun-java6-jdk" ] ; in
+       let vdebs = [ "openjdk-6-jdk" ] ; in
        {
          debian40i386 = [ "sun-java5-jdk" ] ;
          debian50i386 = vdebs ;



From R.B.Vermaas at tudelft.nl  Fri Oct  2 10:23:51 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 08:23:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20071 - rob -
	hydra/strategoxt
Message-ID: <200910020823.n928Npdu028206@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 08:23:51 +0000 (Fri, 02 Oct 2009)
New Revision: 20071

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20071&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 08:11:47 UTC (rev 20070)
+++ hydra/strategoxt/packages.nix	2009-10-02 08:23:51 UTC (rev 20071)
@@ -585,10 +585,10 @@
       extraVirtualDebs =
        let vdebs = [ "openjdk-6-jdk" ] ; in
        {
-         debian40i386 = [ "sun-java5-jdk" ] ;
+         debian40i386 = [] ;
          debian50i386 = vdebs ;
-         ubuntu804i386 = vdebs ;
-         ubuntu810i386 = vdebs ;
+         ubuntu804i386 = [] ;
+         ubuntu810i386 = [] ;
          ubuntu904i386 = vdebs ;
        };
 



From R.B.Vermaas at tudelft.nl  Fri Oct  2 10:25:41 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 08:25:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20072 - rob -
	hydra/strategoxt
Message-ID: <200910020825.n928Pf2u028229@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 08:25:41 +0000 (Fri, 02 Oct 2009)
New Revision: 20072

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20072&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 08:23:51 UTC (rev 20071)
+++ hydra/strategoxt/packages.nix	2009-10-02 08:25:41 UTC (rev 20072)
@@ -583,7 +583,7 @@
 #      checkSupported = pkgs.stdenv.isLinux pkgs;
 
       extraVirtualDebs =
-       let vdebs = [ "openjdk-6-jdk" ] ; in
+       let vdebs = [ "lzma" "openjdk-6-jdk" ] ; in
        {
          debian40i386 = [] ;
          debian50i386 = vdebs ;



From R.B.Vermaas at tudelft.nl  Fri Oct  2 10:29:53 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 08:29:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20073 - rob -
	hydra/strategoxt
Message-ID: <200910020829.n928TrjH028255@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 08:29:53 +0000 (Fri, 02 Oct 2009)
New Revision: 20073

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20073&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 08:25:41 UTC (rev 20072)
+++ hydra/strategoxt/packages.nix	2009-10-02 08:29:53 UTC (rev 20073)
@@ -583,7 +583,7 @@
 #      checkSupported = pkgs.stdenv.isLinux pkgs;
 
       extraVirtualDebs =
-       let vdebs = [ "lzma" "openjdk-6-jdk" ] ; in
+       let vdebs = [ "lzma" "openjdk-6-jre" "openjdk-6-jdk" ] ; in
        {
          debian40i386 = [] ;
          debian50i386 = vdebs ;



From R.B.Vermaas at tudelft.nl  Fri Oct  2 12:45:52 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 10:45:52 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20074 - rob -
	hydra/strategoxt
Message-ID: <200910021045.n92AjrZm030083@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 10:45:52 +0000 (Fri, 02 Oct 2009)
New Revision: 20074

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20074&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
add ant to debian deps

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 08:29:53 UTC (rev 20073)
+++ hydra/strategoxt/packages.nix	2009-10-02 10:45:52 UTC (rev 20074)
@@ -583,7 +583,7 @@
 #      checkSupported = pkgs.stdenv.isLinux pkgs;
 
       extraVirtualDebs =
-       let vdebs = [ "lzma" "openjdk-6-jre" "openjdk-6-jdk" ] ; in
+       let vdebs = [ "lzma" "openjdk-6-jre" "openjdk-6-jdk" "ant" ] ; in
        {
          debian40i386 = [] ;
          debian50i386 = vdebs ;



From R.B.Vermaas at tudelft.nl  Fri Oct  2 12:58:17 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 10:58:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20075 - rob -
	hydra/strategoxt
Message-ID: <200910021058.n92AwH70030303@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 10:58:17 +0000 (Fri, 02 Oct 2009)
New Revision: 20075

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20075&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 10:45:52 UTC (rev 20074)
+++ hydra/strategoxt/packages.nix	2009-10-02 10:58:17 UTC (rev 20075)
@@ -587,8 +587,8 @@
        {
          debian40i386 = [] ;
          debian50i386 = vdebs ;
-         ubuntu804i386 = [] ;
-         ubuntu810i386 = [] ;
+         ubuntu804i386 = vdebs ;
+         ubuntu810i386 = vdebs ;
          ubuntu904i386 = vdebs ;
        };
 



From R.B.Vermaas at tudelft.nl  Fri Oct  2 12:59:26 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 10:59:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20076 - rob -
	hydra/strategoxt
Message-ID: <200910021059.n92AxQVR030314@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 10:59:26 +0000 (Fri, 02 Oct 2009)
New Revision: 20076

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20076&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 10:58:17 UTC (rev 20075)
+++ hydra/strategoxt/packages.nix	2009-10-02 10:59:26 UTC (rev 20076)
@@ -587,7 +587,7 @@
        {
          debian40i386 = [] ;
          debian50i386 = vdebs ;
-         ubuntu804i386 = vdebs ;
+         ubuntu804i386 = [] ;
          ubuntu810i386 = vdebs ;
          ubuntu904i386 = vdebs ;
        };



From R.B.Vermaas at tudelft.nl  Fri Oct  2 13:01:41 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 11:01:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20077 - rob - hydra
Message-ID: <200910021101.n92B1f21030541@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 11:01:41 +0000 (Fri, 02 Oct 2009)
New Revision: 20077

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20077&view=rev

Modified:
   hydra/build.nix

Log:
turn off some rpms'

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-02 10:59:26 UTC (rev 20076)
+++ hydra/build.nix	2009-10-02 11:01:41 UTC (rev 20077)
@@ -38,8 +38,6 @@
           if (spec pkgs) ? makeDistRequiresInstall then !((spec pkgs).makeDistRequiresInstall) else true;
         distTarget =
           if (spec pkgs) ? makeDistcheckSupported then "distcheck" else "dist";  
-        doCheck =
-          if (spec pkgs) ? checkSupported then (spec pkgs).checkSupported else true;
  
         tarballs = "*.tar.gz";
       });
@@ -247,8 +245,8 @@
        '' ;
 
 
-  deb_variants = if makeDebs then [ "debian40i386" "debian50i386" "ubuntu804i386" "ubuntu810i386" "ubuntu904i386"] else [] ;
-  rpm_variants = if makeRPMs then [ "fedora5i386" "fedora9i386" "fedora10i386" "fedora11i386" "opensuse103i386" "opensuse110i386" ] else [] ;
+  deb_variants = if makeDebs then [ "debian50i386" "ubuntu810i386" "ubuntu904i386"] else [] ;
+  rpm_variants = if makeRPMs then [ "fedora10i386" "fedora11i386" "opensuse103i386" "opensuse110i386" ] else [] ;
 
   rpmToNix = rpm :
      pkgsDefault.runCommand



From R.B.Vermaas at tudelft.nl  Fri Oct  2 14:14:54 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 12:14:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20078 - rob -
	hydra/strategoxt
Message-ID: <200910021214.n92CEsJI031257@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 12:14:54 +0000 (Fri, 02 Oct 2009)
New Revision: 20078

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20078&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 11:01:41 UTC (rev 20077)
+++ hydra/strategoxt/packages.nix	2009-10-02 12:14:54 UTC (rev 20078)
@@ -578,7 +578,7 @@
           pkgs.pkgconfig
         ]; 
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt;
+      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt ++ pkgs.lib.optional pkgs.stdenv.isDarwin pkgs.openjdkDarwin;
       requires = svnRequires;
 #      checkSupported = pkgs.stdenv.isLinux pkgs;
 



From R.B.Vermaas at tudelft.nl  Fri Oct  2 14:28:28 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 02 Oct 2009 12:28:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20079 - rob -
	hydra/strategoxt
Message-ID: <200910021228.n92CSSFt031360@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-02 12:28:28 +0000 (Fri, 02 Oct 2009)
New Revision: 20079

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20079&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-02 12:14:54 UTC (rev 20078)
+++ hydra/strategoxt/packages.nix	2009-10-02 12:28:28 UTC (rev 20079)
@@ -578,7 +578,7 @@
           pkgs.pkgconfig
         ]; 
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt ++ pkgs.lib.optional pkgs.stdenv.isDarwin pkgs.openjdkDarwin;
+      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.openjdkDarwin pkgs.antDarwin];
       requires = svnRequires;
 #      checkSupported = pkgs.stdenv.isLinux pkgs;
 



From R.B.Vermaas at tudelft.nl  Mon Oct  5 09:18:44 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Mon, 05 Oct 2009 07:18:44 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20080 - rob - hydra
Message-ID: <200910050718.n957IiG6021519@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-05 07:18:42 +0000 (Mon, 05 Oct 2009)
New Revision: 20080

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20080&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-02 12:28:28 UTC (rev 20079)
+++ hydra/build.nix	2009-10-05 07:18:42 UTC (rev 20080)
@@ -224,8 +224,8 @@
        ((spec pkgs).packageName + "-release.nix" )
        {
          inherit tarball ;
-         rpmnix = map ( v : "    " + v + " = import ${rpmToNix (rpm pkgs v spec tarball)} ; \n" ) rpm_variants ;
-         debnix = map ( v : "    " + v + " = import ${debToNix (deb pkgs v spec tarball)} ; \n" ) deb_variants ;
+         rpmnix = map ( v : "    " + v + " = ${rpm pkgs v spec tarball} ; \n" ) rpm_variants ;
+         debnix = map ( v : "    " + v + " = ${deb pkgs v spec tarball} ; \n" ) deb_variants ;
        }
        ''
          echo "{" >> $out



From R.B.Vermaas at tudelft.nl  Fri Oct  9 14:15:37 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 09 Oct 2009 12:15:37 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20081 - rob -
	strategoxt/trunk
Message-ID: <200910091215.n99CFblv005628@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-09 12:15:34 +0000 (Fri, 09 Oct 2009)
New Revision: 20081

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20081&view=rev

Modified:
   strategoxt/trunk/README

Log:
push

Changes:

Modified: strategoxt/trunk/README
===================================================================
--- strategoxt/trunk/README	2009-10-05 07:18:42 UTC (rev 20080)
+++ strategoxt/trunk/README	2009-10-09 12:15:34 UTC (rev 20081)
@@ -81,7 +81,6 @@
   bugs at strategoxt.org
 
 
-
 Copyright (C) 1998-2009 Eelco Visser
 
   This library is free software; you can redistribute it and/or



From L.C.L.Kats at tudelft.nl  Fri Oct  9 19:11:17 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 09 Oct 2009 17:11:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20082 - LennartKats -
	strc-java/trunk/java
Message-ID: <200910091711.n99HBHX3009582@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-09 17:11:16 +0000 (Fri, 09 Oct 2009)
New Revision: 20082

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20082&view=rev

Modified:
   strc-java/trunk/java/Makefile.am

Log:


Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-09 12:15:34 UTC (rev 20081)
+++ strc-java/trunk/java/Makefile.am	2009-10-09 17:11:16 UTC (rev 20082)
@@ -181,10 +181,10 @@
 runtime/org/strategoxt/lang/compat/override/xtc_compat/Main.java : runtime/org/strategoxt/lang/compat/override/xtc-compat.str ../trans/strj
 	$(STRJ) -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.xtc_compat -la stratego-lib -la stratego-xtc
 
-runtime/org/strategoxt/lang/compat/override/native_calls_compat/Main.java : runtime/org/strategoxt/lang/compat/override/xtc-compat.str ../trans/strj
+runtime/org/strategoxt/lang/compat/override/native_calls_compat/Main.java : runtime/org/strategoxt/lang/compat/override/native-calls-compat.str ../trans/strj
 	$(STRJ) -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.native_calls_compat -la stratego-lib -la stratego-xtc
 
-runtime/org/strategoxt/lang/compat/override/java_integration/Main.java : runtime/org/strategoxt/lang/compat/override/xtc-compat.str ../trans/strj
+runtime/org/strategoxt/lang/compat/override/java_integration/Main.java : runtime/org/strategoxt/lang/compat/override/java-integration.str ../trans/strj
 	$(STRJ) -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.java_integration -la stratego-lib -la stratego-xtc
 
 runtime/org/strategoxt/lang/compat/override/strc_compat/Main.java : runtime/org/strategoxt/lang/compat/override/strc-compat.str ../trans/strj runtime/org/strategoxt/lang/parallel/stratego_parallel/libstratego-parallel.rtree



From L.C.L.Kats at tudelft.nl  Mon Oct 12 14:29:54 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 12 Oct 2009 12:29:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20083 - LennartKats -
	in spoofax/trunk/spoofax:
	org.spoofax.compiler/src/java/org/spoofax/compiler
	org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core
	org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl
Message-ID: <200910121229.n9CCTswt000614@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-12 12:29:54 +0000 (Mon, 12 Oct 2009)
New Revision: 20083

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20083&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.compiler/src/java/org/spoofax/compiler/Main.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/StackTracer.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_copy.java

Log:


Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.compiler/src/java/org/spoofax/compiler/Main.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.compiler/src/java/org/spoofax/compiler/Main.java	2009-10-09 17:11:16 UTC (rev 20082)
+++ spoofax/trunk/spoofax/org.spoofax.compiler/src/java/org/spoofax/compiler/Main.java	2009-10-12 12:29:54 UTC (rev 20083)
@@ -31,7 +31,7 @@
             } else if(arg.equals("-i")) {
                 toCompile = args[i+1];
                 skip++;
-            } else if(args.equals("-o")) {
+            } else if(arg.equals("-o")) {
                 outFile = args[i+1];
                 skip++;
             }

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/StackTracer.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/StackTracer.java	2009-10-09 17:11:16 UTC (rev 20082)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/StackTracer.java	2009-10-12 12:29:54 UTC (rev 20083)
@@ -101,7 +101,7 @@
      */
     public void printStackTrace(boolean onlyCurrent) {
         int depth = onlyCurrent ? currentDepth : failureDepth;
-        String[] frames = this.frames; // avoid _some_ race conditions
+        String[] frames = this.frames.clone(); // avoid _most_ race conditions (for UncaughtExceptionHandler)
         
         for (int i = 0; i < depth; i++) {
             if (i == MAX_REPORTED_FRAMES - MAX_REPORTED_FRAMES_TAIL) {

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_copy.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_copy.java	2009-10-09 17:11:16 UTC (rev 20082)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_copy.java	2009-10-12 12:29:54 UTC (rev 20083)
@@ -89,7 +89,7 @@
             if (closeOut) fos.close();
             if (closeIn) fis.close();
         } catch(IOException e) {
-            agent.getOutputStream(IOAgent.CONST_STDERR).println("SSL_copy: Could not copy file " + e.getMessage());
+            agent.getOutputStream(IOAgent.CONST_STDERR).println("SSL_copy: Could not copy file (" + e.getMessage() + ")");
             return false;
         }
         



From L.C.L.Kats at tudelft.nl  Mon Oct 12 15:01:47 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 12 Oct 2009 13:01:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20084 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.generator/src/syntax
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <200910121301.n9CD1lPC001056@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-12 13:01:47 +0000 (Mon, 12 Oct 2009)
New Revision: 20084

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20084&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Stratego-Java-EditorService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	2009-10-12 12:29:54 UTC (rev 20083)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	2009-10-12 13:01:47 UTC (rev 20084)
@@ -115,6 +115,7 @@
                 <arg value="${basedir}/include/${sdfmodule}.def"/>
                 <arg value="-o"/>
                 <arg value="${basedir}/include/${sdfmodule}-Permissive.def"/>
+                <arg line="--optimize on"/>
             </java>
         </target>
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Stratego-Java-EditorService.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Stratego-Java-EditorService.sdf	2009-10-12 12:29:54 UTC (rev 20083)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Stratego-Java-EditorService.sdf	2009-10-12 13:01:47 UTC (rev 20084)
@@ -1,10 +1,6 @@
 module Stratego-Java-EditorService
 imports
-  StrategoMix[StrategoHost]	
-
-  languages/java/EmbeddedJavaMix[Java Term[[StrategoHost]]]
-  languages/java/eblock/JavaEBlockMix[Java]
-  
+  Stratego-Java-EBlock
   EditorService
   
 %%Comments[Section]

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java	2009-10-12 12:29:54 UTC (rev 20083)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java	2009-10-12 13:01:47 UTC (rev 20084)
@@ -1,5 +1,6 @@
 package org.strategoxt.imp.metatooling.wizards;
 
+import java.io.File;
 import java.io.IOException;
 import java.lang.reflect.InvocationTargetException;
 
@@ -121,7 +122,12 @@
 				String jar1 = org.strategoxt.stratego_lib.Main.class.getProtectionDomain().getCodeSource().getLocation().getFile();
 				String jar2 = make_permissive.class.getProtectionDomain().getCodeSource().getLocation().getFile();
 				String jar3 = sdf2imp.class.getProtectionDomain().getCodeSource().getLocation().getFile();
-				assert jar1.endsWith(".jar") && jar2.endsWith(".jar") && jar3.endsWith(".jar");
+				// HACK: find jars at development time after 'make'
+				if (!jar1.endsWith(".jar")) {
+					String jar1a = jar1 + "/../strategoxt.jar";
+					if (new File(jar1a).exists()) jar1 = jar1a;
+				}
+				assert jar1.endsWith(".jar") && jar2.endsWith(".jar") && jar3.endsWith(".jar") : "Library files are not in JAR"; // please refresh the strj projectin Eclipse
 				sdf2imp.mainNoExit(context, "-m", languageName, "-pn", projectName, "-n", packageName, "-e", extensions, "-jar", jar1, jar2, jar3);
 			} catch (StrategoErrorExit e) {
 				Environment.logException(e);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java	2009-10-12 12:29:54 UTC (rev 20083)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java	2009-10-12 13:01:47 UTC (rev 20084)
@@ -130,7 +130,7 @@
 		} catch (InterpreterException e) {
 			Environment.logException(new BadDescriptorException("Error loading compiler service provider " + filename, e));
 		} catch (IOException e) {
-			Environment.logException(new BadDescriptorException("Could not load compiler service provider" + filename, e));
+			Environment.logException(new BadDescriptorException("Could not load compiler service provider " + filename, e));
 		}
 	}
 	
@@ -220,10 +220,11 @@
 			log = ((LoggingIOAgent) runtime.getIOAgent()).getLog().trim();
 		}
 		
-		synchronized (feedback) {
+		// TODO: figure out how this was supposed to be synchronized
+		// synchronized (feedback) {
 			if (!monitor.isCanceled())
 				presentToUser((ISourceInfo) parseController, feedback, log);
-		}
+		// }
 	}
 	
 	/* UNDONE: asynchronous feedback presentation



From R.B.Vermaas at tudelft.nl  Wed Oct 14 10:58:09 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 14 Oct 2009 08:58:09 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20085 - rob -
	hydra/strategoxt
Message-ID: <200910140858.n9E8w9rf003314@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-14 08:58:09 +0000 (Wed, 14 Oct 2009)
New Revision: 20085

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20085&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
pass openjdk for strc-java on darwin

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-12 13:01:47 UTC (rev 20084)
+++ hydra/strategoxt/packages.nix	2009-10-14 08:58:09 UTC (rev 20085)
@@ -421,7 +421,10 @@
       svnBuildInputs = buildInputs ++ (autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
 
-      buildInputs = [pkgs.pkgconfig pkgs.unzip pkgs.zlib pkgs.ecj pkgs.which pkgs.jdk];
+      buildInputs = 
+        [pkgs.pkgconfig pkgs.unzip pkgs.zlib pkgs.which] 
+        ++ pkgs.lib.optional pkgs.stdenv.isLinux [pkgs.ecj pkgs.jdk] 
+        ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.openjdkDarwin];
       requires = svnRequires;
 
       rpmBuildSupported = true;



From L.C.L.Kats at tudelft.nl  Wed Oct 14 11:33:05 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 09:33:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20086 - LennartKats -
	strc-java/trunk/java
Message-ID: <200910140933.n9E9X5DE003919@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 09:33:05 +0000 (Wed, 14 Oct 2009)
New Revision: 20086

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20086&view=rev

Modified:
   strc-java/trunk/java/Makefile.am

Log:


Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-14 08:58:09 UTC (rev 20085)
+++ strc-java/trunk/java/Makefile.am	2009-10-14 09:33:05 UTC (rev 20086)
@@ -52,6 +52,7 @@
   $(wildcard runtime/org/strategoxt/*/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*/*.str) \
   spoofax-libs.jar \
+  bin \
   META-INF/MANIFEST.MF
 
 CLEANFILES = \



From L.C.L.Kats at tudelft.nl  Wed Oct 14 11:59:33 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 09:59:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20087 - LennartKats -
	strc-java/trunk/trans
Message-ID: <200910140959.n9E9xX47004106@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 09:59:33 +0000 (Wed, 14 Oct 2009)
New Revision: 20087

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20087&view=rev

Modified:
   strc-java/trunk/trans/s2j-options.str

Log:
Fixed an error about option -la which does not follow the format packagename.ClassName

Changes:

Modified: strc-java/trunk/trans/s2j-options.str
===================================================================
--- strc-java/trunk/trans/s2j-options.str	2009-10-14 09:33:05 UTC (rev 20086)
+++ strc-java/trunk/trans/s2j-options.str	2009-10-14 09:59:33 UTC (rev 20087)
@@ -24,7 +24,7 @@
   + ArgOption(
       "-la"
     , if is-substring(!"/") + is-substring(!"\\") then
-        warn(|"Ignoring library import: must follow format packagename.ClassName")
+        warn(|"Ignoring library import: must be a Java package name")
       else
         <post-extend-config> ("-la", [<translate-default-library>]); !()
       end
@@ -91,9 +91,6 @@
 
       case "stratego-parallel":
         <conc-strings> ("org.strategoxt.lang.parallel.", <id>)
-
-      case not(is-substring(!".")):
-        err(|"Imported libraries must follow format packagename.ClassName"); fail
       
       otherwise:
         jify



From L.C.L.Kats at tudelft.nl  Wed Oct 14 14:43:27 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 12:43:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20088 - LennartKats -
	in strc-java/trunk: . java java/runtime/org/strategoxt/lang
	java/runtime/org/strategoxt/lang/compat
	java/runtime/org/strategoxt/lang/compat/override
	java/runtime/org/strategoxt/lang/parallel/collections
	java/runtime/org/strategoxt/lang/parallel/stratego_parallel
	tools trans
Message-ID: <200910141243.n9EChRC9006485@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 12:43:27 +0000 (Wed, 14 Oct 2009)
New Revision: 20088

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20088&view=rev

Added:
   strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/InteropRegisterer.java
Modified:
   strc-java/trunk/AUTHORS
   strc-java/trunk/README
   strc-java/trunk/configure.ac
   strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_at_end_1_0.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/native-calls-compat.str
   strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/collections/ParallelCollectionLibrary.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelAll.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJob.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJobExecutor.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/stratego_parallel.java
   strc-java/trunk/java/spoofax-libs.jar
   strc-java/trunk/tools/strj-jar
   strc-java/trunk/trans/s2j.str
   strc-java/trunk/trans/strj-options.str

Log:
Stuff.

Changes:

Modified: strc-java/trunk/AUTHORS
===================================================================
--- strc-java/trunk/AUTHORS	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/AUTHORS	2009-10-14 12:43:27 UTC (rev 20088)
@@ -1,7 +1,7 @@
 STRJ and the Stratego/J runtime have been developed by:
 
-* Lennart Kats (main strj development; Stratego/J compatibility components)
-* Karl Trygve Kalleberg (Stratego/J runtime; original s2j prototype)
+* Lennart Kats (main STRJ development; Stratego/J compatibility components)
+* Karl Trygve Kalleberg (main Stratego/J and JSGLR development; original s2j prototype)
 * Valentin David (Stratego/J runtime)
 
 The development of STRJ would not have been possible without the

Modified: strc-java/trunk/README
===================================================================
--- strc-java/trunk/README	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/README	2009-10-14 12:43:27 UTC (rev 20088)
@@ -44,9 +44,11 @@
   java -cp plugins/org.eclipse.jdt.core_*.jar  org.eclipse.jdt.internal.compiler.batch.Main
 
 Many Linux distributions also provide a stand-alone version of ECJ
-through their package manager. When using the Sun compiler, you may
-need to add option -J-mx256m to increase the available heap space, and
-likely need to have a fair amount of patience ;)
+through their package manager.  (Note that ECJ 3.3 and lower have a
+bug that can be worked around with the -Xecj33 flag.) When using the
+Sun compiler, you may need to add option -J-mx256m to increase the
+available heap space, and likely need to have a fair amount of
+patience ;)
 
 Stratego programs compiled to Java do not have the same performance
 characteristics as those compiled using the native Stratego compiler
@@ -64,6 +66,8 @@
 overflow problem. (When this parameter is not set and a stack overflow
 occurs, compiled applications will hint at this setting.)
 
+XTC is not supported at this time. Also see the next section.
+
 USING EXTERNAL APPLICATIONS AND LIBRARIES
 =========================================
 

Modified: strc-java/trunk/configure.ac
===================================================================
--- strc-java/trunk/configure.ac	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/configure.ac	2009-10-14 12:43:27 UTC (rev 20088)
@@ -1,5 +1,5 @@
 AC_PREREQ([2.58])
-AC_INIT([strc-java],[0.2],[stratego-bugs at cs.uu.nl])
+AC_INIT([strc-java],[0.2],[bugs at strategoxt.org])
 AM_INIT_AUTOMAKE
 
 # set the prefix immediately to the default prefix

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -151,7 +151,7 @@
     	
     	// Launch with a clean operand stack when launched from SSL_java_call, Ant, etc.
     	if (new Exception().getStackTrace().length > 20) {
-    		return strategy.invokeStackFriendly(this, term, NO_STRATEGIES, NO_TERMS);
+    		return new StackSaver(strategy).invokeStackFriendly(this, term, NO_STRATEGIES, NO_TERMS);
     	} else {
     		return strategy.invoke(this, term);
     	}

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_at_end_1_0.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_at_end_1_0.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_at_end_1_0.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -19,26 +19,34 @@
 	
 	@Override
 	public IStrategoTerm invoke(Context context, IStrategoTerm current, Strategy s) {
+		// context.push("at_end_1_0"); // DEBUG
+		
+		// DEBUG
+		//if (StackSaver.isNeededFor(context))
+		//	new StackSaver(this).invokeStackFriendly(context, current, new Strategy[] { s }, NO_TERMS);
+		
 		if (current.getTermType() != LIST)
 			return null;
 		
 		IStrategoList list = (IStrategoList) current;
 		IStrategoTerm[] listItems = new IStrategoTerm[list.size()];
-		IStrategoList cons = list;
 		
 		for (int i = 0; i < listItems.length; i++) {
-			if (!cons.getAnnotations().isEmpty()) {
-				IStrategoList tail = atEndMaintainAnnos(context, cons, s);
+			if (!list.getAnnotations().isEmpty()) {
+				IStrategoList tail = atEndMaintainAnnos(context, list, s);
 				return tail == null ? null : concat(context, listItems, i, tail);
 			}
-			listItems[i] = cons.head();
-			cons = cons.tail();
+			listItems[i] = list.head();
+			list = list.tail();
 		}
 		
 		IStrategoTerm tail = context.getFactory().makeList();
 		tail = s.invoke(context, tail);
-		if (tail == null || checkListTail(tail) == null)
+		if (tail == null || checkListTail(tail) == null) {
+			//context.popOnFailure(); // DEBUG
 			return null;
+		}
+		//context.popOnSuccess(); // DEBUG
 		return concat(context, listItems, listItems.length, (IStrategoList) tail);
 	}
 	

Added: strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java	                        (rev 0)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -0,0 +1,82 @@
+package org.strategoxt.lang;
+
+import static org.strategoxt.lang.Term.*;
+
+import java.util.concurrent.Callable;
+import java.util.concurrent.ExecutionException;
+import java.util.concurrent.FutureTask;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class StackSaver extends SRTS_all { // DEBUG: SRTS_all superclass
+	
+	public static int MAX_DEPTH = 1000;
+	
+	private static int activeThreadDepth; // FIXME: not thread-safe
+ 	
+	private final Strategy strategy;
+	
+	public StackSaver(Strategy s) {
+		strategy = s;
+	}
+	
+	public static boolean isNeededFor(Context context) {
+		int depth = context.getTraceDepth(true);
+		return depth - activeThreadDepth > MAX_DEPTH;
+	}
+	
+	// TODO: implement other invoke() overloads
+	
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current) {
+		if (isNeededFor(context)) {
+			return invokeStackFriendly(context, current, NO_STRATEGIES, NO_TERMS);
+		} else {
+			return super.invoke(context, current);
+		}
+	}
+	
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm current, Strategy s) {
+		if (isNeededFor(context)) {
+			return invokeStackFriendly(context, current, new Strategy[] { s }, NO_TERMS);
+		} else {
+			return super.invoke(context, current, s);
+		}
+	}
+	
+	/**
+	 * Invokes this strategy in a new thread, and then joins it waiting for the result.
+	 * This way, the strategy has a clean operand stack to its disposal,
+	 * reducing the risk of throwing a StackOverflowError.
+	 * 
+	 * @return The resulting term, or null in case of failure.
+	 */
+	public IStrategoTerm invokeStackFriendly(final Context context, final IStrategoTerm current, final Strategy[] s, final IStrategoTerm[] t) {
+		int startDepth = context.getTraceDepth(true);
+		System.out.println("FREIND!" + strategy.getName() + "!" + startDepth); // DEBUG
+		activeThreadDepth += startDepth;
+		final FutureTask<IStrategoTerm> result = new FutureTask<IStrategoTerm>(new Callable<IStrategoTerm>() {
+			public IStrategoTerm call() throws Exception {
+				return strategy.invokeDynamic(context, current, s, t);
+			}
+    	});
+		new Thread(result).start();
+		try {
+			return result.get();
+		} catch (ExecutionException e) {
+			if (e.getCause() instanceof RuntimeException)
+				throw (RuntimeException) e.getCause();
+			if (e.getCause() instanceof Error)
+				throw (Error) e.getCause();
+			throw new StrategoException("Unexpected exception", e);
+		} catch (InterruptedException e) {
+			throw new RuntimeException(e);
+		} finally {
+			activeThreadDepth -= startDepth;
+		}
+    }
+}

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -93,34 +93,6 @@
 		throw new IllegalArgumentException(s, t);
 	}
 	
-	/**
-	 * Invokes this strategy in a new thread, and then joins it waiting for the result.
-	 * This way, the strategy has a clean operand stack to its disposal,
-	 * reducing the risk of throwing a StackOverflowError.
-	 * 
-	 * @return The resulting term, or null in case of failure.
-	 */
-	@Deprecated // TODO: Move to separate class
-	public IStrategoTerm invokeStackFriendly(final Context context, final IStrategoTerm current, final Strategy[] s, final IStrategoTerm[] t) {
-		final FutureTask<IStrategoTerm> result = new FutureTask<IStrategoTerm>(new Callable<IStrategoTerm>() {
-			public IStrategoTerm call() throws Exception {
-				return invokeDynamic(context, current, s, t);
-			}
-    	});
-		new Thread(result).start();
-		try {
-			return result.get();
-		} catch (ExecutionException e) {
-			if (e.getCause() instanceof RuntimeException)
-				throw (RuntimeException) e.getCause();
-			if (e.getCause() instanceof Error)
-				throw (Error) e.getCause();
-			throw new StrategoException("Unexpected exception", e);
-		} catch (InterruptedException e) {
-			throw new RuntimeException(e);
-		}
-    }
-
 	public IStrategoTerm invoke(Context context, IStrategoTerm current) {
 		throw new IllegalArgumentException();
 	}

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -6,10 +6,8 @@
 import org.spoofax.interpreter.adapter.aterm.WrappedATermFactory;
 import org.spoofax.interpreter.library.jsglr.JSGLRLibrary;
 import org.strategoxt.lang.Context;
-import org.strategoxt.lang.compat.override.jsglr_parser.jsglr_parser;
-import org.strategoxt.lang.compat.override.jsglr_parser_compat.jsglr_parser_compat;
-import org.strategoxt.lang.compat.override.performance_tweaks.performance_tweaks;
-import org.strategoxt.lang.compat.override.xtc_compat.xtc_compat;
+import org.strategoxt.lang.SRTS_all;
+import org.strategoxt.lang.StackSaver;
 import org.strategoxt.lang.compat.sglr.SGLRCompatLibrary;
 
 /**
@@ -49,6 +47,8 @@
 	public void activateComponent(String component) {
 		if ("stratego_lib".equals(component)) {
 			context.addOperatorRegistry(new CompatLibrary());
+			// DEBUG
+			// SRTS_all.instance = new StackSaver(SRTS_all.instance);
 		} else if ("stratego_sglr".equals(component)) {
 			WrappedATermFactory atermFactory = new WrappedATermFactory();
 			context.addOperatorRegistry(new JSGLRLibrary(atermFactory));


Property changes on: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override
___________________________________________________________________
Modified: svn:ignore
   - jsglr_parser_compat
jsglr_parser
libstratego_aterm_compat
performance_tweaks
strc_compat
xtc_compat

   + jsglr_parser_compat
jsglr_parser
libstratego_aterm_compat
performance_tweaks
strc_compat
xtc_compat
java_integration
native_calls_compat


Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str	2009-10-14 12:43:27 UTC (rev 20088)
@@ -82,7 +82,9 @@
 
 strategies // location information
 
-  override asfix-anno-location = // TODO: asfix-anno-location?
+  override asfix-anno-location =
+    // TODO: asfix-anno-location?
+    // TODO: asfix-anno-location should be a (fatal?) error by default
     AsfixAnnoLocationWarned
   <+
     rules(AsfixAnnoLocationWarned: _);

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/native-calls-compat.str
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/native-calls-compat.str	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/native-calls-compat.str	2009-10-14 12:43:27 UTC (rev 20088)
@@ -27,3 +27,9 @@
     log(|Info(), ["Calling external tool ", program, " ", <try(separate-by(|" "); concat-strings)> args]);
     prim("SSL_EXT_call", program, args) => 0
 
+  override fork(child) =
+    fatal-err(|"Forking of applications is not supported on Java at this time")
+
+  override fork(child, parent) =
+    fatal-err(|"Forking of applications is not supported on Java at this time")
+

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/collections/ParallelCollectionLibrary.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/collections/ParallelCollectionLibrary.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/collections/ParallelCollectionLibrary.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -53,7 +53,6 @@
 		add(new ParallelRead(this, new SSL_indexedSet_elements()));
 		add(new ParallelRead(this, new SSL_indexedSet_reset()));
 		add(new ParallelRead(this, new SSL_indexedSet_destroy()));
-		throw new IllegalStateException("we're actually using this");
 	}
 	
 	public void invalidateReads(Object collection) {

Added: strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/InteropRegisterer.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/InteropRegisterer.java	                        (rev 0)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/InteropRegisterer.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -0,0 +1,21 @@
+package org.strategoxt.lang.parallel.stratego_parallel;
+
+import org.spoofax.interpreter.core.IContext;
+import org.strategoxt.lang.Context;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class InteropRegisterer extends org.strategoxt.lang.InteropRegisterer {
+
+	@Override
+	public void register(IContext context, Context compiledContext) {
+		// TODO: stratego_parallel InteropRegisterer
+	}
+
+	@Override
+	public void registerLazy(IContext context, Context compiledContext, ClassLoader classLoader) {
+		// TODO: stratego_parallel InteropRegisterer
+	}
+
+}

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelAll.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelAll.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelAll.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -110,16 +110,20 @@
 				final int index = i;
 				ParallelJob job = new ParallelJob(context, s, inputs, outputs, focusIndex, isAborted, lastSynchronousOperation, lastException, allowUnordered, index, jobLength, parallelismLevel.get());
 				
-				if (firstJob == null) {
+				if (DEFAULT_MAX_THREADS == 1) {
+					job.run();
+				} else if (firstJob == null) {
 					firstJob = job;
 				} else {
 					executor.execute(job);
 				}
 			}
 			
-			firstJob.run();
-			executor.join();
-			firstJob.waitForCompletedFocusIndex();
+			if (DEFAULT_MAX_THREADS != 1) {
+				firstJob.run();
+				executor.join();
+				firstJob.waitForCompletedFocusIndex();
+			}
 		} catch (InterruptedException e) {
 			throw new RuntimeException(e);
 		} finally {

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJob.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJob.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJob.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -121,20 +121,30 @@
 	private void updateFocusIndex() {
 		if (focusIndex.get() == COMPLETED_FOCUS_INDEX) return;
 		
+		/*
+		// HACK: removed synchronized here for now, using CaS instead
 		// synchronized here ensures ordered writes to 'outputs'
-		synchronized (getFocusIndexMonitor()) {
+		//synchronized (getFocusIndexMonitor()) {
 			int oldFocusIndex = focusIndex.get();
 			if (oldFocusIndex == COMPLETED_FOCUS_INDEX) return;
+			int currentFocusIndex = oldFocusIndex;
 			int newFocusIndex = oldFocusIndex;
 			
 			while (newFocusIndex < outputs.length) {
 				int lastJob = min(newFocusIndex + jobLength, outputs.length) - 1;
 				if (newFocusIndex > oldFocusIndex) {
-					focusIndex.set(newFocusIndex);
+					// focusIndex.set(newFocusIndex); // HACK
+					while (!focusIndex.compareAndSet(currentFocusIndex, newFocusIndex)) {
+						if (focusIndex.get() > newFocusIndex)
+							return;
+					}
+					currentFocusIndex = newFocusIndex;
 				}
 				if (outputs[lastJob] == null) {
 					if (newFocusIndex > oldFocusIndex) {
+						synchronized (getFocusIndexMonitor()) { // HACK
 						getFocusIndexMonitor().notifyAll();
+						}
 					}
 					return;
 				}
@@ -142,8 +152,12 @@
 			}
 			
 			focusIndex.set(COMPLETED_FOCUS_INDEX);
-			getFocusIndexMonitor().notifyAll();
-		}
+			synchronized (getFocusIndexMonitor()) { // HACK
+				getFocusIndexMonitor().notifyAll();
+			}
+		//}
+		 */
+		focusIndex.set(COMPLETED_FOCUS_INDEX);
 		if (VERBOSE) System.out.print(">");
 	}
 	
@@ -204,6 +218,7 @@
 	}
 
 	private void waitForFocusIndexAndComplain() throws InterruptedException {
+		System.out.print("$?");
 		if (focusIndex.get() < startIndex) {
 			Object monitor = getFocusIndexMonitor();
 			synchronized (monitor) {
@@ -221,6 +236,7 @@
 		for (int i = 0; i < SPINWAIT_CYCLES; i++) {
 			if (focusIndex.get() == COMPLETED_FOCUS_INDEX) return;
 		}
+		System.out.print("$??");
 		Object monitor = getFocusIndexMonitor();
 		synchronized (monitor) {
 			while (focusIndex.get() != COMPLETED_FOCUS_INDEX) {

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJobExecutor.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJobExecutor.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/ParallelJobExecutor.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -1,5 +1,6 @@
 package org.strategoxt.lang.parallel.stratego_parallel;
 
+import static java.lang.Math.*;
 import static org.strategoxt.lang.parallel.stratego_parallel.stratego_parallel.*;
 
 import java.util.concurrent.ArrayBlockingQueue;
@@ -24,7 +25,7 @@
 	private int asyncPoolSize;
 
 	public ParallelJobExecutor() {
-		this(DEFAULT_ACTIVE_THREADS, DEFAULT_MAX_THREADS);
+		this(max(DEFAULT_ACTIVE_THREADS, 2), max(DEFAULT_MAX_THREADS, 2));
 	}
 	
 	public ParallelJobExecutor(int activeThreads, int maxThreads) {

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/stratego_parallel.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/stratego_parallel.java	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/parallel/stratego_parallel/stratego_parallel.java	2009-10-14 12:43:27 UTC (rev 20088)
@@ -10,13 +10,13 @@
 	
 	protected static final boolean ENABLED = true;
 	
-	protected static final boolean VERBOSE = false;
+	protected static final boolean VERBOSE = true;
 	
 	protected static final boolean DIAGNOSE_SYNCHRONOUS_OPERATIONS = false;
 	
-	protected static final int DEFAULT_ACTIVE_THREADS = 2;
+	protected static final int DEFAULT_MAX_THREADS = 8;
 	
-	protected static final int DEFAULT_MAX_THREADS = 2;
+	protected static final int DEFAULT_ACTIVE_THREADS = DEFAULT_MAX_THREADS;
 	
 	protected static final int DEFAULT_TERM_SIZE_THRESHOLD = 3200;
 	
@@ -36,6 +36,8 @@
 		if (isInitialized || !ENABLED) return;
 		isInitialized = true;
 		
+		// TODO: Override (not supplement) the context with the ParallelCollectionLibrary
+		
 		ParallelAll.instance = new ParallelAll();
 		SRTS_all.instance = ParallelAll.instance;
 		

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)

Modified: strc-java/trunk/tools/strj-jar
===================================================================
--- strc-java/trunk/tools/strj-jar	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/tools/strj-jar	2009-10-14 12:43:27 UTC (rev 20088)
@@ -31,6 +31,9 @@
   elif [ "$P" == "-i" ]; then
     INPUT="$1"
     shift
+  elif [ "$P" == "-m" ]; then
+    MAINCLASS="$1"
+    shift
   elif [ "$P" == "-p" ]; then
     PRINT_CLASSPATH=1
   elif [ "$P" == "-o" ]; then
@@ -91,10 +94,15 @@
   echo "$JAVAC -source 5 -nowarn $JAVACFLAGS -cp $CLASSPATH -d \$TEMPDIR $INPUT $INPUT2 $INPUT3"
   $JAVAC -source 5 -nowarn $JAVACFLAGS -cp "$CLASSPATH" -d $TEMPDIR $INPUT $INPUT2 $INPUT3) || exit 1
 
+# TODO: create META-INF file like:
+#
+#   Manifest-Version: 1.0
+#   Main-Class: $MAINCLASS
+#   Class-Path: strategoxt.jar
 ## JARRING
 
 if ls $INPUTDIR/*.str &>/dev/null; then
-  echo "Warning: using this build directory may mean non-term files are included as attachments" >&2
+  echo "WARNING: using this build directory may mean non-term files are included as attachments" >&2
 fi
 
 ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|astr|str|meta|dep|c|lo|o)$' | sed "s!^!-C $INPUTDIR !"` \

Modified: strc-java/trunk/trans/s2j.str
===================================================================
--- strc-java/trunk/trans/s2j.str	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/trans/s2j.str	2009-10-14 12:43:27 UTC (rev 20088)
@@ -31,16 +31,18 @@
     Match : Term * Exp -> Exp
     Offset: Int -> Term
     Frames: List(Term) -> Term
+    Escape: Stm -> Strategy
     
     // stategoxt-annos extension:
-    AnnoDef  : List(Anno) * Def -> Annos
-    Extend   : Anno
-    Override : Anno
-    Internal : Anno
-    Escape   : Stm -> Strategy
+    Override       : Strategy
+    ProceedNoArgs  : Strategy
+    Proceed        : List(Strategy) -> Strategy
+    ProceedT       : List(Strategy) * List(Term) -> Strategy
 
 overlays
 
+  // Number of term/strategy arguments allowed by the default overloads of Strategy.invoke()
+  // The number 5 was chosen mostly to support Aster-generated strategies.
   MAX_STATIC_TARGS = 5
   MAX_STATIC_SARGS = 5
     
@@ -354,7 +356,7 @@
     type-dec |[
        @SuppressWarnings("all")
        public static class x extends Strategy {
-         public static x instance = new x();
+         public static x /*Strategy*/ instance = new x(); // DEBUG
          
          ~body
          ~invokedynamic*
@@ -369,7 +371,7 @@
     type-dec |[
        @SuppressWarnings("all")
        private static final class x' extends x {
-         private static final x outer = x.instance;
+         private static final x proceed = x.instance;
          ~(body)
          @Override public String getName() { return "~x"; }
        }
@@ -378,11 +380,11 @@
       x' := <conc-strings> (x, "_override")
     ; rules(DefInit :+= |[ x.instance = new x'(); ]|)
     with
-      {| OuterInvoke :
+      {| ProceedInvoke :
         e_s* := <translate-args> s*
       ; e_t* := <translate-args> t*
       ; rules(
-          OuterInvoke := |[ outer.invoke(context, term, e_s*, e_t*) ]|
+          ProceedInvoke := |[ proceed.invoke(context, term, e_s*, e_t*) ]|
         )
       ; body := <translate-definition-body> def
       |}
@@ -392,7 +394,7 @@
     type-dec |[
        @SuppressWarnings("all")
        private static final class x' extends x {
-         private static final x outer = x.instance;
+         private static final x proceed = x.instance;
          ~(body)
          @Override public String getName() { return "~x"; }
        }
@@ -401,12 +403,12 @@
       x' := <conc-strings> (x, "_extension")
     ; rules(DefInit :+= |[ x.instance = new x'(); ]|)
     with
-      {| OuterInvoke :
+      {| ProceedInvoke :
         e_s* := <translate-args> s*
       ; e_t* := <translate-args> t*
       ; def' := SDefT(x, s*, t*, GuardedLChoice(s, Id(), Override()))
       ; rules(
-          OuterInvoke := |[ outer.invoke(context, term, e_s*, e_t*) ]|
+          ProceedInvoke := |[ proceed.invoke(context, term, e_s*, e_t*) ]|
         )
       ; body := <translate-definition-body> def'
       |}
@@ -594,14 +596,16 @@
   translate-Platform :
     CallT(SVar("if_c_platform_1_0"), [s], []) ->  Empty()
 
-  translate-Override :
-    Override() ->
+  // TODO: support Proceed(s*, t*)
+
+  translate-Proceed :
+    <ProceedNoArgs() + Override()> -> // TODO: remove "override" strategy keyword
     bstm* |[
       term = e_outer;
       if (term == null) break Fail;
     ]|
     with
-      e_outer := <OuterInvoke>
+      e_outer := <ProceedInvoke>
     <+
       fatal-err(|"override call illegal in this context")
 
@@ -671,7 +675,7 @@
     <+ translate-PrimT
     <+ translate-Id
     <+ translate-Fail
-    <+ translate-Override
+    <+ translate-Proceed
     <+ translate-GuardedLChoice-no-left-branch
     <+ translate-GuardedLChoice
     <+ translate-Scope

Modified: strc-java/trunk/trans/strj-options.str
===================================================================
--- strc-java/trunk/trans/strj-options.str	2009-10-14 09:59:33 UTC (rev 20087)
+++ strc-java/trunk/trans/strj-options.str	2009-10-14 12:43:27 UTC (rev 20088)
@@ -110,7 +110,7 @@
     where(<set-config> ("--help",())); !(),         
     !"-h | --help        Show help")
   <+
-  /* TODO: support -version
+  /* TODO: support -version; see ${SVN_REVISION} and ${VERSION} in Makefile
     Option("-v"+"--version",     
     where(<set-config> ("-v",())); !(),         
     !"-v | --version     Display program's version")



From L.C.L.Kats at tudelft.nl  Wed Oct 14 16:00:30 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 14:00:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20090 - LennartKats -
	in strc-java/trunk: java/runtime/org/strategoxt/lang trans
Message-ID: <200910141400.n9EE0UIr007584@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 14:00:30 +0000 (Wed, 14 Oct 2009)
New Revision: 20090

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20090&view=rev

Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/_Fail.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/_Id.java
   strc-java/trunk/trans/Makefile.am
   strc-java/trunk/trans/backend-simplify.str
   strc-java/trunk/trans/s2j.str
   strc-java/trunk/trans/strj.str

Log:
- Add dollars to capital letters in generated Java files for our Windows/Mac friends
- Support passing id/fail as parametrized strategy arguments

Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/_Fail.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/_Fail.java	2009-10-14 13:02:04 UTC (rev 20089)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/_Fail.java	2009-10-14 14:00:30 UTC (rev 20090)
@@ -5,7 +5,7 @@
 /**
  * @author Lennart Kats <lennart add lclnet.nl>
  */
-public class _Fail extends Strategy {
+public class _Fail extends DynamicStrategy {
 	public static final _Fail instance = new _Fail();
 	
 	private _Fail() {
@@ -16,4 +16,9 @@
 	public IStrategoTerm invoke(Context context, IStrategoTerm current) {
 		return null;
 	}
+	
+	@Override
+	public IStrategoTerm invokeDynamic(Context context, IStrategoTerm current, Strategy[] sargs, IStrategoTerm[] targs) {
+		return null;
+	}
 }

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/_Id.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/_Id.java	2009-10-14 13:02:04 UTC (rev 20089)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/_Id.java	2009-10-14 14:00:30 UTC (rev 20090)
@@ -5,7 +5,7 @@
 /**
  * @author Lennart Kats <lennart add lclnet.nl>
  */
-public class _Id extends Strategy {
+public class _Id extends DynamicStrategy {
 	public static final _Id instance = new _Id();
 	
 	private _Id() {
@@ -16,4 +16,9 @@
 	public IStrategoTerm invoke(Context context, IStrategoTerm current) {
 		return current;
 	}
+	
+	@Override
+	public IStrategoTerm invokeDynamic(Context context, IStrategoTerm current, Strategy[] sargs, IStrategoTerm[] targs) {
+		return current;
+	}
 }

Modified: strc-java/trunk/trans/Makefile.am
===================================================================
--- strc-java/trunk/trans/Makefile.am	2009-10-14 13:02:04 UTC (rev 20089)
+++ strc-java/trunk/trans/Makefile.am	2009-10-14 14:00:30 UTC (rev 20090)
@@ -34,6 +34,8 @@
 %.str : %.astr
 	aster -i $< -o $@
 
+strj.c : $(STRJSOURCES:.str=.rtree)
+
 strj$(exeext) : $(STRJSOURCES:.str=.rtree) libjava-pp.la
 
 strj.ctree : strj.rtree $(STRJSOURCES:.str=.rtree) strj

Modified: strc-java/trunk/trans/backend-simplify.str
===================================================================
--- strc-java/trunk/trans/backend-simplify.str	2009-10-14 13:02:04 UTC (rev 20089)
+++ strc-java/trunk/trans/backend-simplify.str	2009-10-14 14:00:30 UTC (rev 20090)
@@ -19,7 +19,8 @@
   
   backend-simplify =
     dr-scope-all-verbose(
-      split-large-strategies
+      dollars-for-capitals-top
+    ; split-large-strategies
     ; lift-definitions
     ; canonicalize
     ; simplify1
@@ -27,7 +28,35 @@
     ; escaping-variables
     ; remove-closure-allocs
     )
+
+rules
   
+  /**
+   * Adds dollars to names with capitals (e.g. Desugar becomes $Desugar).
+   * Doing so is required for supporting (Windows/Mac) case-insensitive file systems.
+   */
+  dollars-for-capitals-top =
+    topdown(try(
+      SVar(dollars-for-capitals)
+    + SDefT(dollars-for-capitals, id, id, id)
+    + ExtSDef(dollars-for-capitals, id, id)
+    ))
+   
+  dollars-for-capitals =
+    // We make an exception for the hand-crafted SRTS_EXT Java classes
+    if not(string-starts-with(|"SRTS_EXT")) then
+      escape(dollar-for-capital)
+    end
+  
+  dollar-for-capital(rec) :
+    [c | cs] -> ['$', c | <rec> cs] where <is-upper> c
+  
+  undo-dollars-for-capitals =
+    escape(undo-dollar-for-capital)
+  
+  undo-dollar-for-capital(rec) :
+    ['$' | cs] -> <rec> cs
+  
 rules
 
   remove-closure-allocs =

Modified: strc-java/trunk/trans/s2j.str
===================================================================
--- strc-java/trunk/trans/s2j.str	2009-10-14 13:02:04 UTC (rev 20089)
+++ strc-java/trunk/trans/s2j.str	2009-10-14 14:00:30 UTC (rev 20090)
@@ -337,10 +337,10 @@
 
 rules
 
-  translate-constant-definition : // TODO: check if contant strategy definition name not taken
+  translate-constant-definition : // TODO: check if constant strategy definition name not taken
     (name, value) -> def'
     with
-      name'  := <conc-strings> (<cify> name, "_0_0")
+      name'  := <conc-strings> (<cify; dollars-for-capitals> name, "_0_0")
     ; def    := SDefT(name', [], [], Build(value))
     ; def'   := <translate-outer-definition> def
   
@@ -502,7 +502,7 @@
            boolean TRUE = true;
            ITermFactory termFactory = context.getFactory();
            bstm_init*
-           if (TRACES_ENABLED) context.push("~x");
+           if (TRACES_ENABLED) context.push("~x'");
            Fail: {
              bstm
              if (TRACES_ENABLED) context.popOnSuccess();
@@ -518,6 +518,7 @@
          IsLiftedTVar, IsLiftedSVar, LiftedTVars, LiftedSVars:
         (s'*, [])          := <translate-params> s*
       ; (t'*,  bstm_init*) := <translate-params> t*
+      ; x'                 := <undo-dollars-for-capitals> x
       ; param*             := <conc> (s'*, t'*)   
       ; if is-dynamic-signature(|s*, t*) then
           mod_override* := []

Modified: strc-java/trunk/trans/strj.str
===================================================================
--- strc-java/trunk/trans/strj.str	2009-10-14 13:02:04 UTC (rev 20089)
+++ strc-java/trunk/trans/strj.str	2009-10-14 14:00:30 UTC (rev 20090)
@@ -52,6 +52,7 @@
   ; strc-output-frontend
   ; s2j
   ; with(clean-output-dir)
+    // TODO: output .rtree file for libraries?
   ; log-timed(list-loop(output-java) | "Pretty printing succeeded", 1)
   
   clean-output-dir =



From L.C.L.Kats at tudelft.nl  Wed Oct 14 16:08:08 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 14:08:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20091 - LennartKats -
	in strc-java/trunk:
	java/runtime/org/strategoxt/lang/compat/override tools
Message-ID: <200910141408.n9EE89fn007875@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 14:08:08 +0000 (Wed, 14 Oct 2009)
New Revision: 20091

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20091&view=rev

Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str
   strc-java/trunk/tools/strj-jar

Log:


Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str	2009-10-14 14:00:30 UTC (rev 20090)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str	2009-10-14 14:08:08 UTC (rev 20091)
@@ -18,7 +18,8 @@
     (IncludeFromPath(name), includes) -> ("", ast) // (empty result name goes into .dep)
     where
       switch !name
-        case "libstratego-lib":      import-term(libstratego-lib.rtree)
+        case "libstratego-lib" + "libstrategolib":
+          import-term(libstratego-lib.rtree)
         case "libstratego-xtc":      import-term(libstratego-xtc.rtree)
         case "libstratego-sglr":     import-term(libstratego-sglr.rtree)
         case "libstratego-rtg":      import-term(libstratego-rtg.rtree)

Modified: strc-java/trunk/tools/strj-jar
===================================================================
--- strc-java/trunk/tools/strj-jar	2009-10-14 14:00:30 UTC (rev 20090)
+++ strc-java/trunk/tools/strj-jar	2009-10-14 14:08:08 UTC (rev 20091)
@@ -105,7 +105,7 @@
   echo "WARNING: using this build directory may mean non-term files are included as attachments" >&2
 fi
 
-ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|astr|str|meta|dep|c|lo|o)$' | sed "s!^!-C $INPUTDIR !"` \
+ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|astr|str|meta|dep|c|lo|o|class)$' | sed "s!^!-C $INPUTDIR !"` \
   || (echo "Illegal input file name: $INPUT">&2; exit 1)
 
 echo $JAR cf $OUTPUT -C \$TEMPDIR . $ATTACHMENTS



From L.C.L.Kats at tudelft.nl  Wed Oct 14 16:36:25 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 14:36:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20092 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice
	spoofax-imp/trunk/org.strategoxt.imp.editors.sdf
	spoofax-imp/trunk/org.strategoxt.imp.editors.stratego
	spoofax-imp/trunk/org.strategoxt.imp.generator/lib
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
	strc-java/trunk strc-java/trunk/META-INF
Message-ID: <200910141436.n9EEaPAe008183@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 14:36:25 +0000 (Wed, 14 Oct 2009)
New Revision: 20092

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20092&view=rev

Removed:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-properties.rtree
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/lib/make_permissive.jar
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
   strc-java/trunk/META-INF/MANIFEST.MF
   strc-java/trunk/configure.ac

Log:
Bumped STRJ version after binary incompatible change (dollars in filenames).

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml	2009-10-14 14:08:08 UTC (rev 20091)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml	2009-10-14 14:36:25 UTC (rev 20092)
@@ -102,7 +102,7 @@
         </target>
 
         <target name="aux-files">
-            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18a"/>
+            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
             <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
             <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
@@ -262,4 +262,4 @@
             <delete dir="${build}"/>
             <delete file="${src-gen}/trans/Main.java"/>
         </target>
-    </project>
\ No newline at end of file
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml	2009-10-14 14:08:08 UTC (rev 20091)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml	2009-10-14 14:36:25 UTC (rev 20092)
@@ -102,7 +102,7 @@
         </target>
 
         <target name="aux-files">
-            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18a"/>
+            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
             <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
             <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
@@ -262,4 +262,4 @@
             <delete dir="${build}"/>
             <delete file="${src-gen}/trans/Main.java"/>
         </target>
-    </project>
\ No newline at end of file
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml	2009-10-14 14:08:08 UTC (rev 20091)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml	2009-10-14 14:36:25 UTC (rev 20092)
@@ -102,7 +102,7 @@
         </target>
 
         <target name="aux-files">
-            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18a"/>
+            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
             <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
             <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
@@ -262,4 +262,4 @@
             <delete dir="${build}"/>
             <delete file="${src-gen}/trans/Main.java"/>
         </target>
-    </project>
\ No newline at end of file
+    </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/lib/make_permissive.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-properties.rtree
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	2009-10-14 14:08:08 UTC (rev 20091)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	2009-10-14 14:36:25 UTC (rev 20092)
@@ -120,7 +120,7 @@
         </target>
 
         <target name="aux-files">
-            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18a"/>
+            <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
             <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
             <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>

Modified: strc-java/trunk/META-INF/MANIFEST.MF
===================================================================
--- strc-java/trunk/META-INF/MANIFEST.MF	2009-10-14 14:08:08 UTC (rev 20091)
+++ strc-java/trunk/META-INF/MANIFEST.MF	2009-10-14 14:36:25 UTC (rev 20092)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: Stratego/XT Java runtime
 Bundle-SymbolicName: org.strategoxt.strj;singleton:=true
-Bundle-Version: 0.2.1
+Bundle-Version: 0.2.2
 Export-Package: .,
  aterm,
  aterm.pure,

Modified: strc-java/trunk/configure.ac
===================================================================
--- strc-java/trunk/configure.ac	2009-10-14 14:08:08 UTC (rev 20091)
+++ strc-java/trunk/configure.ac	2009-10-14 14:36:25 UTC (rev 20092)
@@ -1,5 +1,5 @@
 AC_PREREQ([2.58])
-AC_INIT([strc-java],[0.2],[bugs at strategoxt.org])
+AC_INIT([strc-java],[0.2.2],[bugs at strategoxt.org])
 AM_INIT_AUTOMAKE
 
 # set the prefix immediately to the default prefix



From L.C.L.Kats at tudelft.nl  Wed Oct 14 17:23:18 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 15:23:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20094 - LennartKats -
	in strc-java/trunk: java tools
Message-ID: <200910141523.n9EFNITT009135@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 15:23:17 +0000 (Wed, 14 Oct 2009)
New Revision: 20094

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20094&view=rev

Modified:
   strc-java/trunk/java/Makefile.am
   strc-java/trunk/tools/strj-jar

Log:
More RAM for javac.

Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-14 14:42:04 UTC (rev 20093)
+++ strc-java/trunk/java/Makefile.am	2009-10-14 15:23:17 UTC (rev 20094)
@@ -66,8 +66,8 @@
 
 SPOOFAX=../../../spoofax/trunk/spoofax
 CLASSPATH=runtime:lib:compiler:spoofax-libs.jar:.
-JAVACFLAGS=-J-Xmx512m -J-Xms300m -J-server -J-XX:+UseParallelGC -cp $(CLASSPATH) -source 5 -nowarn -d bin
-JAVAC=`if which ecj >/dev/null; then echo ecj; else echo javac; fi`
+JAVACFLAGS=-J-Xmx1024m -J-Xms512m -J-server -J-XX:+UseConcMarkSweepGC -cp $(CLASSPATH) -source 5 -nowarn -d bin
+JAVAC=`if false; then echo ecj; else echo javac; fi`
 
 STRJ=XTC_REPOSITORY="$(BUILD_REPOSITORY)" ../trans/strj
 STRJFLAGS=--library --verbose 3 -clean -O 3

Modified: strc-java/trunk/tools/strj-jar
===================================================================
--- strc-java/trunk/tools/strj-jar	2009-10-14 14:42:04 UTC (rev 20093)
+++ strc-java/trunk/tools/strj-jar	2009-10-14 15:23:17 UTC (rev 20094)
@@ -4,7 +4,7 @@
 
 MAINCLASS=
 PRINT_CLASSPATH=
-CLASSPATH=strategoxt.jar
+CLASSPATH=strategoxt.jar # override with option -cp
 JAR=`if which fastjar &>/dev/null; then echo fastjar; else echo jar; fi`
 JAVAC=`if which ecj &>/dev/null; then echo ecj; else echo javac; fi`
 if [ "$JAVAFLAGS" == "" ]; then



From L.C.L.Kats at tudelft.nl  Wed Oct 14 18:13:15 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 14 Oct 2009 16:13:15 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20095 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library
Message-ID: <200910141613.n9EGDFgR009857@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-14 16:13:15 +0000 (Wed, 14 Oct 2009)
New Revision: 20095

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20095&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java

Log:
Allow creating new files using SSL_fopen.

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2009-10-14 15:23:17 UTC (rev 20094)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2009-10-14 16:13:15 UTC (rev 20095)
@@ -131,12 +131,16 @@
 
     public int openRandomAccessFile(String fn, String mode) throws FileNotFoundException, IOException {
         String m = mode.indexOf('w') >= 0 ? "rw" : "r";
+        if (m.equals("rw")) {
+            File file = new File(getAbsolutePath(getWorkingDir(), fn));
+            if (!file.exists()) file.createNewFile();
+        }
         RandomAccessFile file = new RandomAccessFile(getAbsolutePath(getWorkingDir(), fn), m);
         
         inStreams.put(fileCounter, new BufferedInputStream(new RandomAccessInputStream(file)));
         outStreams.put(fileCounter, new PrintStream(new BufferedOutputStream(new RandomAccessOutputStream(file))));
         
-        if (m.equals("rw")) file.setLength(0); // HACK
+        if (m.equals("rw")) file.setLength(0); // HACK: clear written-to file contents
         
         return fileCounter++;
     }



From L.C.L.Kats at tudelft.nl  Thu Oct 15 13:17:30 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 15 Oct 2009 11:17:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20099 - LennartKats -
	strc-java/trunk/trans
Message-ID: <200910151117.n9FBHUaT025589@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-15 11:17:30 +0000 (Thu, 15 Oct 2009)
New Revision: 20099

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20099&view=rev

Modified:
   strc-java/trunk/trans/s2j.str

Log:
Fixed hybrid interpreter interoperability with strategies that contain capitals in their name.

Changes:

Modified: strc-java/trunk/trans/s2j.str
===================================================================
--- strc-java/trunk/trans/s2j.str	2009-10-15 07:43:30 UTC (rev 20098)
+++ strc-java/trunk/trans/s2j.str	2009-10-15 11:17:30 UTC (rev 20099)
@@ -319,18 +319,22 @@
     ]|
     with
       // HACK: non-lazy defs are used only to trick javac to compile everything atm
-      bstm1*  := <filter(java-register-strategy)> defs
-    ; bstm2*  := <filter(java-register-strategy-lazy)> defs
+      bstm1* := <filter(java-register-strategy)> defs
+    ; bstm2* := <filter(java-register-strategy-lazy)> defs
     ; x_name := <ApplicationName>
 
   java-register-strategy :
     SDefT(x,_,_,_) ->
-    |[ varScope.addSVar("~x", new InteropSDefT(x.instance, context, compiledContext)); ]|
+    |[ varScope.addSVar("~x'", new InteropSDefT(x.instance, context, compiledContext)); ]|
+    with
+      x' := <undo-dollars-for-capitals> x
 
   java-register-strategy-lazy :
     SDefT(x,_,_,_) ->
-    |[ varScope.addSVar("~x", new InteropSDefT(classLoader, "~y", context, compiledContext)); ]|
+    |[ varScope.addSVar("~x'", new InteropSDefT(classLoader, "~y", context, compiledContext)); ]|
     with
+      x' := <undo-dollars-for-capitals> x
+    with
       y := <conc-strings> (<get-config> "-p", ".", x)
     <+
       y := <conc-strings> (<ApplicationName>, "$", x)



From L.C.L.Kats at tudelft.nl  Thu Oct 15 13:22:50 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 15 Oct 2009 11:22:50 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20100 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.generator
	org.strategoxt.imp.generator/src/sdf2imp
	org.strategoxt.imp.generator/src/sdf2imp/lib
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.runtime/META-INF
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <200910151122.n9FBMo5a025657@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-15 11:22:50 +0000 (Thu, 15 Oct 2009)
New Revision: 20100

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20100&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/asfix-abstractions.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf-options.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPJSGLRLibrary.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java

Log:
Working on packaging the native sdf2table/implodePT components into plugins:
- Using the syntax-definition.org SDF plugin for now;
  it works in the wizard but not yet from the user's Ant build file
- pack-sdf is now integrated into sdf2imp


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile	2009-10-15 11:22:50 UTC (rev 20100)
@@ -29,6 +29,7 @@
     -I ${HOME}/.nix-profile/share/sdf-tools \
     -I ${HOME}/.nix-profile/share/stratego-front \
     -I ${HOME}/.nix-profile/share/xtc \
+    -I ${HOME}/.nix-profile/share/pgen \
     `pkg-config --variable=strcxtcflags strategoxt`
 
 JAVACFLAGS=-J-Xmx256m -J-Xms100m -J-server -J-XX:+UseParallelGC -cp strategoxt.jar -source 5 -nowarn
@@ -36,9 +37,7 @@
 STRJ=`if which strj >/dev/null; then echo strj; elif [ -e strategoxt.jar ]; then echo java -server -Xss4m -jar strategoxt.jar; else echo Please install strj or put strategoxt.jar into the current directory. >&2; exit 1; fi`
 
 SDFINCLUDES = \
-    -Idef ${HOME}/.nix-profile/share/java-front-syntax/JavaMix.def \
-    -Idef ${HOME}/.nix-profile/share/java-front/JavaEBlockMix.def \
-    -Idef ${HOME}/.nix-profile/share/java-front/EmbeddedJavaMix.def
+    -Idef ${HOME}/.nix-profile/share/java-front/Stratego-Java-EBlock.def
 
 # I don't care much for nullary constructor warnings unless it's about lowercase ones, such as 'start'
 STRCSTFU=2>&1 | grep -vE 'warning ] Nullary constructor .*[A-Z]|warning ] multiple external| \[ExtSDef\(|stratego-trm|module-name-checked|module-name-checked"' \

Copied: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/asfix-abstractions.str (from rev 20046, strategoxt/trunk/asfix-tools/lib/asfix-abstractions.str)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/asfix-abstractions.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/asfix-abstractions.str	2009-10-15 11:22:50 UTC (rev 20100)
@@ -0,0 +1,114 @@
+module asfix-abstractions
+imports
+  AsFix
+  Sdf2
+  asfix-extra
+
+signature
+constructors
+   ConcLayout: Layout -> Conclayout
+   'id : a -> a
+
+/**
+ * Lists
+ */
+overlays
+
+  conc-prod(s) = 
+    prod([cf(iter(s)),cf(opt(layout())),cf(iter(s))],cf(iter(s)),no-attrs())
+
+  iter-inj-prod(s) =
+    prod([cf(s)], cf(iter(s)), no-attrs())
+
+  af-iter-inj(s, x) =
+    appl(iter-inj-prod(s), [x])
+
+  af-conc(s,x,l,y) = 
+    appl(conc-prod(s), [x, l, y])
+
+/**
+ * START and LAYOUT
+ */
+overlays
+
+  flatlit(str) = flatlex(lit(str), str)
+
+  white(str) = flatlex(cf(opt(layout())), str)
+
+  start(s,l1,x,l2) =       
+    appl(prod([cf(opt(layout())),cf(sort(s)),cf(opt(layout()))],
+              sort("<START>"),no-attrs()),
+         [l1,x,l2])
+
+  CfLayout(l) =
+     appl(prod([lex(layout())], cf(layout()), no-attrs()), [l])
+
+  ConcCfLayout(l1, l2) = 
+     appl(prod([cf(layout()), cf(layout())], cf(layout()), attrs([assoc(left())])), [l1, l2])
+
+  NoCfLayout = 
+     appl(prod([], cf(opt(layout())), no-attrs()), [])
+     
+  CfOptLayout(l) =
+     appl(prod([cf(layout())], cf(opt(layout())), no-attrs()), [l])
+
+  Space =
+    CfLayout(appl(prod([char-class([range(9,10),13,32])],lex(layout()),attrs([prefer()])), [32]))
+
+  NewLine =
+    CfLayout(appl(prod([char-class([range(9,10),13,32])],lex(layout()),attrs([prefer()])), [10]))
+
+  OptNewLine =
+     CfOptLayout(NewLine())
+
+strategies
+
+  yield = rec x(appl(id, map(x)); \ appl(p, ts) -> <concat> ts \
+                <+ \ flatlex(_, str) -> <explode-string> str \
+	        <+ \ a -> [a] \ ); 
+          implode-string
+
+rules
+
+  flatten : appl(prod(_,srt,_), ts) -> flatlex(srt, str)
+	    where yield => str
+
+  flatten : flatlex(srt,str) -> flatlex(srt,str)
+
+  lit-tree :
+    str -> appl(prod(char-sorts, lit(str), no-attrs()), chars)
+    where <explode-string> str => chars;
+          <map( \c -> char-class([c])\ )> chars => char-sorts
+
+  conc-layout1 : 
+    (CfOptLayout(l1), CfOptLayout(l2)) -> 
+    CfOptLayout(ConcCfLayout(l1, l2))
+
+  conc-layout2 : 
+    (NoCfLayout(), l) -> l
+
+  conc-layout3 : 
+    (l, NoCfLayout()) -> l
+
+strategies
+
+  conc-layout = conc-layout1 <+ conc-layout2 <+ conc-layout3
+
+rules
+
+  UnStart : start(s,l1,x,l2) -> (l1, x, l2)
+
+  CombineLayout(s1,s2) : 
+    ((l1, x, l2), (l3, y, l4)) -> 
+    (l1, <s1> (x, <s2>(l2, l3), y), l4)
+
+strategies
+
+  concat-layout =
+    foldr1a(conc-layout <+ !ConcLayout(<id>))
+
+  foldr1a(s) =
+    rec f( 
+       \ [x] -> x \
+    <+ \ [a,b|xs] -> <f>[<s>(a, b)|xs] \
+    )


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/asfix-abstractions.str
___________________________________________________________________
Added: svn:mergeinfo
   + /strategoxt/branches/strategoxt-annos/asfix-tools/lib/asfix-abstractions.str:19217-19721
/strategoxt/branches/strategoxt-with/asfix-tools/lib/asfix-abstractions.str:18038-18120

Copied: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf-options.str (from rev 20046, strategoxt/trunk/sdf-front/parse/pack-sdf-options.str)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf-options.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf-options.str	2009-10-15 11:22:50 UTC (rev 20100)
@@ -0,0 +1,145 @@
+/**
+ * @author  Martin Bravenboer <martin.bravenboer at gmail.com>
+ */
+module pack-sdf-options
+imports
+  libstratego-lib
+  libstratego-xtc
+  strategoxt-xtc-tools
+
+/**
+ * Options
+ */
+signature
+  constructors
+    IncludeDef : String -> IncludeVal
+    IncludeDef : String * List(String, Module) -> IncludeVal
+    IncludeDir : String -> IncludeVal
+    IncludeXTC : IncludeVal
+
+  constructors
+    IncludePathName : String -> Include
+    IncludeFromPath : String -> Include
+
+strategies
+
+  pack-sdf-options =
+       include-from-dir-option
+    <+ include-from-def-option
+    <+ dep-options
+    <+ of-option
+
+  of-config = 
+    <get-config> "--output-format" <+ !"txt"
+
+  of-option =
+    OutputFormatOption(|["txt", "asfix", "ast"])
+
+  OutputFormatOption(|formats) =
+    ArgOption("-of" + "--output-format"
+    , where(
+        where(<elem> (<id>, formats))
+      ; <set-config> ("--output-format", <id>)
+      <+ <fatal-error> ["pack-sdf: ", <id>, " is not a valid output format. Supported formats: " | <separate-by> (", ", formats)]
+      )
+    , <concat-strings> ["-of f            Use output format f (", <separate-by; concat-strings> (", ", formats), ")"]
+    )
+
+  include-from-def-option =
+    ArgOption("-Idef"
+    , where(<extend-config> ("-I", [IncludeDef(<id>)]))
+    , !"-Idef <lang.def>     Include modules from SDF definition <lang.def>"
+    )
+
+  /**
+   * Read SDF definitions and add current directory and XTC to include values.
+   */
+  process-options =
+    where(
+      (<get-config> "-I" <+ ![])
+    ; map(?IncludeDef(_) < process-Idef + id)
+
+      /**
+       * XTC is the final search option
+       */
+    ; <conc> (<id>, [IncludeXTC()])
+      
+      /**
+       * The first search option is the directory of the input
+       * file, or the current directory if the input is stdin.
+       */
+    ; if <get-config> "-i" => input then
+        ![IncludeDir(<dirname> input) | <id>]
+      else 
+        ![IncludeDir(".") | <id>]
+      end
+
+    ; <set-config> ("-I", <id>)
+    )
+
+  /**
+   * @type  String -> List((String, AsFix(Module)))
+   */
+  process-Idef =
+      ?IncludeDef(def)
+    ; !FILE(def)
+    ; xtc-temp-files(
+        xtc-sglr(!"Sdf2.baf", !"SDF")
+      ; read-from
+      )
+    ; collect-om(?
+        appl(prod(_, cf(sort("Module")), attrs([term(cons("module"))])), _)
+      )
+    ; map(!(<module-to-module-name>, <id>))
+    ; where(
+        if-verbose2(
+          say(<concat-strings> ["pack-sdf: SDF Syntax Definition ", def, " provides the modules "])
+        ; map(Fst; debug(!"pack-sdf:   - "))
+        )
+      )
+    ; !IncludeDef(def, <id>)
+
+  include-from-dir-option =
+    ArgOption("-I" + "--Include"
+    , where(<extend-config>("-I", [IncludeDir(<ensure-directory>)]))
+    , !"-I|--Include <dir>   Include modules from directory <dir>"
+    )
+
+  ensure-directory =
+    if not(file-exists) then
+      debug(!"pack-sdf: warning: directory specified with -I does not exist: ")
+    else
+      if not(filemode; isdir) then
+        debug(!"pack-sdf: warning: path specified with -I is a file, not a directory: ")
+      else id end
+    end
+
+  dep-options = 
+    ArgOption("--dep"
+    , where(<set-config> ("-dep", <id>))
+    , !"--dep <file>         Write make dependencies to <file>"
+    )
+
+  /**
+   * Gets the include path from the config.
+   *
+   * The current working directory . is added to this path.
+   */
+  include-path =
+    <get-config> "-I" <+ ![]
+
+  depfile-from-config =
+    <get-config> "-dep"
+
+  maybe-create-depfile =
+    where(try(create-dep-file))
+
+  create-dep-file =
+    ?files
+    ; where(
+        <get-config> "-o" => outfile
+      ; <fopen> (<depfile-from-config> (), "w") => stream
+      )
+    ; ![outfile | <separate-by(|" \\\n\t")> [":" | files]]
+    ; map(<fputs> (<id>, stream))
+    ; <fclose> stream


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf-options.str
___________________________________________________________________
Added: svn:mergeinfo
   + /strategoxt/branches/strategoxt-annos/sdf-front/parse/pack-sdf-options.str:19217-19721
/strategoxt/branches/strategoxt-with/sdf-front/parse/pack-sdf-options.str:18038-18120

Copied: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf.str (from rev 20046, strategoxt/trunk/sdf-front/parse/pack-sdf.str)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf.str	2009-10-15 11:22:50 UTC (rev 20100)
@@ -0,0 +1,399 @@
+/**
+ * pack-sdf creates an SDF definition file containing all modules imported 
+ * from the given top module.
+ *
+ * pack-sdf is an instantiation of pack-modules implemented with graph-nodes. 	
+ *
+ * @authors    Merijn de Jonge <mdejonge at cwi.nl>
+ *             Eelco Visser <visser at acm.org>
+ *             Joost Visser <jvisser at cwi.nl>
+ *             Martin Bravenboer <martin.bravenboer at gmail.com>
+ */
+module pack-sdf
+imports
+  libstratego-lib
+  libstratego-xtc
+  strategoxt-xtc-tools
+  libstratego-sglr
+  sdf2imp/lib/asfix-abstractions
+  sdf2imp/lib/pack-sdf-options
+
+/**
+ * Entry point
+ */
+strategies
+
+  main-pack-sdf =
+    xtc-io-wrap(pack-sdf-options,
+      process-options
+    ; pack-sdf(|<include-path>) => (files, spec)
+    ; <maybe-create-depfile> files
+    ; !spec
+    ; where( (<fopen> (<get-config> "-o", "w") <+ stdout-stream ) => stream ) 
+    ; (  where(of-config => "txt")   < ( asfix-yield(|stream) ; <xtc-exit>0 )
+      +  where(of-config => "ast")   < implode-asfix
+      +  where(of-config => "asfix")
+      ) ; write-to <+ <fatal-error> ["pack-sdf: ", <id>, " is not a valid output format."]
+    )
+
+/**
+ * Main strategies
+ */
+strategies
+
+  pack-sdf(|mkpt) =
+      \ FILE(s) -> IncludePathName(s) \
+    ; !(<id>, mkpt, [])
+    ; graph-nodes-undef(
+        pack-sdf-parse-sdf
+      , get-sdf-imports
+        ; map(!IncludeFromPath(<id>))
+      , \ (n,x,xs) -> [x|xs] \
+      )
+    ; if ?(_, []) then
+       Fst
+       ; unzip
+       ; (id, ConcatModules) 
+      else
+        Snd
+        ; map(report-module-not-found)
+        ; <xtc-exit> 1
+      end
+
+  report-module-not-found =
+    let get-module-name =
+          ?IncludeFromPath(<id>) + ?IncludePathName(<id>)
+
+     in get-module-name => module-name
+      ; <fprintnl> (stderr(), ["pack-sdf: error: module ", module-name, " not found"])
+      ; <bagof-ImportedFrom> module-name
+      ; if [] then
+          id
+        else if ?[mod] then
+            <get-source-pathname <+ !"unknown location"> mod
+          ; <fprintnl> (stderr(), ["    imported from module ", mod, 
+                                "\n      in file ", <id>])
+        else
+            where(<fprintnl> (stderr(), ["    imported from:"]))
+          ; map({mod1 :
+              ?mod1
+            ; (get-source-pathname <+ !"at unknown location")
+            ; <fprintnl> (stderr(),   ["      module ", mod1, 
+                                    "\n        in file ", <id>])
+            })
+          end
+        end
+      ; <fprintnl> (stderr(),   [""])
+    end
+
+  /**
+   * @type  (Include, List(IncludeVal)) -> (String, AsFix(Module))
+   */
+  pack-sdf-parse-sdf =
+    ?(<id>, includes)
+    ; ?IncludeFromPath(<id>)
+    ; guarantee-extension(|"sdf")
+    ; remove-extension
+    ; ?mod
+    ; <fetch-elem(
+         include-from-dir(|mod)
+       + include-from-def(|mod)
+       + include-from-xtc(|mod)
+       )> includes
+
+  pack-sdf-parse-sdf =
+    let qualify-pathname =
+            where(explode-string => cs)
+          ; if <is-qualified> cs then
+              id
+            else
+              <implode-string> ['.', '/' | cs]
+            end
+  
+         is-qualified =
+           ?['/' | _] + ?['.' | _ ]
+
+     in ?(<id>, _)
+      ; ?IncludePathName(<qualify-pathname>)
+      ; if file-exists then
+          if-verbose1(debug(!"  including "))
+        ; include-pathname
+        else
+          <fatal-error> ["pack-sdf: error: file ", <id>, " does not exist\n"]
+        end
+    end
+
+  include-pathname :
+    file -> (file, tree)
+      where <parse-sdf2-module-to-asfix> file => tree
+          ; get-module-name-from-asfix => mod
+          ; <register-source-pathname(|mod)> file
+
+  include-from-dir(|mod) :
+    IncludeDir(dir) -> <include-pathname> file
+      where <concat-strings; file-exists> [dir,"/", mod, ".sdf"] => file
+          ; if-verbose1(debug(!"  including "))
+          ; <parse-sdf2-module-to-asfix(|mod)> file => tree
+          ; <register-source-pathname(|mod)> file
+
+  include-from-xtc(|mod) :
+    IncludeXTC() -> (file, tree)
+      where <conc-strings; xtc-find-loc> (mod, ".sdf") => file
+          ; if-verbose1(say(<concat-strings> ["  including ", mod, " from XTC repository"]))
+          ; <parse-sdf2-module-to-asfix(|mod)> file => tree
+          ; <register-source-pathname(|mod)> file
+
+  include-from-def(|mod) :
+    IncludeDef(file, mods) -> (file, Module_START(NewLine(), tree, NewLine()))
+      where <fetch-elem(?(mod, <id>))> mods => tree
+          ; if-verbose1(say(<concat-strings> ["  including ", mod, " from ", file]))
+          ; <register-source-pathname(|mod)> file
+
+strategies
+
+  register-source-pathname(|mod) =
+    ?file
+    ; rules(SourcePathName : mod -> file)
+
+  get-source-pathname =
+    SourcePathName
+
+strategies
+
+  /**
+   * Parses SDF module and checks basename of SDF module name
+   */
+  parse-sdf2-module-to-asfix =
+    let check =
+            (<conc-strings> (<base-filename>, ".sdf"), base-filename)
+          ; eq
+     in parse-sdf2-module-to-asfix(check)
+    end
+
+  /**
+   * Parses SDF module and checks full module name.
+   */
+  parse-sdf2-module-to-asfix(|mod) =
+    let check =
+          ?(<id>, _)
+          ; <eq> (<id>, mod)
+     in parse-sdf2-module-to-asfix(check)
+    end 
+
+  /**
+   * Parses SDF module.
+   *
+   * check is applied to a tuple of (actual module name, pathname of sdf)
+   */
+  parse-sdf2-module-to-asfix(check) =
+    ?pathname
+    ; ( <parse-file-pt(|<pack-sdf-table>, "Module")> pathname
+        <   ?parsetree(<id>, _)
+          ; check-module-name(check|pathname)
+        + <fatal-error> ["pack-sdf: Error: module ", pathname, " cannot be parsed\n"]
+      )
+  
+  pack-sdf-table =
+    PackSDFTable
+  <+
+    import-term(Sdf2.baf);
+    open-parse-table;
+    rules(
+      PackSDFTable := <id>
+    )
+
+  check-module-name(check|pathname) =
+    ?ptree;
+    let get-actual-modname =
+          <get-module-name-from-asfix> ptree
+
+     in where(<get-actual-modname> () => actual)
+      ; if <check> (actual, pathname) then
+          id
+        else
+          <fatal-error> ["pack-sdf: error: module name '", actual, "' in file '", pathname, "' does not correspond to filename.\n"]
+        end
+    end
+
+  get-module-name-from-asfix = 
+      collect-om(?appl(prod(_, cf(sort("Module")), _), _))
+    ; ?[<id>]
+             // module layout ModuleName
+    ; ?appl(_, [_, _, <id> | _])
+    
+    ; collect-om(?appl(prod(_, lex(sort("ModuleId")), _), _))
+    ; ?[<id>]
+    ; asfix-lex-yield
+
+  asfix-lex-yield =
+    let F  = \ appl(p, ts) -> <concat> ts \
+        F' = \ x -> [x] \
+
+     in rec x(appl(id, map(x)); F <+ F')
+    end
+    ; implode-string
+
+strategies
+
+  get-sdf-imports = 
+    where(get-module-name-from-asfix => mod)
+    ; collect(
+          ?appl(prod(_,cf(sort("Import")),_),_)
+        ; get-module-name
+      , skip-non-imports
+      )
+    ; where(
+        map({import:
+            ?import
+          ; rules(ImportedFrom :+ import -> mod)
+        })
+      )
+    <+ debug(!"a -------------------- "); fail
+
+  skip-non-imports(search, ignore) =  
+    parsetree(search,id)
+    //<+ appl(prod(id, cf(sort("Module")),id),[id,id,id,search,id,search])
+    <+ appl(prod(id, cf(opt(layout()) <+ 
+                        sort("Productions" <+ "Symbols" <+ 
+                             "Priorities" <+ "Restrictions" <+
+                             "Aliases")), id); ignore, ignore)
+    <+ appl(ignore,search)
+
+strategies
+
+  /**
+   * Obtain module name from Import construct by removing optional parameters
+   */
+  get-module-name =
+      oncetd(?appl(prod(_,cf(sort("ModuleId")),_),_); yield => y)
+    ; !y
+
+  module-to-module-name = 
+    ?appl(prod(_, cf(sort("Module")), _), [_, _, mid | _])
+    ; <get-module-name> mid
+
+  /**
+   * Composing AsFix; The parser produces an AsFix term for each module. These
+   * have to be merged into a list of modules. This entails merging the layout
+   * at the end and start of subsequent trees. Note that the prefer longets
+   * match of laout is not considered here. This means that the layout nodes may not be
+   * equavalent to the layout nodes when parsing the resulting definition file:
+   *  
+   * parse( unparse(pack(m))) != pack(m) 
+   *
+   */
+  ConcatModules =
+   rec x(
+   {w1, w2, m, m1, m2, xs:
+      []; 
+      !(NoCfLayout(), EmptyModuleIterStar(), NoCfLayout())
+   <+ 
+      [id];
+      ?[Module_START(w1, m, w2)]; 
+      !(NoCfLayout(), M-iter(m), NoCfLayout())
+   <+
+      ?[m1,m2|xs];
+      <concat-modules>( <x>[m1], <x>[m2|xs])
+   }) => (w1, modules, w2);
+   !parsetree(SDF_START(NoCfLayout(), 
+      Definition-overlay(
+         <concat-layout>[OptNewLine(), w1], 
+         Module-s-overlay(NonEmptyModuleIterStar(modules))),w2),0)
+
+
+  concat-modules =
+    ?( (w1, m1, w2), (w3, m2, w4) );
+    !(w1, MM-iter( 
+            m1, 
+            <concat-layout>[w2, OptNewLine(), OptNewLine(), w3], 
+            m2), w4)
+
+signature
+  constructors
+    'id: Arg -> ID
+
+/**
+ * Overlays for SDF constructs
+ */
+overlays 
+
+  /**
+   * Module -> <START>
+   */
+  Module_START(w1, t, w2) =
+    appl(
+      prod(
+        [ cf(opt(layout()))
+        , cf(sort("Module"))
+        , cf(opt(layout()))
+        ]
+      , sort("<START>")
+      , no-attrs()
+      )
+    , [ w1, t, w2]
+    )
+
+  /**
+   * SDF -> <START>
+   */
+  SDF_START(w1, t, w2) =
+    appl(
+      prod(
+        [ cf(opt(layout()))
+        , cf(sort("SDF"))
+        , cf(opt(layout()))
+        ]
+      , sort("<START>")
+      , no-attrs()
+      )
+    , [w1, t, w2]
+    )
+
+  /**
+   *   -> M*
+   */
+  EmptyModuleIterStar =
+    appl(prod([],cf(iter-star(sort("Module"))),no-attrs()),[])
+
+  /**
+   * M+ -> M*
+   */
+  NonEmptyModuleIterStar(m) = 
+    appl(prod([cf(iter(sort("Module")))],cf(iter-star(sort("Module"))),no-attrs()),[m])
+
+  /**
+   * M+ M+ -> M+ {left}
+   */
+  MM-iter(m1, w, m2) =
+    appl(prod([cf(iter(sort("Module"))),cf(opt(layout())),cf(iter(sort("Module")))],
+     cf(iter(sort("Module"))),attrs([assoc(left())])),[m1, w, m2])
+
+  /**
+   * M -> M+
+   */
+  M-iter( m ) = 
+    appl(prod([cf(sort("Module"))],cf(iter(sort("Module"))),no-attrs()),[m])
+
+  /**
+   *  Module* -> Definition
+   */
+  Module-s-overlay ( g_6 ) =
+    appl ( prod ( [ cf ( iter-star ( sort ( "Module" ) ) ) ] , cf ( sort ( "Definition" ) ) , no-attrs()  ) , [ g_6 ] )
+
+  /**
+   * definition Definition -> SDF
+   */
+  Definition-overlay(b_1,c_1) = 
+  appl(prod([lit("definition"),cf(opt(layout())),cf(sort("Definition"))],cf(sort("SDF")),
+         attrs([term(cons("definition"))])),[appl(prod([
+    char-class([100]),
+    char-class([101]),
+    char-class([102]),
+    char-class([105]),
+    char-class([110]),
+    char-class([105]),
+    char-class([116]),
+    char-class([105]),
+    char-class([111]),
+    char-class([110])],lit("definition"),no-attrs()),[100,101,102,105,110,105,116,105,111,110]),b_1,c_1])
+


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/pack-sdf.str
___________________________________________________________________
Added: svn:mergeinfo
   + /strategoxt/branches/strategoxt-annos/sdf-front/parse/pack-sdf.str:19217-19721
/strategoxt/branches/strategoxt-with/sdf-front/parse/pack-sdf.str:18038-18120

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2009-10-15 11:22:50 UTC (rev 20100)
@@ -88,12 +88,7 @@
       end;
       create-grammar;
       create-trans;
-      ( input := <pack-sdf> FILE(<conc-strings> ("syntax/", <get-sdf-main-module>, ".sdf"))
-      <+
-        fatal-err(|["Could not call pack-sdf. Please ensure pack-sdf and sdf2table are ",
-                    "installed and on the path (on Linux and OS/X they should be on the ",
-                    "PATH variable set in /etc/profile)"])
-      )
+      input := <pack-default-sdf> FILE(<conc-strings> ("syntax/", <get-sdf-main-module>, ".sdf"))
     end;
   
     configure-main-descriptor;
@@ -151,9 +146,33 @@
       ?RTG(_, ProdRules(<id>));
       register-rtg
 
-  pack-sdf:
+  /* UNDONE: sdf2def converts a single SDF file to a DEF file.
+  sdf2def: 
     FILE(sdf) -> FILE(def)
-    where
+    where      
+      <file-exists <+ mkdir> "include";
+      def       := <conc-strings> ("include/", <get-sdf-main-module>, ".def");
+      streamin  := <fopen> (sdf, "r");
+      streamout := <fopen> (def, "w");
+      finally(
+        <fputs> ("definition\n", streamout);
+        repeat(
+          <fgetc> streamin; <fputc> (<id>, streamout)
+        )
+      , <fclose> streamin;
+        <fclose> streamout
+      )
+  */
+
+  pack-default-sdf:
+    FILE(sdf) -> FILE(def)
+    with
       def := <conc-strings> ("include/", <get-sdf-main-module>, ".def");
       <file-exists <+ mkdir> "include";
-      <xtc-command(!"pack-sdf")> ["-i", sdf, "-o", def | <pass-verbose>]
+      
+      // <xtc-command(!"pack-sdf")> ["-i", sdf, "-o", def | <pass-verbose>]
+      <pack-sdf(|[IncludeDir("syntax")])> FILE(sdf) => (_, def-asfix);
+      stream := <fopen> (def, "w");
+      <asfix-yield(|stream)> def-asfix;
+      <fclose> stream
+

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str	2009-10-15 11:22:50 UTC (rev 20100)
@@ -33,14 +33,24 @@
       FILE(input') := <create-permissive-grammar> FILE(input);
       output       := <parse-table-target>;
       print-filename(|[], output);
-      <xtc-command(!"sdf2table")> ["-i", input', "-o", output, "-m", <get-sdf-main-module>]
+      <debug; sdf2table> (input', output)
   
+  sdf2table =
+    ?(input, output);
+    <xtc-command(!"sdf2table")> ["-i", <abspath> input, "-o", <abspath> output, "-m", <get-sdf-main-module>]
+  <+
+    <xtc-command(!"sdf2table")> ["-V"] // ensure it's available
+  <+
+    fatal-err(|["Could not call sdf2table. Please ensure sdf2table is ",
+                "installed and on the path (on Linux and OS/X they should be on the ",
+                "PATH variable set in /etc/profile)"])
+  
   create-permissive-grammar:
     FILE(input) -> FILE(output)
     with
       output := <permissive-grammar-target>;
       print-filename(|[], output);
-      args   := ["-i", input, "-o", output, "--open-insertions", "on", "--optimize", "on"];
+      args   := ["-i", input, "-o", output, "--open-brackets", "on", "--optimize", "on"];
       if-java-platform(
         <call> ("org.strategoxt.permissivegrammars.main-make-permissive", args)
       );

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	2009-10-15 11:22:50 UTC (rev 20100)
@@ -21,7 +21,8 @@
  org.eclipse.ui,
  org.spoofax.compiler,
  org.strategoxt.imp.generator,
- org.strategoxt.strj
+ org.strategoxt.strj,
+ sdf_eclipse_installer
 Export-Package: org.strategoxt.imp.runtime,
  org.strategoxt.imp.runtime.dynamicloading,
  org.strategoxt.imp.runtime.parser,

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2009-10-15 11:22:50 UTC (rev 20100)
@@ -62,6 +62,8 @@
 		parseTables = Collections.synchronizedMap(new HashMap<String, ParseTable>());
 		descriptors = Collections.synchronizedMap(new HashMap<String, Descriptor>());
 		wrappedAstNodeFactory = new WrappedAstNodeFactory();
+		IMPJSGLRLibrary.init();
+		IMPLibrary.init();
 	}
 	
 	// TODO: Split up shared and non-shared environment entities?

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPJSGLRLibrary.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPJSGLRLibrary.java	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPJSGLRLibrary.java	2009-10-15 11:22:50 UTC (rev 20100)
@@ -14,6 +14,9 @@
 		super(Environment.getWrappedATermFactory());
 		
 		add(new IMPParseStringPTPrimitive(Environment.getWrappedATermFactory(), sglrLibrary.getFilterSettings()));
+	}
+	
+	public static void init() {
 		implode_asfix_1_0.instance = new IMPImplodeAsfixStrategy();
 	}
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2009-10-15 11:17:30 UTC (rev 20099)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2009-10-15 11:22:50 UTC (rev 20100)
@@ -1,6 +1,7 @@
 package org.strategoxt.imp.runtime.stratego;
 
 import org.spoofax.interpreter.library.AbstractStrategoOperatorRegistry;
+import org.strategoxt.stratego_xtc.xtc_command_1_0;
 
 /**
  * @author Lennart Kats <lennart add lclnet.nl>
@@ -12,6 +13,10 @@
 	public IMPLibrary() {
 		add(new SubtermPrimitive());
 	}
+	
+	public static void init() {
+		xtc_command_1_0.instance = new SDFBundleCommand();
+	}
 
 	public String getOperatorRegistryName() {
 		return REGISTRY_NAME;

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java	2009-10-15 11:22:50 UTC (rev 20100)
@@ -0,0 +1,100 @@
+package org.strategoxt.imp.runtime.stratego;
+
+import static org.spoofax.interpreter.terms.IStrategoTerm.*;
+
+import java.io.File;
+import java.io.IOException;
+import java.io.PrintStream;
+
+import org.spoofax.interpreter.library.IOAgent;
+import org.spoofax.interpreter.terms.IStrategoList;
+import org.spoofax.interpreter.terms.IStrategoString;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.StrategoException;
+import org.strategoxt.lang.compat.NativeCallHelper;
+import org.strategoxt.stratego_xtc.xtc_command_1_0;
+import org.syntax_definition.sdf.Activator;
+
+/**
+ * Overrides the xtc-command strategy to use sdf2table
+ * from the SDF plugin.
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class SDFBundleCommand extends xtc_command_1_0 {
+	
+	private final xtc_command_1_0 proceed = xtc_command_1_0.instance;
+
+	private File binaryPrefix;
+	
+	private String binaryPostfix;
+	
+	private void init() throws IOException {
+		if (binaryPostfix != null) return;
+		Activator sdfBundle = Activator.getInstance();
+		binaryPrefix = sdfBundle.getBinaryPrefix();
+		binaryPostfix = sdfBundle.getBinaryPostfix();
+	}
+	
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm args,
+			org.strategoxt.lang.Strategy command) {
+		
+		try {
+			init();
+		} catch (IOException e) {
+			e.printStackTrace();
+			return proceed.invoke(context, args, command);
+		}
+		
+		IStrategoTerm commandTerm = command.invoke(context, args);
+		if (commandTerm.getTermType() != STRING)
+			return proceed.invoke(context, args, command);
+		
+		String commandName = ((IStrategoString) commandTerm).stringValue();
+		if (!new File(binaryPrefix + "/" + commandName + binaryPostfix).exists())
+			return proceed.invoke(context, args, command);
+		
+		if (args.getTermType() != LIST)
+			return null;
+		
+		return invokeSDF2Table(context, commandName, ((IStrategoList) args).getAllSubterms())
+			? args
+			: null;
+	}
+
+	private boolean invokeSDF2Table(Context context, String command, IStrategoTerm[] argList) throws StrategoException {
+		// HACK: concatenating all command-line arguments...
+		StringBuilder allArgs = new StringBuilder();
+		String[] commandArgs = new String[argList.length + 1];
+		int i = 1;
+		for (IStrategoTerm arg : argList) {
+			if (arg.getTermType() != STRING) return false;
+			allArgs.append(' ');
+			allArgs.append(((IStrategoString) arg).stringValue());
+			commandArgs[i++] = ((IStrategoString) arg).stringValue();
+		}
+		
+		try {
+			/*
+			InputStream result = Tools.exec("sdf2table " + allArgs, System.in);
+			// Synchronously copy the std error stream
+			PrintStream stderr = context.getIOAgent().getOutputStream(IOAgent.CONST_STDERR);
+			new NativeCallHelper.StreamCopier(result, stderr).run();
+			*/
+			commandArgs[0] = binaryPrefix + "/" + command + binaryPostfix;
+			String[] environment = { "PATH=" + binaryPrefix.getAbsolutePath(), 
+					                 "LD_LIBRARY_PATH=" + binaryPrefix.getParentFile().getAbsolutePath() + "/lib" };
+			IOAgent io = context.getIOAgent();
+			PrintStream stdout = io.getOutputStream(IOAgent.CONST_STDOUT);
+			PrintStream stderr = io.getOutputStream(IOAgent.CONST_STDERR);
+			int result = new NativeCallHelper().call(commandArgs, environment, new File(io.getWorkingDir()), stdout, stderr);
+			return result == 0;
+		} catch (IOException e) {
+			return false;
+		} catch (InterruptedException e) {
+			throw new StrategoException("Could not call sdf2table", e);
+		}
+	}
+}



From L.C.L.Kats at tudelft.nl  Thu Oct 15 13:50:16 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 15 Oct 2009 11:50:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20101 - LennartKats -
	in strc-java/trunk: . java/runtime/org/strategoxt/lang/compat
Message-ID: <200910151150.n9FBoGjo025939@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-15 11:50:16 +0000 (Thu, 15 Oct 2009)
New Revision: 20101

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20101&view=rev

Modified:
   strc-java/trunk/README
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/NativeCallHelper.java

Log:


Changes:

Modified: strc-java/trunk/README
===================================================================
--- strc-java/trunk/README	2009-10-15 11:22:50 UTC (rev 20100)
+++ strc-java/trunk/README	2009-10-15 11:50:16 UTC (rev 20101)
@@ -33,8 +33,13 @@
 may arise. In particular, the parsing primitives are implemented using
 JSGLR, the Java version of SGLR, which is not yet fully
 mature. Mainly, the post-parse filter implementation is not yet
-complete (especially the heuristic filters -- which are disabled by
-default).
+complete. This especially impacts the heuristic filters, which are
+disabled by default, but used for Stratego's concrete syntax
+embedding. To work around any problems, we suggest using the native
+'strj' executable to compile these files for now, or to pre-parse them
+to '.rtree' files using parse-stratego. A general recommendation may
+be to disable the heuristic filters in the .meta files using the
+HeuristicFilters(Off()) directive.
 
 The standard Sun compiler can be quite slow when compiling large
 Stratego projects. We recommend using ECJ (Eclipse Compiler for Java)

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/NativeCallHelper.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/NativeCallHelper.java	2009-10-15 11:22:50 UTC (rev 20100)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/NativeCallHelper.java	2009-10-15 11:50:16 UTC (rev 20101)
@@ -13,10 +13,17 @@
  * @author Lennart Kats <lennart add lclnet.nl>
  */
 public class NativeCallHelper {	
+	
+	@Deprecated
 	public int call(String[] commandArgs, File workingDir, PrintStream outStream, PrintStream errorStream)
+		throws InterruptedException, IOException {
+		return call(commandArgs, null, workingDir, outStream, errorStream);
+	}
+	
+	public int call(String[] commandArgs, String[] environment, File workingDir, PrintStream outStream, PrintStream errorStream)
 			throws InterruptedException, IOException {
 		
-		Process process = Runtime.getRuntime().exec(commandArgs, null, workingDir);
+		Process process = Runtime.getRuntime().exec(commandArgs, environment, workingDir);
 		Thread t1 = new StreamCopier(process.getInputStream(), outStream);
 		Thread t2 = new StreamCopier(process.getErrorStream(), errorStream);
 		t1.start();
@@ -28,33 +35,33 @@
 	
 		return result;
 	}
-}
 
-class StreamCopier extends Thread {
-	private final InputStream input;
-	private final PrintStream output;
-
-	public StreamCopier(InputStream input, PrintStream output) {
-		this.input = input;
-		this.output = output;
-	}
-
-	@Override
-	public void run() {
-		try {
-			InputStreamReader streamReader = new InputStreamReader(input);
-			BufferedReader reader = new BufferedReader(streamReader);
-			
-			// NOTE: This might block if exceptionally long lines are printed
-			String line;
-			while ((line = reader.readLine()) != null) {
-				output.println(line);
+	public static class StreamCopier extends Thread {
+		private final InputStream input;
+		private final PrintStream output;
+	
+		public StreamCopier(InputStream input, PrintStream output) {
+			this.input = input;
+			this.output = output;
+		}
+	
+		@Override
+		public void run() {
+			try {
+				InputStreamReader streamReader = new InputStreamReader(input);
+				BufferedReader reader = new BufferedReader(streamReader);
+				
+				// NOTE: This might block if exceptionally long lines are printed
+				String line;
+				while ((line = reader.readLine()) != null) {
+					output.println(line);
+				}
+				
+				reader.close();
+				output.flush();
+			} catch (IOException e) {
+				throw new StrategoException("IO Exception redirecting output from Process", e);
 			}
-			
-			reader.close();
-			output.flush();
-		} catch (IOException e) {
-			throw new StrategoException("IO Exception redirecting output from Process", e);
 		}
 	}
 }
\ No newline at end of file



From L.C.L.Kats at tudelft.nl  Fri Oct 16 10:18:31 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 16 Oct 2009 08:18:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20104 - LennartKats -
	in strc-java/trunk: java java/runtime
	java/runtime/org/strategoxt/lang
	java/runtime/org/strategoxt/lang/compat trans
Message-ID: <200910160818.n9G8IVKR010547@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-16 08:18:30 +0000 (Fri, 16 Oct 2009)
New Revision: 20104

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20104&view=rev

Added:
   strc-java/trunk/java/runtime/org/strategoxt/lang/MissingStrategyException.java
   strc-java/trunk/java/runtime/start.java
Modified:
   strc-java/trunk/java/Makefile.am
   strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/SSL_EXT_java_call.java
   strc-java/trunk/java/spoofax-libs.jar
   strc-java/trunk/trans/s2j.str

Log:
- New MissingStrategyException for dynamically called strategies
- New "start" class to dynamically invoke any given main strategy in a Stratego JAR
  (e.g., java -cp strategoxt.jar start org.strategoxt.strj.main)


Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-15 14:01:53 UTC (rev 20103)
+++ strc-java/trunk/java/Makefile.am	2009-10-16 08:18:30 UTC (rev 20104)
@@ -67,7 +67,7 @@
 SPOOFAX=../../../spoofax/trunk/spoofax
 CLASSPATH=runtime:lib:compiler:spoofax-libs.jar:.
 JAVACFLAGS=-J-Xmx1024m -J-Xms512m -J-server -J-XX:+UseConcMarkSweepGC -cp $(CLASSPATH) -source 5 -nowarn -d bin
-JAVAC=`if false; then echo ecj; else echo javac; fi`
+JAVAC=`if which ecj >/dev/null; then echo ecj; else echo javac; fi`
 
 STRJ=XTC_REPOSITORY="$(BUILD_REPOSITORY)" ../trans/strj
 STRJFLAGS=--library --verbose 3 -clean -O 3

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java	2009-10-15 14:01:53 UTC (rev 20103)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/Context.java	2009-10-16 08:18:30 UTC (rev 20104)
@@ -138,8 +138,31 @@
     	exceptionHandler.setEnabled(isStandAlone);
     }
     
-    public IStrategoTerm invokeStrategyCLI(Strategy strategy, String appName, String[] args) {
-    	ITermFactory factory = getFactory();    	
+    public IStrategoTerm invokeStrategyCLI(Strategy strategy, String appName, String... args)
+    		throws StrategoExit, StrategoException {
+    	
+    	IStrategoList input = toCLITerm(appName, args);
+    	
+    	// Launch with a clean operand stack when launched from SSL_java_call, Ant, etc.
+    	if (new Exception().getStackTrace().length > 20) {
+    		return new StackSaver(strategy).invokeStackFriendly(this, input, NO_STRATEGIES, NO_TERMS);
+    	} else {
+    		return strategy.invoke(this, input);
+    	}
+    }
+    
+    public IStrategoTerm invokeStrategyCLI(String strategy, String appName, String... args)
+    		throws MissingStrategyException, StrategoExit, StrategoException {
+    	
+    	IStrategoList input = toCLITerm(appName, args);
+
+    	SSL_EXT_java_call caller = (SSL_EXT_java_call) lookupPrimitive("SSL_EXT_java_call");
+    	if (caller == null) caller = new SSL_EXT_java_call();
+    	return caller.call(this, strategy, input, false);
+    }
+
+	private IStrategoList toCLITerm(String appName, String... args) {
+		ITermFactory factory = getFactory();    	
     	IStrategoTerm[] termArgs = new IStrategoTerm[args.length + 1];
 		termArgs[0] = factory.makeString(appName);
 		
@@ -148,14 +171,8 @@
     	}
     	
     	IStrategoList term = factory.makeList(termArgs);
-    	
-    	// Launch with a clean operand stack when launched from SSL_java_call, Ant, etc.
-    	if (new Exception().getStackTrace().length > 20) {
-    		return new StackSaver(strategy).invokeStackFriendly(this, term, NO_STRATEGIES, NO_TERMS);
-    	} else {
-    		return strategy.invoke(this, term);
-    	}
-    }
+		return term;
+	}
     
     public final IStrategoTerm invokePrimitive(String name, IStrategoTerm term, Strategy[] sargs, IStrategoTerm[] targs) {
     	AbstractPrimitive primitive = lookupPrimitive(name);

Added: strc-java/trunk/java/runtime/org/strategoxt/lang/MissingStrategyException.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/MissingStrategyException.java	                        (rev 0)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/MissingStrategyException.java	2009-10-16 08:18:30 UTC (rev 20104)
@@ -0,0 +1,21 @@
+package org.strategoxt.lang;
+
+/**
+ * An exception thrown when a dynamically invoked strategy
+ * was not found or could otherwise not be used.
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class MissingStrategyException extends StrategoException {
+
+	private static final long serialVersionUID = -3945927901665941583L;
+
+	public MissingStrategyException(String message) {
+		this(message, null);
+	}
+
+	public MissingStrategyException(String message, Throwable cause) {
+		super(message, cause);
+	}
+
+}

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java	2009-10-15 14:01:53 UTC (rev 20103)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/StackSaver.java	2009-10-16 08:18:30 UTC (rev 20104)
@@ -57,7 +57,6 @@
 	 */
 	public IStrategoTerm invokeStackFriendly(final Context context, final IStrategoTerm current, final Strategy[] s, final IStrategoTerm[] t) {
 		int startDepth = context.getTraceDepth(true);
-		System.out.println("FREIND!" + strategy.getName() + "!" + startDepth); // DEBUG
 		activeThreadDepth += startDepth;
 		final FutureTask<IStrategoTerm> result = new FutureTask<IStrategoTerm>(new Callable<IStrategoTerm>() {
 			public IStrategoTerm call() throws Exception {

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java	2009-10-15 14:01:53 UTC (rev 20103)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/Strategy.java	2009-10-16 08:18:30 UTC (rev 20104)
@@ -1,9 +1,5 @@
 package org.strategoxt.lang;
 
-import java.util.concurrent.Callable;
-import java.util.concurrent.ExecutionException;
-import java.util.concurrent.FutureTask;
-
 import org.spoofax.interpreter.terms.IStrategoTerm;
 
 /**

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/SSL_EXT_java_call.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/SSL_EXT_java_call.java	2009-10-15 14:01:53 UTC (rev 20103)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/SSL_EXT_java_call.java	2009-10-16 08:18:30 UTC (rev 20104)
@@ -19,7 +19,7 @@
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.lang.Context;
 import org.strategoxt.lang.InteropContext;
-import org.strategoxt.lang.StrategoException;
+import org.strategoxt.lang.MissingStrategyException;
 import org.strategoxt.lang.StrategoExit;
 import org.strategoxt.lang.Strategy;
 
@@ -65,36 +65,49 @@
 		if (!isTermInt(tvars[2])) return false;
 
 		String className = ((IStrategoString) tvars[0]).stringValue();
-		IStrategoTerm arg = tvars[1];
+		IStrategoTerm input = tvars[1];
+		Context parentContext = ((InteropContext) env).getContext();
 		boolean sameContext = ((IStrategoInt) tvars[2]).intValue() != 0;
 		
+		IStrategoTerm result = call(parentContext, className, input, sameContext);
+		if (result != null) {
+			env.setCurrent(result);
+			return true;
+		} else {
+			return false;
+		}
+	}
+
+	public IStrategoTerm call(Context parentContext, String className, IStrategoTerm arg, boolean sameContext) {
 		Strategy strategy = getStrategy(className);
-		if (strategy == null) return false;
+		if (strategy == null) return null;
 
-		Context parentContext = ((InteropContext) env).getContext();
 		Context context;
 		String oldWorkingDir = null;
 		if (sameContext) {
 			context = parentContext;
 		} else {
-			oldWorkingDir = parentContext.getIOAgent().getWorkingDir();
-			context = new Context(parentContext.getFactory(), parentContext.getIOAgent());
+			if (parentContext != null) {
+				oldWorkingDir = parentContext.getIOAgent().getWorkingDir();
+				context = new Context(parentContext.getFactory(), parentContext.getIOAgent());
+			} else {
+				context = new Context();
+			}
 			context = initContext(context, className);
-			if (context == null) return false;
+			if (context == null) return null;
 		}
 
 		try {
 			IStrategoTerm result = strategy.invoke(context, arg);
 			if (result == null) {
-				return false;
+				return null;
 			} else {
-				env.setCurrent(result);
-				return true;
+				return result;
 			}
 		} catch (StrategoExit e) {
 			if (sameContext) throw new StrategoExit(e.getValue(), e);
 			
-			return e.getValue() == StrategoExit.SUCCESS;
+			return e.getValue() == StrategoExit.SUCCESS ? arg : null;
 		} finally {
 			try {
 				if (!sameContext) context.getIOAgent().setWorkingDir(oldWorkingDir);
@@ -128,11 +141,11 @@
 		} catch (NoSuchMethodException e) {
 			return null;
 		} catch (ClassCastException e) {
-			throw new StrategoException("Could not dynamically call strategy " + className, e);
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (InvocationTargetException e) {
-			throw new StrategoException("Could not dynamically call strategy " + className, e);
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (SecurityException e) {
-			throw new StrategoException("Could not dynamically call strategy " + className, e);
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		}
 	}
 
@@ -148,7 +161,7 @@
 				Field instance = library.getField("instance");
 
 				if (!Strategy.class.isAssignableFrom(instance.getDeclaringClass()))
-					return null;
+					throw new MissingStrategyException("Unable to initialize container library for strategy: " + className);
 				
 				cached = (Strategy) instance.get(null);
 				
@@ -156,28 +169,28 @@
 				library = Class.forName(toStrategoName(className));
 				cached = (Strategy) library.getMethod("getMainStrategy", new Class[0]).invoke(null);
 				if (cached == null)
-					throw new StrategoException("Component has no main strategy: " + className);
+					throw new MissingStrategyException("Component has no main strategy: " + className);
 			}
 			
 			invocationCache.put(className, cached);
 			return cached;
 			
 		} catch (ClassNotFoundException e) {
-			return null;
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (IllegalArgumentException e) {
-			return null;
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (NoSuchFieldException e) {
-			return null;
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (IllegalAccessException e) {
-			return null;
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (NoSuchMethodException e) {
-			return null;
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (ClassCastException e) {
-			throw new StrategoException("Could not dynamically call strategy " + className, e);
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (InvocationTargetException e) {
-			throw new StrategoException("Could not dynamically call strategy " + className, e);
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		} catch (SecurityException e) {
-			throw new StrategoException("Could not dynamically call strategy " + className, e);
+			throw new MissingStrategyException("Could not dynamically call strategy " + className, e);
 		}
 	}
 	

Added: strc-java/trunk/java/runtime/start.java
===================================================================
--- strc-java/trunk/java/runtime/start.java	                        (rev 0)
+++ strc-java/trunk/java/runtime/start.java	2009-10-16 08:18:30 UTC (rev 20104)
@@ -0,0 +1,37 @@
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.MissingStrategyException;
+import org.strategoxt.lang.StrategoExit;
+
+/**
+ * A helper class to invoke strategies using the command-line interface
+ * (example usage: java -cp strategoxt.jar start org.strategoxt.strj.main).
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class start {
+	public static void main(String[] strategyArgs) {
+		String strategy = strategyArgs[0];
+		String[] args = new String[strategyArgs.length - 1];
+		System.arraycopy(strategyArgs, 1, args, 0, args.length);
+		try {
+			Context context = new Context();
+			IStrategoTerm result = context.invokeStrategyCLI(strategy, strategy, args);
+			if (result == null) {
+				System.err.println(strategy + (context.getTraceDepth() != 0
+								? ": rewriting failed, trace:"
+								: ": rewriting failed"));
+				context.printStackTrace();
+				System.exit(1);
+			} else {
+				System.out.println(result);
+				System.exit(0);
+			}
+		} catch (MissingStrategyException e) {
+			e.printStackTrace();
+			System.exit(127);
+		} catch (StrategoExit e) {
+			System.exit(e.getValue());
+		}
+	}
+}

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)

Modified: strc-java/trunk/trans/s2j.str
===================================================================
--- strc-java/trunk/trans/s2j.str	2009-10-15 14:01:53 UTC (rev 20103)
+++ strc-java/trunk/trans/s2j.str	2009-10-16 08:18:30 UTC (rev 20104)
@@ -184,7 +184,7 @@
     ; x_name'       := <ApplicationName>
     ; pkgname       := <!package-dec? |[ package ~x:<get-config> "-p"; ]| <+ !None()>
     ; main          := <java-main-methods>
-    ; register      := <java-register-method> defs
+    ; register      := <java-interop-registerers> defs
     ; switch <get-config> "--stacktrace"
         case 0: e_traces := |[ false ]|
         case 1: e_traces := |[ true ]|
@@ -280,7 +280,7 @@
   
   // TODO: do interop strategy additions in a fully on-demand fashion?
   //       (need to adapt VarScope class to do so)
-  java-register-method : 
+  java-interop-registerers : 
     defs ->
     class-body-dec* |[
       public static void registerInterop(org.spoofax.interpreter.core.IContext context, Context compiledContext) {



From R.B.Vermaas at tudelft.nl  Fri Oct 16 12:14:31 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 16 Oct 2009 10:14:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20105 - rob - hydra
Message-ID: <200910161014.n9GAEVLa012279@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-16 10:14:30 +0000 (Fri, 16 Oct 2009)
New Revision: 20105

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20105&view=rev

Modified:
   hydra/job.nix

Log:
allow extra jobs

Changes:

Modified: hydra/job.nix
===================================================================
--- hydra/job.nix	2009-10-16 08:18:30 UTC (rev 20104)
+++ hydra/job.nix	2009-10-16 10:14:30 UTC (rev 20105)
@@ -1,8 +1,8 @@
-{ spec, inputs }:
+{ spec, inputs, extraJobs ? ( builder : {}) }:
 
 let
   pkgs       = import inputs.nixpkgs { };
-  systemPkgs = system : import inputs.nixpkgs ( { inherit system; } // ( if system == "i686-mingw" then { stdenvType = "i686-mingw"; } else {} ) );
+  systemPkgs = system : import inputs.nixpkgs ( { inherit system; } );
   pkgsDebRPM = import inputs.nixpkgs { system = "i686-linux" ; } ;
 
   builder = import ./build.nix ( inputs // { pkgsDefault = pkgs ; baseline = import inputs.baselineNix ; } ) ;
@@ -11,10 +11,11 @@
 
   jobs = {
     tarball = tarballTop ;
-    build   = { tarball ? jobs.tarball, system ? "i686-linux" }: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball tarball sysPkgs (spec sysPkgs) ;
+    build   = { tarball ? jobs.tarball, system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball tarball sysPkgs (spec sysPkgs) ;
     release = { tarball ? jobs.tarball }: builder.easyReleaseNix pkgsDebRPM spec tarball ;
   } // builder.debs pkgsDebRPM spec tarballTop
-    // builder.rpms pkgsDebRPM spec tarballTop ;
+    // builder.rpms pkgsDebRPM spec tarballTop
+    // extraJobs builder ;
 
 in jobs
 



From R.B.Vermaas at tudelft.nl  Fri Oct 16 12:18:00 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 16 Oct 2009 10:18:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20106 - rob - hydra/jobs
Message-ID: <200910161018.n9GAI0Bl012382@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-16 10:18:00 +0000 (Fri, 16 Oct 2009)
New Revision: 20106

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20106&view=rev

Modified:
   hydra/jobs/pil.nix

Log:
added pilc-java job

Changes:

Modified: hydra/jobs/pil.nix
===================================================================
--- hydra/jobs/pil.nix	2009-10-16 10:14:30 UTC (rev 20105)
+++ hydra/jobs/pil.nix	2009-10-16 10:18:00 UTC (rev 20106)
@@ -8,7 +8,7 @@
 let
   specs = import (hydraConfig + "/strategoxt/packages.nix") ; 
   jobs = 
-    import (hydraConfig + "/job.nix" ) { 
+    import (hydraConfig + "/job.nix" ) rec { 
       inputs = { 
         inherit officialRelease ; 
         inherit pilCheckout ;
@@ -20,6 +20,34 @@
       } ; 
    
       spec = specs.pil ; 
+
+      extraJobs = builder : {
+        pilcJava = { system ? "x86_64-linux" }: 
+          let pkgs = (import nixpkgs {}); 
+          in
+            pkgs.stdenv.mkDerivation (
+              (if (spec pkgs) ? svnCustomEnv then (spec pkgs).svnCustomEnv else {}) // rec {
+                name = "pilc-java" ;
+                src = pilCheckout;
+
+                inherit officialRelease;
+                preConfigure = ''   
+                  ./bootstrap
+                '';
+                buildPhase = '' 
+                  make javainstall
+                '';
+                installPhase = ''
+                  ensureDir $out/nix-support
+                  ensureDir $out/tarballs
+                  cp src/pilc-java.tar.gz $out/tarballs/pilc-java.tar.gz
+                  echo "file source-dist $out/tarballs/pilc-java.tar.gz" > $out/nix-support/hydra-build-products
+                '';
+
+                buildInputs =
+                  (spec pkgs).svnBuildInputs ++ (map (spec2: builder.easyBuild pkgs spec2) (spec pkgs).svnRequires);
+            });
+        };
     } ;
 
 in jobs



From R.B.Vermaas at tudelft.nl  Fri Oct 16 13:58:24 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 16 Oct 2009 11:58:24 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20107 - rob -
	hydra/strategoxt
Message-ID: <200910161158.n9GBwOwX014040@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-16 11:58:23 +0000 (Fri, 16 Oct 2009)
New Revision: 20107

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20107&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-16 10:18:00 UTC (rev 20106)
+++ hydra/strategoxt/packages.nix	2009-10-16 11:58:23 UTC (rev 20107)
@@ -142,12 +142,7 @@
         trunk = https://svn.strategoxt.org/repos/StrategoXT/stratego-shell/trunk;
       };
 
-      svnBuildInputs = buildInputs ++ [
-      pkgs.autoconf
-      pkgs.automake110x
-      pkgs.libtool_1_5
-      pkgs.pkgconfig
-    ] ;
+      svnBuildInputs = buildInputs ++ (autotools pkgs) ;
       svnRequires = requires;
       buildInputs = [pkgs.pkgconfig pkgs.readline5 pkgs.ncurses];
       requires = [strategoxt sdf2Bundle aterm];
@@ -581,9 +576,8 @@
           pkgs.pkgconfig
         ]; 
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux pkgs.apacheAnt ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.openjdkDarwin pkgs.antDarwin];
+      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux [pkgs.apacheAnt pkgs.ecj pkgs.jdk] ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.openjdkDarwin pkgs.antDarwin];
       requires = svnRequires;
-#      checkSupported = pkgs.stdenv.isLinux pkgs;
 
       extraVirtualDebs =
        let vdebs = [ "lzma" "openjdk-6-jre" "openjdk-6-jdk" "ant" ] ; in



From L.C.L.Kats at tudelft.nl  Fri Oct 16 14:24:56 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 16 Oct 2009 12:24:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20108 - LennartKats -
	spoofax-imp/tags
Message-ID: <200910161224.n9GCOuAY014565@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-16 12:24:54 +0000 (Fri, 16 Oct 2009)
New Revision: 20108

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20108&view=rev

Added:
   spoofax-imp/tags/spoofax-imp-calling-executables/

Log:
Tagged the last revision of Spoofax/IMP that still used locally installed native executables for building editors.

Changes:



From L.C.L.Kats at tudelft.nl  Fri Oct 16 15:09:05 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 16 Oct 2009 13:09:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20109 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.generator/src/sdf2imp
	org.strategoxt.imp.generator/src/sdf2imp/lib
	org.strategoxt.imp.metatooling
	org.strategoxt.imp.metatooling/META-INF
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego
	org.strategoxt.imp.runtime/META-INF
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <200910161309.n9GD95LF015373@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-16 13:09:04 +0000 (Fri, 16 Oct 2009)
New Revision: 20109

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20109&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/NativePrefixAntPropertyProvider.java
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/MetaIMPLibrary.java
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java
Removed:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/MetatoolingActivator.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java

Log:
- Moved the native SDF executable dependencies and handling from the runtime to the metatooling plugin
- Working on Ant support for the native sdf2table
- Added sdf2rtg's main strategy to sdf2imp


Changes:

Added: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str	2009-10-16 13:09:04 UTC (rev 20109)
@@ -0,0 +1,47 @@
+module lib/sdf2imp/sdf2rtg
+
+imports
+  libstratego-lib
+  libstratego-xtc
+  tool-doc
+
+signature constructors
+  IgnoreMissingCons : Option
+
+strategies
+
+  main-sdf2rtg =
+    xtc-io-wrap(
+      sdf-main-module-option + ignore-option
+    , sdf2rtg-usage
+    , sdf2rtg-about
+    , !["sdf2table", "implodePT", "sdf-desugar"]
+    , sdf2rtg; write-to
+    )
+
+  ignore-option =
+    Option("--ignore-missing-cons"
+    , <set-config> (IgnoreMissingCons(), ())
+    , !HelpString("--ignore-missing-cons", "Ignore productions that do not have a constructor (default: produce error)")
+    )
+
+  sdf2rtg-usage =
+    <tool-doc>
+      [ Usage("sdf2rtg [OPTIONS]")
+      , Summary(
+         "Generates an abstract syntax definition in the rtg language
+          from a SDF concrete syntax definition.")
+      , OptionUsage()
+      , AutoReportBugs()
+      ]
+
+  sdf2rtg-about =
+    <tool-doc>
+      [ AutoProgram()
+      , Author(Person("Martin Bravenboer", "martin.bravenboer at gmail.com"))
+      , GNU_LGPL("2002-2008", "Stratego Software Foundation <stratego at cs.uu.nl>")
+      , Config([
+          DefaultXTCRepository()
+        , CurrentXTCRepository()
+        ]) 
+      ]

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2009-10-16 13:09:04 UTC (rev 20109)
@@ -92,7 +92,7 @@
     end;
   
     configure-main-descriptor;
-    <sdf2rtg> input;
+    <sdf2rtg => RTG(_, ProdRules(<id>)); register-rtg> input;
     
     if not(IsLaunchedFromEclipse) then
       // We could build the table here, but doing it from ant is more customizable
@@ -142,9 +142,7 @@
       xtc-transform(!"implodePT");
       read-from;
       sdf-desugar;
-      core-sdf-grammar2rtg => rtg;
-      ?RTG(_, ProdRules(<id>));
-      register-rtg
+      core-sdf-grammar2rtg => rtg
 
   /* UNDONE: sdf2def converts a single SDF file to a DEF file.
   sdf2def: 

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF	2009-10-16 13:09:04 UTC (rev 20109)
@@ -26,7 +26,9 @@
  org.eclipse.ui.ide,
  org.strategoxt.strj,
  org.strategoxt.imp.editors.editorservice,
- org.strategoxt.imp.editors.sdf
+ org.strategoxt.imp.editors.sdf,
+ org.eclipse.ant.core,
+ sdf_eclipse_installer;bundle-version="1.0.10"
 Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Bundle-Activator: org.strategoxt.imp.metatooling.MetatoolingActivator
 Bundle-ActivationPolicy: lazy

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml	2009-10-16 13:09:04 UTC (rev 20109)
@@ -28,5 +28,12 @@
             project="true">
       </wizard>
    </extension>
+   <extension
+         point="org.eclipse.ant.core.antProperties">
+      <antProperty
+            class="org.strategoxt.imp.metatooling.NativePrefixAntPropertyProvider"
+            name="eclipse.spoofaximp.nativeprefix">
+      </antProperty>
+   </extension>
    
 </plugin>

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/MetatoolingActivator.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/MetatoolingActivator.java	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/MetatoolingActivator.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -8,6 +8,7 @@
 import org.eclipse.core.runtime.FileLocator;
 import org.eclipse.core.runtime.Path;
 import org.eclipse.ui.plugin.AbstractUIPlugin;
+import org.strategoxt.imp.metatooling.stratego.MetaIMPLibrary;
 
 public class MetatoolingActivator extends AbstractUIPlugin {
 
@@ -15,6 +16,7 @@
 	
 	public MetatoolingActivator() {
 		instance = this;
+		MetaIMPLibrary.init();
 	}
 
 	public static MetatoolingActivator getDefault() { 

Added: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/NativePrefixAntPropertyProvider.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/NativePrefixAntPropertyProvider.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/NativePrefixAntPropertyProvider.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -0,0 +1,23 @@
+package org.strategoxt.imp.metatooling;
+
+import java.io.IOException;
+
+import org.eclipse.ant.core.IAntPropertyValueProvider;
+import org.strategoxt.imp.runtime.Environment;
+import org.syntax_definition.sdf.Activator;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class NativePrefixAntPropertyProvider implements IAntPropertyValueProvider {
+
+	public String getAntPropertyValue(String antPropertyName) {
+		try {
+			return Activator.getInstance().getBinaryPrefix().getParentFile().getAbsolutePath();
+		} catch (IOException e) {
+			Environment.logException("Could not determine the prefix path for the native tool bundle", e);
+			return ".";
+		}
+	}
+	
+}

Added: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/MetaIMPLibrary.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/MetaIMPLibrary.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/MetaIMPLibrary.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -0,0 +1,12 @@
+package org.strategoxt.imp.metatooling.stratego;
+
+import org.strategoxt.stratego_xtc.xtc_command_1_0;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class MetaIMPLibrary {
+	public static void init() {
+		xtc_command_1_0.instance = new SDFBundleCommand();
+	}
+}

Copied: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java (from rev 20100, spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -0,0 +1,101 @@
+package org.strategoxt.imp.metatooling.stratego;
+
+import static org.spoofax.interpreter.terms.IStrategoTerm.*;
+
+import java.io.File;
+import java.io.IOException;
+import java.io.PrintStream;
+
+import org.spoofax.interpreter.library.IOAgent;
+import org.spoofax.interpreter.terms.IStrategoList;
+import org.spoofax.interpreter.terms.IStrategoString;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.StrategoException;
+import org.strategoxt.lang.compat.NativeCallHelper;
+import org.strategoxt.stratego_xtc.xtc_command_1_0;
+import org.syntax_definition.sdf.Activator;
+
+/**
+ * Overrides the xtc-command strategy to use sdf2table
+ * from the SDF plugin.
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class SDFBundleCommand extends xtc_command_1_0 {
+	
+	private final xtc_command_1_0 proceed = xtc_command_1_0.instance;
+
+	private File binaryPrefix;
+	
+	private String binaryPostfix;
+	
+	private void init() throws IOException {
+		if (binaryPostfix != null) return;
+		Activator sdfBundle = Activator.getInstance();
+		binaryPrefix = sdfBundle.getBinaryPrefix();
+		binaryPostfix = sdfBundle.getBinaryPostfix();
+	}
+	
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm args,
+			org.strategoxt.lang.Strategy command) {
+		
+		try {
+			init();
+		} catch (IOException e) {
+			Environment.logException("Could not determine the prefix path for the native tool bundle", e);
+			return proceed.invoke(context, args, command);
+		}
+		
+		IStrategoTerm commandTerm = command.invoke(context, args);
+		if (commandTerm.getTermType() != STRING)
+			return proceed.invoke(context, args, command);
+		
+		String commandName = ((IStrategoString) commandTerm).stringValue();
+		if (!new File(binaryPrefix + "/" + commandName + binaryPostfix).exists())
+			return proceed.invoke(context, args, command);
+		
+		if (args.getTermType() != LIST)
+			return null;
+		
+		return invokeSDF2Table(context, commandName, ((IStrategoList) args).getAllSubterms())
+			? args
+			: null;
+	}
+
+	private boolean invokeSDF2Table(Context context, String command, IStrategoTerm[] argList) throws StrategoException {
+		// HACK: concatenating all command-line arguments...
+		StringBuilder allArgs = new StringBuilder();
+		String[] commandArgs = new String[argList.length + 1];
+		int i = 1;
+		for (IStrategoTerm arg : argList) {
+			if (arg.getTermType() != STRING) return false;
+			allArgs.append(' ');
+			allArgs.append(((IStrategoString) arg).stringValue());
+			commandArgs[i++] = ((IStrategoString) arg).stringValue();
+		}
+		
+		try {
+			/*
+			InputStream result = Tools.exec("sdf2table " + allArgs, System.in);
+			// Synchronously copy the std error stream
+			PrintStream stderr = context.getIOAgent().getOutputStream(IOAgent.CONST_STDERR);
+			new NativeCallHelper.StreamCopier(result, stderr).run();
+			*/
+			commandArgs[0] = binaryPrefix + "/" + command + binaryPostfix;
+			String[] environment = { "PATH=" + binaryPrefix.getAbsolutePath(), 
+					                 "LD_LIBRARY_PATH=" + binaryPrefix.getParentFile().getAbsolutePath() + "/lib" };
+			IOAgent io = context.getIOAgent();
+			PrintStream stdout = io.getOutputStream(IOAgent.CONST_STDOUT);
+			PrintStream stderr = io.getOutputStream(IOAgent.CONST_STDERR);
+			int result = new NativeCallHelper().call(commandArgs, environment, new File(io.getWorkingDir()), stdout, stderr);
+			return result == 0;
+		} catch (IOException e) {
+			return false;
+		} catch (InterruptedException e) {
+			throw new StrategoException("Could not call sdf2table", e);
+		}
+	}
+}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	2009-10-16 13:09:04 UTC (rev 20109)
@@ -21,8 +21,7 @@
  org.eclipse.ui,
  org.spoofax.compiler,
  org.strategoxt.imp.generator,
- org.strategoxt.strj,
- sdf_eclipse_installer
+ org.strategoxt.strj
 Export-Package: org.strategoxt.imp.runtime,
  org.strategoxt.imp.runtime.dynamicloading,
  org.strategoxt.imp.runtime.parser,

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -63,7 +63,6 @@
 		descriptors = Collections.synchronizedMap(new HashMap<String, Descriptor>());
 		wrappedAstNodeFactory = new WrappedAstNodeFactory();
 		IMPJSGLRLibrary.init();
-		IMPLibrary.init();
 	}
 	
 	// TODO: Split up shared and non-shared environment entities?

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoFeedback.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -260,6 +260,8 @@
 		    feedbackToMarkers(sourceInfo, warnings, IMarker.SEVERITY_WARNING);
 		    feedbackToMarkers(sourceInfo, notes, IMarker.SEVERITY_INFO);
 		} else if (feedback == null) {
+			// Note that this condition may also be reached when
+			// the semantic service hasn't been loaded yet
 			IResource resource = ((SGLRParseController) sourceInfo).getResource();
 			if (log.length() == 0) log = "(see error log)"; // TODO: report or throw last exception if strategy not found etc.
 			messages.addMarkerFirstLine(resource, "Analysis failed: " + log, IMarker.SEVERITY_ERROR);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -13,10 +13,6 @@
 	public IMPLibrary() {
 		add(new SubtermPrimitive());
 	}
-	
-	public static void init() {
-		xtc_command_1_0.instance = new SDFBundleCommand();
-	}
 
 	public String getOperatorRegistryName() {
 		return REGISTRY_NAME;

Deleted: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java	2009-10-16 12:24:54 UTC (rev 20108)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SDFBundleCommand.java	2009-10-16 13:09:04 UTC (rev 20109)
@@ -1,100 +0,0 @@
-package org.strategoxt.imp.runtime.stratego;
-
-import static org.spoofax.interpreter.terms.IStrategoTerm.*;
-
-import java.io.File;
-import java.io.IOException;
-import java.io.PrintStream;
-
-import org.spoofax.interpreter.library.IOAgent;
-import org.spoofax.interpreter.terms.IStrategoList;
-import org.spoofax.interpreter.terms.IStrategoString;
-import org.spoofax.interpreter.terms.IStrategoTerm;
-import org.strategoxt.lang.Context;
-import org.strategoxt.lang.StrategoException;
-import org.strategoxt.lang.compat.NativeCallHelper;
-import org.strategoxt.stratego_xtc.xtc_command_1_0;
-import org.syntax_definition.sdf.Activator;
-
-/**
- * Overrides the xtc-command strategy to use sdf2table
- * from the SDF plugin.
- * 
- * @author Lennart Kats <lennart add lclnet.nl>
- */
-public class SDFBundleCommand extends xtc_command_1_0 {
-	
-	private final xtc_command_1_0 proceed = xtc_command_1_0.instance;
-
-	private File binaryPrefix;
-	
-	private String binaryPostfix;
-	
-	private void init() throws IOException {
-		if (binaryPostfix != null) return;
-		Activator sdfBundle = Activator.getInstance();
-		binaryPrefix = sdfBundle.getBinaryPrefix();
-		binaryPostfix = sdfBundle.getBinaryPostfix();
-	}
-	
-	@Override
-	public IStrategoTerm invoke(Context context, IStrategoTerm args,
-			org.strategoxt.lang.Strategy command) {
-		
-		try {
-			init();
-		} catch (IOException e) {
-			e.printStackTrace();
-			return proceed.invoke(context, args, command);
-		}
-		
-		IStrategoTerm commandTerm = command.invoke(context, args);
-		if (commandTerm.getTermType() != STRING)
-			return proceed.invoke(context, args, command);
-		
-		String commandName = ((IStrategoString) commandTerm).stringValue();
-		if (!new File(binaryPrefix + "/" + commandName + binaryPostfix).exists())
-			return proceed.invoke(context, args, command);
-		
-		if (args.getTermType() != LIST)
-			return null;
-		
-		return invokeSDF2Table(context, commandName, ((IStrategoList) args).getAllSubterms())
-			? args
-			: null;
-	}
-
-	private boolean invokeSDF2Table(Context context, String command, IStrategoTerm[] argList) throws StrategoException {
-		// HACK: concatenating all command-line arguments...
-		StringBuilder allArgs = new StringBuilder();
-		String[] commandArgs = new String[argList.length + 1];
-		int i = 1;
-		for (IStrategoTerm arg : argList) {
-			if (arg.getTermType() != STRING) return false;
-			allArgs.append(' ');
-			allArgs.append(((IStrategoString) arg).stringValue());
-			commandArgs[i++] = ((IStrategoString) arg).stringValue();
-		}
-		
-		try {
-			/*
-			InputStream result = Tools.exec("sdf2table " + allArgs, System.in);
-			// Synchronously copy the std error stream
-			PrintStream stderr = context.getIOAgent().getOutputStream(IOAgent.CONST_STDERR);
-			new NativeCallHelper.StreamCopier(result, stderr).run();
-			*/
-			commandArgs[0] = binaryPrefix + "/" + command + binaryPostfix;
-			String[] environment = { "PATH=" + binaryPrefix.getAbsolutePath(), 
-					                 "LD_LIBRARY_PATH=" + binaryPrefix.getParentFile().getAbsolutePath() + "/lib" };
-			IOAgent io = context.getIOAgent();
-			PrintStream stdout = io.getOutputStream(IOAgent.CONST_STDOUT);
-			PrintStream stderr = io.getOutputStream(IOAgent.CONST_STDERR);
-			int result = new NativeCallHelper().call(commandArgs, environment, new File(io.getWorkingDir()), stdout, stderr);
-			return result == 0;
-		} catch (IOException e) {
-			return false;
-		} catch (InterruptedException e) {
-			throw new StrategoException("Could not call sdf2table", e);
-		}
-	}
-}



From L.C.L.Kats at tudelft.nl  Fri Oct 16 17:31:06 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 16 Oct 2009 15:31:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20110 - LennartKats -
	in strc-java/trunk/java: . tools tools/org
	tools/org/strategoxt tools/org/strategoxt/tools
	tools/org/strategoxt/tools/lib tools/org/strategoxt/tools/sdf2rtg
Message-ID: <200910161531.n9GFV6SE017171@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-16 15:31:05 +0000 (Fri, 16 Oct 2009)
New Revision: 20110

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20110&view=rev

Added:
   strc-java/trunk/java/tools/
   strc-java/trunk/java/tools/org/
   strc-java/trunk/java/tools/org/strategoxt/
   strc-java/trunk/java/tools/org/strategoxt/tools/
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/asfix-abstractions.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.meta
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.meta
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/module-option.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf-options.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/pp-rtg.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/rtg-ppfix.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/rtg2sig.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/sdf-desugar.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/sdf-options.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/sdf2rtg.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/stratego-rtg.meta
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/stratego-rtg.str
   strc-java/trunk/java/tools/org/strategoxt/tools/sdf2rtg/
   strc-java/trunk/java/tools/org/strategoxt/tools/tools.str
Modified:
   strc-java/trunk/java/Makefile.am

Log:
Added sdf2rtg, rtg2sig, and pack-sdf to the org.strategoxt.tools package, so they can be invoked as:
  java -cp strategoxt.jar start org.strategoxt.tools.main-sdf2rtg
(Unfortunately these tools were not yet librarified, so I had to partially copy and adapt them for inclusion here.)

Changes (first 1000 lines of the diffs):

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-16 13:09:04 UTC (rev 20109)
+++ strc-java/trunk/java/Makefile.am	2009-10-16 15:31:05 UTC (rev 20110)
@@ -34,6 +34,13 @@
   lib/org/strategoxt/strc/Main.java \
   lib/org/strategoxt/java_front/Main.java
 
+TOOLJAVAS = \
+  tools/org/strategoxt/tools/Main.java
+
+TOOLSTRS = \
+  $(wildcard tools/org/strategoxt/tools/*.str) \
+  $(wildcard tools/org/strategoxt/tools/lib/*.str)
+
 nobase_pkgdata_DATA = \
   runtime/org/strategoxt/lang/parallel/stratego_parallel/libstratego-parallel.rtree \
   $(LIBRARYJAVAS) $(COMPILERJAVAS) .ALLCLASSES
@@ -55,8 +62,11 @@
   bin \
   META-INF/MANIFEST.MF
 
+STRINCLUDES= \
+  -I $(STRATEGOXT)/share/sdf/stratego-regular
+
 CLEANFILES = \
-  $(LIBRARYJAVAS) $(COMPILERJAVAS) \
+  $(LIBRARYJAVAS) $(COMPILERJAVAS) $(TOOLJAVAS) \
   runtime/org/strategoxt/lang/compat/override/stratego_aterm_compat.rtree \
   lib/org/strategoxt/stratego-xtc.rtree \
   .ALLCLASSES
@@ -65,7 +75,7 @@
 	rm -rf bin/* lib/org/strategoxt/*
 
 SPOOFAX=../../../spoofax/trunk/spoofax
-CLASSPATH=runtime:lib:compiler:spoofax-libs.jar:.
+CLASSPATH=runtime:lib:compiler:tools:spoofax-libs.jar:.
 JAVACFLAGS=-J-Xmx1024m -J-Xms512m -J-server -J-XX:+UseConcMarkSweepGC -cp $(CLASSPATH) -source 5 -nowarn -d bin
 JAVAC=`if which ecj >/dev/null; then echo ecj; else echo javac; fi`
 
@@ -77,7 +87,7 @@
 JARIN2=`find lib      | grep -E '\.rtree|\.af|\.tbl' | sed 's!lib/!-C lib/ !'`
 JARIN3=`find compiler | grep -E '\.rtree|\.af|\.tbl' | sed 's!compiler/!-C compiler/ !'`
 
-jar strategoxt.jar : spoofax-libs.jar # .ALLCLASSES $(RUNTIMEJAVAS) $(LIBARYJAVAS) $(COMPILERJAVAS)
+jar strategoxt.jar : spoofax-libs.jar # .ALLCLASSES $(RUNTIMEJAVAS) $(LIBRARYJAVAS) $(TOOLJAVAS) $(COMPILERJAVAS)
 	@if [ ! -e bin/org/strategoxt/stratego_lib/Main.class ]; then \
 	  echo "Standard library classes not found; please run 'make all' first." >&2; exit 1; \
 	fi 
@@ -114,11 +124,11 @@
 
 .ALLCLASSES : bin/org/strategoxt/strj/Main.class
 
-bin/org/strategoxt/strj/Main.class : $(RUNTIMEJAVAS) $(LIBARYJAVAS) $(COMPILERJAVAS)
+bin/org/strategoxt/strj/Main.class : $(RUNTIMEJAVAS) $(LIBARYJAVAS) $(TOOLJAVAS) $(COMPILERJAVAS)
 	@if ! which ecj >/dev/null; \
 	  then echo "WARNING: ecj is not installed; using the (much) slower javac compiler instead" >&2; \
 	fi
-	$(JAVAC) $(JAVACFLAGS) $(RUNTIMEJAVAS) $(LIBRARYJAVAS) $(COMPILERJAVAS) && touch .ALLCLASSES
+	$(JAVAC) $(JAVACFLAGS) $(RUNTIMEJAVAS) $(LIBRARYJAVAS) $(TOOLJAVAS) $(COMPILERJAVAS) && touch .ALLCLASSES
 
 debug-classes : $(RUNTIMEJAVA)
 	$(JAVAC) -g $(JAVACFLAGS) $(RUNTIMEJAVAS)
@@ -191,11 +201,16 @@
 runtime/org/strategoxt/lang/compat/override/strc_compat/Main.java : runtime/org/strategoxt/lang/compat/override/strc-compat.str ../trans/strj runtime/org/strategoxt/lang/parallel/stratego_parallel/libstratego-parallel.rtree
 	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/stratego-front -I $(STRATEGOXT)/share/xtc -I $(STRATEGOXT)/share/stratego-lib -I $(JAVA_FRONT)/share/java-front -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.strc_compat -la stratego-lib -la stratego-xtc -la org.strategoxt.strc -I runtime/org/strategoxt/lang/parallel/stratego_parallel
 
+###### TOOLS #######
+
+tools/org/strategoxt/tools/Main.java : $(TOOLSTRS:.str=.rtree)
+	$(STRJ) -i tools/org/strategoxt/tools/tools.rtree -o $@ $(STRJFLAGS) -p org.strategoxt.tools -la stratego-lib -la stratego-xtc -la stratego-gpp -la stratego-rtg -la stratego-sglr -la stratego-tool-doc -I $(STRATEGOXT)/share/sdf/xml-front -I tools/org/strategoxt/tools/lib -I $(STRATEGOXT)/share/sdf/gpp -I $(STRATEGOXT)/share/sdf/stratego-regular -I $(STRATEGOXT)/share/stratego-regular -I $(STRATEGOXT)/share/sdf/sdf-front
+
 ###### COMPILER #######
 
 compiler/org/strategoxt/strj/Main.java : ../trans/strj.ctree ../trans/strj
 	[ -e compiler/org/strategoxt ] || mkdir -p compiler/org/strategoxt
-	$(STRJ) -i $< -o $@ -clean -p org.strategoxt.strj --verbose 3 -la stratego-lib -la stratego-xtc -la stratego-gpp -la org.strategoxt.strc -la org.strategoxt.java_front -O 3 # -D DEFAULT_XTC_REPOSITORY="\"$(REPOSITORY)\""
+	$(STRJ) -i $< -o $@ -clean -p org.strategoxt.strj --verbose 3 -la stratego-lib -la stratego-xtc -la stratego-gpp -la strc -la java-front -O 3 # -D DEFAULT_XTC_REPOSITORY="\"$(REPOSITORY)\""
 
 ###### EXTERNAL #######
 

Copied: strc-java/trunk/java/tools/org/strategoxt/tools/lib/asfix-abstractions.str (from rev 20107, spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/asfix-abstractions.str)
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/asfix-abstractions.str	                        (rev 0)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/asfix-abstractions.str	2009-10-16 15:31:05 UTC (rev 20110)
@@ -0,0 +1,112 @@
+module asfix-abstractions
+imports
+  asfix-extra
+
+signature
+constructors
+   ConcLayout: Layout -> Conclayout
+   'id : a -> a
+
+/**
+ * Lists
+ */
+overlays
+
+  conc-prod(s) = 
+    prod([cf(iter(s)),cf(opt(layout())),cf(iter(s))],cf(iter(s)),no-attrs())
+
+  iter-inj-prod(s) =
+    prod([cf(s)], cf(iter(s)), no-attrs())
+
+  af-iter-inj(s, x) =
+    appl(iter-inj-prod(s), [x])
+
+  af-conc(s,x,l,y) = 
+    appl(conc-prod(s), [x, l, y])
+
+/**
+ * START and LAYOUT
+ */
+overlays
+
+  flatlit(str) = flatlex(lit(str), str)
+
+  white(str) = flatlex(cf(opt(layout())), str)
+
+  start(s,l1,x,l2) =       
+    appl(prod([cf(opt(layout())),cf(sort(s)),cf(opt(layout()))],
+              sort("<START>"),no-attrs()),
+         [l1,x,l2])
+
+  CfLayout(l) =
+     appl(prod([lex(layout())], cf(layout()), no-attrs()), [l])
+
+  ConcCfLayout(l1, l2) = 
+     appl(prod([cf(layout()), cf(layout())], cf(layout()), attrs([assoc(left())])), [l1, l2])
+
+  NoCfLayout = 
+     appl(prod([], cf(opt(layout())), no-attrs()), [])
+     
+  CfOptLayout(l) =
+     appl(prod([cf(layout())], cf(opt(layout())), no-attrs()), [l])
+
+  Space =
+    CfLayout(appl(prod([char-class([range(9,10),13,32])],lex(layout()),attrs([prefer()])), [32]))
+
+  NewLine =
+    CfLayout(appl(prod([char-class([range(9,10),13,32])],lex(layout()),attrs([prefer()])), [10]))
+
+  OptNewLine =
+     CfOptLayout(NewLine())
+
+strategies
+
+  yield = rec x(appl(id, map(x)); \ appl(p, ts) -> <concat> ts \
+                <+ \ flatlex(_, str) -> <explode-string> str \
+	        <+ \ a -> [a] \ ); 
+          implode-string
+
+rules
+
+  flatten : appl(prod(_,srt,_), ts) -> flatlex(srt, str)
+	    where yield => str
+
+  flatten : flatlex(srt,str) -> flatlex(srt,str)
+
+  lit-tree :
+    str -> appl(prod(char-sorts, lit(str), no-attrs()), chars)
+    where <explode-string> str => chars;
+          <map( \c -> char-class([c])\ )> chars => char-sorts
+
+  conc-layout1 : 
+    (CfOptLayout(l1), CfOptLayout(l2)) -> 
+    CfOptLayout(ConcCfLayout(l1, l2))
+
+  conc-layout2 : 
+    (NoCfLayout(), l) -> l
+
+  conc-layout3 : 
+    (l, NoCfLayout()) -> l
+
+strategies
+
+  conc-layout = conc-layout1 <+ conc-layout2 <+ conc-layout3
+
+rules
+
+  UnStart : start(s,l1,x,l2) -> (l1, x, l2)
+
+  CombineLayout(s1,s2) : 
+    ((l1, x, l2), (l3, y, l4)) -> 
+    (l1, <s1> (x, <s2>(l2, l3), y), l4)
+
+strategies
+
+  concat-layout =
+    foldr1a(conc-layout <+ !ConcLayout(<id>))
+
+  foldr1a(s) =
+    rec f( 
+       \ [x] -> x \
+    <+ \ [a,b|xs] -> <f>[<s>(a, b)|xs] \
+    )

Copied: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.meta (from rev 20046, strategoxt/trunk/stratego-regular/trans/sig/core-rtg2sig.meta)
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.meta	                        (rev 0)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.meta	2009-10-16 15:31:05 UTC (rev 20110)
@@ -0,0 +1,3 @@
+Meta(
+ [ Syntax("StrategoStratego" ) ]
+)


Property changes on: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.meta
___________________________________________________________________
Added: svn:mergeinfo
   + /strategoxt/branches/strategoxt-annos/stratego-regular/trans/sig/core-rtg2sig.meta:19217-19721
/strategoxt/branches/strategoxt-with/stratego-regular/trans/sig/core-rtg2sig.meta:18038-18120

Copied: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.str (from rev 20046, strategoxt/trunk/stratego-regular/trans/sig/core-rtg2sig.str)
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.str	                        (rev 0)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.str	2009-10-16 15:31:05 UTC (rev 20110)
@@ -0,0 +1,104 @@
+/**
+ * Generates a Stratego signature from an RTG.
+ *
+ * @author  Martin Bravenboer <martin.bravenboer at gmail.com>
+ */
+module core-rtg2sig 
+imports
+  lib/stratego-rtg
+  libstratego-lib
+
+strategies
+
+  /**
+   * @type  RTG -> StrategoModule
+   */ 
+  core-rtg2sig(|modulename) =
+      rtg-group-productions
+    ; RTG(id, ProdRules(map(ProdRule(id, make-set))))
+    ; RTG(id, ProdRules(filter(not(ignore-prodrule))))
+    ; rtg-ungroup-productions
+
+    ; ?RTG(Start(starts), ProdRules(prods))
+    ; !|[
+        module ~modulename
+        signature
+          constructors
+            ~*<map(prodrule-to-constr)> prods
+
+        signature
+          constructors
+            Some : a -> Option(a)
+            None : Option(a)
+
+        signature
+          constructors
+            Cons : a * List(a) -> List(a)
+            Nil  : List(a)
+            Conc : List(a) * List(a) -> List(a)
+      ]|
+
+/**
+ * @todo  Create at least some constructors for labelled content models
+ * @todo  Anonymous term applications
+ */
+strategies
+
+  /**
+   * @type  ProdRule -> Opdecl
+   */
+  prodrule-to-constr =
+       empty-prodrule-to-constr
+    <+ not-empty-prodrule-to-constr
+    <+ ref-prodrule-to-constr
+    <+ log(|Error(), "Cannot rewrite production", <id>); fail
+
+/**
+ * This somewhat ad-hoc, but it works fine for sdf2rtg | rtg2sig 
+ */
+strategies
+
+  ignore-prodrule =
+       declare-plus-list
+    <+ is-list-prodrule
+    <+ declare-option
+
+  is-list-prodrule = 
+    where(
+      collect(?Appl(<id>, []))
+    ; ?[_|_]
+    ; map(ConcTerm() + ConsTerm() + NilTerm())
+    )
+
+  declare-option =
+    ?ProdRule(Nonterm(srtx1), alts)
+    ; where(
+        <length> alts => 2
+      ; <fetch(?Appl(NoneTerm(), []))> alts
+      ; <fetch(?Appl(SomeTerm(), [Ref(Nonterm(srtx))]))> alts
+      ; rules(
+          OptionTree2Sort : Ref(Nonterm(srtx1)) -> Sort |[ Option(srtx) ]|
+        )
+      )
+
+  declare-plus-list =
+    ?ProdRule(Nonterm(srtx1), alts)
+    ; where(
+        <make-set> alts => alts1
+      ; <length> alts1 => 4
+      ; !alts1
+      ; filter(?Appl(ConcTerm(), [Ref(_), Ref(_)]))
+      ; length => 3
+      ; !alts1
+      ; fetch(?Appl(ConsTerm(), [Ref(Nonterm(srtx)), Ref(Nonterm(srtx2))]))
+      ; rules(
+          ListTree2Sort : Ref(Nonterm(srtx1)) -> Sort |[ List(srtx) ]|
+          ListTree2Sort : Ref(Nonterm(srtx2)) -> Sort |[ List(srtx) ]|
+        )
+      )
+
+
+
+
+
+


Property changes on: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-rtg2sig.str
___________________________________________________________________
Added: svn:mergeinfo
   + /strategoxt/branches/strategoxt-annos/stratego-regular/trans/sig/core-rtg2sig.str:19217-19721
/strategoxt/branches/strategoxt-with/stratego-regular/trans/sig/core-rtg2sig.str:18038-18120

Copied: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.meta (from rev 20107, spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/core-sdf-grammar2rtg.meta)
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.meta	                        (rev 0)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.meta	2009-10-16 15:31:05 UTC (rev 20110)
@@ -0,0 +1 @@
+Meta([Syntax("Stratego-rtg")])
\ No newline at end of file


Property changes on: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.meta
___________________________________________________________________
Added: svn:mergeinfo
   + /spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/sdf2imp/lib/core-sdf-grammar2rtg.meta:19707-19736

Copied: strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.str (from rev 20107, spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/core-sdf-grammar2rtg.str)
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.str	                        (rev 0)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/core-sdf-grammar2rtg.str	2009-10-16 15:31:05 UTC (rev 20110)
@@ -0,0 +1,621 @@
+/**
+ * Converts a normalized SDF grammar in abstract syntax to an RTG in abstract syntax.
+ *
+ * @author  Martin Bravenboer <martin.bravenboer at gmail.com>
+ */
+module lib/sdf2imp/core-sdf-grammar2rtg
+imports
+  libstratego-lib
+  libstratego-rtg
+  libstratego-sdf
+  sdf/tool/xtc
+  libstratego-xtc
+
+strategies
+
+  /**
+   * @type  Grammar -> RTG
+   */
+  core-sdf-grammar2rtg =
+    where(
+      <table-create> "generated-nonterms"
+    )
+  ; where(
+      collect-om(?syntax(_))
+    ; map(grammar2prodrules <+ fatal-err(|"sdf2rtg: Rewriting syntax section failed"); fail)
+    ; concat
+    ; if ?[] then
+        fatal-err-msg(|"No production rules in RTG. Did you specify the right main module?")
+      else
+        ?prods
+      end
+    )
+
+    /**
+     * @todo  use start symbols of SDF
+     */
+  ; collect-om(is-start-prod)
+  ; if ?[] then
+      fatal-err(|"No start productions found. Did you specify any start-symbols in the syntax definition?")
+    else
+      map(start-prod2tree; ?Ref(<id>) <+ err(!"Rewriting production to nonterm failed"); fail)
+    ; !RTG(Start(<id>), ProdRules(prods))
+    end
+
+
+/**
+ * @type  Grammar -> List(ProdRule)
+ */
+strategies
+
+  grammar2prodrules :
+    syntax(prods) ->
+      < remove-all(ignore-prod)
+      ; map({p:
+          ?p
+        ; (  listinj2prodrule
+          <+ seq2prodrule
+          <+ alt2prodrule
+          <+ var2prodrule
+          <+ opt2prodrule
+          <+ inj2prodrule
+          <+ prod2prodrule
+          <+ fatal-err(|"sdf2rtg: Rewriting production failed"); fail
+          )
+        ; where(try(<cycle-error> (p, <id>)))
+        })
+      ; remove-all(?[])
+      > prods
+
+  grammar2prodrules =
+    ?context-free-syntax(_)
+    ; fatal-err(|"context-free syntax in input hasn't been normalized to syntax")
+
+  grammar2prodrules =
+    ?lexical-syntax(_)
+    ; fatal-err(|"lexical syntax in input hasn't been normalized to syntax")
+
+  cycle-error =
+    ?(p, rtg |[ A -> A ]|)
+    ; <fatal-err(|"production rule resulted in a direct cycle")> p
+
+strategies
+
+  /**
+   * Ignore layout productions.
+   *
+   * @type Production ->? _
+   */
+  ignore-prod =
+    ?prod(_, cf(layout()), _)
+
+  ignore-prod =
+    ?prod(_, cf(opt(layout())), _)
+
+  /**
+   * Ignore lexical productions.
+   */
+  ignore-prod =
+    ?prod(_, lex(_), _)
+
+  ignore-prod = 
+    ?prod(_,lit(_), _)
+
+  ignore-prod = 
+    ?prod(_,ci-lit(_), _)
+
+  ignore-prod =
+    ?prod([lex(iter-star(char-class(_)))], cf(iter-star(char-class(_))), _)
+
+  ignore-prod =
+    ?prod([lex(_)],  sym, _)
+    ; where(<oncetd(?char-class(_))> sym)
+
+  /*
+  cf(alt(
+       char-class(simple-charclass(present(conc(range(numeric("\\0"),numeric("\\92")),range(numeric("\\94"),numeric("\\255"))))))
+     , alt(sort("CloseBracket"),sort("TwoCloseBrackets"))
+     )
+  )*/
+
+
+  /**
+   * Ignore syntax -> context-free injections
+   */
+  ignore-prod =
+    ?prod([a],  cf(a), _)
+
+  /**
+   * Ignore varsym -> context-free injections
+   */
+  ignore-prod =
+    ?prod([varsym(cf(a))], cf(a), _)
+
+  /**
+   * Ignore lit -> lit | lit | lit productions
+   */
+  ignore-prod =
+    ?prod([lit(_)], cf(alt(lit(_), more)),attrs([]))
+    ; where(
+        <rec rec(lit(id) + alt(rec, rec))> more
+      )
+
+  ignore-prod =
+    ?prod([start()], sort("SURROGATE-START"), _)
+
+  ignore-prod =
+    ?prod(_, file-start(), _)
+
+  /**
+   * Ignore a reject production that injects A into A.
+   */
+  ignore-prod =
+    ?prod(_, _, attrs(attrs)); where(<contains-reject> attrs)
+
+
+  /**
+   * Ignore aux. productions
+   */
+  ignore-prod =
+    ?prod(_, _, attrs(attrs)); where(<contains-rtg(?ignore())> attrs)
+
+  /**
+   * Ignore a bracket production that injects A into A.
+   */
+  ignore-prod =
+    prod(?syms, cf(match-sort(?x)), ?attrs(attrs))
+    ; where(
+        <contains-bracket> attrs
+      ; <not(get-cnstr-name)> attrs
+      ; <syms2trees> syms => [ rtg |[ x ]| ]
+      )
+
+  match-sort(s) =
+    sort(s)
+
+  match-sort(s) =
+    parameterized-sort(s, id)
+
+  ignore-prod =
+    is-start-prod
+
+  is-start-prod =
+    ?prod(_, start(), _)
+
+  start-prod2tree :
+    prod(syms, start(), _) -> t
+      where <syms2trees> syms => [t]
+
+strategies
+
+  /**
+   * Rewrites a context-free production with a constructor.
+   *
+   * @type Production -> ProdRule
+   */
+  prod2prodrule :
+    p at prod(syms, sym, attrs(attrs)) -> result
+    where
+        <sym2nonterm> sym => A
+      ; <syms2trees> syms => t*
+      ; if y := <get-cnstr-name> attrs then
+          !rtg |[ A -> y(t*) ]|
+        else
+          //log-prod(|Error(), "No constructor name specified in production:", p)
+          //;    log(|Error(), "Resolution: please add a cons attribute to this production.")
+          //; if-verbose1(log(|Error(), "Production in abstract syntax: ", p))
+          //; if <get-config> IgnoreMissingCons() then
+              ![]
+            //else
+            //  // FIXME SDF: http://sjofar.sen.cwi.nl:8080/show_bug.cgi?id=660
+            //     <?prod([sort("Label"), lit(_), sort("Symbol")], sort("Symbol"), _)> p
+            //     ; ![]
+            //
+            //  <+ <?prod([sort("Symbol"),lit(_),sort("Symbol")],sort("Symbol"), _)> p
+            //     ; ![]
+            // 
+            //  <+ <xtc-exit> 1
+            //end
+         end
+       ; ?result
+
+/**
+ * Injections
+ */
+rules
+
+  /**
+   * Rewrites an context-free or lexical injection.
+   *
+   * The lhs must be a simple non-terminal reference.
+   */
+  inj2prodrule :
+    prod([inj], sym, attrs(attrs)) -> rtg |[ A -> t ]|
+      where not(<get-cnstr-name> attrs)
+          ; <sym2tree> inj => t
+          ; <sym2nonterm> sym => A
+
+  /**
+   * Rewrite a bracket production which is not a 'real' injection.
+   */
+  inj2prodrule :
+    prod(syms, cf(<match-sort(?x)>), attrs(attrs)) -> rtg |[ x -> A ]|
+      where <contains-bracket> attrs
+          ; <not(get-cnstr-name)> attrs
+          ; <syms2trees> syms => [ rtg |[ A ]| ]
+
+/**
+ * Sequence
+ */
+rules
+
+  /**
+   * syms -> (syms)
+   */
+  seq2prodrule :
+    prod(syms, nt, _) -> rtg |[ x -> <(i)> (t*) ]|
+      where <is-seq-symbol> nt
+          ; <get-nonterm-of> nt => x
+          ; <syms2trees> syms => t*
+          ; <length; int-to-string> t* => i
+
+/**
+ * Alternatives
+ */
+rules
+
+  alt2prodrule :
+    prod(syms, nt, _) -> rtg |[ x -> t ]|
+      where <is-alt-symbol> nt
+          ; <get-nonterm-of> nt => x
+          ; <syms2trees> syms => [t]
+
+/**
+ * Iteration
+ */
+rules
+
+  /**
+   *  A+ -> A* 
+   */
+  listinj2prodrule :
+    prod([s1 at cf(iter(a))], s2 at cf(iter-star(a)), _) -> rtg |[ x2 -> x1 ]|
+      where <get-nonterm-of> s1 => x1
+          ; <get-nonterm-of> s2 => x2
+
+  /**
+   * -> A* 
+   * -> {A lit}* 
+   */
+  listinj2prodrule :
+    prod([], sym, _) -> rtg |[ x -> <nil>() ]|
+      where <is-list-symbol> sym
+          ; <get-nonterm-of> sym => x
+
+  /**
+   *  A -> A+
+   */
+  listinj2prodrule :
+    prod([cf(a)], cf(iter(a)), _) -> rtg |[ x1 -> <cons> (t, x2) ]|
+      where <sym2tree> cf(a) => t
+          ; <get-nonterm-of> cf(iter(a)) => x1
+          ; <get-nonterm-of> cf(iter-star(a)) => x2
+
+  /**
+   *  A -> A+
+   */
+  listinj2prodrule :
+    prod([a], iter(a), _) -> rtg |[ x1 -> <cons> (t, x2) ]|
+    where
+        <sym2tree> a => t
+      ; <get-nonterm-of> iter(a) => x1
+      ; <get-nonterm-of> iter-star(a) => x2
+
+/**
+ * Iteration with Separator
+ * Currently only separators that do not occur in the AST are supported.
+ */
+rules
+
+  /**
+   * {A lit}* lit  {A lit}+ -> {A lit}+
+   */
+  listinj2prodrule :
+    prod(syms, nt, _) -> rtg |[ x -> <conc> (y, z) ]|
+      where <is-list-symbol> nt
+          ; <get-nonterm-of> nt => x
+          ; <filter(not(is-empty-sym)); map(is-list-symbol; get-nonterm-of)> syms => [y, z]
+
+  /**
+   *  {A lit}+ -> {A lit}* 
+   */
+  listinj2prodrule :
+    prod([s1 at cf(iter-sep(a, sep))], s2 at cf(iter-star-sep(a, sep)), _) -> rtg |[ x2 -> x1 ]|
+      where <is-empty-sym> sep
+          ; <get-nonterm-of> s1 => x1
+          ; <get-nonterm-of> s2 => x2
+
+  /**
+   *  A -> {A lit}+
+   */
+  listinj2prodrule :
+    prod([cf(a)], nt at cf(iter-sep(a, sep)), _) -> rtg |[ x -> <cons> (t, x2) ]|
+      where <is-empty-sym> sep
+          ; <sym2tree> cf(a) => t
+          ; <get-nonterm-of> nt => x
+          ; <get-nonterm-of> cf(iter-star-sep(a, sep)) => x2
+
+/**
+ * Alternative
+ */
+rules
+
+  /**
+   *  A -> A?
+   */
+  opt2prodrule :
+    prod([cf(A)], nt at cf(opt(A)), _) -> rtg |[ x -> <some> (t) ]|
+      where <sym2tree> A => t
+          ; <get-nonterm-of> nt => x
+
+  /**
+   *  -> A?
+   */
+  opt2prodrule :
+    prod([], cf(opt(a)), _) -> rtg |[ x -> <none> () ]|
+      where <get-nonterm-of> cf(opt(a)) => x
+
+/**
+ * Variables
+ */
+rules
+
+  var2prodrule :
+    prod(_, varsym(sym), _) -> rtg |[ x -> meta-var(<string>) ]|
+      where <sym2nonterm> sym => x
+
+strategies
+
+  get-nonterm-of =
+   ?key
+   ; is-nonterm-generator
+   ; (  <table-get> ("generated-nonterms", key)
+     <+ <table-get> ("generated-nonterms", cf(key))
+     <+ <table-get> ("generated-nonterms", <?cf(<id>)> key)
+     <+ sdf-symbol-to-string
+        ; where(<table-put> ("generated-nonterms", key, <id>))
+     )
+
+  is-seq-symbol =
+      cf(is-seq-symbol)
+    + seq(id, is-list)
+
+  is-alt-symbol = 
+      cf(is-alt-symbol)
+    + alt(id, id)
+     
+  is-list-symbol = 
+      cf(is-list-symbol)
+    + iter-star-sep(id, id)
+    + iter-sep(id, id)
+    + iter-star(id)
+    + iter(id)
+
+  is-nonterm-generator = 
+      is-list-symbol
+    + is-seq-symbol
+    + is-alt-symbol
+    + cf(is-nonterm-generator)
+    + opt(id)
+    + varsym(id)
+
+strategies
+
+  /**
+   * @type List(Symbol) -> List(AnnoTreeFN)
+   */
+  syms2trees =
+      filter(not(is-empty-sym))
+    ; map(sym2tree)
+
+  /**
+   * @type  Symbol -> Symbol
+   */
+  is-empty-sym = ?lit(_)
+  is-empty-sym = ?ci-lit(_)
+  is-empty-sym = ?layout()
+  is-empty-sym = opt(is-empty-sym)
+  is-empty-sym = cf(is-empty-sym)
+  is-empty-sym = lex(is-empty-sym)
+  is-empty-sym = label(id, is-empty-sym)
+
+/**
+ * @type  Symbol -> AnnoTreeFN
+ */  
+strategies
+
+  sym2tree :
+    sym -> rtg |[ A ]|
+      where <sym2nonterm> sym => A
+
+  sym2tree:
+    cf(sym) -> <sym2tree> sym
+      where <not(is-nonterm-generator)> cf(sym)
+
+  sym2tree:
+    lex(sym) -> rtg |[ <string> ]|
+
+  sym2tree:
+    char-class(_) -> rtg |[ <int> ]|
+
+  sym2tree:
+    label(_,sym) -> <sym2tree> sym
+
+  sym2tree:
+    sym -> rtg |[ x ]|
+      where <get-nonterm-of> sym => x
+
+rules
+
+  sym2nonterm :
+    sym -> rtg nonterm |[ x ]|
+      where <get-nonterm-of> sym => x
+
+  sym2nonterm =
+    sort2nonterm
+
+  sym2nonterm =
+    ?cf(<sort2nonterm>)
+
+  sort2nonterm :
+    sort(x) -> rtg nonterm |[ x ]|
+
+  sort2nonterm :
+    parameterized-sort(x, params) -> rtg nonterm |[ y ]|
+    where
+      Symbol2String => y
+
+strategies
+
+  /**
+   * @type  List(Attribute) -> String
+   */
+  get-cnstr-name =
+    fetch-elem(
+      ?default(term(cons(<id>)))
+
+      // FIXME SDF: used for old SDF
+      <+ ?term(cons(<id>))
+    )
+
+  /**
+   * @type  List(Attribute) ->? _
+   */
+  contains-bracket =
+    fetch(?bracket())
+
+  /**
+   * @type  List(Attribute) ->? _
+   */
+  contains-reject =
+    fetch(?reject())
+
+  /**
+   * @type  List(Attribute) ->? _
+   */
+  contains-rtg(s) =
+    fetch(term(rtg(where(s))))
+
+strategies
+
+  err(s) = log(|Error(), <s> (), <id>)
+  dbg(s) = log(|Debug(), <s> (), <id>)
+
+strategies
+
+  sdf-symbol-to-string =
+    Symbol2String
+    ; newname
+    <+ log-sym(|Warning(), "Cannot generate a nice name for symbol", <id>)
+     ;     log(|Warning(), "  Please report this bug at ")
+     ;     log(|Warning(), "    - https://bugs.cs.uu.nl/browse/STR")
+     ;     log(|Warning(), "    - or martin.bravenboer at gmail.com")
+     ; new
+     ;     log(|Warning(), "  Resolution: falling back to the ugly name ", <id>)
+
+  Symbol2String :
+    cf(sym) -> <Symbol2String> sym
+
+  Symbol2String :
+    lex(sym) -> <Symbol2String> sym
+
+  /**
+   * @todo  This could be improved by using quoted identifiers.
+   */
+  Symbol2String :
+    char-class(_) -> "CharClass"
+
+  /**
+   * @todo  This could be improved by using quoted identifiers.
+   */
+  Symbol2String :
+    lit(_) -> "Lit"
+
+  Symbol2String :
+    ci-lit(_) -> "CaseInsensitiveLit"
+
+  Symbol2String :
+    iter(sym) -> <conc-strings> ("ListPlusOf", <Symbol2String> sym)
+
+  Symbol2String :
+    iter-star(sym) -> <conc-strings> ("ListStarOf", <Symbol2String> sym)
+
+  Symbol2String :
+    iter-sep(sym, sep) -> <conc-strings> ("ListPlusOf", <Symbol2String> sym)
+
+  Symbol2String :
+    iter-star-sep(sym, sep) -> <conc-strings> ("ListStarOf", <Symbol2String> sym)
+
+  Symbol2String :
+    sort(s) -> s
+    where
+      <is-string> s
+
+  Symbol2String :
+    parameterized-sort(x, params)  -> <concat-strings> [x, "_" | param-string]
+    where
+      <is-string> x
+      ; <map(Symbol2String)> params => param-string
+
+  Symbol2String :
+    label(_,sym) -> <Symbol2String> sym
+
+  Symbol2String :
+    opt(sym) -> <conc-strings> ("Opt", <Symbol2String> sym)
+
+  Symbol2String :
+    seq(sym, syms) ->
+      < filter(not(?lit(_) + ?ci-lit(_)))
+      ; map(Symbol2String)
+      ; <separate-by> ("_", <id>)
+      ; concat-strings
+      > [sym | syms]
+
+  Symbol2String :
+    alt(sym1, sym2) -> <concat-strings> [<Symbol2String> sym1, "_", <Symbol2String> sym2]
+
+strategies
+
+  log-sym(|severity, msg, sym) =
+    log-prod(|severity, msg, sym)
+
+  /**
+   * @todo Use libgpp
+   */
+  log-prod(|severity, msg, prod) =
+    where(
+      xtc-temp-files(
+        !prod
+      ; write-to
+      ; xtc-pp-sdf2
+      ; ?FILE(<read-text-file; trim-chars('\n' + '\r' + ' ' + '\t'); string-as-chars(filter(not('\n' + '\r')))>)
+      ; ?prodtxt
+      )
+    ; log(|severity, msg)
+    ; log(|severity, <conc-strings> ("  ", prodtxt))
+    )
+
+signature
+  constructors
+    rtg    : rtginfo -> rtg
+    ignore : rtginfo
+
+
+    /**
+     * FIXME: bootstrap problem
+
+    cilit : String -> Tree
+
+    // WTF?
+    ci-lit : String -> Tree
+     */

Copied: strc-java/trunk/java/tools/org/strategoxt/tools/lib/module-option.str (from rev 20046, strategoxt/trunk/stratego-regular/lib/module-option.str)
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/module-option.str	                        (rev 0)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/module-option.str	2009-10-16 15:31:05 UTC (rev 20110)
@@ -0,0 +1,23 @@
+module module-option
+
+strategies
+
+  module-option =
+    ArgOption("--module"
+    , where(<set-config> ("--module", <id>))
+    , !"--module n       Generated module has name n"
+    )
+
+  get-module-name =
+    <get-config> "--module"
+    <+ log(|Critical(), "No module name specified. Use the --module option to specify a module name. See also --help.")
+       ; <exit> 1
+
+  guess-module-name =
+    <get-config> "--module"
+    <+ <get-config; remove-extension> "-o"
+    <+ <get-config; remove-extension> "-i"
+    <+ log(|Critical(), "No module name specified. Use the --module option to specify a module name. See also --help.")
+       ; <exit> 1

(1190 diff lines omitted)


From L.C.L.Kats at tudelft.nl  Sat Oct 17 19:06:32 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sat, 17 Oct 2009 17:06:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20111 - LennartKats -
	in strc-java/trunk: java
	java/runtime/org/strategoxt/lang/compat/override
	java/runtime/org/strategoxt/lang/compat/strc_compat
	java/tools/org/strategoxt/tools/lib tools trans
Message-ID: <200910171706.n9HH6WtD002753@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-17 17:06:31 +0000 (Sat, 17 Oct 2009)
New Revision: 20111

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20111&view=rev

Added:
   strc-java/trunk/trans/strj-version.str
Modified:
   strc-java/trunk/java/Makefile.am
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/strc_compat/Main.java
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf-options.str
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str
   strc-java/trunk/tools/strj-jar
   strc-java/trunk/trans/Makefile.am
   strc-java/trunk/trans/s2j-options.str
   strc-java/trunk/trans/s2j.str
   strc-java/trunk/trans/strj-options.str

Log:
- Support the strj --version option
- The -D option can now be used to set primitive constants such as prim("VERSION_TERM")
- Reuse the libstratego-sdf parse table for pack-sdf
- Added META-INF.MF support to strj-jar 


Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/java/Makefile.am	2009-10-17 17:06:31 UTC (rev 20111)
@@ -3,6 +3,7 @@
 pkgdata_DATA=.ALLCLASSES strategoxt.jar
 
 RUNTIMEJAVAS = \
+  $(wildcard runtime/*.java) \
   $(wildcard runtime/org/strategoxt/*.java) \
   $(wildcard runtime/org/strategoxt/lang/*.java) \
   $(wildcard runtime/org/strategoxt/lang/compat/*.java) \
@@ -46,6 +47,7 @@
   $(LIBRARYJAVAS) $(COMPILERJAVAS) .ALLCLASSES
 
 EXTRA_DIST=\
+  $(wildcard runtime/*.java) \
   $(wildcard runtime/org/strategoxt/*.java) \
   $(wildcard runtime/org/strategoxt/*/*.java) \
   $(wildcard runtime/org/strategoxt/*/*/*.java) \
@@ -58,6 +60,7 @@
   $(wildcard runtime/org/strategoxt/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*/*.str) \
+  $(wildcard tools/org/strategoxt/tools/*.str) \
   spoofax-libs.jar \
   bin \
   META-INF/MANIFEST.MF
@@ -82,7 +85,11 @@
 STRJ=XTC_REPOSITORY="$(BUILD_REPOSITORY)" ../trans/strj
 STRJFLAGS=--library --verbose 3 -clean -O 3
 
+STRJ_VERSION=$(VERSION) (Java version) based on `$(STRATEGOXT)/bin/strc --version | head -n1 | sed 's/ (revision \(.*\))/r\1/'`
+STRJ_CONSTANTS=-D STRJ_VERSION_TERM="\"$(STRJ_VERSION)\"" -D SVN_REVISION_TERM=\"$(SVN_REVISION)\" -D STRC_SYSTEM_LDFLAGS=\"\" -D STRC_SYSTEM_CFLAGS=\"\"
+
 JAR=`if which fastjar >/dev/null; then echo fastjar; else echo jar; fi`
+JARIN0=`find tools    | grep -E '\.rtree|\.af|\.tbl' | sed 's!tools/!-C tools/ !'`
 JARIN1=`find runtime  | grep -E '\.rtree|\.af|\.tbl' | sed 's!runtime/!-C runtime/ !'`
 JARIN2=`find lib      | grep -E '\.rtree|\.af|\.tbl' | sed 's!lib/!-C lib/ !'`
 JARIN3=`find compiler | grep -E '\.rtree|\.af|\.tbl' | sed 's!compiler/!-C compiler/ !'`
@@ -98,7 +105,8 @@
 	mv strategoxt.jar.tmp strategoxt.jar
 
 smalljar :
-	$(JAR) cfm0 strategoxt.jar META-INF/MANIFEST.MF $(JARIN1)
+	$(JAR) cfm0 strategoxt.jar META-INF/MANIFEST.MF $(JARIN0)
+	$(JAR) ufm0 strategoxt.jar META-INF/MANIFEST.MF $(JARIN1)
 	$(JAR) ufm0 strategoxt.jar META-INF/MANIFEST.MF $(JARIN2)
 	$(JAR) ufm0 strategoxt.jar META-INF/MANIFEST.MF $(JARIN3)
 	$(JAR) ufm0 strategoxt.jar META-INF/MANIFEST.MF -C spoofax-libs/ .
@@ -146,7 +154,7 @@
 	cp $< $@
 
 lib/org/strategoxt/stratego_xtc/Main.java : lib/org/strategoxt/stratego-xtc.rtree ../trans/strj runtime/org/strategoxt/lang/compat/override/xtc_compat/Main.java
-	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/xtc -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_xtc -la stratego-lib -la org.strategoxt.lang.compat.override.xtc_compat -D GetInternalDefaultXtcRepository=None
+	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/xtc -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_xtc -la stratego-lib -la org.strategoxt.lang.compat.override.xtc_compat -D GetInternalDefaultXtcRepository_0_0=None
 
 lib/org/strategoxt/stratego_sglr/Main.java : $(STRATEGOXT)/share/libstratego-sglr.ctree ../trans/strj runtime/org/strategoxt/lang/compat/override/jsglr_parser/Main.java runtime/org/strategoxt/lang/compat/override/jsglr_parser_compat/Main.java
 	$(STRJ) -I $(STRATEGOXT)/share -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_sglr -la stratego-lib -la stratego-xtc -la org.strategoxt.lang.compat.override.jsglr_parser -la org.strategoxt.lang.compat.override.jsglr_parser_compat
@@ -164,10 +172,10 @@
 	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/sdf-front -I $(STRATEGOXT)/share/sdf-front -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_sdf -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-aterm 
 
 lib/org/strategoxt/stratego_tool_doc/Main.java : $(STRATEGOXT)/share/libstratego-tool-doc.ctree ../trans/strj
-	$(STRJ) -I $(STRATEGOXT)/share -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_tool_doc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm -D SRTS-package-bugreport='"bugs at strategoxt.org"' -D SRTS-package-name='"<SRTS-package-name>"' -D SRTS-package-revision='"<SRTS-package-revision>"' -D SRTS-package-version='"<SRTS-package-version>"'
+	$(STRJ) -I $(STRATEGOXT)/share -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_tool_doc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm -D SRTS_package_bugreport_0_0='"bugs at strategoxt.org"' -D SRTS_package_name_0_0='"<SRTS-package-name>"' -D SRTS_package_revision_0_0='"<SRTS-package-revision>"' -D SRTS_package_version_0_0='"<SRTS-package-version>"'
 
-lib/org/strategoxt/strc/Main.java : $(STRATEGOXT)/share/libstrc.ctree ../trans/strj runtime/org/strategoxt/lang/compat/strc_compat/Main.java
-	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/stratego-front -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.strc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-rtg -la stratego-xtc -la org.strategoxt.lang.compat.strc_compat
+lib/org/strategoxt/strc/Main.java : $(STRATEGOXT)/share/libstrc.ctree ../trans/strj runtime/org/strategoxt/lang/compat/strc_compat/Main.java runtime/org/strategoxt/lang/compat/override/strc_compat/Main.java
+	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/stratego-front -i $< -o $@ $(STRJFLAGS) $(STRJCONSTANTS) -p org.strategoxt.strc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-rtg -la stratego-xtc -la org.strategoxt.lang.compat.strc_compat
 
 lib/org/strategoxt/java_front/Main.java : $(JAVA_FRONT)/share/java-front/libjava-front.ctree ../trans/strj
 	$(STRJ) -I $(JAVA_FRONT)/share/java-front-syntax -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.java_front -la stratego-lib -la stratego-sglr -la stratego-gpp
@@ -198,19 +206,19 @@
 runtime/org/strategoxt/lang/compat/override/java_integration/Main.java : runtime/org/strategoxt/lang/compat/override/java-integration.str ../trans/strj
 	$(STRJ) -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.java_integration -la stratego-lib -la stratego-xtc
 
-runtime/org/strategoxt/lang/compat/override/strc_compat/Main.java : runtime/org/strategoxt/lang/compat/override/strc-compat.str ../trans/strj runtime/org/strategoxt/lang/parallel/stratego_parallel/libstratego-parallel.rtree
-	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/stratego-front -I $(STRATEGOXT)/share/xtc -I $(STRATEGOXT)/share/stratego-lib -I $(JAVA_FRONT)/share/java-front -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.strc_compat -la stratego-lib -la stratego-xtc -la org.strategoxt.strc -I runtime/org/strategoxt/lang/parallel/stratego_parallel
+runtime/org/strategoxt/lang/compat/override/strc_compat/Main.java : runtime/org/strategoxt/lang/compat/override/strc-compat.str ../trans/strj runtime/org/strategoxt/lang/parallel/stratego_parallel/libstratego-parallel.rtree ../trans/strj-version.str
+	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/stratego-front -I $(STRATEGOXT)/share/xtc -I $(STRATEGOXT)/share/stratego-lib -I $(JAVA_FRONT)/share/java-front -I ../trans -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.lang.compat.override.strc_compat -la stratego-lib -la stratego-xtc -la org.strategoxt.strc -I runtime/org/strategoxt/lang/parallel/stratego_parallel
 
 ###### TOOLS #######
 
 tools/org/strategoxt/tools/Main.java : $(TOOLSTRS:.str=.rtree)
-	$(STRJ) -i tools/org/strategoxt/tools/tools.rtree -o $@ $(STRJFLAGS) -p org.strategoxt.tools -la stratego-lib -la stratego-xtc -la stratego-gpp -la stratego-rtg -la stratego-sglr -la stratego-tool-doc -I $(STRATEGOXT)/share/sdf/xml-front -I tools/org/strategoxt/tools/lib -I $(STRATEGOXT)/share/sdf/gpp -I $(STRATEGOXT)/share/sdf/stratego-regular -I $(STRATEGOXT)/share/stratego-regular -I $(STRATEGOXT)/share/sdf/sdf-front
+	$(STRJ) -i tools/org/strategoxt/tools/tools.rtree -o $@ $(STRJFLAGS) -p org.strategoxt.tools -la stratego-lib -la stratego-xtc -la stratego-gpp -la stratego-rtg -la stratego-sglr -la stratego-tool-doc -la stratego-sdf -I $(STRATEGOXT)/share/sdf/xml-front -I tools/org/strategoxt/tools/lib -I $(STRATEGOXT)/share/sdf/gpp -I $(STRATEGOXT)/share/sdf/stratego-regular -I $(STRATEGOXT)/share/stratego-regular -I $(STRATEGOXT)/share/sdf/sdf-front
 
 ###### COMPILER #######
 
 compiler/org/strategoxt/strj/Main.java : ../trans/strj.ctree ../trans/strj
 	[ -e compiler/org/strategoxt ] || mkdir -p compiler/org/strategoxt
-	$(STRJ) -i $< -o $@ -clean -p org.strategoxt.strj --verbose 3 -la stratego-lib -la stratego-xtc -la stratego-gpp -la strc -la java-front -O 3 # -D DEFAULT_XTC_REPOSITORY="\"$(REPOSITORY)\""
+	$(STRJ) -i $< -o $@ --clean -p org.strategoxt.strj --verbose 3 -la stratego-lib -la stratego-xtc -la stratego-gpp -la strc -la java-front -O 3 $(STRJ_CONSTANTS)
 
 ###### EXTERNAL #######
 

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/strc-compat.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -8,6 +8,7 @@
 imports
   libstratego-lib
   libstrc
+  strj-version
 
 strategies
 

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/strc_compat/Main.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/strc_compat/Main.java	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/strc_compat/Main.java	2009-10-17 17:06:31 UTC (rev 20111)
@@ -5,8 +5,7 @@
 import org.strategoxt.lang.compat.StringValuePrimitive;
 
 /**
- * Registers primitives for use by libstrc and configures
- * the strc_compat overrides.
+ * Configures the strc_compat overrides.
  * 
  * @author Lennart Kats <lennart add lclnet.nl>
  */
@@ -17,20 +16,6 @@
 	}
 	
 	public static void init(Context context) {
-		context.addOperatorRegistry(new OperatorRegistry());
 		org.strategoxt.lang.compat.override.strc_compat.Main.init(context);
 	}
-	
-	private static class OperatorRegistry extends AbstractStrategoOperatorRegistry {		
-		public OperatorRegistry() {
-			add(new StringValuePrimitive("VERSION_TERM", "x.y"));
-			add(new StringValuePrimitive("SVN_REVISION_TERM", "nnnn"));
-			add(new StringValuePrimitive("STRC_SYSTEM_LDFLAGS", ""));
-			add(new StringValuePrimitive("STRC_SYSTEM_CFLAGS", ""));
-		}
-
-		public String getOperatorRegistryName() {
-			return "strc_compat";
-		}		
-	}
 }

Modified: strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf-options.str
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf-options.str	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf-options.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -84,7 +84,7 @@
       ?IncludeDef(def)
     ; !FILE(def)
     ; xtc-temp-files(
-        parse-xtc-file-report-errors(|<pack-sdf-table>, "Module")
+        parse-xtc-file-report-errors(|<get-sdf-parse-table>, "Module")
       ; read-from
       )
     ; collect-om(?

Modified: strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -187,20 +187,11 @@
    */
   parse-sdf2-module-to-asfix(check) =
     ?pathname
-    ; ( <parse-file-pt(|<pack-sdf-table>, "Module")> pathname
+    ; ( <parse-file-pt(|<get-sdf-parse-table>, "Module")> pathname
         <   ?parsetree(<id>, _)
           ; check-module-name(check|pathname)
         + <fatal-error> ["pack-sdf: Error: module ", pathname, " cannot be parsed\n"]
       )
-  
-  pack-sdf-table =
-    PackSDFTable
-  <+
-    import-term(Sdf2.tbl);
-    open-parse-table;
-    rules(
-      PackSDFTable := <id>
-    )
 
   check-module-name(check|pathname) =
     ?ptree;

Modified: strc-java/trunk/tools/strj-jar
===================================================================
--- strc-java/trunk/tools/strj-jar	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/tools/strj-jar	2009-10-17 17:06:31 UTC (rev 20111)
@@ -2,7 +2,6 @@
 
 ## SETTINGS
 
-MAINCLASS=
 PRINT_CLASSPATH=
 CLASSPATH=strategoxt.jar # override with option -cp
 JAR=`if which fastjar &>/dev/null; then echo fastjar; else echo jar; fi`
@@ -31,9 +30,6 @@
   elif [ "$P" == "-i" ]; then
     INPUT="$1"
     shift
-  elif [ "$P" == "-m" ]; then
-    MAINCLASS="$1"
-    shift
   elif [ "$P" == "-p" ]; then
     PRINT_CLASSPATH=1
   elif [ "$P" == "-o" ]; then
@@ -54,7 +50,7 @@
 fi
 
 if [ "$INPUT" == "" ]; then
-  echo "Usage: strj-jar [-m MAINCLASS] [-cp CLASSPATH] [-runtimecp CLASSPATH] -i INPUT.java [-o OUTPUT.jar]"
+  echo "Usage: strj-jar [-cp CLASSPATH] [-runtimecp CLASSPATH] -i INPUT.java [-o OUTPUT.jar]"
   exit 1
 fi
 
@@ -90,26 +86,36 @@
 
 ## COMPILATION
 
-( mkdir -p $TEMPDIR
-  echo "$JAVAC -source 5 -nowarn $JAVACFLAGS -cp $CLASSPATH -d \$TEMPDIR $INPUT $INPUT2 $INPUT3"
-  $JAVAC -source 5 -nowarn $JAVACFLAGS -cp "$CLASSPATH" -d $TEMPDIR $INPUT $INPUT2 $INPUT3) || exit 1
+mkdir -p $TEMPDIR || exit 1
+echo "$JAVAC -source 5 -nowarn $JAVACFLAGS -cp $CLASSPATH -d \$TEMPDIR $INPUT $INPUT2 $INPUT3"
+set -o pipefail
+$JAVAC -source 5 -nowarn $JAVACFLAGS -cp "$CLASSPATH" -d $TEMPDIR $INPUT $INPUT2 $INPUT3 \
+  | tee $TEMPDIR/javac.log
+if [ $? != 0 ]; then
+  if grep "annot be resolved" $TEMPDIR/javac.log >/dev/null; then
+    echo "Unresolved references: please check the -la import options." >&2
+  fi
+  rm -rf $TEMPDIR
+  exit 1
+fi
 
-# TODO: create META-INF file like:
-#
-#   Manifest-Version: 1.0
-#   Main-Class: $MAINCLASS
-#   Class-Path: strategoxt.jar
 ## JARRING
 
+MAINCLASS="`head -n1 $INPUT | grep "package [^;];" | sed 's/package ([^;]*);/$1\./'``basename $INPUT .java`"
+echo "Manifest-Version: 1.0" > $TEMPDIR/MANIFEST.MF
+echo "Main-Class: $MAINCLASS" >> $TEMPDIR/MANIFEST.MF
+echo "Class-Path: strategoxt.jar" >> $TEMPDIR/MANIFEST.MF
+echo >> $TEMPDIR/MANIFEST.MF
+cat $TEMPDIR/MANIFEST.MF
+
 if ls $INPUTDIR/*.str &>/dev/null; then
   echo "WARNING: using this build directory may mean non-term files are included as attachments" >&2
 fi
 
-ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|astr|str|meta|dep|c|lo|o|class)$' | sed "s!^!-C $INPUTDIR !"` \
-  || (echo "Illegal input file name: $INPUT">&2; exit 1)
+ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|log|astr|str|meta|dep|c|lo|o|class|MF)$' | sed 's!^!-C $INPUTDIR !'`
 
-echo $JAR cf $OUTPUT -C \$TEMPDIR . $ATTACHMENTS
-$JAR cf $OUTPUT -C $TEMPDIR . $ATTACHMENTS
+echo $JAR cfm $OUTPUT \$TEMPDIR/MANIFEST.MF -C \$TEMPDIR . $ATTACHMENTS
+$JAR cfm $OUTPUT $TEMPDIR/MANIFEST.MF -C $TEMPDIR . $ATTACHMENTS
 RET=$?
 
 rm -rf $TEMPDIR

Modified: strc-java/trunk/trans/Makefile.am
===================================================================
--- strc-java/trunk/trans/Makefile.am	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/trans/Makefile.am	2009-10-17 17:06:31 UTC (rev 20111)
@@ -12,8 +12,14 @@
 
 STRINCLUDES    = -I $(XTC)/share/xtc -I $(JAVA_FRONT)/share/java-front -I $(STRATEGO_FRONT)/share/stratego-front -I ../syn
 
+STRJ_VERSION=$(VERSION) based on `$(STRATEGOXT)/bin/strc --version | head -n1 | sed 's/ (revision \(.*\))/r\1/'`
+
 STRCFLAGS      = --main main-$* -O 0 --format-check 0
 
+DEFS += -DSTRJ_VERSION_TERM\(\)=\(\(ATerm\)\ ATmakeString\(\""$(STRJ_VERSION)"\"\)\)
+
+#  -D SVN_REVISION_TERM=\"$(SVN_REVISION)\" -D STRC_SYSTEM_LDFLAGS=\"\" -D STRC_SYSTEM_CFLAGS=\"\"
+
 EXTRA_DIST     = $(wildcard *.str) $(wildcard *.meta) $(wildcard lib/*.str) $(wildcard lib/*.meta)
 CLEANFILES     = $(wildcard *.dep) $(wildcard *.tmp) $(wildcard *.o) # $(wildcard *.c)
 BOOTCLEANFILES = $(wildcard *.c) 

Modified: strc-java/trunk/trans/s2j-options.str
===================================================================
--- strc-java/trunk/trans/s2j-options.str	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/trans/s2j-options.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -110,6 +110,8 @@
     | "option -D must be followed by name=value pair")
   ; risky(
       (id, read-from-string; trm-explode; raise-in-build; stratego-desugar)
+    ; ?(name, value)
+    ; rules(GetConstantDef: name -> value)
     | "illegal constant value for option -D"
     )
  

Modified: strc-java/trunk/trans/s2j.str
===================================================================
--- strc-java/trunk/trans/s2j.str	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/trans/s2j.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -344,7 +344,7 @@
   translate-constant-definition : // TODO: check if constant strategy definition name not taken
     (name, value) -> def'
     with
-      name'  := <conc-strings> (<cify; dollars-for-capitals> name, "_0_0")
+      name'  := <dollars-for-capitals> name
     ; def    := SDefT(name', [], [], Build(value))
     ; def'   := <translate-outer-definition> def
   
@@ -677,6 +677,7 @@
     <+ translate-CallT
     <+ translate-Build
     <+ translate-Seq
+    <+ translate-PrimT-constant
     <+ translate-PrimT
     <+ translate-Id
     <+ translate-Fail
@@ -760,6 +761,11 @@
       // but they're never used anyway
       fatal-err(|"Think again. Dynamic calls are not supported")
 
+  translate-PrimT-constant :
+    PrimT(f, [], []) -> <translate-strategy> Build(term)
+    where
+      term := <GetConstantDef> f
+
   translate-PrimT :
     PrimT(f, s*, t*) -> 
     <java-check-unbound-args(|t*)>  

Modified: strc-java/trunk/trans/strj-options.str
===================================================================
--- strc-java/trunk/trans/strj-options.str	2009-10-16 15:31:05 UTC (rev 20110)
+++ strc-java/trunk/trans/strj-options.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -9,6 +9,7 @@
 
 imports
   s2j-options
+  strj-version
 
 strategies
 
@@ -26,6 +27,8 @@
   ; parse-options(
       strj-options
     )
+  ; display-version
+  ; strc-announce
   ; if <get-config> "-o"; base-filename; not(<eq> (<id>, <jify>)) then
       <get-config> "-o"
     ; fatal-err(|"Output file name is not a legal Java name")
@@ -110,10 +113,8 @@
     where(<set-config> ("--help",())); !(),         
     !"-h | --help        Show help")
   <+
-  /* TODO: support -version; see ${SVN_REVISION} and ${VERSION} in Makefile
-    Option("-v"+"--version",     
+    Option("-v" + "--version",     
     where(<set-config> ("-v",())); !(),         
     !"-v | --version     Display program's version")
   <+
-  */
     stratego-warnings-options

Added: strc-java/trunk/trans/strj-version.str
===================================================================
--- strc-java/trunk/trans/strj-version.str	                        (rev 0)
+++ strc-java/trunk/trans/strj-version.str	2009-10-17 17:06:31 UTC (rev 20111)
@@ -0,0 +1,18 @@
+/**
+ * strj version overrides
+ *
+ * @author Lennart Kats
+ */
+module strj-options
+
+strategies
+  
+  override strc-version-number =
+    prim("STRJ_VERSION_TERM")
+
+  override svn-revision-number =
+    prim("SVN_REVISION_TERM")
+    
+  override strc-version =
+    where(<fprintnl>(stdout(), ["STRJ ", <strc-version-number>, "\n"]))
+



From L.C.L.Kats at tudelft.nl  Sat Oct 17 19:55:04 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sat, 17 Oct 2009 17:55:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20112 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl
	strc-java/trunk/java strc-java/trunk/java/runtime
	strc-java/trunk/java/tools/org/strategoxt/tools/lib
	strc-java/trunk/trans
Message-ID: <200910171755.n9HHt4Nx003025@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-17 17:55:03 +0000 (Sat, 17 Oct 2009)
New Revision: 20112

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20112&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_exit.java
   strc-java/trunk/java/Makefile.am
   strc-java/trunk/java/runtime/start.java
   strc-java/trunk/java/spoofax-libs.jar
   strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str
   strc-java/trunk/trans/s2j.str

Log:
Flush and close all streams when a Stratego program is exited.

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2009-10-17 17:06:31 UTC (rev 20111)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2009-10-17 17:55:03 UTC (rev 20112)
@@ -12,6 +12,7 @@
 import java.io.PrintStream;
 import java.io.RandomAccessFile;
 import java.util.HashMap;
+import java.util.Iterator;
 import java.util.Map;
 
 import org.spoofax.interpreter.core.InterpreterException;
@@ -122,12 +123,27 @@
         try {
             stream.close();
         } catch (IOException e) {
-            return true;
+            // Ignored
         }
         inStreams.remove(fd);
         outStreams.remove(fd);
         return true;
     }
+    
+    public void closeAllFiles() {
+        Iterator<Integer> fds = outStreams.keySet().iterator();
+        while (fds.hasNext()) {
+            int fd = fds.next();
+            OutputStream stream = outStreams.get(fd);
+            try {
+                stream.close();
+            } catch (IOException e) {
+                // Ignored
+            }
+            inStreams.remove(fd);
+            fds.remove();
+        }
+    }
 
     public int openRandomAccessFile(String fn, String mode) throws FileNotFoundException, IOException {
         String m = mode.indexOf('w') >= 0 ? "rw" : "r";

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_exit.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_exit.java	2009-10-17 17:06:31 UTC (rev 20111)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_exit.java	2009-10-17 17:55:03 UTC (rev 20112)
@@ -27,6 +27,8 @@
         if(!Tools.isTermInt(tvars[0]))
             return false;
         
+        SSLLibrary.instance(env).getIOAgent().closeAllFiles();
+        
         int exitCode = Tools.asJavaInt(tvars[0]);
         env.getStackTracer().popOnExit(exitCode == 0);
         

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-17 17:06:31 UTC (rev 20111)
+++ strc-java/trunk/java/Makefile.am	2009-10-17 17:55:03 UTC (rev 20112)
@@ -60,7 +60,7 @@
   $(wildcard runtime/org/strategoxt/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*/*.str) \
-  $(wildcard tools/org/strategoxt/tools/*.str) \
+  $(TOOLSTRS) \
   spoofax-libs.jar \
   bin \
   META-INF/MANIFEST.MF

Modified: strc-java/trunk/java/runtime/start.java
===================================================================
--- strc-java/trunk/java/runtime/start.java	2009-10-17 17:06:31 UTC (rev 20111)
+++ strc-java/trunk/java/runtime/start.java	2009-10-17 17:55:03 UTC (rev 20112)
@@ -16,7 +16,12 @@
 		System.arraycopy(strategyArgs, 1, args, 0, args.length);
 		try {
 			Context context = new Context();
-			IStrategoTerm result = context.invokeStrategyCLI(strategy, strategy, args);
+			IStrategoTerm result;
+			try {
+				result = context.invokeStrategyCLI(strategy, strategy, args);
+			} finally {
+				context.getIOAgent().closeAllFiles();
+			}
 			if (result == null) {
 				System.err.println(strategy + (context.getTraceDepth() != 0
 								? ": rewriting failed, trace:"

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)

Modified: strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str
===================================================================
--- strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str	2009-10-17 17:06:31 UTC (rev 20111)
+++ strc-java/trunk/java/tools/org/strategoxt/tools/lib/pack-sdf.str	2009-10-17 17:55:03 UTC (rev 20112)
@@ -33,8 +33,10 @@
     ; (  where(of-config => "txt")   < ( asfix-yield(|stream) ; <xtc-exit>0 )
       +  where(of-config => "ast")   < implode-asfix
       +  where(of-config => "asfix")
-      ) ; write-to <+ <fatal-error> ["pack-sdf: ", <id>, " is not a valid output format."]
+      ); write-to <+ <fatal-error> ["pack-sdf: ", <id>, " is not a valid output format."]
     )
+  
+  external asfix-yield(|stream) // HACK
 
 /**
  * Main strategies

Modified: strc-java/trunk/trans/s2j.str
===================================================================
--- strc-java/trunk/trans/s2j.str	2009-10-17 17:06:31 UTC (rev 20111)
+++ strc-java/trunk/trans/s2j.str	2009-10-17 17:55:03 UTC (rev 20112)
@@ -244,7 +244,12 @@
        Context context = init();
        context.setStandAlone(true);
        try {
-         IStrategoTerm result = context.invokeStrategyCLI(x_main.instance, "~x_name", args);
+         IStrategoTerm result;
+         try {
+           result = context.invokeStrategyCLI(x_main.instance, "~x_name", args);
+         } finally {
+           context.getIOAgent().closeAllFiles();
+         }
          if (result == null) {
            System.err.println("~x_name" + (TRACES_ENABLED ? ": rewriting failed, trace:" : ": rewriting failed"));
            context.printStackTrace();
@@ -263,8 +268,12 @@
      }
      
      public static IStrategoTerm mainNoExit(Context context, String... args) throws StrategoExit {
-       init(context);
-       return context.invokeStrategyCLI(x_main.instance, "~x_name", args);
+       try {
+         init(context);
+         return context.invokeStrategyCLI(x_main.instance, "~x_name", args);
+       } finally {
+         context.getIOAgent().closeAllFiles();
+       }
      }
      
      public static Strategy getMainStrategy() { // used by SSL_EXT_java_call



From L.C.L.Kats at tudelft.nl  Mon Oct 19 11:14:36 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 19 Oct 2009 09:14:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20113 - LennartKats -
	strc-java/trunk/java
Message-ID: <200910190914.n9J9Ea89012915@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-19 09:14:36 +0000 (Mon, 19 Oct 2009)
New Revision: 20113

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20113&view=rev

Modified:
   strc-java/trunk/java/Makefile.am

Log:


Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-17 17:55:03 UTC (rev 20112)
+++ strc-java/trunk/java/Makefile.am	2009-10-19 09:14:36 UTC (rev 20113)
@@ -60,7 +60,7 @@
   $(wildcard runtime/org/strategoxt/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*/*.str) \
-  $(TOOLSTRS) \
+  $(TOOLSTRS) $(TOOLSTRS:.str=.meta) \
   spoofax-libs.jar \
   bin \
   META-INF/MANIFEST.MF
@@ -89,7 +89,7 @@
 STRJ_CONSTANTS=-D STRJ_VERSION_TERM="\"$(STRJ_VERSION)\"" -D SVN_REVISION_TERM=\"$(SVN_REVISION)\" -D STRC_SYSTEM_LDFLAGS=\"\" -D STRC_SYSTEM_CFLAGS=\"\"
 
 JAR=`if which fastjar >/dev/null; then echo fastjar; else echo jar; fi`
-JARIN0=`find tools    | grep -E '\.rtree|\.af|\.tbl' | sed 's!tools/!-C tools/ !'`
+JARIN0=`find tools    | grep -E         '\.af|\.tbl' | sed 's!tools/!-C tools/ !'`
 JARIN1=`find runtime  | grep -E '\.rtree|\.af|\.tbl' | sed 's!runtime/!-C runtime/ !'`
 JARIN2=`find lib      | grep -E '\.rtree|\.af|\.tbl' | sed 's!lib/!-C lib/ !'`
 JARIN3=`find compiler | grep -E '\.rtree|\.af|\.tbl' | sed 's!compiler/!-C compiler/ !'`
@@ -99,7 +99,7 @@
 	  echo "Standard library classes not found; please run 'make all' first." >&2; exit 1; \
 	fi 
 	cp spoofax-libs.jar strategoxt.jar.tmp
-	$(JAR) uf strategoxt.jar.tmp $(JARIN1) $(JARIN2) $(JARIN3)
+	$(JAR) uf strategoxt.jar.tmp $(JARIN0) $(JARIN1) $(JARIN2) $(JARIN3)
 	$(JAR) uf strategoxt.jar.tmp META-INF/MANIFEST.MF -C bin .
 	jar i strategoxt.jar.tmp
 	mv strategoxt.jar.tmp strategoxt.jar
@@ -159,9 +159,13 @@
 lib/org/strategoxt/stratego_sglr/Main.java : $(STRATEGOXT)/share/libstratego-sglr.ctree ../trans/strj runtime/org/strategoxt/lang/compat/override/jsglr_parser/Main.java runtime/org/strategoxt/lang/compat/override/jsglr_parser_compat/Main.java
 	$(STRJ) -I $(STRATEGOXT)/share -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_sglr -la stratego-lib -la stratego-xtc -la org.strategoxt.lang.compat.override.jsglr_parser -la org.strategoxt.lang.compat.override.jsglr_parser_compat
 
-lib/org/strategoxt/stratego_rtg/Main.java : $(STRATEGOXT)/share/libstratego-rtg.ctree ../trans/strj runtime/org/strategoxt/lang/compat/stratego_rtg_compat/Main.java
-	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/stratego-regular -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_rtg -la stratego-lib -la stratego-sglr -la org.strategoxt.lang.compat.stratego_rtg_compat
+lib/org/strategoxt/stratego_rtg/Main.java : $(STRATEGOXT)/share/libstratego-rtg.ctree ../trans/strj runtime/org/strategoxt/lang/compat/stratego_rtg_compat/Main.java lib/org/strategoxt/stratego_rtg/rtg.tbl
+	$(STRJ) -I lib/org/strategoxt/stratego_rtg -I $(STRATEGOXT)/share -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_rtg -la stratego-lib -la stratego-sglr -la org.strategoxt.lang.compat.stratego_rtg_compat
 
+# HACK: work-around for the Java BAFReader
+lib/org/strategoxt/stratego_rtg/rtg.tbl : $(STRATEGOXT)/share/sdf/stratego-regular/rtg.tbl
+	baffle -ws -i $< -o $@
+
 lib/org/strategoxt/stratego_gpp/Main.java : $(STRATEGOXT)/share/libstratego-gpp.ctree ../trans/strj
 	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/gpp -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_gpp -la stratego-lib -la stratego-lib -la stratego-sglr
 



From L.C.L.Kats at tudelft.nl  Mon Oct 19 11:55:11 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 19 Oct 2009 09:55:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20114 - LennartKats -
	strc-java/trunk/java
Message-ID: <200910190955.n9J9tBRZ013369@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-19 09:55:11 +0000 (Mon, 19 Oct 2009)
New Revision: 20114

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20114&view=rev

Modified:
   strc-java/trunk/java/Makefile.am

Log:


Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-19 09:14:36 UTC (rev 20113)
+++ strc-java/trunk/java/Makefile.am	2009-10-19 09:55:11 UTC (rev 20114)
@@ -40,7 +40,9 @@
 
 TOOLSTRS = \
   $(wildcard tools/org/strategoxt/tools/*.str) \
-  $(wildcard tools/org/strategoxt/tools/lib/*.str)
+  $(wildcard tools/org/strategoxt/tools/*.meta) \
+  $(wildcard tools/org/strategoxt/tools/lib/*.str) \
+  $(wildcard tools/org/strategoxt/tools/lib/*.meta)
 
 nobase_pkgdata_DATA = \
   runtime/org/strategoxt/lang/parallel/stratego_parallel/libstratego-parallel.rtree \
@@ -60,7 +62,7 @@
   $(wildcard runtime/org/strategoxt/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*.str) \
   $(wildcard runtime/org/strategoxt/*/*/*/*/*/*.str) \
-  $(TOOLSTRS) $(TOOLSTRS:.str=.meta) \
+  $(TOOLSTRS) \
   spoofax-libs.jar \
   bin \
   META-INF/MANIFEST.MF
@@ -164,6 +166,7 @@
 
 # HACK: work-around for the Java BAFReader
 lib/org/strategoxt/stratego_rtg/rtg.tbl : $(STRATEGOXT)/share/sdf/stratego-regular/rtg.tbl
+	[ -e lib/org/strategoxt/stratego_rtg ] || mkdir lib/org/strategoxt/stratego_rtg
 	baffle -ws -i $< -o $@
 
 lib/org/strategoxt/stratego_gpp/Main.java : $(STRATEGOXT)/share/libstratego-gpp.ctree ../trans/strj



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:19:28 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:19:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20118 - rob -
	hydra/strategoxt
Message-ID: <200910200619.n9K6JSPG029755@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:19:27 +0000 (Tue, 20 Oct 2009)
New Revision: 20118

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20118&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
remove all notifyaddresses before enabling mails

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-19 14:54:46 UTC (rev 20117)
+++ hydra/strategoxt/packages.nix	2009-10-20 06:19:27 UTC (rev 20118)
@@ -1,5 +1,6 @@
 rec {
   bravenboer = "martin.bravenboer at gmail.com";
+  rob = "rob.vermaas at gmail.com";
   kalleberg = "karltk at strategoxt.org";
   visser = "e.visser at tudelft.nl";
   kats = "l.c.l.kats at tudelft.nl";
@@ -39,7 +40,7 @@
       fullName = "Stratego/XT";
       packageName = "strategoxt";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [bravenboer visser kalleberg];
+      notifyAddresses = [];
       attrPrefix = "strategoxt";
 
       svn = {
@@ -60,7 +61,7 @@
     pkgs : (strategoxt pkgs) // {
       fullName = "Stratego/XT Bootstrap branch";
       packageName = "strategoxt-bootstrap";
-      notifyAddresses = [pierron];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/strategoxt/branches/strategoxt-fix-compilation;
@@ -75,7 +76,7 @@
       fullName = "Stratego Libraries";
       packageName = "stratego-libraries";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [bravenboer visser kalleberg];
+      notifyAddresses = [];
       attrPrefix = "strategoLibraries";
 
       svn = {
@@ -135,7 +136,7 @@
       fullName = "Stratego Shell";
       packageName = "stratego-shell";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [bravenboer visser kalleberg];
+      notifyAddresses = [];
       attrPrefix = "strategoShell";
 
       svn = {
@@ -218,7 +219,7 @@
       packageName = "aster";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "aster";
-      notifyAddresses = [ kats ];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/aster/trunk;
@@ -265,7 +266,7 @@
       packageName = "java-front";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "javaFront";
-      notifyAddresses = [bravenboer kalleberg visser kats];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/java-front/trunk;
@@ -322,7 +323,7 @@
       packageName = "java-front-syntax";
       attrPrefix = "javaFrontSyntax";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [bravenboer kalleberg visser kats];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/java-front/trunk/syntax;
@@ -351,7 +352,7 @@
       packageName = "dryad";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "dryad";
-      notifyAddresses = [bravenboer kats];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/dryad/trunk;
@@ -390,7 +391,7 @@
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/dryad-compiler/trunk;
       };
-      notifyAddresses = [kats bravenboer];
+      notifyAddresses = [];
 
       svnBuildInputs = buildInputs ++ (autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront dryad];
@@ -454,7 +455,7 @@
       attrPrefix = "jimpleFront";
 
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [bravenboer kalleberg];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/sootxt/jimple-front/trunk;
@@ -653,7 +654,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "aspectjFront";
-      notifyAddresses = [bravenboer];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/aspectj-front/trunk;
       };
@@ -712,7 +713,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "aspectjFrontSyntax";
-      notifyAddresses = [bravenboer];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/aspectj-front/trunk/syntax;
       };
@@ -758,7 +759,7 @@
       contactEmail = "transformers-bugs at lrde.epita.fr";
 
       attrPrefix = "transformersGenericTools";
-      notifyAddresses = [bravenboer "transformers-private at lrde.epita.fr"];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.lrde.epita.fr/svn/transformers/trunk/generic-tools;
       };
@@ -785,7 +786,7 @@
       contactEmail = "transformers-bugs at lrde.epita.fr";
 
       attrPrefix = "transformersCTools";
-      notifyAddresses = [bravenboer "transformers-private at lrde.epita.fr"];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.lrde.epita.fr/svn/transformers/trunk/c-tools;
       };
@@ -812,7 +813,7 @@
       contactEmail = "transformers-bugs at lrde.epita.fr";
 
       attrPrefix = "transformersCxxTools";
-      notifyAddresses = [bravenboer "transformers-private at lrde.epita.fr"];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.lrde.epita.fr/svn/transformers/trunk/cxx-tools;
       };
@@ -839,7 +840,7 @@
       contactEmail = "karltk at strategoxt.org";
 
       attrPrefix = "lutin";
-      notifyAddresses = [kalleberg];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.strategoxt.org/repos/lutin/trunk;
       };
@@ -867,7 +868,7 @@
       contactEmail = "magnolia at ii.uib.no";
 
       attrPrefix = "magnolia";
-      notifyAddresses = ["magnolia at magnolia-lang.org"];
+      notifyAddresses = [];
       svn = {
         trunk = https://www.ii.uib.no/svn/magnolia/trunk;
       };
@@ -920,7 +921,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "sqlFront";
-      notifyAddresses = [bravenboer];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/sql-front/trunk;
       };
@@ -944,7 +945,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "stringborg";
-      notifyAddresses = [bravenboer];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/stringborg/trunk;
       };
@@ -990,7 +991,7 @@
       packageName = "webdsl";
       contactEmail = "webdsl at st.ewi.tudelft.nl";
       attrPrefix = "webdsl";
-      notifyAddresses = [ "webdsl at st.ewi.tudelft.nl" ];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/WebDSL/webdsls/trunk;
@@ -1018,7 +1019,7 @@
       packageName = "strategoxt-utils";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "strategoxtUtils";
-      notifyAddresses = [kalleberg bravenboer visser];
+      notifyAddresses = [];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/strategoxt-utils/trunk;
@@ -1076,7 +1077,7 @@
       fullName = "xdoc";
       packageName = "xdoc";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [bravenboer "robv at cs.uu.nl"];
+      notifyAddresses = [];
       attrPrefix = "xdoc";
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/xdoc/trunk;
@@ -1154,7 +1155,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "phpFront";
-      notifyAddresses = ["psat-commits at cs.uu.nl"];
+      notifyAddresses = [];
       svn = {
         trunk = https://svn.cs.uu.nl:12443/repos/psat/php-front/trunk;
       };



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:26:42 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:26:42 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20119 - rob -
	hydra/strategoxt
Message-ID: <200910200626.n9K6QguI029792@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:26:42 +0000 (Tue, 20 Oct 2009)
New Revision: 20119

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20119&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
add rob to all notifyemails

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-20 06:19:27 UTC (rev 20118)
+++ hydra/strategoxt/packages.nix	2009-10-20 06:26:42 UTC (rev 20119)
@@ -40,7 +40,7 @@
       fullName = "Stratego/XT";
       packageName = "strategoxt";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       attrPrefix = "strategoxt";
 
       svn = {
@@ -61,7 +61,7 @@
     pkgs : (strategoxt pkgs) // {
       fullName = "Stratego/XT Bootstrap branch";
       packageName = "strategoxt-bootstrap";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/strategoxt/branches/strategoxt-fix-compilation;
@@ -76,7 +76,7 @@
       fullName = "Stratego Libraries";
       packageName = "stratego-libraries";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       attrPrefix = "strategoLibraries";
 
       svn = {
@@ -136,7 +136,7 @@
       fullName = "Stratego Shell";
       packageName = "stratego-shell";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       attrPrefix = "strategoShell";
 
       svn = {
@@ -219,7 +219,7 @@
       packageName = "aster";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "aster";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/aster/trunk;
@@ -266,7 +266,7 @@
       packageName = "java-front";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "javaFront";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/java-front/trunk;
@@ -323,7 +323,7 @@
       packageName = "java-front-syntax";
       attrPrefix = "javaFrontSyntax";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/java-front/trunk/syntax;
@@ -352,7 +352,7 @@
       packageName = "dryad";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "dryad";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/dryad/trunk;
@@ -391,7 +391,7 @@
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/dryad-compiler/trunk;
       };
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svnBuildInputs = buildInputs ++ (autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront dryad];
@@ -455,7 +455,7 @@
       attrPrefix = "jimpleFront";
 
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/sootxt/jimple-front/trunk;
@@ -654,7 +654,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "aspectjFront";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/aspectj-front/trunk;
       };
@@ -713,7 +713,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "aspectjFrontSyntax";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/aspectj-front/trunk/syntax;
       };
@@ -759,7 +759,7 @@
       contactEmail = "transformers-bugs at lrde.epita.fr";
 
       attrPrefix = "transformersGenericTools";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.lrde.epita.fr/svn/transformers/trunk/generic-tools;
       };
@@ -786,7 +786,7 @@
       contactEmail = "transformers-bugs at lrde.epita.fr";
 
       attrPrefix = "transformersCTools";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.lrde.epita.fr/svn/transformers/trunk/c-tools;
       };
@@ -813,7 +813,7 @@
       contactEmail = "transformers-bugs at lrde.epita.fr";
 
       attrPrefix = "transformersCxxTools";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.lrde.epita.fr/svn/transformers/trunk/cxx-tools;
       };
@@ -840,7 +840,7 @@
       contactEmail = "karltk at strategoxt.org";
 
       attrPrefix = "lutin";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.strategoxt.org/repos/lutin/trunk;
       };
@@ -868,7 +868,7 @@
       contactEmail = "magnolia at ii.uib.no";
 
       attrPrefix = "magnolia";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://www.ii.uib.no/svn/magnolia/trunk;
       };
@@ -921,7 +921,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "sqlFront";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/sql-front/trunk;
       };
@@ -945,7 +945,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "stringborg";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/stringborg/trunk;
       };
@@ -991,7 +991,7 @@
       packageName = "webdsl";
       contactEmail = "webdsl at st.ewi.tudelft.nl";
       attrPrefix = "webdsl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/WebDSL/webdsls/trunk;
@@ -1019,7 +1019,7 @@
       packageName = "strategoxt-utils";
       contactEmail = "stratego at cs.uu.nl";
       attrPrefix = "strategoxtUtils";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
 
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/strategoxt-utils/trunk;
@@ -1077,7 +1077,7 @@
       fullName = "xdoc";
       packageName = "xdoc";
       contactEmail = "stratego at cs.uu.nl";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       attrPrefix = "xdoc";
       svn = {
         trunk = https://svn.strategoxt.org/repos/StrategoXT/xdoc/trunk;
@@ -1155,7 +1155,7 @@
       contactEmail = "stratego at cs.uu.nl";
 
       attrPrefix = "phpFront";
-      notifyAddresses = [];
+      notifyAddresses = [rob];
       svn = {
         trunk = https://svn.cs.uu.nl:12443/repos/psat/php-front/trunk;
       };



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:27:05 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:27:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20120 - rob - hydra
Message-ID: <200910200627.n9K6R5GX029798@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:27:05 +0000 (Tue, 20 Oct 2009)
New Revision: 20120

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20120&view=rev

Modified:
   hydra/build.nix

Log:
enable meta.maintainers in builds

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-20 06:26:42 UTC (rev 20119)
+++ hydra/build.nix	2009-10-20 06:27:05 UTC (rev 20120)
@@ -38,6 +38,8 @@
           if (spec pkgs) ? makeDistRequiresInstall then !((spec pkgs).makeDistRequiresInstall) else true;
         distTarget =
           if (spec pkgs) ? makeDistcheckSupported then "distcheck" else "dist";  
+
+        meta.maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ;
  
         tarballs = "*.tar.gz";
       });
@@ -80,6 +82,9 @@
         if specpkgs ? configureFlags then specpkgs.configureFlags else null;
       doCheck =
         if specpkgs ? checkSupported then specpkgs.checkSupported else true;
+
+      meta.maintainers = if specpkgs ? notifyAddresses then specpkgs.notifyAddresses else [] ;
+
     });
 
   svnInputFromInputs = spec :



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:34:41 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:34:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20121 - rob -
	java-front/trunk
Message-ID: <200910200634.n9K6YffD029835@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:34:41 +0000 (Tue, 20 Oct 2009)
New Revision: 20121

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20121&view=rev

Modified:
   java-front/trunk/README

Log:
buildfarm push

Changes:

Modified: java-front/trunk/README
===================================================================
--- java-front/trunk/README	2009-10-20 06:27:05 UTC (rev 20120)
+++ java-front/trunk/README	2009-10-20 06:34:41 UTC (rev 20121)
@@ -2,7 +2,7 @@
 JavaFront
 --------------------------------------------------------------------------
 
-  Copyright (C) 2002-2006 Martin Bravenboer <martin at bravenboer.name>
+  Copyright (C) 2002-2009 Martin Bravenboer <martin at bravenboer.name>
   
   This library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:36:48 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:36:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20122 - rob -
	java-front/trunk
Message-ID: <200910200636.n9K6amkC029850@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:36:48 +0000 (Tue, 20 Oct 2009)
New Revision: 20122

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20122&view=rev

Modified:
   java-front/trunk/README

Log:
buildfarm push

Changes:

Modified: java-front/trunk/README
===================================================================
--- java-front/trunk/README	2009-10-20 06:34:41 UTC (rev 20121)
+++ java-front/trunk/README	2009-10-20 06:36:48 UTC (rev 20122)
@@ -17,6 +17,7 @@
   You should have received a copy of the GNU Lesser General Public
   License along with this library; if not, write to the Free Software
   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
+
   
 --------------------------------------------------------------------------
 Authors and contributors are listed in the AUTHORS file.



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:39:37 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:39:37 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20123 - rob -
	strategoxt/trunk/stratego-libraries
Message-ID: <200910200639.n9K6dbhA029859@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:39:37 +0000 (Tue, 20 Oct 2009)
New Revision: 20123

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20123&view=rev

Modified:
   strategoxt/trunk/stratego-libraries/README

Log:
buildfarm push

Changes:

Modified: strategoxt/trunk/stratego-libraries/README
===================================================================
--- strategoxt/trunk/stratego-libraries/README	2009-10-20 06:36:48 UTC (rev 20122)
+++ strategoxt/trunk/stratego-libraries/README	2009-10-20 06:39:37 UTC (rev 20123)
@@ -16,7 +16,7 @@
   stratego-bugs at cs.uu.nl
 
 
-Copyright (C) 1998-2006 Stratego Software Foundation
+Copyright (C) 1998-2009 Stratego Software Foundation
 
   This library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:48:32 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:48:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20124 - rob -
	strc-java/trunk
Message-ID: <200910200648.n9K6mWvB029931@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:48:32 +0000 (Tue, 20 Oct 2009)
New Revision: 20124

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20124&view=rev

Modified:
   strc-java/trunk/README

Log:
buildfarm push

Changes:

Modified: strc-java/trunk/README
===================================================================
--- strc-java/trunk/README	2009-10-20 06:39:37 UTC (rev 20123)
+++ strc-java/trunk/README	2009-10-20 06:48:32 UTC (rev 20124)
@@ -159,3 +159,4 @@
 external components may be covered by different licenses.
 
 Authors and contributors are listed in the AUTHORS file.
+



From R.B.Vermaas at tudelft.nl  Tue Oct 20 08:49:05 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 06:49:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20125 - rob -
	hydra/strategoxt
Message-ID: <200910200649.n9K6n5gh029944@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 06:49:05 +0000 (Tue, 20 Oct 2009)
New Revision: 20125

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20125&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2009-10-20 06:48:32 UTC (rev 20124)
+++ hydra/strategoxt/packages.nix	2009-10-20 06:49:05 UTC (rev 20125)
@@ -413,6 +413,7 @@
       fullName = "Stratego Java compiler";
       packageName = "strc-java";
       attrPrefix = "strcJava";
+      notifyAddresses = [rob];
 
       svnBuildInputs = buildInputs ++ (autotools pkgs);
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];



From R.B.Vermaas at tudelft.nl  Tue Oct 20 09:15:23 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 07:15:23 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20126 - rob -
	strc-java/trunk
Message-ID: <200910200715.n9K7FNsN030338@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 07:15:22 +0000 (Tue, 20 Oct 2009)
New Revision: 20126

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20126&view=rev

Modified:
   strc-java/trunk/strc-java.m4

Log:
 * added XT_USE_STRC_JAVA for packages depending on strc-java

Changes:

Modified: strc-java/trunk/strc-java.m4
===================================================================
--- strc-java/trunk/strc-java.m4	2009-10-20 06:49:05 UTC (rev 20125)
+++ strc-java/trunk/strc-java.m4	2009-10-20 07:15:22 UTC (rev 20126)
@@ -139,3 +139,15 @@
   AC_SUBST([LANGUAGE_TESTS])
 ])
 
+AC_DEFUN([XT_USE_STRC_JAVA], [
+  XT_CHECK_PACKAGE([STRC_JAVA],[strc-java])
+
+  AC_MSG_CHECKING([for strategoxt.jar at $STRC_JAVA/share/strc-java/strategoxt.jar])
+  test -x "$STRC_JAVA/share/strc-java/strategoxt.jar"
+  if test $? -eq 0; then
+    AC_MSG_RESULT([yes])
+  else
+    AC_MSG_RESULT([no])
+    AC_MSG_ERROR([cannot find strategoxt.jar. Is strc-java installed correctly?])
+  fi
+])



From R.B.Vermaas at tudelft.nl  Tue Oct 20 09:16:38 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 07:16:38 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20127 - rob -
	strc-java/trunk
Message-ID: <200910200716.n9K7Gca8030345@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 07:16:38 +0000 (Tue, 20 Oct 2009)
New Revision: 20127

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20127&view=rev

Modified:
   strc-java/trunk/Makefile.am

Log:
added strc-java to pkgdata_DATA

Changes:

Modified: strc-java/trunk/Makefile.am
===================================================================
--- strc-java/trunk/Makefile.am	2009-10-20 07:15:22 UTC (rev 20126)
+++ strc-java/trunk/Makefile.am	2009-10-20 07:16:38 UTC (rev 20127)
@@ -4,6 +4,7 @@
 am__tar = ${AMTAR} chf - "$$tardir"
 
 ACLOCAL_AMFLAGS = -I .
+pkgdata_DATA = strc-java.m4
 
 SUBDIRS           = syn trans java test tools
 BOOTCLEAN_SUBDIRS = $(SUBDIRS)



From R.B.Vermaas at tudelft.nl  Tue Oct 20 10:14:18 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 08:14:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20129 - rob -
	strc-java/trunk/java
Message-ID: <200910200814.n9K8EIGw031138@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 08:14:18 +0000 (Tue, 20 Oct 2009)
New Revision: 20129

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20129&view=rev

Modified:
   strc-java/trunk/java/Makefile.am

Log:
use baffle from  in stead of PATH

Changes:

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-20 07:39:42 UTC (rev 20128)
+++ strc-java/trunk/java/Makefile.am	2009-10-20 08:14:18 UTC (rev 20129)
@@ -167,7 +167,7 @@
 # HACK: work-around for the Java BAFReader
 lib/org/strategoxt/stratego_rtg/rtg.tbl : $(STRATEGOXT)/share/sdf/stratego-regular/rtg.tbl
 	[ -e lib/org/strategoxt/stratego_rtg ] || mkdir lib/org/strategoxt/stratego_rtg
-	baffle -ws -i $< -o $@
+	$(ATERM)/bin/baffle -ws -i $< -o $@
 
 lib/org/strategoxt/stratego_gpp/Main.java : $(STRATEGOXT)/share/libstratego-gpp.ctree ../trans/strj
 	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/sdf/gpp -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_gpp -la stratego-lib -la stratego-lib -la stratego-sglr



From R.B.Vermaas at tudelft.nl  Tue Oct 20 16:41:06 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 20 Oct 2009 14:41:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20130 - rob -
	strc-java/trunk
Message-ID: <200910201441.n9KEf6On004189@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-20 14:41:06 +0000 (Tue, 20 Oct 2009)
New Revision: 20130

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20130&view=rev

Added:
   strc-java/trunk/strc-java.pc.in
Modified:
   strc-java/trunk/Makefile.am
   strc-java/trunk/configure.ac

Log:
add strc-java pkgconfig stuff

Changes:

Modified: strc-java/trunk/Makefile.am
===================================================================
--- strc-java/trunk/Makefile.am	2009-10-20 08:14:18 UTC (rev 20129)
+++ strc-java/trunk/Makefile.am	2009-10-20 14:41:06 UTC (rev 20130)
@@ -4,7 +4,7 @@
 am__tar = ${AMTAR} chf - "$$tardir"
 
 ACLOCAL_AMFLAGS = -I .
-pkgdata_DATA = strc-java.m4
+pkgconfig_DATA = strc-java.m4 strc-java.pc
 
 SUBDIRS           = syn trans java test tools
 BOOTCLEAN_SUBDIRS = $(SUBDIRS)

Modified: strc-java/trunk/configure.ac
===================================================================
--- strc-java/trunk/configure.ac	2009-10-20 08:14:18 UTC (rev 20129)
+++ strc-java/trunk/configure.ac	2009-10-20 14:41:06 UTC (rev 20130)
@@ -26,6 +26,7 @@
 
 ### OUTPUT #############################
 AC_CONFIG_FILES([
+  strc-java.pc
   Makefile
   syn/Makefile
   trans/Makefile

Added: strc-java/trunk/strc-java.pc.in
===================================================================
--- strc-java/trunk/strc-java.pc.in	                        (rev 0)
+++ strc-java/trunk/strc-java.pc.in	2009-10-20 14:41:06 UTC (rev 20130)
@@ -0,0 +1,8 @@
+prefix=@prefix@
+datarootdir=@datarootdir@
+pkgdatadir=@datadir@/@PACKAGE@
+sdfdatadir=@datadir@/sdf/@PACKAGE@
+
+Name: strc-java
+Description: Stratego Java compiler
+Version: @PACKAGE_VERSION@



From R.B.Vermaas at tudelft.nl  Wed Oct 21 11:58:36 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 09:58:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20134 - rob - hydra
Message-ID: <200910210958.n9L9waCJ019425@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 09:58:36 +0000 (Wed, 21 Oct 2009)
New Revision: 20134

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20134&view=rev

Modified:
   hydra/build.nix

Log:
add maintainers to debian and rpm builds

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-20 16:08:24 UTC (rev 20133)
+++ hydra/build.nix	2009-10-21 09:58:36 UTC (rev 20134)
@@ -160,6 +160,7 @@
 
       dontBuild = false;
       useTempPrefix = false;
+
     };
 
 
@@ -192,6 +193,9 @@
       # Hack - swap checkPhase and installPhase (otherwise Stratego and SDF barf).
       phases = "installExtraDebsPhase sysInfoPhase unpackPhase patchPhase configurePhase buildPhase installPhase checkPhase fixupPhase distPhase";
       dontDisableStatic = true;
+
+      meta.maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ;
+
     } // ( if (builtins.substring 0 6 diskImage.name) == "ubuntu" then { NIX_CFLAGS_COMPILE = "-fno-stack-protector" ; } else {} ) );
 
   /**
@@ -221,6 +225,8 @@
 
       extraRPMs = map (s : easyRPMBuildFromTarball pkgs s (easyTarball pkgs s) diskImageFun prio version) (spec pkgs).requires;
       dontDisableStatic = true;
+
+      meta.maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ;
     };
 
 



From R.B.Vermaas at tudelft.nl  Wed Oct 21 13:24:11 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 11:24:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20135 - rob - hydra
Message-ID: <200910211124.n9LBOBXV020956@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 11:24:10 +0000 (Wed, 21 Oct 2009)
New Revision: 20135

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20135&view=rev

Modified:
   hydra/build.nix

Log:
typo

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 09:58:36 UTC (rev 20134)
+++ hydra/build.nix	2009-10-21 11:24:10 UTC (rev 20135)
@@ -179,7 +179,8 @@
       diskImage = diskImage;
       memSize = 1024 ;
 
-      meta = { schedulingPriority = toString prio; };
+      meta = { schedulingPriority = toString prio; 
+               maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ; };
 
       patches =
         if specpkgs ? patches then specpkgs.patches else [];
@@ -194,7 +195,6 @@
       phases = "installExtraDebsPhase sysInfoPhase unpackPhase patchPhase configurePhase buildPhase installPhase checkPhase fixupPhase distPhase";
       dontDisableStatic = true;
 
-      meta.maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ;
 
     } // ( if (builtins.substring 0 6 diskImage.name) == "ubuntu" then { NIX_CFLAGS_COMPILE = "-fno-stack-protector" ; } else {} ) );
 
@@ -214,7 +214,8 @@
       diskImage = diskImage;
       memSize = 1024;
 
-      meta = { schedulingPriority = toString prio; };
+      meta = { schedulingPriority = toString prio; 
+               maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ; };
 
       patches =
         if specpkgs ? patches then specpkgs.patches else [];
@@ -226,7 +227,6 @@
       extraRPMs = map (s : easyRPMBuildFromTarball pkgs s (easyTarball pkgs s) diskImageFun prio version) (spec pkgs).requires;
       dontDisableStatic = true;
 
-      meta.maintainers = if (spec pkgs) ? notifyAddresses then (spec pkgs).notifyAddresses else [] ;
     };
 
 



From R.B.Vermaas at tudelft.nl  Wed Oct 21 13:35:46 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 11:35:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20136 - rob - hydra
Message-ID: <200910211135.n9LBZkQU021073@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 11:35:46 +0000 (Wed, 21 Oct 2009)
New Revision: 20136

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20136&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 11:24:10 UTC (rev 20135)
+++ hydra/build.nix	2009-10-21 11:35:46 UTC (rev 20136)
@@ -1,7 +1,7 @@
 { 
   pkgsDefault 
 , officialRelease ? false 
-, baseline ? {}
+, baseline ? ( pkgs: {} )
 , makeDebs ? false
 , makeRPMs ? false
 , ...



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:10:13 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:10:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20137 - rob - hydra
Message-ID: <200910211210.n9LCADbC021555@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:10:12 +0000 (Wed, 21 Oct 2009)
New Revision: 20137

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20137&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 11:35:46 UTC (rev 20136)
+++ hydra/build.nix	2009-10-21 12:10:12 UTC (rev 20137)
@@ -4,6 +4,7 @@
 , baseline ? ( pkgs: {} )
 , makeDebs ? false
 , makeRPMs ? false
+, makeDocs ? false
 , ...
 } @ inputs : rec {
 
@@ -229,6 +230,15 @@
 
     };
 
+  makeDocsJob = 
+    if makeDocs then {
+      docs = easyDocsTarball rec {
+         title = "${packageName} xDoc documentation";
+         checkout = svnInputFromInputs spec;
+         packageName = (spec pkgs).packageName;
+         xdocIncludes = ["${inputs.build}/share/sdf/${packageName}"];
+       } ;
+     } else {} ;
 
   easyReleaseNix = pkgs : spec : tarball :
      pkgs.runCommand



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:13:21 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:13:21 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20139 - rob - hydra/jobs
Message-ID: <200910211213.n9LCDLwH021579@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:13:21 +0000 (Wed, 21 Oct 2009)
New Revision: 20139

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20139&view=rev

Modified:
   hydra/jobs/java-front.nix

Log:


Changes:

Modified: hydra/jobs/java-front.nix
===================================================================
--- hydra/jobs/java-front.nix	2009-10-21 12:10:46 UTC (rev 20138)
+++ hydra/jobs/java-front.nix	2009-10-21 12:13:21 UTC (rev 20139)
@@ -2,7 +2,8 @@
 , officialRelease ? false
 , hydraConfig ? ../. 
 , baselineNix ? ../baseline.nix
-, javaFrontCheckout ? { outPath = ../../javaFront ; rev = 1234 ; }
+, javaFrontCheckout ? { outPath = ../../java-front ; rev = 1234 ; }
+, xdoc ? (import ./xdoc.nix {}).build {}
 } :
 
 let
@@ -14,9 +15,11 @@
         inherit javaFrontCheckout ;
         inherit hydraConfig ;
         inherit baselineNix ;
-        inherit nixpkgs; 
+        inherit nixpkgs;
+        inherit xdoc; 
         makeDebs = true;
         makeRPMs = true;
+        makeDocs = true;
       } ; 
    
       spec = specs.javaFront ; 



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:14:11 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:14:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20140 - rob - hydra
Message-ID: <200910211214.n9LCEBW1021591@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:14:11 +0000 (Wed, 21 Oct 2009)
New Revision: 20140

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20140&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 12:13:21 UTC (rev 20139)
+++ hydra/build.nix	2009-10-21 12:14:11 UTC (rev 20140)
@@ -230,7 +230,7 @@
 
     };
 
-  makeDocsJob = 
+  makeDocsJob = spec :
     if makeDocs then {
       docs = easyDocsTarball rec {
          title = "${packageName} xDoc documentation";



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:14:28 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:14:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20141 - rob - hydra
Message-ID: <200910211214.n9LCESc8021594@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:14:28 +0000 (Wed, 21 Oct 2009)
New Revision: 20141

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20141&view=rev

Modified:
   hydra/job.nix

Log:


Changes:

Modified: hydra/job.nix
===================================================================
--- hydra/job.nix	2009-10-21 12:14:11 UTC (rev 20140)
+++ hydra/job.nix	2009-10-21 12:14:28 UTC (rev 20141)
@@ -15,7 +15,7 @@
     release = { tarball ? jobs.tarball }: builder.easyReleaseNix pkgsDebRPM spec tarball ;
   } // builder.debs pkgsDebRPM spec tarballTop
     // builder.rpms pkgsDebRPM spec tarballTop
-    // builder.makeDocsJob
+    // builder.makeDocsJob spec
     // extraJobs builder ;
 
 in jobs



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:10:46 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:10:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20138 - rob - hydra
Message-ID: <200910211210.n9LCAkx1021558@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:10:46 +0000 (Wed, 21 Oct 2009)
New Revision: 20138

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20138&view=rev

Modified:
   hydra/job.nix

Log:


Changes:

Modified: hydra/job.nix
===================================================================
--- hydra/job.nix	2009-10-21 12:10:12 UTC (rev 20137)
+++ hydra/job.nix	2009-10-21 12:10:46 UTC (rev 20138)
@@ -15,6 +15,7 @@
     release = { tarball ? jobs.tarball }: builder.easyReleaseNix pkgsDebRPM spec tarball ;
   } // builder.debs pkgsDebRPM spec tarballTop
     // builder.rpms pkgsDebRPM spec tarballTop
+    // builder.makeDocsJob
     // extraJobs builder ;
 
 in jobs



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:21:23 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:21:23 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20144 - rob - hydra
Message-ID: <200910211221.n9LCLNHt021682@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:21:23 +0000 (Wed, 21 Oct 2009)
New Revision: 20144

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20144&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 12:20:40 UTC (rev 20143)
+++ hydra/build.nix	2009-10-21 12:21:23 UTC (rev 20144)
@@ -231,14 +231,15 @@
     };
 
   makeDocsJob = pkgs: spec :
-    { build }:
     if makeDocs then {
-      docs = easyDocsTarball rec {
-         title = "${packageName} xDoc documentation";
-         checkout = svnInputFromInputs spec;
-         packageName = (spec pkgs).packageName;
-         xdocIncludes = ["${inputs.build}/share/sdf/${packageName}"];
-       } ;
+      docs =     
+        { build }:
+        easyDocsTarball rec {
+          title = "${packageName} xDoc documentation";
+          checkout = svnInputFromInputs spec;
+          packageName = (spec pkgs).packageName;
+          xdocIncludes = ["${inputs.build}/share/sdf/${packageName}"];
+        } ;
      } else {} ;
 
   easyReleaseNix = pkgs : spec : tarball :



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:22:00 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:22:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20145 - rob - hydra
Message-ID: <200910211222.n9LCM037021691@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:22:00 +0000 (Wed, 21 Oct 2009)
New Revision: 20145

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20145&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 12:21:23 UTC (rev 20144)
+++ hydra/build.nix	2009-10-21 12:22:00 UTC (rev 20145)
@@ -238,7 +238,7 @@
           title = "${packageName} xDoc documentation";
           checkout = svnInputFromInputs spec;
           packageName = (spec pkgs).packageName;
-          xdocIncludes = ["${inputs.build}/share/sdf/${packageName}"];
+          xdocIncludes = ["${build}/share/sdf/${packageName}"];
         } ;
      } else {} ;
 



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:17:27 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:17:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20142 - rob - hydra
Message-ID: <200910211217.n9LCHRaU021633@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:17:27 +0000 (Wed, 21 Oct 2009)
New Revision: 20142

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20142&view=rev

Modified:
   hydra/build.nix
   hydra/job.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 12:14:28 UTC (rev 20141)
+++ hydra/build.nix	2009-10-21 12:17:27 UTC (rev 20142)
@@ -230,7 +230,7 @@
 
     };
 
-  makeDocsJob = spec :
+  makeDocsJob = pkgs: spec :
     if makeDocs then {
       docs = easyDocsTarball rec {
          title = "${packageName} xDoc documentation";

Modified: hydra/job.nix
===================================================================
--- hydra/job.nix	2009-10-21 12:14:28 UTC (rev 20141)
+++ hydra/job.nix	2009-10-21 12:17:27 UTC (rev 20142)
@@ -15,7 +15,7 @@
     release = { tarball ? jobs.tarball }: builder.easyReleaseNix pkgsDebRPM spec tarball ;
   } // builder.debs pkgsDebRPM spec tarballTop
     // builder.rpms pkgsDebRPM spec tarballTop
-    // builder.makeDocsJob spec
+    // builder.makeDocsJob pkgsDebRPM spec
     // extraJobs builder ;
 
 in jobs



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:20:40 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:20:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20143 - rob - hydra
Message-ID: <200910211220.n9LCKeLD021677@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:20:40 +0000 (Wed, 21 Oct 2009)
New Revision: 20143

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20143&view=rev

Modified:
   hydra/build.nix

Log:


Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-21 12:17:27 UTC (rev 20142)
+++ hydra/build.nix	2009-10-21 12:20:40 UTC (rev 20143)
@@ -231,6 +231,7 @@
     };
 
   makeDocsJob = pkgs: spec :
+    { build }:
     if makeDocs then {
       docs = easyDocsTarball rec {
          title = "${packageName} xDoc documentation";



From R.B.Vermaas at tudelft.nl  Wed Oct 21 14:49:58 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 21 Oct 2009 12:49:58 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20146 - rob - hydra/jobs
Message-ID: <200910211249.n9LCnwvV021968@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-21 12:49:58 +0000 (Wed, 21 Oct 2009)
New Revision: 20146

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20146&view=rev

Modified:
   hydra/jobs/java-front.nix

Log:


Changes:

Modified: hydra/jobs/java-front.nix
===================================================================
--- hydra/jobs/java-front.nix	2009-10-21 12:22:00 UTC (rev 20145)
+++ hydra/jobs/java-front.nix	2009-10-21 12:49:58 UTC (rev 20146)
@@ -16,10 +16,8 @@
         inherit hydraConfig ;
         inherit baselineNix ;
         inherit nixpkgs;
-        inherit xdoc; 
         makeDebs = true;
         makeRPMs = true;
-        makeDocs = true;
       } ; 
    
       spec = specs.javaFront ; 



From L.C.L.Kats at tudelft.nl  Wed Oct 21 16:52:01 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 21 Oct 2009 14:52:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20150 - LennartKats -
	strc-java/trunk/tools
Message-ID: <200910211452.n9LEq16h024368@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-21 14:52:00 +0000 (Wed, 21 Oct 2009)
New Revision: 20150

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20150&view=rev

Modified:
   strc-java/trunk/tools/strj-jar

Log:


Changes:

Modified: strc-java/trunk/tools/strj-jar
===================================================================
--- strc-java/trunk/tools/strj-jar	2009-10-21 14:49:55 UTC (rev 20149)
+++ strc-java/trunk/tools/strj-jar	2009-10-21 14:52:00 UTC (rev 20150)
@@ -112,7 +112,7 @@
   echo "WARNING: using this build directory may mean non-term files are included as attachments" >&2
 fi
 
-ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|log|astr|str|meta|dep|c|lo|o|class|MF)$' | sed 's!^!-C $INPUTDIR !'`
+ATTACHMENTS=`ls $INPUTDIR | grep -vE '^.*\.(java|jar|log|astr|str|meta|dep|c|lo|o|class|MF)$' | sed "s!^!-C $INPUTDIR !"`
 
 echo $JAR cfm $OUTPUT \$TEMPDIR/MANIFEST.MF -C \$TEMPDIR . $ATTACHMENTS
 $JAR cfm $OUTPUT $TEMPDIR/MANIFEST.MF -C $TEMPDIR . $ATTACHMENTS



From L.C.L.Kats at tudelft.nl  Wed Oct 21 16:53:53 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 21 Oct 2009 14:53:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20151 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.generator/src/sdf2imp/lib
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards
Message-ID: <200910211453.n9LErrg3024374@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-21 14:53:52 +0000 (Wed, 21 Oct 2009)
New Revision: 20151

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20151&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str	2009-10-21 14:52:00 UTC (rev 20150)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/lib/sdf2rtg.str	2009-10-21 14:53:52 UTC (rev 20151)
@@ -3,7 +3,7 @@
 imports
   libstratego-lib
   libstratego-xtc
-  tool-doc
+  libstratego-tool-doc
 
 signature constructors
   IgnoreMissingCons : Option

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java	2009-10-21 14:52:00 UTC (rev 20150)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java	2009-10-21 14:53:52 UTC (rev 20151)
@@ -104,6 +104,7 @@
 		monitor.setTaskName("Preparing project builder");
 		EditorIOAgent agent = new EditorIOAgent();		
 		Context context = new Context(Environment.getTermFactory(), agent);
+		context.registerClassLoader(make_permissive.class.getClassLoader());
 		sdf2imp.init(context);
 		monitor.worked(1);
 



From R.B.Vermaas at tudelft.nl  Fri Oct 23 15:32:27 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 23 Oct 2009 13:32:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20155 - rob - hydra/jobs
Message-ID: <200910231332.n9NDWRaR029874@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-23 13:32:27 +0000 (Fri, 23 Oct 2009)
New Revision: 20155

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20155&view=rev

Modified:
   hydra/jobs/java-front.nix

Log:


Changes:

Modified: hydra/jobs/java-front.nix
===================================================================
--- hydra/jobs/java-front.nix	2009-10-23 13:18:26 UTC (rev 20154)
+++ hydra/jobs/java-front.nix	2009-10-23 13:32:27 UTC (rev 20155)
@@ -3,7 +3,6 @@
 , hydraConfig ? ../. 
 , baselineNix ? ../baseline.nix
 , javaFrontCheckout ? { outPath = ../../java-front ; rev = 1234 ; }
-, xdoc ? (import ./xdoc.nix {}).build {}
 } :
 
 let



From L.C.L.Kats at tudelft.nl  Fri Oct 23 15:32:53 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 23 Oct 2009 13:32:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20156 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter
Message-ID: <200910231332.n9NDWr9V029879@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-23 13:32:53 +0000 (Fri, 23 Oct 2009)
New Revision: 20156

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20156&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeLink.java

Log:
Fixed term equality for annotated terms that contain position information.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeLink.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeLink.java	2009-10-23 13:32:27 UTC (rev 20155)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeLink.java	2009-10-23 13:32:53 UTC (rev 20156)
@@ -11,6 +11,7 @@
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.IStrategoTuple;
 import org.spoofax.interpreter.terms.ITermPrinter;
+import org.strategoxt.lang.terms.TermFactory;
 
 /**
  * A wrapper class linking any {@link IStrategoTerm} to an {@link IAst} node.
@@ -44,12 +45,19 @@
 
 	@Override
 	protected boolean doSlowMatch(IStrategoTerm second, int commonStorageType) {
-		if (second.getAnnotations().size() != getAnnotations().size())
-			return false;
+		IStrategoTerm wrapped = getWrapped();
+		IStrategoList annotations = getAnnotations();
+		IStrategoList secondAnnotations = second.getAnnotations();
 		
-		assert getAnnotations().equals(wrapped.getAnnotations());
+		if (annotations != secondAnnotations && !annotations.match(secondAnnotations))
+        	return false;
 		
-		return wrapped.equals(second) && getAnnotations().equals(second);
+		if (annotations.isEmpty()) {
+			return wrapped.match(second);
+		} else {
+			second = getFactory().annotateTerm(second, TermFactory.EMPTY_LIST);
+			return wrapped.match(second);
+		}
 	}
 
 	@Override



From R.B.Vermaas at tudelft.nl  Fri Oct 23 15:53:31 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 23 Oct 2009 13:53:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20157 - rob - hydra/jobs
Message-ID: <200910231353.n9NDrVGk030057@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-23 13:53:31 +0000 (Fri, 23 Oct 2009)
New Revision: 20157

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20157&view=rev

Modified:
   hydra/jobs/stratego-libraries.nix

Log:


Changes:

Modified: hydra/jobs/stratego-libraries.nix
===================================================================
--- hydra/jobs/stratego-libraries.nix	2009-10-23 13:32:53 UTC (rev 20156)
+++ hydra/jobs/stratego-libraries.nix	2009-10-23 13:53:31 UTC (rev 20157)
@@ -19,7 +19,7 @@
         inherit nixpkgs; 
       } ; 
    
-      spec = pkgs : specs.strategoLibraries pkgs // ( if system != "i686-mingw" && std != "" then { configureFlags = "--with-std=${std}" ; } else {} ) ; 
+      spec = specs.strategoLibraries ; #pkgs : specs.strategoLibraries pkgs // ( if system != "i686-mingw" && std != "" then { configureFlags = "--with-std=${std}" ; } else {} ) ; 
 
     } ;
 



From R.B.Vermaas at tudelft.nl  Fri Oct 23 15:57:02 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 23 Oct 2009 13:57:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20158 - rob - hydra/jobs
Message-ID: <200910231357.n9NDv2fl030094@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-23 13:57:01 +0000 (Fri, 23 Oct 2009)
New Revision: 20158

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20158&view=rev

Modified:
   hydra/jobs/stratego-libraries.nix

Log:
 

Changes:

Modified: hydra/jobs/stratego-libraries.nix
===================================================================
--- hydra/jobs/stratego-libraries.nix	2009-10-23 13:53:31 UTC (rev 20157)
+++ hydra/jobs/stratego-libraries.nix	2009-10-23 13:57:01 UTC (rev 20158)
@@ -4,7 +4,6 @@
 , baselineNix ? ../baseline.nix
 , strategoLibrariesCheckout ? { outPath = ../../strategoxt/stratego-libraries ; rev = 1234 ; } 
 , std ? ""
-, system ? "i686-linux"
 } :
 
 let



From R.B.Vermaas at tudelft.nl  Fri Oct 23 15:59:25 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 23 Oct 2009 13:59:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20159 - rob - hydra/jobs
Message-ID: <200910231359.n9NDxPJO030114@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-23 13:59:25 +0000 (Fri, 23 Oct 2009)
New Revision: 20159

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20159&view=rev

Modified:
   hydra/jobs/stratego-libraries.nix

Log:
 

Changes:

Modified: hydra/jobs/stratego-libraries.nix
===================================================================
--- hydra/jobs/stratego-libraries.nix	2009-10-23 13:57:01 UTC (rev 20158)
+++ hydra/jobs/stratego-libraries.nix	2009-10-23 13:59:25 UTC (rev 20159)
@@ -18,7 +18,7 @@
         inherit nixpkgs; 
       } ; 
    
-      spec = specs.strategoLibraries ; #pkgs : specs.strategoLibraries pkgs // ( if system != "i686-mingw" && std != "" then { configureFlags = "--with-std=${std}" ; } else {} ) ; 
+      spec = pkgs : specs.strategoLibraries pkgs // ( if pkgs.stdenv.system != "i686-mingw" && std != "" then { configureFlags = "--with-std=${std}" ; } else {} ) ; 
 
     } ;
 



From L.C.L.Kats at tudelft.nl  Sun Oct 25 16:18:22 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sun, 25 Oct 2009 15:18:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20161 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.generator
	org.strategoxt.imp.generator/src/sdf2imp
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.metatooling
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego
Message-ID: <200910251518.n9PFIMCK013561@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-25 15:18:21 +0000 (Sun, 25 Oct 2009)
New Revision: 20161

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20161&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/build.properties
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java

Log:
Disabled the use of the included sdf2table for now, and re-introduced the error if sdf2table is not on the path.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile	2009-10-23 14:53:13 UTC (rev 20160)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/Makefile	2009-10-25 15:18:21 UTC (rev 20161)
@@ -58,7 +58,7 @@
 
 jar : lib/sdf2imp.jar
 
-check : all \
+check : sdf2imp syntax \
         test/EditorService.runtestsuite \
         test/test-editor-service.runsh \
         test/test-stratego-java.runsh \

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2009-10-23 14:53:13 UTC (rev 20160)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2009-10-25 15:18:21 UTC (rev 20161)
@@ -130,7 +130,7 @@
     
     say(!"SUCCESS: completed with 0 fatal errors.")
   
-  // TODO: XTC detox -_-;;
+  // (Note that these xtc calls are intercepted by the Spoofax/IMP runtime.)
   sdf2rtg:
     FILE(sdf) -> rtg
     with
@@ -138,8 +138,9 @@
       if FILE(has-extension(|"sdf")) then
         fatal-err(|"Input file must be a .def file.")
       end;
-      xtc-transform(!"sdf2table", !["-n", "-m", <get-sdf-main-module> | <pass-v-verbose>]);
-      xtc-transform(!"implodePT");
+      table := <xtc-new-file>;
+      <sdf2table> (sdf, table, ["-n"]);
+      <xtc-transform(!"implodePT")> FILE(table);
       read-from;
       sdf-desugar;
       core-sdf-grammar2rtg => rtg

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str	2009-10-23 14:53:13 UTC (rev 20160)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-parse-table.str	2009-10-25 15:18:21 UTC (rev 20161)
@@ -33,11 +33,12 @@
       FILE(input') := <create-permissive-grammar> FILE(input);
       output       := <parse-table-target>;
       print-filename(|[], output);
-      <debug; sdf2table> (input', output)
+      <debug; sdf2table> (input', output, [])
   
+  // (Note that these xtc calls are intercepted by the Spoofax/IMP runtime.)
   sdf2table =
-    ?(input, output);
-    <xtc-command(!"sdf2table")> ["-i", <abspath> input, "-o", <abspath> output, "-m", <get-sdf-main-module>]
+    ?(input, output, options);
+    <xtc-command(!"sdf2table")> ["-i", <abspath> input, "-o", <abspath> output, "-m", <get-sdf-main-module> | <conc> (options, <pass-v-verbose>)]
   <+
     <xtc-command(!"sdf2table")> ["-V"] // ensure it's available
   <+

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/build.properties
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/build.properties	2009-10-23 14:53:13 UTC (rev 20160)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/build.properties	2009-10-25 15:18:21 UTC (rev 20161)
@@ -1,7 +1,6 @@
-source.org.strategoxt.imp.metatooling/ = src/
-output.org.strategoxt.imp.metatooling/ = bin/
+source.. = src/
+output.. = bin/
 bin.includes = META-INF/,\
-               org.strategoxt.imp.metatooling/,\
                plugin.xml,\
-               bin/,\
+               .,\
                icons/

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java	2009-10-23 14:53:13 UTC (rev 20160)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java	2009-10-25 15:18:21 UTC (rev 20161)
@@ -5,6 +5,7 @@
 import java.io.File;
 import java.io.IOException;
 import java.io.PrintStream;
+import java.util.Arrays;
 
 import org.spoofax.interpreter.library.IOAgent;
 import org.spoofax.interpreter.terms.IStrategoList;
@@ -50,7 +51,7 @@
 		}
 		
 		IStrategoTerm commandTerm = command.invoke(context, args);
-		if (commandTerm.getTermType() != STRING)
+		if (commandTerm.getTermType() != STRING || true) // FIXME: call sdf2table in plugin
 			return proceed.invoke(context, args, command);
 		
 		String commandName = ((IStrategoString) commandTerm).stringValue();
@@ -64,6 +65,25 @@
 			? args
 			: null;
 	}
+	
+	/* TODO: chmod executable before use
+	private static void makeExecutable(String command) throws IOException {
+		String os = Platform.getOS();
+		if (os.equals(Platform.OS_LINUX)
+				|| os.equals(Platform.OS_MACOSX)) {
+			try {
+			    String cmdBin = binary(command);
+				Process p = Runtime.getRuntime().exec("/bin/chmod +x " + cmdBin);
+				p.waitFor();
+				if (p.exitValue() != 0) {
+				    a.getLog().log(new Status(IStatus.ERROR, Activator.PLUGIN_ID, "chmod of '" + cmdBin + "' failed: " + p.exitValue()));
+				}
+			} catch (InterruptedException e) {
+				a.getLog().log(new Status(IStatus.ERROR, Activator.PLUGIN_ID, "chmod of '" + binary(command) + "' failed: " + e.getMessage()));	
+			}
+		}
+	}
+	*/
 
 	private boolean invokeSDF2Table(Context context, String command, IStrategoTerm[] argList) throws StrategoException {
 		// HACK: concatenating all command-line arguments...
@@ -90,6 +110,8 @@
 			IOAgent io = context.getIOAgent();
 			PrintStream stdout = io.getOutputStream(IOAgent.CONST_STDOUT);
 			PrintStream stderr = io.getOutputStream(IOAgent.CONST_STDERR);
+			// DEBUG
+			System.out.println("Calling: " + Arrays.toString(commandArgs) + " " + Arrays.toString(environment) + " " + io.getWorkingDir());
 			int result = new NativeCallHelper().call(commandArgs, environment, new File(io.getWorkingDir()), stdout, stderr);
 			return result == 0;
 		} catch (IOException e) {



From L.C.L.Kats at tudelft.nl  Sun Oct 25 16:52:45 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sun, 25 Oct 2009 15:52:45 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20162 - LennartKats -
	sglr-recovery/trunk/recovery-runtime/src/sglrbridges
	sglr-recovery/trunk/recovery-runtime/src/test
	spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <200910251552.n9PFqjMW013734@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-25 15:52:45 +0000 (Sun, 25 Oct 2009)
New Revision: 20162

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20162&view=rev

Added:
   spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NoRecoveryRulesException.java
Modified:
   sglr-recovery/trunk/recovery-runtime/src/sglrbridges/BridgeRecoveryParser.java
   sglr-recovery/trunk/recovery-runtime/src/test/BaseTest.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/StandAloneSGLRI.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java
   spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/SGLR.java

Log:
Added a new NoRecoveryRulesException thrown when recovery is enabled but no recovery rules are available.

Changes:

Modified: sglr-recovery/trunk/recovery-runtime/src/sglrbridges/BridgeRecoveryParser.java
===================================================================
--- sglr-recovery/trunk/recovery-runtime/src/sglrbridges/BridgeRecoveryParser.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ sglr-recovery/trunk/recovery-runtime/src/sglrbridges/BridgeRecoveryParser.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -4,19 +4,16 @@
 import java.io.FileNotFoundException;
 import java.io.IOException;
 import java.io.InputStream;
-import java.util.Collection;
 import java.util.List;
 
-import org.bripgen.sglr.ISGLRBridgeParser;
 import org.bripgen.sglr.example.JavaSGLRBridgeParser;
-import org.briplib.recovery.RecoveryResult;
-import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.jsglr.BadTokenException;
 import org.spoofax.jsglr.IRecoveryParser;
 import org.spoofax.jsglr.IRecoveryResult;
 import org.spoofax.jsglr.InvalidParseTableException;
 import org.spoofax.jsglr.NoRecovery;
+import org.spoofax.jsglr.NoRecoveryRulesException;
 import org.spoofax.jsglr.SGLRException;
 import org.spoofax.jsglr.TokenExpectedException;
 import org.strategoxt.imp.runtime.parser.ParseErrorHandler;
@@ -37,7 +34,7 @@
 	private final IRecoveryParser bridgeParser;
 	
 	public BridgeRecoveryParser(InputStream parseTable, String startSymbol, InputStream tokenParseTable) throws IOException,
-			InvalidParseTableException {
+			NoRecoveryRulesException, InvalidParseTableException {
 		
 		super(parseTable, startSymbol);
 		

Modified: sglr-recovery/trunk/recovery-runtime/src/test/BaseTest.java
===================================================================
--- sglr-recovery/trunk/recovery-runtime/src/test/BaseTest.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ sglr-recovery/trunk/recovery-runtime/src/test/BaseTest.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -5,7 +5,6 @@
 import java.io.IOException;
 import java.io.InputStream;
 import java.io.PrintWriter;
-import java.util.Arrays;
 import java.util.HashMap;
 import java.util.LinkedList;
 
@@ -16,6 +15,7 @@
 import org.spoofax.jsglr.BackTrackRecovery2;
 import org.spoofax.jsglr.BadTokenException;
 import org.spoofax.jsglr.Measures;
+import org.spoofax.jsglr.NoRecoveryRulesException;
 import org.spoofax.jsglr.ParseTimeoutException;
 import org.spoofax.jsglr.SGLRException;
 import org.spoofax.jsglr.Tools;
@@ -78,10 +78,9 @@
 				
 				System.out.println("** warm-up ** " + file);
 				// Get AST
-				IStrategoAstNode ast = null;
 				try {
 					parser.getParser().setRecoverHandler(new BackTrackRecovery2());
-					ast = parser.parseFile(path + "/" + file);
+					parser.parseFile(path + "/" + file);
 				} catch (ParseTimeoutException e) {
 					// not handled.
 				} catch (BadTokenException e) {
@@ -93,6 +92,8 @@
 					e.printStackTrace();
 				} catch (SGLRException e) {
 					e.printStackTrace();
+				} catch (NoRecoveryRulesException e) {
+					e.printStackTrace();
 				} 
 				if (++count == (NBR_WARM_UP_RUNS-1)) {
 					System.out.println();
@@ -810,6 +811,7 @@
 	}	
 	*/
 	
+	@SuppressWarnings("unused")
 	private void printPP(IStrategoAstNode ast, String breakFile) {
 		String outputDir = outputDir();
 		if (!outputDir.endsWith("/"))

Added: spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NoRecoveryRulesException.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NoRecoveryRulesException.java	                        (rev 0)
+++ spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NoRecoveryRulesException.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -0,0 +1,17 @@
+package org.spoofax.jsglr;
+
+/**
+ * An exception thrown when recovery is enabled for a parse table with
+ * no recovery rules.
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class NoRecoveryRulesException extends InvalidParseTableException {
+
+    private static final long serialVersionUID = 442099735579027095L;
+
+    public NoRecoveryRulesException(SGLR parser) {
+        super("Parse table has no recovery rules");
+    }
+
+}

Modified: spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/SGLR.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/SGLR.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/SGLR.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -160,12 +160,12 @@
         basicInit(pf);        
     }
     
-    public void setRecoverHandler(RecoverAlgorithm recoverHandler) {
+    public void setRecoverHandler(RecoverAlgorithm recoverHandler) throws NoRecoveryRulesException {
         useIntegratedRecovery = false;
         this.recoverHandler = recoverHandler;
         recoverHandler.initialize(this);
         if (!parseTable.hasRecovers() && recoverHandler.getClass() != NoRecovery.class)
-            System.err.println("Warning: parse table has no recovery productions");
+            throw new NoRecoveryRulesException(this);
     }
     
     public RecoveryBase getRecoverHandler() {
@@ -181,7 +181,7 @@
      */
     @Deprecated
     public void setUseStructureRecovery(boolean useRoughRecovery, IRecoveryParser parser) {
-        useIntegratedRecovery =useRoughRecovery;
+        useIntegratedRecovery = useRoughRecovery;
         recoverIntegrator = new RecoveryConnector(this, parser);
     }
     
@@ -192,7 +192,7 @@
      *             with {@link StructureRecoveryAlgorithm}.
      */
     @Deprecated
-    public final void setUseStructureRecovery(boolean useRoughRecovery) {        
+    public final void setUseStructureRecovery(boolean useRoughRecovery) throws NoRecoveryRulesException {        
         setUseStructureRecovery(useRoughRecovery, null);
     }
     

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -6,6 +6,7 @@
 import org.spoofax.jsglr.BadTokenException;
 import org.spoofax.jsglr.Disambiguator;
 import org.spoofax.jsglr.NoRecovery;
+import org.spoofax.jsglr.NoRecoveryRulesException;
 import org.spoofax.jsglr.ParseTable;
 import org.spoofax.jsglr.RecoverAlgorithm;
 import org.spoofax.jsglr.SGLR;
@@ -50,7 +51,7 @@
 	/**
 	 * @see SGLR#setRecoverHandler(RecoverAlgorithm)
 	 */
-	public void setRecoverHandler(RecoverAlgorithm recoverHandler) {
+	public void setRecoverHandler(RecoverAlgorithm recoverHandler) throws NoRecoveryRulesException {
 		this.recoverHandler = recoverHandler;
 		parser.setRecoverHandler(recoverHandler);
 	}
@@ -71,7 +72,12 @@
 	 */
 	void resetState() {
 		parser = Environment.createSGLR(parseTable);
-		parser.setRecoverHandler(recoverHandler);
+		try {
+			parser.setRecoverHandler(recoverHandler);
+		} catch (NoRecoveryRulesException e) {
+			// Not expected here
+			Environment.logException("Exception when resetting parser state", e);
+		}
 		// XXX: Must run with filters enabled, when they're no longer b0rked
 		parser.getDisambiguator().setFilterPriorities(false);
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -28,6 +28,7 @@
 import org.eclipse.imp.services.ILanguageSyntaxProperties;
 import org.eclipse.jface.text.IRegion;
 import org.spoofax.jsglr.BadTokenException;
+import org.spoofax.jsglr.NoRecoveryRulesException;
 import org.spoofax.jsglr.ParseTable;
 import org.spoofax.jsglr.ParseTimeoutException;
 import org.spoofax.jsglr.SGLR;
@@ -131,7 +132,11 @@
     	ParseTable table = Environment.getParseTable(language);
 		parser = new JSGLRI(table, startSymbol, this, tokenManager);
 		parser.setKeepAmbiguities(true);
-		parser.setRecoverHandler(new StructureRecoveryAlgorithm());
+		try {
+			parser.setRecoverHandler(new StructureRecoveryAlgorithm());
+		} catch (NoRecoveryRulesException e) {
+			Environment.logException("Warning: no recovery rules available for " + language.getName());
+		}
     }
 
     public void initialize(IPath filePath, ISourceProject project,

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/StandAloneSGLRI.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/StandAloneSGLRI.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/StandAloneSGLRI.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -7,6 +7,7 @@
 import org.spoofax.jsglr.BadTokenException;
 import org.spoofax.jsglr.Disambiguator;
 import org.spoofax.jsglr.InvalidParseTableException;
+import org.spoofax.jsglr.NoRecoveryRulesException;
 import org.spoofax.jsglr.ParseTable;
 import org.spoofax.jsglr.RecoverAlgorithm;
 import org.spoofax.jsglr.SGLRException;
@@ -40,7 +41,7 @@
 		}
 	}
 	
-	public void setRecoverHandler(RecoverAlgorithm recoverHandler) {
+	public void setRecoverHandler(RecoverAlgorithm recoverHandler) throws NoRecoveryRulesException {
 		if (parser instanceof JSGLRI) {
 			((JSGLRI) parser).setRecoverHandler(recoverHandler);
 		} else {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java	2009-10-25 15:18:21 UTC (rev 20161)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java	2009-10-25 15:52:45 UTC (rev 20162)
@@ -1,6 +1,7 @@
 package org.strategoxt.imp.runtime.stratego;
 
 import java.io.IOException;
+import java.util.IdentityHashMap;
 import java.util.Map;
 import java.util.WeakHashMap;
 
@@ -10,6 +11,7 @@
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.TermConverter;
 import org.spoofax.jsglr.Disambiguator;
+import org.spoofax.jsglr.NoRecoveryRulesException;
 import org.spoofax.jsglr.ParseTable;
 import org.spoofax.jsglr.SGLRException;
 import org.spoofax.jsglr.StructureRecoveryAlgorithm;
@@ -33,6 +35,8 @@
 	private final Map<IStrategoTerm, char[]> inputCharMap = new WeakHashMap<IStrategoTerm, char[]>();
 
 	private final Map<IStrategoTerm, ATerm> inputTermMap = new WeakHashMap<IStrategoTerm, ATerm>();
+	
+	private Map<ParseTable, ParseTable> isNoRecoveryWarned = new IdentityHashMap<ParseTable, ParseTable>();
 
 	protected IMPParseStringPTPrimitive(WrappedATermFactory factory, Disambiguator filterSettings) {
 		super(factory, filterSettings);
@@ -49,7 +53,15 @@
 		
 		String path = getLastPath();		
 		JSGLRI parser = new JSGLRI(table, startSymbol);
-		parser.setRecoverHandler(new StructureRecoveryAlgorithm());
+		try {
+			parser.setRecoverHandler(new StructureRecoveryAlgorithm());
+		} catch (NoRecoveryRulesException e) {
+			if (!isNoRecoveryWarned.containsKey(table)) {
+				Environment.logException(NAME + ": warning - no recovery rules available in parse table", e);
+				// (we use an identity hash map to avoid parse table hashing)
+				isNoRecoveryWarned.put(table, table);
+			}
+		}
 		char[] inputChars = input.toCharArray();
 		
 		final ATerm asfix = parser.parseNoImplode(inputChars, path);



From L.C.L.Kats at tudelft.nl  Sun Oct 25 18:52:28 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sun, 25 Oct 2009 17:52:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20163 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util
Message-ID: <200910251752.n9PHqSRB014844@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-25 17:52:28 +0000 (Sun, 25 Oct 2009)
New Revision: 20163

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20163&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/output.str

Log:
Avoid name clash with the (indirectly imported) tool-doc package-name strategy.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/output.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/output.str	2009-10-25 15:52:45 UTC (rev 20162)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/output.str	2009-10-25 17:52:28 UTC (rev 20163)
@@ -98,14 +98,14 @@
   output-java-file =
     where(
       ?class;
-      path := <create-dirs> ["editor", "java" | <package-name>];
+      path := <create-dirs> ["editor", "java" | <to-package-name>];
       fullpath := <conc-strings> (path, "/", <class-name> class, ".java")
     );
     
     output-java-file(|fullpath)
 
   output-java-file(|filename) =
-    print-filename(|["editor", "java" | <package-name>], <base-filename> filename);
+    print-filename(|["editor", "java" | <to-package-name>], <base-filename> filename);
     
     (
       text := <pp-java-string <+ pp-java-string-fallback>
@@ -165,11 +165,11 @@
     getcwd; // return path to innermost created dir.
     where (<chdir> root)     
   
-  package-name:
+  to-package-name:
     CompilationUnit(Some(PackageDec(_, PackageName(ids))), _, _) -> xs
     where xs := <map(?Id(<id>))> ids
     
-  package-name:
+  to-package-name:
     CompilationUnit(None(), _, _) -> []
     
   class-name =



From L.C.L.Kats at tudelft.nl  Sun Oct 25 21:27:39 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sun, 25 Oct 2009 20:27:39 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20164 - LennartKats -
	in strc-java/trunk: . META-INF java
Message-ID: <200910252027.n9PKRduu016696@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-25 20:27:39 +0000 (Sun, 25 Oct 2009)
New Revision: 20164

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20164&view=rev

Modified:
   strc-java/trunk/META-INF/MANIFEST.MF
   strc-java/trunk/README
   strc-java/trunk/configure.ac
   strc-java/trunk/java/Makefile.am

Log:


Changes:

Modified: strc-java/trunk/META-INF/MANIFEST.MF
===================================================================
--- strc-java/trunk/META-INF/MANIFEST.MF	2009-10-25 17:52:28 UTC (rev 20163)
+++ strc-java/trunk/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: Stratego/XT Java runtime
 Bundle-SymbolicName: org.strategoxt.strj;singleton:=true
-Bundle-Version: 0.2.2
+Bundle-Version: 0.2.3
 Export-Package: .,
  aterm,
  aterm.pure,

Modified: strc-java/trunk/README
===================================================================
--- strc-java/trunk/README	2009-10-25 17:52:28 UTC (rev 20163)
+++ strc-java/trunk/README	2009-10-25 20:27:39 UTC (rev 20164)
@@ -71,7 +71,13 @@
 overflow problem. (When this parameter is not set and a stack overflow
 occurs, compiled applications will hint at this setting.)
 
-XTC is not supported at this time. Also see the next section.
+While the XTC standard library strategies (such as xtc-io-wrap) are
+supported, support for the XTC repository is not implemented as this
+time because of portability concerns. Any xtc-transform or xtc-call
+invocations report a warning, and simply invoke executables on the
+path. For the interest of portability, applications that make use
+of these strategies should use library strategies instead, as
+discussed in the following section.
 
 USING EXTERNAL APPLICATIONS AND LIBRARIES
 =========================================

Modified: strc-java/trunk/configure.ac
===================================================================
--- strc-java/trunk/configure.ac	2009-10-25 17:52:28 UTC (rev 20163)
+++ strc-java/trunk/configure.ac	2009-10-25 20:27:39 UTC (rev 20164)
@@ -1,5 +1,5 @@
 AC_PREREQ([2.58])
-AC_INIT([strc-java],[0.2.2],[bugs at strategoxt.org])
+AC_INIT([strc-java],[0.2.3],[bugs at strategoxt.org])
 AM_INIT_AUTOMAKE
 
 # set the prefix immediately to the default prefix

Modified: strc-java/trunk/java/Makefile.am
===================================================================
--- strc-java/trunk/java/Makefile.am	2009-10-25 17:52:28 UTC (rev 20163)
+++ strc-java/trunk/java/Makefile.am	2009-10-25 20:27:39 UTC (rev 20164)
@@ -156,7 +156,7 @@
 	cp $< $@
 
 lib/org/strategoxt/stratego_xtc/Main.java : lib/org/strategoxt/stratego-xtc.rtree ../trans/strj runtime/org/strategoxt/lang/compat/override/xtc_compat/Main.java
-	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/xtc -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_xtc -la stratego-lib -la org.strategoxt.lang.compat.override.xtc_compat -D GetInternalDefaultXtcRepository_0_0=None
+	$(STRJ) -I $(STRATEGOXT)/share -I $(STRATEGOXT)/share/xtc -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_xtc -la stratego-lib -la org.strategoxt.lang.compat.override.xtc_compat -D GetInternalDefaultXtcRepository_0_0=None -D PACKAGE_NAME_TERM='"<package name>"'
 
 lib/org/strategoxt/stratego_sglr/Main.java : $(STRATEGOXT)/share/libstratego-sglr.ctree ../trans/strj runtime/org/strategoxt/lang/compat/override/jsglr_parser/Main.java runtime/org/strategoxt/lang/compat/override/jsglr_parser_compat/Main.java
 	$(STRJ) -I $(STRATEGOXT)/share -i $< -o $@ $(STRJFLAGS) -p org.strategoxt.stratego_sglr -la stratego-lib -la stratego-xtc -la org.strategoxt.lang.compat.override.jsglr_parser -la org.strategoxt.lang.compat.override.jsglr_parser_compat



From L.C.L.Kats at tudelft.nl  Sun Oct 25 21:30:30 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sun, 25 Oct 2009 20:30:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20165 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.editorservice
	org.strategoxt.imp.editors.editorservice/META-INF
	org.strategoxt.imp.editors.sdf/META-INF
	org.strategoxt.imp.editors.stratego/META-INF
	org.strategoxt.imp.feature org.strategoxt.imp.generator/META-INF
	org.strategoxt.imp.metatooling
	org.strategoxt.imp.metatooling/META-INF
	org.strategoxt.imp.runtime/META-INF
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser
	org.strategoxt.imp.updatesite org.strategoxt.imp.updatesite/features
	org.strategoxt.imp.updatesite/plugins
Message-ID: <200910252030.n9PKUUsx016718@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-25 20:30:30 +0000 (Sun, 25 Oct 2009)
New Revision: 20165

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20165&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.3.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200910251503.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.stratego_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2802.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.3.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/sdf_eclipse_installer_1.0.10.42.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/sdf_eclipse_installer_linux_x86_1.0.10.42.jar
Removed:
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2505.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2801.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.2.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.2.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.3.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200903101227.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200909031718.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200909201429.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2505.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.stratego_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2801.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2505.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2505.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2800.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.stratego_editor_0.1.0.2700.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.1.1.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.0.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.1.jar
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml
   spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/lpg.runtime_2.0.16.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.lpg.metatooling_0.1.79.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.lpg.runtime_0.1.79.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.lpg_0.1.79.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.metatooling_0.1.79.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.preferences_0.1.79.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.prefspecs_0.1.79.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.presentation_0.1.1.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.runtime_0.1.88.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.smapi_0.1.86.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.smapifier_0.1.86.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.xform_0.1.87.jar
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
New update site revision: 0.1.0.2802.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/META-INF/MANIFEST.MF	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: EditorService Plug-in
 Bundle-SymbolicName: org.strategoxt.imp.editors.editorservice; singleton:=true
-Bundle-Version: 0.1.0.2800
+Bundle-Version: 0.1.0.2802
 Bundle-Activator: org.strategoxt.imp.editors.editorservice.Activator
 Import-Package: org.osgi.framework;version="1.3.0"
 Require-Bundle: org.eclipse.core.runtime,

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml	2009-10-25 20:30:30 UTC (rev 20165)
@@ -93,7 +93,8 @@
         </target>
     
         <target name="make-permissive.helper" unless="permissive-grammar.available" depends="aux-files">
-            <java classname="org.strategoxt.permissivegrammars.make_permissive" classpath="aux/make_permissive.jar:aux/strategoxt.jar" failonerror="true">
+            <java classname="org.strategoxt.permissivegrammars.make_permissive" classpath="aux/make_permissive.jar:aux/strategoxt.jar" failonerror="true" fork="true">
+                <jvmarg line="-ss4m -server"/>
                 <arg value="-i"/>
                 <arg value="${basedir}/include/${sdfmodule}.def"/>
                 <arg value="-o"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/META-INF/MANIFEST.MF	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: SDF Editor Plug-in
 Bundle-SymbolicName: org.strategoxt.imp.editors.sdf; singleton:=true
-Bundle-Version: 0.1.0.2800
+Bundle-Version: 0.1.0.2802
 Bundle-Activator: org.strategoxt.imp.editors.sdf.Activator
 Import-Package: org.osgi.framework;version="1.3.0"
 Require-Bundle: org.eclipse.core.runtime,

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/META-INF/MANIFEST.MF	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: Stratego Editor Plug-in
 Bundle-SymbolicName: org.strategoxt.imp.editors.stratego; singleton:=true
-Bundle-Version: 0.1.0.2800
+Bundle-Version: 0.1.0.2802
 Bundle-Activator: org.strategoxt.imp.editors.stratego.Activator
 Import-Package: org.osgi.framework;version="1.3.0"
 Require-Bundle: org.eclipse.core.runtime,

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.1.0.2801"
+      version="0.1.0.2802"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">
@@ -32,14 +32,14 @@
          id="org.strategoxt.imp.metatooling"
          download-size="0"
          install-size="0"
-         version="0.1.0.2800"
+         version="0.1.0.2802"
          unpack="false"/>
 
    <plugin
          id="org.strategoxt.imp.runtime"
          download-size="0"
          install-size="0"
-         version="0.1.0.2800"
+         version="0.1.0.2802"
          unpack="false"/>
 
    <plugin
@@ -143,7 +143,7 @@
          id="org.strategoxt.imp.editors.editorservice"
          download-size="0"
          install-size="0"
-         version="0.1.0.2800"
+         version="0.1.0.2802"
          unpack="false"/>
 
    <plugin
@@ -192,26 +192,59 @@
          id="org.strategoxt.strj"
          download-size="0"
          install-size="0"
-         version="0.2.1"/>
+         version="0.2.3"/>
 
    <plugin
          id="org.strategoxt.imp.generator"
          download-size="0"
          install-size="0"
-         version="0.1.0.2801"/>
+         version="0.1.0.2802"/>
 
    <plugin
          id="org.strategoxt.imp.editors.sdf"
          download-size="0"
          install-size="0"
-         version="0.1.0.2800"
+         version="0.1.0.2802"
          unpack="false"/>
 
    <plugin
          id="org.strategoxt.imp.editors.stratego"
          download-size="0"
          install-size="0"
-         version="0.1.0.2800"
+         version="0.1.0.2802"
          unpack="false"/>
 
+   <plugin
+         id="sdf_eclipse_installer"
+         download-size="0"
+         install-size="0"
+         version="1.0.10.42"/>
+
+   <plugin
+         id="sdf_eclipse_installer_win32_x86"
+         os="win32"
+         arch="x86"
+         download-size="0"
+         install-size="0"
+         version="1.0.10.42"
+         fragment="true"/>
+
+   <plugin
+         id="sdf_eclipse_installer_linux_x86"
+         os="linux"
+         arch="x86"
+         download-size="0"
+         install-size="0"
+         version="1.0.10.42"
+         fragment="true"/>
+
+   <plugin
+         id="sdf_eclipse_installer_macosx_x86"
+         os="macosx"
+         arch="x86"
+         download-size="0"
+         install-size="0"
+         version="1.0.10.42"
+         fragment="true"/>
+
 </feature>

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/META-INF/MANIFEST.MF	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: Spoofax/IMP Metatooling
 Bundle-SymbolicName: org.strategoxt.imp.generator;singleton:=true
-Bundle-Version: 0.1.0.2801
+Bundle-Version: 0.1.0.2802
 Bundle-ClassPath: lib/make_permissive.jar,
  lib/sdf2imp.jar
 Require-Bundle: org.spoofax.aterm,

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/META-INF/MANIFEST.MF	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,8 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: Spoofax/IMP Metatooling
 Bundle-SymbolicName: org.strategoxt.imp.metatooling;singleton:=true
-Bundle-Version: 0.1.0.2800
-Bundle-ClassPath: org.strategoxt.imp.metatooling/
+Bundle-Version: 0.1.0.2802
 Require-Bundle: org.strategoxt.imp.runtime,
  org.strategoxt.imp.generator,
  org.eclipse.imp.runtime,

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/plugin.xml	2009-10-25 20:30:30 UTC (rev 20165)
@@ -35,5 +35,9 @@
             name="eclipse.spoofaximp.nativeprefix">
       </antProperty>
    </extension>
-   
+   <!--  TODO: something like the following:
+   <extension point="org.eclipse.ant.core.extraClasspathEntries">
+     <extraClasspathEntry library="strategoxt.jar"/>
+   </extension>
+   -->
 </plugin>

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/META-INF/MANIFEST.MF	2009-10-25 20:30:30 UTC (rev 20165)
@@ -2,7 +2,7 @@
 Bundle-ManifestVersion: 2
 Bundle-Name: Spoofax/IMP Runtime
 Bundle-SymbolicName: org.strategoxt.imp.runtime;singleton:=true
-Bundle-Version: 0.1.0.2800
+Bundle-Version: 0.1.0.2802
 Require-Bundle: org.eclipse.imp.runtime,
  org.spoofax.aterm,
  org.spoofax.jsglr,

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/JSGLRI.java	2009-10-25 20:30:30 UTC (rev 20165)
@@ -75,8 +75,7 @@
 		try {
 			parser.setRecoverHandler(recoverHandler);
 		} catch (NoRecoveryRulesException e) {
-			// Not expected here
-			Environment.logException("Exception when resetting parser state", e);
+			// Already handled/logged this error in setRecoverHandler()
 		}
 		// XXX: Must run with filters enabled, when they're no longer b0rked
 		parser.getDisambiguator().setFilterPriorities(false);

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2505.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2800.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2801.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/features/org.strategoxt.imp_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/com.ibm.wala.shrike_1.1.3.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/lpg.runtime_2.0.16.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.lpg.metatooling_0.1.79.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.lpg.runtime_0.1.79.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.lpg_0.1.79.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.metatooling_0.1.79.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.preferences_0.1.79.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.prefspecs_0.1.79.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.presentation_0.1.1.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.runtime_0.1.88.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.smapi_0.1.86.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.smapifier_0.1.86.jar
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.eclipse.imp.xform_0.1.87.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.2.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.2.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.3.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.3.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.aterm_0.2.3.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.compiler_0.3.9.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.adapter.aterm_0.3.11.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.core_0.3.13.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter.library.jsglr_0.3.9.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.interpreter_0.3.11.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200903101227.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200909031718.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200909201429.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200910251503.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.spoofax.jsglr_0.2.1.200910251503.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2505.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2800.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.editorservice_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2800.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.sdf_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.stratego_0.1.0.2800.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.stratego_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.editors.stratego_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2800.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2801.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.generator_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2505.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2800.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2505.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2800.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2802.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2802.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.stratego_editor_0.1.0.2700.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.1.1.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.0.jar
===================================================================
(Binary files differ)

Deleted: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.1.jar
===================================================================
(Binary files differ)

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.3.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.strj_0.2.3.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/sdf_eclipse_installer_1.0.10.42.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/sdf_eclipse_installer_1.0.10.42.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Added: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/sdf_eclipse_installer_linux_x86_1.0.10.42.jar
===================================================================
(Binary files differ)


Property changes on: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/sdf_eclipse_installer_linux_x86_1.0.10.42.jar
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2009-10-25 20:27:39 UTC (rev 20164)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2009-10-25 20:30:30 UTC (rev 20165)
@@ -3,17 +3,8 @@
    <description url="http://www.lclnet.nl/update/0.1.x">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.1.0.2505.jar" id="org.strategoxt.imp" version="0.1.0.2505">
+   <feature url="features/org.strategoxt.imp_0.1.0.2802.jar" id="org.strategoxt.imp" version="0.1.0.2802">
       <category name="Spoofax/IMP"/>
    </feature>
-   <feature url="features/org.strategoxt.imp_0.1.0.2700.jar" id="org.strategoxt.imp" version="0.1.0.2700">
-      <category name="Spoofax/IMP"/>
-   </feature>
-   <feature url="features/org.strategoxt.imp_0.1.0.2800.jar" id="org.strategoxt.imp" version="0.1.0.2800">
-      <category name="Spoofax/IMP"/>
-   </feature>
-   <feature url="features/org.strategoxt.imp_0.1.0.2801.jar" id="org.strategoxt.imp" version="0.1.0.2801">
-      <category name="Spoofax/IMP"/>
-   </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP"/>
 </site>



From L.C.L.Kats at tudelft.nl  Sun Oct 25 21:59:42 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Sun, 25 Oct 2009 20:59:42 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20166 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.updatesite/plugins
Message-ID: <200910252059.n9PKxg91016905@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-25 20:59:42 +0000 (Sun, 25 Oct 2009)
New Revision: 20166

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20166&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/FoldingUpdater.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2802.jar

Log:
Minor failure logging hackfix for folding failures.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/FoldingUpdater.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/FoldingUpdater.java	2009-10-25 20:30:30 UTC (rev 20165)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/FoldingUpdater.java	2009-10-25 20:59:42 UTC (rev 20166)
@@ -6,7 +6,9 @@
 import lpg.runtime.IPrsStream;
 import lpg.runtime.IToken;
 
+import org.eclipse.core.runtime.AssertionFailedException;
 import org.eclipse.imp.services.base.FolderBase;
+import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.ast.AstNode;
 import org.strategoxt.imp.runtime.parser.ast.AbstractVisitor;
 import static org.strategoxt.imp.runtime.parser.tokens.TokenKind.*;
@@ -89,7 +91,11 @@
 			if (end == -1)
 				end = lastToken.getEndOffset();
 			
-			makeAnnotation(start, end - start + 1);
+			try {
+				makeAnnotation(start, end - start + 1);
+			} catch (AssertionFailedException e) {
+				Environment.logException("Could not create a folding annotation at (" + start + "," + (end - start + 1));
+			}
 		}
 	}
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.runtime_0.1.0.2802.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Tue Oct 27 18:59:36 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 27 Oct 2009 17:59:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20176 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego
	org.strategoxt.imp.updatesite/plugins
Message-ID: <200910271759.n9RHxa8e020209@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-27 17:59:36 +0000 (Tue, 27 Oct 2009)
New Revision: 20176

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20176&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2802.jar

Log:
Disabled SDFBundleCommand initialization for now since it causes problems on the Mac.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java	2009-10-27 15:35:52 UTC (rev 20175)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/SDFBundleCommand.java	2009-10-27 17:59:36 UTC (rev 20176)
@@ -33,10 +33,12 @@
 	private String binaryPostfix;
 	
 	private void init() throws IOException {
+		/* FIXME: initialization doesn't seem to work on the mac atm
 		if (binaryPostfix != null) return;
 		Activator sdfBundle = Activator.getInstance();
 		binaryPrefix = sdfBundle.getBinaryPrefix();
 		binaryPostfix = sdfBundle.getBinaryPostfix();
+		*/
 	}
 	
 	@Override

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/plugins/org.strategoxt.imp.metatooling_0.1.0.2802.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Tue Oct 27 19:12:41 2009
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 27 Oct 2009 18:12:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20177 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.editorservice
	org.strategoxt.imp.editors.sdf org.strategoxt.imp.editors.stratego
	org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <200910271812.n9RICfa9020538@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2009-10-27 18:12:41 +0000 (Tue, 27 Oct 2009)
New Revision: 20177

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20177&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str

Log:
Added <parallel> for downloading in ant build scripts.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml	2009-10-27 17:59:36 UTC (rev 20176)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.xml	2009-10-27 18:12:41 UTC (rev 20177)
@@ -105,9 +105,11 @@
         <target name="aux-files">
             <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
-            <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            <parallel>
+                <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
+                <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
+                <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            </parallel>
         </target>
     
         <target name="pack-sdf" unless="externaldef">

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml	2009-10-27 17:59:36 UTC (rev 20176)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.xml	2009-10-27 18:12:41 UTC (rev 20177)
@@ -104,9 +104,11 @@
         <target name="aux-files">
             <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
-            <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            <parallel>
+                <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
+                <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
+                <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            </parallel>
         </target>
     
         <target name="pack-sdf" unless="externaldef">

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml	2009-10-27 17:59:36 UTC (rev 20176)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.xml	2009-10-27 18:12:41 UTC (rev 20177)
@@ -104,9 +104,11 @@
         <target name="aux-files">
             <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
-            <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            <parallel>
+                <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
+                <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
+                <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            </parallel>
         </target>
     
         <target name="pack-sdf" unless="externaldef">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	2009-10-27 17:59:36 UTC (rev 20176)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	2009-10-27 18:12:41 UTC (rev 20177)
@@ -122,9 +122,11 @@
         <target name="aux-files">
             <property name="site" value="http://www.st.ewi.tudelft.nl/~kats/strategoxt/18b"/>
             <mkdir dir="aux"/>
-            <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
-            <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            <parallel>
+              <get src="${site}/strategoxt.jar" dest="aux/strategoxt.jar" usetimestamp="true" ignoreerrors="true"/>
+              <get src="${site}/make_permissive.jar" dest="aux/make_permissive.jar" usetimestamp="true" ignoreerrors="true"/>
+              <get src="${site}/sdf2imp.jar" dest="aux/sdf2imp.jar" usetimestamp="true" ignoreerrors="true"/>
+            </parallel>
         </target>
     
         <target name="pack-sdf" unless="externaldef">



From R.B.Vermaas at tudelft.nl  Wed Oct 28 22:48:19 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 28 Oct 2009 21:48:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20181 - rob -
	cygwin-macosx-bin
Message-ID: <200910282148.n9SLmJHw008793@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-28 21:48:19 +0000 (Wed, 28 Oct 2009)
New Revision: 20181

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20181&view=rev

Modified:
   cygwin-macosx-bin/configure.ac

Log:
version updates

Changes:

Modified: cygwin-macosx-bin/configure.ac
===================================================================
--- cygwin-macosx-bin/configure.ac	2009-10-28 10:59:29 UTC (rev 20180)
+++ cygwin-macosx-bin/configure.ac	2009-10-28 21:48:19 UTC (rev 20181)
@@ -2,12 +2,12 @@
 
 ### Versions
 
-AC_SUBST([ATERM_VERSION],["2.4.2"])
-AC_SUBST([SDF_VERSION],["2.3.4pre14396"])
-AC_SUBST([STRATEGOXT_VERSION],["0.17M1pre15115"])
-AC_SUBST([STRATEGOXT_UTILS_VERSION],["0.16M1"])
-AC_SUBST([JAVA_FRONT_VERSION],["0.8pre13292"])
-AC_SUBST([STRATEGO_SHELL_VERSION],["0.6pre13284"])
+AC_SUBST([ATERM_VERSION],["2.5"])
+AC_SUBST([SDF_VERSION],["2.4"])
+AC_SUBST([STRATEGOXT_VERSION],["0.17"])
+AC_SUBST([STRATEGOXT_UTILS_VERSION],["0.17"])
+AC_SUBST([JAVA_FRONT_VERSION],["0.9"])
+AC_SUBST([STRATEGO_SHELL_VERSION],["0.7"])
 
 ### Prefixes
 
@@ -21,7 +21,7 @@
 ### System info
 
 AC_SUBST([WINDOWS_VERSION],["Microsoft Windows XP"])
-AC_SUBST([CYGWIN_VERSION],["Cygwin DLL 1.5.16"])
+AC_SUBST([CYGWIN_VERSION],["Cygwin DLL 1.5.25"])
 
 AC_SUBST([MAC_VERSION],["Mac OS X 10.3.9"])
 AC_SUBST([MAC_KERNEL_VERSION],["Darwin 7.9.0"])



From R.B.Vermaas at tudelft.nl  Wed Oct 28 22:50:04 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 28 Oct 2009 21:50:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20182 - rob -
	cygwin-macosx-bin/scripts
Message-ID: <200910282150.n9SLo4Dt008824@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-28 21:50:04 +0000 (Wed, 28 Oct 2009)
New Revision: 20182

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20182&view=rev

Modified:
   cygwin-macosx-bin/scripts/make-all-cygwin.sh

Log:
add stack related CFLAGS

Changes:

Modified: cygwin-macosx-bin/scripts/make-all-cygwin.sh
===================================================================
--- cygwin-macosx-bin/scripts/make-all-cygwin.sh	2009-10-28 21:48:19 UTC (rev 20181)
+++ cygwin-macosx-bin/scripts/make-all-cygwin.sh	2009-10-28 21:50:04 UTC (rev 20182)
@@ -1,6 +1,7 @@
 #! /bin/sh
+export CFLAGS="-O2 -Wl,--stack=0x2300000"
 
 sh ./install-aterm.sh || exit 1
 sh ./install-sdf2-bundle.sh || exit 1
-# sh ./install-strategoxt.sh || exit 1
+sh ./install-strategoxt.sh || exit 1
 sh ./make-dist.sh cygwin || exit 1



From R.B.Vermaas at tudelft.nl  Thu Oct 29 12:35:49 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 11:35:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20183 - rob -
	xdoc/trunk/src/xdoc/tools/asfix
Message-ID: <200910291135.n9TBZnqr020279@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 11:35:49 +0000 (Thu, 29 Oct 2009)
New Revision: 20183

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20183&view=rev

Modified:
   xdoc/trunk/src/xdoc/tools/asfix/asfix-extra.str

Log:
keywords weren't highlighted anymore

Changes:

Modified: xdoc/trunk/src/xdoc/tools/asfix/asfix-extra.str
===================================================================
--- xdoc/trunk/src/xdoc/tools/asfix/asfix-extra.str	2009-10-28 21:50:04 UTC (rev 20182)
+++ xdoc/trunk/src/xdoc/tools/asfix/asfix-extra.str	2009-10-29 11:35:49 UTC (rev 20183)
@@ -26,7 +26,7 @@
       + asfix-layout
       + asfix-meta-var 
       )
-    , try(lit(span(|"keyword")))
+    , try(  ?appl(prod(_,lit(_),_), _) ; appl(prod(id,id,id),span(|"keyword")) )
     ) 
 
   make-info =



From R.B.Vermaas at tudelft.nl  Thu Oct 29 14:37:32 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 13:37:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20184 - rob -
	xdoc/trunk/src/xdoc/tools/analysis
Message-ID: <200910291337.n9TDbWMs022037@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 13:37:31 +0000 (Thu, 29 Oct 2009)
New Revision: 20184

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20184&view=rev

Modified:
   xdoc/trunk/src/xdoc/tools/analysis/stratego-match.str

Log:
 * fix import links

Changes:

Modified: xdoc/trunk/src/xdoc/tools/analysis/stratego-match.str
===================================================================
--- xdoc/trunk/src/xdoc/tools/analysis/stratego-match.str	2009-10-29 11:35:49 UTC (rev 20183)
+++ xdoc/trunk/src/xdoc/tools/analysis/stratego-match.str	2009-10-29 13:37:31 UTC (rev 20184)
@@ -14,10 +14,26 @@
 
   stratego-match =
     where(generate-import-rules)
+  ; alltd-xdoc(do-package)
   ; topdown-xdoc(try(use + do-module))
 
+  do-package =
+    where(
+     ?SourceFile(fn,"Stratego", _, <id>)
+    ; where( pkgname := <dirname>fn )
+    ; map({def, modname, qmodname:
+        try(
+  	?def
+        ; is-definition(|"Module")
+        ; modname := <get-definition-name>def
+        ; qmodname := <concat-strings>[pkgname, "/", modname]
+        ; rules( module-definition : qmodname -> def )
+        )
+      })
+    )
+  
   do-module = 
-    is-definition(|"Module") => def 
+    is-definition(|"Module") => def
   ; get-definition-name => n 
   ; packimports 
   ; mapconcat(module-to-xdocinfo ; get-definitions-from-definition <+![]) => defs
@@ -29,7 +45,7 @@
       where 
       ( c-2-sorts(|tp) 
       ; where(<remove-dr-prefix>n => rn ) 
-      ; filter(\ sort -> <get-definitions(|sort)>(rn,np) \) 
+      ; filter(\ sort -> <get-module-definitions(|sort) <+ get-definitions(|sort)>(rn,np) \) 
       ; concat
       <+ ![] ) => ls
 
@@ -47,6 +63,12 @@
   ; visible-definitions 
   ; filter({ nn: Definition(?n,?cn,<eq>(<map(Snd)>,np),id,id,id,id,id,?area,id);!(cn,area) }) 
 
+  get-module-definitions(|s) =
+    ?(cn,np)
+  ; !"Module" => s
+  ; <module-definition;![(cn,<?Definition(_,_,_,_,_,_,_,_,<id>,_)>)]>cn 
+
+  
 strategies
 
   qualify-name = 



From R.B.Vermaas at tudelft.nl  Thu Oct 29 15:07:41 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 14:07:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20185 - rob - hydra
Message-ID: <200910291407.n9TE7fj7022519@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 14:07:41 +0000 (Thu, 29 Oct 2009)
New Revision: 20185

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20185&view=rev

Modified:
   hydra/build.nix

Log:
add flags for stratego, sdf and stats

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-29 13:37:31 UTC (rev 20184)
+++ hydra/build.nix	2009-10-29 14:07:41 UTC (rev 20185)
@@ -110,8 +110,77 @@
     includeSrc ? true,
     contactEmail ? "",
     version ? null,
+    stratego ? true,
+    sdf ? true,
+    stats ? false,
     subdirSrc ? ""}:
 
+    let cfg = pkgs.lib.writeText "xdoc.conf" ''
+group all {
+
+  visualizations {
+    api {
+    ${if stats then ''
+      global  = stats
+      package = stats
+      module  = stats
+    '' else '''' }
+    }
+  }
+
+  group StrategoXT {
+    packagesystem = directory
+    
+    ${if stratego then ''
+    Stratego {
+      packagesystem = source
+
+      extensions   = str, cr, r
+      2xdoc        = stratego2xdoc
+      match        = stratego-match
+      pretty-print = Stratego-pretty.pp.af
+      parse-table  = Stratego.tbl
+      kinds        = Module, Constructor, Overlay, Strategy, Rule, DynamicRule
+
+      constructors {
+        highlight       = Str, Char
+        meta-transition = ToTerm, ToStrategy, ToMetaExpr, ToMetaListExpr
+        definitions     = SDef, SDefNoArgs, SDefT, RDef, RDefNoArgs, RDefT, OpDecl
+                        , Rules, Strategies, Module, Overlays, Overlay, OverlayNoArgs
+        uses            = Call, CallT, CallNoArgs, Op, Import, ImportWildcard
+      }
+
+      sorts {
+        comment = LongCom, ShortCom, StrategoLongCom, StrategoShortCom
+      }
+    }
+    '' else '''' }
+
+    ${if sdf then ''
+    SDF {
+      packagesystem = source
+
+      extensions   = sdf
+      2xdoc        = sdf2xdoc
+      match        = sdf-match
+      pretty-print = Sdf2.pp.af
+      parse-table  = Sdf2.tbl
+      kinds        = Module, Production
+
+      constructors {
+        definitions     = module, prod
+        uses            = sort, parameterized, unparameterized
+      }
+
+    }
+    '' else '''' }
+
+  }
+
+}
+
+    '' ;
+    in
     pkgsDefault.stdenv.mkDerivation rec {
       name = packageName + "-docs" ;
       src = checkout;



From R.B.Vermaas at tudelft.nl  Thu Oct 29 15:08:25 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 14:08:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20186 - rob - hydra
Message-ID: <200910291408.n9TE8PoC022528@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 14:08:25 +0000 (Thu, 29 Oct 2009)
New Revision: 20186

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20186&view=rev

Modified:
   hydra/build.nix

Log:
add flags for stratego, sdf and stats

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-29 14:07:41 UTC (rev 20185)
+++ hydra/build.nix	2009-10-29 14:08:25 UTC (rev 20186)
@@ -191,6 +191,7 @@
           (if apiDocs then " --api " else "")
         + (if codeBrowser then " --code " else "")
         + (pkgsDefault.lib.concatMapStrings (dir : " -I ${dir}  ") xdocIncludes)
+        + " --config ${cfg} "
         + (if includeSrc then " -I ${packageName} " else "");
 
       autoconfPhase = '' 



From R.B.Vermaas at tudelft.nl  Thu Oct 29 15:11:20 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 14:11:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20187 - rob - hydra
Message-ID: <200910291411.n9TEBK7c022562@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 14:11:20 +0000 (Thu, 29 Oct 2009)
New Revision: 20187

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20187&view=rev

Modified:
   hydra/build.nix

Log:
typo

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-29 14:08:25 UTC (rev 20186)
+++ hydra/build.nix	2009-10-29 14:11:20 UTC (rev 20187)
@@ -115,7 +115,7 @@
     stats ? false,
     subdirSrc ? ""}:
 
-    let cfg = pkgs.lib.writeText "xdoc.conf" ''
+    let cfg = pkgsDefault.lib.writeText "xdoc.conf" ''
 group all {
 
   visualizations {



From R.B.Vermaas at tudelft.nl  Thu Oct 29 15:12:57 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 14:12:57 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20188 - rob - hydra
Message-ID: <200910291412.n9TECvSS022569@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 14:12:56 +0000 (Thu, 29 Oct 2009)
New Revision: 20188

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20188&view=rev

Modified:
   hydra/build.nix

Log:
typo

Changes:

Modified: hydra/build.nix
===================================================================
--- hydra/build.nix	2009-10-29 14:11:20 UTC (rev 20187)
+++ hydra/build.nix	2009-10-29 14:12:56 UTC (rev 20188)
@@ -115,7 +115,7 @@
     stats ? false,
     subdirSrc ? ""}:
 
-    let cfg = pkgsDefault.lib.writeText "xdoc.conf" ''
+    let cfg = pkgsDefault.writeText "xdoc.conf" ''
 group all {
 
   visualizations {



From R.B.Vermaas at tudelft.nl  Thu Oct 29 19:04:29 2009
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Thu, 29 Oct 2009 18:04:29 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20189 - rob -
	strategoxt/trunk/strc-core/lib/stratego/strc/opt
Message-ID: <200910291804.n9TI4TZW025710@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2009-10-29 18:04:29 +0000 (Thu, 29 Oct 2009)
New Revision: 20189

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20189&view=rev

Modified:
   strategoxt/trunk/strc-core/lib/stratego/strc/opt/idfail-laws.str

Log:
STR-722 add rule for fail < s1 + s2 -> s2

Changes:

Modified: strategoxt/trunk/strc-core/lib/stratego/strc/opt/idfail-laws.str
===================================================================
--- strategoxt/trunk/strc-core/lib/stratego/strc/opt/idfail-laws.str	2009-10-29 14:12:56 UTC (rev 20188)
+++ strategoxt/trunk/strc-core/lib/stratego/strc/opt/idfail-laws.str	2009-10-29 18:04:29 UTC (rev 20189)
@@ -25,7 +25,7 @@
 
   ElimFail = 
     F1 + F2 + F3 + F5 + F6 + F7 + F8 + F10 + 
-    F11 + F12 + F13 + F14 + F15 + F16
+    F11 + F12 + F13 + F14 + F15 + F16 + F17
 
 rules
 
@@ -45,5 +45,6 @@
   F15 : Where(Fail())      -> Fail()
 
   F16 : GuardedLChoice(s1, s2, Fail()) -> Seq(s1, s2)
+  F17 : GuardedLChoice(Fail(), s1, s2) -> s2
 
   NotValid : All(Fail()) -> Fail()



