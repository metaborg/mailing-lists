From g.h.wachsmuth at tudelft.nl  Wed May  1 08:43:25 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 01 May 2013 06:43:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26073 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130501064325.A7E1F7F8057@mx1.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed May  1 06:43:23 2013
New Revision: 26073
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26073&sc=1

Log:
re-established support for anonymous scopes

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str
   spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str
   spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str	Mon Apr 29 13:39:08 2013	(r26072)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str	Wed May  1 06:43:23 2013	(r26073)
@@ -41,6 +41,7 @@
                             , MATCH(CALL("implicits__"), LIST(implicit*))
                             ] 
     ;  result   := [DEF_RULE(def-seq)]
+    <+ result   := [SCOPE_RULE(pattern, <nonempty> scope*)]
     <+ result   := []
  
   clause-to-def-seq(|pattern, scope*):
@@ -83,7 +84,30 @@
   NAME_RULE(lhs, rhs) = RDefNoArgs("nabl-get-name", RuleNoCond(lhs, rhs))
 
 overlays
-  	
+  
+  SCOPE_RULE(pattern, scopes) =
+  SDefT(
+    "nabl-anonymous-scope-site"
+  , [DefaultVarDec("child-uris__")]
+  , [ DefaultVarDec("lang__")
+    , DefaultVarDec("partition__")
+    , DefaultVarDec("uniques__")
+    , DefaultVarDec("uris__")
+    , DefaultVarDec("states__") ]
+  , Seq(
+      Match(pattern)
+    , CallT(
+        SVar("nabl-anonymous-scope")
+      , [CALL("child-uris__")]
+      , [ Var("lang__")
+        , Var("partition__")
+        , Var("uniques__")
+        , Var("uris__")
+        , LIST(scopes) ]
+      )
+    )
+  )
+  
 	DEF_RULE(body) =
   SDefT(
     "nabl-def-site"

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str	Mon Apr 29 13:39:08 2013	(r26072)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str	Wed May  1 06:43:23 2013	(r26073)
@@ -6,25 +6,61 @@
   
   generation2/util
   
-rules
+rules 
   
+  /*
+  * scope-to-term transforms NaBL scope definition into a Stratego term for consumption by the NaBL runtime
+  *
+  * NaBL input     : ... in current scope
+  * Stratego output: Current()
+  */
   scope-to-term(|i): 
     Current() -> TERM("Current")
   
+  /*
+  * scope-to-term transforms NaBL scope definition into a Stratego term for consumption by the NaBL runtime
+  *
+  * NaBL input      : ... in subsequent scope
+  * Stratego output : [Subsequent()]
+  *
+  * NaBL input      : ... in ctx1, ..., ctxn
+  * Stratego output : [scope_i]
+  *
+  * NaBL input      : ... in subsequent scope, ctx1, ..., ctxn
+  * Stratego output : [Subsequent(), scope_i]
+  *
+  * Note that the list contains only a single scope variable for ctx1, ..., ctxn. 
+  * The scope variable is shared by all definition contexts of a definition clause
+  *
+  */
   scope-to-term(|i): 
     DefScopes(ds*) -> LIST([ss*, ctx*])
     where
+      // handle "in subsequent scope"
       if <fetch-elem(?Subsequent())> ds* then
         ss* := [TERM("Subsequent")] 
       else
         ss* := []
       end
+      // handle "in ctx"
     ; if x := <fetch-elem(?Context(<id>))> ds* then 
         ctx* := [<scope-var> i]
       else
         ctx* := []
       end
    
+rules 
+  
+  /** 
+  * transforms NaBL scope definitions into assignments for scope variables
+  *  
+  * NaBL input     : ... in ctx1, ..., ctxn
+  * NaBL input     : ... in subsequent scope, ctx1, ..., ctxn
+  * Stratego output: where( scope_i := <nabl-construct-def-scope(|...)> NS ) 
+  * 
+  * Note that only a single assignment is generated. 
+  * The scope variable is shared by all definition contexts of a definition clause
+  */
   scope-to-assignments(|ns, i) =
     if DefScopes(fetch-elem(Context(id))) then
       ![SCOPE_CALL(<scope-var> i, ns)]
@@ -32,13 +68,26 @@
       ![]
     end
     
+  /**
+  * transforms NaBL scope definitions into a list of replacements
+  * a replacement consists of a term to replace and a strategy call which should replace it
+  *
+  * NaBL input  : ... in current scope
+  * NaBL input  : ... in subsequent scope
+  * no replacements
+  *
+  * NaBL input  : ... in ctx1, ..., ctxn
+  * NaBL input  : ... in subsequent scope, ctx1, ..., ctxn
+  * replacements: ctx1 replaced by nabl-scope-def(|scope_i), ..., ctxn replaced by nabl-scope-def(|scope_i)
+  */
   scope-to-replacement(|i):
-    DefScopes(ds*) -> <filter(context-to-replace(|r))> ds*
-    where
-      r  := SCOPE_CALL(<scope-var> i)
+    DefScopes(ds*) -> <filter(context-to-replace(|SCOPE_CALL(<scope-var> i)))> ds*
       
   context-to-replace(|r): Context(c) -> (c, r)
   
+  /**
+  * helper strategy to produce unique scope variables
+  */
   scope-var: i -> Var($[scope[i]__])
 
 overlays

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Mon Apr 29 13:39:08 2013	(r26072)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Wed May  1 06:43:23 2013	(r26073)
@@ -42,7 +42,7 @@
       ns-term        := <ns-to-term> ns
     ; k              := <extend-index(|i)> j
     ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
-    ; prop-term*     := <map(prop-to-str; replace-all(|repl*))> prop*
+    ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
     ; ctx-term       := <context-to-term(|repl*)> ctx
   
   context-to-term(|repl*):
@@ -55,7 +55,7 @@
     Context(disamb, ns, term, prop*, ctx) -> TERM("Context", [ns-term, name-term, LIST(prop-term*), ctx-term])
     where
       ns-term        := <ns-to-term> ns
-    ; prop-term*     := <map(prop-to-str; replace-all(|repl*))> prop*
+    ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
     ; name-term      := <replace-all(|repl*)> term
     ; ctx-term       := <context-to-term(|repl*)> ctx
     

From g.h.wachsmuth at tudelft.nl  Wed May  1 08:52:59 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 01 May 2013 06:52:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26074 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130501065259.6BBEF108C00A@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed May  1 06:52:58 2013
New Revision: 26074
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26074&sc=1

Log:
support for properties with dependencies in the generator

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str	Wed May  1 06:43:23 2013	(r26073)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str	Wed May  1 06:52:58 2013	(r26074)
@@ -32,7 +32,8 @@
     ; ns-term        := <ns-to-term> ns
     ; k              := <extend-index(|i)> j
     ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
-    ; prop-call      := PROP_CALL(<replace-all(|repl*); map(prop-to-str)> prop*)
+    ; dep*           := <map(Snd)> repl*
+    ; prop-call      := PROP_CALL(<replace-all(|repl*); map(prop-to-str(|dep*))> prop*)
     ; if impl-var := <implicit-def-var(|j)> kind then
         cong := Where(App(prop-call, impl-var))
       else
@@ -48,7 +49,7 @@
        
 rules
          
-  prop-to-str: PropertyTerm(p, t) -> PROPERTY(<nabl-to-str> p, t)     
+  prop-to-str(|dependencies): PropertyTerm(p, t) -> PROPERTY(<nabl-to-str> p, t, dependencies)     
 
   nabl-to-str: NonUnique() -> TERM("NonUnique")
   nabl-to-str: Unique()    -> TERM("Unique")
@@ -74,5 +75,5 @@
   , [Var("partition__"), LIST(ps)]
   )
   
-  PROPERTY(p, v) = TERM("Prop", [p, v])
+  PROPERTY(kind, value, dependencies) = TERM("Prop", [kind, value, LIST(dependencies)])
 

From gabrielkonat at gmail.com  Wed May  1 10:11:20 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Wed, 01 May 2013 08:11:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26075 -
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/src/main/stratego/lib
Message-ID: <20130501081120.D3399108C00A@mx3.tudelft.nl>

Author: gkonat
Date: Wed May  1 08:11:19 2013
New Revision: 26075
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26075&sc=1

Log:
Removed old index libraries

Deleted:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/src/main/stratego/lib/

From gabrielkonat at gmail.com  Wed May  1 11:48:26 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Wed, 01 May 2013 09:48:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26076 - hydra/jobs
Message-ID: <20130501094826.234A07F8083@mx1.tudelft.nl>

Author: gkonat
Date: Wed May  1 09:48:19 2013
New Revision: 26076
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26076&sc=1

Log:
Fix shasums

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Wed May  1 08:11:19 2013	(r26075)
+++ hydra/jobs/spoofax-imp.nix	Wed May  1 09:48:19 2013	(r26076)
@@ -32,12 +32,12 @@
 
   guava = pkgs.fetchurl {
     url = http://search.maven.org/remotecontent?filepath=com/google/guava/guava/14.0.1/guava-14.0.1.jar;
-    sha256 = "69e12f4c6aeac392555f1ea86fab82b5e5e31ad4";
+    sha256 = "d69df3331840605ef0e5fe4add60f2d28e870e3820937ea29f713d2035d9ab97";
   };
 
   junit-benchmarks = pkgs.fetchurl {
     url = http://labs.carrotsearch.com/download/junit-benchmarks/0.6.0/junit-benchmarks-0.6.0.zip;
-    sha256 = "7d23728aeeca7adcc049035e9ac57a8e49e084de";
+    sha256 = "07f189bd06e4294b329b4e3b0c7f54ce8236bba0393991a212a94cbb39ecd5b1";
   };
 
   eclipseFun = import ../eclipse.nix pkgs ; 

From g.h.wachsmuth at tudelft.nl  Wed May  1 13:53:34 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 01 May 2013 11:53:34 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26077 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130501115335.052B72B8004@mx2.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed May  1 11:53:33 2013
New Revision: 26077
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26077&sc=1

Log:
support for imports as references

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Wed May  1 09:48:19 2013	(r26076)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Wed May  1 11:53:33 2013	(r26077)
@@ -14,6 +14,7 @@
   
   use-to-name = 
     ?RefClause(<fetch-elem(use-to-name)>)
+  + ?ImportClause(<fetch-elem(use-to-name)>)
   + ?RefClausePart(_, _, <id>, _, _, _)
   + ?SingleImport(_, _, <id>, _, _, _, _, _)
   + ?WildcardImport(_, _, Context(_, _, <id>, _, _), _, _)
@@ -27,16 +28,32 @@
     <+ result  := []
     
   clause-to-use-clauses(|pattern, bound*, repl*, i):
-    (j, RefClause(part*)) -> [clause*, cong]
+    (j, clause) -> [clause*, cong]
+    where
+    	RefClause(part*)    := clause
+    + ImportClause(part*) := clause	
     where
       k        := <extend-index(|i)> j
     ; (clause*, candidate*) 
                := <filter-with-index(part-to-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
-    ; term     := <fetch-elem(?RefClausePart(_, _, <id>, _, _, _))> part*
+    ; term     := <use-to-name> clause*
     ; use-call := USE_CALL(candidate*)
     ; cong     := <replace-all-id(|[(term, use-call)])> pattern
   
   part-to-candidate(|pattern, bound*, glob-repl*, i):
+    (j, part) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term))
+    where
+    	RefClausePart(disamb, ns, term, prop*, ctx, constr*) := part
+    + SingleImport(disamb, ns, term, prop*, ctx, _, _, constr*) := part
+    + WildcardImport(_, Context(disamb, ns, term, prop*, ctx), _, _, constr*) := part
+    where
+      ns-term        := <ns-to-term> ns
+    ; k              := <extend-index(|i)> j
+    ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
+    ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
+    ; ctx-term       := <context-to-term(|repl*)> ctx
+  
+  part-to-candidate(|pattern, bound*, glob-repl*, i):
     (j, RefClausePart(disamb, ns, term, prop*, ctx, constr*)) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term))
     where
       ns-term        := <ns-to-term> ns

From g.h.wachsmuth at tudelft.nl  Wed May  1 14:39:26 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Wed, 01 May 2013 12:39:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26078 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130501123926.256AC2B8038@mx2.tudelft.nl>

Author: GuidoWachsmuth
Date: Wed May  1 12:39:24 2013
New Revision: 26078
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26078&sc=1

Log:
fixed error in new use sites handling

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Wed May  1 11:53:33 2013	(r26077)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Wed May  1 12:39:24 2013	(r26078)
@@ -30,22 +30,22 @@
   clause-to-use-clauses(|pattern, bound*, repl*, i):
     (j, clause) -> [clause*, cong]
     where
-    	RefClause(part*)    := clause
-    + ImportClause(part*) := clause	
+      RefClause(part*)    := clause
+    + ImportClause(part*) := clause
     where
       k        := <extend-index(|i)> j
     ; (clause*, candidate*) 
                := <filter-with-index(part-to-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
-    ; term     := <use-to-name> clause*
+    ; term     := <use-to-name> clause
     ; use-call := USE_CALL(candidate*)
     ; cong     := <replace-all-id(|[(term, use-call)])> pattern
   
   part-to-candidate(|pattern, bound*, glob-repl*, i):
     (j, part) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term))
     where
-    	RefClausePart(disamb, ns, term, prop*, ctx, constr*) := part
-    + SingleImport(disamb, ns, term, prop*, ctx, _, _, constr*) := part
-    + WildcardImport(_, Context(disamb, ns, term, prop*, ctx), _, _, constr*) := part
+      RefClausePart(disamb, ns, term, prop*, ctx, constr*)                    := part
+    + SingleImport(disamb, ns, term, prop*, ctx, _, _, constr*)               := part
+    + WildcardImport(_, _, Context(disamb, ns, term, prop*, ctx), _, constr*) := part
     where
       ns-term        := <ns-to-term> ns
     ; k              := <extend-index(|i)> j
@@ -53,16 +53,7 @@
     ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
     ; ctx-term       := <context-to-term(|repl*)> ctx
   
-  part-to-candidate(|pattern, bound*, glob-repl*, i):
-    (j, RefClausePart(disamb, ns, term, prop*, ctx, constr*)) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term))
-    where
-      ns-term        := <ns-to-term> ns
-    ; k              := <extend-index(|i)> j
-    ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
-    ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
-    ; ctx-term       := <context-to-term(|repl*)> ctx
-  
-  context-to-term(|repl*):
+   context-to-term(|repl*):
   	Current() -> TERM("Current")
   	
   context-to-term(|repl*):

From v.vergu+vc at gmail.com  Thu May  2 13:29:03 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Thu, 02 May 2013 11:29:03 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26079 - hydra/jobs
Message-ID: <20130502112904.01D177F8027@mx1.tudelft.nl>

Author: VladVergu
Date: Thu May  2 11:28:55 2013
New Revision: 26079
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26079&sc=1

Log:
try to make a product of strategoxt-java-bootstrap

Modified:
   hydra/jobs/strategoxt-java-bootstrap.nix

Modified: hydra/jobs/strategoxt-java-bootstrap.nix
==============================================================================
--- hydra/jobs/strategoxt-java-bootstrap.nix	Wed May  1 12:39:24 2013	(r26078)
+++ hydra/jobs/strategoxt-java-bootstrap.nix	Thu May  2 11:28:55 2013	(r26079)
@@ -38,6 +38,9 @@
       ANT_OPTS="-Xss8m -Xmx1024m";
 
       dontInstall = true;
+      postBuild = ''
+	      echo "file jar $out/share/strategoxt/strategoxt.jar" > $out/nix-support/hydra-build-products
+	    '';
     };
 
   jobs = {

From v.vergu+vc at gmail.com  Thu May  2 15:06:51 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Thu, 02 May 2013 13:06:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26080 - hydra/jobs
Message-ID: <20130502130651.EDB832B804D@mx2.tudelft.nl>

Author: VladVergu
Date: Thu May  2 13:06:50 2013
New Revision: 26080
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26080&sc=1

Log:
Undo previous change, i.e. restore build to previous state.

Modified:
   hydra/jobs/strategoxt-java-bootstrap.nix

Modified: hydra/jobs/strategoxt-java-bootstrap.nix
==============================================================================
--- hydra/jobs/strategoxt-java-bootstrap.nix	Thu May  2 11:28:55 2013	(r26079)
+++ hydra/jobs/strategoxt-java-bootstrap.nix	Thu May  2 13:06:50 2013	(r26080)
@@ -38,9 +38,6 @@
       ANT_OPTS="-Xss8m -Xmx1024m";
 
       dontInstall = true;
-      postBuild = ''
-	      echo "file jar $out/share/strategoxt/strategoxt.jar" > $out/nix-support/hydra-build-products
-	    '';
     };
 
   jobs = {

From gabrielkonat at gmail.com  Thu May  2 16:17:57 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Thu, 02 May 2013 14:17:57 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26081 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130502141757.EEE827F8043@mx1.tudelft.nl>

Author: gkonat
Date: Thu May  2 14:17:56 2013
New Revision: 26081
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26081&sc=1

Log:
Added support for simple wildcard imports

Added:
   spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/rules.str

Added: spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Thu May  2 14:17:56 2013	(r26081)
@@ -0,0 +1,80 @@
+module generation2/import-sites
+
+imports
+	
+  libstrc
+  include/NameBindingLanguage
+  
+  generation2/util
+  generation2/sections
+  generation2/prop-sites
+  generation2/constraints
+  
+rules
+	
+  import-to-name = 
+    ?RefClause(<fetch-elem(import-to-name)>)
+  + ?ImportClause(<fetch-elem(import-to-name)>)
+  + ?SingleImport(_, _, <id>, _, _, _, _, _)
+  + ?WildcardImport(_, _, Context(_, _, <id>, _, _), _, _)
+	
+  clauses-to-import-rules(|pattern, bound*, repl*, task*, i):
+    import-clause* -> result
+    where
+       clause* := <filter-with-index(clause-to-import-rule(|pattern, bound*, repl*, i)); debug(!"Clauses: "); concat; nonempty> import-clause*
+    ;  use-seq := <to-seq> [Match(pattern), task*, clause*]
+    ;  result  := [IMPORT_RULE(use-seq)]
+    <+ result  := []
+    
+  clause-to-import-rule(|pattern, bound*, repl*, i):
+    (j, clause at ImportClause(part*)) -> [cong]
+    where
+    	debug(!"1: ")
+    ; term     := <import-to-name> clause
+    ; debug(!"2: ")
+    ; import*  := <filter-with-index(part-to-imports); concat> part*
+    ; debug(!"3: ")
+    ; import-call := IMPORT_CALL(import*)
+    ; debug(!"4: ")
+    ; cong     := <replace-all-id(|[(term, import-call)])> pattern
+    ; debug(!"5: ")
+    
+	part-to-imports:
+		(j, WildcardImport(import-part*, _, _, _, _)) -> <filter(part-to-import)> import-part*
+
+	part-to-import:
+		Direct(ns) -> IMPORT_DIRECT(<ns-to-term> ns)
+		
+	part-to-import:
+		Transitive(ns) -> IMPORT_TRANSITIVE(<ns-to-term> ns)	
+    
+overlays
+     
+  IMPORT_RULE(call) =
+  SDefT(
+    "nabl-import-site"
+  , []
+  , [ DefaultVarDec("lang__")
+    , DefaultVarDec("partition__")
+    , DefaultVarDec("uris__")
+    , DefaultVarDec("states__") 
+    ]
+  , call
+  )
+  
+  IMPORT_CALL(imports) =
+  CallT(
+    SVar("nabl-import")
+  , []
+  , [ Var("lang__")
+    , Var("partition__")
+    , Var("uris__")
+    , LIST(imports)
+    ] 
+  )
+  
+  IMPORT_DIRECT(ns) =
+  TERM("Import", [Var("lang__"), ns])
+  
+  IMPORT_TRANSITIVE(ns) =
+  TERM("Import", [Var("lang__"), TERM("Imported", [ns])])

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/rules.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/rules.str	Thu May  2 13:06:50 2013	(r26080)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/rules.str	Thu May  2 14:17:56 2013	(r26081)
@@ -10,12 +10,13 @@
   generation2/def-sites
   generation2/prop-sites
   generation2/use-sites
+  generation2/import-sites
   generation2/sections
   
 rules
   
   nabl-to-str: 
-    (i, BindingRule(pattern, constr*, clause*)) -> [name-rule*, def-rule*, prop-rule*, use-rule*, match-rule*]
+    (i, BindingRule(pattern, constr*, clause*)) -> [name-rule*, def-rule*, prop-rule*, use-rule*, import-rule*, match-rule*]
     where 
        [t]        := <filter(def-to-name <+ use-to-name)> clause*
     ;  name-rule* := [NAME_RULE(pattern, t)]
@@ -30,6 +31,6 @@
     ; (task*, repl*) := <constraints-to-tasks(|bound*, i, 0)> (constr*, [])
     ; prop-rule*     := <clauses-to-prop-rules(|pattern, bound*, repl*, task*, implicit*, i)> def-clause*
     ; use-rule*      := <clauses-to-use-rules(|pattern, bound*, repl*, task*, i)> clause*
+    ; import-rule*   := <clauses-to-import-rules(|pattern, bound*, repl*, task*, i)> clause*
     ; match-rule*    := <filter-with-index(clause-to-match-rules(|bound*, i)); concat> clause*
-    
-	
+      
\ No newline at end of file

From gabrielkonat at gmail.com  Fri May  3 10:03:50 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 03 May 2013 08:03:50 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26082 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130503080350.CF40BCC321@mx4.tudelft.nl>

Author: gkonat
Date: Fri May  3 08:03:38 2013
New Revision: 26082
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26082&sc=1

Log:
Removed debug logging

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Thu May  2 14:17:56 2013	(r26081)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Fri May  3 08:03:38 2013	(r26082)
@@ -21,7 +21,7 @@
   clauses-to-import-rules(|pattern, bound*, repl*, task*, i):
     import-clause* -> result
     where
-       clause* := <filter-with-index(clause-to-import-rule(|pattern, bound*, repl*, i)); debug(!"Clauses: "); concat; nonempty> import-clause*
+       clause* := <filter-with-index(clause-to-import-rule(|pattern, bound*, repl*, i)); concat; nonempty> import-clause*
     ;  use-seq := <to-seq> [Match(pattern), task*, clause*]
     ;  result  := [IMPORT_RULE(use-seq)]
     <+ result  := []
@@ -29,15 +29,10 @@
   clause-to-import-rule(|pattern, bound*, repl*, i):
     (j, clause at ImportClause(part*)) -> [cong]
     where
-    	debug(!"1: ")
-    ; term     := <import-to-name> clause
-    ; debug(!"2: ")
+      term     := <import-to-name> clause
     ; import*  := <filter-with-index(part-to-imports); concat> part*
-    ; debug(!"3: ")
     ; import-call := IMPORT_CALL(import*)
-    ; debug(!"4: ")
     ; cong     := <replace-all-id(|[(term, import-call)])> pattern
-    ; debug(!"5: ")
     
 	part-to-imports:
 		(j, WildcardImport(import-part*, _, _, _, _)) -> <filter(part-to-import)> import-part*

From gabrielkonat at gmail.com  Fri May  3 13:44:43 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Fri, 03 May 2013 11:44:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26083 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130503114443.CDEC32B8052@mx2.tudelft.nl>

Author: gkonat
Date: Fri May  3 11:44:41 2013
New Revision: 26083
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26083&sc=1

Log:
Fixed property constraints on use sites not working

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Fri May  3 08:03:38 2013	(r26082)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Fri May  3 11:44:41 2013	(r26083)
@@ -50,7 +50,7 @@
       ns-term        := <ns-to-term> ns
     ; k              := <extend-index(|i)> j
     ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
-    ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
+    ; prop-term*     := <map(prop-pattern-to-str(|[]); replace-all(|repl*))> prop*
     ; ctx-term       := <context-to-term(|repl*)> ctx
   
    context-to-term(|repl*):
@@ -79,6 +79,8 @@
       k     := <extend-index(|i)> j
     ; rule* := <constraints-to-match-rules(|bound*, k, 1)> constr*
 
+	prop-pattern-to-str(|dependencies): PropertyPattern(type, p, t) -> PROPERTY(<nabl-to-str> p, t, dependencies) 
+
 overlays
      
   USE_RULE(call) =

From v.vergu at gmail.com  Fri May  3 20:11:21 2013
From: v.vergu at gmail.com (Vlad Vergu)
Date: Fri, 3 May 2013 20:11:21 +0200
Subject: [Stratego-commits] migration svn -> git of spoofax, jsglr, terms,
	interpreter !!
Message-ID: <CC500A18-2B00-4562-B1B4-3E0B61D8BCD7@gmail.com>

Dear developers,


You are receiving this email because (1) i'm migrating many of Spoofax and Stratego related projects to Git, (2) i need your assistance and (3) it is likely that it concerns your current/previous work. 


For the past week or so i've been working on migrating to GitHub everything that is in the spoofax and spoofax-imp directories of the StrategoXT SVN repository. At the same time i've split the two folders up into 18 separate Git repositories each with its own history. This was/is a non-trivial endeavour requiring understanding of each project's history for the last decade and lots of regular expressions, thus very error prone. As far as I can tell all history is preserved and things appear to be complete.


My first request to you is that you carefully review the contents and histories of the resulting Git repositories (below) and report any irregularities that you discover. It is crucial that the new repositories preserve history and your feedback is therefore invaluable. Please look at code you have contributed to as well as to the rest of the codebase to check for continuity, missing files, etc. I've attached a diagram that explains how each folder from the spoofax/trunk/spoofax and spoofax-imp/trunk directories corresponds to Git repos. I kindly ask you to check these repositories by coming Tuesday and report any issues you discover, no matter how minor or major.

After i've fixed the problems that you report i will (1) make the spoofax and spoofax-imp directories read-only on SVN and (2) create new Git repositories based on the then latest revisions.

Before anything: Do not develop anything against the Git repositories mentioned below. They are temporary and only for review. After i've received all of your comments I will delete these repositories and i will make new ones based on the latest SVN revisions and according to the planning below. You can distinguish the temporary from the permanent repositories by the presence/absence of the MIG- prefix in their names.

The new (temporary) repositories are hosted on GitHub at the following addresses:

https://github.com/metaborg-testing/MIG-jsglr
https://github.com/metaborg-testing/MIG-mb-exec
https://github.com/metaborg-testing/MIG-mb-exec-deps
https://github.com/metaborg-testing/MIG-mb-rep
https://github.com/metaborg-testing/MIG-aster
https://github.com/metaborg-testing/MIG-esv
https://github.com/metaborg-testing/MIG-sdf
https://github.com/metaborg-testing/MIG-nabl
https://github.com/metaborg-testing/MIG-box
https://github.com/metaborg-testing/MIG-spx
https://github.com/metaborg-testing/MIG-spt
https://github.com/metaborg-testing/MIG-stratego
https://github.com/metaborg-testing/MIG-tdl
https://github.com/metaborg-testing/MIG-rtg
https://github.com/metaborg-testing/MIG-spoofax
https://github.com/metaborg-testing/MIG-spoofax-debug
https://github.com/metaborg-testing/MIG-spoofax-deploy
https://github.com/metaborg-testing/MIG-spoofax-imp-patches
https://github.com/metaborg-testing/MIG-spoofax-imp-archive


The final repositories will also be hosted on GitHub, under the Metaborg organisation.


There a few known issues with the new repositories:

1. Branches that could never non-destructively be merged into back into the trunk have been archived as tags. The are those SVN branches that branched on a particular directory of the trunk instead of the entire trunk. This was a standard practice in the SVN-era but it results in Git branch commits that delete everything that was not branched. The net effect of merging those back into master would be that of deleting everything else but your work. The tags that archive these branches preserve history of the branch and the branches can later be revived if necessary.

2. Some deleted branches (e.g: spoofax-new-terms) have reappeared as tags. This was intentional. If you happen to spot a previously deleted branch which is not tagged, please report it. Branch-deletion in Git is destructive and history would be lost unless we tag the deleted branches.

3. The old Spoofax editor (first version started in ~2005) is not yet migrated. This is the big red-colored repository in the diagram. This will be migrated later, separately, as one big read-only Git repository. 


To summarise, i kindly ask you to:

1. Examine and give feedback on the health of the MIG- repositories by cob of coming Tuesday. Do pay special attention to missing or corrupted files, branches, tags, history or committer-info. 

2. Avoid branching/merging in the spoofax and spoofax-imp directories. If you do so, then (1) branch the entire trunk of the respective folder (this will ensure merge-able branches) and (2) notify me. The migration is like a white-list so anything not explicitly mentioned in it does not get copied. 

3. Avoid deleting, creating or renaming folders at the spoofax/[ trunk | branches | tags ]/spoofax or spoofax-imp/[ trunk | branches | tags ] roots. If you do, please let me know. Things will not be copied over unless I explicitly mention them in the migration script. Making changes to subdirectories, such as spoofax/trunk/spoofax/foobar/, is fine. In other words, you can safely continue your work but don't start new things in the SVN repository. 


This migration has a few more steps, here's the tentative plan (depending on the problems you discover):

1. Wed 08-05 8:00 AM : make the spoofax and spoofax-imp directories on SVN read-only. At this stage you shouldn't have any uncommitted changes anymore. 
2. Wed 08-05 12:00 PM : all your reported issues should be fixed in the migration scripts.
3. Wed 08-05 1:30 PM : final Git repositories published at GitHub Metaborg organisation.
4. Wed 08-05 6:00 PM : the Hydra build-farm should have the first build results available based on the Git repositories. This means builds of the stable, master and unstable branches.
5. Thu 09-05 8:00 PM : all Spoofax update sites should be pointing/containing builds based on the Git repositories.


I'll email you again (1) if something changes in the above plan and (2) after steps 3 and 5 are completed.

Thank you for your help.


Cheers,

Vlad




-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://mailman.st.ewi.tudelft.nl/pipermail/stratego-commits/attachments/20130503/1d91821e/attachment-0002.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: migration_diagram.pdf
Type: application/pdf
Size: 166448 bytes
Desc: not available
URL: <https://mailman.st.ewi.tudelft.nl/pipermail/stratego-commits/attachments/20130503/1d91821e/attachment-0001.pdf>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://mailman.st.ewi.tudelft.nl/pipermail/stratego-commits/attachments/20130503/1d91821e/attachment-0003.html>

From v.vergu+vc at gmail.com  Sat May  4 18:34:40 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 16:34:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26084 -
	hydra/jobs/spoofax-git
Message-ID: <20130504163440.EB5017F801C@mx1.tudelft.nl>

Author: VladVergu
Date: Sat May  4 16:34:39 2013
New Revision: 26084
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26084&sc=1

Log:
Basepoint for build files for Spoofax and related projects on GitHub

Added:
   hydra/jobs/spoofax-git/
   hydra/jobs/spoofax-git/spoofax-imp.nix

Added: hydra/jobs/spoofax-git/spoofax-imp.nix
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ hydra/jobs/spoofax-git/spoofax-imp.nix	Sat May  4 16:34:39 2013	(r26084)
@@ -0,0 +1,363 @@
+{ nixpkgs ? ../../nixpkgs
+, spoofax ? { outPath = ../../spoofax ; rev = 1234; }
+, spoofaxImp ? { outPath = ../../spoofax-imp ; rev = 1234; }
+, lpgRuntime ? { outPath = ../../lpg.runtime.java ; rev = 1234; }
+, metaborgRuntime ? { outPath = ../../runtime-libraries; }
+, strategoxtJavaBackend ? ../../strategoxt-java-backend
+, hydraConfig ? { outPath = ../.; rev = 1234; }
+}:
+let 
+  max = a : b : ( if builtins.lessThan a b then b else a );
+  maxrev = xs : pkgs.lib.foldl max 0 xs ;
+  spoofaxRev = toString (maxrev [spoofax.rev spoofaxImp.rev lpgRuntime.rev]) ;
+
+  pkgs = import nixpkgs { system = "i686-linux"; };
+
+  orgEclipseImp = pkgs.fetchsvn {
+    url = http://dev.eclipse.org/svnroot/technology/org.eclipse.imp/trunk;
+    rev = 22255;
+    sha256 = "0mknky2wpqvpcaqnz1l6wh6p1p8zjmd299hlf1nnwm91paiqmm85";
+  };
+
+  jline = pkgs.fetchurl {
+    url = http://spoofax.org/mirror/extras/jline-1.0.jar;
+    sha256 = "6d35823d5ae86ea4c71bc653747d1234c1587662882a76738d2881fb409394ab";
+  };
+
+  shrike = pkgs.fetchsvn {
+    url = https://wala.svn.sourceforge.net/svnroot/wala/trunk/com.ibm.wala.shrike;
+    rev = 3073;
+    sha256 = "0y13i31xlhian5glk4cahbzxg4mky4q61qzc5g03qkg4d67k12zd";
+  };
+
+  guava = pkgs.fetchurl {
+    url = http://search.maven.org/remotecontent?filepath=com/google/guava/guava/14.0.1/guava-14.0.1.jar;
+    sha256 = "d69df3331840605ef0e5fe4add60f2d28e870e3820937ea29f713d2035d9ab97";
+  };
+
+  junit-benchmarks = pkgs.fetchurl {
+    url = http://labs.carrotsearch.com/download/junit-benchmarks/0.6.0/junit-benchmarks-0.6.0.zip;
+    sha256 = "07f189bd06e4294b329b4e3b0c7f54ce8236bba0393991a212a94cbb39ecd5b1";
+  };
+
+  eclipseFun = import ../eclipse.nix pkgs ; 
+    
+  eclipse = eclipseFun {
+    name = "eclipse-plain";
+    src =  pkgs.fetchurl {
+      url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+      sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";
+    };
+  }; 
+
+  eclipseTest = eclipseFun {
+    name = "eclipse-spoofax-install-test";
+    src =  pkgs.fetchurl {
+      url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+      sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";
+    };
+    updatesites = [ "file://${jobs.build}/site" ];
+    installIUs = [ "org.strategoxt.imp.feature.group" ];
+    dontInstall = true;
+  }; 
+
+  strcJava = (import ./strc-java.nix {
+    inherit nixpkgs hydraConfig;
+    strcJavaCheckout = strategoxtJavaBackend;
+  }).build { system = "i686-linux"; };
+    
+  jobs = with pkgs.lib; {
+    tests.install = eclipseTest;
+    src = pkgs.stdenv.mkDerivation {
+      name = "spoofax-imp-src-r${spoofaxRev}";
+
+      buildCommand = ''
+        ensureDir $out
+        cd $out
+            
+        header "Preparing org.eclipse.imp"
+    
+        for d in ${orgEclipseImp}/org.eclipse.imp.cheatsheets \
+                 ${orgEclipseImp}/org.eclipse.imp.java.hosted \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg.ide \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg.metatooling \
+                 ${orgEclipseImp}/org.eclipse.imp.metatooling \
+                 ${orgEclipseImp}/org.eclipse.imp.preferences \
+                 ${orgEclipseImp}/org.eclipse.imp.prefspecs \
+                 ${orgEclipseImp}/org.eclipse.imp.presentation \
+                 ${orgEclipseImp}/org.eclipse.imp.runtime \
+                 ${orgEclipseImp}/org.eclipse.imp.smapi \
+                 ${orgEclipseImp}/org.eclipse.imp.smapifier \
+                 ${orgEclipseImp}/org.eclipse.imp.xform \
+                 ${spoofax}/org.spoofax.aterm \
+                 ${spoofax}/org.spoofax.compiler \
+                 ${spoofax}/org.spoofax.interpreter.core \
+                 ${spoofax}/org.spoofax.interpreter \
+                 ${spoofax}/org.spoofax.interpreter.externaldeps \
+                 ${spoofax}/org.spoofax.interpreter.ui \
+                 ${spoofax}/org.spoofax.interpreter.library.jsglr \
+                 ${spoofax}/org.spoofax.interpreter.library.index \
+                 ${spoofax}/org.spoofax.interpreter.library.language \
+                 ${spoofax}/org.spoofax.interpreter.library.xml \
+                 ${spoofax}/org.spoofax.interpreter.library.interpreter \
+                 ${spoofax}/org.spoofax.interpreter.library.jline \
+                 ${spoofax}/org.spoofax.interpreter.adapter.ecj \
+                 ${spoofax}/org.spoofax.interpreter.library.eclipse \
+                 ${spoofax}/org.spoofax.interpreter.library.java \
+                 ${spoofax}/org.spoofax.jsglr \
+                 ${spoofax}/org.spoofax.terms \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.aster \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.aterm \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.editorservice \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.pp \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.rtg \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.sdf \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.template \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.spoofax \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.stratego \
+                 ${spoofaxImp}/org.strategoxt.imp.editors.spoofax.configuration \
+                 ${spoofaxImp}/org.strategoxt.imp.names \
+                 ${spoofaxImp}/org.strategoxt.imp.testing \
+                 ${spoofaxImp}/org.strategoxt.imp.testing.ui \
+                 ${spoofaxImp}/org.strategoxt.imp.feature \
+                 ${spoofaxImp}/org.strategoxt.imp.generator \
+                 ${spoofaxImp}/org.strategoxt.imp.spoofax.generator \
+                 ${spoofaxImp}/org.strategoxt.imp.metatooling \
+                 ${spoofaxImp}/org.strategoxt.imp.nativebundle \
+                 ${spoofaxImp}/org.strategoxt.imp.runtime \
+                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.main \
+                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.legacy \
+                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.latest \
+                 ${spoofaxImp}/org.strategoxt.imp.updatesite \
+                 ${spoofaxImp}/org.strategoxt.imp.debug.core \
+                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.core \
+                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.runtime \
+                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.test \
+                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.transformer \
+                 ${spoofaxImp}/org.strategoxt.imp.debug.ui \
+		  ${metaborgRuntime}/org.metaborg.runtime.task 
+        do
+          header "Copying $d"
+          cp -R $d .
+          stopNest
+        done
+
+        cp -R ${shrike} com.ibm.wala.shrike
+        cp -R ${lpgRuntime} lpg.runtime.java
+        cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
+        mv ${guava} ${spoofax}/org.spoofax.interpreter.externaldeps/lib
+        unzip ${junit-benchmarks} -d ${spoofax}/org.spoofax.interpreter.externaldeps/lib
+            
+        chmod -R +w .
+        rm -rf \
+              org.spoofax.jsglr/src/org/spoofax/jsglr/shared/RemoteParseTableService* \
+              org.spoofax.jsglr/src/org/spoofax/client/JSGLREntryPoint.java \
+              org.spoofax.jsglr/src/org/spoofax/jsglr/server/RemoteParseTableServiceImpl.java \
+              org.spoofax.terms/src/org/spoofax/gwt/
+        sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
+
+        header "Patching org.eclipse.imp using ${spoofaxImp}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
+        patch -p0 < ${spoofaxImp}/org.eclipse.imp/org.eclipse.imp.runtime.patch
+        stopNest
+                    
+        stopNest
+      '';
+    };
+
+    build = pkgs.stdenv.mkDerivation rec {
+      name = "spoofax-imp-r${spoofaxRev}";
+      inherit (jobs) src;
+          
+      buildInputs = with pkgs; [ maven3 strcJava pkgconfig which ecj openjdk apacheAntOpenJDK];
+      mvnFlags = "-Dversion=1.0.0-SNAPSHOT -DgroupId=spoofax -Dtycho.targetPlatform=${eclipse}/eclipse -Dmaven.repo.local=/tmp/m3";
+
+      M2_REPO="/tmp/m3";
+      MAVEN_OPTS="-Xss8m -Xmx1024m";
+      STRATEGOXT=pkgs.strategoPackages.strategoxt;
+      JAVA_FRONT=pkgs.strategoPackages.javafront;
+      SDF=pkgs.strategoPackages.sdf;
+
+      buildPhase = ''
+        ulimit -s unlimited
+
+        #hack
+        mkdir -p plugins
+        export eclipsefakehome=`pwd`
+            
+        mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
+
+        mkdir -p org.strategoxt.strj/java
+        cp ${strcJava}/share/strc-java/strategoxt.jar org.strategoxt.strj/java/
+
+        header "Building org.strategoxt.imp.generator"
+        make -C org.strategoxt.imp.generator all
+        stopNest
+
+        for e in */build.generated.xml
+        do
+          POM=`dirname $e`/pom.xml
+          if [[ -f $POM ]] ; then
+             sed -i 's|</project>||' $POM
+             echo '
+  <build>
+    <plugins>
+ <plugin>
+    <groupId>org.apache.maven.plugins</groupId>
+    <artifactId>maven-antrun-plugin</artifactId>
+    <dependencies>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>aster</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/aster.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>strategoxt</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.strj/java/strategoxt.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>sdf2imp</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/sdf2imp.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>make_permissive.jar</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/make_permissive.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>com.sun</groupId>
+            <artifactId>tools</artifactId>
+            <version>1.4.2</version>
+            <scope>system</scope>
+            <systemPath>''${java.home}/../lib/tools.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>ecj</groupId>
+            <artifactId>ecj</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>${pkgs.ecj}/lib/java/ecj.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>jline</groupId>
+            <artifactId>jline</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.spoofax.interpreter.library.jline/lib/jline-1.0.jar</systemPath>
+        </dependency>
+    </dependencies>
+    <executions>
+       <execution>
+               <id>generate-sources</id>
+               <phase>generate-sources</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="externaljarx" refid="maven.compile.classpath"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
+                          <property name="eclipse.home" value="${eclipse}/eclipse"/>
+                          <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+                          <ant antfile="build.main.xml" inheritRefs="true">
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+       <execution>
+               <id>process-classes</id>
+               <phase>process-classes</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
+                          <property name="eclipse.home" value="${eclipse}/eclipse"/>
+                          <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+                          <ant antfile="build.main.xml" inheritRefs="true">
+                            <target name="java.jar"/> 
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+    </executions>
+  </plugin>
+    </plugins>
+</build></project>' >>$POM
+          fi
+        done
+
+        for e in */build.ant.xml
+        do
+          POM=`dirname $e`/pom.xml
+          if [[ -f $POM ]] ; then
+             sed -i 's|</project>||' $POM
+             echo '
+  <build>
+    <plugins>
+ <plugin>
+    <groupId>org.apache.maven.plugins</groupId>
+    <artifactId>maven-antrun-plugin</artifactId>
+    <executions>
+       <execution>
+               <id>generate-sources</id>
+               <phase>generate-sources</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="strategoxt.dir" value="${STRATEGOXT}"/>
+                          <property name="sdf.dir" value="${SDF}"/>
+                          <ant antfile="build.ant.xml" inheritRefs="true">
+                              <target name="bundle-ctree" />
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+    </executions>
+  </plugin>
+    </plugins>
+</build></project>' >>$POM
+          fi
+        done
+
+        mvn package ${mvnFlags} -e
+        mvn integration-test ${mvnFlags} -e
+      '';
+          
+      installPhase = ''
+        ensureDir $out/nix-support
+        cp -Rv org.strategoxt.imp.updatesite/target/site $out/
+        touch $out/site/index.html
+        cd $out
+        tar cvzf $out/${name}.tar.gz site
+        echo "file site $out/site" >> $out/nix-support/hydra-build-products
+        echo "file tar $out/${name}.tar.gz" >> $out/nix-support/hydra-build-products
+      '';
+
+       __noChroot = true;
+       meta.maintainers = ["lclkats at gmail.com" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com" "karltk at strategoxt.org" "g.h.wachsmuth at tudelft.nl" "gabrielkonat at gmail.com" "v.vergu at gmail.com"];
+     } ;     
+  } ;
+
+in jobs

From v.vergu+vc at gmail.com  Sat May  4 18:42:24 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 16:42:24 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26085 -
	hydra/jobs/spoofax-git
Message-ID: <20130504164224.38C782B800B@mx2.tudelft.nl>

Author: VladVergu
Date: Sat May  4 16:42:23 2013
New Revision: 26085
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26085&sc=1

Log:
Renamed job file

Added:
   hydra/jobs/spoofax-git/spoofax-master.nix
      - copied, changed from r26084, hydra/jobs/spoofax-git/spoofax-imp.nix
Deleted:
   hydra/jobs/spoofax-git/spoofax-imp.nix

Copied and modified: hydra/jobs/spoofax-git/spoofax-master.nix (from r26084, hydra/jobs/spoofax-git/spoofax-imp.nix)
==============================================================================

From v.vergu+vc at gmail.com  Sat May  4 20:27:54 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 18:27:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26086 - hydra/jobs
Message-ID: <20130504182754.8578E7F806A@mx1.tudelft.nl>

Author: VladVergu
Date: Sat May  4 18:27:52 2013
New Revision: 26086
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26086&sc=1

Log:
Adding slashes after a target directory is the way to move something into that directory

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Sat May  4 16:42:23 2013	(r26085)
+++ hydra/jobs/spoofax-imp.nix	Sat May  4 18:27:52 2013	(r26086)
@@ -146,8 +146,8 @@
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
         cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
-        mv ${guava} ${spoofax}/org.spoofax.interpreter.externaldeps/lib
-        unzip ${junit-benchmarks} -d ${spoofax}/org.spoofax.interpreter.externaldeps/lib
+        mv ${guava} ${spoofax}/org.spoofax.interpreter.externaldeps/lib/
+        unzip ${junit-benchmarks} -d ${spoofax}/org.spoofax.interpreter.externaldeps/lib/
             
         chmod -R +w .
         rm -rf \

From v.vergu+vc at gmail.com  Sat May  4 20:39:56 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 18:39:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26087 - hydra/jobs
Message-ID: <20130504183956.78D5DCC284@mx4.tudelft.nl>

Author: VladVergu
Date: Sat May  4 18:39:56 2013
New Revision: 26087
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26087&sc=1

Log:
Turns out that the lib dir doesn't exist in the project. let's make it.

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Sat May  4 18:27:52 2013	(r26086)
+++ hydra/jobs/spoofax-imp.nix	Sat May  4 18:39:56 2013	(r26087)
@@ -146,6 +146,7 @@
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
         cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
+        mkdir -p ${spoofax}/org.spoofax.interpreter.externaldeps/lib
         mv ${guava} ${spoofax}/org.spoofax.interpreter.externaldeps/lib/
         unzip ${junit-benchmarks} -d ${spoofax}/org.spoofax.interpreter.externaldeps/lib/
             

From v.vergu+vc at gmail.com  Sat May  4 21:00:48 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 19:00:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26088 - hydra/jobs
Message-ID: <20130504190048.8C0E82B8002@mx2.tudelft.nl>

Author: VladVergu
Date: Sat May  4 19:00:47 2013
New Revision: 26088
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26088&sc=1

Log:
Now i get it. SVN checkouts are read-only. Actually makes sense :-).

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Sat May  4 18:39:56 2013	(r26087)
+++ hydra/jobs/spoofax-imp.nix	Sat May  4 19:00:47 2013	(r26088)
@@ -146,9 +146,9 @@
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
         cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
-        mkdir -p ${spoofax}/org.spoofax.interpreter.externaldeps/lib
-        mv ${guava} ${spoofax}/org.spoofax.interpreter.externaldeps/lib/
-        unzip ${junit-benchmarks} -d ${spoofax}/org.spoofax.interpreter.externaldeps/lib/
+        mkdir -p org.spoofax.interpreter.externaldeps/lib
+        mv ${guava} org.spoofax.interpreter.externaldeps/lib/
+        unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/
             
         chmod -R +w .
         rm -rf \

From v.vergu+vc at gmail.com  Sat May  4 23:14:18 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 21:14:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26089 - hydra/jobs
Message-ID: <20130504211418.2C13FCC2B3@mx4.tudelft.nl>

Author: VladVergu
Date: Sat May  4 21:14:16 2013
New Revision: 26089
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26089&sc=1

Log:
Ok. RTFM === git grep unzip

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Sat May  4 19:00:47 2013	(r26088)
+++ hydra/jobs/spoofax-imp.nix	Sat May  4 21:14:16 2013	(r26089)
@@ -71,6 +71,9 @@
     src = pkgs.stdenv.mkDerivation {
       name = "spoofax-imp-src-r${spoofaxRev}";
 
+
+      buildInputs = with pkgs; [ unzip ];
+
       buildCommand = ''
         ensureDir $out
         cd $out
@@ -146,6 +149,8 @@
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
         cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
+        
+        chmod +w .
         mkdir -p org.spoofax.interpreter.externaldeps/lib
         mv ${guava} org.spoofax.interpreter.externaldeps/lib/
         unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/

From v.vergu+vc at gmail.com  Sat May  4 23:25:51 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 04 May 2013 21:25:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26090 - hydra/jobs
Message-ID: <20130504212551.239DACC275@mx4.tudelft.nl>

Author: VladVergu
Date: Sat May  4 21:25:50 2013
New Revision: 26090
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26090&sc=1

Log:
Oh nooo!

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Sat May  4 21:14:16 2013	(r26089)
+++ hydra/jobs/spoofax-imp.nix	Sat May  4 21:25:50 2013	(r26090)
@@ -150,9 +150,9 @@
         cp -R ${lpgRuntime} lpg.runtime.java
         cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
         
-        chmod +w .
-        mkdir -p org.spoofax.interpreter.externaldeps/lib
-        mv ${guava} org.spoofax.interpreter.externaldeps/lib/
+        chmod -R +w .
+        ensureDir org.spoofax.interpreter.externaldeps/lib
+        cp ${guava} org.spoofax.interpreter.externaldeps/lib/
         unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/
             
         chmod -R +w .

From gabrielkonat at gmail.com  Sun May  5 10:15:49 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Sun, 05 May 2013 08:15:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26091 - hydra/jobs
Message-ID: <20130505081549.27337CC25D@mx4.tudelft.nl>

Author: gkonat
Date: Sun May  5 08:15:46 2013
New Revision: 26091
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26091&sc=1

Log:
Rename guava jar.

Modified:
   hydra/jobs/spoofax-imp.nix

Modified: hydra/jobs/spoofax-imp.nix
==============================================================================
--- hydra/jobs/spoofax-imp.nix	Sat May  4 21:25:50 2013	(r26090)
+++ hydra/jobs/spoofax-imp.nix	Sun May  5 08:15:46 2013	(r26091)
@@ -139,7 +139,7 @@
                  ${spoofaxImp}/org.strategoxt.imp.debug.stratego.test \
                  ${spoofaxImp}/org.strategoxt.imp.debug.stratego.transformer \
                  ${spoofaxImp}/org.strategoxt.imp.debug.ui \
-		  ${metaborgRuntime}/org.metaborg.runtime.task 
+		             ${metaborgRuntime}/org.metaborg.runtime.task 
         do
           header "Copying $d"
           cp -R $d .
@@ -152,7 +152,7 @@
         
         chmod -R +w .
         ensureDir org.spoofax.interpreter.externaldeps/lib
-        cp ${guava} org.spoofax.interpreter.externaldeps/lib/
+        cp ${guava} org.spoofax.interpreter.externaldeps/lib/guava.jar
         unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/
             
         chmod -R +w .

From gabrielkonat at gmail.com  Sun May  5 16:20:03 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Sun, 05 May 2013 14:20:03 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26092 - in
	spoofax/trunk/spoofax/org.spoofax.interpreter.library.index:
	. META-INF
Message-ID: <20130505142003.29CDB7F800B@mx1.tudelft.nl>

Author: gkonat
Date: Sun May  5 14:20:01 2013
New Revision: 26092
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26092&sc=1

Log:
Improve manifest file.

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/META-INF/MANIFEST.MF
   spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/build.properties

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/META-INF/MANIFEST.MF
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/META-INF/MANIFEST.MF	Sun May  5 08:15:46 2013	(r26091)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/META-INF/MANIFEST.MF	Sun May  5 14:20:01 2013	(r26092)
@@ -3,12 +3,10 @@
 Bundle-Name: org.spoofax.interpreter.library.index
 Bundle-SymbolicName: org.spoofax.interpreter.library.index
 Bundle-Version: 1.0.0.qualifier
-Bundle-RequiredExecutionEnvironment: J2SE-1.5
 Require-Bundle: org.spoofax.interpreter.core,
  org.spoofax.terms;bundle-version="1.0.0",
  org.spoofax.jsglr;bundle-version="0.3.0",
- org.junit4,
- org.spoofax.interpreter.externaldeps;bundle-version="1.0.0"
-Bundle-ClassPath: lib/junit-benchmarks-0.4.0.jar,
- .
-Export-Package: org.spoofax.interpreter.library.index
+ org.spoofax.interpreter.externaldeps,
+ org.junit4
+Bundle-ClassPath: .
+Export-Package: org.spoofax.interpreter.library.index;uses:="org.spoofax.interpreter.core,org.spoofax.interpreter.terms,org.spoofax.interpreter.library"

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/build.properties
==============================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/build.properties	Sun May  5 08:15:46 2013	(r26091)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.library.index/build.properties	Sun May  5 14:20:01 2013	(r26092)
@@ -2,5 +2,4 @@
            src/test/java
 output.. = bin/
 bin.includes = META-INF/,\
-               lib/junit-benchmarks-0.4.0.jar,\
                .

From g.h.wachsmuth at tudelft.nl  Sun May  5 17:46:03 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 15:46:03 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26093 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505154603.EDD6C7F8009@mx1.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 15:45:57 2013
New Revision: 26093
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26093&sc=1

Log:
moved helper into util.str

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/constraints.str
   spoofax-imp/branches/nbl-dev/trans/generation2/util.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/constraints.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/constraints.str	Sun May  5 14:20:01 2013	(r26092)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/constraints.str	Sun May  5 15:45:57 2013	(r26093)
@@ -61,8 +61,6 @@
   result-var: i-> Var($[r[i]__])
   match-name: i -> $["match[i]"]
   
-  extend-index(|i): j -> $[[i]-[j]]
-
   nabl-match: ("m", Var(x), [y,z]) -> x
   
 overlays

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/util.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/util.str	Sun May  5 14:20:01 2013	(r26092)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/util.str	Sun May  5 15:45:57 2013	(r26093)
@@ -8,6 +8,8 @@
 rules
 
   bound-vars = collect-all(?Var(_))  
+
+  extend-index(|i): j -> $[[i]-[j]]
  
   to-seq: [c]           -> c
   to-seq: [c1, c2 | c*] -> Seq(c1, <to-seq> [c2|c*])
@@ -38,6 +40,13 @@
      in nfilter(apply | 1)
     end
 
+  add-values(|val*):
+    (key, map) -> [(key, new*)|map]
+    where
+      old* := <lookup <+ ![]> (key, map)
+    ; new* := <union> (old*, val*) 
+             
+  
 overlays
   
   CONS_DECL(c, t) = OpDecl(c, ConstType(SortNoArgs(t)))

From g.h.wachsmuth at tudelft.nl  Sun May  5 17:48:26 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 15:48:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26094 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505154826.903DC7F8020@mx1.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 15:48:25 2013
New Revision: 26094
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26094&sc=1

Log:
unified, conceptually clean support for scopes

Added:
   spoofax-imp/branches/nbl-dev/trans/generation2/scoping-sites.str
      - copied, changed from r26073, spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str

Copied and modified: spoofax-imp/branches/nbl-dev/trans/generation2/scoping-sites.str (from r26073, spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str)
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str	Wed May  1 06:43:23 2013	(r26073, copy source)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/scoping-sites.str	Sun May  5 15:48:25 2013	(r26094)
@@ -1,111 +1,101 @@
-module generation2/scopes
+module generation2/scoping-sites
 
 imports
   libstrc
   include/NameBindingLanguage
   
   generation2/util
+  generation2/sections
+  generation2/prop-sites
   
 rules 
   
-  /*
+  binding-to-scope-rule:
+    BindingRule(pattern, constr*, clause*) -> SCOPE_RULE(pattern, seq)
+    where
+      cong* := <filter(to-scope-cong(|pattern)); concat> clause*
+    where
+       ns-term* := <filter(?ScopeClause(<map(ns-to-term)>)); concat; nonempty> clause*
+     ; <not(fetch-elem(?DefClause(Explicit(), _, _, _, _, _, _)))> clause*
+     ; anon* := [SCOPE_CALL(ns-term*)]
+    <+ anon* := []
+    where
+      seq := <nonempty; to-seq> [cong*, anon*] 
+    
+  to-scope-cong(|pattern):
+    clause -> <filter(to-scope-cong(|pattern)); concat; nonempty> part*
+    where
+      RefClause(part*)    := clause
+    + ImportClause(part*) := clause
+    
+  to-scope-cong(|pattern):
+    part -> [cong1*, cong2*]
+    where
+       DefClause(_, _, ns, term, _, into, _) := part
+     ; ns* := [ns]
+    <+ RefClausePart(_, ns, _, _, from, _) := part
+     ; ns* := [ns]
+    <+ SingleImport(_, ns, _, _, from, _, into, _) := part
+     ; ns* := [ns]
+    <+ WildcardImport(import*, _, from, into, _) := part
+     ; ns* := <map(?Direct(<id>) + ?Transitive(<id>)); make-set> import*
+    where
+       ns-term* := <map(ns-to-term)> ns*
+    where
+       repl   := (<collect-one(?RefScope(<id>))> from, SCOPE_CALL(ns-term*))
+     ; cong1* := [<replace-all-id(|[repl])> pattern]
+    <+ cong1* := []
+    where
+    	 scope* := <?DefScopes(<filter(?DefScope(<id>))>); nonempty> into
+     ; repl*  := <map(!(<id>, SCOPE_CALL(ns-term*)))> scope*
+     ; cong2* := [<replace-all-id(|repl*)> pattern]
+    <+ cong2* := []
+ 
+ /**
   * scope-to-term transforms NaBL scope definition into a Stratego term for consumption by the NaBL runtime
   *
-  * NaBL input     : ... in current scope
+  * NaBL input     : defines   ... in current scope
+  * NaBL input     : refers to ... in current scope
   * Stratego output: Current()
-  */
-  scope-to-term(|i): 
-    Current() -> TERM("Current")
-  
-  /*
-  * scope-to-term transforms NaBL scope definition into a Stratego term for consumption by the NaBL runtime
-  *
-  * NaBL input      : ... in subsequent scope
+  * 
+  * NaBL input      : defines ... in subsequent scope
   * Stratego output : [Subsequent()]
   *
-  * NaBL input      : ... in ctx1, ..., ctxn
-  * Stratego output : [scope_i]
+  * NaBL input      : defines ... in ctx1, ..., ctxn
+  * Stratego output : [DefScope(ctx1), ..., DefScope(ctxn)]
+  *
+  * NaBL input      : defines ... in subsequent scope, ctx1, ..., ctxn
+  * Stratego output : [Subsequent(), DefScope(ctx1), ..., DefScope(ctxn)]
   *
-  * NaBL input      : ... in subsequent scope, ctx1, ..., ctxn
-  * Stratego output : [Subsequent(), scope_i]
+  * NaBL input      : refers to ... in enclosing Namespace
+  * Stratego output : Enclosing(NablNsNamespace())
   *
-  * Note that the list contains only a single scope variable for ctx1, ..., ctxn. 
-  * The scope variable is shared by all definition contexts of a definition clause
+  * NaBL input      : refers to ... in ctx
+  * Stratego output : scope-i
   *
   */
-  scope-to-term(|i): 
-    DefScopes(ds*) -> LIST([ss*, ctx*])
-    where
-      // handle "in subsequent scope"
-      if <fetch-elem(?Subsequent())> ds* then
-        ss* := [TERM("Subsequent")] 
-      else
-        ss* := []
-      end
-      // handle "in ctx"
-    ; if x := <fetch-elem(?Context(<id>))> ds* then 
-        ctx* := [<scope-var> i]
-      else
-        ctx* := []
-      end
+
+  scope-to-term: Current()      -> TERM("Current")
+  scope-to-term: DefScopes(ds*) -> LIST(<map(scope-to-term)> ds*)
+  scope-to-term: Subsequent()   -> TERM("Subsequent")
+  scope-to-term: DefScope(term) -> TERM("DefScope", [term])
    
-rules 
-  
-  /** 
-  * transforms NaBL scope definitions into assignments for scope variables
-  *  
-  * NaBL input     : ... in ctx1, ..., ctxn
-  * NaBL input     : ... in subsequent scope, ctx1, ..., ctxn
-  * Stratego output: where( scope_i := <nabl-construct-def-scope(|...)> NS ) 
-  * 
-  * Note that only a single assignment is generated. 
-  * The scope variable is shared by all definition contexts of a definition clause
-  */
-  scope-to-assignments(|ns, i) =
-    if DefScopes(fetch-elem(Context(id))) then
-      ![SCOPE_CALL(<scope-var> i, ns)]
-    else
-      ![]
-    end
+  scope-to-term:
+    Enclosing(ns)  -> TERM("Enclosing", [<ns-to-term> ns])
+
+  scope-to-term:
+    RefScope(term) -> TERM("RefScope", [term])
     
-  /**
-  * transforms NaBL scope definitions into a list of replacements
-  * a replacement consists of a term to replace and a strategy call which should replace it
-  *
-  * NaBL input  : ... in current scope
-  * NaBL input  : ... in subsequent scope
-  * no replacements
-  *
-  * NaBL input  : ... in ctx1, ..., ctxn
-  * NaBL input  : ... in subsequent scope, ctx1, ..., ctxn
-  * replacements: ctx1 replaced by nabl-scope-def(|scope_i), ..., ctxn replaced by nabl-scope-def(|scope_i)
-  */
-  scope-to-replacement(|i):
-    DefScopes(ds*) -> <filter(context-to-replace(|SCOPE_CALL(<scope-var> i)))> ds*
-      
-  context-to-replace(|r): Context(c) -> (c, r)
+  scope-to-term:
+    Context(disamb, ns, term, prop*, ctx) -> TERM("Context", [ns-term, term, LIST(prop-term*), ctx-term])
+    where
+      ns-term    := <ns-to-term> ns
+    ; prop-term* := <map(prop-to-str(|[]))> prop*
+    ; ctx-term   := <scope-to-term> ctx
   
-  /**
-  * helper strategy to produce unique scope variables
-  */
-  scope-var: i -> Var($[scope[i]__])
-
 overlays
   
-  SCOPE_CALL(v) = CallT(SVar("nabl-def-scope"), [], [v])
-  SCOPE_CALL(v, ns) = 
-  Where(
-    Assign(
-      v
-    , App(
-        CallT(
-          SVar("nabl-construct-def-scope")
-        , []
-        , [Var("lang__"), Var("partition__"), Var("uniques__")]
-        )
-      , ns
-      )
-    )
-  )
+  SCOPE_RULE(pattern, body) = SDefNoArgs("nabl-scoping-site", Seq(Match(pattern), body))
+  SCOPE_CALL(ns)            = CallT(SVar("nabl-scope"), [], [LIST(ns)])
  
-     
+   

From g.h.wachsmuth at tudelft.nl  Sun May  5 17:49:09 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 15:49:09 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26095 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505154909.A9B97108C01B@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 15:49:09 2013
New Revision: 26095
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26095&sc=1

Log:
definition sites using the new handling of scopes

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str	Sun May  5 15:48:25 2013	(r26094)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/def-sites.str	Sun May  5 15:49:09 2013	(r26095)
@@ -7,9 +7,8 @@
   
   generation2/util
   generation2/main
-  generation2/scopes
-  generation2/use-sites
   generation2/sections
+  generation2/scoping-sites
   
 rules
   
@@ -17,61 +16,63 @@
     
 rules
   
-  implicit-def-vars = filter-with-index(implicit-def-var)
-    
-  implicit-def-var:
-    (i, DefClause(kind, _, _, _, _, _, _)) -> <implicit-def-var(|i)> kind
-  
-  implicit-def-var(|i): Implicit() -> Var($[i[i]__])
-  
-  def-scope(|scope*): Implicit() -> []
-  def-scope(|scope*): Explicit() -> scope*
-  
-  clauses-to-def-rules(|pattern, scope*, implicit*):
-    def-clause* -> result
+  binding-to-def-rule:
+    BindingRule(pattern, constr*, clause*) -> DEF_RULE(pattern, seq)
     where
-       clause*  := <filter-with-index(clause-to-def-seq(|pattern, scope*)); concat; nonempty> def-clause*
-    ;  m        := <length> def-clause*
-    ;  uri-cvar := <uri-child-var> m
-    ;  uri-svar := <uri-sibl-var> m
-    ;  def-seq  := <to-seq> [ Match(pattern)
-       	                    , clause*
-                            , MATCH(CALL("child-uris__"), uri-cvar)
-                            , MATCH(CALL("sibl-uris__"), uri-svar)
-                            , MATCH(CALL("implicits__"), LIST(implicit*))
-                            ] 
-    ;  result   := [DEF_RULE(def-seq)]
-    <+ result   := [SCOPE_RULE(pattern, <nonempty> scope*)]
-    <+ result   := []
- 
-  clause-to-def-seq(|pattern, scope*):
-    (o, DefClause(kind, unique, ns, term, _, scope, _)) -> [scope-assign*, def-cong*]
+      def-clause* := <filter-def-clauses; nonempty> clause*
+    ; implicit*   := <implicit-def-vars> def-clause*
+    ; ns-term*    := <filter(?ScopeClause(<map(ns-to-term)>)); concat> clause*    
+    ; cong*       := <filter-with-index(to-def-cong(|pattern, ns-term*))> def-clause*
+    ; m           := <length> def-clause*
+    ; uri-cvar    := <uri-child-var> m
+    ; uri-svar    := <uri-sibl-var> m
+    ; seq         := <to-seq> [ cong*
+                              , MATCH(CALL("child-uris__"), uri-cvar)
+                              , MATCH(CALL("sibl-uris__"), uri-svar)
+                              , MATCH(CALL("implicits__"), LIST(implicit*))
+                              ] 
+                                   
+  to-def-cong(|pattern, scope*):
+    (o, clause) -> def-cong
     where
-      ns-term       := <ns-to-term> ns
-    ; scope-assign* := <scope-to-assignments(|ns-term, o)> scope
-    ; scope-term    := <scope-to-term(|o)> scope
-    ; scope-repl*   := <scope-to-replacement(|o) <+ ![]> scope 
+      DefClause(Explicit(), unique, ns, term, _, scope, _) := clause
+    ; scope'* := scope*
+    + DefClause(Implicit(), unique, ns, term, _, scope, _) := clause
+    ; scope'* := []
+    ; impl-var := <implicit-def-var> o 
+    + SingleImport(_, ns, _, _, _, Alias(term), scope, _)  := clause
+    ; unique := Unique()
     where
-      unique-term := <nabl-to-str> unique
+      ns-term     := <ns-to-term> ns
+    ; scope-term  := <scope-to-term> scope
+    ; unique-term := <nabl-to-str> unique
     ; i           := <dec> o
     ; uri-cvar1   := <uri-child-var> i
     ; uri-cvar2   := <uri-child-var> o
     ; uri-svar1   := <uri-sibl-var> i
     ; uri-svar2   := <uri-sibl-var> o
-    ; scope'*     := <def-scope(|scope*)> kind
     ; def-call    := DEF_CALL(ns-term, unique-term, scope-term, scope'*, uri-cvar1, uri-svar1, uri-cvar2, uri-svar2)
-    ; if impl-var := <implicit-def-var(|o)> kind then
-        if <nonempty> scope-repl* then
-          scope-cong* := [<replace-all-id(|[scope-repl*])> pattern]
-        else
-          scope-cong* := []
-        end
-        ; def-cong* := [scope-cong*, Where(Assign(impl-var, App(def-call, term)))]
-      else
-        def-cong* := [<replace-all-id(|[scope-repl*, (term, def-call)])> pattern]
-      end
+    where
+       def-cong := Where(Assign(impl-var, App(def-call, term)))
+    <+ def-cong := <replace-all-id(|[(term, def-call)])> pattern
+  
+rules
+  
+  filter-def-clauses =
+    filter(
+      ?DefClause(_, _, _, _, _, _, _) 
+    + ?Import(<fetch-elem(?SingleImport(_, _, _, _, _, Alias(_), _, _))>)
+    )
+      
+  implicit-def-vars = 
+    filter-with-index(
+      ?(<implicit-def-var>, DefClause(Implicit(), _, _, _, _, _, _))
+    )
     
-rules 
+  implicit-def-var = !Var($[i-[<id>]__])
+  
+  nabl-to-str: NonUnique() -> TERM("NonUnique")
+  nabl-to-str: Unique()    -> TERM("Unique")
   
   uri-var(|kind): 0 -> Var($[uri__])
   uri-var(|kind): i -> Var($[[kind]-uri[i]__]) where not(?0)
@@ -85,30 +86,7 @@
 
 overlays
   
-  SCOPE_RULE(pattern, scopes) =
-  SDefT(
-    "nabl-anonymous-scope-site"
-  , [DefaultVarDec("child-uris__")]
-  , [ DefaultVarDec("lang__")
-    , DefaultVarDec("partition__")
-    , DefaultVarDec("uniques__")
-    , DefaultVarDec("uris__")
-    , DefaultVarDec("states__") ]
-  , Seq(
-      Match(pattern)
-    , CallT(
-        SVar("nabl-anonymous-scope")
-      , [CALL("child-uris__")]
-      , [ Var("lang__")
-        , Var("partition__")
-        , Var("uniques__")
-        , Var("uris__")
-        , LIST(scopes) ]
-      )
-    )
-  )
-  
-	DEF_RULE(body) =
+	DEF_RULE(pattern, body) =
   SDefT(
     "nabl-def-site"
   , [ DefaultVarDec("child-uris__")
@@ -120,7 +98,7 @@
     , DefaultVarDec("uniques__")
     , DefaultVarDec("uri__")
     , DefaultVarDec("states__")]
-  , body
+  , Seq(Match(pattern), body)
   )  
 	
   DEF_CALL(ns, u, ds, s, in-child-uris, in-sibl-uris, out-child-uris, out-sibl-uris) = 

From g.h.wachsmuth at tudelft.nl  Sun May  5 17:55:29 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 15:55:29 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26096 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505155529.0F87D108C009@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 15:55:28 2013
New Revision: 26096
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26096&sc=1

Log:
prop sites following the same pattern as definition sites

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str	Sun May  5 15:49:09 2013	(r26095)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/prop-sites.str	Sun May  5 15:55:28 2013	(r26096)
@@ -6,26 +6,27 @@
   include/NameBindingLanguage
   
   generation2/util
-  generation2/main
-  generation2/scopes
-  generation2/constraints
-  generation2/def-sites
   generation2/sections
+  generation2/def-sites
+  generation2/constraints
   
 rules
 
   pdebug(s) = id
   
-  clauses-to-prop-rules(|pattern, bound*, repl*, task*, implicit*, i):
-    def-clause* -> result
-    where 
-       prop-clause* := <filter-with-index(clause-to-prop-clauses(|pattern, bound*, repl*, i)); concat> def-clause*
-    ;  match*       := <![Assign(LIST(<nonempty>), Var("implicits__"))] <+ ![]> implicit*
-    ;  prop-seq     := <to-seq> [match*, task*, prop-clause*]
-    ;  result       := [PROP_RULE(Seq(Match(pattern), prop-seq))]
-    <+ result       := []
+   binding-to-prop-rule(|bound*, task*, repl*):
+    (i, BindingRule(pattern, constr*, clause*)) -> PROP_RULE(pattern, seq)
+    where
+      def-clause*    := <filter-def-clauses; nonempty> clause*
+    ; implicit*      := <implicit-def-vars> def-clause*
+    ; prop-clause*   := <filter-with-index(to-prop-clauses(|pattern, bound*, repl*, i)); concat> def-clause*
+    where
+       match* := [Assign(LIST(<nonempty> implicit*), Var("implicits__"))] 
+    <+ match* := []
+    where
+      seq := <to-seq> [match*, task*, prop-clause*]
     
-  clause-to-prop-clauses(|pattern, bound*, glob-repl*, i):
+  to-prop-clauses(|pattern, bound*, glob-repl*, i):
     (j, DefClause(kind, _, ns, term, prop*, _, constr*)) -> [task*, cong]
     where
       <nonempty> prop*
@@ -34,13 +35,12 @@
     ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
     ; dep*           := <map(Snd)> repl*
     ; prop-call      := PROP_CALL(<replace-all(|repl*); map(prop-to-str(|dep*))> prop*)
-    ; if impl-var := <implicit-def-var(|j)> kind then
-        cong := Where(App(prop-call, impl-var))
-      else
-        cong := <replace-all-id(|[(term, prop-call)])> pattern
-      end
-   
-  clause-to-match-rules(|bound*, i):
+    with
+       Implicit() := kind
+     ; cong := Where(App(prop-call, <implicit-def-var> j))
+    <+ cong := <replace-all-id(|[(term, prop-call)])> pattern
+     
+  to-match-rules(|bound*, i):
     (j, DefClause(kind, _, ns, term, prop*, _, constr*)) -> rule*
     where
       <nonempty> prop*
@@ -49,14 +49,12 @@
        
 rules
          
-  prop-to-str(|dependencies): PropertyTerm(p, t) -> PROPERTY(<nabl-to-str> p, t, dependencies)     
+  prop-to-str(|dependencies): PropertyTerm(p, t)       -> PROPERTY(<nabl-to-str> p, t, dependencies)     
+  prop-to-str(|dependencies): PropertyPattern(_, p, t) -> PROPERTY(<nabl-to-str> p, t, dependencies) 
 
-  nabl-to-str: NonUnique() -> TERM("NonUnique")
-  nabl-to-str: Unique()    -> TERM("Unique")
-  
 overlays
   
-  PROP_RULE(body)  =
+  PROP_RULE(pattern, body)  =
   SDefT(
     "nabl-prop-site"
   , []
@@ -65,7 +63,7 @@
     , DefaultVarDec("states__")
     , DefaultVarDec("implicits__")
     ]
-  , body
+  , Seq(Match(pattern), body)
   )
 
   PROP_CALL(ps) = 

From g.h.wachsmuth at tudelft.nl  Sun May  5 17:57:54 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 15:57:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26097 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505155754.D75C4CC229@mx4.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 15:57:54 2013
New Revision: 26097
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26097&sc=1

Log:
use sites follow pattern of definition sites

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Sun May  5 15:55:28 2013	(r26096)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Sun May  5 15:57:54 2013	(r26097)
@@ -7,6 +7,7 @@
   
   generation2/util
   generation2/sections
+  generation2/scoping-sites
   generation2/prop-sites
   generation2/constraints
   
@@ -19,15 +20,13 @@
   + ?SingleImport(_, _, <id>, _, _, _, _, _)
   + ?WildcardImport(_, _, Context(_, _, <id>, _, _), _, _)
     
-  clauses-to-use-rules(|pattern, bound*, repl*, task*, i):
-    use-clause* -> result
+  binding-to-use-rule(|bound*, task*, repl*):
+    (i, BindingRule(pattern, constr*, clause*)) -> USE_RULE(pattern, seq)
     where 
-       clause* := <filter-with-index(clause-to-use-clauses(|pattern, bound*, repl*, i)); concat; nonempty> use-clause*
-    ;  use-seq := <to-seq> [Match(pattern), task*, clause*]
-    ;  result  := [USE_RULE(use-seq)]
-    <+ result  := []
-    
-  clause-to-use-clauses(|pattern, bound*, repl*, i):
+      use-clause* := <filter-with-index(to-use-clauses(|pattern, bound*, repl*, i)); concat; nonempty> clause*
+    ; seq         := <to-seq> [task*, use-clause*]
+      
+  to-use-clauses(|pattern, bound*, repl*, i):
     (j, clause) -> [clause*, cong]
     where
       RefClause(part*)    := clause
@@ -35,45 +34,32 @@
     where
       k        := <extend-index(|i)> j
     ; (clause*, candidate*) 
-               := <filter-with-index(part-to-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
+               := <filter-with-index(to-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
     ; term     := <use-to-name> clause
     ; use-call := USE_CALL(candidate*)
     ; cong     := <replace-all-id(|[(term, use-call)])> pattern
   
-  part-to-candidate(|pattern, bound*, glob-repl*, i):
-    (j, part) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term))
+  to-candidate(|pattern, bound*, glob-repl*, i):
+    (j, part) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term, dep*))
     where
       RefClausePart(disamb, ns, term, prop*, ctx, constr*)                    := part
-    + SingleImport(disamb, ns, term, prop*, ctx, _, _, constr*)               := part
+    + SingleImport(disamb, ns, term, prop*, ctx, alias, _, constr*)           := part
     + WildcardImport(_, _, Context(disamb, ns, term, prop*, ctx), _, constr*) := part
     where
       ns-term        := <ns-to-term> ns
     ; k              := <extend-index(|i)> j
     ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
     ; prop-term*     := <map(prop-pattern-to-str(|[]); replace-all(|repl*))> prop*
-    ; ctx-term       := <context-to-term(|repl*)> ctx
-  
-   context-to-term(|repl*):
-  	Current() -> TERM("Current")
-  	
-  context-to-term(|repl*):
-    Enclosing(ns) -> TERM("Enclosing", [<ns-to-term> ns])
-    
-  context-to-term(|repl*):
-    Context(disamb, ns, term, prop*, ctx) -> TERM("Context", [ns-term, name-term, LIST(prop-term*), ctx-term])
-    where
-      ns-term        := <ns-to-term> ns
-    ; prop-term*     := <map(prop-to-str(|[]); replace-all(|repl*))> prop*
-    ; name-term      := <replace-all(|repl*)> term
-    ; ctx-term       := <context-to-term(|repl*)> ctx
-    
-  clause-to-match-rules(|bound*, i):
+    ; ctx-term       := <scope-to-term; replace-all(|repl*)> ctx
+    ; dep*           := <map(Snd)> repl*
+       
+  to-match-rules(|bound*, i):
     (j, RefClause(part*)) -> rule*
     where
       k      := <extend-index(|i)> j
-    ; rule*  := <map-with-index(part-to-match-rules(|bound*, k)); concat> part*
+    ; rule*  := <map-with-index(to-match-rules(|bound*, k)); concat> part*
   
-  part-to-match-rules(|bound*, i):
+  to-match-rules(|bound*, i):
     (j, RefClausePart(disamb, ns, term, prop*, scope, constr*)) -> rule*
     where
       k     := <extend-index(|i)> j
@@ -83,7 +69,7 @@
 
 overlays
      
-  USE_RULE(call) =
+  USE_RULE(pattern, body) =
   SDefT(
     "nabl-use-site"
   , []
@@ -92,7 +78,7 @@
     , DefaultVarDec("uris__")
     , DefaultVarDec("states__") 
     ]
-  , call
+  , Seq(Match(pattern), body)
   )
   
   USE_CALL(candidates) =
@@ -106,6 +92,6 @@
     ] 
   )
   
-  CANDIDATE(ns, ps, ctx) =
-  TERM("UseCandidate", [ns, LIST(ps), ctx])
+  CANDIDATE(ns, ps, ctx, deps) =
+  TERM("UseCandidate", [ns, LIST(ps), ctx, LIST(deps)])
   
\ No newline at end of file

From g.h.wachsmuth at tudelft.nl  Sun May  5 18:01:30 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 16:01:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26098 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505160130.8002C7F8009@mx1.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 16:01:30 2013
New Revision: 26098
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26098&sc=1

Log:
new driver for new style of rules

Deleted:
   spoofax-imp/branches/nbl-dev/trans/generation2/rules.str
   spoofax-imp/branches/nbl-dev/trans/generation2/scopes.str
Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/sections.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/sections.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/sections.str	Sun May  5 15:57:54 2013	(r26097)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/sections.str	Sun May  5 16:01:30 2013	(r26098)
@@ -6,7 +6,11 @@
   include/NameBindingLanguage
   
   generation2/util
-  generation2/rules
+  generation2/scoping-sites
+  generation2/def-sites
+  generation2/prop-sites
+  generation2/use-sites
+  generation2/constraints
     
 rules // namespaces 
       
@@ -40,5 +44,26 @@
 rules // binding rules
 
   nabl-to-str:
-    BindingRules(rs) -> Rules(<filter-with-index(nabl-to-str); concat; nonempty> rs)
+    BindingRules(rs) -> Rules(<filter-with-index(to-rules); concat; nonempty> rs)
+    
+  to-rules:
+    (i, rule at BindingRule(pattern, constr*, clause*)) -> [b*, d*, p*, u*, m1*, m2*]
+    where 
+       b* := [<binding-to-scope-rule> rule] 
+    <+ b* := [] 
+    where 
+       d* := [<binding-to-def-rule> rule] 
+    <+ d* := [] 
+    where
+       bound*         := <bound-vars> pattern
+     ; (task*, repl*) := <constraints-to-tasks(|bound*, i, 0)> (constr*, [])
+    where 
+       p* := [<binding-to-prop-rule(|bound*, task*, repl*)>]
+    <+ p* := []
+    where 
+       u* := [<binding-to-use-rule(|bound*, task*, repl*)>]
+    <+ u* := []
+    where
+       m1* := <constraints-to-match-rules(|bound*, i, 0)> constr*
+     ; m2* := <filter-with-index(to-match-rules(|bound*, i)); concat> clause*
     
\ No newline at end of file

From g.h.wachsmuth at tudelft.nl  Sun May  5 18:02:48 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 16:02:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26099 -
	spoofax-imp/branches/nbl-dev/syntax
Message-ID: <20130505160248.6972D7F8027@mx1.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 16:02:48 2013
New Revision: 26099
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26099&sc=1

Log:
minor abstract syntax change, same use of term scopes in imports and use sites

Modified:
   spoofax-imp/branches/nbl-dev/syntax/NaBL.tmpl
   spoofax-imp/branches/nbl-dev/syntax/NameBindingLanguage.generated.pp

Modified: spoofax-imp/branches/nbl-dev/syntax/NaBL.tmpl
==============================================================================
--- spoofax-imp/branches/nbl-dev/syntax/NaBL.tmpl	Sun May  5 16:01:30 2013	(r26098)
+++ spoofax-imp/branches/nbl-dev/syntax/NaBL.tmpl	Sun May  5 16:02:48 2013	(r26099)
@@ -102,18 +102,19 @@
   DefScopes.Current     = <current scope>
   DefScopes.DefScopes   = <<DefScope+; separator=", ">> 
   DefScope.Subsequent   = <subsequent scope>
-  DefScope.Context      = <<Term>>
+  DefScope.DefScope     = <<Term>>
  
   InRefScope.Current    = <>
   InRefScope            = <in <RefScope>>    {bracket}
   
-  FromRefScope.Current  = <>
-  FromRefScope          = <from <RefScope>>  {bracket}
+  FromRefScope.Current   = <>
+  FromRefScope           = <from <RefScope>>  {bracket}
   
   RefScope.Current    = <current scope>
   RefScope.Enclosing  = <enclosing <NamespaceRef>>
   RefScope.Context    = <<Disambiguator> <NamespaceRef> <Term> <PropertyPattern*> <InRefScope>>
-
+  RefScope.RefScope   = <<Term>>
+  
   Disambiguator.All   = <>
   Disambiguator.Best  = <best>
   

Modified: spoofax-imp/branches/nbl-dev/syntax/NameBindingLanguage.generated.pp
==============================================================================
--- spoofax-imp/branches/nbl-dev/syntax/NameBindingLanguage.generated.pp	Sun May  5 16:01:30 2013	(r26098)
+++ spoofax-imp/branches/nbl-dev/syntax/NameBindingLanguage.generated.pp	Sun May  5 16:02:48 2013	(r26099)
@@ -72,13 +72,14 @@
    DefScopes                                              -- _1,
    DefScopes.1:iter-sep                                   -- _1 KW[","],
    Subsequent                                             -- KW["subsequent"] KW["scope"],
-   Context                                                -- _1,
+   DefScope                                               -- _1,
    Current                                                -- ,
    Current                                                -- ,
    Current                                                -- KW["current"] KW["scope"],
    Enclosing                                              -- KW["enclosing"] _1,
    Context                                                -- _1 _2 _3 _4 _5,
    Context.4:iter-star                                    -- _1,
+   RefScope                                               -- _1,
    All                                                    -- ,
    Best                                                   -- KW["best"],
    COMPLETION-InDefScopes                                 -- _1,

From g.h.wachsmuth at tudelft.nl  Sun May  5 18:19:59 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Sun, 05 May 2013 16:19:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26100 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130505161959.60207CC204@mx4.tudelft.nl>

Author: GuidoWachsmuth
Date: Sun May  5 16:19:59 2013
New Revision: 26100
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26100&sc=1

Log:
integrated Gabr?el's solution for imports for now, will merge full support later today

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
   spoofax-imp/branches/nbl-dev/trans/generation2/sections.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Sun May  5 16:02:48 2013	(r26099)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Sun May  5 16:19:59 2013	(r26100)
@@ -11,28 +11,27 @@
   generation2/constraints
   
 rules
+                     
 	
   import-to-name = 
     ?RefClause(<fetch-elem(import-to-name)>)
   + ?ImportClause(<fetch-elem(import-to-name)>)
   + ?SingleImport(_, _, <id>, _, _, _, _, _)
   + ?WildcardImport(_, _, Context(_, _, <id>, _, _), _, _)
-	
-  clauses-to-import-rules(|pattern, bound*, repl*, task*, i):
-    import-clause* -> result
-    where
-       clause* := <filter-with-index(clause-to-import-rule(|pattern, bound*, repl*, i)); concat; nonempty> import-clause*
-    ;  use-seq := <to-seq> [Match(pattern), task*, clause*]
-    ;  result  := [IMPORT_RULE(use-seq)]
-    <+ result  := []
-    
-  clause-to-import-rule(|pattern, bound*, repl*, i):
-    (j, clause at ImportClause(part*)) -> [cong]
+	    
+  binding-to-import-rule(|bound*, task*, repl*):
+    (i, BindingRule(pattern, constr*, clause*)) -> IMPORT_RULE(pattern, seq)
+    where 
+      cong* := <filter-with-index(to-import-cong(|pattern, bound*, repl*, i)); nonempty> clause*
+    ; seq   := <to-seq> [task*, cong*]
+  
+  to-import-cong(|pattern, bound*, repl*, i):
+    (j, clause at ImportClause(part*)) -> cong
     where
-      term     := <import-to-name> clause
-    ; import*  := <filter-with-index(part-to-imports); concat> part*
-    ; import-call := IMPORT_CALL(import*)
-    ; cong     := <replace-all-id(|[(term, import-call)])> pattern
+      term    := <import-to-name> clause
+    ; import* := <filter-with-index(part-to-imports); concat> part*
+    ; call    := IMPORT_CALL(import*)
+    ; cong    := <replace-all-id(|[(term, call)])> pattern
     
 	part-to-imports:
 		(j, WildcardImport(import-part*, _, _, _, _)) -> <filter(part-to-import)> import-part*
@@ -45,7 +44,7 @@
     
 overlays
      
-  IMPORT_RULE(call) =
+  IMPORT_RULE(pattern, body) =
   SDefT(
     "nabl-import-site"
   , []
@@ -54,7 +53,7 @@
     , DefaultVarDec("uris__")
     , DefaultVarDec("states__") 
     ]
-  , call
+  , Seq(Match(pattern), body)
   )
   
   IMPORT_CALL(imports) =

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/sections.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/sections.str	Sun May  5 16:02:48 2013	(r26099)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/sections.str	Sun May  5 16:19:59 2013	(r26100)
@@ -10,6 +10,7 @@
   generation2/def-sites
   generation2/prop-sites
   generation2/use-sites
+  generation2/import-sites
   generation2/constraints
     
 rules // namespaces 
@@ -47,7 +48,7 @@
     BindingRules(rs) -> Rules(<filter-with-index(to-rules); concat; nonempty> rs)
     
   to-rules:
-    (i, rule at BindingRule(pattern, constr*, clause*)) -> [b*, d*, p*, u*, m1*, m2*]
+    (i, rule at BindingRule(pattern, constr*, clause*)) -> [b*, d*, p*, u*, i*, m1*, m2*]
     where 
        b* := [<binding-to-scope-rule> rule] 
     <+ b* := [] 
@@ -63,6 +64,9 @@
     where 
        u* := [<binding-to-use-rule(|bound*, task*, repl*)>]
     <+ u* := []
+    where 
+       i* := [<binding-to-import-rule(|bound*, task*, repl*)>]
+    <+ i* := []
     where
        m1* := <constraints-to-match-rules(|bound*, i, 0)> constr*
      ; m2* := <filter-with-index(to-match-rules(|bound*, i)); concat> clause*

From gabrielkonat at gmail.com  Sun May  5 20:04:16 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Sun, 05 May 2013 18:04:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26101 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <20130505180416.84B95108C009@mx3.tudelft.nl>

Author: gkonat
Date: Sun May  5 18:04:15 2013
New Revision: 26101
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26101&sc=1

Log:
Only enable task engine for new projects.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	Sun May  5 16:19:59 2013	(r26100)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-build-xml.str	Sun May  5 18:04:15 2013	(r26101)
@@ -49,6 +49,7 @@
         <property name="externaljar" value="../lib.jar"/>
         <property name="externaljarflags" value="-la org.lib"/>
         -->
+        <property name="externaljarflags" value="-la org.metaborg.runtime.task.interop"/>
     
         <!-- Environment configuration for command-line builds -->
         <condition property="build.strategoxt.sdf" value="${eclipse.spoofaximp.nativeprefix}" else="">
@@ -617,7 +618,6 @@
                 <arg line="${externaljarflags}"/>
                 <arg line="${externaldefimport}"/>
                 <arg line="-I &quot;${lib}&quot; -I &quot;${include}&quot; --cache-dir &quot;${basedir}/.cache&quot;"/>
-                <arg line="-la org.metaborg.runtime.task.interop"/>
             </java>
             <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <mkdir dir="${build}/trans"/>

From gabrielkonat at gmail.com  Mon May  6 10:22:11 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 06 May 2013 08:22:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26102 -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp
Message-ID: <20130506082211.713352B8015@mx2.tudelft.nl>

Author: gkonat
Date: Mon May  6 08:22:06 2013
New Revision: 26102
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26102&sc=1

Log:
Disable generation of runtime libraries for now.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	Sun May  5 18:04:15 2013	(r26101)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	Mon May  6 08:22:06 2013	(r26102)
@@ -158,7 +158,7 @@
     create-compilation-library;
     create-nbl-library;
     
-    create-all-runtime-libraries;
+    //create-all-runtime-libraries;
     
     create-behavior-preservation;
     create-namebinding-preservation;

From gabrielkonat at gmail.com  Mon May  6 10:25:39 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 06 May 2013 08:25:39 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26103 -
	spoofax-imp/branches/nbl-dev-working
Message-ID: <20130506082539.B18277F8044@mx1.tudelft.nl>

Author: gkonat
Date: Mon May  6 08:25:38 2013
New Revision: 26103
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26103&sc=1

Log:
Branch last working version of new NaBL generator.

Added:
   spoofax-imp/branches/nbl-dev-working/
      - copied from r26083, spoofax-imp/branches/nbl-dev/

From gabrielkonat at gmail.com  Mon May  6 12:52:59 2013
From: gabrielkonat at gmail.com (Gabriël Konat)
Date: Mon, 06 May 2013 10:52:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26104 -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <20130506105300.0903DCC1DD@mx4.tudelft.nl>

Author: gkonat
Date: Mon May  6 10:52:58 2013
New Revision: 26104
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26104&sc=1

Log:
Schedule a different background job for each project/language combination when multiple files have changed.

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisService.java

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisService.java
==============================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisService.java	Mon May  6 08:25:38 2013	(r26103)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/QueueAnalysisService.java	Mon May  6 10:52:58 2013	(r26104)
@@ -3,8 +3,12 @@
 import java.io.File;
 import java.io.FileNotFoundException;
 import java.net.URI;
+import java.util.AbstractMap;
 import java.util.ArrayList;
+import java.util.HashMap;
 import java.util.List;
+import java.util.Map;
+import java.util.Map.Entry;
 
 import org.eclipse.core.resources.IProject;
 import org.eclipse.core.runtime.IPath;
@@ -55,24 +59,30 @@
 		if (files.length == 0)
 			return;
 
-		List<IPath> relativePaths = new ArrayList<IPath>(files.length);
+		Map<Entry<IProject, Language>, List<IPath>> projects = new HashMap<Entry<IProject, Language>, List<IPath>>();
 		for (FilePartition file : files) {
 			try {
 				IPath path = relativePath(file.file, file.partition);
-				if (path != null)
+				if (path != null) {
+					IProject project = EditorIOAgent.getProject(new File(file.file));
+					Language lang = LanguageRegistry.findLanguage(path, null);
+					Entry<IProject, Language> entry =
+						    new AbstractMap.SimpleEntry<IProject, Language>(project, lang);
+					List<IPath> relativePaths = projects.get(entry);
+					if(relativePaths == null) {
+						relativePaths = new ArrayList<IPath>();
+						projects.put(entry, relativePaths);
+					}
 					relativePaths.add(path);
+				}
 			} catch (FileNotFoundException e) {
 				// Ignore exception, path is not added.
 			}
 		}
 
-		try {
-			// TODO: assuming all projects are the same, is that fine?
-			IProject project = EditorIOAgent.getProject(new File(files[0].file));
+		for(Entry<Entry<IProject, Language>, List<IPath>> entry : projects.entrySet()) {
 			StrategoAnalysisQueueFactory.getInstance().queueAnalysis(
-					relativePaths.toArray(new IPath[0]), project, triggerOnSave);
-		} catch (FileNotFoundException e) {
-			Environment.logException("Background language service failed", e);
+					entry.getValue().toArray(new IPath[0]), entry.getKey().getKey(), triggerOnSave);
 		}
 	}
 

From v.vergu+vc at gmail.com  Mon May  6 14:41:13 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 12:41:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26105 -
	hydra/jobs/spoofax-git
Message-ID: <20130506124113.B19A3CC117@mx4.tudelft.nl>

Author: VladVergu
Date: Mon May  6 12:41:11 2013
New Revision: 26105
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26105&sc=1

Log:
First attempt at building based on Git

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 10:52:58 2013	(r26104)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 12:41:11 2013	(r26105)
@@ -1,15 +1,37 @@
-{ nixpkgs ? ../../nixpkgs
-, spoofax ? { outPath = ../../spoofax ; rev = 1234; }
-, spoofaxImp ? { outPath = ../../spoofax-imp ; rev = 1234; }
-, lpgRuntime ? { outPath = ../../lpg.runtime.java ; rev = 1234; }
-, metaborgRuntime ? { outPath = ../../runtime-libraries; }
-, strategoxtJavaBackend ? ../../strategoxt-java-backend
-, hydraConfig ? { outPath = ../.; rev = 1234; }
+{
+  nixpkgs ? ../../../nixpkgs
+, jsglr ? ../../../jsglr
+, mbexec ? ../../../mb-exec
+, mbexecdeps ? ../../../mb-exec-deps
+, mbrep ? ../../../mb-rep
+, nabl ? ../../../nabl
+, sdf ? ../../../sdf
+, esv ? ../../../esv
+, aster ? ../../../aster
+, box ? ../../../box
+, spx ? ../../../spx
+, rtg ? ../../../rtg
+, stratego ? ../../../stratego
+, spt ? ../../../spt
+, tdl ? ../../../tdl
+, spoofax ? { outPath = ../../../spoofax ; rev= 1234; }
+, spoofaxdebug ? ../../../spoofax-debug
+, spoofaxdeploy ? ../../../spoofax-deploy
+, spoofaximppatches ? ../../../spoofax-imp-patches
+
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
+, metaborgRuntime ? { outPath = ../../../runtime-libraries; }
+, strategoxtJavaBackend ? ../../../strategoxt-java-backend
+, hydraConfig ? { outPath = ../../.; rev = 1234; }
+
 }:
-let 
+let
+/* 
   max = a : b : ( if builtins.lessThan a b then b else a );
   maxrev = xs : pkgs.lib.foldl max 0 xs ;
   spoofaxRev = toString (maxrev [spoofax.rev spoofaxImp.rev lpgRuntime.rev]) ;
+*/
+  spoofaxRev = toString spoofax.rev ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 
@@ -40,7 +62,7 @@
     sha256 = "07f189bd06e4294b329b4e3b0c7f54ce8236bba0393991a212a94cbb39ecd5b1";
   };
 
-  eclipseFun = import ../eclipse.nix pkgs ; 
+  eclipseFun = import ../../eclipse.nix pkgs ; 
     
   eclipse = eclipseFun {
     name = "eclipse-plain";
@@ -61,7 +83,7 @@
     dontInstall = true;
   }; 
 
-  strcJava = (import ./strc-java.nix {
+  strcJava = (import ../strc-java.nix {
     inherit nixpkgs hydraConfig;
     strcJavaCheckout = strategoxtJavaBackend;
   }).build { system = "i686-linux"; };
@@ -71,6 +93,9 @@
     src = pkgs.stdenv.mkDerivation {
       name = "spoofax-imp-src-r${spoofaxRev}";
 
+
+      buildInputs = with pkgs; [ unzip ];
+
       buildCommand = ''
         ensureDir $out
         cd $out
@@ -90,53 +115,67 @@
                  ${orgEclipseImp}/org.eclipse.imp.smapi \
                  ${orgEclipseImp}/org.eclipse.imp.smapifier \
                  ${orgEclipseImp}/org.eclipse.imp.xform \
-                 ${spoofax}/org.spoofax.aterm \
-                 ${spoofax}/org.spoofax.compiler \
-                 ${spoofax}/org.spoofax.interpreter.core \
-                 ${spoofax}/org.spoofax.interpreter \
-                 ${spoofax}/org.spoofax.interpreter.externaldeps \
-                 ${spoofax}/org.spoofax.interpreter.ui \
-                 ${spoofax}/org.spoofax.interpreter.library.jsglr \
-                 ${spoofax}/org.spoofax.interpreter.library.index \
-                 ${spoofax}/org.spoofax.interpreter.library.language \
-                 ${spoofax}/org.spoofax.interpreter.library.xml \
-                 ${spoofax}/org.spoofax.interpreter.library.interpreter \
-                 ${spoofax}/org.spoofax.interpreter.library.jline \
-                 ${spoofax}/org.spoofax.interpreter.adapter.ecj \
-                 ${spoofax}/org.spoofax.interpreter.library.eclipse \
-                 ${spoofax}/org.spoofax.interpreter.library.java \
-                 ${spoofax}/org.spoofax.jsglr \
-                 ${spoofax}/org.spoofax.terms \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.aster \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.aterm \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.editorservice \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.pp \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.rtg \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.sdf \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.template \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.spoofax \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.stratego \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.spoofax.configuration \
-                 ${spoofaxImp}/org.strategoxt.imp.names \
-                 ${spoofaxImp}/org.strategoxt.imp.testing \
-                 ${spoofaxImp}/org.strategoxt.imp.testing.ui \
-                 ${spoofaxImp}/org.strategoxt.imp.feature \
-                 ${spoofaxImp}/org.strategoxt.imp.generator \
-                 ${spoofaxImp}/org.strategoxt.imp.spoofax.generator \
-                 ${spoofaxImp}/org.strategoxt.imp.metatooling \
-                 ${spoofaxImp}/org.strategoxt.imp.nativebundle \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.main \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.legacy \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.latest \
-                 ${spoofaxImp}/org.strategoxt.imp.updatesite \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.core \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.core \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.runtime \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.test \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.transformer \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.ui \
-		  ${metaborgRuntime}/org.metaborg.runtime.task 
+
+                 ${mbexec}/org.spoofax.compiler \
+                 ${mbexec}/org.spoofax.interpreter.core \
+                 ${mbexec}/org.spoofax.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.ui \
+                 ${mbexec}/org.spoofax.interpreter.library.xml \
+                 ${mbexec}/org.spoofax.interpreter.library.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.library.jline \
+                 ${mbexec}/org.spoofax.interpreter.adapter.ecj \
+                 ${mbexec}/org.spoofax.interpreter.library.eclipse \
+                 ${mbexec}/org.spoofax.interpreter.library.java \
+                 ${mbexecdeps}/org.spoofax.interpreter.externaldeps \
+
+                 ${metaborgRuntime}/org.metaborg.runtime.task \
+
+                 ${mbrep}/org.spoofax.interpreter.library.index \
+                 ${mbrep}/org.spoofax.aterm \
+                 ${mbrep}/org.spoofax.terms \
+                 ${mbrep}/org.strategoxt.imp.editors.aterm \
+
+                 ${jsglr}/org.spoofax.jsglr \
+                 ${jsglr}/org.spoofax.interpreter.library.jsglr \
+
+                 ${sdf}/org.strategoxt.imp.editors.sdf \
+                 ${sdf}/org.strategoxt.imp.editors.template \
+
+                 ${stratego}/org.strategoxt.imp.editors.stratego \
+                 ${aster}/org.strategoxt.imp.editors.aster \
+                 ${esv}/org.strategoxt.imp.editors.editorservice \
+                 ${box}/org.strategoxt.imp.editors.pp \
+                 ${rtg}/org.strategoxt.imp.editors.rtg \
+
+                 ${spx}/org.strategoxt.imp.editors.spoofax \
+                 ${spx}/org.spoofax.interpreter.library.language \
+                 ${spx}/org.strategoxt.imp.editors.spoofax.configuration \                 
+                 ${spx}/org.strategoxt.imp.spoofax.generator \
+
+                 ${nabl}/org.strategoxt.imp.names \
+
+                 ${spt}/org.strategoxt.imp.testing \
+                 ${spt}/org.strategoxt.imp.testing.ui \
+
+                 ${spoofax}/org.strategoxt.imp.generator \
+                 ${spoofax}/org.strategoxt.imp.metatooling \
+                 ${spoofax}/org.strategoxt.imp.nativebundle \
+                 ${spoofax}/org.strategoxt.imp.runtime \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.main \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.legacy \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.latest \
+
+
+                 ${spoofax-debug}/org.strategoxt.imp.debug.core \
+                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.core \
+                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.runtime \
+                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.test \
+                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.transformer \
+                 ${spoofax-debug}/org.strategoxt.imp.debug.ui \
+
+                 ${spoofax-deploy}/org.strategoxt.imp.feature \
+                 ${spoofax-deploy}/org.strategoxt.imp.updatesite
+
         do
           header "Copying $d"
           cp -R $d .
@@ -146,8 +185,11 @@
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
         cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
-        mv ${guava} ${spoofax}/org.spoofax.interpreter.externaldeps/lib
-        unzip ${junit-benchmarks} -d ${spoofax}/org.spoofax.interpreter.externaldeps/lib
+        
+        chmod -R +w .
+        ensureDir org.spoofax.interpreter.externaldeps/lib
+        cp ${guava} org.spoofax.interpreter.externaldeps/lib/guava.jar
+        unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/
             
         chmod -R +w .
         rm -rf \
@@ -160,8 +202,8 @@
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
         sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
 
-        header "Patching org.eclipse.imp using ${spoofaxImp}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
-        patch -p0 < ${spoofaxImp}/org.eclipse.imp/org.eclipse.imp.runtime.patch
+        header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
+        patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
         stopNest
                     
         stopNest

From v.vergu+vc at gmail.com  Mon May  6 15:15:07 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 13:15:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26106 -
	hydra/jobs/spoofax-git
Message-ID: <20130506131507.DD04D108C007@mx3.tudelft.nl>

Author: VladVergu
Date: Mon May  6 13:15:06 2013
New Revision: 26106
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26106&sc=1

Log:
Take 2

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 12:41:11 2013	(r26105)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 13:15:06 2013	(r26106)
@@ -166,15 +166,15 @@
                  ${spoofax}/org.strategoxt.imp.runtime.sidebyside.latest \
 
 
-                 ${spoofax-debug}/org.strategoxt.imp.debug.core \
-                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.core \
-                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.runtime \
-                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.test \
-                 ${spoofax-debug}/org.strategoxt.imp.debug.stratego.transformer \
-                 ${spoofax-debug}/org.strategoxt.imp.debug.ui \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.runtime \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.test \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.transformer \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.ui \
 
-                 ${spoofax-deploy}/org.strategoxt.imp.feature \
-                 ${spoofax-deploy}/org.strategoxt.imp.updatesite
+                 ${spoofaxdeploy}/org.strategoxt.imp.feature \
+                 ${spoofaxdeploy}/org.strategoxt.imp.updatesite
 
         do
           header "Copying $d"

From v.vergu+vc at gmail.com  Mon May  6 15:18:54 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 13:18:54 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26107 -
	hydra/jobs/spoofax-git
Message-ID: <20130506131854.BFF08108C020@mx3.tudelft.nl>

Author: VladVergu
Date: Mon May  6 13:18:53 2013
New Revision: 26107
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26107&sc=1

Log:
Take 3

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 13:15:06 2013	(r26106)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 13:18:53 2013	(r26107)
@@ -115,7 +115,6 @@
                  ${orgEclipseImp}/org.eclipse.imp.smapi \
                  ${orgEclipseImp}/org.eclipse.imp.smapifier \
                  ${orgEclipseImp}/org.eclipse.imp.xform \
-
                  ${mbexec}/org.spoofax.compiler \
                  ${mbexec}/org.spoofax.interpreter.core \
                  ${mbexec}/org.spoofax.interpreter \
@@ -127,36 +126,27 @@
                  ${mbexec}/org.spoofax.interpreter.library.eclipse \
                  ${mbexec}/org.spoofax.interpreter.library.java \
                  ${mbexecdeps}/org.spoofax.interpreter.externaldeps \
-
                  ${metaborgRuntime}/org.metaborg.runtime.task \
-
                  ${mbrep}/org.spoofax.interpreter.library.index \
                  ${mbrep}/org.spoofax.aterm \
                  ${mbrep}/org.spoofax.terms \
                  ${mbrep}/org.strategoxt.imp.editors.aterm \
-
                  ${jsglr}/org.spoofax.jsglr \
                  ${jsglr}/org.spoofax.interpreter.library.jsglr \
-
                  ${sdf}/org.strategoxt.imp.editors.sdf \
                  ${sdf}/org.strategoxt.imp.editors.template \
-
                  ${stratego}/org.strategoxt.imp.editors.stratego \
                  ${aster}/org.strategoxt.imp.editors.aster \
                  ${esv}/org.strategoxt.imp.editors.editorservice \
                  ${box}/org.strategoxt.imp.editors.pp \
                  ${rtg}/org.strategoxt.imp.editors.rtg \
-
                  ${spx}/org.strategoxt.imp.editors.spoofax \
                  ${spx}/org.spoofax.interpreter.library.language \
                  ${spx}/org.strategoxt.imp.editors.spoofax.configuration \                 
                  ${spx}/org.strategoxt.imp.spoofax.generator \
-
                  ${nabl}/org.strategoxt.imp.names \
-
                  ${spt}/org.strategoxt.imp.testing \
                  ${spt}/org.strategoxt.imp.testing.ui \
-
                  ${spoofax}/org.strategoxt.imp.generator \
                  ${spoofax}/org.strategoxt.imp.metatooling \
                  ${spoofax}/org.strategoxt.imp.nativebundle \
@@ -164,18 +154,14 @@
                  ${spoofax}/org.strategoxt.imp.runtime.sidebyside.main \
                  ${spoofax}/org.strategoxt.imp.runtime.sidebyside.legacy \
                  ${spoofax}/org.strategoxt.imp.runtime.sidebyside.latest \
-
-
                  ${spoofaxdebug}/org.strategoxt.imp.debug.core \
                  ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.core \
                  ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.runtime \
                  ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.test \
                  ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.transformer \
                  ${spoofaxdebug}/org.strategoxt.imp.debug.ui \
-
                  ${spoofaxdeploy}/org.strategoxt.imp.feature \
                  ${spoofaxdeploy}/org.strategoxt.imp.updatesite
-
         do
           header "Copying $d"
           cp -R $d .

From v.vergu+vc at gmail.com  Mon May  6 15:24:14 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 13:24:14 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26108 -
	hydra/jobs/spoofax-git
Message-ID: <20130506132414.D6B9F7F803B@mx1.tudelft.nl>

Author: VladVergu
Date: Mon May  6 13:24:14 2013
New Revision: 26108
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26108&sc=1

Log:
Strange, it seems hydra is stricter than nix-build locally.

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 13:18:53 2013	(r26107)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 13:24:14 2013	(r26108)
@@ -142,7 +142,7 @@
                  ${rtg}/org.strategoxt.imp.editors.rtg \
                  ${spx}/org.strategoxt.imp.editors.spoofax \
                  ${spx}/org.spoofax.interpreter.library.language \
-                 ${spx}/org.strategoxt.imp.editors.spoofax.configuration \                 
+                 ${spx}/org.strategoxt.imp.editors.spoofax.configuration \
                  ${spx}/org.strategoxt.imp.spoofax.generator \
                  ${nabl}/org.strategoxt.imp.names \
                  ${spt}/org.strategoxt.imp.testing \

From v.vergu+vc at gmail.com  Mon May  6 17:32:07 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 15:32:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26109 -
	hydra/jobs/spoofax-git
Message-ID: <20130506153207.DAE362B8004@mx2.tudelft.nl>

Author: VladVergu
Date: Mon May  6 15:32:06 2013
New Revision: 26109
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26109&sc=1

Log:
Add missing path

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 13:24:14 2013	(r26108)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 15:32:06 2013	(r26109)
@@ -218,6 +218,7 @@
             
         mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
 
+        mkdir -p org.strategoxt.imp.generator/src-gen/org/strategoxt/imp/generator
         mkdir -p org.strategoxt.strj/java
         cp ${strcJava}/share/strc-java/strategoxt.jar org.strategoxt.strj/java/
 

From v.vergu+vc at gmail.com  Mon May  6 21:11:43 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 19:11:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26110 -
	hydra/jobs/spoofax-git
Message-ID: <20130506191143.A3297CC0FD@mx4.tudelft.nl>

Author: VladVergu
Date: Mon May  6 19:11:42 2013
New Revision: 26110
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26110&sc=1

Log:
Some cleanup

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 15:32:06 2013	(r26109)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May  6 19:11:42 2013	(r26110)
@@ -14,24 +14,19 @@
 , stratego ? ../../../stratego
 , spt ? ../../../spt
 , tdl ? ../../../tdl
-, spoofax ? { outPath = ../../../spoofax ; rev= 1234; }
+, spoofax ? { outPath = ../../../spoofax ; shortRev= 1234; }
 , spoofaxdebug ? ../../../spoofax-debug
 , spoofaxdeploy ? ../../../spoofax-deploy
 , spoofaximppatches ? ../../../spoofax-imp-patches
 
 , lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
 , metaborgRuntime ? { outPath = ../../../runtime-libraries; }
-, strategoxtJavaBackend ? ../../../strategoxt-java-backend
+, strategoxt ? ../../../strategoxt-cver
 , hydraConfig ? { outPath = ../../.; rev = 1234; }
 
 }:
 let
-/* 
-  max = a : b : ( if builtins.lessThan a b then b else a );
-  maxrev = xs : pkgs.lib.foldl max 0 xs ;
-  spoofaxRev = toString (maxrev [spoofax.rev spoofaxImp.rev lpgRuntime.rev]) ;
-*/
-  spoofaxRev = toString spoofax.rev ;
+  spoofaxRev = toString spoofax.shortRev ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 
@@ -85,7 +80,7 @@
 
   strcJava = (import ../strc-java.nix {
     inherit nixpkgs hydraConfig;
-    strcJavaCheckout = strategoxtJavaBackend;
+    strcJavaCheckout = strategoxt;
   }).build { system = "i686-linux"; };
     
   jobs = with pkgs.lib; {
@@ -170,7 +165,7 @@
 
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
-        cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
+        cp -R ${strategoxt}/strategoxt-java-backend org.strategoxt.strj
         
         chmod -R +w .
         ensureDir org.spoofax.interpreter.externaldeps/lib

From v.vergu+vc at gmail.com  Mon May  6 22:22:58 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 20:22:58 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26111 - hydra/jobs
Message-ID: <20130506202258.A1D127F805A@mx1.tudelft.nl>

Author: VladVergu
Date: Mon May  6 20:22:57 2013
New Revision: 26111
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26111&sc=1

Log:
Wondering why Javascript backend build is broken.

Modified:
   hydra/jobs/strategoxt-javascript-backend.nix

Modified: hydra/jobs/strategoxt-javascript-backend.nix
==============================================================================
--- hydra/jobs/strategoxt-javascript-backend.nix	Mon May  6 19:11:42 2013	(r26110)
+++ hydra/jobs/strategoxt-javascript-backend.nix	Mon May  6 20:22:57 2013	(r26111)
@@ -1,7 +1,7 @@
 { 
  nixpkgs ? ../../nixpkgs
-, jsbackend ? {  outPath = ../../strategoxt-javascript-backend/trunk ;  }
-, strategoxtJavaBackend ? { outPath = ../../strc-java ; rev = 1234; } 
+, jsbackend ? {  outPath = ../../strategoxt-javascript-backend ;  }
+, strategoxt ? { outPath = ../../strategoxt-cver ; rev = 1234; } 
 , hydraConfig ? { outPath = ../.; rev = 1234; }
 }:
 
@@ -10,7 +10,7 @@
   stdenv = pkgs.stdenv;
   strcJava = (import ./strc-java.nix {
     inherit nixpkgs hydraConfig;
-    strcJavaCheckout = strategoxtJavaBackend;
+    strcJavaCheckout = strategoxt;
   }).build { system = "i686-linux"; };
 in
 {

From v.vergu+vc at gmail.com  Mon May  6 23:44:18 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 06 May 2013 21:44:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26112 -
	hydra/jobs/spoofax-git
Message-ID: <20130506214418.EEC2F2B8004@mx2.tudelft.nl>

Author: VladVergu
Date: Mon May  6 21:44:16 2013
New Revision: 26112
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26112&sc=1

Log:
WIP for obtaining a Spoofax build that is built with the bootstrapped StrJ. Not yet working.

Added:
   hydra/jobs/spoofax-git/spoofax-master-strj.nix

Added: hydra/jobs/spoofax-git/spoofax-master-strj.nix
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ hydra/jobs/spoofax-git/spoofax-master-strj.nix	Mon May  6 21:44:16 2013	(r26112)
@@ -0,0 +1,398 @@
+{
+  nixpkgs ? ../../../nixpkgs
+
+, jsglr ? ../../../jsglr
+, mbexec ? ../../../mb-exec
+, mbexecdeps ? ../../../mb-exec-deps
+, mbrep ? ../../../mb-rep
+, nabl ? ../../../nabl
+, sdf ? ../../../sdf
+, esv ? ../../../esv
+, aster ? ../../../aster
+, box ? ../../../box
+, spx ? ../../../spx
+, rtg ? ../../../rtg
+, stratego ? ../../../stratego
+, spt ? ../../../spt
+, tdl ? ../../../tdl
+, spoofax ? { outPath = ../../../spoofax ; shortRev= 1234; }
+, spoofaxdebug ? ../../../spoofax-debug
+, spoofaxdeploy ? ../../../spoofax-deploy
+, spoofaximppatches ? ../../../spoofax-imp-patches
+
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
+, metaborgRuntime ? ../../../runtime-libraries
+
+, strategoxt ? { outPath = ../../../strategoxt ; rev = 1234; }
+, strategoxtCVersion ? ../../../strategoxt-cver
+, javaFront ? ../../../java-front
+
+, hydraConfig ? { outPath = ../../.; rev = 1234; }
+
+}:
+let
+  spoofaxRev = toString spoofax.shortRev ;
+
+  pkgs = import nixpkgs { system = "i686-linux"; };
+
+  orgEclipseImp = pkgs.fetchsvn {
+    url = http://dev.eclipse.org/svnroot/technology/org.eclipse.imp/trunk;
+    rev = 22255;
+    sha256 = "0mknky2wpqvpcaqnz1l6wh6p1p8zjmd299hlf1nnwm91paiqmm85";
+  };
+
+  jline = pkgs.fetchurl {
+    url = http://spoofax.org/mirror/extras/jline-1.0.jar;
+    sha256 = "6d35823d5ae86ea4c71bc653747d1234c1587662882a76738d2881fb409394ab";
+  };
+
+  shrike = pkgs.fetchsvn {
+    url = https://wala.svn.sourceforge.net/svnroot/wala/trunk/com.ibm.wala.shrike;
+    rev = 3073;
+    sha256 = "0y13i31xlhian5glk4cahbzxg4mky4q61qzc5g03qkg4d67k12zd";
+  };
+
+  guava = pkgs.fetchurl {
+    url = http://search.maven.org/remotecontent?filepath=com/google/guava/guava/14.0.1/guava-14.0.1.jar;
+    sha256 = "d69df3331840605ef0e5fe4add60f2d28e870e3820937ea29f713d2035d9ab97";
+  };
+
+  junit-benchmarks = pkgs.fetchurl {
+    url = http://labs.carrotsearch.com/download/junit-benchmarks/0.6.0/junit-benchmarks-0.6.0.zip;
+    sha256 = "07f189bd06e4294b329b4e3b0c7f54ce8236bba0393991a212a94cbb39ecd5b1";
+  };
+
+  eclipseFun = import ../../eclipse.nix pkgs ; 
+    
+  eclipse = eclipseFun {
+    name = "eclipse-plain";
+    src =  pkgs.fetchurl {
+      url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+      sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";
+    };
+  }; 
+
+  eclipseTest = eclipseFun {
+    name = "eclipse-spoofax-install-test";
+    src =  pkgs.fetchurl {
+      url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+      sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";
+    };
+    updatesites = [ "file://${jobs.build}/site" ];
+    installIUs = [ "org.strategoxt.imp.feature.group" ];
+    dontInstall = true;
+  }; 
+
+  strj = (import ../strategoxt-java-bootstrap.nix {
+    inherit nixpkgs hydraConfig javaFront;
+    strategoxtJava = strategoxt;
+
+    baseline = (import ../strc-java.nix {
+      inherit nixpkgs hydraConfig;
+      strcJavaCheckout = strategoxtCVersion;
+    }).build { system = "i686-linux"; };
+    
+  }).bootstrap1;
+
+  jobs = with pkgs.lib; {
+    tests.install = eclipseTest;
+    src = pkgs.stdenv.mkDerivation {
+      name = "spoofax-imp-src-r${spoofaxRev}";
+
+
+      buildInputs = with pkgs; [ unzip ];
+
+      buildCommand = ''
+        ensureDir $out
+        cd $out
+            
+        header "Preparing org.eclipse.imp"
+    
+        for d in ${orgEclipseImp}/org.eclipse.imp.cheatsheets \
+                 ${orgEclipseImp}/org.eclipse.imp.java.hosted \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg.ide \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg.metatooling \
+                 ${orgEclipseImp}/org.eclipse.imp.metatooling \
+                 ${orgEclipseImp}/org.eclipse.imp.preferences \
+                 ${orgEclipseImp}/org.eclipse.imp.prefspecs \
+                 ${orgEclipseImp}/org.eclipse.imp.presentation \
+                 ${orgEclipseImp}/org.eclipse.imp.runtime \
+                 ${orgEclipseImp}/org.eclipse.imp.smapi \
+                 ${orgEclipseImp}/org.eclipse.imp.smapifier \
+                 ${orgEclipseImp}/org.eclipse.imp.xform \
+                 ${mbexec}/org.spoofax.compiler \
+                 ${mbexec}/org.spoofax.interpreter.core \
+                 ${mbexec}/org.spoofax.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.ui \
+                 ${mbexec}/org.spoofax.interpreter.library.xml \
+                 ${mbexec}/org.spoofax.interpreter.library.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.library.jline \
+                 ${mbexec}/org.spoofax.interpreter.adapter.ecj \
+                 ${mbexec}/org.spoofax.interpreter.library.eclipse \
+                 ${mbexec}/org.spoofax.interpreter.library.java \
+                 ${mbexecdeps}/org.spoofax.interpreter.externaldeps \
+                 ${metaborgRuntime}/org.metaborg.runtime.task \
+                 ${mbrep}/org.spoofax.interpreter.library.index \
+                 ${mbrep}/org.spoofax.aterm \
+                 ${mbrep}/org.spoofax.terms \
+                 ${mbrep}/org.strategoxt.imp.editors.aterm \
+                 ${jsglr}/org.spoofax.jsglr \
+                 ${jsglr}/org.spoofax.interpreter.library.jsglr \
+                 ${sdf}/org.strategoxt.imp.editors.sdf \
+                 ${sdf}/org.strategoxt.imp.editors.template \
+                 ${stratego}/org.strategoxt.imp.editors.stratego \
+                 ${aster}/org.strategoxt.imp.editors.aster \
+                 ${esv}/org.strategoxt.imp.editors.editorservice \
+                 ${box}/org.strategoxt.imp.editors.pp \
+                 ${rtg}/org.strategoxt.imp.editors.rtg \
+                 ${spx}/org.strategoxt.imp.editors.spoofax \
+                 ${spx}/org.spoofax.interpreter.library.language \
+                 ${spx}/org.strategoxt.imp.editors.spoofax.configuration \
+                 ${spx}/org.strategoxt.imp.spoofax.generator \
+                 ${nabl}/org.strategoxt.imp.names \
+                 ${spt}/org.strategoxt.imp.testing \
+                 ${spt}/org.strategoxt.imp.testing.ui \
+                 ${spoofax}/org.strategoxt.imp.generator \
+                 ${spoofax}/org.strategoxt.imp.metatooling \
+                 ${spoofax}/org.strategoxt.imp.nativebundle \
+                 ${spoofax}/org.strategoxt.imp.runtime \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.main \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.legacy \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.latest \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.runtime \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.test \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.transformer \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.ui \
+                 ${spoofaxdeploy}/org.strategoxt.imp.feature \
+                 ${spoofaxdeploy}/org.strategoxt.imp.updatesite
+        do
+          header "Copying $d"
+          cp -R $d .
+          stopNest
+        done
+
+        cp -R ${shrike} com.ibm.wala.shrike
+        cp -R ${lpgRuntime} lpg.runtime.java
+        cp -R ${strategoxt}/strategoxt/stratego-libraries/java-backend org.strategoxt.strj
+        
+        chmod -R +w .
+        ensureDir org.spoofax.interpreter.externaldeps/lib
+        cp ${guava} org.spoofax.interpreter.externaldeps/lib/guava.jar
+        unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/
+            
+        chmod -R +w .
+        rm -rf \
+              org.spoofax.jsglr/src/org/spoofax/jsglr/shared/RemoteParseTableService* \
+              org.spoofax.jsglr/src/org/spoofax/client/JSGLREntryPoint.java \
+              org.spoofax.jsglr/src/org/spoofax/jsglr/server/RemoteParseTableServiceImpl.java \
+              org.spoofax.terms/src/org/spoofax/gwt/
+        sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
+
+        header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
+        patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
+        stopNest
+                    
+        stopNest
+      '';
+    };
+
+    build = pkgs.stdenv.mkDerivation rec {
+      name = "spoofax-imp-r${spoofaxRev}";
+      inherit (jobs) src;
+
+      buildInputs = with pkgs; [ maven3 strj pkgconfig which ecj openjdk apacheAntOpenJDK strategoPackages.sdf ];
+      mvnFlags = "-Dversion=1.0.0-SNAPSHOT -DgroupId=spoofax -Dtycho.targetPlatform=${eclipse}/eclipse -Dmaven.repo.local=/tmp/m3";
+
+      M2_REPO="/tmp/m3";
+      MAVEN_OPTS="-Xss8m -Xmx1024m";
+      STRATEGOXT=pkgs.strategoPackages.strategoxt;
+      JAVA_FRONT=pkgs.strategoPackages.javafront;
+      SDF=pkgs.strategoPackages.sdf;
+
+      buildPhase = ''
+        ulimit -s unlimited
+
+        #hack
+        mkdir -p plugins
+        export eclipsefakehome=`pwd`
+            
+        mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
+
+        mkdir -p org.strategoxt.imp.generator/src-gen/org/strategoxt/imp/generator
+        mkdir -p org.strategoxt.strj/java
+        cp ${strj}/share/strategoxt/strategoxt.jar org.strategoxt.strj/java/
+
+        header "Building org.strategoxt.imp.generator"
+        make -C org.strategoxt.imp.generator all
+        stopNest
+
+        for e in */build.generated.xml
+        do
+          POM=`dirname $e`/pom.xml
+          if [[ -f $POM ]] ; then
+             sed -i 's|</project>||' $POM
+             echo '
+  <build>
+    <plugins>
+ <plugin>
+    <groupId>org.apache.maven.plugins</groupId>
+    <artifactId>maven-antrun-plugin</artifactId>
+    <dependencies>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>aster</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/aster.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>strategoxt</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.strj/java/strategoxt.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>sdf2imp</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/sdf2imp.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>make_permissive.jar</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/make_permissive.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>com.sun</groupId>
+            <artifactId>tools</artifactId>
+            <version>1.4.2</version>
+            <scope>system</scope>
+            <systemPath>''${java.home}/../lib/tools.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>ecj</groupId>
+            <artifactId>ecj</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>${pkgs.ecj}/lib/java/ecj.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>jline</groupId>
+            <artifactId>jline</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.spoofax.interpreter.library.jline/lib/jline-1.0.jar</systemPath>
+        </dependency>
+    </dependencies>
+    <executions>
+       <execution>
+               <id>generate-sources</id>
+               <phase>generate-sources</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="externaljarx" refid="maven.compile.classpath"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
+                          <property name="eclipse.home" value="${eclipse}/eclipse"/>
+                          <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+                          <ant antfile="build.main.xml" inheritRefs="true">
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+       <execution>
+               <id>process-classes</id>
+               <phase>process-classes</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
+                          <property name="eclipse.home" value="${eclipse}/eclipse"/>
+                          <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+                          <ant antfile="build.main.xml" inheritRefs="true">
+                            <target name="java.jar"/> 
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+    </executions>
+  </plugin>
+    </plugins>
+</build></project>' >>$POM
+          fi
+        done
+
+        for e in */build.ant.xml
+        do
+          POM=`dirname $e`/pom.xml
+          if [[ -f $POM ]] ; then
+             sed -i 's|</project>||' $POM
+             echo '
+  <build>
+    <plugins>
+ <plugin>
+    <groupId>org.apache.maven.plugins</groupId>
+    <artifactId>maven-antrun-plugin</artifactId>
+    <executions>
+       <execution>
+               <id>generate-sources</id>
+               <phase>generate-sources</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="strategoxt.dir" value="${STRATEGOXT}"/>
+                          <property name="sdf.dir" value="${SDF}"/>
+                          <ant antfile="build.ant.xml" inheritRefs="true">
+                              <target name="bundle-ctree" />
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+    </executions>
+  </plugin>
+    </plugins>
+</build></project>' >>$POM
+          fi
+        done
+
+        mvn package ${mvnFlags} -e
+        mvn integration-test ${mvnFlags} -e
+      '';
+          
+      installPhase = ''
+        ensureDir $out/nix-support
+        cp -Rv org.strategoxt.imp.updatesite/target/site $out/
+        touch $out/site/index.html
+        cd $out
+        tar cvzf $out/${name}.tar.gz site
+        echo "file site $out/site" >> $out/nix-support/hydra-build-products
+        echo "file tar $out/${name}.tar.gz" >> $out/nix-support/hydra-build-products
+      '';
+
+       __noChroot = true;
+       meta.maintainers = ["lclkats at gmail.com" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com" "karltk at strategoxt.org" "g.h.wachsmuth at tudelft.nl" "gabrielkonat at gmail.com" "v.vergu at gmail.com"];
+     } ;     
+  } ;
+
+in jobs

From g.h.wachsmuth at tudelft.nl  Tue May  7 10:39:10 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Tue, 07 May 2013 08:39:10 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26113 - in
	spoofax-imp/branches/nbl-dev: editor lib trans trans/generation2
Message-ID: <20130507083910.95FB4108C01E@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Tue May  7 08:39:08 2013
New Revision: 26113
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26113&sc=1

Log:
support for all imports

Modified:
   spoofax-imp/branches/nbl-dev/editor/   (props changed)
   spoofax-imp/branches/nbl-dev/lib/   (props changed)
   spoofax-imp/branches/nbl-dev/trans/   (props changed)
   spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
   spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Mon May  6 21:44:16 2013	(r26112)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Tue May  7 08:39:08 2013	(r26113)
@@ -7,7 +7,7 @@
   
   generation2/util
   generation2/sections
-  generation2/prop-sites
+  generation2/scoping-sites
   generation2/constraints
   
 rules
@@ -22,25 +22,46 @@
   binding-to-import-rule(|bound*, task*, repl*):
     (i, BindingRule(pattern, constr*, clause*)) -> IMPORT_RULE(pattern, seq)
     where 
-      cong* := <filter-with-index(to-import-cong(|pattern, bound*, repl*, i)); nonempty> clause*
+      cong* := <filter-with-index(to-import-clauses(|pattern, bound*, repl*, i)); concat; nonempty> clause*
     ; seq   := <to-seq> [task*, cong*]
   
-  to-import-cong(|pattern, bound*, repl*, i):
-    (j, clause at ImportClause(part*)) -> cong
+  to-import-clauses(|pattern, bound*, repl*, i):
+    (j, DefClause(_, _, _, term, _, DefScopes(ds*), _)) -> [IMPORT_CALL([SINGLE(term, scope, [])])]
     where
-      term    := <import-to-name> clause
-    ; import* := <filter-with-index(part-to-imports); concat> part*
-    ; call    := IMPORT_CALL(import*)
-    ; cong    := <replace-all-id(|[(term, call)])> pattern
+      ds'*  := <filter(?DefScope(_)); nonempty> ds*
+    ; scope := <scope-to-term> DefScopes(ds'*)
     
-	part-to-imports:
-		(j, WildcardImport(import-part*, _, _, _, _)) -> <filter(part-to-import)> import-part*
-
-	part-to-import:
-		Direct(ns) -> IMPORT_DIRECT(<ns-to-term> ns)
-		
-	part-to-import:
-		Transitive(ns) -> IMPORT_TRANSITIVE(<ns-to-term> ns)	
+  to-import-clauses(|pattern, bound*, repl*, i):
+    (j, clause at ImportClause(part*)) -> [clause*, IMPORT_CALL(import*)]
+    where
+      k       := <extend-index(|i)> j
+    ; (clause*, import*) 
+              := <filter-with-index(to-import-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
+    
+  to-import-candidate(|pattern, bound*, glob-repl*, i):
+    (j, SingleImport(_, _, term, _, _, alias, into, constr*)) -> result
+    where
+      into-term      := <scope-to-term> into
+    ; k              := <extend-index(|i)> j
+    ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
+    ; dep*           := <map(Snd)> repl*
+    where
+       Alias(a) := alias
+     ; result   := (task*, ALIAS(term, a, []))
+    <+ result   := (task*, SINGLE(term, into-term, dep*))
+       
+	to-import-candidate(|pattern, bound*, glob-repl*, i):
+		(j, WildcardImport(ns*, _, from, into, constr*)) -> (task*, WILDCARD(ns-term*, from-term, into-term, dep*))
+    where
+      ns-term*  := <map(ns-to-term)> ns*
+    ; from-term := <scope-to-term> from
+    ; into-term := <scope-to-term> into
+    ; k              := <extend-index(|i)> j
+    ; (task*, repl*) := <constraints-to-tasks(|bound*, k, 1)> (constr*, glob-repl*)
+    ; dep*           := <map(Snd)> repl*
+      
+	ns-to-term: Direct(ns)     -> DIRECT(<ns-to-term> ns)
+	ns-to-term: Transitive(ns) -> TRANSITIVE(<ns-to-term> ns)	
     
 overlays
      
@@ -67,8 +88,9 @@
     ] 
   )
   
-  IMPORT_DIRECT(ns) =
-  TERM("Import", [Var("lang__"), ns])
-  
-  IMPORT_TRANSITIVE(ns) =
-  TERM("Import", [Var("lang__"), TERM("Imported", [ns])])
+  SINGLE(term, scope, deps)      = TERM("Single", [term, scope, LIST(deps)])
+  ALIAS(term, alias, deps)       = TERM("Alias", [term, alias, LIST(deps)])
+  WILDCARD(ns, from, into, deps) = TERM("Wildcard", [LIST(ns), from, into, LIST(deps)])
+
+  DIRECT(ns)     = TERM("Import", [Var("lang__"), ns])
+  TRANSITIVE(ns) = TERM("Import", [Var("lang__"), TERM("Imported", [ns])])

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Mon May  6 21:44:16 2013	(r26112)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/use-sites.str	Tue May  7 08:39:08 2013	(r26113)
@@ -34,12 +34,12 @@
     where
       k        := <extend-index(|i)> j
     ; (clause*, candidate*) 
-               := <filter-with-index(to-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
+               := <filter-with-index(to-use-candidate(|pattern, bound*, repl*, k)); unzip; (concat, id)> part*
     ; term     := <use-to-name> clause
     ; use-call := USE_CALL(candidate*)
     ; cong     := <replace-all-id(|[(term, use-call)])> pattern
   
-  to-candidate(|pattern, bound*, glob-repl*, i):
+  to-use-candidate(|pattern, bound*, glob-repl*, i):
     (j, part) -> (task*, CANDIDATE(ns-term, prop-term*, ctx-term, dep*))
     where
       RefClausePart(disamb, ns, term, prop*, ctx, constr*)                    := part

From v.vergu+vc at gmail.com  Tue May  7 10:47:12 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Tue, 07 May 2013 08:47:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26114 -
	hydra/jobs/spoofax-git
Message-ID: <20130507084712.8F6C3CC18B@mx4.tudelft.nl>

Author: VladVergu
Date: Tue May  7 08:47:10 2013
New Revision: 26114
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26114&sc=1

Log:
A build which makes a Spoofax that includes the bootstrapped version of StrJ but does Spoofax itself is built with the non-bootstrapped.

Added:
   hydra/jobs/spoofax-git/spoofax-master-i-strj.nix
      - copied, changed from r26112, hydra/jobs/spoofax-git/spoofax-master-strj.nix

Copied and modified: hydra/jobs/spoofax-git/spoofax-master-i-strj.nix (from r26112, hydra/jobs/spoofax-git/spoofax-master-strj.nix)
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master-strj.nix	Mon May  6 21:44:16 2013	(r26112, copy source)
+++ hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Tue May  7 08:47:10 2013	(r26114)
@@ -83,16 +83,16 @@
     dontInstall = true;
   }; 
 
-  strj = (import ../strategoxt-java-bootstrap.nix {
-    inherit nixpkgs hydraConfig javaFront;
-    strategoxtJava = strategoxt;
-
-    baseline = (import ../strc-java.nix {
+  strcj = (import ../strc-java.nix {
       inherit nixpkgs hydraConfig;
       strcJavaCheckout = strategoxtCVersion;
     }).build { system = "i686-linux"; };
-    
-  }).bootstrap1;
+
+  strj = (import ../strategoxt-java-bootstrap.nix {
+    inherit nixpkgs hydraConfig javaFront;
+    strategoxtJava = strategoxt;
+    baseline = strcj;
+  }).bootstrap3;
 
   jobs = with pkgs.lib; {
     tests.install = eclipseTest;
@@ -206,7 +206,7 @@
       name = "spoofax-imp-r${spoofaxRev}";
       inherit (jobs) src;
 
-      buildInputs = with pkgs; [ maven3 strj pkgconfig which ecj openjdk apacheAntOpenJDK strategoPackages.sdf ];
+      buildInputs = with pkgs; [ maven3 strcj pkgconfig which ecj openjdk apacheAntOpenJDK strategoPackages.sdf ];
       mvnFlags = "-Dversion=1.0.0-SNAPSHOT -DgroupId=spoofax -Dtycho.targetPlatform=${eclipse}/eclipse -Dmaven.repo.local=/tmp/m3";
 
       M2_REPO="/tmp/m3";

From v.vergu+vc at gmail.com  Tue May  7 11:46:28 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Tue, 07 May 2013 09:46:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26115 -
	hydra/jobs/spoofax-git
Message-ID: <20130507094628.8843D108C00A@mx3.tudelft.nl>

Author: VladVergu
Date: Tue May  7 09:46:22 2013
New Revision: 26115
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26115&sc=1

Log:
Git-oriented build for the Spoofax release

Added:
   hydra/jobs/spoofax-git/spoofax-release.nix
      - copied, changed from r26112, hydra/jobs/spoofax-imp-release.nix

Copied and modified: hydra/jobs/spoofax-git/spoofax-release.nix (from r26112, hydra/jobs/spoofax-imp-release.nix)
==============================================================================
--- hydra/jobs/spoofax-imp-release.nix	Mon May  6 21:44:16 2013	(r26112, copy source)
+++ hydra/jobs/spoofax-git/spoofax-release.nix	Tue May  7 09:46:22 2013	(r26115)
@@ -1,14 +1,31 @@
-{ nixpkgs ? ../../nixpkgs
-, spoofax ? { outPath = ../../spoofax ; rev = 1234; }
-, spoofaxImp ? { outPath = ../../spoofax-imp ; rev = 1234; }
-, lpgRuntime ? { outPath = ../../lpg.runtime.java ; rev = 1234; }
-, strategoxtJavaBackend ? ../../strategoxt-java-backend
-, hydraConfig ? { outPath = ../.; rev = 1234; }
+{
+  nixpkgs ? ../../../nixpkgs
+, jsglr ? ../../../jsglr
+, mbexec ? ../../../mb-exec
+, mbexecdeps ? ../../../mb-exec-deps
+, mbrep ? ../../../mb-rep
+, nabl ? ../../../nabl
+, sdf ? ../../../sdf
+, esv ? ../../../esv
+, aster ? ../../../aster
+, box ? ../../../box
+, spx ? ../../../spx
+, rtg ? ../../../rtg
+, stratego ? ../../../stratego
+, spt ? ../../../spt
+, tdl ? ../../../tdl
+, spoofax ? { outPath = ../../../spoofax ; shortRev= 1234; }
+, spoofaxdebug ? ../../../spoofax-debug
+, spoofaxdeploy ? ../../../spoofax-deploy
+, spoofaximppatches ? ../../../spoofax-imp-patches
+
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
+, strategoxt ? ../../../strategoxt
+, hydraConfig ? { outPath = ../../.; rev = 1234; }
+
 }:
 let 
-  max = a : b : ( if builtins.lessThan a b then b else a );
-  maxrev = xs : pkgs.lib.foldl max 0 xs ;
-  spoofaxRev = toString (maxrev [spoofax.rev spoofaxImp.rev lpgRuntime.rev]) ;
+  spoofaxRev = toString spoofax.shortRev ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 
@@ -29,7 +46,7 @@
     sha256 = "0y13i31xlhian5glk4cahbzxg4mky4q61qzc5g03qkg4d67k12zd";
   };
 
-  eclipseFun = import ../eclipse.nix pkgs ; 
+  eclipseFun = import ../../eclipse.nix pkgs ; 
     
   eclipse = eclipseFun {
     name = "eclipse-plain";
@@ -50,9 +67,9 @@
     dontInstall = true;
   }; 
 
-  strcJava = (import ./strc-java.nix {
+  strcJava = (import ../strc-java.nix {
     inherit nixpkgs hydraConfig;
-    strcJavaCheckout = strategoxtJavaBackend;
+    strcJavaCheckout = strategoxt;
   }).build { system = "i686-linux"; };
     
   jobs = with pkgs.lib; {
@@ -79,51 +96,51 @@
                  ${orgEclipseImp}/org.eclipse.imp.smapi \
                  ${orgEclipseImp}/org.eclipse.imp.smapifier \
                  ${orgEclipseImp}/org.eclipse.imp.xform \
-                 ${spoofax}/org.spoofax.aterm \
-                 ${spoofax}/org.spoofax.compiler \
-                 ${spoofax}/org.spoofax.interpreter.core \
-                 ${spoofax}/org.spoofax.interpreter \
-                 ${spoofax}/org.spoofax.interpreter.ui \
-                 ${spoofax}/org.spoofax.interpreter.library.jsglr \
-                 ${spoofax}/org.spoofax.interpreter.library.index \
-                 ${spoofax}/org.spoofax.interpreter.library.language \
-                 ${spoofax}/org.spoofax.interpreter.library.xml \
-                 ${spoofax}/org.spoofax.interpreter.library.interpreter \
-                 ${spoofax}/org.spoofax.interpreter.library.jline \
-                 ${spoofax}/org.spoofax.interpreter.adapter.ecj \
-                 ${spoofax}/org.spoofax.interpreter.library.eclipse \
-                 ${spoofax}/org.spoofax.interpreter.library.java \
-                 ${spoofax}/org.spoofax.jsglr \
-                 ${spoofax}/org.spoofax.terms \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.aster \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.aterm \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.editorservice \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.pp \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.rtg \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.sdf \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.template \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.spoofax \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.stratego \
-                 ${spoofaxImp}/org.strategoxt.imp.editors.spoofax.configuration \
-                 ${spoofaxImp}/org.strategoxt.imp.names \
-                 ${spoofaxImp}/org.strategoxt.imp.testing \
-                 ${spoofaxImp}/org.strategoxt.imp.testing.ui \
-                 ${spoofaxImp}/org.strategoxt.imp.feature \
-                 ${spoofaxImp}/org.strategoxt.imp.generator \
-                 ${spoofaxImp}/org.strategoxt.imp.spoofax.generator \
-                 ${spoofaxImp}/org.strategoxt.imp.metatooling \
-                 ${spoofaxImp}/org.strategoxt.imp.nativebundle \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.main \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.legacy \
-                 ${spoofaxImp}/org.strategoxt.imp.runtime.sidebyside.latest \
-                 ${spoofaxImp}/org.strategoxt.imp.updatesite \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.core \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.core \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.runtime \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.test \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.stratego.transformer \
-                 ${spoofaxImp}/org.strategoxt.imp.debug.ui
+                 ${mbexec}/org.spoofax.compiler \
+                 ${mbexec}/org.spoofax.interpreter.core \
+                 ${mbexec}/org.spoofax.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.ui \
+                 ${mbexec}/org.spoofax.interpreter.library.xml \
+                 ${mbexec}/org.spoofax.interpreter.library.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.library.jline \
+                 ${mbexec}/org.spoofax.interpreter.adapter.ecj \
+                 ${mbexec}/org.spoofax.interpreter.library.eclipse \
+                 ${mbexec}/org.spoofax.interpreter.library.java \
+                 ${mbrep}/org.spoofax.interpreter.library.index \
+                 ${mbrep}/org.spoofax.aterm \
+                 ${mbrep}/org.spoofax.terms \
+                 ${mbrep}/org.strategoxt.imp.editors.aterm \
+                 ${jsglr}/org.spoofax.jsglr \
+                 ${jsglr}/org.spoofax.interpreter.library.jsglr \
+                 ${sdf}/org.strategoxt.imp.editors.sdf \
+                 ${sdf}/org.strategoxt.imp.editors.template \
+                 ${stratego}/org.strategoxt.imp.editors.stratego \
+                 ${aster}/org.strategoxt.imp.editors.aster \
+                 ${esv}/org.strategoxt.imp.editors.editorservice \
+                 ${box}/org.strategoxt.imp.editors.pp \
+                 ${rtg}/org.strategoxt.imp.editors.rtg \
+                 ${spx}/org.strategoxt.imp.editors.spoofax \
+                 ${spx}/org.spoofax.interpreter.library.language \
+                 ${spx}/org.strategoxt.imp.editors.spoofax.configuration \
+                 ${spx}/org.strategoxt.imp.spoofax.generator \
+                 ${nabl}/org.strategoxt.imp.names \
+                 ${spt}/org.strategoxt.imp.testing \
+                 ${spt}/org.strategoxt.imp.testing.ui \
+                 ${spoofax}/org.strategoxt.imp.generator \
+                 ${spoofax}/org.strategoxt.imp.metatooling \
+                 ${spoofax}/org.strategoxt.imp.nativebundle \
+                 ${spoofax}/org.strategoxt.imp.runtime \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.main \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.legacy \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.latest \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.runtime \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.test \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.transformer \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.ui \
+                 ${spoofaxdeploy}/org.strategoxt.imp.feature \
+                 ${spoofaxdeploy}/org.strategoxt.imp.updatesite
         do
           header "Copying $d"
           cp -R $d .
@@ -132,7 +149,7 @@
 
         cp -R ${shrike} com.ibm.wala.shrike
         cp -R ${lpgRuntime} lpg.runtime.java
-        cp -R ${strategoxtJavaBackend}/strategoxt-java-backend org.strategoxt.strj
+        cp -R ${strategoxt}/strategoxt-java-backend org.strategoxt.strj
             
         chmod -R +w .
         rm -rf \
@@ -145,8 +162,8 @@
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
         sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
 
-        header "Patching org.eclipse.imp using ${spoofaxImp}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
-        patch -p0 < ${spoofaxImp}/org.eclipse.imp/org.eclipse.imp.runtime.patch
+        header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
+        patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
         stopNest
                     
         stopNest
@@ -175,6 +192,7 @@
             
         mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
 
+        mkdir -p org.strategoxt.imp.generator/src-gen/org/strategoxt/imp/generator
         mkdir -p org.strategoxt.strj/java
         cp ${strcJava}/share/strc-java/strategoxt.jar org.strategoxt.strj/java/
 

From v.vergu+vc at gmail.com  Tue May  7 11:53:55 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Tue, 07 May 2013 09:53:55 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26116 -
	hydra/jobs/spoofax-git
Message-ID: <20130507095355.C0AFF108C013@mx3.tudelft.nl>

Author: VladVergu
Date: Tue May  7 09:53:55 2013
New Revision: 26116
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26116&sc=1

Log:
Renamed build file

Added:
   hydra/jobs/spoofax-git/spoofax-master-w-strj.nix
      - copied unchanged from r26112, hydra/jobs/spoofax-git/spoofax-master-strj.nix
Deleted:
   hydra/jobs/spoofax-git/spoofax-master-strj.nix

Copied: hydra/jobs/spoofax-git/spoofax-master-w-strj.nix (from r26112, hydra/jobs/spoofax-git/spoofax-master-strj.nix)
==============================================================================
--- /dev/null	00:00:00 1970	(empty, because file is newly added)
+++ hydra/jobs/spoofax-git/spoofax-master-w-strj.nix	Tue May  7 09:53:55 2013	(r26116, copy of r26112, hydra/jobs/spoofax-git/spoofax-master-strj.nix)
@@ -0,0 +1,398 @@
+{
+  nixpkgs ? ../../../nixpkgs
+
+, jsglr ? ../../../jsglr
+, mbexec ? ../../../mb-exec
+, mbexecdeps ? ../../../mb-exec-deps
+, mbrep ? ../../../mb-rep
+, nabl ? ../../../nabl
+, sdf ? ../../../sdf
+, esv ? ../../../esv
+, aster ? ../../../aster
+, box ? ../../../box
+, spx ? ../../../spx
+, rtg ? ../../../rtg
+, stratego ? ../../../stratego
+, spt ? ../../../spt
+, tdl ? ../../../tdl
+, spoofax ? { outPath = ../../../spoofax ; shortRev= 1234; }
+, spoofaxdebug ? ../../../spoofax-debug
+, spoofaxdeploy ? ../../../spoofax-deploy
+, spoofaximppatches ? ../../../spoofax-imp-patches
+
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
+, metaborgRuntime ? ../../../runtime-libraries
+
+, strategoxt ? { outPath = ../../../strategoxt ; rev = 1234; }
+, strategoxtCVersion ? ../../../strategoxt-cver
+, javaFront ? ../../../java-front
+
+, hydraConfig ? { outPath = ../../.; rev = 1234; }
+
+}:
+let
+  spoofaxRev = toString spoofax.shortRev ;
+
+  pkgs = import nixpkgs { system = "i686-linux"; };
+
+  orgEclipseImp = pkgs.fetchsvn {
+    url = http://dev.eclipse.org/svnroot/technology/org.eclipse.imp/trunk;
+    rev = 22255;
+    sha256 = "0mknky2wpqvpcaqnz1l6wh6p1p8zjmd299hlf1nnwm91paiqmm85";
+  };
+
+  jline = pkgs.fetchurl {
+    url = http://spoofax.org/mirror/extras/jline-1.0.jar;
+    sha256 = "6d35823d5ae86ea4c71bc653747d1234c1587662882a76738d2881fb409394ab";
+  };
+
+  shrike = pkgs.fetchsvn {
+    url = https://wala.svn.sourceforge.net/svnroot/wala/trunk/com.ibm.wala.shrike;
+    rev = 3073;
+    sha256 = "0y13i31xlhian5glk4cahbzxg4mky4q61qzc5g03qkg4d67k12zd";
+  };
+
+  guava = pkgs.fetchurl {
+    url = http://search.maven.org/remotecontent?filepath=com/google/guava/guava/14.0.1/guava-14.0.1.jar;
+    sha256 = "d69df3331840605ef0e5fe4add60f2d28e870e3820937ea29f713d2035d9ab97";
+  };
+
+  junit-benchmarks = pkgs.fetchurl {
+    url = http://labs.carrotsearch.com/download/junit-benchmarks/0.6.0/junit-benchmarks-0.6.0.zip;
+    sha256 = "07f189bd06e4294b329b4e3b0c7f54ce8236bba0393991a212a94cbb39ecd5b1";
+  };
+
+  eclipseFun = import ../../eclipse.nix pkgs ; 
+    
+  eclipse = eclipseFun {
+    name = "eclipse-plain";
+    src =  pkgs.fetchurl {
+      url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+      sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";
+    };
+  }; 
+
+  eclipseTest = eclipseFun {
+    name = "eclipse-spoofax-install-test";
+    src =  pkgs.fetchurl {
+      url = http://download.springsource.com/release/ECLIPSE/helios/SR1/eclipse-SDK-3.6.1-linux-gtk.tar.gz ;
+      sha256 = "0s48rjaswi8m5gan1zlqvfwb4l06x5nslkq41wpkrbyj9ka8gh4x";
+    };
+    updatesites = [ "file://${jobs.build}/site" ];
+    installIUs = [ "org.strategoxt.imp.feature.group" ];
+    dontInstall = true;
+  }; 
+
+  strj = (import ../strategoxt-java-bootstrap.nix {
+    inherit nixpkgs hydraConfig javaFront;
+    strategoxtJava = strategoxt;
+
+    baseline = (import ../strc-java.nix {
+      inherit nixpkgs hydraConfig;
+      strcJavaCheckout = strategoxtCVersion;
+    }).build { system = "i686-linux"; };
+    
+  }).bootstrap1;
+
+  jobs = with pkgs.lib; {
+    tests.install = eclipseTest;
+    src = pkgs.stdenv.mkDerivation {
+      name = "spoofax-imp-src-r${spoofaxRev}";
+
+
+      buildInputs = with pkgs; [ unzip ];
+
+      buildCommand = ''
+        ensureDir $out
+        cd $out
+            
+        header "Preparing org.eclipse.imp"
+    
+        for d in ${orgEclipseImp}/org.eclipse.imp.cheatsheets \
+                 ${orgEclipseImp}/org.eclipse.imp.java.hosted \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg.ide \
+                 ${orgEclipseImp}/org.eclipse.imp.lpg.metatooling \
+                 ${orgEclipseImp}/org.eclipse.imp.metatooling \
+                 ${orgEclipseImp}/org.eclipse.imp.preferences \
+                 ${orgEclipseImp}/org.eclipse.imp.prefspecs \
+                 ${orgEclipseImp}/org.eclipse.imp.presentation \
+                 ${orgEclipseImp}/org.eclipse.imp.runtime \
+                 ${orgEclipseImp}/org.eclipse.imp.smapi \
+                 ${orgEclipseImp}/org.eclipse.imp.smapifier \
+                 ${orgEclipseImp}/org.eclipse.imp.xform \
+                 ${mbexec}/org.spoofax.compiler \
+                 ${mbexec}/org.spoofax.interpreter.core \
+                 ${mbexec}/org.spoofax.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.ui \
+                 ${mbexec}/org.spoofax.interpreter.library.xml \
+                 ${mbexec}/org.spoofax.interpreter.library.interpreter \
+                 ${mbexec}/org.spoofax.interpreter.library.jline \
+                 ${mbexec}/org.spoofax.interpreter.adapter.ecj \
+                 ${mbexec}/org.spoofax.interpreter.library.eclipse \
+                 ${mbexec}/org.spoofax.interpreter.library.java \
+                 ${mbexecdeps}/org.spoofax.interpreter.externaldeps \
+                 ${metaborgRuntime}/org.metaborg.runtime.task \
+                 ${mbrep}/org.spoofax.interpreter.library.index \
+                 ${mbrep}/org.spoofax.aterm \
+                 ${mbrep}/org.spoofax.terms \
+                 ${mbrep}/org.strategoxt.imp.editors.aterm \
+                 ${jsglr}/org.spoofax.jsglr \
+                 ${jsglr}/org.spoofax.interpreter.library.jsglr \
+                 ${sdf}/org.strategoxt.imp.editors.sdf \
+                 ${sdf}/org.strategoxt.imp.editors.template \
+                 ${stratego}/org.strategoxt.imp.editors.stratego \
+                 ${aster}/org.strategoxt.imp.editors.aster \
+                 ${esv}/org.strategoxt.imp.editors.editorservice \
+                 ${box}/org.strategoxt.imp.editors.pp \
+                 ${rtg}/org.strategoxt.imp.editors.rtg \
+                 ${spx}/org.strategoxt.imp.editors.spoofax \
+                 ${spx}/org.spoofax.interpreter.library.language \
+                 ${spx}/org.strategoxt.imp.editors.spoofax.configuration \
+                 ${spx}/org.strategoxt.imp.spoofax.generator \
+                 ${nabl}/org.strategoxt.imp.names \
+                 ${spt}/org.strategoxt.imp.testing \
+                 ${spt}/org.strategoxt.imp.testing.ui \
+                 ${spoofax}/org.strategoxt.imp.generator \
+                 ${spoofax}/org.strategoxt.imp.metatooling \
+                 ${spoofax}/org.strategoxt.imp.nativebundle \
+                 ${spoofax}/org.strategoxt.imp.runtime \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.main \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.legacy \
+                 ${spoofax}/org.strategoxt.imp.runtime.sidebyside.latest \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.core \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.runtime \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.test \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.stratego.transformer \
+                 ${spoofaxdebug}/org.strategoxt.imp.debug.ui \
+                 ${spoofaxdeploy}/org.strategoxt.imp.feature \
+                 ${spoofaxdeploy}/org.strategoxt.imp.updatesite
+        do
+          header "Copying $d"
+          cp -R $d .
+          stopNest
+        done
+
+        cp -R ${shrike} com.ibm.wala.shrike
+        cp -R ${lpgRuntime} lpg.runtime.java
+        cp -R ${strategoxt}/strategoxt/stratego-libraries/java-backend org.strategoxt.strj
+        
+        chmod -R +w .
+        ensureDir org.spoofax.interpreter.externaldeps/lib
+        cp ${guava} org.spoofax.interpreter.externaldeps/lib/guava.jar
+        unzip ${junit-benchmarks} -d org.spoofax.interpreter.externaldeps/lib/
+            
+        chmod -R +w .
+        rm -rf \
+              org.spoofax.jsglr/src/org/spoofax/jsglr/shared/RemoteParseTableService* \
+              org.spoofax.jsglr/src/org/spoofax/client/JSGLREntryPoint.java \
+              org.spoofax.jsglr/src/org/spoofax/jsglr/server/RemoteParseTableServiceImpl.java \
+              org.spoofax.terms/src/org/spoofax/gwt/
+        sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
+
+        header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
+        patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
+        stopNest
+                    
+        stopNest
+      '';
+    };
+
+    build = pkgs.stdenv.mkDerivation rec {
+      name = "spoofax-imp-r${spoofaxRev}";
+      inherit (jobs) src;
+
+      buildInputs = with pkgs; [ maven3 strj pkgconfig which ecj openjdk apacheAntOpenJDK strategoPackages.sdf ];
+      mvnFlags = "-Dversion=1.0.0-SNAPSHOT -DgroupId=spoofax -Dtycho.targetPlatform=${eclipse}/eclipse -Dmaven.repo.local=/tmp/m3";
+
+      M2_REPO="/tmp/m3";
+      MAVEN_OPTS="-Xss8m -Xmx1024m";
+      STRATEGOXT=pkgs.strategoPackages.strategoxt;
+      JAVA_FRONT=pkgs.strategoPackages.javafront;
+      SDF=pkgs.strategoPackages.sdf;
+
+      buildPhase = ''
+        ulimit -s unlimited
+
+        #hack
+        mkdir -p plugins
+        export eclipsefakehome=`pwd`
+            
+        mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
+
+        mkdir -p org.strategoxt.imp.generator/src-gen/org/strategoxt/imp/generator
+        mkdir -p org.strategoxt.strj/java
+        cp ${strj}/share/strategoxt/strategoxt.jar org.strategoxt.strj/java/
+
+        header "Building org.strategoxt.imp.generator"
+        make -C org.strategoxt.imp.generator all
+        stopNest
+
+        for e in */build.generated.xml
+        do
+          POM=`dirname $e`/pom.xml
+          if [[ -f $POM ]] ; then
+             sed -i 's|</project>||' $POM
+             echo '
+  <build>
+    <plugins>
+ <plugin>
+    <groupId>org.apache.maven.plugins</groupId>
+    <artifactId>maven-antrun-plugin</artifactId>
+    <dependencies>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>aster</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/aster.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>strategoxt</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.strj/java/strategoxt.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>sdf2imp</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/sdf2imp.jar</systemPath>
+        </dependency>
+        <dependency>
+            <groupId>local</groupId>
+            <artifactId>make_permissive.jar</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/make_permissive.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>com.sun</groupId>
+            <artifactId>tools</artifactId>
+            <version>1.4.2</version>
+            <scope>system</scope>
+            <systemPath>''${java.home}/../lib/tools.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>ecj</groupId>
+            <artifactId>ecj</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>${pkgs.ecj}/lib/java/ecj.jar</systemPath>
+        </dependency>
+        <dependency>
+           <groupId>jline</groupId>
+            <artifactId>jline</artifactId>
+            <version>1.0</version>
+            <scope>system</scope>
+            <systemPath>''${basedir}/../org.spoofax.interpreter.library.jline/lib/jline-1.0.jar</systemPath>
+        </dependency>
+    </dependencies>
+    <executions>
+       <execution>
+               <id>generate-sources</id>
+               <phase>generate-sources</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="externaljarx" refid="maven.compile.classpath"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
+                          <property name="eclipse.home" value="${eclipse}/eclipse"/>
+                          <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+                          <ant antfile="build.main.xml" inheritRefs="true">
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+       <execution>
+               <id>process-classes</id>
+               <phase>process-classes</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
+                          <property name="eclipse.home" value="${eclipse}/eclipse"/>
+                          <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
+                          <ant antfile="build.main.xml" inheritRefs="true">
+                            <target name="java.jar"/> 
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+    </executions>
+  </plugin>
+    </plugins>
+</build></project>' >>$POM
+          fi
+        done
+
+        for e in */build.ant.xml
+        do
+          POM=`dirname $e`/pom.xml
+          if [[ -f $POM ]] ; then
+             sed -i 's|</project>||' $POM
+             echo '
+  <build>
+    <plugins>
+ <plugin>
+    <groupId>org.apache.maven.plugins</groupId>
+    <artifactId>maven-antrun-plugin</artifactId>
+    <executions>
+       <execution>
+               <id>generate-sources</id>
+               <phase>generate-sources</phase>
+               <configuration>
+                  <tasks>
+                          <echo>Running ant script</echo>
+                          <property name="strategoxt.dir" value="${STRATEGOXT}"/>
+                          <property name="sdf.dir" value="${SDF}"/>
+                          <ant antfile="build.ant.xml" inheritRefs="true">
+                              <target name="bundle-ctree" />
+                          </ant>
+                  </tasks>
+               </configuration>
+               <goals>
+                  <goal>run</goal>
+               </goals>
+       </execution>
+    </executions>
+  </plugin>
+    </plugins>
+</build></project>' >>$POM
+          fi
+        done
+
+        mvn package ${mvnFlags} -e
+        mvn integration-test ${mvnFlags} -e
+      '';
+          
+      installPhase = ''
+        ensureDir $out/nix-support
+        cp -Rv org.strategoxt.imp.updatesite/target/site $out/
+        touch $out/site/index.html
+        cd $out
+        tar cvzf $out/${name}.tar.gz site
+        echo "file site $out/site" >> $out/nix-support/hydra-build-products
+        echo "file tar $out/${name}.tar.gz" >> $out/nix-support/hydra-build-products
+      '';
+
+       __noChroot = true;
+       meta.maintainers = ["lclkats at gmail.com" "m.dejonge at tudelft.nl" "rob.vermaas at gmail.com" "karltk at strategoxt.org" "g.h.wachsmuth at tudelft.nl" "gabrielkonat at gmail.com" "v.vergu at gmail.com"];
+     } ;     
+  } ;
+
+in jobs

From g.h.wachsmuth at tudelft.nl  Tue May  7 19:35:50 2013
From: g.h.wachsmuth at tudelft.nl (Guido Wachsmuth)
Date: Tue, 07 May 2013 17:35:50 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26117 -
	spoofax-imp/branches/nbl-dev/trans/generation2
Message-ID: <20130507173550.ABD41108C008@mx3.tudelft.nl>

Author: GuidoWachsmuth
Date: Tue May  7 17:35:48 2013
New Revision: 26117
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26117&sc=1

Log:
handling external definitions at definition sites

Modified:
   spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str

Modified: spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str
==============================================================================
--- spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Tue May  7 09:53:55 2013	(r26116)
+++ spoofax-imp/branches/nbl-dev/trans/generation2/import-sites.str	Tue May  7 17:35:48 2013	(r26117)
@@ -25,11 +25,12 @@
       cong* := <filter-with-index(to-import-clauses(|pattern, bound*, repl*, i)); concat; nonempty> clause*
     ; seq   := <to-seq> [task*, cong*]
   
-  to-import-clauses(|pattern, bound*, repl*, i):
-    (j, DefClause(_, _, _, term, _, DefScopes(ds*), _)) -> [IMPORT_CALL([SINGLE(term, scope, [])])]
-    where
-      ds'*  := <filter(?DefScope(_)); nonempty> ds*
-    ; scope := <scope-to-term> DefScopes(ds'*)
+  // should be handled at def-site instead
+  // to-import-clauses(|pattern, bound*, repl*, i):
+  //   (j, DefClause(_, _, _, term, _, DefScopes(ds*), _)) -> [IMPORT_CALL([SINGLE(term, scope, [])])]
+  //   where
+  //     ds'*  := <filter(?DefScope(_)); nonempty> ds*
+  //   ; scope := <scope-to-term> DefScopes(ds'*)
     
   to-import-clauses(|pattern, bound*, repl*, i):
     (j, clause at ImportClause(part*)) -> [clause*, IMPORT_CALL(import*)]

From v.vergu at gmail.com  Wed May  8 11:02:59 2013
From: v.vergu at gmail.com (Vlad Vergu)
Date: Wed, 8 May 2013 11:02:59 +0200
Subject: [Stratego-commits] migration svn -> git of spoofax, jsglr, terms,
	interpreter !!
In-Reply-To: <E5FC2445-3135-4A6B-8719-C186745B690B@gmail.com>
References: <CC500A18-2B00-4562-B1B4-3E0B61D8BCD7@gmail.com>
	<E5FC2445-3135-4A6B-8719-C186745B690B@gmail.com>
Message-ID: <B70935EB-38DA-4119-8AFA-E4E2CA5B8887@gmail.com>

Dear all,

This email is an update on migration of source code repositories for the Stratego and Spoofax projects. It is directed at developers of Stratego and Spoofax. If you are a user and not a developer you can safely ignore this email as this migration will be transparent to you.



Dear developers,

I am writing as promised to update you on the progress of the migration from SVN to Git.

Everything is on or ahead of schedule. Thank you for your comments and suggestions on the health of the Git repositories; they are all implemented in the new repositories. I'm attaching an updated diagram to help you track down where everything is. All repositories have been migrated to GitHub under the Metaborg organisation. 

The links to the new repositories are:

git://github.com/metaborg/jsglr
git://github.com/metaborg/mb-exec
git://github.com/metaborg/mb-exec-deps
git://github.com/metaborg/mb-rep
git://github.com/metaborg/aster
git://github.com/metaborg/esv
git://github.com/metaborg/sdf
git://github.com/metaborg/nabl
git://github.com/metaborg/box
git://github.com/metaborg/spx
git://github.com/metaborg/spt
git://github.com/metaborg/stratego
git://github.com/metaborg/tdl
git://github.com/metaborg/rtg
git://github.com/metaborg/spoofax
git://github.com/metaborg/spoofax-debug
git://github.com/metaborg/spoofax-deploy
git://github.com/metaborg/spoofax-imp-patches
git://github.com/metaborg/spoofax-imp-archive

You may begin pushing commits to these. The SVN aster, spoofax, spoofax-imp, sglr-recovery/trunk/permissive-grammars directories do not accept any new commits.

The updated plan for the remaining things:

1. Next few hours: Expected Spoofax nightly update site to become available again, containing the last builds from SVN.
2. Wed 08-05 15:00: First nightly builds based on the Git repositories available.
3. Wed 08-05 18:00: Stable update site contains stable version built from Git.
4. Wed 08-05 22:00: Other CI jobs (e.g: interpreter, jsglr, spoofax-mdsd, spoofax-unstable) switched over to Git sources and producing builds.

I will email you again (1) if something drastic changes and (2) after step 3 is completed.

Cheers,

Vlad 


On May 4, 2013, at 3:05 PM, Vlad Vergu <v.vergu at gmail.com> wrote:

> Dear all,
> 
> This email concerns the migration of source code repositories for the Stratego and Spoofax projects. It is directed at developers of Stratego and Spoofax. If you are a user and not a developer you can safely ignore this email as this migration will be transparent to you.
> 
> 
> 
> Dear developers,
> 
> 
> You are receiving this email because (1) i'm migrating many of Spoofax and Stratego related projects to Git, (2) i need your assistance and (3) it is likely that it concerns your current/previous work. 
> 
> 
> For the past week or so i've been working on migrating to GitHub everything that is in the spoofax and spoofax-imp directories of the StrategoXT SVN repository. At the same time i've split the two folders up into 18 separate Git repositories each with its own history. This was/is a non-trivial endeavour requiring understanding of each project's history for the last decade and lots of regular expressions, thus very error prone. As far as I can tell all history is preserved and things appear to be complete.
> 
> 
> My first request to you is that you carefully review the contents and histories of the resulting Git repositories (below) and report any irregularities that you discover. It is crucial that the new repositories preserve history and your feedback is therefore invaluable. Please look at code you have contributed to as well as to the rest of the codebase to check for continuity, missing files, etc. I've attached a diagram that explains how each folder from the spoofax/trunk/spoofax and spoofax-imp/trunk directories corresponds to Git repos. I kindly ask you to check these repositories by coming Tuesday and report any issues you discover, no matter how minor or major.
> 
> After i've fixed the problems that you report i will (1) make the spoofax and spoofax-imp directories read-only on SVN and (2) create new Git repositories based on the then latest revisions.
> 
> Before anything: Do not develop anything against the Git repositories mentioned below. They are temporary and only for review. After i've received all of your comments I will delete these repositories and i will make new ones based on the latest SVN revisions and according to the planning below. You can distinguish the temporary from the permanent repositories by the presence/absence of the MIG- prefix in their names.
> 
> The new (temporary) repositories are hosted on GitHub at the following addresses:
> 
> https://github.com/metaborg-testing/MIG-jsglr
> https://github.com/metaborg-testing/MIG-mb-exec
> https://github.com/metaborg-testing/MIG-mb-exec-deps
> https://github.com/metaborg-testing/MIG-mb-rep
> https://github.com/metaborg-testing/MIG-aster
> https://github.com/metaborg-testing/MIG-esv
> https://github.com/metaborg-testing/MIG-sdf
> https://github.com/metaborg-testing/MIG-nabl
> https://github.com/metaborg-testing/MIG-box
> https://github.com/metaborg-testing/MIG-spx
> https://github.com/metaborg-testing/MIG-spt
> https://github.com/metaborg-testing/MIG-stratego
> https://github.com/metaborg-testing/MIG-tdl
> https://github.com/metaborg-testing/MIG-rtg
> https://github.com/metaborg-testing/MIG-spoofax
> https://github.com/metaborg-testing/MIG-spoofax-debug
> https://github.com/metaborg-testing/MIG-spoofax-deploy
> https://github.com/metaborg-testing/MIG-spoofax-imp-patches
> https://github.com/metaborg-testing/MIG-spoofax-imp-archive
> 
> 
> The final repositories will also be hosted on GitHub, under the Metaborg organisation.
> 
> 
> There a few known issues with the new repositories:
> 
> 1. Branches that could never non-destructively be merged into back into the trunk have been archived as tags. The are those SVN branches that branched on a particular directory of the trunk instead of the entire trunk. This was a standard practice in the SVN-era but it results in Git branch commits that delete everything that was not branched. The net effect of merging those back into master would be that of deleting everything else but your work. The tags that archive these branches preserve history of the branch and the branches can later be revived if necessary.
> 
> 2. Some deleted branches (e.g: spoofax-new-terms) have reappeared as tags. This was intentional. If you happen to spot a previously deleted branch which is not tagged, please report it. Branch-deletion in Git is destructive and history would be lost unless we tag the deleted branches.
> 
> 3. The old Spoofax editor (first version started in ~2005) is not yet migrated. This is the big red-colored repository in the diagram. This will be migrated later, separately, as one big read-only Git repository. 
> 
> 
> To summarise, i kindly ask you to:
> 
> 1. Examine and give feedback on the health of the MIG- repositories by cob of coming Tuesday. Do pay special attention to missing or corrupted files, branches, tags, history or committer-info. 
> 
> 2. Avoid branching/merging in the spoofax and spoofax-imp directories. If you do so, then (1) branch the entire trunk of the respective folder (this will ensure merge-able branches) and (2) notify me. The migration is like a white-list so anything not explicitly mentioned in it does not get copied. 
> 
> 3. Avoid deleting, creating or renaming folders at the spoofax/[ trunk | branches | tags ]/spoofax or spoofax-imp/[ trunk | branches | tags ] roots. If you do, please let me know. Things will not be copied over unless I explicitly mention them in the migration script. Making changes to subdirectories, such as spoofax/trunk/spoofax/foobar/, is fine. In other words, you can safely continue your work but don't start new things in the SVN repository. 
> 
> 
> This migration has a few more steps, here's the tentative plan (depending on the problems you discover):
> 
> 1. Wed 08-05 8:00 AM : make the spoofax and spoofax-imp directories on SVN read-only. At this stage you shouldn't have any uncommitted changes anymore. 
> 2. Wed 08-05 12:00 PM : all your reported issues should be fixed in the migration scripts.
> 3. Wed 08-05 1:30 PM : final Git repositories published at GitHub Metaborg organisation.
> 4. Wed 08-05 6:00 PM : the Hydra build-farm should have the first build results available based on the Git repositories. This means builds of the stable, master and unstable branches.
> 5. Thu 09-05 8:00 PM : all Spoofax update sites should be pointing/containing builds based on the Git repositories.
> 
> 
> I'll email you again (1) if something changes in the above plan and (2) after steps 3 and 5 are completed.
> 
> Thank you for your help.
> 
> 
> Cheers,
> 
> Vlad
>> 
> <migration_diagram.pdf>
> 
> 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://mailman.st.ewi.tudelft.nl/pipermail/stratego-commits/attachments/20130508/c1bb5ec8/attachment-0002.html>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: migration.pdf
Type: application/pdf
Size: 171861 bytes
Desc: not available
URL: <https://mailman.st.ewi.tudelft.nl/pipermail/stratego-commits/attachments/20130508/c1bb5ec8/attachment-0001.pdf>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <https://mailman.st.ewi.tudelft.nl/pipermail/stratego-commits/attachments/20130508/c1bb5ec8/attachment-0003.html>

From dgroenewegen at gmail.com  Mon May 13 09:35:53 2013
From: dgroenewegen at gmail.com (Danny Groenewegen)
Date: Mon, 13 May 2013 07:35:53 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26118 - hydra/webdsl
Message-ID: <20130513073554.039E9CC1D2@mx4.tudelft.nl>

Author: dgroenewegen
Date: Mon May 13 07:35:52 2013
New Revision: 26118
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26118&sc=1

Log:
disable researchr builds on hydra to keep source private

Modified:
   hydra/webdsl/tests-separate-compilation.nix
   hydra/webdsl/tests.nix

Modified: hydra/webdsl/tests-separate-compilation.nix
==============================================================================
--- hydra/webdsl/tests-separate-compilation.nix	Tue May  7 17:35:48 2013	(r26117)
+++ hydra/webdsl/tests-separate-compilation.nix	Mon May 13 07:35:52 2013	(r26118)
@@ -56,7 +56,7 @@
   
 in
 {
-  researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
+  # researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc [];
   yellowgrass_webservices = { yellowgrasswebservicesSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrasswebservicesSrc [];

Modified: hydra/webdsl/tests.nix
==============================================================================
--- hydra/webdsl/tests.nix	Tue May  7 17:35:48 2013	(r26117)
+++ hydra/webdsl/tests.nix	Mon May 13 07:35:52 2013	(r26118)
@@ -53,7 +53,7 @@
 
 in
 {
-  researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
+  # researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
   webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
   yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ["chrismelman at hotmail.com""s.d.vermolen at tudelft.nl"] ;
   reposearch  = { reposearchSrc ? { outPath = ../../webdslorg; rev = 1234; } }    : build "reposearch" reposearchSrc [];

From v.vergu+vc at gmail.com  Mon May 13 15:25:49 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 13 May 2013 13:25:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26119 -
	hydra/jobs/spoofax-git
Message-ID: <20130513132550.00B967F8037@mx1.tudelft.nl>

Author: VladVergu
Date: Mon May 13 13:25:49 2013
New Revision: 26119
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26119&sc=1

Log:
Change version numbering from git hash to revCount

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 07:35:52 2013	(r26118)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 13:25:49 2013	(r26119)
@@ -26,8 +26,11 @@
 
 }:
 let
-  spoofaxRev = toString spoofax.shortRev ;
-
+  max = a : b : ( if builtins.lessThan a b then b else a );
+  maxrev = xs : pkgs.lib.foldl max 0 xs ;
+  
+  spoofaxRev = toString (maxrev [jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metborgRuntime.revCount]) ;  
+  
   pkgs = import nixpkgs { system = "i686-linux"; };
 
   orgEclipseImp = pkgs.fetchsvn {

From v.vergu+vc at gmail.com  Mon May 13 15:48:44 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 13 May 2013 13:48:44 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26120 -
	hydra/jobs/spoofax-git
Message-ID: <20130513134844.CC5102B8002@mx2.tudelft.nl>

Author: VladVergu
Date: Mon May 13 13:48:43 2013
New Revision: 26120
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26120&sc=1

Log:
Typo

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 13:25:49 2013	(r26119)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 13:48:43 2013	(r26120)
@@ -29,7 +29,7 @@
   max = a : b : ( if builtins.lessThan a b then b else a );
   maxrev = xs : pkgs.lib.foldl max 0 xs ;
   
-  spoofaxRev = toString (maxrev [jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metborgRuntime.revCount]) ;  
+  spoofaxRev = toString (maxrev [jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metaborgRuntime.revCount]) ;  
   
   pkgs = import nixpkgs { system = "i686-linux"; };
 

From v.vergu+vc at gmail.com  Mon May 13 17:12:08 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 13 May 2013 15:12:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26121 -
	hydra/jobs/spoofax-git
Message-ID: <20130513151209.010182B800F@mx2.tudelft.nl>

Author: VladVergu
Date: Mon May 13 15:12:08 2013
New Revision: 26121
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26121&sc=1

Log:
Switching to -s### suffix to hopefully convince old versions to update.

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 13:48:43 2013	(r26120)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 15:12:08 2013	(r26121)
@@ -89,7 +89,7 @@
   jobs = with pkgs.lib; {
     tests.install = eclipseTest;
     src = pkgs.stdenv.mkDerivation {
-      name = "spoofax-imp-src-r${spoofaxRev}";
+      name = "spoofax-imp-src-s${spoofaxRev}";
 
 
       buildInputs = with pkgs; [ unzip ];
@@ -182,9 +182,9 @@
               org.spoofax.jsglr/src/org/spoofax/jsglr/server/RemoteParseTableServiceImpl.java \
               org.spoofax.terms/src/org/spoofax/gwt/
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.updatesite/site.xml
-        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-s${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
-        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-s${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
 
         header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
         patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
@@ -195,7 +195,7 @@
     };
 
     build = pkgs.stdenv.mkDerivation rec {
-      name = "spoofax-imp-r${spoofaxRev}";
+      name = "spoofax-imp-s${spoofaxRev}";
       inherit (jobs) src;
           
       buildInputs = with pkgs; [ maven3 strcJava pkgconfig which ecj openjdk apacheAntOpenJDK];

From v.vergu+vc at gmail.com  Mon May 13 21:35:10 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 13 May 2013 19:35:10 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26122 -
	hydra/jobs/spoofax-git
Message-ID: <20130513193510.B69AE7F8025@mx1.tudelft.nl>

Author: VladVergu
Date: Mon May 13 19:35:08 2013
New Revision: 26122
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26122&sc=1

Log:
Making ${spoofaxRev} monotonically increasing by summing up all revCounts of all inputs

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 15:12:08 2013	(r26121)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 19:35:08 2013	(r26122)
@@ -1,36 +1,36 @@
 {
   nixpkgs ? ../../../nixpkgs
-, jsglr ? ../../../jsglr
-, mbexec ? ../../../mb-exec
-, mbexecdeps ? ../../../mb-exec-deps
-, mbrep ? ../../../mb-rep
-, nabl ? ../../../nabl
-, sdf ? ../../../sdf
-, esv ? ../../../esv
-, aster ? ../../../aster
-, box ? ../../../box
-, spx ? ../../../spx
-, rtg ? ../../../rtg
-, stratego ? ../../../stratego
-, spt ? ../../../spt
-, tdl ? ../../../tdl
-, spoofax ? { outPath = ../../../spoofax ; shortRev= 1234; }
-, spoofaxdebug ? ../../../spoofax-debug
-, spoofaxdeploy ? ../../../spoofax-deploy
-, spoofaximppatches ? ../../../spoofax-imp-patches
+, jsglr ? { outPath = ../../../jsglr ; revCount = 9999; }
+, mbexec ? { outPath = ../../../mb-exec ; revCount = 9999; }
+, mbexecdeps ? { outPath = ../../../mb-exec-deps ; revCount = 9999; }
+, mbrep ? { outPath = ../../../mb-rep ; revCount = 9999; }
+, nabl ? { outPath = ../../../nabl ; revCount = 9999; }
+, sdf ? { outPath = ../../../sdf ; revCount = 9999; }
+, esv ? { outPath = ../../../esv ; revCount = 9999; }
+, aster ? { outPath = ../../../aster ; revCount = 9999; }
+, box ? { outPath = ../../../box ; revCount = 9999; }
+, spx ? { outPath = ../../../spx ; revCount = 9999; }
+, rtg ? { outPath = ../../../rtg ; revCount = 9999; }
+, stratego ? { outPath = ../../../stratego ; revCount = 9999; }
+, spt ? { outPath = ../../../spt ; revCount = 9999; }
+, tdl ? { outPath = ../../../tdl ; revCount = 9999; }
+, spoofax ? { outPath = ../../../spoofax ; revCount = 9999; }
+, spoofaxdebug ? { outPath = ../../../spoofax-debug ; revCount = 9999; }
+, spoofaxdeploy ? { outPath = ../../../spoofax-deploy ; revCount = 9999; }
+, spoofaximppatches ? { outPath = ../../../spoofax-imp-patches ; revCount = 9999; }
 
-, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
-, metaborgRuntime ? { outPath = ../../../runtime-libraries; }
-, strategoxt ? ../../../strategoxt-cver
-, hydraConfig ? { outPath = ../../.; rev = 1234; }
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; revCount = 9999; }
+, metaborgRuntime ? { outPath = ../../../runtime-libraries ; revCount = 9999; }
+, strategoxt ? { outPath = ../../../strategoxt-cver ; revCount = 9999; }
+, hydraConfig ? { outPath = ../../.; revCount = 9999; }
 
 }:
 let
-  max = a : b : ( if builtins.lessThan a b then b else a );
-  maxrev = xs : pkgs.lib.foldl max 0 xs ;
-  
-  spoofaxRev = toString (maxrev [jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metaborgRuntime.revCount]) ;  
+  plus = a : b : ( builtins.add a b );
+  sumrev = xs : pkgs.lib.foldl plus 0 xs ;
   
+  spoofaxRev = toString (sumrev [lpgRuntime.revCount jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metaborgRuntime.revCount]) ;
+
   pkgs = import nixpkgs { system = "i686-linux"; };
 
   orgEclipseImp = pkgs.fetchsvn {

From v.vergu+vc at gmail.com  Mon May 13 21:39:19 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 13 May 2013 19:39:19 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26123 -
	hydra/jobs/spoofax-git
Message-ID: <20130513193919.BA8C9108C008@mx3.tudelft.nl>

Author: VladVergu
Date: Mon May 13 19:39:19 2013
New Revision: 26123
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26123&sc=1

Log:
Same fix for stable release, hopefully

Modified:
   hydra/jobs/spoofax-git/spoofax-release.nix

Modified: hydra/jobs/spoofax-git/spoofax-release.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-release.nix	Mon May 13 19:35:08 2013	(r26122)
+++ hydra/jobs/spoofax-git/spoofax-release.nix	Mon May 13 19:39:19 2013	(r26123)
@@ -1,31 +1,34 @@
 {
   nixpkgs ? ../../../nixpkgs
-, jsglr ? ../../../jsglr
-, mbexec ? ../../../mb-exec
-, mbexecdeps ? ../../../mb-exec-deps
-, mbrep ? ../../../mb-rep
-, nabl ? ../../../nabl
-, sdf ? ../../../sdf
-, esv ? ../../../esv
-, aster ? ../../../aster
-, box ? ../../../box
-, spx ? ../../../spx
-, rtg ? ../../../rtg
-, stratego ? ../../../stratego
-, spt ? ../../../spt
-, tdl ? ../../../tdl
-, spoofax ? { outPath = ../../../spoofax ; shortRev= 1234; }
-, spoofaxdebug ? ../../../spoofax-debug
-, spoofaxdeploy ? ../../../spoofax-deploy
-, spoofaximppatches ? ../../../spoofax-imp-patches
+, jsglr ? { outPath = ../../../jsglr ; revCount = 9999; }
+, mbexec ? { outPath = ../../../mb-exec ; revCount = 9999; }
+, mbexecdeps ? { outPath = ../../../mb-exec-deps ; revCount = 9999; }
+, mbrep ? { outPath = ../../../mb-rep ; revCount = 9999; }
+, nabl ? { outPath = ../../../nabl ; revCount = 9999; }
+, sdf ? { outPath = ../../../sdf ; revCount = 9999; }
+, esv ? { outPath = ../../../esv ; revCount = 9999; }
+, aster ? { outPath = ../../../aster ; revCount = 9999; }
+, box ? { outPath = ../../../box ; revCount = 9999; }
+, spx ? { outPath = ../../../spx ; revCount = 9999; }
+, rtg ? { outPath = ../../../rtg ; revCount = 9999; }
+, stratego ? { outPath = ../../../stratego ; revCount = 9999; }
+, spt ? { outPath = ../../../spt ; revCount = 9999; }
+, tdl ? { outPath = ../../../tdl ; revCount = 9999; }
+, spoofax ? { outPath = ../../../spoofax ; revCount = 9999; }
+, spoofaxdebug ? { outPath = ../../../spoofax-debug ; revCount = 9999; }
+, spoofaxdeploy ? { outPath = ../../../spoofax-deploy ; revCount = 9999; }
+, spoofaximppatches ? { outPath = ../../../spoofax-imp-patches ; revCount = 9999; }
 
-, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 1234; }
-, strategoxt ? ../../../strategoxt
-, hydraConfig ? { outPath = ../../.; rev = 1234; }
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; revCount = 9999; }
+, strategoxt ? { outPath = ../../../strategoxt-cver ; revCount = 9999; }
+, hydraConfig ? { outPath = ../../.; revCount = 9999; }
 
 }:
 let 
-  spoofaxRev = toString spoofax.shortRev ;
+  plus = a : b : ( builtins.add a b );
+  sumrev = xs : pkgs.lib.foldl plus 0 xs ;
+  
+  spoofaxRev = toString (sumrev [lpgRuntime.revCount jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount]) ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 

From v.vergu+vc at gmail.com  Mon May 13 21:40:40 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Mon, 13 May 2013 19:40:40 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26124 -
	hydra/jobs/spoofax-git
Message-ID: <20130513194040.C741ACC1DF@mx4.tudelft.nl>

Author: VladVergu
Date: Mon May 13 19:40:40 2013
New Revision: 26124
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26124&sc=1

Log:
And suffix change

Modified:
   hydra/jobs/spoofax-git/spoofax-release.nix

Modified: hydra/jobs/spoofax-git/spoofax-release.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-release.nix	Mon May 13 19:39:19 2013	(r26123)
+++ hydra/jobs/spoofax-git/spoofax-release.nix	Mon May 13 19:40:40 2013	(r26124)
@@ -78,7 +78,7 @@
   jobs = with pkgs.lib; {
     tests.install = eclipseTest;
     src = pkgs.stdenv.mkDerivation {
-      name = "spoofax-imp-src-r${spoofaxRev}";
+      name = "spoofax-imp-src-s${spoofaxRev}";
 
       buildCommand = ''
         ensureDir $out
@@ -161,9 +161,9 @@
               org.spoofax.jsglr/src/org/spoofax/jsglr/server/RemoteParseTableServiceImpl.java \
               org.spoofax.terms/src/org/spoofax/gwt/
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.updatesite/site.xml
-        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-s${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
-        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-s${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
 
         header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
         patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
@@ -174,7 +174,7 @@
     };
 
     build = pkgs.stdenv.mkDerivation rec {
-      name = "spoofax-imp-r${spoofaxRev}";
+      name = "spoofax-imp-s${spoofaxRev}";
       inherit (jobs) src;
           
       buildInputs = with pkgs; [ maven3 strcJava pkgconfig which ecj openjdk apacheAntOpenJDK];

From v.vergu+vc at gmail.com  Tue May 14 19:10:11 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Tue, 14 May 2013 17:10:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26125 -
	hydra/jobs/spoofax-git
Message-ID: <20130514171011.DFB9ECC235@mx4.tudelft.nl>

Author: VladVergu
Date: Tue May 14 17:10:10 2013
New Revision: 26125
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26125&sc=1

Log:
Maybe svn checkouts don't have a revCount

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Mon May 13 19:40:40 2013	(r26124)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Tue May 14 17:10:10 2013	(r26125)
@@ -19,7 +19,7 @@
 , spoofaxdeploy ? { outPath = ../../../spoofax-deploy ; revCount = 9999; }
 , spoofaximppatches ? { outPath = ../../../spoofax-imp-patches ; revCount = 9999; }
 
-, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; revCount = 9999; }
+, lpgRuntime ? { outPath = ../../../lpg.runtime.java ; rev = 9999; }
 , metaborgRuntime ? { outPath = ../../../runtime-libraries ; revCount = 9999; }
 , strategoxt ? { outPath = ../../../strategoxt-cver ; revCount = 9999; }
 , hydraConfig ? { outPath = ../../.; revCount = 9999; }
@@ -29,7 +29,7 @@
   plus = a : b : ( builtins.add a b );
   sumrev = xs : pkgs.lib.foldl plus 0 xs ;
   
-  spoofaxRev = toString (sumrev [lpgRuntime.revCount jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metaborgRuntime.revCount]) ;
+  spoofaxRev = toString (sumrev [lpgRuntime.rev jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metaborgRuntime.revCount]) ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 

From v.vergu+vc at gmail.com  Wed May 15 01:07:20 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Tue, 14 May 2013 23:07:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26126 -
	hydra/jobs/spoofax-git
Message-ID: <20130514230720.49F8C2B8028@mx2.tudelft.nl>

Author: VladVergu
Date: Tue May 14 23:07:18 2013
New Revision: 26126
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26126&sc=1

Log:
Applying same fix to spoofax-release to obtain increasing build revision numbers.

Modified:
   hydra/jobs/spoofax-git/spoofax-release.nix

Modified: hydra/jobs/spoofax-git/spoofax-release.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-release.nix	Tue May 14 17:10:10 2013	(r26125)
+++ hydra/jobs/spoofax-git/spoofax-release.nix	Tue May 14 23:07:18 2013	(r26126)
@@ -28,7 +28,7 @@
   plus = a : b : ( builtins.add a b );
   sumrev = xs : pkgs.lib.foldl plus 0 xs ;
   
-  spoofaxRev = toString (sumrev [lpgRuntime.revCount jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount]) ;
+  spoofaxRev = toString (sumrev [lpgRuntime.rev jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount]) ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 

From v.vergu+vc at gmail.com  Sat May 18 19:41:12 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sat, 18 May 2013 17:41:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26127 -
	hydra/jobs/spoofax-git
Message-ID: <20130518174112.B93E57F807F@mx1.tudelft.nl>

Author: VladVergu
Date: Sat May 18 17:41:09 2013
New Revision: 26127
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26127&sc=1

Log:
Backport the -s suffix and revCount based version number to the Spoofax that includes the java-bootstrapped strj

Modified:
   hydra/jobs/spoofax-git/spoofax-master-i-strj.nix

Modified: hydra/jobs/spoofax-git/spoofax-master-i-strj.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Tue May 14 23:07:18 2013	(r26126)
+++ hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Sat May 18 17:41:09 2013	(r26127)
@@ -31,7 +31,10 @@
 
 }:
 let
-  spoofaxRev = toString spoofax.shortRev ;
+  plus = a : b : ( builtins.add a b );
+  sumrev = xs : pkgs.lib.foldl plus 0 xs ;
+  
+  spoofaxRev = toString (sumrev [lpgRuntime.rev jsglr.revCount mbexec.revCount mbexecdeps.revCount mbrep.revCount nabl.revCount sdf.revCount esv.revCount aster.revCount box.revCount spx.revCount rtg.revCount stratego.revCount spt.revCount tdl.revCount spoofax.revCount spoofaxdebug.revCount spoofaxdeploy.revCount spoofaximppatches.revCount strategoxt.revCount metaborgRuntime.revCount]) ;
 
   pkgs = import nixpkgs { system = "i686-linux"; };
 
@@ -97,7 +100,7 @@
   jobs = with pkgs.lib; {
     tests.install = eclipseTest;
     src = pkgs.stdenv.mkDerivation {
-      name = "spoofax-imp-src-r${spoofaxRev}";
+      name = "spoofax-imp-src-s${spoofaxRev}";
 
 
       buildInputs = with pkgs; [ unzip ];
@@ -190,9 +193,9 @@
               org.spoofax.jsglr/src/org/spoofax/jsglr/server/RemoteParseTableServiceImpl.java \
               org.spoofax.terms/src/org/spoofax/gwt/
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.updatesite/site.xml
-        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-s${spoofaxRev}"/' org.strategoxt.imp.updatesite/site.xml
         sed -Ei 's|\.[0-9]\{12\}|.qualifier|g' org.strategoxt.imp.feature/feature.xml
-        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-r${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
+        sed -Ei 's/(version="([0-9]+\.){3,}[0-9]+)"/\1-s${spoofaxRev}"/' org.strategoxt.imp.feature/feature.xml
 
         header "Patching org.eclipse.imp using ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch"
         patch -p0 < ${spoofaximppatches}/org.eclipse.imp/org.eclipse.imp.runtime.patch
@@ -203,7 +206,7 @@
     };
 
     build = pkgs.stdenv.mkDerivation rec {
-      name = "spoofax-imp-r${spoofaxRev}";
+      name = "spoofax-imp-s${spoofaxRev}";
       inherit (jobs) src;
 
       buildInputs = with pkgs; [ maven3 strcj pkgconfig which ecj openjdk apacheAntOpenJDK strategoPackages.sdf ];

From v.vergu+vc at gmail.com  Sun May 19 18:49:16 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sun, 19 May 2013 16:49:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26128 -
	hydra/jobs/spoofax-git
Message-ID: <20130519164916.A73C62B8007@mx2.tudelft.nl>

Author: VladVergu
Date: Sun May 19 16:49:14 2013
New Revision: 26128
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26128&sc=1

Log:
Build sdf2imp with Ant instead of Make

Modified:
   hydra/jobs/spoofax-git/spoofax-master.nix

Modified: hydra/jobs/spoofax-git/spoofax-master.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master.nix	Sat May 18 17:41:09 2013	(r26127)
+++ hydra/jobs/spoofax-git/spoofax-master.nix	Sun May 19 16:49:14 2013	(r26128)
@@ -194,9 +194,44 @@
       '';
     };
 
+    generator = pkgs.releaseTools.antBuild {
+      name = "spoofax-imp-generator-s${spoofaxRev}";
+      inherit (jobs) src;
+
+      buildInputs = with pkgs; [strategoPackages.sdf strategoPackages.strategoxt 
+strategoPackages.javafront ecj openjdk ];
+
+      preConfigure = ''
+        cd org.strategoxt.imp.generator
+        ulimit -s unlimited
+      '';
+
+      postUnpack = ''
+        echo ${pkgs.strategoPackages.strategoxt}
+        echo ${pkgs.strategoPackages.sdf}
+        echo ${pkgs.strategoPackages.javafront}
+      '';
+
+      antTargets = [ "install" ];
+      antProperties = [
+	{ name = "sdf2bundle"; value = pkgs.strategoPackages.sdf; }
+        { name = "strategoxt"; value = "${pkgs.strategoPackages.strategoxt}/share"; }
+        { name = "sdf"; value = pkgs.strategoPackages.sdf; }
+        { name = "java-front"; value = "${pkgs.strategoPackages.javafront}/share/java-front"; }
+        { name = "install-prefix"; value = "$out/dist"; }
+      ];
+      antBuildInputs = [ pkgs.ecj strcJava ];
+
+      ANT_OPTS="-Xss16m -Xmx1024m -server -XX:+UseParallelGC -XX:MaxPermSize=256m";
+
+      dontInstall = true;
+    };
+
+
     build = pkgs.stdenv.mkDerivation rec {
       name = "spoofax-imp-s${spoofaxRev}";
       inherit (jobs) src;
+      inherit (jobs) generator;
           
       buildInputs = with pkgs; [ maven3 strcJava pkgconfig which ecj openjdk apacheAntOpenJDK];
       mvnFlags = "-Dversion=1.0.0-SNAPSHOT -DgroupId=spoofax -Dtycho.targetPlatform=${eclipse}/eclipse -Dmaven.repo.local=/tmp/m3";
@@ -216,12 +251,12 @@
             
         mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
 
-        mkdir -p org.strategoxt.imp.generator/src-gen/org/strategoxt/imp/generator
         mkdir -p org.strategoxt.strj/java
         cp ${strcJava}/share/strc-java/strategoxt.jar org.strategoxt.strj/java/
 
-        header "Building org.strategoxt.imp.generator"
-        make -C org.strategoxt.imp.generator all
+	header "Copying back org.strategoxt.imp.generator"
+        cp -r ${generator}/dist org.strategoxt.imp.generator/
+
         stopNest
 
         for e in */build.generated.xml
@@ -241,7 +276,7 @@
             <artifactId>aster</artifactId>
             <version>1.0</version>
             <scope>system</scope>
-            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/aster.jar</systemPath>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/dist/aster.jar</systemPath>
         </dependency>
         <dependency>
             <groupId>local</groupId>
@@ -255,14 +290,14 @@
             <artifactId>sdf2imp</artifactId>
             <version>1.0</version>
             <scope>system</scope>
-            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/sdf2imp.jar</systemPath>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/dist/sdf2imp.jar</systemPath>
         </dependency>
         <dependency>
             <groupId>local</groupId>
             <artifactId>make_permissive.jar</artifactId>
             <version>1.0</version>
             <scope>system</scope>
-            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/make_permissive.jar</systemPath>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/dist/make_permissive.jar</systemPath>
         </dependency>
         <dependency>
            <groupId>com.sun</groupId>
@@ -294,7 +329,7 @@
                   <tasks>
                           <echo>Running ant script</echo>
                           <property name="externaljarx" refid="maven.compile.classpath"/>
-                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/dist/"/>
                           <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
                           <property name="eclipse.home" value="${eclipse}/eclipse"/>
                           <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
@@ -312,7 +347,7 @@
                <configuration>
                   <tasks>
                           <echo>Running ant script</echo>
-                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/dist/"/>
                           <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
                           <property name="eclipse.home" value="${eclipse}/eclipse"/>
                           <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>

From v.vergu+vc at gmail.com  Sun May 19 19:00:36 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sun, 19 May 2013 17:00:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26129 -
	hydra/jobs/spoofax-git
Message-ID: <20130519170037.0F47ECC1D5@mx4.tudelft.nl>

Author: VladVergu
Date: Sun May 19 17:00:35 2013
New Revision: 26129
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26129&sc=1

Log:
Update build for generator compilation using Ant

Modified:
   hydra/jobs/spoofax-git/spoofax-master-i-strj.nix

Modified: hydra/jobs/spoofax-git/spoofax-master-i-strj.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Sun May 19 16:49:14 2013	(r26128)
+++ hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Sun May 19 17:00:35 2013	(r26129)
@@ -205,10 +205,45 @@
       '';
     };
 
+        generator = pkgs.releaseTools.antBuild {
+      name = "spoofax-imp-generator-s${spoofaxRev}";
+      inherit (jobs) src;
+
+      buildInputs = with pkgs; [strategoPackages.sdf strategoPackages.strategoxt 
+strategoPackages.javafront ecj openjdk ];
+
+      preConfigure = ''
+        cd org.strategoxt.imp.generator
+        ulimit -s unlimited
+      '';
+
+      postUnpack = ''
+        echo ${pkgs.strategoPackages.strategoxt}
+        echo ${pkgs.strategoPackages.sdf}
+        echo ${pkgs.strategoPackages.javafront}
+      '';
+
+      antTargets = [ "install" ];
+      antProperties = [
+	{ name = "sdf2bundle"; value = pkgs.strategoPackages.sdf; }
+        { name = "strategoxt"; value = "${pkgs.strategoPackages.strategoxt}/share"; }
+        { name = "sdf"; value = pkgs.strategoPackages.sdf; }
+        { name = "java-front"; value = "${pkgs.strategoPackages.javafront}/share/java-front"; }
+        { name = "install-prefix"; value = "$out/dist"; }
+      ];
+      antBuildInputs = [ pkgs.ecj strcJava ];
+
+      ANT_OPTS="-Xss16m -Xmx1024m -server -XX:+UseParallelGC -XX:MaxPermSize=256m";
+
+      dontInstall = true;
+    };
+
+
     build = pkgs.stdenv.mkDerivation rec {
       name = "spoofax-imp-s${spoofaxRev}";
       inherit (jobs) src;
-
+      inherit (jobs) generator;
+          
       buildInputs = with pkgs; [ maven3 strcj pkgconfig which ecj openjdk apacheAntOpenJDK strategoPackages.sdf ];
       mvnFlags = "-Dversion=1.0.0-SNAPSHOT -DgroupId=spoofax -Dtycho.targetPlatform=${eclipse}/eclipse -Dmaven.repo.local=/tmp/m3";
 
@@ -227,12 +262,12 @@
             
         mvn org.sonatype.tycho:maven-tycho-plugin:generate-poms ${mvnFlags}
 
-        mkdir -p org.strategoxt.imp.generator/src-gen/org/strategoxt/imp/generator
         mkdir -p org.strategoxt.strj/java
         cp ${strj}/share/strategoxt/strategoxt.jar org.strategoxt.strj/java/
 
-        header "Building org.strategoxt.imp.generator"
-        make -C org.strategoxt.imp.generator all
+        header "Copying back org.strategoxt.imp.generator"
+        cp -r ${generator}/dist org.strategoxt.imp.generator/
+
         stopNest
 
         for e in */build.generated.xml
@@ -252,7 +287,7 @@
             <artifactId>aster</artifactId>
             <version>1.0</version>
             <scope>system</scope>
-            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/aster.jar</systemPath>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/dist/aster.jar</systemPath>
         </dependency>
         <dependency>
             <groupId>local</groupId>
@@ -266,14 +301,14 @@
             <artifactId>sdf2imp</artifactId>
             <version>1.0</version>
             <scope>system</scope>
-            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/sdf2imp.jar</systemPath>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/dist/sdf2imp.jar</systemPath>
         </dependency>
         <dependency>
             <groupId>local</groupId>
             <artifactId>make_permissive.jar</artifactId>
             <version>1.0</version>
             <scope>system</scope>
-            <systemPath>''${basedir}/../org.strategoxt.imp.generator/lib/make_permissive.jar</systemPath>
+            <systemPath>''${basedir}/../org.strategoxt.imp.generator/dist/make_permissive.jar</systemPath>
         </dependency>
         <dependency>
            <groupId>com.sun</groupId>
@@ -305,7 +340,7 @@
                   <tasks>
                           <echo>Running ant script</echo>
                           <property name="externaljarx" refid="maven.compile.classpath"/>
-                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/dist/"/>
                           <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
                           <property name="eclipse.home" value="${eclipse}/eclipse"/>
                           <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>
@@ -323,7 +358,7 @@
                <configuration>
                   <tasks>
                           <echo>Running ant script</echo>
-                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/lib/"/>
+                          <property name="eclipse.spoofaximp.jars" value="''${basedir}/../org.strategoxt.imp.generator/dist/"/>
                           <property name="eclipse.spoofaximp.strategojar" value="''${basedir}/../org.strategoxt.strj/java/strategoxt.jar"/>
                           <property name="eclipse.home" value="${eclipse}/eclipse"/>
                           <property name="build.compiler" value="org.eclipse.jdt.core.JDTCompilerAdapter"/>

From v.vergu+vc at gmail.com  Sun May 19 19:06:36 2013
From: v.vergu+vc at gmail.com (Vlad Vergu)
Date: Sun, 19 May 2013 17:06:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - r26130 -
	hydra/jobs/spoofax-git
Message-ID: <20130519170636.242A6CC1B6@mx4.tudelft.nl>

Author: VladVergu
Date: Sun May 19 17:06:34 2013
New Revision: 26130
URL: https://svn.strategoxt.org/websvn/StrategoXT/?rev=26130&sc=1

Log:
oops

Modified:
   hydra/jobs/spoofax-git/spoofax-master-i-strj.nix

Modified: hydra/jobs/spoofax-git/spoofax-master-i-strj.nix
==============================================================================
--- hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Sun May 19 17:00:35 2013	(r26129)
+++ hydra/jobs/spoofax-git/spoofax-master-i-strj.nix	Sun May 19 17:06:34 2013	(r26130)
@@ -231,7 +231,7 @@
         { name = "java-front"; value = "${pkgs.strategoPackages.javafront}/share/java-front"; }
         { name = "install-prefix"; value = "$out/dist"; }
       ];
-      antBuildInputs = [ pkgs.ecj strcJava ];
+      antBuildInputs = [ pkgs.ecj strcj ];
 
       ANT_OPTS="-Xss16m -Xmx1024m -server -XX:+UseParallelGC -XX:MaxPermSize=256m";
 

