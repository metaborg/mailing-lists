From L.C.L.Kats at tudelft.nl  Mon Mar  1 15:32:43 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 01 Mar 2010 14:32:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20649 - LennartKats -
	in spoofax-imp/trunk/org.strategoxt.imp.generator/src:
	sdf2imp/project syntax
Message-ID: <201003011432.o21EWhsN006621@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-01 14:32:42 +0000 (Mon, 01 Mar 2010)
New Revision: 20649

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20649&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-grammar.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf

Log:
grammar tweaks

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-grammar.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-grammar.str	2010-02-28 18:15:55 UTC (rev 20648)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-grammar.str	2010-03-01 14:32:42 UTC (rev 20649)
@@ -42,43 +42,51 @@
     <file-exists> <conc-strings> ("syntax/Common.sdf")
   <+
     <output-text-file(|["syntax"], "Common.sdf")>
-(
 // TODO: FLOAT
-"module Common
+${module Common
 
 exports
 
-  sorts
-    ID INT STRING StringChar CommentChar
-
   lexical syntax
   
-    [a-zA-Z][a-zA-Z0-9\\_]* -> ID
-    \"-\"? [0-9]+            -> INT
+    [a-zA-Z][a-zA-Z0-9\_]* -> ID
+    "-"? [0-9]+            -> INT
     
-    \"\\\"\" StringChar* \"\\\"\" -> STRING
-    ~[\\\"\\n]               -> StringChar
-    \"\\\\\\\"\"                -> StringChar
+    "\"" StringChar* "\"" -> STRING
+    ~[\"\n]               -> StringChar
+    "\\\""                -> StringChar
+    BackSlashChar         -> StringChar
+    "\\"                  -> BackSlashChar
     
-    [\\ \\t\\n\\r] -> LAYOUT
+    [\ \t\n\r] -> LAYOUT
     
-    [\\*]                             -> CommentChar
-    \"/*\" (~[\\*] | CommentChar)* \"*/\" -> LAYOUT
-    \"//\" ~[\\n\\r]* ([\\n\\r] | EOF)     -> LAYOUT
+    [\*]                             -> CommentChar
+    "/*" (~[\*] | CommentChar)* "*/" -> LAYOUT
+    "//" ~[\n\r]* ([\n\r] | EOF)     -> LAYOUT
     
     -> EOF
   
   lexical restrictions
   
-    CommentChar -/- [\\/]
-    INT         -/- [0-9]
-    ID          -/- [a-zA-Z0-9\\_]
-    EOF         -/- ~[]
+    %% Ensure greedy matching for lexicals
+  
+    CommentChar   -/- [\/]
+    INT           -/- [0-9]
+    ID            -/- [a-zA-Z0-9\_]
+    
+    %% EOF may not be followed by any char
+    
+    EOF           -/- ~[]
 
+    %% Backslash chars in strings may not be followed by " 
+    
+    BackSlashChar -/- [\"]
+
   context-free restrictions
+  
+    %% Ensure greedy matching for comments
 
-    LAYOUT? -/- [\\ \\t\\n\\r]
-    LAYOUT? -/- [\\/].[\\/]
-    LAYOUT? -/- [\\/].[\\*]
-"
-)
\ No newline at end of file
+    LAYOUT? -/- [\ \t\n\r]
+    LAYOUT? -/- [\/].[\/]
+    LAYOUT? -/- [\/].[\*]
+}
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf	2010-02-28 18:15:55 UTC (rev 20648)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf	2010-03-01 14:32:42 UTC (rev 20649)
@@ -3,7 +3,7 @@
 exports
 
   sorts
-    Id IdStar Int STRING String Node Sort Constructor ConstructorId
+    Id IdStar Int STRING CHAR BACKSLASH String Node Sort Constructor ConstructorId
     ReservedName SectionName ModuleName Section Eof
     Ws ShortCom LongCom CommChar
 
@@ -12,7 +12,11 @@
     [a-zA-Z][a-zA-Z0-9\'\-\_]*     -> Id
     [a-zA-Z][a-zA-Z0-9\'\-\_]* "*" -> IdStar
     "-"? [0-9]+                    -> Int
-    "\"" ~[\"\n]* "\""             -> STRING
+    "\"" CHAR* "\""                -> STRING
+    ~[\"\n\\]                      -> CHAR
+    "\\\""                         -> CHAR
+    BACKSLASH                      -> CHAR
+    "\\"                           -> BACKSLASH
     
     ~[\n\r]*                       -> SectionName
 
@@ -33,6 +37,7 @@
     Id          -/- [a-zA-Z0-9\'\-\_]
     SectionName -/- ~[\n\r]
     Asterisk    -/- [\/]
+    BACKSLASH   -/- [\"]
     Eof         -/- ~[]
 
   context-free restrictions



From L.C.L.Kats at tudelft.nl  Mon Mar  1 15:33:02 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 01 Mar 2010 14:33:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20650 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl
	strc-java/trunk/java
Message-ID: <201003011433.o21EX2l5006626@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-01 14:33:02 +0000 (Mon, 01 Mar 2010)
New Revision: 20650

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20650&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_concat_strings.java
   strc-java/trunk/java/spoofax-libs.jar

Log:


Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_concat_strings.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_concat_strings.java	2010-03-01 14:32:42 UTC (rev 20649)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_concat_strings.java	2010-03-01 14:33:02 UTC (rev 20650)
@@ -12,6 +12,7 @@
 import org.spoofax.interpreter.core.Tools;
 import org.spoofax.interpreter.library.AbstractPrimitive;
 import org.spoofax.interpreter.stratego.Strategy;
+import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 
 public class SSL_concat_strings extends AbstractPrimitive {
@@ -25,15 +26,22 @@
         
         if(!Tools.isTermList(targs[0]))
             return false;
-        IStrategoTerm[] kids = targs[0].getAllSubterms();
+        String result = call((IStrategoList) targs[0]);
+        if (result == null)
+            return false;
+        env.setCurrent(env.getFactory().makeString(result));
+        return true;
+    }
+
+    public static String call(IStrategoList list) {
+        IStrategoTerm[] kids = list.getAllSubterms();
         
         StringBuilder sb = new StringBuilder();
         for(int i = 0; i < kids.length; i++) {
             if(!Tools.isTermString(kids[i]))
-                return false;
+                return null;
             sb.append(Tools.asJavaString(kids[i]));
         }
-        env.setCurrent(env.getFactory().makeString(sb.toString()));
-        return true;
+        return sb.toString();
     }
 }

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From R.B.Vermaas at tudelft.nl  Mon Mar  1 17:22:04 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Mon, 01 Mar 2010 16:22:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20651 - rob -
	hydra/strategoxt
Message-ID: <201003011622.o21GM4bD008478@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-01 16:22:04 +0000 (Mon, 01 Mar 2010)
New Revision: 20651

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20651&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
use ecj for strc-java

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2010-03-01 14:33:02 UTC (rev 20650)
+++ hydra/strategoxt/packages.nix	2010-03-01 16:22:04 UTC (rev 20651)
@@ -423,7 +423,7 @@
       buildInputs = 
         [pkgs.pkgconfig pkgs.unzip pkgs.zlib pkgs.which] 
         ++ pkgs.lib.optional pkgs.stdenv.isLinux [pkgs.ecj pkgs.jdk] 
-        ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.openjdkDarwin];
+        ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.ecjDarwin pkgs.openjdkDarwin];
       requires = svnRequires;
 
       rpmBuildSupported = true;



From R.B.Vermaas at tudelft.nl  Mon Mar  1 17:22:45 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Mon, 01 Mar 2010 16:22:45 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20652 - rob -
	hydra/strategoxt
Message-ID: <201003011622.o21GMjR3008486@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-01 16:22:44 +0000 (Mon, 01 Mar 2010)
New Revision: 20652

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20652&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:
use ecj for pil

Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2010-03-01 16:22:04 UTC (rev 20651)
+++ hydra/strategoxt/packages.nix	2010-03-01 16:22:44 UTC (rev 20652)
@@ -587,7 +587,7 @@
           pkgs.pkgconfig
         ]; 
       svnRequires = [aterm sdf2Bundle strategoxt javaFront];
-      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux [pkgs.apacheAnt pkgs.ecj pkgs.jdk] ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.openjdkDarwin pkgs.antDarwin];
+      buildInputs = [pkgs.pkgconfig] ++ pkgs.lib.optional pkgs.stdenv.isLinux [pkgs.apacheAnt pkgs.ecj pkgs.jdk] ++ pkgs.lib.optional pkgs.stdenv.isDarwin [pkgs.ecjDarwin pkgs.openjdkDarwin pkgs.antDarwin];
       requires = svnRequires;
 
       extraVirtualDebs =



From L.C.L.Kats at tudelft.nl  Tue Mar  2 13:42:45 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 12:42:45 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20653 - LennartKats -
	in spoofax-imp/trunk: org.eclipse.imp
	org.strategoxt.imp.editors.aterm
	org.strategoxt.imp.editors.editorservice
	org.strategoxt.imp.editors.editorservice/editor
	org.strategoxt.imp.editors.sdf org.strategoxt.imp.editors.sdf/editor
	org.strategoxt.imp.editors.sdf/trans
	org.strategoxt.imp.editors.stratego
	org.strategoxt.imp.editors.stratego/editor
	org.strategoxt.imp.generator
	org.strategoxt.imp.generator/src/sdf2imp
	org.strategoxt.imp.generator/src/sdf2imp/services
	org.strategoxt.imp.generator/src/syntax org.strategoxt.imp.runtime
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003021242.o22CgjXQ024274@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 12:42:45 +0000 (Tue, 02 Mar 2010)
New Revision: 20653

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20653&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.generator/.disable-global-analysis
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.meta
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/SyntaxProperties.java
Modified:
   spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService.main.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF.main.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-References.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar.main.esv
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-colorer-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-folding-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-outliner-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-references-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-syntax-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/LanguageDescription.sdf
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/ReferencesService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.runtime/plugin.xml
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/ContentProposerFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/SyntaxPropertiesFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/TermReader.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java

Log:
- Moved content completion descriptions to YourLang-Completions.esv

- Added support for completion templates.
  For example, a template for Stratego's "if" statement:
  
    completion template:
      "if" " " "e" " then\n\ts\nend"

  Based on the 'identifier lexical' configuration the editor will then select
  the "e" part of the template

- More intelligent indentation when pasting code (Spoofax/29)

- Automatic closing bracket insertion (Spoofax/30)
  Uses the 'fences' definition, respects string literals and comments,
  and allows users to type "(())" to get "(())" and not "(())))" like
  in Eclipse 3.old

- Added smart indentation based on 'fences' and 'indent after' specifications
  e.g., {}
  becomes:
  {
      // cursor
  }
  when you hit enter right before the closing bracket


Changes (first 1000 lines of the diffs):

Modified: spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch
===================================================================
--- spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	2010-03-02 12:42:45 UTC (rev 20653)
@@ -200,7 +200,7 @@
  import org.eclipse.imp.editor.internal.ProblemMarkerManager;
  import org.eclipse.imp.editor.internal.ToggleBreakpointsAdapter;
  import org.eclipse.imp.help.IMPHelp;
-@@ -257,6 +258,20 @@
+@@ -257,6 +258,24 @@
          setInsertMode(SMART_INSERT);
          fProblemMarkerManager= new ProblemMarkerManager();
      }
@@ -213,6 +213,10 @@
 +        return fLanguageServiceManager;
 +    }
 +    
++    public IPreferenceStore getThePreferenceStore() { // LK
++    	return super.getPreferenceStore();
++    }
++    
 +    public void updateColoring(Region region) { // LK
 +        PresentationController presentation = fServiceControllerManager.getPresentationController();
 +		presentation.damage(region);
@@ -221,7 +225,7 @@
  
      public Object getAdapter(Class required) {
          if (IContentOutlinePage.class.equals(required)) {
-@@ -697,7 +712,8 @@
+@@ -697,7 +716,8 @@
          IFile file= EditorInputUtils.getFile(editorInput);
          IPath filePath= EditorInputUtils.getPath(editorInput);
          try {
@@ -231,7 +235,7 @@
  
              fLanguageServiceManager.getParseController().initialize(filePath, srcProject, fAnnotationCreator);
          } catch (ModelException e) {
-@@ -1491,6 +1507,7 @@
+@@ -1491,6 +1511,7 @@
              ContentAssistant ca= new ContentAssistant();
              ca.setContentAssistProcessor(fServiceControllerManager.getCompletionProcessor(), IDocument.DEFAULT_CONTENT_TYPE);
              ca.setInformationControlCreator(getInformationControlCreator(sourceViewer));
@@ -239,7 +243,7 @@
              return ca;
          }
  
-@@ -1771,7 +1788,8 @@
+@@ -1771,7 +1792,8 @@
                  if (fServiceControllerManager.getPresentationController() != null) {
  //                  System.out.println("Scheduling repair for damage to region " + damage.getOffset() + ":" + damage.getLength() + " in doc of length " + fDocument.getLength());
                      fServiceControllerManager.getPresentationController().damage(damage);
@@ -249,7 +253,7 @@
  //                      System.out.println("** Forcing repair for hyperlink damage to region " + damage.getOffset() + ":" + damage.getLength() + " in doc of length " + fDocument.getLength());
                          fServiceControllerManager.getPresentationController().update(fLanguageServiceManager.getParseController(), fProgressMonitor);
                      }
-@@ -1845,6 +1863,7 @@
+@@ -1845,6 +1867,7 @@
      }
  
      public IParseController getParseController() {
@@ -261,7 +265,18 @@
 ===================================================================
 --- org.eclipse.imp.runtime/src/org/eclipse/imp/editor/SourceProposal.java	(revision 22255)
 +++ org.eclipse.imp.runtime/src/org/eclipse/imp/editor/SourceProposal.java	(working copy)
-@@ -155,6 +155,18 @@
+@@ -134,7 +134,9 @@
+ 
+     public void apply(IDocument document) {
+         try {
+-            document.replace(fRange.getOffset(), fRange.getLength(), fNewText.substring(fPrefix.length()));
++        	// LK: use accessors
++            Region range = getRange();
++			document.replace(range.getOffset(), range.getLength(), getNewText().substring(getPrefix().length()));
+         } catch (BadLocationException e) {
+             e.printStackTrace();
+         }
+@@ -155,6 +157,18 @@
      public Image getImage() {
          return null;
      }

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/build.generated.xml	2010-03-02 12:42:45 UTC (rev 20653)
@@ -227,6 +227,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${include}/${strmodule}.ctree"/>
             </dependset>
@@ -246,6 +247,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${src-gen}/trans/Main.java"/>
             </dependset>
@@ -261,6 +263,7 @@
         </target>
             
         <target name="stratego.jvm.helper" unless="strc-java.available" if="build.stratego.enabled">
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <java classname="org.strategoxt.strj.Main" failonerror="true">
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/build.generated.xml	2010-03-02 12:42:45 UTC (rev 20653)
@@ -227,6 +227,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${include}/${strmodule}.ctree"/>
             </dependset>
@@ -246,6 +247,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${src-gen}/trans/Main.java"/>
             </dependset>
@@ -261,6 +263,7 @@
         </target>
             
         <target name="stratego.jvm.helper" unless="strc-java.available" if="build.stratego.enabled">
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <java classname="org.strategoxt.strj.Main" failonerror="true">
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1,47 @@
+module EditorService-Completions
+
+imports EditorService-Completions.generated
+
+completions
+  
+  completion template:
+    "completion template" ":\n\t" "prefix" " \"c\""
+  
+  completion template:
+    "completion lexical" ":\n\t" "regex"
+  
+  completion template:
+    "completion proposer" ":\n\t" "s"
+  
+  completion template:
+    "completion keyword" ":\n\t" "k"
+  
+  completion template:
+    "completion trigger" ":\n\t" "regex"
+  
+  completion template:
+    prefix "i" 
+  
+  completion template:
+  	"observer" ": " "s"
+  
+  completion template:
+  	"builder" ": \"caption\" = " "s"
+  
+  completion template:
+  	"unmanaged table" ": " "prefix" "*"
+  
+  completion template:
+  	"line comment" ": " "prefix"
+  
+  completion template:
+  	"block comment" ":\n\t" "prefix" " " "middle" " " "end"
+  
+  completion template:
+  	"fences" ":\n\t" "f" " " "g"
+ 
+  completion template:
+  	"indent after" ":\n\t" "keyword"
+  
+  completion template:
+  	"identifier lexical" ": " "regex"
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Syntax.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Syntax.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -3,7 +3,11 @@
 language Syntax properties
                   
   line comment  : "//"
+  
   block comment : "/*" * "*/"
+
+  indent after:
+    ":" "=" ","
+    
   fences        :
-    // No fences
-    // (e.g., [  ] (  ) {  } |[ ]| <? ?>)
+    ( ) // (just for annotations)
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService.main.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService.main.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService.main.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -7,6 +7,7 @@
   EditorService-Outliner
   EditorService-References
   EditorService-Syntax
+  EditorService-Completions
 
 language
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.generated.xml	2010-03-02 12:42:45 UTC (rev 20653)
@@ -227,6 +227,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${include}/${strmodule}.ctree"/>
             </dependset>
@@ -246,6 +247,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${src-gen}/trans/Main.java"/>
             </dependset>
@@ -261,6 +263,7 @@
         </target>
             
         <target name="stratego.jvm.helper" unless="strc-java.available" if="build.stratego.enabled">
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <java classname="org.strategoxt.strj.Main" failonerror="true">
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1,56 @@
+module SDF-Completions
+
+imports SDF-Completions.generated
+
+completions
+
+  completion template:
+  	"context-free syntax" "\n\t"
+
+  completion template:
+  	"lexical syntax" "\n\t"
+
+  completion template:
+  	"syntax" "\n\t"
+
+  completion template:
+  	"imports" "\n\t"
+
+  completion template:
+  	"exports" "\n\t"
+
+  completion template:
+  	"context-free restrictions" "\n\t"
+
+  completion template:
+  	"lexical restrictions" "\n\t"
+
+  completion template:
+  	"restrictions" "\n\t"
+
+  completion template:
+  	"context-free start-symbols" "\n\t" "Start"
+
+  completion template:
+  	"lexical start-symbols" "\n\t" "Start"
+
+  completion template:
+  	"start-symbols" "\n\t" "Start"
+
+  completion template:
+  	"sorts" "\n\t"
+
+  completion template:
+  	"variables" "\n\t"
+
+  completion template:
+  	"aliases" "\n\t"
+
+  completion template:
+  	"priorities" "\n\t"
+
+  completion template:
+  	"module" "x\n\t\nexports\n\t"
+
+  completion template:
+  	"lexical variables" "\n\t"
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -5,9 +5,16 @@
 
 language
   
-
-
-
-// This file can be used for custom syntax rules.
-
-// See the imported file for a brief introduction and examples.
\ No newline at end of file
+  indent after:
+    imports
+    exports
+    syntax
+    sorts
+    restrictions
+    priorities
+  	
+  fences : ( ) { }
+  
+  line comment: "%%"
+  
+  block comment: % % %
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF.main.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF.main.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF.main.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -7,6 +7,7 @@
   SDF-Outliner
   SDF-References
   SDF-Syntax
+  SDF-Completions
 
 language General properties
                   

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -24,7 +24,7 @@
         not(<one(term(default(appl(unquoted("cons"), [id]))))> a'*)
       ; not(<one(term(default(appl(unquoted("bracket" + "reject"), []))))> a'*)
       ; not(<one(reject())> a'*)
-      ; not(!s => sort("Keyword")) 
+      ; not(!s; (sort("Keyword") + sort("\"Keyword\""))) 
       ; target := a*
       else
         target := s

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/build.generated.xml	2010-03-02 12:42:45 UTC (rev 20653)
@@ -227,6 +227,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${include}/${strmodule}.ctree"/>
             </dependset>
@@ -246,6 +247,7 @@
                 <srcfileset dir="${basedir}">
                     <include name="**/*.str"/>
                     <include name="**/*.astr"/>
+                    <exclude name="lib/editor-common.generated.str"/>
                 </srcfileset>
                 <targetfileset file="${src-gen}/trans/Main.java"/>
             </dependset>
@@ -261,6 +263,7 @@
         </target>
             
         <target name="stratego.jvm.helper" unless="strc-java.available" if="build.stratego.enabled">
+            <delete file="${include}/${strmodule}.rtree" failonerror="false"/>
             <java classname="org.strategoxt.strj.Main" failonerror="true">
                 <arg value="-i"/>
                 <arg value="${trans}/${strmodule}.str"/>

Copied: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv (from rev 20648, spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-References.esv)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1,44 @@
+module Stratego-Sugar-References
+
+imports Stratego-Sugar-References.generated
+
+references
+                                                                   
+  // This file can be used for custom reference resolving rules.   
+  // See the imported file for a brief introduction and examples.
+
+  completion proposer : editor-complete
+  
+  identifier lexical : [a-zA-Z\_][a-zA-Z0-9\'\-\_]*\*?
+
+/* TODO: enable completion triggers in a later release?
+  completion trigger : "->[ \n\t]*[A-Za-z]"
+  completion trigger : "([^A-Za-z0-9_ ]) ?<" // trigger for ':= <' but not for 'a < b'
+  completion trigger : "(where|with)[ \n\t]*<"
+  completion trigger : "\[<"
+  completion trigger : "\n ?<"
+  completion trigger : "!"
+  completion trigger : "\?"
+  completion trigger : "\{\| "
+  completion trigger : ":[ \n\t]*[A-Za-z]"
+  completion trigger : ":= [A-Za-z]"
+*/
+                                                                                 
+  reference _ : editor-resolve
+
+  hover _ : editor-hover
+  
+  completion template:
+    "if" " " "e" " then\n\ts\nend"
+      
+  completion template:
+    "switch" " " "s" "\n\tcase " "c" ":" " " "s" "\n\totherwise: " "id" "\nend"
+
+  completion template:
+  	"let" "\n\t" "x" " = " "s" "\nin\n\t" "s" "\nend"
+
+  completion keyword:
+  	"where"
+  	
+  completion keyword:
+  	"with"
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-References.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-References.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-References.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -3,26 +3,6 @@
 imports Stratego-Sugar-References.generated
 
 references
-                                                                   
-  // This file can be used for custom reference resolving rules.   
-  // See the imported file for a brief introduction and examples.
-
-  completion proposer : editor-complete
-  
-  completion lexical : [a-zA-Z\_][a-zA-Z0-9\'\-\_]*\*?
-
-/* TODO: enable completion triggers in a later release?
-  completion trigger : "->[ \n\t]*[A-Za-z]"
-  completion trigger : "([^A-Za-z0-9_ ]) ?<" // trigger for ':= <' but not for 'a < b'
-  completion trigger : "(where|with)[ \n\t]*<"
-  completion trigger : "\[<"
-  completion trigger : "\n ?<"
-  completion trigger : "!"
-  completion trigger : "\?"
-  completion trigger : "\{\| "
-  completion trigger : ":[ \n\t]*[A-Za-z]"
-  completion trigger : ":= [A-Za-z]"
-*/
                                                                                  
   reference _ : editor-resolve
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -1,8 +1,29 @@
 module Stratego-Sugar-Syntax
 
-imports Stratego-Sugar-Syntax.generated
-
 language
-                                                                   
-  // This file can be used for custom syntax rules.                
-  // See the imported file for a brief introduction and examples.  
\ No newline at end of file
+                  
+  line comment  : "//"
+  block comment : "/*" * "*/"
+  fences        : [ ]
+                  ( )
+                  { }
+                  {| |}
+                  |[ ]|
+                  $[ ]
+                  ${ }
+                  $< >
+                  $( )
+  
+  indent after:
+    then
+    in
+    else
+    ":"
+    "="
+    <
+    >
+    rules
+    strategies
+    overlays
+    constructors
+    imports

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar.main.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar.main.esv	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar.main.esv	2010-03-02 12:42:45 UTC (rev 20653)
@@ -1,6 +1,9 @@
 module Stratego-Sugar.main
 
-imports Stratego-Sugar-Builders Stratego-Sugar-Colorer Stratego-Sugar-Folding Stratego-Sugar-Outliner Stratego-Sugar-References Stratego-Sugar-Syntax
+imports
+  Stratego-Sugar-Builders Stratego-Sugar-Colorer Stratego-Sugar-Folding
+  Stratego-Sugar-Outliner Stratego-Sugar-References Stratego-Sugar-Syntax
+  Stratego-Sugar-Completions
 
 language General properties
                   

Added: spoofax-imp/trunk/org.strategoxt.imp.generator/.disable-global-analysis
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/.disable-global-analysis	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/.disable-global-analysis	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1 @@
+.

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -120,6 +120,7 @@
     create-colorer-descriptor;
     create-builders-descriptor;
     create-references-descriptor;
+    create-completions-descriptor;
 
     create-packed-descriptor-file;
     
@@ -146,7 +147,7 @@
         <guarantee-extension(|"rtg")> <InputFile>
       , [ $[editor/[<descriptor-name> "-Outliner.generated.esv"]]
         , $[editor/[<descriptor-name> "-Folding.generated.esv"]]
-        , $[editor/[<descriptor-name> "-References.generated.esv"]]
+        , $[editor/[<descriptor-name> "-Completions.generated.esv"]]
         ]
       )
     )

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -21,6 +21,7 @@
         builders
           ~~
           ~~// This file can be used for custom analysis and builder rules.
+          ~~//
           ~~// See the imported file for a brief introduction and examples.
         builders
           ~~
@@ -43,14 +44,14 @@
           ~//
           ~//   provider : stratego-program.ctree
           ~//   provider : stratego-library.jar
-          ~
+          ~//
           ~// Analysis is carried out by a Stratego rule that can be selected as follows:
           ~//
           ~//   observer : analysis-rule
           ~//
           ~// Any dynamic rules set in the analysis may be used by other semantic services,
           ~// such as reference resolving or the builders.
-          ~
+          ~//
           ~// Builders may carry out custom transformations on a file or selection.
           ~// (At run-time, they can be accessed using the toolbar button with the star icon.)
           ~// Builders can be specified as follows:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-colorer-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-colorer-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-colorer-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -18,6 +18,7 @@
         colorer
           ~
           ~// This file can be used for custom colorer rules.
+          ~//
           ~// See the imported file for a brief introduction and examples.
       ]|
     );
@@ -46,7 +47,7 @@
           // TODO: Better documentation of colorer descriptor
         
         colorer Default, token-based highlighting
-        ~
+        ~~
           keyword    : 127 0 85     bold
           identifier : default
           string     : blue
@@ -56,7 +57,7 @@
           layout     : 100 100 0    italic
         
         colorer System colors
-        ~
+        ~~
         darkred   = 128 0 0       
         red       = 255 0 0       
         darkgreen = 0 128 0       

Copied: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.meta (from rev 20648, spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-references-descriptor.meta)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.meta	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.meta	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1 @@
+Meta([Syntax("Stratego-Java-EditorService")])

Copied: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str (from rev 20648, spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-references-descriptor.str)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1,126 @@
+module sdf2imp/services/create-completions-descriptor
+
+imports
+  libstratego-lib
+  libstratego-sdf
+  
+  sdf2imp/util/-
+  sdf2imp/main
+
+signature constructors
+
+  lit  : Term -> Term
+  prod : Term * Term * Term -> Term
+
+strategies
+
+  create-completions-descriptor =
+    output-initial-descriptor-file(
+      <descriptor-name> "-Completions"
+    , !|[
+        module <descriptor-name> "-Completions"
+        
+        imports <descriptor-name> "-Completions.generated"
+        
+        completions
+          ~~
+          ~~// This file is used to define content completion.
+          ~~//
+          ~~// See the imported file for a brief introduction and examples.
+          ~~
+        completions
+          ~~
+          ~// Syntax completion:
+          completion template: "module " "m"
+          completion template: "entity " "e" " {}"
+          ~~
+          ~// Semantic (identifier) completion:
+          completion proposer: editor-complete
+          completion trigger: ":"
+      ]|
+    );
+    create-derived-completions-descriptor
+    
+  create-derived-completions-descriptor =
+    not(is-heuristic-services-needed);
+    verbose-msg(!"Skipping", <descriptor-name> "-Completions.generated")
+  <+
+    output-derived-descriptor-file(
+      <descriptor-name> "-Completions.generated"
+    ,
+      completion-rules := <collect-all-keywords; map(keyword-to-completion-rule)>;
+      !|[
+        module <descriptor-name> "-Completions.generated"
+        
+        completions
+          ~
+          ~// Syntactic content completion can be defined as follows:
+          ~//
+          ~//   completion keyword  : "keyword"
+          ~//   completion template : "if " "e" " then\n\ts\nend"
+          ~//
+          ~// This defines keyword completion for "keyword" and
+          ~// a template completion for the "if" keyword (note the use of \n, \t, and spaces).
+          ~// In this template, the text selection expands to the "e" identifier
+          ~// if it matches the identifier lexical of YourLanguage-Syntax.esv.
+          ~//
+          ~// Semantic content completion can be defined as follows:
+          ~//
+          ~//   completion proposer : completion-function-call  
+          ~//   completion trigger  : "\."
+          ~//
+          ~// This sets completion-function-call as the completion strategy,
+          ~// and declares that [A-Za-z0-9_]+ may be used as a lexical pattern
+          ~// to parse identifiers (used to set the text selection with suggestions).
+          ~// The completion trigger uses a regular expression to specify that  
+          ~// completions should be proposed as the user types ".".
+          ~//
+          ~// Completions make use of the identifier lexical defined in YourLanguage-Syntax.esv
+          ~// to select identifiers in completion suggestions.
+          ~//
+          ~// Semantic completion uses the semantic provider defined in YourLanguage-Builders.esv
+          ~~// All semantic services may make use of the dynamic rules created by the observer.
+
+        completions
+          ~~
+          ~// Derived completions may follow
+          ~
+          ~*completion-rules
+      ]|
+    )
+
+strategies
+
+  keyword-to-completion-rule:
+    keyword -> |[ completion keyword : ~String(keyword) ]|
+
+  collect-all-keywords =
+    (InputFile <+ DefaultDefFile);
+    parse-sdf-definition-file;
+    collect-all(?prod(<pattern-to-keywords>, _, _));
+    concat;
+    make-set
+
+  pattern-to-keywords =
+    pattern-to-keywords-1 <+ pattern-to-keywords-2 <+ []
+
+  pattern-to-keywords-1:
+    [lit(lit) | p*] -> [keyword | <pattern-to-keywords> p'*]
+    where
+      <is-prefixed-keyword> lit
+    with
+      keyword-suffix := <take-while(lit(is-prefixed-keyword))> p*; 
+      keyword        := <map(?lit(<id>)); separate-by(|" "); concat-strings> [lit(lit) | keyword-suffix];
+      p'*            := <drop-while(?lit(_))> p*
+
+  pattern-to-keywords-2:
+    [_ | p*] -> <pattern-to-keywords> p*
+
+  /**
+   * Tests if the given string is a keyword prefixed
+   * by non-alphabetic characters (e.g., ~java: or {annotation})
+   */
+  is-prefixed-keyword =
+    explode-string;
+    where([not(is-alpha) | id]); // not("")
+    one(is-alpha)

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-folding-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-folding-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-folding-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -19,6 +19,7 @@
         folding
           ~
           ~// This file can be used for custom folding rules.
+          ~//
           ~// See the imported file for a brief introduction and examples.
       ]|
     );

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -32,20 +32,21 @@
       imports
         <descriptor-name> "-Builders"
         <descriptor-name> "-Colorer"
+        <descriptor-name> "-Completions"
         <descriptor-name> "-Folding"
         <descriptor-name> "-Outliner"
         <descriptor-name> "-References"
         <descriptor-name> "-Syntax"
       
       language General properties
-        ~
+        ~~
         name:    ~name
         id:      ~pkgname
         extends: Root
-        ~
+        ~~
         description: <conc-strings> ("\"Spoofax/IMP-generated editor for the ", name, " language\"")
         url: http://strategoxt.org
-        ~
+        ~~
         extensions: ~extensions
         table:  ~parsetable
         start symbols: ~*startsymbols

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-outliner-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-outliner-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-outliner-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -20,6 +20,7 @@
         outliner
           ~
           ~// This file can be used for custom outliner rules.
+          ~//
           ~// See the imported file for a brief introduction and examples.
       ]|
     );

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-references-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-references-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-references-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -7,11 +7,6 @@
   sdf2imp/util/-
   sdf2imp/main
 
-signature constructors
-
-  lit  : Term -> Term
-  prod : Term * Term * Term -> Term
-
 strategies
 
   create-references-descriptor =
@@ -24,16 +19,12 @@
         
         references
           ~~
-          ~~// This file can be used for custom reference resolving,
-          ~~// hover help, occurrence highlighting rules.
+          ~~// This file can be used to specify reference resolving and hover help, and content completion.
+          ~~//
           ~~// See the imported file for a brief introduction and examples.
           ~~
         references
           ~~
-          completion proposer: editor-complete
-          completion lexical: [A-Za-z0-9_]+
-          completion trigger: ":"
-          ~~
           reference _ : editor-resolve
           hover     _ : editor-hover
       ]|
@@ -47,17 +38,11 @@
     output-derived-descriptor-file(
       <descriptor-name> "-References.generated"
     ,
-      completion-rules := <collect-all-keywords; map(keyword-to-completion-rule)>;
       !|[
         module <descriptor-name> "-References.generated"
         
         references
           ~
-          ~// Building and analysis is defined in Stratego program or programs:
-          ~//
-          ~//   provider : stratego-program.ctree
-          ~//   provider : stratego-library.jar
-          ~
           ~// Reference resolving rules can specify the syntax constructors for which
           ~// a reference resolving function is available:
           ~//
@@ -65,61 +50,12 @@
           ~//
           ~// This defines that for each FunctionCall, resolve-function-call
           ~// will retrieve the AST node that declares it.
-          ~
-          ~// Likewise, hover help and occurrence highlighting functionality and can be
-          ~// specified as follows: (note: occurrence highlighting is not implemented at this time)
           ~//
-          ~//   hover      FunctionCall : hover-help-function-call
-          ~//   occurrence _            : find-occurrences
-          ~
-          ~// Content completion can be defined using the following declarations:
+          ~// Likewise, hover help can be specified as follows:
           ~//
-          ~//   completion proposer : completion-function-call  
-          ~//   completion lexical  : [A-Za-z0-9_]+
-          ~//   completion trigger  : "\."
-          ~//   completion keyword  : "keyword"
+          ~//   hover FunctionCall : hover-help-function-call
           ~//
-          ~// This sets completion-function-call as the completion strategy,
-          ~// and declares that [A-Za-z0-9_]+ may be used as a lexical pattern
-          ~// to parse identifiers (used when the input file has syntax errors).
-          ~// The completion trigger uses a regular expression to specify that  
-          ~// completions should be proposed as the user types ".".
-          ~// Finally, the above also defines a completion for the keyword "keyword."
-          ~
-          ~~// All semantic services may make use of the
-          ~~// dynamic rules created by the observer.
-
-        references
-
-          ~
-          ~*completion-rules
+          ~// Reference resolving uses the semantic provider defined in YourLanguage-Builders.esv
+          ~// All semantic services may make use of the dynamic rules created by the observer.
       ]|
     )
-
-  keyword-to-completion-rule:
-    keyword -> |[ completion keyword : ~String(keyword) ]|
-
-  collect-all-keywords =
-    (InputFile <+ DefaultDefFile);
-    parse-sdf-definition-file;
-    collect-all(?prod(<pattern-to-keywords>, _, _));
-    concat;
-    make-set
-
-  pattern-to-keywords =
-    pattern-to-keywords-1 <+ pattern-to-keywords-2 <+ []
-
-  pattern-to-keywords-1:
-    [lit(lit) | p*] -> [keyword | <pattern-to-keywords> p'*]
-    where
-      <is-proper-keyword> lit
-    with
-      keyword-suffix := <take-while(lit(is-proper-keyword))> p*; 
-      keyword        := <map(?lit(<id>)); separate-by(|" "); concat-strings> [lit(lit) | keyword-suffix];
-      p'*            := <drop-while(?lit(_))> p*
-
-  pattern-to-keywords-2:
-    [_ | p*] -> <pattern-to-keywords> p*
-
-  is-proper-keyword =
-    explode-string; one(is-alpha); not("")

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-syntax-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-syntax-descriptor.str	2010-03-01 16:22:44 UTC (rev 20652)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-syntax-descriptor.str	2010-03-02 12:42:45 UTC (rev 20653)
@@ -18,6 +18,7 @@
         language
           ~
           ~// This file can be used for custom syntax rules.
+          ~//
           ~// See the imported file for a brief introduction and examples.
       ]|
     );
@@ -31,10 +32,22 @@
         
         language Syntax properties (static defaults)
           ~
+          ~// Comment constructs:
           line comment: "//"
           block comment: "/*" * "*/"
+          ~
+          ~// Fences (used for matching,
+          ~// inserting, indenting brackets):
           fences: [  ]
                   (  )
                   {  }
+          ~
+          ~// Automatic indent hints
+          ~// (indent after these tokens):
+          indent after: "="
+                        ":"
+          ~
+          ~// Regular expression for identifiers:
+          identifier lexical: "[A-Za-z0-9_]+"
       ]|
     )

Copied: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf (from rev 20648, spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/ReferencesService.sdf)
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf	2010-03-02 12:42:45 UTC (rev 20653)
@@ -0,0 +1,43 @@
+module CompletionsService
+
+imports
+  SemanticServices
+
+exports
+
+  sorts
+    CompletionAnno
+

(1686 diff lines omitted)


From L.C.L.Kats at tudelft.nl  Tue Mar  2 14:35:21 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 13:35:21 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20654 - LennartKats - in
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime:
	dynamicloading services
Message-ID: <201003021335.o22DZL0M024966@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 13:35:21 +0000 (Tue, 02 Mar 2010)
New Revision: 20654

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20654&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicTokenColorer.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicTokenColorer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicTokenColorer.java	2010-03-02 12:42:45 UTC (rev 20653)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicTokenColorer.java	2010-03-02 13:35:21 UTC (rev 20654)
@@ -10,6 +10,7 @@
 import org.eclipse.swt.graphics.Color;
 import org.eclipse.swt.widgets.Display;
 import org.strategoxt.imp.runtime.EditorState;
+import org.strategoxt.imp.runtime.Environment;
 
 /**
  * Dynamic proxy class to a token colorer.
@@ -65,6 +66,7 @@
 			}
 		} catch (NullPointerException e) {
 			// TODO: find out what's causing this NPE
+			Environment.logException("Exception when reinitializing token colorer", e);
 		}
 	}
 	

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 12:42:45 UTC (rev 20653)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 13:35:21 UTC (rev 20654)
@@ -1,6 +1,8 @@
 package org.strategoxt.imp.runtime.services;
 
 import static java.lang.Math.min;
+import static org.eclipse.ui.texteditor.AbstractDecoratedTextEditorPreferenceConstants.EDITOR_SPACES_FOR_TABS;
+import static org.eclipse.ui.texteditor.AbstractDecoratedTextEditorPreferenceConstants.EDITOR_TAB_WIDTH;
 import static org.eclipse.ui.texteditor.ITextEditorExtension3.SMART_INSERT;
 
 import java.util.regex.Matcher;
@@ -24,12 +26,10 @@
 import org.eclipse.swt.custom.VerifyKeyListener;
 import org.eclipse.swt.events.VerifyEvent;
 import org.eclipse.swt.graphics.Point;
-import org.eclipse.ui.texteditor.AbstractDecoratedTextEditorPreferenceConstants;
 import org.spoofax.NotImplementedException;
 import org.strategoxt.imp.runtime.EditorState;
 import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.tokens.TokenKind;
-import static org.eclipse.ui.texteditor.AbstractDecoratedTextEditorPreferenceConstants.*;
 
 /**
  * @author Lennart Kats <lennart add lclnet.nl>
@@ -471,7 +471,7 @@
 						continue;
 					case TK_NUMBER: case TK_OPERATOR:
 					case TK_VAR: case TK_EOF: case TK_UNKNOWN: case TK_RESERVED:
-					case TK_NO_TOKEN_KIND:
+					case TK_NO_TOKEN_KIND: case TK_KEYWORD:
 						continue;
 					default:
 						Environment.logException("Uknown token kind: " + token.getKind());
@@ -486,7 +486,7 @@
 	 */
 	private static boolean isSameLine(IDocument document, int offset, IToken token) {
 		try {
-			return document.getLineOfOffset(offset) == token.getLine();
+			return document.getLineOfOffset(offset) + 1 == token.getLine();
 		} catch (BadLocationException e) {
 			return false;
 		}



From L.C.L.Kats at tudelft.nl  Tue Mar  2 15:29:52 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 14:29:52 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20655 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.editors.editorservice/editor
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003021429.o22ETqXN025912@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 14:29:52 +0000 (Tue, 02 Mar 2010)
New Revision: 20655

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20655&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java

Log:
Minor reloading fixes related to auto editing.
Added some assertions to avoid this problem in the future.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 13:35:21 UTC (rev 20654)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 14:29:52 UTC (rev 20655)
@@ -20,9 +20,6 @@
     "completion trigger" ":\n\t" "regex"
   
   completion template:
-    prefix "i" 
-  
-  completion template:
   	"observer" ": " "s"
   
   completion template:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java	2010-03-02 13:35:21 UTC (rev 20654)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java	2010-03-02 14:29:52 UTC (rev 20655)
@@ -28,7 +28,7 @@
 			throws BadDescriptorException {
 		
 		ILanguageSyntaxProperties syntax = descriptor.createService(ILanguageSyntaxProperties.class, controller);
-		return new AutoEditStrategy(controller, syntax);
+		return new AutoEditStrategy(syntax);
 	}
 	
 	/**
@@ -40,12 +40,10 @@
 			for (IAutoEditStrategy autoEdit : autoEdits) {
 				if (autoEdit instanceof DynamicAutoEditStrategy) {
 					DynamicAutoEditStrategy dynAutoEdit = (DynamicAutoEditStrategy) autoEdit;
-					if (!dynAutoEdit.isInitialized()) {
-						dynAutoEdit.initialize(controller);
-						ISourceViewer viewer = editor.getEditor().getServiceControllerManager().getSourceViewer();
-						if (viewer instanceof ITextViewerExtension)
-							((ITextViewerExtension) viewer).prependVerifyKeyListener(dynAutoEdit);
-					}
+					dynAutoEdit.initialize(controller);
+					ISourceViewer viewer = editor.getEditor().getServiceControllerManager().getSourceViewer();
+					if (viewer instanceof ITextViewerExtension)
+						((ITextViewerExtension) viewer).prependVerifyKeyListener(dynAutoEdit);
 				}
 			}
 		}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	2010-03-02 13:35:21 UTC (rev 20654)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	2010-03-02 14:29:52 UTC (rev 20655)
@@ -125,6 +125,8 @@
 			throws BadDescriptorException {
 
 		boolean foundFactory = false;
+		assert controller == null || !controller.isReplaced()
+			: "Stale SGLRParseController given to Descriptor.createService() - service didn't call initialize()?";
 		
 		try {
 			for (AbstractServiceFactory<T> factory : serviceFactories) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java	2010-03-02 13:35:21 UTC (rev 20654)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java	2010-03-02 14:29:52 UTC (rev 20655)
@@ -3,11 +3,13 @@
  */
 package org.strategoxt.imp.runtime.dynamicloading;
 
+import org.eclipse.imp.parser.IParseController;
 import org.eclipse.imp.services.IAutoEditStrategy;
 import org.eclipse.jface.text.DocumentCommand;
 import org.eclipse.jface.text.IDocument;
 import org.eclipse.swt.custom.VerifyKeyListener;
 import org.eclipse.swt.events.VerifyEvent;
+import org.strategoxt.imp.runtime.services.AutoEditStrategy;
 
 /**
  * @author Lennart Kats <lennart add lclnet.nl>
@@ -28,5 +30,13 @@
 		if (wrapped instanceof VerifyKeyListener)
 			((VerifyKeyListener) wrapped).verifyKey(event);
 	}
+	
+	@Override
+	public void initialize(IParseController controller) {
+		super.initialize(controller);
+		IAutoEditStrategy wrapped = getWrapped();
+		if (wrapped instanceof AutoEditStrategy)
+			((AutoEditStrategy) wrapped).initialize(controller);
+	}
 
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java	2010-03-02 13:35:21 UTC (rev 20654)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/SGLRParseController.java	2010-03-02 14:29:52 UTC (rev 20655)
@@ -95,6 +95,8 @@
 	private volatile boolean disallowColorer;
 	
 	private volatile boolean isAborted;
+	
+	private boolean isReplaced;
 
 	// Simple accessors
 	
@@ -105,6 +107,7 @@
 	 * @return The parsed AST, or null if the file could not be parsed (yet).
 	 */
 	public final RootAstNode getCurrentAst() {
+		assert !isReplaced();
 		if (currentAst == null) forceInitialParse();
 		return currentAst;
 	}
@@ -124,6 +127,14 @@
 	public ParseErrorHandler getErrorHandler() {
 		return errorHandler;
 	}
+	
+	/**
+	 * Returns true if the given parse controller has been replaced by
+	 * a newly loaded instance.
+	 */
+	public boolean isReplaced() {
+		return isReplaced;
+	}
 
 	/**
 	 * @return either a project-relative path, if getProject() is non-null, or
@@ -184,6 +195,7 @@
     }
 
 	public AstNode parse(String input, final IProgressMonitor monitor) {
+		assert !isReplaced();
 		disallowColorer = true;
 		boolean wasStartupParsed = isStartupParsed;
 		isStartupParsed = true; // Eagerly init this to avoid the main thread acquiring our lock			

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 13:35:21 UTC (rev 20654)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 14:29:52 UTC (rev 20655)
@@ -35,9 +35,7 @@
  * @author Lennart Kats <lennart add lclnet.nl>
  */
 public class AutoEditStrategy implements IAutoEditStrategy, VerifyKeyListener {
-	
-	private final IParseController controller;
-	
+		
 	private final ILanguageSyntaxProperties syntax;
 	
 	private final String[][] allFences;
@@ -48,6 +46,8 @@
 	
 	private static UniversalEditor lastEditor;
 	
+	private IParseController controller;
+	
 	private UniversalEditor editor;
 	
 	private int lastAutoInsertedFenceLine;
@@ -58,8 +58,7 @@
 	
 	private String lastAutoInsertedFenceLineEnd;
 
-	public AutoEditStrategy(IParseController controller, ILanguageSyntaxProperties syntax) {
-		this.controller = controller;
+	public AutoEditStrategy(ILanguageSyntaxProperties syntax) {
 		this.syntax = syntax;
 		
 		allFences = syntax instanceof SyntaxProperties
@@ -79,6 +78,10 @@
 		this.maxCloseFenceLength = maxCloseFenceLength;
 	}
 	
+	public void initialize(IParseController controller) {
+		this.controller = controller;
+	}
+	
 	public void customizeDocumentCommand(IDocument document, DocumentCommand command) {
 		try {
 			indentPastedContent(document, command);



From L.C.L.Kats at tudelft.nl  Tue Mar  2 15:48:20 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 14:48:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20656 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.editors.editorservice/editor
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003021448.o22EmKQL026258@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 14:48:19 +0000 (Tue, 02 Mar 2010)
New Revision: 20656

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20656&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 14:29:52 UTC (rev 20655)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 14:48:19 UTC (rev 20656)
@@ -41,4 +41,10 @@
   	"indent after" ":\n\t" "keyword"
   
   completion template:
-  	"identifier lexical" ": " "regex"
\ No newline at end of file
+  	"reference" " _ : " "s"
+  
+  completion template:
+    "occrurrence" " _ : " "s"
+  
+  completion template:
+    "hover" " _ : " "s"

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 14:29:52 UTC (rev 20655)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 14:48:19 UTC (rev 20656)
@@ -94,14 +94,14 @@
 	}
 
 	public void verifyKey(VerifyEvent event) {
-		String input = new String(new char[] { event.character });
-		Point selection = getEditor().getSelection();
-		ISourceViewer viewer = getEditor().getServiceControllerManager()
-				.getSourceViewer();
 		try {
+			String input = new String(new char[] { event.character });
+			Point selection = getEditor().getSelection();
+			ISourceViewer viewer = getEditor().getServiceControllerManager().getSourceViewer();
 			if (indentAfterNewline(viewer, viewer.getDocument(), selection.x, selection.y, input)
 					|| insertClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input)
-					|| skipClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input))
+					|| skipClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input)
+					|| undoClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input))
 				event.doit = false;
 		} catch (BadLocationException e) {
 			Environment.logException("Could not determine auto edit strategy", e);
@@ -235,6 +235,16 @@
 		return false;
 	}
 	
+	/**
+	 * Undo automatically inserted closing fences when the user
+	 * deletes the opening fence.
+	 */
+	protected boolean undoClosingFence(ISourceViewer viewer, IDocument document, int offset, int length, String input) throws BadLocationException {
+		// TODO:  Undo automatically inserted closing fences when the user deletes the opening fence
+		//        Would only really work with single-char fences
+		return false;
+	}
+	
 	private UniversalEditor getEditor() {
 		if (editor == null) {
 			editor = EditorState.getEditorFor(controller).getEditor();



From R.B.Vermaas at tudelft.nl  Tue Mar  2 16:44:50 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 02 Mar 2010 15:44:50 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20657 - rob -
	hydra/webdsl
Message-ID: <201003021544.o22Fiogn027052@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-02 15:44:50 +0000 (Tue, 02 Mar 2010)
New Revision: 20657

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20657&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
ant logger test

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-02 14:48:19 UTC (rev 20656)
+++ hydra/webdsl/tests.nix	2010-03-02 15:44:50 UTC (rev 20657)
@@ -14,6 +14,7 @@
       buildCommand = ''
         ensureDir $out/nix-support        
         ulimit -s unlimited 
+        export ANT_ARGS="-logger org.hydra.ant.HydraLogger -lib `ls ${pkgs.hydraAntLogger}/lib/java/*.jar | head -1`"
 
         header "Copying sources"        
         cp -vR ${researchrSrc}/* .



From L.C.L.Kats at tudelft.nl  Tue Mar  2 16:46:12 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 15:46:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20658 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.editors.editorservice/editor
	org.strategoxt.imp.feature org.strategoxt.imp.updatesite
Message-ID: <201003021546.o22FkC2X027069@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 15:46:12 +0000 (Tue, 02 Mar 2010)
New Revision: 20658

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20658&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
0.3.9 beta release

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 15:44:50 UTC (rev 20657)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-02 15:46:12 UTC (rev 20658)
@@ -44,7 +44,7 @@
   	"reference" " _ : " "s"
   
   completion template:
-    "occrurrence" " _ : " "s"
+    "occurrence" " _ : " "s"
   
   completion template:
     "hover" " _ : " "s"

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-02 15:44:50 UTC (rev 20657)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-02 15:46:12 UTC (rev 20658)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.3.3.2"
+      version="0.3.9"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">
@@ -25,7 +25,7 @@
    </license>
 
    <url>
-      <update label="Spoofax/IMP updates" url="http://www.lclnet.nl/update/"/>
+      <update label="Spoofax/IMP updates" url="http://www.lclnet.nl/update/unstable"/>
    </url>
 
    <requires>

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-02 15:44:50 UTC (rev 20657)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-02 15:46:12 UTC (rev 20658)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <site>
-   <description name="Spoofax/IMP" url="http://www.lclnet.nl/update">
+   <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.3.3.2.jar" id="org.strategoxt.imp" version="0.3.3.2"> 
+   <feature url="features/org.strategoxt.imp_0.3.9.jar" id="org.strategoxt.imp" version="0.3.9">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From R.B.Vermaas at tudelft.nl  Tue Mar  2 16:48:27 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 02 Mar 2010 15:48:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20659 - rob -
	hydra/webdsl
Message-ID: <201003021548.o22FmRYr027121@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-02 15:48:27 +0000 (Tue, 02 Mar 2010)
New Revision: 20659

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20659&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
proper nesting

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-02 15:46:12 UTC (rev 20658)
+++ hydra/webdsl/tests.nix	2010-03-02 15:48:27 UTC (rev 20659)
@@ -20,9 +20,11 @@
         cp -vR ${researchrSrc}/* .
         cp -v ${./application.ini} application.ini
         chmod -R 755 . 
-
+        stopNest
+ 
         header "Building"
         webdsl build        
+        stopNest
 
         touch $out/nix-support/hydra-build-products
       '';



From L.C.L.Kats at tudelft.nl  Tue Mar  2 16:51:55 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 15:51:55 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20660 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax
Message-ID: <201003021551.o22Fptig027208@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 15:51:54 +0000 (Tue, 02 Mar 2010)
New Revision: 20660

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20660&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf

Log:
Avoiding reserved sort CHAR warning

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf	2010-03-02 15:48:27 UTC (rev 20659)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/Common.sdf	2010-03-02 15:51:54 UTC (rev 20660)
@@ -12,10 +12,10 @@
     [a-zA-Z][a-zA-Z0-9\'\-\_]*     -> Id
     [a-zA-Z][a-zA-Z0-9\'\-\_]* "*" -> IdStar
     "-"? [0-9]+                    -> Int
-    "\"" CHAR* "\""                -> STRING
-    ~[\"\n\\]                      -> CHAR
-    "\\\""                         -> CHAR
-    BACKSLASH                      -> CHAR
+    "\"" StringChar* "\""          -> STRING
+    ~[\"\n\\]                      -> StringChar
+    "\\\""                         -> StringChar
+    BACKSLASH                      -> StringChar
     "\\"                           -> BACKSLASH
     
     ~[\n\r]*                       -> SectionName



From L.C.L.Kats at tudelft.nl  Tue Mar  2 17:34:13 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 02 Mar 2010 16:34:13 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20661 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.updatesite
Message-ID: <201003021634.o22GYDjs028013@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-02 16:34:13 +0000 (Tue, 02 Mar 2010)
New Revision: 20661

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20661&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/EditorState.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
Fixed problem with AutoEditStrategy not being able to find the active editor.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-02 16:34:13 UTC (rev 20661)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.3.9"
+      version="0.3.9.1"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">
@@ -25,7 +25,7 @@
    </license>
 
    <url>
-      <update label="Spoofax/IMP updates" url="http://www.lclnet.nl/update/unstable"/>
+      <update label="Spoofax/IMP updates" url="http://www.lclnet.nl/update/unstable/"/>
    </url>
 
    <requires>

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/EditorState.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/EditorState.java	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/EditorState.java	2010-03-02 16:34:13 UTC (rev 20661)
@@ -71,8 +71,15 @@
 	 * @throws IllegalStateException  if not called from the UI thread
 	 */
 	public static EditorState getEditorFor(IParseController parseController) {
+		assert !(parseController instanceof SGLRParseController)
+			|| !((SGLRParseController) parseController).isReplaced();
+		
 		if (parseController instanceof SGLRParseController)
 			return ((SGLRParseController) parseController).getEditor();
+		if (parseController instanceof DynamicParseController) {
+			EditorState result = ((DynamicParseController) parseController).getLastEditor();
+			if (result != null) return result;
+		}
 		
 		EditorState activeEditor = getActiveEditor();
 		if (activeEditor != null && activeEditor.getEditor().getParseController() == parseController)

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java	2010-03-02 16:34:13 UTC (rev 20661)
@@ -67,14 +67,9 @@
 		return language != null && Environment.getDescriptor(language) != null;
 	}
 	
-	public void initialize(IParseController controller) {
+	public final void initialize(IParseController controller) {
 		initialize(controller, controller.getLanguage());
 	}
-	
-	@Deprecated
-	protected void initialize(Language language) {
-		initialize(null, language);
-	}
 
 	protected void initialize(IParseController controller, Language language) {
 		// (Thrown exceptions are shown directly in the editor view.)

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java	2010-03-02 16:34:13 UTC (rev 20661)
@@ -3,6 +3,7 @@
  */
 package org.strategoxt.imp.runtime.dynamicloading;
 
+import org.eclipse.imp.language.Language;
 import org.eclipse.imp.parser.IParseController;
 import org.eclipse.imp.services.IAutoEditStrategy;
 import org.eclipse.jface.text.DocumentCommand;
@@ -32,8 +33,8 @@
 	}
 	
 	@Override
-	public void initialize(IParseController controller) {
-		super.initialize(controller);
+	protected void initialize(IParseController controller, Language language) {
+		super.initialize(controller, language);
 		IAutoEditStrategy wrapped = getWrapped();
 		if (wrapped instanceof AutoEditStrategy)
 			((AutoEditStrategy) wrapped).initialize(controller);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java	2010-03-02 16:34:13 UTC (rev 20661)
@@ -97,7 +97,13 @@
 		return getWrapped().getProject();
 	}
 	
-	protected EditorState getLastEditor() {
+	/**
+	 * Gets the editor for this parse controller, if it was already known.
+	 * 
+	 * @see EditorState#getEditorFor(IParseController) to get the actual editor
+	 */
+	public EditorState getLastEditor() {
+		// (must be a simple accessor: used in EditorState.getEditorFor()
 		return lastEditor;
 	}
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 16:34:13 UTC (rev 20661)
@@ -246,6 +246,7 @@
 	}
 	
 	private UniversalEditor getEditor() {
+		assert controller != null;
 		if (editor == null) {
 			editor = EditorState.getEditorFor(controller).getEditor();
 			lastEditor = editor;

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-02 15:51:54 UTC (rev 20660)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-02 16:34:13 UTC (rev 20661)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <site>
-   <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable">
+   <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.3.9.jar" id="org.strategoxt.imp" version="0.3.9">
+   <feature url="features/org.strategoxt.imp_0.3.9.1.jar" id="org.strategoxt.imp" version="0.3.9.1">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar  3 11:20:51 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 10:20:51 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20662 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.aterm/editor
	org.strategoxt.imp.editors.stratego/editor
	org.strategoxt.imp.feature org.strategoxt.imp.generator/src/syntax
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.updatesite
Message-ID: <201003031020.o23AKpju009534@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 10:20:51 +0000 (Wed, 03 Mar 2010)
New Revision: 20662

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20662&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/editor/ATerm-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/editor/ATerm-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/editor/ATerm-Syntax.esv	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/editor/ATerm-Syntax.esv	2010-03-03 10:20:51 UTC (rev 20662)
@@ -2,4 +2,8 @@
 
 language
 
-  fences : ( ) [ ]
\ No newline at end of file
+  fences: ( ) [ ] { } < >
+  
+  indent after: ","
+  
+  identifier lexical: [A-Za-z][A-Za-z\-0-9]*
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	2010-03-03 10:20:51 UTC (rev 20662)
@@ -7,7 +7,8 @@
   fences        : [ ]
                   ( )
                   { }
-                  {| |}
+                  {| | // hack: interacts with { }
+                  <% %>
                   |[ ]|
                   $[ ]
                   ${ }
@@ -18,6 +19,9 @@
     then
     in
     else
+    where
+    with
+    switch
     ":"
     "="
     <

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-03 10:20:51 UTC (rev 20662)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.3.9.1"
+      version="0.3.9.2"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf	2010-03-03 10:20:51 UTC (rev 20662)
@@ -24,7 +24,7 @@
 
     "completion" "keyword" ":" PropertyValue CompletionAnno -> SemanticRule {cons("CompletionKeyword")}
     
-    "completion" "template" ":" PropertyValue String+ -> SemanticRule {cons("CompletionTemplate")}
+    "completion" "template" ":" PropertyValue String+ CompletionAnno -> SemanticRule {cons("CompletionTemplate")}
 
     "completion" "trigger" ":" PropertyValue CompletionAnno -> SemanticRule {cons("CompletionTrigger")}
   
@@ -39,5 +39,8 @@
     ReservedName  -> StrategoCall {reject}
 
                  -> CompletionAnno {cons("None")}
-    "(disable)"  -> CompletionAnno {cons("Disable")}
+    "(disabled)" -> CompletionAnno {cons("Disable")}
+    "(disable)"  -> CompletionAnno {cons("Disable"), deprecated("Use (disabled) instead")}
+    "(blank)"    -> CompletionAnno {cons("Blank")}
+    "(blank)"    -> PropertyValue {reject}
     "(disable)"  -> PropertyValue {reject}

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-03 10:20:51 UTC (rev 20662)
@@ -5,7 +5,7 @@
    CompletionLexical    -- R [ H [ KW["completion"] KW["lexical"] ] KW[":"] _1 ],
    IdentifierLexical    -- R [ H [ KW["identifier"] KW["lexical"] ] KW[":"] _1 ],
    CompletionKeyword    -- R [ H [ KW["completion"] KW["keyword"] ] KW[":"] H [ _1 _2 ] ],
-   CompletionTemplate   -- R [ H [ KW["completion"] KW["template"] ] KW[":"] H [ _1 _2 ] ],
+   CompletionTemplate   -- R [ H [ KW["completion"] KW["template"] ] KW[":"] H [ _1 _2 _3 ] ],
    CompletionTemplate.2:iter-star -- _1,
    CompletionTrigger    -- R [ H [ KW["completion"] KW["trigger"] ] KW[":"] H [ _1 _2 ] ],
    HoverRule            -- R [ H [ KW["hover"]     _1 ] KW[":"] _2 ],
@@ -41,6 +41,7 @@
    AttributeRef         -- _1,
    FoldRuleAll          -- H [ KW["all"] _1 _2 ],
    FoldRule             -- H [ _1 _2 ],
+   Disable              -- KW["(blank)"],
    Disable              -- KW["(disabled)"],
    Folded               -- KW["(folded)"],
    None                 -- ,

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 10:20:51 UTC (rev 20662)
@@ -140,13 +140,13 @@
 			String lineEnd = getLineAfterOffset(document, offset, length);
 			String upToCursor;
 			if (isCloseFenceLine(lineEnd)) {
-				upToCursor = "\n" + getIndentation(lineStart) + createIndentationLevel();
-				document.replace(offset, length, upToCursor + "\n" + getIndentation(lineStart));
+				upToCursor = "\n" + getIndentation(lineStart, true) + createIndentationLevel();
+				document.replace(offset, length, upToCursor + "\n" + getIndentation(lineStart, true));
 			} else if (isOpenFenceLine(lineStart)) {
-				upToCursor = "\n" + getIndentation(lineStart) + createIndentationLevel();
+				upToCursor = "\n" + getIndentation(lineStart, true) + createIndentationLevel();
 				document.replace(offset, length, upToCursor);
 			} else {
-				upToCursor = "\n" + getIndentation(lineStart);
+				upToCursor = "\n" + getIndentation(lineStart, true);
 				document.replace(offset, length, upToCursor);
 			}
 			viewer.setSelectedRange(offset + upToCursor.length(), 0);
@@ -193,7 +193,7 @@
 	}
 
 	public static String formatInsertedText(String text, String lineStart) {
-		return text.replace("\\n", "\n" + getIndentation(lineStart))
+		return text.replace("\\n", "\n" + getIndentation(lineStart, true))
 				.replace("\\t", createIndentationLevel())
 				.replace("\\\"", "\"")
 				.replace("\\\\", "\\");
@@ -349,12 +349,22 @@
 	}
 	
 	private static String getIndentation(String line) {
+		return getIndentation(line, false);
+	}
+	
+	private static String getIndentation(String line, boolean considerPrefix) {
 		int i = 0;
 		
+		// HACK: support Stratego-like prefix semicolons
+		if (considerPrefix)
+			line = line.replace(';', ' ').replace(',', ' ');
+		
 		for (int length = line.length(); i < length; i++) {
-			if (line.charAt(i) != ' ' && line.charAt(i) != '\t')
+			char c = line.charAt(i);
+			if (c != ' ' && c != '\t') {
 				return line.substring(0, i);
-		} 
+			}
+		}
 		
 		return i == line.length() ? line : "";
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-02 16:34:13 UTC (rev 20661)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-03 10:20:51 UTC (rev 20662)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.3.9.1.jar" id="org.strategoxt.imp" version="0.3.9.1">
+   <feature url="features/org.strategoxt.imp_0.3.9.2.jar" id="org.strategoxt.imp" version="0.3.9.2">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar  3 12:57:30 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 11:57:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20663 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003031157.o23BvUS9011473@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 11:57:30 +0000 (Wed, 03 Mar 2010)
New Revision: 20663

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20663&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java

Log:
Spoofax/36: Editor doesn't scroll when adding new line to end of file
(urgh, please don't look at how I got Eclipse to call the package-private showCaret() method)

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 10:20:51 UTC (rev 20662)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 11:57:30 UTC (rev 20663)
@@ -23,6 +23,8 @@
 import org.eclipse.jface.text.IRegion;
 import org.eclipse.jface.text.Region;
 import org.eclipse.jface.text.source.ISourceViewer;
+import org.eclipse.swt.custom.ST;
+import org.eclipse.swt.custom.StyledText;
 import org.eclipse.swt.custom.VerifyKeyListener;
 import org.eclipse.swt.events.VerifyEvent;
 import org.eclipse.swt.graphics.Point;
@@ -98,11 +100,16 @@
 			String input = new String(new char[] { event.character });
 			Point selection = getEditor().getSelection();
 			ISourceViewer viewer = getEditor().getServiceControllerManager().getSourceViewer();
-			if (indentAfterNewline(viewer, viewer.getDocument(), selection.x, selection.y, input)
-					|| insertClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input)
+			if (event.widget instanceof StyledText && indentAfterNewline(viewer, viewer.getDocument(), selection.x, selection.y, input)) {
+				// Make sure caret is visible (urgh)
+				((StyledText) event.widget).invokeAction(ST.LINE_UP);
+				((StyledText) event.widget).invokeAction(ST.LINE_DOWN);
+				event.doit = false;
+			} else if (insertClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input)
 					|| skipClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input)
-					|| undoClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input))
+					|| undoClosingFence(viewer, viewer.getDocument(), selection.x, selection.y, input)) {
 				event.doit = false;
+			}
 		} catch (BadLocationException e) {
 			Environment.logException("Could not determine auto edit strategy", e);
 		} catch (RuntimeException e) {
@@ -111,6 +118,9 @@
 	}
 
 	protected void indentPastedContent(IDocument document, DocumentCommand command) throws BadLocationException {
+		// UNDONE: Disabled smart pasting for now
+		if ("true".equals("true"))
+			return;
 		if (isIndentable(command)) {
 			String lineStart = getLineBeforeOffset(document, command.offset);
 			if (lineStart.trim().length() > 0) {
@@ -120,8 +130,8 @@
 				return;
 			}
 			String indentation = getIndentation(lineStart);
-			if (isCloseFenceLine(lineStart))
-				indentation += createIndentationLevel();
+			//if (isCloseFenceLine(lineStart)) (noop with above sanity check)
+			//	indentation += createIndentationLevel();
 			command.text = setIndentation(command.text, indentation);
 		}
 	}
@@ -150,6 +160,7 @@
 				document.replace(offset, length, upToCursor);
 			}
 			viewer.setSelectedRange(offset + upToCursor.length(), 0);
+			// viewer.setSelectedRange(offset - 1, 0);
 			return true;
 		}
 		return false;



From L.C.L.Kats at tudelft.nl  Wed Mar  3 14:06:35 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 13:06:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20664 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.updatesite
Message-ID: <201003031306.o23D6ZOh012717@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 13:06:34 +0000 (Wed, 03 Mar 2010)
New Revision: 20664

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20664&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
0.3.9.3 beta release

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-03 11:57:30 UTC (rev 20663)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-03 13:06:34 UTC (rev 20664)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.3.9.2"
+      version="0.3.9.3"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-03 11:57:30 UTC (rev 20663)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-03 13:06:34 UTC (rev 20664)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.3.9.2.jar" id="org.strategoxt.imp" version="0.3.9.2">
+   <feature url="features/org.strategoxt.imp_0.3.9.3.jar" id="org.strategoxt.imp" version="0.3.9.3">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar  3 15:32:01 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 14:32:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20665 - LennartKats -
	in strc-java/trunk:
	java/runtime/org/strategoxt/lang/compat/override test test/sglr
Message-ID: <201003031432.o23EW15H013998@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 14:32:01 +0000 (Wed, 03 Mar 2010)
New Revision: 20665

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20665&view=rev

Added:
   strc-java/trunk/test/sglr/Entities.ent
   strc-java/trunk/test/sglr/Entities.tbl
   strc-java/trunk/test/sglr/entities.str
Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser.str
   strc-java/trunk/test/Makefile.am

Log:
Added <memo-open-parse-table> calls so parse-file works without requiring <open-parse-table>.

Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str	2010-03-03 13:06:34 UTC (rev 20664)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser-compat.str	2010-03-03 14:32:01 UTC (rev 20665)
@@ -25,17 +25,14 @@
     jsglr-open-parsetable
 
   override parse-file(on-open-error, on-parse-error | tbl, start-symbol, path) =
-    where(!tbl => ParseTable(internal-tbl))
-    ; (<fopen> (<id>, "r") => stream <+ on-open-error; fail)
+      (<fopen> (<id>, "r") => stream <+ on-open-error; fail)
     ; finally(
         parse-stream(on-parse-error | tbl, start-symbol, path)
       , <fclose> stream
       )
 
   override parse-xtc-file(on-open-error, on-parse-error |tbl, start-symbol, path) =
-    where(!tbl => ParseTable(internal-tbl))
-    
-    ; let open-stream =
+      let open-stream =
             ?FILE(<id>); (<fopen> (<id>, "r") <+ on-open-error)
             <+ ?stdin(); stdin-stream
             
@@ -47,14 +44,8 @@
       end
   
   override parse-xtc-file-report-errors(|tbl, sort) =
-    if is-parse-table-open(|tbl) then
-      parse-xtc-file(strsglr-perror, strsglr-report-parse-error | tbl, sort)
-    else
-      // open the parse table and call recursive
-      let parse(|tbl') = parse-xtc-file-report-errors(|tbl', sort)
-       in open-parse-table-wrap-report-errors(parse| tbl)
-      end
-    end
+  	where(<try(memo-open-parse-table)> tbl => tbl');
+    parse-xtc-file(strsglr-perror, strsglr-report-parse-error | tbl', sort)
   
   override parse-stream(on-parse-error |tbl, start-symbol, path):
     stream -> term

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser.str
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser.str	2010-03-03 13:06:34 UTC (rev 20664)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/override/jsglr-parser.str	2010-03-03 14:32:01 UTC (rev 20665)
@@ -1,4 +1,4 @@
-module org/strategoxt/lang/compat/jsglr-parser // org/spoofax/bindings/jsglr/jsglr-parser
+module jsglr-parser // org/spoofax/bindings/jsglr/jsglr-parser
 
 imports
   libstratego-lib
@@ -40,11 +40,3 @@
       where(<try(not(?ParseTable(_)); memo-open-parse-table)> tbl => ParseTable(internal-tbl))
     ; ?string
     ; prim("JSGLR_parse_string_pt_compat", on-parse-error | string, internal-tbl, start-symbol, path)
-    
-  internal memo-open-parse-table = // HACK: copied here until a new STRC baseline is set
-    MemoOpenParseTable'
-  <+
-    ?trm
-    ; open-parse-table => tbl
-    ; rules(MemoOpenParseTable' : trm -> tbl)
-

Modified: strc-java/trunk/test/Makefile.am
===================================================================
--- strc-java/trunk/test/Makefile.am	2010-03-03 13:06:34 UTC (rev 20664)
+++ strc-java/trunk/test/Makefile.am	2010-03-03 14:32:01 UTC (rev 20665)
@@ -1,6 +1,6 @@
 include $(top_srcdir)/Makefile.xt
 
-TESTFILES    = $(BASICTESTFILES) $(STRC1TESTFILES) $(STRC2TESTFILES) $(ASTERTESTFILES)
+TESTFILES    = $(BASICTESTFILES) $(STRC1TESTFILES) $(STRC2TESTFILES) $(ASTERTESTFILES) $(SGLRTESTFILES)
 JAVAFILES    = $(subst .str,.java,$(subst -,_,$(TESTFILES)))
 CLASSFILES   = $(subst .str,.java,$(subst -,_,$(TESTFILES)))
 CTREEFILES   = $(subst .java,.ctree,$(JAVAFILES))
@@ -67,6 +67,10 @@
 
 BASICTESTFILES=$(addprefix basic/,$(addsuffix .str,$(BASICTESTS)))
 
+SGLRTESTS=entities
+
+SGLRTESTFILES=$(addprefix sglr/,$(addsuffix .str,$(SGLRTESTS)))
+
 ASTERTESTS=test_attributes
 
 ASTERTESTFILES=$(addprefix aster/,$(addsuffix .str,$(ASTERTESTS)))
@@ -101,7 +105,7 @@
 	aster -i $< -o $@
 
 %.java : %.ctree ../trans/strj
-	../trans/strj --verbose 2 -i $< -o $@ -la stratego-lib -la java-front -la stratego-sglr -I $(STRATEGOXT)/share/sdf/stratego-front -I strc1 -I parallel -la strc `if echo $< | grep parallel >/dev/null; then echo -la stratego-parallel; fi`
+	../trans/strj --verbose 2 -i $< -o $@ -la stratego-lib -la java-front -la stratego-sglr -I $(STRATEGOXT)/share/sdf/stratego-front -I strc1 -I sglr -I parallel -la strc `if echo $< | grep parallel >/dev/null; then echo -la stratego-parallel; fi`
 
 %.class : %.java
 	$(JAVAC) $(JAVACFLAGS) $<
@@ -134,7 +138,7 @@
 	$(PGEN)/bin/sdf2table $(PGEN_FLAGS) -i $< -o $@
 
 %.crun : %.str
-	strc -la strc -la stratego-lib -i $<
+	strc -la strc -la stratego-lib -i $< -I sglr
 	(cd `dirname $<`; ./`basename $< .str`)
 
 strc1/cs_test01.ctree : strc1/ExpStratego.tbl strc1/Expressions.def strc1/Expressions.str

Added: strc-java/trunk/test/sglr/Entities.ent
===================================================================
--- strc-java/trunk/test/sglr/Entities.ent	                        (rev 0)
+++ strc-java/trunk/test/sglr/Entities.ent	2010-03-03 14:32:01 UTC (rev 20665)
@@ -0,0 +1 @@
+module A entity B {} 

Added: strc-java/trunk/test/sglr/Entities.tbl
===================================================================
(Binary files differ)


Property changes on: strc-java/trunk/test/sglr/Entities.tbl
___________________________________________________________________
Added: svn:mime-type
   + application/octet-stream

Added: strc-java/trunk/test/sglr/entities.str
===================================================================
--- strc-java/trunk/test/sglr/entities.str	                        (rev 0)
+++ strc-java/trunk/test/sglr/entities.str	2010-03-03 14:32:01 UTC (rev 20665)
@@ -0,0 +1,14 @@
+module entities
+
+imports
+  libstratego-lib
+  libstratego-xtc
+  libstratego-sglr
+
+rules
+
+  main =
+    <parse-file> "/tmp/foo.ent"
+  
+  parse-file =
+    parse-file(|<import-term(Entities.tbl)>)



From L.C.L.Kats at tudelft.nl  Wed Mar  3 15:44:44 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 14:44:44 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20666 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <201003031444.o23EiilA014088@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 14:44:44 +0000 (Wed, 03 Mar 2010)
New Revision: 20666

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20666&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str

Log:
Show errors when parse-file/parse-string is used.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-03 14:32:01 UTC (rev 20665)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-03 14:44:44 UTC (rev 20666)
@@ -204,10 +204,16 @@
 strategies
 
   parse-file =
-    parse-file(|<import-term(include/{sdf-name}.tbl)>)
+    parse-file(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/{sdf-name}.tbl)>
+    )
 
   parse-string =
-    parse-string(|<import-term(include/{sdf-name}.tbl)>)
+    parse-string(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/{sdf-name}.tbl)>
+    )
   
 strategies
   



From L.C.L.Kats at tudelft.nl  Wed Mar  3 15:45:00 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 14:45:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20667 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003031445.o23Ej02Q014091@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 14:45:00 +0000 (Wed, 03 Mar 2010)
New Revision: 20667

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20667&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java

Log:
Fixed weird indentation when cursor is at closing brace.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 14:44:44 UTC (rev 20666)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 14:45:00 UTC (rev 20667)
@@ -149,12 +149,15 @@
 			String lineStart = getLineBeforeOffset(document, offset);
 			String lineEnd = getLineAfterOffset(document, offset, length);
 			String upToCursor;
-			if (isCloseFenceLine(lineEnd)) {
-				upToCursor = "\n" + getIndentation(lineStart, true) + createIndentationLevel();
-				document.replace(offset, length, upToCursor + "\n" + getIndentation(lineStart, true));
-			} else if (isOpenFenceLine(lineStart)) {
-				upToCursor = "\n" + getIndentation(lineStart, true) + createIndentationLevel();
-				document.replace(offset, length, upToCursor);
+			String closeFence = getCloseFenceForOpenFenceLine(lineStart);
+			if (closeFence != null) {
+				if (isCloseFenceLine(lineEnd, closeFence)) {
+					upToCursor = "\n" + getIndentation(lineStart, true) + createIndentationLevel();
+					document.replace(offset, length, upToCursor + "\n" + getIndentation(lineStart, true));
+				} else {
+					upToCursor = "\n" + getIndentation(lineStart, true) + createIndentationLevel();
+					document.replace(offset, length, upToCursor);
+				}
 			} else {
 				upToCursor = "\n" + getIndentation(lineStart, true);
 				document.replace(offset, length, upToCursor);
@@ -384,9 +387,11 @@
 	 * Tests if the line ends with an opening fence,
 	 * ignoring whitespace, comments, and lexicals.
 	 * 
+	 * @return the matching closing fence, or null if no open fence on this line
+	 * 
 	 * @see stripCommentsAndLayout(String)
 	 */
-	private boolean isOpenFenceLine(String line) {
+	private String getCloseFenceForOpenFenceLine(String line) {
 		line = stripCommentsAndLayout(line);
 		for (int i = 1; i <= maxOpenFenceLength && i <= line.length(); i++) {
 			int offset = line.length() - i;
@@ -394,9 +399,9 @@
 			String closeFence = getMatchingCloseFence(openFence);
 			if (closeFence != null
 					&& (!isIdentifier(openFence) || offset == 0 || !isIdentifier(line.substring(offset - 1, offset))))
-				return true;
+				return closeFence;
 		}
-		return false;
+		return null;
 	}
 	
 	/**
@@ -405,12 +410,11 @@
 	 * 
 	 * @see stripCommentsAndLayout(String)
 	 */
-	private boolean isCloseFenceLine(String line) {
+	private boolean isCloseFenceLine(String line, String fence) {
 		line = stripCommentsAndLayout(line);
 		for (int i = 1; i <= maxCloseFenceLength && i <= line.length(); i++) {
 			String closeFence = line.substring(0, i);
-			String openFence = getMatchingOpenFence(closeFence);
-			if (openFence != null
+			if (closeFence.equals(fence)
 					&& (!isIdentifier(closeFence) || i == line.length() || !isIdentifier(line.substring(i, i + 1))))
 				return true;
 		}



From L.C.L.Kats at tudelft.nl  Wed Mar  3 16:00:07 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 15:00:07 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20668 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.adapter.aterm/src/org/spoofax/interpreter/adapter/aterm
	strc-java/trunk/java
Message-ID: <201003031500.o23F07Pl014206@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 15:00:07 +0000 (Wed, 03 Mar 2010)
New Revision: 20668

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20668&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.adapter.aterm/src/org/spoofax/interpreter/adapter/aterm/ATermConverter.java
   strc-java/trunk/java/spoofax-libs.jar

Log:
Safer empty list check in ATermConverter.

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.adapter.aterm/src/org/spoofax/interpreter/adapter/aterm/ATermConverter.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.adapter.aterm/src/org/spoofax/interpreter/adapter/aterm/ATermConverter.java	2010-03-03 14:45:00 UTC (rev 20667)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.adapter.aterm/src/org/spoofax/interpreter/adapter/aterm/ATermConverter.java	2010-03-03 15:00:07 UTC (rev 20668)
@@ -156,7 +156,7 @@
     @SuppressWarnings("unchecked")
     protected <T extends IStrategoTerm> T annotate(T term, ATerm input) {
         ATermList annotations = input.getAnnotations();
-        if (annotations == null || annotations == emptyList) {
+        if (annotations == null || annotations == emptyList || annotations.isEmpty()) {
             return term;
         } else {
             return (T) factory.annotateTerm(term, (IStrategoList) convert(annotations));

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Wed Mar  3 16:17:57 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 15:17:57 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20669 - LennartKats -
	strc-java/trunk/test
Message-ID: <201003031517.o23FHvol014695@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 15:17:57 +0000 (Wed, 03 Mar 2010)
New Revision: 20669

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20669&view=rev

Modified:
   strc-java/trunk/test/Makefile.am

Log:
buildfix

Changes:

Modified: strc-java/trunk/test/Makefile.am
===================================================================
--- strc-java/trunk/test/Makefile.am	2010-03-03 15:00:07 UTC (rev 20668)
+++ strc-java/trunk/test/Makefile.am	2010-03-03 15:17:57 UTC (rev 20669)
@@ -14,6 +14,7 @@
   $(wildcard */*.sdf) \
   $(wildcard */*.tbl) \
   $(wildcard */*.trm) \
+  $(wildcard */*.ent) \
   $(wildcard */*.in) \
   $(wildcard */*.res) \
   test-tools.sh



From L.C.L.Kats at tudelft.nl  Wed Mar  3 16:20:00 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 15:20:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20670 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast
Message-ID: <201003031520.o23FK0Kb014711@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 15:20:00 +0000 (Wed, 03 Mar 2010)
New Revision: 20670

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20670&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java	2010-03-03 15:17:57 UTC (rev 20669)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java	2010-03-03 15:20:00 UTC (rev 20670)
@@ -1,6 +1,7 @@
 package org.strategoxt.imp.runtime.parser.ast;
 
-import static org.spoofax.jsglr.Term.*;
+import static org.spoofax.jsglr.Term.termAt;
+import static org.spoofax.jsglr.Term.toInt;
 
 import java.util.ArrayList;
 import java.util.List;
@@ -8,14 +9,13 @@
 import lpg.runtime.IToken;
 
 import org.spoofax.NotImplementedException;
+import org.strategoxt.imp.runtime.Environment;
 
 import aterm.ATerm;
 import aterm.ATermAppl;
-import aterm.ATermFactory;
 import aterm.ATermInt;
 import aterm.ATermList;
 import aterm.ATermPlaceholder;
-import aterm.pure.PureFactory;
 
 
 /**
@@ -27,8 +27,6 @@
  * @author Lennart Kats <lennart add lclnet.nl>
  */
 public class AstAnnoImploder {
-	
-	private final ATermFactory atermFactory = new PureFactory();
 
 	private final AstNodeFactory factory;
 	
@@ -48,7 +46,7 @@
 		String astString = ast.toString();
 		if (astString.startsWith("\"") && astString.endsWith("\"")) {
 			astString = astString.substring(1, astString.length() - 1);
-			ast = atermFactory.parse(astString);
+			ast = Environment.getATermFactory().parse(astString);
 		}
 		
 		return toAstNode(ast, sort);



From L.C.L.Kats at tudelft.nl  Wed Mar  3 18:20:01 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 17:20:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20671 - LennartKats -
	in spoofax-imp/trunk:
	org.strategoxt.imp.editors.editorservice/editor
	org.strategoxt.imp.editors.sdf/editor
	org.strategoxt.imp.editors.stratego/editor
	org.strategoxt.imp.editors.stratego/lib org.strategoxt.imp.feature
	org.strategoxt.imp.generator/src/sdf2imp/services
	org.strategoxt.imp.generator/src/syntax
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.updatesite
Message-ID: <201003031720.o23HK1VK016366@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 17:20:01 +0000 (Wed, 03 Mar 2010)
New Revision: 20671

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20671&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/ContentProposerFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
Small refinements to completion template definition language.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-03 17:20:01 UTC (rev 20671)
@@ -5,46 +5,46 @@
 completions
   
   completion template:
-    "completion template" ":\n\t" "prefix" " \"c\""
+    "completion template" ":\n\t" <prefix> " \"c\"" (blank)
   
   completion template:
-    "completion lexical" ":\n\t" "regex"
+    "completion lexical" ":\n\t" <regex> (blank)
   
   completion template:
-    "completion proposer" ":\n\t" "s"
+    "completion proposer" ":\n\t" <s> (blank)
   
   completion template:
-    "completion keyword" ":\n\t" "k"
+    "completion keyword" ":\n\t" <k> (blank)
   
   completion template:
-    "completion trigger" ":\n\t" "regex"
-  
+    "completion trigger" ":\n\t" <regex> (blank)
+    
   completion template:
-  	"observer" ": " "s"
+  	"observer" ": " <s> (blank)
   
   completion template:
-  	"builder" ": \"caption\" = " "s"
+  	"builder" ": " <"caption"> " = " <s> (blank)
   
   completion template:
-  	"unmanaged table" ": " "prefix" "*"
+  	"unmanaged table" ": " <prefix> "*" (blank)
   
   completion template:
-  	"line comment" ": " "prefix"
+  	"line comment" ": " <prefix> (blank)
   
   completion template:
-  	"block comment" ":\n\t" "prefix" " " "middle" " " "end"
+  	"block comment" ":\n\t" <prefix> " " <middle> " " <end> (blank)
   
   completion template:
-  	"fences" ":\n\t" "f" " " "g"
+  	"fences" ":\n\t" <f> " " <g> (blank)
  
   completion template:
-  	"indent after" ":\n\t" "keyword"
+  	"indent after" ":\n\t" <keyword> (blank)
   
   completion template:
-  	"reference" " _ : " "s"
+  	"reference" " _ : " <s> (blank)
   
   completion template:
-    "occurrence" " _ : " "s"
+    "occurrence" " _ : " <s> (blank)
   
   completion template:
-    "hover" " _ : " "s"
+    "hover" " _ : " <s> (blank)

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-03 17:20:01 UTC (rev 20671)
@@ -5,52 +5,52 @@
 completions
 
   completion template:
-  	"context-free syntax" "\n\t"
+  	"context-free syntax" "\n\t" (blank)
 
   completion template:
-  	"lexical syntax" "\n\t"
+  	"lexical syntax" "\n\t" (blank)
 
   completion template:
-  	"syntax" "\n\t"
+  	"syntax" "\n\t" (blank)
 
   completion template:
-  	"imports" "\n\t"
+  	"imports" "\n\t" (blank)
 
   completion template:
-  	"exports" "\n\t"
+  	"exports" "\n\t" (blank)
 
   completion template:
-  	"context-free restrictions" "\n\t"
+  	"context-free restrictions" "\n\t" (blank)
 
   completion template:
-  	"lexical restrictions" "\n\t"
+  	"lexical restrictions" "\n\t" (blank)
 
   completion template:
-  	"restrictions" "\n\t"
+  	"restrictions" "\n\t" (blank)
 
   completion template:
-  	"context-free start-symbols" "\n\t" "Start"
+  	"context-free start-symbols" "\n\t" <Start> (blank)
 
   completion template:
-  	"lexical start-symbols" "\n\t" "Start"
+  	"lexical start-symbols" "\n\t" <Start> (blank)
 
   completion template:
-  	"start-symbols" "\n\t" "Start"
+  	"start-symbols" "\n\t" <Start> (blank)
 
   completion template:
-  	"sorts" "\n\t"
+  	"sorts" "\n\t" (blank)
 
   completion template:
-  	"variables" "\n\t"
+  	"variables" "\n\t" (blank)
 
   completion template:
-  	"aliases" "\n\t"
+  	"aliases" "\n\t" (blank)
 
   completion template:
-  	"priorities" "\n\t"
+  	"priorities" "\n\t" (blank)
 
   completion template:
-  	"module" "x\n\t\nexports\n\t"
+  	"module" <x> "\n\t\nexports\n\t" (blank)
 
   completion template:
-  	"lexical variables" "\n\t"
\ No newline at end of file
+  	"lexical variables" "\n\t" (blank)

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv	2010-03-03 17:20:01 UTC (rev 20671)
@@ -29,16 +29,29 @@
   hover _ : editor-hover
   
   completion template:
-    "if" " " "e" " then\n\ts\nend"
+    "if" " " <e> " then\n\t" <s> "\nend"
       
   completion template:
-    "switch" " " "s" "\n\tcase " "c" ":" " " "s" "\n\totherwise: " "id" "\nend"
+    "switch" " " <s> "\n\tcase " <c> ":" " " <s> "\n\totherwise: " <id> "\nend"
 
   completion template:
-  	"let" "\n\t" "x" " = " "s" "\nin\n\t" "s" "\nend"
+  	"let" "\n\t" <x> " = " <s> "\nin\n\t" <s> "\nend"
 
-  completion keyword:
-  	"where"
+  completion template:
+  	"where" "\n\t" (blank)
   	
-  completion keyword:
-  	"with"
\ No newline at end of file
+  completion template:
+  	"with" "\n\t" (blank)
+  
+  completion template:
+    "strategies" "\n\t" (blank)
+  
+  completion template:
+    "rules" "\n\t" (blank)
+  
+  completion template:
+    "signature constructors" "\n\t" (blank)
+  
+  completion template:
+    "signature sorts" "\n\t" (blank)
+

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-03 17:20:01 UTC (rev 20671)
@@ -7,10 +7,16 @@
 strategies
 
   parse-file =
-    parse-file(|<import-term(include/Stratego-Sugar.tbl)>)
+    parse-file(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/Stratego-Sugar.tbl)>
+    )
 
   parse-string =
-    parse-string(|<import-term(include/Stratego-Sugar.tbl)>)
+    parse-string(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/Stratego-Sugar.tbl)>
+    )
   
 strategies
   

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-03 17:20:01 UTC (rev 20671)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.3.9.3"
+      version="0.3.9.4"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str	2010-03-03 17:20:01 UTC (rev 20671)
@@ -31,8 +31,8 @@
         completions
           ~~
           ~// Syntax completion:
-          completion template: "module " "m"
-          completion template: "entity " "e" " {}"
+          completion template: "module " <m>        (blank)
+          completion template: "entity " <e> " {}"  (blank)
           ~~
           ~// Semantic (identifier) completion:
           completion proposer: editor-complete
@@ -57,13 +57,18 @@
           ~// Syntactic content completion can be defined as follows:
           ~//
           ~//   completion keyword  : "keyword"
-          ~//   completion template : "if " "e" " then\n\ts\nend"
+          ~//   completion template : "if " <e> " then\n\t" <s> "\nend"
           ~//
           ~// This defines keyword completion for "keyword" and
           ~// a template completion for the "if" keyword (note the use of \n, \t, and spaces).
-          ~// In this template, the text selection expands to the "e" identifier
-          ~// if it matches the identifier lexical of YourLanguage-Syntax.esv.
+          ~// In this template, the text selection expands to the "e" placeholder identifier
+          ~// enclosed in <> brackets.
           ~//
+          ~// Use the (blank) annotation if you want a template completion only to
+          ~// appear on blank lines:
+          ~//
+          ~//   completion template: "section" <title> "\n\t" (blank)
+          ~//
           ~// Semantic content completion can be defined as follows:
           ~//
           ~//   completion proposer : completion-function-call  

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/CompletionsService.sdf	2010-03-03 17:20:01 UTC (rev 20671)
@@ -6,7 +6,7 @@
 exports
 
   sorts
-    CompletionAnno
+    CompletionPart CompletionAnno
 
   syntax
   
@@ -24,7 +24,7 @@
 
     "completion" "keyword" ":" PropertyValue CompletionAnno -> SemanticRule {cons("CompletionKeyword")}
     
-    "completion" "template" ":" PropertyValue String+ CompletionAnno -> SemanticRule {cons("CompletionTemplate")}
+    "completion" "template" ":" PropertyValue CompletionPart+ CompletionAnno -> SemanticRule {cons("CompletionTemplate")}
 
     "completion" "trigger" ":" PropertyValue CompletionAnno -> SemanticRule {cons("CompletionTrigger")}
   
@@ -37,6 +37,9 @@
     "builder"     -> StrategoCall {reject}
     "occurrence"  -> StrategoCall {reject}
     ReservedName  -> StrategoCall {reject}
+    
+    String      -> CompletionPart
+    Placeholder -> CompletionPart {cons("Placeholder")}
 
                  -> CompletionAnno {cons("None")}
     "(disabled)" -> CompletionAnno {cons("Disable")}
@@ -44,3 +47,9 @@
     "(blank)"    -> CompletionAnno {cons("Blank")}
     "(blank)"    -> PropertyValue {reject}
     "(disable)"  -> PropertyValue {reject}
+
+  lexical syntax
+    
+    "<" PlaceholderChar* ">" -> Placeholder
+    ~[\>\n]                  -> PlaceholderChar
+    
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-03 17:20:01 UTC (rev 20671)
@@ -4,6 +4,7 @@
    CompletionProposer   -- R [ H [ KW["completion"] KW["proposer"] ] KW[":"] _1 ],
    CompletionLexical    -- R [ H [ KW["completion"] KW["lexical"] ] KW[":"] _1 ],
    IdentifierLexical    -- R [ H [ KW["identifier"] KW["lexical"] ] KW[":"] _1 ],
+   Placeholder          -- H hs=0 [ KW["<"] _1 KW[">"] ],
    CompletionKeyword    -- R [ H [ KW["completion"] KW["keyword"] ] KW[":"] H [ _1 _2 ] ],
    CompletionTemplate   -- R [ H [ KW["completion"] KW["template"] ] KW[":"] H [ _1 _2 _3 ] ],
    CompletionTemplate.2:iter-star -- _1,

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/ContentProposerFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/ContentProposerFactory.java	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/ContentProposerFactory.java	2010-03-03 17:20:01 UTC (rev 20671)
@@ -97,8 +97,9 @@
 			IStrategoTerm prefixTerm = termAt(template, 0);
 			String prefix = termContents(prefixTerm);
 			IStrategoList completionParts = termAt(template, 1);
+			IStrategoTerm anno = termAt(template, 2);
 			completionParts = Environment.getTermFactory().makeListCons(prefixTerm, completionParts);
-			results.add(new ContentProposalTemplate(prefix, completionParts));
+			results.add(new ContentProposalTemplate(prefix, completionParts, "Blank".equals(cons(anno))));
 		}
 		
 		return results.toArray(new ContentProposalTemplate[0]);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/AutoEditStrategy.java	2010-03-03 17:20:01 UTC (rev 20671)
@@ -440,6 +440,7 @@
 		return null;
 	}
 	
+	@SuppressWarnings("unused")
 	private String getMatchingOpenFence(String text) {
 		if (text.length() > maxCloseFenceLength)
 			return null;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java	2010-03-03 17:20:01 UTC (rev 20671)
@@ -23,6 +23,7 @@
 import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.imp.runtime.dynamicloading.TermReader;
 
 /**
  * A content proposal that selects the lexical at the cursor location.
@@ -108,8 +109,10 @@
 	private Point proposalPartsToSelection(IDocument document, IStrategoList proposalParts, int offset) {
 		int i = termContents(proposalParts.head()).length();
 		for (IStrategoList cons = proposalParts.tail(); !cons.isEmpty(); cons = cons.tail()) {
-			String part = proposalPartToString(document, cons.head());
-			if (proposer.getCompletionLexical().matcher(part).matches())
+			IStrategoTerm partTerm = cons.head();
+			String part = proposalPartToString(document, partTerm);
+			if ("Placeholder".equals(TermReader.cons(partTerm)) 
+					|| proposer.getCompletionLexical().matcher(part).matches())
 				return new Point(offset + i, part.length());
 			i += part.length();
 		}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java	2010-03-03 17:20:01 UTC (rev 20671)
@@ -16,10 +16,13 @@
 	private final String prefix;
 	
 	private final IStrategoList completionParts;
+	
+	private final boolean blankLineRequired;
 
-	public ContentProposalTemplate(String prefix, IStrategoList completionParts) {
+	public ContentProposalTemplate(String prefix, IStrategoList completionParts, boolean blankLineRequired) {
 		this.prefix = prefix;
 		this.completionParts = completionParts;
+		this.blankLineRequired = blankLineRequired;
 	}
 
 	public String getPrefix() {
@@ -29,6 +32,10 @@
 	public IStrategoList getCompletionParts() {
 		return completionParts;
 	}
+	
+	public boolean isBlankLineRequired() {
+		return blankLineRequired;
+	}
 
 	public String getDescription() {
 		StringBuilder result = new StringBuilder();

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-03 17:20:01 UTC (rev 20671)
@@ -311,6 +311,7 @@
 		Set<ICompletionProposal> results = new HashSet<ICompletionProposal>();
 		boolean backTrackResultsOnly = false;
 		
+		// TODO: simplify - turn completion keywords in completion templates?
 		for (String proposal : keywords) {
 			if (!backTrackResultsOnly && proposal.regionMatches(IGNORE_TEMPLATE_PREFIX_CASE, 0, prefix, 0, prefix.length())) {
 				if (prefix.length() > 0 || identifierLexical.matcher(proposal).lookingAt())
@@ -325,6 +326,7 @@
 					do {
 						if (document.regionMatches(offset - matcher.start() - prefix.length(), proposal, 0, matcher.start()) 
 								&& proposal.regionMatches(matcher.start(), prefix, 0, prefix.length())) {
+							
 							String subProposal = proposal.substring(matcher.start());
 							if (!backTrackResultsOnly) results.clear();
 							backTrackResultsOnly = true;
@@ -340,7 +342,8 @@
 		for (ContentProposalTemplate proposal : templates) {
 			String proposalPrefix = proposal.getPrefix();
 			if (!backTrackResultsOnly && proposalPrefix.regionMatches(IGNORE_TEMPLATE_PREFIX_CASE, 0, prefix, 0, prefix.length())) {
-				results.add(new ContentProposal(this, proposal.getPrefix(), proposal, prefix, offsetRegion));
+				if (!proposal.isBlankLineRequired() || isBlankBeforeOffset(document, offset - prefix.length()))
+					results.add(new ContentProposal(this, proposal.getPrefix(), proposal, prefix, offsetRegion));
 			} else {
 				Matcher matcher = identifierLexical.matcher(proposalPrefix);
 				if (matcher.find() && (matcher.start() > 0 || matcher.end() < proposalPrefix.length())) {
@@ -350,6 +353,8 @@
 					do {
 						if (document.regionMatches(offset - matcher.start() - prefix.length(), proposalPrefix, 0, matcher.start()) 
 								&& proposalPrefix.regionMatches(matcher.start(), prefix, 0, prefix.length())) {
+							
+							// TODO: respect proposal.isBlankLineRequired() here?
 							String subProposal = proposalPrefix.substring(matcher.start());
 							if (!backTrackResultsOnly) results.clear();
 							backTrackResultsOnly = true;
@@ -364,6 +369,17 @@
 		return results;
 	}
 
+	private static boolean isBlankBeforeOffset(String document, int offset) {
+		for (int i = offset - 1; i > 0; i--) {
+			switch (document.charAt(i)) {
+				case ' ': case '\t': continue;
+				case '\n': return true;
+				default: return false;
+			}
+		}
+		return true;
+	}
+
 	private ICompletionProposal[] createErrorProposal(String error, int offset) {
 		return new ICompletionProposal[] { new ErrorProposal(error, offset) };
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-03 15:20:00 UTC (rev 20670)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-03 17:20:01 UTC (rev 20671)
@@ -3,9 +3,6 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.3.9.3.jar" id="org.strategoxt.imp" version="0.3.9.3">
-      <category name="Spoofax/IMP"/>
-   </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">
       <description>
          Spoofax/IMP IDE metatooling environment



From L.C.L.Kats at tudelft.nl  Wed Mar  3 18:25:06 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 17:25:06 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20672 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003031725.o23HP6pB016387@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 17:25:06 +0000 (Wed, 03 Mar 2010)
New Revision: 20672

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20672&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java	2010-03-03 17:20:01 UTC (rev 20671)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposal.java	2010-03-03 17:25:06 UTC (rev 20672)
@@ -4,6 +4,8 @@
 package org.strategoxt.imp.runtime.services;
 
 import static org.eclipse.core.runtime.Platform.OS_MACOSX;
+import static org.spoofax.interpreter.core.Tools.termAt;
+import static org.strategoxt.imp.runtime.dynamicloading.TermReader.cons;
 import static org.strategoxt.imp.runtime.dynamicloading.TermReader.termContents;
 
 import org.eclipse.core.runtime.Platform;
@@ -21,9 +23,9 @@
 import org.eclipse.swt.graphics.TextStyle;
 import org.eclipse.swt.widgets.Display;
 import org.spoofax.interpreter.terms.IStrategoList;
+import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.Environment;
-import org.strategoxt.imp.runtime.dynamicloading.TermReader;
 
 /**
  * A content proposal that selects the lexical at the cursor location.
@@ -111,7 +113,7 @@
 		for (IStrategoList cons = proposalParts.tail(); !cons.isEmpty(); cons = cons.tail()) {
 			IStrategoTerm partTerm = cons.head();
 			String part = proposalPartToString(document, partTerm);
-			if ("Placeholder".equals(TermReader.cons(partTerm)) 
+			if ("Placeholder".equals(cons(partTerm)) 
 					|| proposer.getCompletionLexical().matcher(part).matches())
 				return new Point(offset + i, part.length());
 			i += part.length();
@@ -130,7 +132,14 @@
 	private String proposalPartToString(IDocument document, IStrategoTerm part) {
 		try {
 			String lineStart = AutoEditStrategy.getLineBeforeOffset(document, getRange().getOffset());
-			return AutoEditStrategy.formatInsertedText(termContents(part), lineStart);
+			if ("Placeholder".equals(cons(part))) {
+				IStrategoString placeholder = termAt(part, 0);
+				String contents = placeholder.stringValue();
+				contents = contents.substring(1, contents.length() - 1); // strip < >
+				return AutoEditStrategy.formatInsertedText(contents, lineStart);
+			} else {
+				return AutoEditStrategy.formatInsertedText(termContents(part), lineStart);
+			}
 		} catch (BadLocationException e) {
 			Environment.logException("Could not format completion fragment", e);
 			return termContents(part);



From L.C.L.Kats at tudelft.nl  Wed Mar  3 18:28:27 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 17:28:27 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20673 - LennartKats -
	strc-java/trunk/test/sglr
Message-ID: <201003031728.o23HSRAN016423@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 17:28:27 +0000 (Wed, 03 Mar 2010)
New Revision: 20673

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20673&view=rev

Modified:
   strc-java/trunk/test/sglr/entities.str

Log:


Changes:

Modified: strc-java/trunk/test/sglr/entities.str
===================================================================
--- strc-java/trunk/test/sglr/entities.str	2010-03-03 17:25:06 UTC (rev 20672)
+++ strc-java/trunk/test/sglr/entities.str	2010-03-03 17:28:27 UTC (rev 20673)
@@ -8,7 +8,7 @@
 rules
 
   main =
-    <parse-file> "/tmp/foo.ent"
+    <parse-file> "Entities.ent"
   
   parse-file =
     parse-file(|<import-term(Entities.tbl)>)



From L.C.L.Kats at tudelft.nl  Wed Mar  3 18:34:55 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 03 Mar 2010 17:34:55 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20674 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.stratego/editor
	org.strategoxt.imp.generator/src/syntax
Message-ID: <201003031734.o23HYtS0016466@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-03 17:34:55 +0000 (Wed, 03 Mar 2010)
New Revision: 20674

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20674&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv	2010-03-03 17:28:27 UTC (rev 20673)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Completions.esv	2010-03-03 17:34:55 UTC (rev 20674)
@@ -1,6 +1,6 @@
-module Stratego-Sugar-References
+module Stratego-Sugar-Completions
 
-imports Stratego-Sugar-References.generated
+imports Stratego-Sugar-Completions.generated
 
 references
                                                                    

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-03 17:28:27 UTC (rev 20673)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-03 17:34:55 UTC (rev 20674)
@@ -42,7 +42,7 @@
    AttributeRef         -- _1,
    FoldRuleAll          -- H [ KW["all"] _1 _2 ],
    FoldRule             -- H [ _1 _2 ],
-   Disable              -- KW["(blank)"],
+   Blank                -- KW["(blank)"],
    Disable              -- KW["(disabled)"],
    Folded               -- KW["(folded)"],
    None                 -- ,



From L.C.L.Kats at tudelft.nl  Thu Mar  4 17:09:47 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 04 Mar 2010 16:09:47 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20675 - LennartKats -
	in spoofax-imp/trunk: org.eclipse.imp
	org.strategoxt.imp.editors.editorservice/editor
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.generator/src/sdf2imp/util
	org.strategoxt.imp.generator/src/syntax
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego
	org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
	org.strategoxt.imp.updatesite
Message-ID: <201003041609.o24G9lbq002468@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-04 16:09:47 +0000 (Thu, 04 Mar 2010)
New Revision: 20675

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20675&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicOnSaveService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/OnSaveServiceFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
Modified:
   spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch
   spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/pp.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/SemanticServices.sdf
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
Spoofax/38: Add an "on save" listener for lightweight code generation
Spoofax/39: Add a "refresh file in Eclipse" strategy to editor-common


Changes:

Modified: spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch
===================================================================
--- spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	2010-03-04 16:09:47 UTC (rev 20675)
@@ -192,7 +192,15 @@
 ===================================================================
 --- org.eclipse.imp.runtime/src/org/eclipse/imp/editor/UniversalEditor.java	(revision 22255)
 +++ org.eclipse.imp.runtime/src/org/eclipse/imp/editor/UniversalEditor.java	(working copy)
-@@ -42,6 +42,7 @@
+@@ -15,6 +15,7 @@
+ import java.lang.reflect.Method;
+ import java.util.ArrayList;
+ import java.util.HashMap;
++import java.util.HashSet;
+ import java.util.Iterator;
+ import java.util.List;
+ import java.util.Map;
+@@ -42,6 +43,7 @@
  import org.eclipse.imp.editor.internal.AnnotationCreator;
  import org.eclipse.imp.editor.internal.EditorErrorTickUpdater;
  import org.eclipse.imp.editor.internal.FoldingController;
@@ -200,7 +208,17 @@
  import org.eclipse.imp.editor.internal.ProblemMarkerManager;
  import org.eclipse.imp.editor.internal.ToggleBreakpointsAdapter;
  import org.eclipse.imp.help.IMPHelp;
-@@ -257,6 +258,24 @@
+@@ -240,6 +242,9 @@
+     private static final String BUNDLE_FOR_CONSTRUCTED_KEYS= MESSAGE_BUNDLE;//$NON-NLS-1$
+ 
+     private static final String IMP_EDITOR_CONTEXT= RuntimePlugin.IMP_RUNTIME + ".imp_editor_context";
++    
++    // LK
++    private final Set<IDocumentListener> onSaveListeners = new HashSet<IDocumentListener>();
+ 
+     static ResourceBundle fgBundleForConstructedKeys= ResourceBundle.getBundle(BUNDLE_FOR_CONSTRUCTED_KEYS);
+ 
+@@ -257,6 +262,32 @@
          setInsertMode(SMART_INSERT);
          fProblemMarkerManager= new ProblemMarkerManager();
      }
@@ -217,6 +235,14 @@
 +    	return super.getPreferenceStore();
 +    }
 +    
++    public void addOnSaveListener(IDocumentListener listener) { // LK
++    	onSaveListeners.add(listener);
++    }
++    
++    public void removeOnSaveListener(IDocumentListener listener) { // LK
++    	onSaveListeners.remove(listener);
++    }
++    
 +    public void updateColoring(Region region) { // LK
 +        PresentationController presentation = fServiceControllerManager.getPresentationController();
 +		presentation.damage(region);
@@ -225,7 +251,7 @@
  
      public Object getAdapter(Class required) {
          if (IContentOutlinePage.class.equals(required)) {
-@@ -697,7 +716,8 @@
+@@ -697,7 +728,8 @@
          IFile file= EditorInputUtils.getFile(editorInput);
          IPath filePath= EditorInputUtils.getPath(editorInput);
          try {
@@ -235,7 +261,7 @@
  
              fLanguageServiceManager.getParseController().initialize(filePath, srcProject, fAnnotationCreator);
          } catch (ModelException e) {
-@@ -1491,6 +1511,7 @@
+@@ -1491,6 +1523,7 @@
              ContentAssistant ca= new ContentAssistant();
              ca.setContentAssistProcessor(fServiceControllerManager.getCompletionProcessor(), IDocument.DEFAULT_CONTENT_TYPE);
              ca.setInformationControlCreator(getInformationControlCreator(sourceViewer));
@@ -243,7 +269,7 @@
              return ca;
          }
  
-@@ -1771,7 +1792,8 @@
+@@ -1771,7 +1804,8 @@
                  if (fServiceControllerManager.getPresentationController() != null) {
  //                  System.out.println("Scheduling repair for damage to region " + damage.getOffset() + ":" + damage.getLength() + " in doc of length " + fDocument.getLength());
                      fServiceControllerManager.getPresentationController().damage(damage);
@@ -253,7 +279,7 @@
  //                      System.out.println("** Forcing repair for hyperlink damage to region " + damage.getOffset() + ":" + damage.getLength() + " in doc of length " + fDocument.getLength());
                          fServiceControllerManager.getPresentationController().update(fLanguageServiceManager.getParseController(), fProgressMonitor);
                      }
-@@ -1845,6 +1867,7 @@
+@@ -1845,6 +1879,7 @@
      }
  
      public IParseController getParseController() {
@@ -261,6 +287,19 @@
          return fLanguageServiceManager.getParseController();
      }
      
+@@ -1861,7 +1896,12 @@
+ 		// SMS 25 Apr 2007:  Removing parser annotations here
+ 		// may not hurt but also doesn't seem to be necessary
+ 		//removeParserAnnotations();
++		DocumentEvent event = new DocumentEvent(getServiceControllerManager().getSourceViewer().getDocument(), 0, 0, null);
++		for (IDocumentListener listener : onSaveListeners)
++			listener.documentAboutToBeChanged(event);
+ 		super.doSave(progressMonitor);
++		for (IDocumentListener listener : onSaveListeners)
++			listener.documentChanged(event);
+ 	}
+ 
+     public void removeParserAnnotations() {
 Index: org.eclipse.imp.runtime/src/org/eclipse/imp/editor/SourceProposal.java
 ===================================================================
 --- org.eclipse.imp.runtime/src/org/eclipse/imp/editor/SourceProposal.java	(revision 22255)

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.editorservice/editor/EditorService-Completions.esv	2010-03-04 16:09:47 UTC (rev 20675)
@@ -48,3 +48,6 @@
   
   completion template:
     "hover" " _ : " <s> (blank)
+
+  completion template:
+    "on save" ": " <s> (blank)
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-04 16:09:47 UTC (rev 20675)
@@ -211,7 +211,7 @@
 
   parse-string =
     parse-string(
-      strsglr-perror, strsglr-report-parse-error
+      strsglr-report-parse-error
     | <import-term(include/{sdf-name}.tbl)>
     )
   
@@ -285,7 +285,12 @@
       <gt> (<file-exists; modification-time> file1, <file-exists; modification-time> file2) 
 
 strategies
+  
+  refresh-workspace-file:
+    f -> <prim("SSL_EXT_refreshresource", f)>
 
+strategies
+
   desugar-position(desugar|ast):
     position -> position'
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/pp.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/pp.str	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/pp.str	2010-03-04 16:09:47 UTC (rev 20675)
@@ -37,3 +37,10 @@
       <not(string-starts-with(|"\""))> string
     with
       string' := <conc-strings> ("\"", string, "\"")
+  
+  pp-fix-string-quotes:
+    Placeholder(string) -> Placeholder(string')
+    where
+      <not(string-starts-with(|"<"))> string
+    with
+      string' := <conc-strings> ("<", string, ">")

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-04 16:09:47 UTC (rev 20675)
@@ -4,14 +4,15 @@
    CompletionProposer   -- R [ H [ KW["completion"] KW["proposer"] ] KW[":"] _1 ],
    CompletionLexical    -- R [ H [ KW["completion"] KW["lexical"] ] KW[":"] _1 ],
    IdentifierLexical    -- R [ H [ KW["identifier"] KW["lexical"] ] KW[":"] _1 ],
-   Placeholder          -- H hs=0 [ KW["<"] _1 KW[">"] ],
+   Placeholder          -- H hs=0 [ _1 ],
    CompletionKeyword    -- R [ H [ KW["completion"] KW["keyword"] ] KW[":"] H [ _1 _2 ] ],
    CompletionTemplate   -- R [ H [ KW["completion"] KW["template"] ] KW[":"] H [ _1 _2 _3 ] ],
    CompletionTemplate.2:iter-star -- _1,
    CompletionTrigger    -- R [ H [ KW["completion"] KW["trigger"] ] KW[":"] H [ _1 _2 ] ],
    HoverRule            -- R [ H [ KW["hover"]     _1 ] KW[":"] _2 ],
    OccurrenceRule       -- R [ H [ KW["occurrence"] _1 ] H [ KW[":"] _2 ] ],
-   SemanticProvider     -- R [ H [ KW["provider" ] ] KW[":"] _1 ],
+   SemanticProvider     -- R [ H [ KW["provider"] ] KW[":"] _1 ],
+   SemanticProvider     -- R [ H [ KW["on"] KW["save"] ] KW[":"] _1 ],
    SemanticObserver     -- R [ H [ KW["observer"] ]  KW[":"] _1 ],
    Builder              -- R [ H [ KW["builder"] ]   KW[":"] _1 H [ KW["="] _2 _3 ] ],
    Builder.3:iter-star  -- _1,

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/SemanticServices.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/SemanticServices.sdf	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/SemanticServices.sdf	2010-03-04 16:09:47 UTC (rev 20675)
@@ -6,7 +6,7 @@
 exports
 
   sorts
-    SemanticRule SemanticNode StrategoId StrategoCall
+    SemanticRule SemanticNode StrategoId StrategoCall OnSaveAnno
 
   lexical syntax
 
@@ -24,5 +24,9 @@
     "provider"     PropertyValue -> SemanticRule {cons("SemanticProvider"), deprecated("Use 'provider :'")}
     "provider" ":" PropertyValue -> SemanticRule {cons("SemanticProvider")}
 
+    "on" "save" ":" StrategoCall OnSaveAnno -> SemanticRule {cons("OnSave")}
+
              StrategoId -> StrategoCall {cons("Strategy")}
-    "id" "." StrategoId -> StrategoCall {cons("Attribute")}
\ No newline at end of file
+    "id" "." StrategoId -> StrategoCall {cons("Attribute")}
+    
+                        -> OnSaveAnno {cons("None")}
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/stratego/IMPParseStrategoFileStrategy.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -19,7 +19,7 @@
 import org.strategoxt.imp.runtime.parser.JSGLRI;
 import org.strategoxt.imp.runtime.parser.ast.RootAstNode;
 import org.strategoxt.imp.runtime.services.MetaFile;
-import org.strategoxt.imp.runtime.stratego.IMPImplodeAsfixStrategy;
+import org.strategoxt.imp.runtime.stratego.RefreshResourcePrimitive;
 import org.strategoxt.lang.Context;
 import org.strategoxt.lang.StrategoException;
 import org.strategoxt.strc.parse_stratego_file_0_0;
@@ -43,7 +43,7 @@
 			try {
 				stream = context.getIOAgent().openInputStream(file);
 				RootAstNode ast = parser.parse(stream, file);
-				ast.setResource(IMPImplodeAsfixStrategy.getResource(new File(file)));
+				ast.setResource(RefreshResourcePrimitive.getResource(new File(file)));
 				return ast.getTerm();
 			} finally {
 				if (stream != null) stream.close();

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/wizards/NewEditorWizard.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -219,7 +219,7 @@
 			}
 		};
 		job.setSystem(true);
-		job.schedule(5000); 
+		job.schedule(5000);
 	}
  	
  	private static String toStrategoName(String languageName) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -88,6 +88,7 @@
 		serviceFactories.add(new ContentProposerFactory());
 		serviceFactories.add(new LabelProviderFactory());
 		serviceFactories.add(new AutoEditStrategyFactory());
+		serviceFactories.add(new OnSaveServiceFactory());
 	}
 	
 	/**

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicOnSaveService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicOnSaveService.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicOnSaveService.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -0,0 +1,27 @@
+/**
+ * 
+ */
+package org.strategoxt.imp.runtime.dynamicloading;
+
+import org.eclipse.jface.text.DocumentEvent;
+import org.eclipse.jface.text.IDocumentListener;
+import org.strategoxt.imp.runtime.services.OnSaveService;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class DynamicOnSaveService extends AbstractService<OnSaveService> implements IDocumentListener {
+
+	public DynamicOnSaveService() {
+		super(OnSaveService.class);
+	}
+
+	public void documentAboutToBeChanged(DocumentEvent event) {
+		getWrapped().documentAboutToBeChanged(event);
+	}
+
+	public void documentChanged(DocumentEvent event) {
+		getWrapped().documentChanged(event);
+	}
+
+}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicParseController.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -73,6 +73,7 @@
 			Descriptor descriptor = Environment.getDescriptor(getLanguage());
 			ContentProposerFactory.eagerInit(descriptor, result, lastEditor);
 			AutoEditStrategyFactory.eagerInit(descriptor, result, lastEditor);
+			OnSaveServiceFactory.eagerInit(descriptor, result, lastEditor);
 		}
 		return result;
 	}
@@ -142,6 +143,7 @@
 			Descriptor descriptor = Environment.getDescriptor(getLanguage());
 			ContentProposerFactory.eagerInit(descriptor, getWrapped(), lastEditor);
 			AutoEditStrategyFactory.eagerInit(descriptor, getWrapped(), lastEditor);
+			OnSaveServiceFactory.eagerInit(descriptor, getWrapped(), lastEditor);
 		}
 	}
 

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/OnSaveServiceFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/OnSaveServiceFactory.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/OnSaveServiceFactory.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -0,0 +1,64 @@
+/**
+ * 
+ */
+package org.strategoxt.imp.runtime.dynamicloading;
+
+import static java.util.Collections.synchronizedMap;
+import static org.spoofax.interpreter.core.Tools.termAt;
+import static org.strategoxt.imp.runtime.dynamicloading.TermReader.findTerm;
+
+import java.util.Map;
+import java.util.WeakHashMap;
+
+import org.eclipse.imp.editor.UniversalEditor;
+import org.eclipse.imp.parser.IParseController;
+import org.spoofax.interpreter.terms.IStrategoAppl;
+import org.strategoxt.imp.runtime.EditorState;
+import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.imp.runtime.parser.SGLRParseController;
+import org.strategoxt.imp.runtime.services.OnSaveService;
+import org.strategoxt.imp.runtime.services.StrategoObserver;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class OnSaveServiceFactory extends AbstractServiceFactory<OnSaveService> {
+	
+	private static final Map<UniversalEditor, OnSaveService> registeredServices =
+		synchronizedMap(new WeakHashMap<UniversalEditor, OnSaveService>());
+
+	public OnSaveServiceFactory() {
+		super(OnSaveService.class, false);
+	}
+
+	@Override
+	public OnSaveService create(Descriptor descriptor, SGLRParseController controller)
+			throws BadDescriptorException {
+		
+		IStrategoAppl onsave = findTerm(descriptor.getDocument(), "OnSave");
+		String function = null;
+		if (onsave != null)
+			function = TermReader.termContents(termAt(onsave, 0));
+		StrategoObserver feedback = descriptor.createService(StrategoObserver.class, controller);
+		return new OnSaveService(feedback, function);
+	}
+
+	public static void eagerInit(Descriptor descriptor, IParseController controller,
+			EditorState editor) {
+		
+		try {
+			if (editor != null && controller instanceof SGLRParseController) {
+				OnSaveService oldService = registeredServices.get(editor.getEditor());
+				editor.getEditor().removeOnSaveListener(oldService);
+				OnSaveService newService = descriptor.createService(OnSaveService.class, (SGLRParseController) controller);
+				newService.initialize(editor);
+				registeredServices.put(editor.getEditor(), newService);
+				editor.getEditor().addOnSaveListener(newService);
+			}
+		} catch (BadDescriptorException e) {
+			Environment.logException("Could not eagerly intiialize the on save service", e);
+		} catch (RuntimeException e) {
+			Environment.logException("Could not eagerly intiialize the on save service", e);
+		}
+	}
+}

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -0,0 +1,81 @@
+/**
+ * 
+ */
+package org.strategoxt.imp.runtime.services;
+
+import static org.spoofax.interpreter.core.Tools.asJavaString;
+import static org.spoofax.interpreter.core.Tools.isTermString;
+import static org.spoofax.interpreter.core.Tools.isTermTuple;
+import static org.spoofax.interpreter.core.Tools.termAt;
+
+import java.io.File;
+
+import org.eclipse.core.resources.IFile;
+import org.eclipse.core.resources.IResource;
+import org.eclipse.core.runtime.CoreException;
+import org.eclipse.imp.language.ILanguageService;
+import org.eclipse.jface.text.DocumentEvent;
+import org.eclipse.jface.text.IDocumentListener;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.imp.runtime.EditorState;
+import org.strategoxt.imp.runtime.Environment;
+import org.strategoxt.imp.runtime.parser.ast.AstNode;
+import org.strategoxt.imp.runtime.stratego.RefreshResourcePrimitive;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class OnSaveService implements IDocumentListener, ILanguageService {
+
+	private final StrategoObserver runtime;
+	
+	private final String function;
+	
+	private EditorState editor;
+	
+	public OnSaveService(StrategoObserver runtime, String function) {
+		this.runtime = runtime;
+		this.function = function;
+	}
+	
+	public void initialize(EditorState editor) {
+		this.editor = editor;
+	}
+
+	public void documentAboutToBeChanged(DocumentEvent event) {
+		// Unused
+	}
+
+	public void documentChanged(DocumentEvent event) {
+		if (function == null) return;
+		
+		synchronized (Environment.getSyncRoot()) {
+			AstNode ast = editor.getCurrentAst();
+			// IStrategoTerm result = runtime.invokeSilent(function, runtime.makeInputTerm(ast, false), ast.getResource());
+			IStrategoTerm result = runtime.invokeSilent(function, ast);
+			if (result == null) {
+				runtime.reportRewritingFailed();
+				String log = runtime.getLog();
+				Environment.logException(log.length() == 0 ? "Analysis failed" : "Analysis failed:\n" + log);
+			} else if (isTermString(result)) {
+				// Function's returning a filename
+				String file = asJavaString(termAt(result, 0));
+				if (new File(file).exists())
+					RefreshResourcePrimitive.call(runtime.getRuntime().getContext(), file);	
+			} else if (isTermTuple(result) && result.getSubtermCount() == 2 && isTermString(termAt(result, 0)) && isTermString(termAt(result, 1))) {
+				// Function's returning a tuple like a builder
+				// let's be friendly and try to refresh the file
+				String file = asJavaString(termAt(result, 0));
+				String contents = asJavaString(termAt(result, 1));
+				IResource resource = RefreshResourcePrimitive.getResource(runtime.getRuntime().getContext(), file);
+				// TODO: write contents to file
+				try {
+					StrategoBuilder.setFileContentsDirect((IFile) resource, contents);
+				} catch (CoreException e) {
+					Environment.logException("Problem when handling on save event", e);
+				}
+			}
+		}
+	}
+
+}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -240,33 +240,39 @@
 		assert !Thread.holdsLock(observer.getSyncRoot()) || Thread.holdsLock(Environment.getSyncRoot())
 			: "Acquiring a resource lock can cause a deadlock";
 
+		/* TODO: update editor contents instead of file?
+		if (file.exists()):
+		if (editor.getEditor().getTitleImage().isDisposed()) {
+			InputStream resultStream = new ByteArrayInputStream(contents.getBytes());
+			file.setContents(resultStream, true, true, null);
+			...save...
+		} else {
+			Job job = new UIJob("Update derived editor") {
+				@Override
+				public IStatus runInUIThread(IProgressMonitor monitor) {
+					try {
+						editor.getDocument().set(contents);
+						...save...
+		                ...ensure listener knows updated time stamp...
+					} catch (RuntimeException e) {
+						Environment.logException("Could not update derived editor", e);
+					}
+					return Status.OK_STATUS;
+				}
+			};
+			job.setSystem(true);
+			job.schedule();
+		}
+		*/
+		setFileContentsDirect(file, contents);
+	}
+
+	public static void setFileContentsDirect(IFile file, final String contents) throws CoreException {
 		InputStream resultStream = new ByteArrayInputStream(contents.getBytes());
 		if (file.exists()) {
 			file.setContents(resultStream, true, true, null);
 			
-			/* TODO: update editor contents instead of file?
-			if (editor.getEditor().getTitleImage().isDisposed()) {
-				InputStream resultStream = new ByteArrayInputStream(contents.getBytes());
-				file.setContents(resultStream, true, true, null);
-				...save...
-			} else {
-				Job job = new UIJob("Update derived editor") {
-					@Override
-					public IStatus runInUIThread(IProgressMonitor monitor) {
-						try {
-							editor.getDocument().set(contents);
-							...save...
-			                ...ensure listener knows updated time stamp...
-						} catch (RuntimeException e) {
-							Environment.logException("Could not update derived editor", e);
-						}
-						return Status.OK_STATUS;
-					}
-				};
-				job.setSystem(true);
-				job.schedule();
-			}
-			*/
+
 		} else {
 			file.create(resultStream, true, null);
 			// UNDONE: file.setDerived(!persistent); // marks it as "derived" for life, even after editing...

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -280,7 +280,7 @@
 		
 		try {
 			synchronized (getSyncRoot()) {
-				feedback = invokeSilent(feedbackFunction, ast.getResource(), makeInputTerm(ast, false));
+				feedback = invokeSilent(feedbackFunction, makeInputTerm(ast, false), ast.getResource());
 	
 				if (feedback == null) {
 					reportRewritingFailed();
@@ -499,7 +499,7 @@
 	 * @see #getAstNode(IStrategoTerm)  To retrieve the AST node associated with the resulting term.
 	 */
 	public IStrategoTerm invokeSilent(String function, IStrategoAstNode node) {
-		return invokeSilent(function, node.getResource(), makeInputTerm(node, true));
+		return invokeSilent(function, makeInputTerm(node, true), node.getResource());
 	}
 	
 	/**
@@ -507,7 +507,7 @@
 	 * given a particular working directory.
 	 * Logs and swallows all exceptions.
 	 */
-	public IStrategoTerm invokeSilent(String function, IResource resource, IStrategoTerm input) {
+	public IStrategoTerm invokeSilent(String function, IStrategoTerm input, IResource resource) {
 		assert Thread.holdsLock(getSyncRoot());
 		IStrategoTerm result = null;
 		

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -1,11 +1,7 @@
 package org.strategoxt.imp.runtime.stratego;
 
 import java.io.File;
-import java.net.URI;
 
-import org.eclipse.core.resources.IResource;
-import org.eclipse.core.resources.IWorkspace;
-import org.eclipse.core.resources.ResourcesPlugin;
 import org.spoofax.interpreter.library.IOperatorRegistry;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.Environment;
@@ -52,24 +48,11 @@
 		}
 		
 		AstNode result = imploder.implode(asfixATerm, tokenizer);
-		result = RootAstNode.makeRoot(result, null, getResource(inputFile));
+		result = RootAstNode.makeRoot(result, null, RefreshResourcePrimitive.getResource(inputFile));
 		return result.getTerm();
 		
 		// TODO: Make a RootAstNode object from this tree and for IMPSGLRIPrimitive
 		//       which either refers to a (possibly fresh) ParseController or
 		//       some other cookie that traces back the tree to the file
 	}
-
-	public static IResource getResource(File file) {
-		URI uri = file.toURI();
-		IWorkspace workspace = ResourcesPlugin.getWorkspace();
-		IResource[] resources = workspace.getRoot().findFilesForLocationURI(uri);
-		if (resources.length == 0) {
-			Environment.logWarning("Parsed file not in workspace: " + file);
-			return null;
-		}
-
-		IResource resource = resources[0];
-		return resource;
-	}
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -12,6 +12,7 @@
 	public IMPLibrary() {
 		add(new SubtermPrimitive());
 		add(new ProjectPathPrimitive());
+		add(new RefreshResourcePrimitive());
 	}
 
 	public String getOperatorRegistryName() {

Added: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-04 16:09:47 UTC (rev 20675)
@@ -0,0 +1,98 @@
+/**
+ * 
+ */
+package org.strategoxt.imp.runtime.stratego;
+
+import static org.eclipse.core.resources.IResource.DEPTH_INFINITE;
+import static org.spoofax.interpreter.core.Tools.asJavaString;
+import static org.spoofax.interpreter.core.Tools.isTermString;
+
+import java.io.File;
+import java.net.URI;
+
+import org.eclipse.core.resources.IResource;
+import org.eclipse.core.resources.IWorkspace;
+import org.eclipse.core.resources.ResourcesPlugin;
+import org.eclipse.core.runtime.CoreException;
+import org.eclipse.core.runtime.IProgressMonitor;
+import org.eclipse.core.runtime.IStatus;
+import org.eclipse.core.runtime.NullProgressMonitor;
+import org.eclipse.core.runtime.Status;
+import org.eclipse.core.runtime.jobs.Job;
+import org.spoofax.interpreter.core.IContext;
+import org.spoofax.interpreter.core.InterpreterException;
+import org.spoofax.interpreter.library.AbstractPrimitive;
+import org.spoofax.interpreter.library.IOAgent;
+import org.spoofax.interpreter.library.ssl.SSLLibrary;
+import org.spoofax.interpreter.stratego.Strategy;
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.imp.runtime.Environment;
+
+/**
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class RefreshResourcePrimitive extends AbstractPrimitive {
+
+	public RefreshResourcePrimitive() {
+		super("SSL_EXT_refreshresource", 0, 1);
+	}
+
+	@Override
+	public boolean call(IContext env, Strategy[] svars, IStrategoTerm[] tvars)
+			throws InterpreterException {
+		
+		if (!isTermString(tvars[0]))
+			return false;
+		
+		return call(env, asJavaString(tvars[0]));
+	}
+
+	public static boolean call(IContext env, String file) {
+		final IResource resource = getResource(env, file);
+		if (resource == null)
+			return false;
+		
+		// Cannot acquire a workspace lock here:
+		// the Ant acquires 1) a workspace lock and 2) the environment lock
+		// we cannot go against that order here or would risk a deadlock
+		
+		Job job = new Job("Refreshing resource") {
+			@Override
+			protected IStatus run(IProgressMonitor monitor) {
+				try {
+					resource.refreshLocal(DEPTH_INFINITE, new NullProgressMonitor());
+				} catch (CoreException e) {
+					// Ignore
+				} catch (RuntimeException e) {
+					// Ignore
+				}
+				return Status.OK_STATUS;
+			}
+		};
+		job.setSystem(true);
+		job.schedule(0);
+		return true;
+	}
+
+	public static IResource getResource(IContext env, String file) {
+		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
+		File file2 = new File(file);
+		if (!file2.exists() && agent instanceof EditorIOAgent)
+			file2 = new File(((EditorIOAgent) agent).getProjectPath() + "/" + file);
+		return getResource(file2);
+	}
+
+	public static IResource getResource(File file) {
+		URI uri = file.toURI();
+		IWorkspace workspace = ResourcesPlugin.getWorkspace();
+		IResource[] resources = workspace.getRoot().findFilesForLocationURI(uri);
+		if (resources.length == 0) {
+			Environment.logWarning("File not in workspace: " + file);
+			return null;
+		}
+	
+		IResource resource = resources[0];
+		return resource;
+	}
+
+}

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-03 17:34:55 UTC (rev 20674)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-04 16:09:47 UTC (rev 20675)
@@ -3,6 +3,9 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable/">
       Spoofax/IMP update site
    </description>
+   <feature url="features/org.strategoxt.imp_0.3.9.4.jar" id="org.strategoxt.imp" version="0.3.9.4">
+      <category name="Spoofax/IMP"/>
+   </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">
       <description>
          Spoofax/IMP IDE metatooling environment



From L.C.L.Kats at tudelft.nl  Fri Mar  5 09:34:59 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 05 Mar 2010 08:34:59 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20676 - LennartKats -
	in spoofax-imp/trunk/org.strategoxt.imp.generator/src:
	sdf2imp/project sdf2imp/services syntax
Message-ID: <201003050834.o258YxAk014873@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-05 08:34:58 +0000 (Fri, 05 Mar 2010)
New Revision: 20676

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20676&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp

Log:
Released 0.3.9.4: added 'on save' to entities example and documentation

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-04 16:09:47 UTC (rev 20675)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-05 08:34:58 UTC (rev 20676)
@@ -229,7 +229,7 @@
    *                      Performs semantic analysis on a tree
    */
   open-import(resolve-path, parse-file, record-declarations):
-    import -> import
+    import -> file'
     where
       if not(!import => COMPLETION(_)) then
         path       := <resolve-path> import;
@@ -249,7 +249,7 @@
           end;
           ${$| CurrentFile:
             rules(CurrentFile := path);
-            <record-declarations> file
+            file' := <record-declarations> file
           |$}$
         end
       end

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	2010-03-04 16:09:47 UTC (rev 20675)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	2010-03-05 08:34:58 UTC (rev 20676)
@@ -26,9 +26,13 @@
         builders
           ~~
           provider: ~provider
+          ~~
           observer: editor-analyze
+          ~~
           builder: "Generate Java code"   = generate-java  (openeditor) (realtime)
           builder: "Show abstract syntax" = generate-aterm (openeditor) (realtime) (meta)
+          ~~
+          on save: generate-java
       ]|
     );
     
@@ -69,5 +73,10 @@
           ~//   (persistent)  Indicates that the resulting file should be saved to disk.
           ~//   (realtime)    Indicates that the resulting editor should be updated in real-time
           ~//                 as the source file is edited.
+          ~//
+          ~// The 'on save' handler can be used  to generate code as files
+          ~// are saved:
+          ~//   
+          ~//   on save : generate-java
       ]|
     )

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str	2010-03-04 16:09:47 UTC (rev 20675)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-completions-descriptor.str	2010-03-05 08:34:58 UTC (rev 20676)
@@ -36,7 +36,7 @@
           ~~
           ~// Semantic (identifier) completion:
           completion proposer: editor-complete
-          completion trigger: ":"
+          completion trigger: ": "
       ]|
     );
     create-derived-completions-descriptor

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-04 16:09:47 UTC (rev 20675)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-05 08:34:58 UTC (rev 20676)
@@ -12,7 +12,7 @@
    HoverRule            -- R [ H [ KW["hover"]     _1 ] KW[":"] _2 ],
    OccurrenceRule       -- R [ H [ KW["occurrence"] _1 ] H [ KW[":"] _2 ] ],
    SemanticProvider     -- R [ H [ KW["provider"] ] KW[":"] _1 ],
-   SemanticProvider     -- R [ H [ KW["on"] KW["save"] ] KW[":"] _1 ],
+   OnSave               -- R [ H [ KW["on"] KW["save"] ] KW[":"] _1 _2 ],
    SemanticObserver     -- R [ H [ KW["observer"] ]  KW[":"] _1 ],
    Builder              -- R [ H [ KW["builder"] ]   KW[":"] _1 H [ KW["="] _2 _3 ] ],
    Builder.3:iter-star  -- _1,



From L.C.L.Kats at tudelft.nl  Fri Mar  5 09:35:03 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 05 Mar 2010 08:35:03 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20677 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003050835.o258Z34E014883@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-05 08:35:03 +0000 (Fri, 05 Mar 2010)
New Revision: 20677

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20677&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java

Log:
Fixed a regression causing content proposals only to show names not arguments.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-05 08:34:58 UTC (rev 20676)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-05 08:35:03 UTC (rev 20677)
@@ -242,11 +242,13 @@
 		WrappedAstNodeFactory factory = Environment.getTermFactory();
 		IStrategoString emptyString = factory.makeString("");
 		Region offsetRegion = new Region(offset, 0);
+		String prefix = currentCompletionPrefix;
+		
+		Set<ICompletionProposal> results = getKeywordAndTemplateProposals(document, prefix, offsetRegion, offset);
 
-		Set<ICompletionProposal> results = getKeywordAndTemplateProposals(document, currentCompletionPrefix, offsetRegion, offset);
-
 		for (IStrategoList cons = (IStrategoList) proposals; !cons.isEmpty(); cons = cons.tail()) {
 			IStrategoTerm proposal = cons.head();
+			boolean confirmed = false;
 			String newText;
 			IStrategoList newTextParts;
 			IStrategoString description;
@@ -257,6 +259,11 @@
 				description = emptyString;
 			} else if (proposal.getTermType() == LIST) {
 				newTextParts = (IStrategoList) proposal;
+				String head = newTextParts.size() == 0 ? "" : asJavaString(newTextParts.head());
+				if (head.length() >= prefix.length()) {
+					if (head.startsWith(prefix)) confirmed = true;
+					else continue;
+				}
 				newText = proposalPartsToDisplayString(newTextParts);
 				description = emptyString;
 			} else {
@@ -267,6 +274,11 @@
 					return createErrorProposal(error, offset);
 				if (newTextTerm.getTermType() == LIST) {
 					newTextParts = (IStrategoList) newTextTerm;
+					String head = newTextParts.size() == 0 ? "" : asJavaString(newTextParts.head());
+					if (head.length() >= prefix.length()) {
+						if (head.startsWith(prefix)) confirmed = true;
+						else continue;
+					}
 					newText = proposalPartsToDisplayString(newTextParts);
 				} else {
 					newTextParts = factory.makeList(newTextTerm);
@@ -274,9 +286,9 @@
 				}
 				description = termAt(proposal, 1);
 			}
-			if (newTextParts.isEmpty() || !newText.startsWith(currentCompletionPrefix))
+			if (!confirmed && (newTextParts.isEmpty() || !newText.startsWith(prefix)))
 				continue;
-			results.add(new ContentProposal(this, newText, newText, currentCompletionPrefix, offsetRegion, newTextParts, description.stringValue()));
+			results.add(new ContentProposal(this, newText, newText, prefix, offsetRegion, newTextParts, description.stringValue()));
 		}
 		
 		return toSortedArray(results);
@@ -289,7 +301,7 @@
 			if (part.getTermType() != STRING) return null;
 			proposalBuilder.append(asJavaString(part));
 		}
-		if (proposalBuilder.indexOf("\n") != 0 || proposalBuilder.indexOf("\t") != 0) {
+		if (proposalBuilder.indexOf("\\n") != -1 || proposalBuilder.indexOf("\\t") != -1) {
 			return asJavaString(proposalParts.head());
 		} else {
 			return proposalBuilder.toString();



From L.C.L.Kats at tudelft.nl  Fri Mar  5 10:03:15 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 05 Mar 2010 09:03:15 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20678 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003050903.o2593Fed015976@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-05 09:03:15 +0000 (Fri, 05 Mar 2010)
New Revision: 20678

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20678&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-05 08:35:03 UTC (rev 20677)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-05 09:03:15 UTC (rev 20678)
@@ -10,7 +10,7 @@
    </description>
 
    <copyright url="http://www.lclnet.nl/software/spoofax-imp/">
-      Copyright (c) Lennart C. L. Kats 2009
+      Copyright (c) Lennart C. L. Kats 2010
    </copyright>
 
    <license url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-05 08:35:03 UTC (rev 20677)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-05 09:03:15 UTC (rev 20678)
@@ -7,6 +7,7 @@
 import static org.spoofax.interpreter.core.Tools.isTermString;
 import static org.spoofax.interpreter.core.Tools.isTermTuple;
 import static org.spoofax.interpreter.core.Tools.termAt;
+import static org.strategoxt.imp.runtime.dynamicloading.TermReader.cons;
 
 import java.io.File;
 
@@ -74,6 +75,9 @@
 				} catch (CoreException e) {
 					Environment.logException("Problem when handling on save event", e);
 				}
+			} else if (!"None".equals(cons(result))) {
+				if (editor.getDescriptor().isDynamicallyLoaded())
+					Environment.logException("Unexpected result from 'on save' strategy: should be None() or (\"filename\", \"contents\"): " + result);
 			}
 		}
 	}



From L.C.L.Kats at tudelft.nl  Fri Mar  5 10:03:43 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 05 Mar 2010 09:03:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20679 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003050903.o2593hCa015988@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-05 09:03:43 +0000 (Fri, 05 Mar 2010)
New Revision: 20679

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20679&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-05 09:03:15 UTC (rev 20678)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-05 09:03:43 UTC (rev 20679)
@@ -77,7 +77,7 @@
 				}
 			} else if (!"None".equals(cons(result))) {
 				if (editor.getDescriptor().isDynamicallyLoaded())
-					Environment.logException("Unexpected result from 'on save' strategy: should be None() or (\"filename\", \"contents\"): " + result);
+					Environment.logWarning("Unexpected result from 'on save' strategy: should be None() or (\"filename\", \"contents\"): " + result);
 			}
 		}
 	}



From L.C.L.Kats at tudelft.nl  Fri Mar  5 10:43:34 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 05 Mar 2010 09:43:34 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20680 - LennartKats - in
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime:
	services stratego
Message-ID: <201003050943.o259hYvr016597@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-05 09:43:34 +0000 (Fri, 05 Mar 2010)
New Revision: 20680

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20680&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-05 09:03:43 UTC (rev 20679)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/OnSaveService.java	2010-03-05 09:43:34 UTC (rev 20680)
@@ -69,7 +69,6 @@
 				String file = asJavaString(termAt(result, 0));
 				String contents = asJavaString(termAt(result, 1));
 				IResource resource = RefreshResourcePrimitive.getResource(runtime.getRuntime().getContext(), file);
-				// TODO: write contents to file
 				try {
 					StrategoBuilder.setFileContentsDirect((IFile) resource, contents);
 				} catch (CoreException e) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-05 09:03:43 UTC (rev 20679)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-05 09:43:34 UTC (rev 20680)
@@ -77,8 +77,8 @@
 	public static IResource getResource(IContext env, String file) {
 		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
 		File file2 = new File(file);
-		if (!file2.exists() && agent instanceof EditorIOAgent)
-			file2 = new File(((EditorIOAgent) agent).getProjectPath() + "/" + file);
+		if (!file2.exists())
+			file2 = new File(agent.getWorkingDir() + "/" + file);
 		return getResource(file2);
 	}
 



From L.C.L.Kats at tudelft.nl  Fri Mar  5 15:50:58 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 05 Mar 2010 14:50:58 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20681 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <201003051450.o25Eow0k021527@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-05 14:50:58 +0000 (Fri, 05 Mar 2010)
New Revision: 20681

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20681&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-05 09:43:34 UTC (rev 20680)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-05 14:50:58 UTC (rev 20681)
@@ -14,7 +14,7 @@
 
   parse-string =
     parse-string(
-      strsglr-perror, strsglr-report-parse-error
+      strsglr-report-parse-error
     | <import-term(include/Stratego-Sugar.tbl)>
     )
   
@@ -32,7 +32,7 @@
    *                      Performs semantic analysis on a tree
    */
   open-import(resolve-path, parse-file, record-declarations):
-    import -> import
+    import -> file'
     where
       if not(!import => COMPLETION(_)) then
         path       := <resolve-path> import;
@@ -52,7 +52,7 @@
           end;
           {| CurrentFile:
             rules(CurrentFile := path);
-            <record-declarations> file
+            file' := <record-declarations> file
           |}
         end
       end
@@ -88,7 +88,12 @@
       <gt> (<file-exists; modification-time> file1, <file-exists; modification-time> file2) 
 
 strategies
+  
+  refresh-workspace-file:
+    f -> <prim("SSL_EXT_refreshresource", f)>
 
+strategies
+
   desugar-position(desugar|ast):
     position -> position'
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-05 09:43:34 UTC (rev 20680)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-05 14:50:58 UTC (rev 20681)
@@ -53,7 +53,7 @@
 			return false;
 		
 		// Cannot acquire a workspace lock here:
-		// the Ant acquires 1) a workspace lock and 2) the environment lock
+		// the Ant thread acquires 1) a workspace lock and 2) the environment lock
 		// we cannot go against that order here or would risk a deadlock
 		
 		Job job = new Job("Refreshing resource") {
@@ -91,8 +91,7 @@
 			return null;
 		}
 	
-		IResource resource = resources[0];
-		return resource;
+		return resources[0];
 	}
 
 }



From L.C.L.Kats at tudelft.nl  Mon Mar  8 13:38:36 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 08 Mar 2010 12:38:36 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20682 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.sdf/editor
	org.strategoxt.imp.editors.sdf/trans
	org.strategoxt.imp.editors.stratego/editor
	org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <201003081238.o28Ccaag021349@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-08 12:38:35 +0000 (Mon, 08 Mar 2010)
New Revision: 20682

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20682&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-References.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java

Log:
Added basic resolving/completion for SDF and some misc. tweaks.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-08 12:38:35 UTC (rev 20682)
@@ -4,6 +4,9 @@
 
 completions
 
+  completion proposer:
+    editor-complete
+
   completion template:
   	"context-free syntax" "\n\t" (blank)
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-References.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-References.esv	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-References.esv	2010-03-08 12:38:35 UTC (rev 20682)
@@ -5,9 +5,9 @@
 
 references
   
+  reference _ : editor-resolve
 
 
-
 // This file can be used for custom reference resolving rules.
 
 // See the imported file for a brief introduction and examples.
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-08 12:38:35 UTC (rev 20682)
@@ -5,6 +5,7 @@
   libstratego-sdf
   libstratego-sglr
   libstrc
+  analysis
 
 rules
 
@@ -14,7 +15,20 @@
   editor-analyze:
     (ast, path, project-path) -> ([], warnings, [])
     with
+      analyze-ast;
       warnings := <collect(?context-free-syntax(<filter(context-free-syntax-warning)>))> ast
+
+  editor-complete:
+    (node, position, ast, path, project-path) -> proposals
+    where
+      proposals := <propose-completion> node
+ 
+  editor-resolve:
+    (sort(x), position, ast, path, project-path) -> target
+    where
+      target := <Declaration> x
+
+rules
   
   context-free-syntax-warning:
     prod(p, s, a*) -> (target, $[Missing {cons("Label")} attribute to label the abstract syntax])

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Syntax.esv	2010-03-08 12:38:35 UTC (rev 20682)
@@ -25,7 +25,6 @@
     ":"
     "="
     <
-    >
     rules
     strategies
     overlays

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-08 12:38:35 UTC (rev 20682)
@@ -90,7 +90,7 @@
 strategies
   
   refresh-workspace-file:
-    f -> <prim("SSL_EXT_refreshresource", f)>
+    path -> <prim("SSL_EXT_refreshresource", path)>
 
 strategies
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-08 12:38:35 UTC (rev 20682)
@@ -287,7 +287,7 @@
 strategies
   
   refresh-workspace-file:
-    f -> <prim("SSL_EXT_refreshresource", f)>
+    path -> <prim("SSL_EXT_refreshresource", path)>
 
 strategies
 
@@ -357,7 +357,7 @@
 signature constructors
 
   COMPLETION : String -> Term
-  UNKNOWN    : Term   -> Term
+  NOCONTEXT  : Term   -> Term
   MARKER     : Term
 
   // Below are copies of the signatures of the terms used in example

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AbstractService.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -63,6 +63,10 @@
 		return language;
 	}
 	
+	SGLRParseController internalGetParseController() {
+		return parseController;
+	}
+	
 	public boolean isInitialized() {
 		return language != null && Environment.getDescriptor(language) != null;
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/AutoEditStrategyFactory.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -11,6 +11,7 @@
 import org.eclipse.jface.text.ITextViewerExtension;
 import org.eclipse.jface.text.source.ISourceViewer;
 import org.strategoxt.imp.runtime.EditorState;
+import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.SGLRParseController;
 import org.strategoxt.imp.runtime.services.AutoEditStrategy;
 
@@ -42,8 +43,11 @@
 					DynamicAutoEditStrategy dynAutoEdit = (DynamicAutoEditStrategy) autoEdit;
 					dynAutoEdit.initialize(controller);
 					ISourceViewer viewer = editor.getEditor().getServiceControllerManager().getSourceViewer();
-					if (viewer instanceof ITextViewerExtension)
+					if (viewer instanceof ITextViewerExtension) {
 						((ITextViewerExtension) viewer).prependVerifyKeyListener(dynAutoEdit);
+					} else {
+						Environment.logException("Text viewer does not implement ITextViewerExtension interface; cannot enable auto editing");
+					}
 				}
 			}
 		}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicAutoEditStrategy.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -27,7 +27,11 @@
 	}
 
 	public void verifyKey(VerifyEvent event) {
+		// HACK: AutoEditStrategy might not always be initialized, make sure it is
 		IAutoEditStrategy wrapped = getWrapped();
+		if (wrapped instanceof AutoEditStrategy)
+			((AutoEditStrategy) wrapped).initialize(internalGetParseController());
+		
 		if (wrapped instanceof VerifyKeyListener)
 			((VerifyKeyListener) wrapped).verifyKey(event);
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeFactory.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeFactory.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -66,17 +66,20 @@
 		return result;
 	}
 	
-	public AstNode createSublist(ListAstNode list, IStrategoAstNode startChild, IStrategoAstNode endChild) {
+	public AstNode createSublist(ListAstNode list, IStrategoAstNode startChild, IStrategoAstNode endChild, boolean cloneFirst) {
 		ArrayList<AstNode> children = new ArrayList<AstNode>();
 		int startOffset = list.getChildren().indexOf(startChild);
 		int endOffset = list.getChildren().indexOf(endChild);
 		
 		for (int i = startOffset; i <= endOffset; i++) {
-			children.add(list.getChildren().get(i));
+			AstNode child = list.getChildren().get(i);
+			assert child.getParent() != null;
+			children.add(child);
 		}
 		
 		AstNode result = new SubListAstNode(list, list.getElementSort(), startChild.getLeftIToken(), endChild.getLeftIToken(), children);
-		list.overrideReferences(list.getLeftIToken(), list.getRightIToken(), list.getChildren(), result);
+		if (cloneFirst) result = result.cloneIgnoreTokens();
+		list.overrideReferences(list.getLeftIToken(), list.getRightIToken(), children, result);
 		result.setParent(list);
 		return result;
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -367,10 +367,10 @@
 								&& proposalPrefix.regionMatches(matcher.start(), prefix, 0, prefix.length())) {
 							
 							// TODO: respect proposal.isBlankLineRequired() here?
-							String subProposal = proposalPrefix.substring(matcher.start());
+							String bigPrefix = proposalPrefix.substring(0, matcher.start() + prefix.length());
 							if (!backTrackResultsOnly) results.clear();
 							backTrackResultsOnly = true;
-							results.add(new ContentProposal(this, subProposal, proposal, prefix, offsetRegion));
+							results.add(new ContentProposal(this, proposal.getPrefix(), proposal, bigPrefix, offsetRegion));
 							break;
 						}
 					} while (matcher.find(matcher.end()));
@@ -548,7 +548,7 @@
 		AstNode newNode = createCompletionNode(prefix, node.getLeftIToken(), node.getRightIToken());
 		ArrayList<AstNode> newNodeContainer = new ArrayList<AstNode>(1);
 		newNodeContainer.add(newNode);
-		newNode = new AstNode(null, node.getLeftIToken(), node.getRightIToken(), COMPLETION_UNKNOWN, newNodeContainer);
+		currentCompletionNode = newNode = new AstNode(null, node.getLeftIToken(), node.getRightIToken(), COMPLETION_UNKNOWN, newNodeContainer);
 		
 		// Insert the node in a list near the textual input location
 		if (node instanceof ListAstNode) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -262,7 +262,6 @@
 
 	public void update(IParseController parseController, IProgressMonitor monitor) {
 		isUpdateStarted = true;
-		
 		IStrategoAstNode ast = (IStrategoAstNode) parseController.getCurrentAst();
 		if (ast == null || ast.getConstructor() == null)
 			return;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -77,8 +77,8 @@
 	public static IResource getResource(IContext env, String file) {
 		IOAgent agent = SSLLibrary.instance(env).getIOAgent();
 		File file2 = new File(file);
-		if (!file2.exists())
-			file2 = new File(agent.getWorkingDir() + "/" + file);
+		if (!file2.exists() && agent instanceof EditorIOAgent)
+			file2 = new File(((EditorIOAgent) agent).getProjectPath() + "/" + file);
 		return getResource(file2);
 	}
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java	2010-03-05 14:50:58 UTC (rev 20681)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java	2010-03-08 12:38:35 UTC (rev 20682)
@@ -128,7 +128,7 @@
 			if (i == 0)
 				return commonAncestor;
 			IStrategoAstNode child1 = ancestors1List.get(i - 1);
-			return new AstNodeFactory().createSublist((ListAstNode) commonAncestor, child1, child2); 
+			return new AstNodeFactory().createSublist((ListAstNode) commonAncestor, child1, child2, true); 
 		} else {
 			return commonAncestor;
 		}



From L.C.L.Kats at tudelft.nl  Mon Mar  8 16:09:20 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 08 Mar 2010 15:09:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20683 - LennartKats -
	spoofax-imp/trunk/org.eclipse.imp
Message-ID: <201003081509.o28F9KOv023263@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-08 15:09:19 +0000 (Mon, 08 Mar 2010)
New Revision: 20683

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20683&view=rev

Modified:
   spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch

Log:
Tuning presentation controller responsiveness

Changes:

Modified: spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch
===================================================================
--- spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	2010-03-08 12:38:35 UTC (rev 20682)
+++ spoofax-imp/trunk/org.eclipse.imp/org.eclipse.imp.runtime.patch	2010-03-08 15:09:19 UTC (rev 20683)
@@ -127,7 +127,7 @@
              fWorkItems.push(bigRegion);
          }
      }
-@@ -118,13 +122,18 @@
+@@ -118,13 +122,23 @@
  //            if (fWorkItems.size() == 0) {
  //                ConsoleUtil.findConsoleStream(PresentationController.CONSOLE_NAME).println("PresentationController.update() called, but no damage in the work queue?");
  //            }
@@ -143,6 +143,11 @@
 +            	try {
 +	                while (!monitor.isCanceled() && !fWorkItems.isEmpty()) {
 +	                    Region damage = (Region) fWorkItems.pop();
++	                    synchronized (fWorkItems) { // LK: clean up work items queue
++	                    	while (!fWorkItems.isEmpty()
++	                    			&& (fWorkItems.peek().getOffset() >= damage.getOffset() && fWorkItems.peek().getLength() <= damage.getLength()))
++	                    		fWorkItems.pop();
++	                    }
 +	                    changeTextPresentationForRegion(controller, monitor, damage);
 +	                }
 +	                // if (!monitor.isCanceled())
@@ -153,7 +158,7 @@
              }
          }
      }
-@@ -157,7 +166,7 @@
+@@ -157,7 +171,7 @@
              int offset= locator.getStartOffset(token);
              int end= locator.getEndOffset(token);
  
@@ -162,7 +167,7 @@
                  continue;
              }
              changeTokenPresentation(parseController, presentation, token, locator);
-@@ -176,7 +185,7 @@
+@@ -176,7 +190,7 @@
          
         // SMS 21 Jun 2007:  negative (possibly 0) length style ranges seem to cause problems;
          // but if you have one it should lead to an IllegalArgumentException in changeTextPresentation(..)
@@ -171,7 +176,7 @@
          } else {
              presentation.addStyleRange(styleRange);
          }
-@@ -190,6 +199,7 @@
+@@ -190,6 +204,7 @@
              	// SMS 16 Sep 2008
              	int charCount;
              	if (fSourceViewer != null) {
@@ -179,7 +184,7 @@
              		charCount = fSourceViewer.getDocument().getLength();
              	} else {
              		charCount = 0;
-@@ -201,7 +211,7 @@
+@@ -201,7 +216,7 @@
              	int lastLength = presentation.getLastStyleRange().length;
              	int end = lastStart + lastLength;
          		TextPresentation newPresentation = null;
@@ -200,7 +205,17 @@
  import java.util.Iterator;
  import java.util.List;
  import java.util.Map;
-@@ -42,6 +43,7 @@
+@@ -31,7 +32,9 @@
+ import org.eclipse.core.runtime.CoreException;
+ import org.eclipse.core.runtime.IPath;
+ import org.eclipse.core.runtime.IProgressMonitor;
++import org.eclipse.core.runtime.IStatus;
+ import org.eclipse.core.runtime.NullProgressMonitor;
++import org.eclipse.core.runtime.Status;
+ import org.eclipse.debug.ui.actions.IToggleBreakpointsTarget;
+ import org.eclipse.debug.ui.actions.ToggleBreakpointAction;
+ import org.eclipse.help.IContextProvider;
+@@ -42,6 +45,7 @@
  import org.eclipse.imp.editor.internal.AnnotationCreator;
  import org.eclipse.imp.editor.internal.EditorErrorTickUpdater;
  import org.eclipse.imp.editor.internal.FoldingController;
@@ -208,7 +223,15 @@
  import org.eclipse.imp.editor.internal.ProblemMarkerManager;
  import org.eclipse.imp.editor.internal.ToggleBreakpointsAdapter;
  import org.eclipse.imp.help.IMPHelp;
-@@ -240,6 +242,9 @@
+@@ -163,6 +167,7 @@
+ import org.eclipse.ui.editors.text.TextSourceViewerConfiguration;
+ import org.eclipse.ui.handlers.IHandlerActivation;
+ import org.eclipse.ui.handlers.IHandlerService;
++import org.eclipse.ui.progress.UIJob;
+ import org.eclipse.ui.texteditor.AbstractTextEditor;
+ import org.eclipse.ui.texteditor.ContentAssistAction;
+ import org.eclipse.ui.texteditor.IEditorStatusLine;
+@@ -240,6 +245,9 @@
      private static final String BUNDLE_FOR_CONSTRUCTED_KEYS= MESSAGE_BUNDLE;//$NON-NLS-1$
  
      private static final String IMP_EDITOR_CONTEXT= RuntimePlugin.IMP_RUNTIME + ".imp_editor_context";
@@ -218,7 +241,7 @@
  
      static ResourceBundle fgBundleForConstructedKeys= ResourceBundle.getBundle(BUNDLE_FOR_CONSTRUCTED_KEYS);
  
-@@ -257,6 +262,32 @@
+@@ -257,6 +265,41 @@
          setInsertMode(SMART_INSERT);
          fProblemMarkerManager= new ProblemMarkerManager();
      }
@@ -244,14 +267,23 @@
 +    }
 +    
 +    public void updateColoring(Region region) { // LK
-+        PresentationController presentation = fServiceControllerManager.getPresentationController();
++    	final PresentationController presentation = fServiceControllerManager.getPresentationController();
 +		presentation.damage(region);
-+        presentation.update(fLanguageServiceManager.getParseController(), new NullProgressMonitor());
++		// Must run in main thread in order not to keep further updates waiting
++		UIJob job = new UIJob("Update presentation") {
++			@Override
++			public IStatus runInUIThread(IProgressMonitor monitor) {
++				presentation.update(fLanguageServiceManager.getParseController(), monitor);
++				return Status.OK_STATUS;
++			}
++		};
++		job.setSystem(true);
++		job.schedule();
 +    }
  
      public Object getAdapter(Class required) {
          if (IContentOutlinePage.class.equals(required)) {
-@@ -697,7 +728,8 @@
+@@ -697,7 +740,8 @@
          IFile file= EditorInputUtils.getFile(editorInput);
          IPath filePath= EditorInputUtils.getPath(editorInput);
          try {
@@ -261,7 +293,7 @@
  
              fLanguageServiceManager.getParseController().initialize(filePath, srcProject, fAnnotationCreator);
          } catch (ModelException e) {
-@@ -1491,6 +1523,7 @@
+@@ -1491,6 +1535,7 @@
              ContentAssistant ca= new ContentAssistant();
              ca.setContentAssistProcessor(fServiceControllerManager.getCompletionProcessor(), IDocument.DEFAULT_CONTENT_TYPE);
              ca.setInformationControlCreator(getInformationControlCreator(sourceViewer));
@@ -269,7 +301,7 @@
              return ca;
          }
  
-@@ -1771,7 +1804,8 @@
+@@ -1771,7 +1816,8 @@
                  if (fServiceControllerManager.getPresentationController() != null) {
  //                  System.out.println("Scheduling repair for damage to region " + damage.getOffset() + ":" + damage.getLength() + " in doc of length " + fDocument.getLength());
                      fServiceControllerManager.getPresentationController().damage(damage);
@@ -279,7 +311,7 @@
  //                      System.out.println("** Forcing repair for hyperlink damage to region " + damage.getOffset() + ":" + damage.getLength() + " in doc of length " + fDocument.getLength());
                          fServiceControllerManager.getPresentationController().update(fLanguageServiceManager.getParseController(), fProgressMonitor);
                      }
-@@ -1845,6 +1879,7 @@
+@@ -1845,6 +1891,7 @@
      }
  
      public IParseController getParseController() {
@@ -287,7 +319,7 @@
          return fLanguageServiceManager.getParseController();
      }
      
-@@ -1861,7 +1896,12 @@
+@@ -1861,7 +1908,12 @@
  		// SMS 25 Apr 2007:  Removing parser annotations here
  		// may not hurt but also doesn't seem to be necessary
  		//removeParserAnnotations();



From L.C.L.Kats at tudelft.nl  Mon Mar  8 16:09:34 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 08 Mar 2010 15:09:34 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20684 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003081509.o28F9YWw023266@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-08 15:09:34 +0000 (Mon, 08 Mar 2010)
New Revision: 20684

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20684&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java	2010-03-08 15:09:19 UTC (rev 20683)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposalTemplate.java	2010-03-08 15:09:34 UTC (rev 20684)
@@ -3,9 +3,12 @@
  */
 package org.strategoxt.imp.runtime.services;
 
+import static org.spoofax.interpreter.core.Tools.termAt;
+import static org.strategoxt.imp.runtime.dynamicloading.TermReader.cons;
 import static org.strategoxt.imp.runtime.dynamicloading.TermReader.termContents;
 
 import org.spoofax.interpreter.terms.IStrategoList;
+import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 
 /**
@@ -40,7 +43,14 @@
 	public String getDescription() {
 		StringBuilder result = new StringBuilder();
 		for (IStrategoTerm part : completionParts.getAllSubterms()) {
-			result.append(termContents(part));
+			if ("Placeholder".equals(cons(part))) {
+				IStrategoString placeholder = termAt(part, 0);
+				String contents = placeholder.stringValue();
+				contents = contents.substring(1, contents.length() - 1); // strip < >
+				result.append(contents);
+			} else {
+				result.append(termContents(part));
+			}
 		}
 		return AutoEditStrategy.formatInsertedText(result.toString(), "");
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-08 15:09:19 UTC (rev 20683)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-08 15:09:34 UTC (rev 20684)
@@ -313,7 +313,7 @@
 		
 		Arrays.sort(resultArray, new Comparator<ICompletionProposal>() {
 			public int compare(ICompletionProposal o1, ICompletionProposal o2) {
-				return o1.getDisplayString().compareTo(o2.getDisplayString());
+				return o1.getDisplayString().compareToIgnoreCase(o2.getDisplayString());
 			}
 		});
 		return resultArray;
@@ -329,7 +329,7 @@
 				if (prefix.length() > 0 || identifierLexical.matcher(proposal).lookingAt())
 					results.add(new ContentProposal(this, proposal, proposal, prefix, offsetRegion,
 							offset + proposal.length() - prefix.length(), ""));
-			} else {
+			} /*else*/ {
 				Matcher matcher = identifierLexical.matcher(proposal);
 				if (matcher.find() && (matcher.start() > 0 || matcher.end() < proposal.length())) {
 					// Handle completion literals with special characters, like "(disabled)"
@@ -356,7 +356,7 @@
 			if (!backTrackResultsOnly && proposalPrefix.regionMatches(IGNORE_TEMPLATE_PREFIX_CASE, 0, prefix, 0, prefix.length())) {
 				if (!proposal.isBlankLineRequired() || isBlankBeforeOffset(document, offset - prefix.length()))
 					results.add(new ContentProposal(this, proposal.getPrefix(), proposal, prefix, offsetRegion));
-			} else {
+			} /*else*/ {
 				Matcher matcher = identifierLexical.matcher(proposalPrefix);
 				if (matcher.find() && (matcher.start() > 0 || matcher.end() < proposalPrefix.length())) {
 					// Handle completion literals with special characters, like "(disabled)"



From R.B.Vermaas at tudelft.nl  Tue Mar  9 12:04:02 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 09 Mar 2010 11:04:02 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20685 - rob - hydra
Message-ID: <201003091104.o29B42fK007242@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-09 11:04:02 +0000 (Tue, 09 Mar 2010)
New Revision: 20685

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20685&view=rev

Modified:
   hydra/job.nix

Log:
 * hydra-config/job.nix: remove explicit tarball arguments

Changes:

Modified: hydra/job.nix
===================================================================
--- hydra/job.nix	2010-03-08 15:09:34 UTC (rev 20684)
+++ hydra/job.nix	2010-03-09 11:04:02 UTC (rev 20685)
@@ -9,10 +9,10 @@
 
   tarballTop = builder.easyTarball pkgs spec ;
 
-  jobs = {
+  jobs = rec {
     tarball = tarballTop ;
-    build   = { tarball ? jobs.tarball, system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball tarball sysPkgs (spec sysPkgs) ;
-    release = { tarball ? jobs.tarball }: builder.easyReleaseNix pkgsDebRPM spec tarball ;
+    build   = { system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball tarball sysPkgs (spec sysPkgs) ;
+    release = builder.easyReleaseNix pkgsDebRPM spec tarball ;
   } // builder.debs pkgsDebRPM spec tarballTop
     // builder.rpms pkgsDebRPM spec tarballTop
     // builder.makeDocsJob pkgsDebRPM spec



From L.C.L.Kats at tudelft.nl  Tue Mar  9 13:03:05 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 09 Mar 2010 12:03:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20686 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.sdf
	org.strategoxt.imp.editors.sdf/editor
	org.strategoxt.imp.editors.sdf/lib
	org.strategoxt.imp.editors.sdf/trans
	org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
Message-ID: <201003091203.o29C35Zn008355@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-09 12:03:05 +0000 (Tue, 09 Mar 2010)
New Revision: 20686

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20686&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-09 11:04:02 UTC (rev 20685)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Completions.esv	2010-03-09 12:03:05 UTC (rev 20686)
@@ -1,7 +1,5 @@
 module SDF-Completions
 
-imports SDF-Completions.generated
-
 completions
 
   completion proposer:
@@ -23,6 +21,9 @@
   	"exports" "\n\t" (blank)
 
   completion template:
+    "hiddens" "\n\t" (blank)
+
+  completion template:
   	"context-free restrictions" "\n\t" (blank)
 
   completion template:
@@ -53,7 +54,67 @@
   	"priorities" "\n\t" (blank)
 
   completion template:
-  	"module" <x> "\n\t\nexports\n\t" (blank)
+  	"module" " " <x> "\n\t\nexports\n\t" (blank)
 
   completion template:
   	"lexical variables" "\n\t" (blank)
+
+  completion template:
+    "{cons" "(\"" <x> "\")"
+
+  completion template:
+    "{deprecated" "(\"" <explanation> "\")"
+
+  completion keyword:
+    "{reject"
+
+  completion keyword:
+    "{left"
+
+  completion keyword:
+    "{right"
+
+  completion keyword:
+    "{non-assoc"
+
+  completion keyword:
+    "{avoid"
+
+  completion keyword:
+    "{prefer"
+
+  completion keyword:
+    "{bracket"
+
+  completion keyword:
+    "{recover"
+
+  completion template:
+    ", cons" "(\"" <x> "\")"
+
+  completion template:
+    ", deprecated" "(\"" <explanation> "\")"
+
+  completion keyword:
+    ", reject"
+
+  completion keyword:
+    ", left"
+
+  completion keyword:
+    ", right"
+
+  completion keyword:
+    ", non-assoc"
+
+  completion keyword:
+    ", avoid"
+
+  completion keyword:
+    ", prefer"
+
+  completion keyword:
+    ", bracket"
+
+  completion keyword:
+    ", recover"
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv	2010-03-09 11:04:02 UTC (rev 20685)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Syntax.esv	2010-03-09 12:03:05 UTC (rev 20686)
@@ -1,13 +1,11 @@
 module SDF-Syntax
 
-imports
-  SDF-Syntax.generated
-
 language
   
   indent after:
     imports
     exports
+    hiddens
     syntax
     sorts
     restrictions

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-09 12:03:05 UTC (rev 20686)
@@ -0,0 +1,169 @@
+module lib/editor-common.generated
+
+imports
+  libstratego-lib
+  libstratego-sglr
+
+strategies
+
+  parse-file =
+    parse-file(
+      strsglr-perror, strsglr-report-parse-error
+    | <import-term(include/SDF.tbl)>
+    )
+
+  parse-string =
+    parse-string(
+      strsglr-report-parse-error
+    | <import-term(include/SDF.tbl)>
+    )
+  
+strategies
+  
+  /**
+   * Processes an import during semantic analysis.
+   * Ensures proper caching of files and prevents
+   * processing duplicate imports more than once.
+   *
+   * @param resolve-path  Resolves the filesystem path of this import
+   * @param parse-file    Parses a file (optionally removing definition bodies
+   *                      so only signatures are stored in the cache)
+   * @param record-declarations
+   *                      Performs semantic analysis on a tree
+   */
+  open-import(resolve-path, parse-file, record-declarations):
+    import -> file'
+    where
+      if not(!import => COMPLETION(_)) then
+        path       := <resolve-path> import;
+        cache-path := <import-cache-path> path;
+        if not(<IsImported> path) then
+          rules(
+            IsImported: path
+          );
+          if <is-newer> (cache-path, path) then
+            file := <ReadFromFile> cache-path
+          else
+            file := <parse-file> path;
+            if <file-exists> path then
+              // Only cache if on filesystem (e.g., ignore libstratego-lib)
+              <WriteToBinaryFile> (cache-path, file)
+            end        
+          end;
+          {| CurrentFile:
+            rules(CurrentFile := path);
+            file' := <record-declarations> file
+          |}
+        end
+      end
+
+  open-wildcard-import(resolve-path, parse-file, record-declarations, is-source-file):
+    import -> import
+    where
+      if not(!import => COMPLETION(_)) then
+        path := <resolve-path> import;
+        readdir;
+        list-loop(
+          if is-source-file then
+            <open-import(resolve-path, parse-file, record-declarations)>
+              $[[path]/[<id>]]
+          <+
+            try(?one-failed)
+          end
+        );
+        not(!one-failed)
+      end
+  
+  import-cache-path:
+    full-path -> cache-path
+    with
+      project-path := <prim("SSL_EXT_projectpath")>;
+      cache-dir    := <file-exists <+ mkdir> $[[project-path]/.cache];
+      full-path'   := <string-replace(|"/", "+"); string-replace(|"\\", "+"); string-replace(|":", "+")> full-path;
+      cache-path   := $[[cache-dir]/[full-path'].sig]
+
+  is-newer:
+    (file1, file2) -> <id>
+    where
+      <gt> (<file-exists; modification-time> file1, <file-exists; modification-time> file2) 
+
+strategies
+  
+  refresh-workspace-file:
+    path -> <prim("SSL_EXT_refreshresource", path)>
+
+strategies
+
+  desugar-position(desugar|ast):
+    position -> position'
+    where
+      ast'  := <at-position(!<id>{MARKER()}|position)> ast;
+      ast'' := <topdown(repeat(preserve-annos({?x; desugar; not(?x)})))> ast';
+      position' := <position-of-term({?_{a*}; <one(?MARKER())> a*})> ast''
+   
+  at-position(s|position):
+    c#(t*) -> t'
+    where
+      !position => [i | position']
+    where
+      t' := c#(<at-index(at-position(s|position'))> (i, t*))
+
+  at-position(s|position):
+    t -> t'
+    where
+      !position => [];
+      t' := <s> t
+
+  position-of-term(is-term):
+    t -> []
+    where
+      is-term
+  
+  position-of-term(is-term):
+    _#(t*) -> <position-of-term(is-term|0)> t*
+  
+  position-of-term(is-term|start-index):
+    [t | t*] -> position
+    where
+      if i* := <position-of-term(is-term)> t then
+        position := [start-index | i*]
+      else
+        position := <position-of-term(is-term | <inc> start-index)> t*
+      end
+
+  term-at-position(|position):
+    t -> t'
+    where
+      at-position(?t'|position) 
+
+  parent-at-position(|position):
+    t -> t'
+    where
+      !position => [i, _];
+      t' := <subterm-at(|i)> t
+  
+  parent-at-position(|position):
+    t -> <parent-at-position(|position')> t'
+    where
+      !position => [i | position' @ [_, _ | _]];
+      t' := <subterm-at(|i)> t
+
+  subterm-at(|index):
+    _#(t*) -> <index(|<inc> index)> t*
+  
+signature constructors
+
+  COMPLETION : String -> Term
+  NOCONTEXT  : Term   -> Term
+  MARKER     : Term
+
+  // Below are copies of the signatures of the terms used in example
+  // trans/sdf.str file. These definitions should also be automatically 
+  // generated in the imported include/SDF.str module. However,
+  // to ensure that the example transformation doesn't break when the
+  // syntax is changed, we also hard-coded them here.
+          
+  Module   : ID * List(Entity)   -> Module
+  Entity   : ID * List(Property) -> Entity
+  Property : ID * Type           -> Property
+  Type     : ID                  -> Type

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-09 11:04:02 UTC (rev 20685)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-09 12:03:05 UTC (rev 20686)
@@ -21,7 +21,7 @@
   editor-complete:
     (node, position, ast, path, project-path) -> proposals
     where
-      proposals := <propose-completion> node
+      proposals := <propose-completion <+ ![]> node
  
   editor-resolve:
     (sort(x), position, ast, path, project-path) -> target

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-09 11:04:02 UTC (rev 20685)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-09 12:03:05 UTC (rev 20686)
@@ -154,7 +154,7 @@
 signature constructors
 
   COMPLETION : String -> Term
-  UNKNOWN    : Term   -> Term
+  NOCONTEXT  : Term   -> Term
   MARKER     : Term
 
   // Below are copies of the signatures of the terms used in example

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-09 11:04:02 UTC (rev 20685)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-09 12:03:05 UTC (rev 20686)
@@ -355,7 +355,8 @@
 			String proposalPrefix = proposal.getPrefix();
 			if (!backTrackResultsOnly && proposalPrefix.regionMatches(IGNORE_TEMPLATE_PREFIX_CASE, 0, prefix, 0, prefix.length())) {
 				if (!proposal.isBlankLineRequired() || isBlankBeforeOffset(document, offset - prefix.length()))
-					results.add(new ContentProposal(this, proposal.getPrefix(), proposal, prefix, offsetRegion));
+					if (prefix.length() > 0 || identifierLexical.matcher(proposal.getPrefix()).lookingAt())
+						results.add(new ContentProposal(this, proposal.getPrefix(), proposal, prefix, offsetRegion));
 			} /*else*/ {
 				Matcher matcher = identifierLexical.matcher(proposalPrefix);
 				if (matcher.find() && (matcher.start() > 0 || matcher.end() < proposalPrefix.length())) {



From L.C.L.Kats at tudelft.nl  Tue Mar  9 13:03:48 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 09 Mar 2010 12:03:48 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20687 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl
	strc-java/trunk/java
Message-ID: <201003091203.o29C3mGv008364@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-09 12:03:48 +0000 (Tue, 09 Mar 2010)
New Revision: 20687

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20687&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_explode_string.java
   strc-java/trunk/java/spoofax-libs.jar

Log:


Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2010-03-09 12:03:05 UTC (rev 20686)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2010-03-09 12:03:48 UTC (rev 20687)
@@ -136,7 +136,9 @@
             if (file.writer == null) {
                 assert file.outputStream == null;
                 try {
-                    file.file.setLength(0); // Clear written-to file contents
+                    // Clear written-to file contents
+                    if (file.file.length() != 0)
+                        file.file.setLength(0);
                 } catch (IOException e) {
                     // Be forgiving: if this results in an exception, so will writing to it
                 }

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_explode_string.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_explode_string.java	2010-03-09 12:03:05 UTC (rev 20686)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_explode_string.java	2010-03-09 12:03:48 UTC (rev 20687)
@@ -13,6 +13,7 @@
 import org.spoofax.interpreter.library.AbstractPrimitive;
 import org.spoofax.interpreter.stratego.Strategy;
 import org.spoofax.interpreter.terms.IStrategoList;
+import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.ITermFactory;
 
@@ -28,7 +29,7 @@
         if (!Tools.isTermString(t))
             return false;
         
-        String s = Tools.javaString(t);
+        String s = ((IStrategoString) t).stringValue();
         
         ITermFactory factory = env.getFactory();
         IStrategoList result = factory.makeList();

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Tue Mar  9 14:06:30 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 09 Mar 2010 13:06:30 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20690 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.aterm
	org.strategoxt.imp.editors.stratego
Message-ID: <201003091306.o29D6Uun009569@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-09 13:06:29 +0000 (Tue, 09 Mar 2010)
New Revision: 20690

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20690&view=rev

Removed:
   spoofax-imp/trunk/org.strategoxt.imp.editors.aterm/aux/
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/aux/

Log:
Removed old aux dirs (preventing checkout on Windows)

Changes:



From R.B.Vermaas at tudelft.nl  Tue Mar  9 21:26:35 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 09 Mar 2010 20:26:35 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20691 - rob -
	hydra/webdsl
Message-ID: <201003092026.o29KQZFP015673@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-09 20:26:35 +0000 (Tue, 09 Mar 2010)
New Revision: 20691

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20691&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
test case for webdsl.org

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-09 13:06:29 UTC (rev 20690)
+++ hydra/webdsl/tests.nix	2010-03-09 20:26:35 UTC (rev 20691)
@@ -1,15 +1,12 @@
 { nixpkgs ? ../../nixpkgs
+, webdsl
 }:
 let 
   pkgs = import nixpkgs { system = "i686-linux"; };
-in
-{
-  researchr = { 
-    webdsl
-  , researchrSrc ? { outPath = ../../researchr; rev = 1234; }  
-  } :
+ 
+  build = name : src :
     pkgs.stdenv.mkDerivation {
-      name = "researchr-r${toString researchrSrc.rev}";
+      name = "${name}-r${toString src.rev}";
       buildInputs = [webdsl pkgs.ant];
       buildCommand = ''
         ensureDir $out/nix-support        
@@ -17,7 +14,7 @@
         export ANT_ARGS="-logger org.hydra.ant.HydraLogger -lib `ls ${pkgs.hydraAntLogger}/lib/java/*.jar | head -1`"
 
         header "Copying sources"        
-        cp -vR ${researchrSrc}/* .
+        cp -vR ${src}/* .
         cp -v ${./application.ini} application.ini
         chmod -R 755 . 
         stopNest
@@ -29,4 +26,11 @@
         touch $out/nix-support/hydra-build-products
       '';
   };
+
+in
+{
+  researchr = {  researchrSrc ? { outPath = ../../researchr; rev = 1234; } } : build "researchr" researchrSrc ;
+  webdslorg = {  researchrSrc ? { outPath = ../../webdslorg; rev = 1234; } } : build "webdslorg" webdslorgSrc ;
+
+
 }



From R.B.Vermaas at tudelft.nl  Tue Mar  9 21:29:16 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Tue, 09 Mar 2010 20:29:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20692 - rob -
	hydra/webdsl
Message-ID: <201003092029.o29KTGeM015697@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-09 20:29:16 +0000 (Tue, 09 Mar 2010)
New Revision: 20692

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20692&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
typo

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-09 20:26:35 UTC (rev 20691)
+++ hydra/webdsl/tests.nix	2010-03-09 20:29:16 UTC (rev 20692)
@@ -30,7 +30,7 @@
 in
 {
   researchr = {  researchrSrc ? { outPath = ../../researchr; rev = 1234; } } : build "researchr" researchrSrc ;
-  webdslorg = {  researchrSrc ? { outPath = ../../webdslorg; rev = 1234; } } : build "webdslorg" webdslorgSrc ;
+  webdslorg = {  webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } } : build "webdslorg" webdslorgSrc ;
 
 
 }



From R.B.Vermaas at tudelft.nl  Wed Mar 10 08:33:05 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 10 Mar 2010 07:33:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20693 - rob -
	hydra/webdsl
Message-ID: <201003100733.o2A7X6DY024669@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-10 07:33:04 +0000 (Wed, 10 Mar 2010)
New Revision: 20693

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20693&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:


Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-09 20:29:16 UTC (rev 20692)
+++ hydra/webdsl/tests.nix	2010-03-10 07:33:04 UTC (rev 20693)
@@ -3,9 +3,25 @@
 }:
 let 
   pkgs = import nixpkgs { system = "i686-linux"; };
+  appIni = name : pkgs.writeText "application.ini" ''
+    export BACKEND=servlet
+    export TOMCATPATH=/opt/tomcat
+    export APPNAME=${name}
+    export DBSERVER=localhost
+    export DBUSER=webdsluser 
+    export DBPASSWORD=
+    export DBNAME=webdsldb
+    export DBMODE=create-drop
+    export SMTPHOST=localhost
+    export SMTPPORT=25
+    export SMTPUSER=  
+    export SMTPPASS=
+    export SMTPSSL=false
+    export SMTPTLS=false
+  '';
  
   build = name : src :
-    pkgs.stdenv.mkDerivation {
+    pkgs.stdenv.mkDerivation rec {
       name = "${name}-r${toString src.rev}";
       buildInputs = [webdsl pkgs.ant];
       buildCommand = ''
@@ -15,7 +31,7 @@
 
         header "Copying sources"        
         cp -vR ${src}/* .
-        cp -v ${./application.ini} application.ini
+        cp -v ${appIni name} application.ini
         chmod -R 755 . 
         stopNest
  



From R.B.Vermaas at tudelft.nl  Wed Mar 10 08:34:41 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 10 Mar 2010 07:34:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20694 - rob -
	hydra/webdsl
Message-ID: <201003100734.o2A7Yfb9024683@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-10 07:34:41 +0000 (Wed, 10 Mar 2010)
New Revision: 20694

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20694&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
inifite recursion not good...

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-10 07:33:04 UTC (rev 20693)
+++ hydra/webdsl/tests.nix	2010-03-10 07:34:41 UTC (rev 20694)
@@ -20,9 +20,9 @@
     export SMTPTLS=false
   '';
  
-  build = name : src :
+  build = appname : src :
     pkgs.stdenv.mkDerivation rec {
-      name = "${name}-r${toString src.rev}";
+      name = "${appname}-r${toString src.rev}";
       buildInputs = [webdsl pkgs.ant];
       buildCommand = ''
         ensureDir $out/nix-support        
@@ -31,7 +31,7 @@
 
         header "Copying sources"        
         cp -vR ${src}/* .
-        cp -v ${appIni name} application.ini
+        cp -v ${appIni appname} application.ini
         chmod -R 755 . 
         stopNest
  



From R.B.Vermaas at tudelft.nl  Wed Mar 10 13:43:23 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 10 Mar 2010 12:43:23 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20695 - rob -
	hydra/webdsl
Message-ID: <201003101243.o2AChNBO030104@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-10 12:43:23 +0000 (Wed, 10 Mar 2010)
New Revision: 20695

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20695&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
add yellowgrass build

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-10 07:34:41 UTC (rev 20694)
+++ hydra/webdsl/tests.nix	2010-03-10 12:43:23 UTC (rev 20695)
@@ -31,7 +31,9 @@
 
         header "Copying sources"        
         cp -vR ${src}/* .
-        cp -v ${appIni appname} application.ini
+        if test -f application.ini ; then
+          cp -v ${appIni appname} application.ini
+        fi
         chmod -R 755 . 
         stopNest
  
@@ -45,8 +47,7 @@
 
 in
 {
-  researchr = {  researchrSrc ? { outPath = ../../researchr; rev = 1234; } } : build "researchr" researchrSrc ;
-  webdslorg = {  webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } } : build "webdslorg" webdslorgSrc ;
-
-
+  researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } } : build "researchr" researchrSrc ;
+  webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } } : build "webdslorg" webdslorgSrc ;
+  yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ;
 }



From R.B.Vermaas at tudelft.nl  Wed Mar 10 13:45:44 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 10 Mar 2010 12:45:44 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20696 - rob -
	hydra/webdsl
Message-ID: <201003101245.o2ACjiL7030120@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-10 12:45:44 +0000 (Wed, 10 Mar 2010)
New Revision: 20696

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20696&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
typo

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-10 12:43:23 UTC (rev 20695)
+++ hydra/webdsl/tests.nix	2010-03-10 12:45:44 UTC (rev 20696)
@@ -31,7 +31,7 @@
 
         header "Copying sources"        
         cp -vR ${src}/* .
-        if test -f application.ini ; then
+        if ! test -f application.ini ; then
           cp -v ${appIni appname} application.ini
         fi
         chmod -R 755 . 



From L.C.L.Kats at tudelft.nl  Wed Mar 10 14:23:05 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 10 Mar 2010 13:23:05 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20697 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.sdf/lib
	org.strategoxt.imp.editors.stratego/lib org.strategoxt.imp.feature
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.updatesite
Message-ID: <201003101323.o2ADN5jH031359@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-10 13:23:04 +0000 (Wed, 10 Mar 2010)
New Revision: 20697

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20697&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
0.4 release

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-10 12:45:44 UTC (rev 20696)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-10 13:23:04 UTC (rev 20697)
@@ -32,7 +32,7 @@
    *                      Performs semantic analysis on a tree
    */
   open-import(resolve-path, parse-file, record-declarations):
-    import -> file'
+    import -> import
     where
       if not(!import => COMPLETION(_)) then
         path       := <resolve-path> import;
@@ -52,7 +52,7 @@
           end;
           {| CurrentFile:
             rules(CurrentFile := path);
-            file' := <record-declarations> file
+            <record-declarations> file
           |}
         end
       end

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-10 12:45:44 UTC (rev 20696)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-10 13:23:04 UTC (rev 20697)
@@ -32,7 +32,7 @@
    *                      Performs semantic analysis on a tree
    */
   open-import(resolve-path, parse-file, record-declarations):
-    import -> file'
+    import -> import
     where
       if not(!import => COMPLETION(_)) then
         path       := <resolve-path> import;
@@ -52,7 +52,7 @@
           end;
           {| CurrentFile:
             rules(CurrentFile := path);
-            file' := <record-declarations> file
+            <record-declarations> file
           |}
         end
       end

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-10 12:45:44 UTC (rev 20696)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-10 13:23:04 UTC (rev 20697)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.3.9.4"
+      version="0.4.0"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">
@@ -25,7 +25,7 @@
    </license>
 
    <url>
-      <update label="Spoofax/IMP updates" url="http://www.lclnet.nl/update/unstable/"/>
+      <update label="Spoofax/IMP updates" url="http://www.lclnet.nl/update/"/>
    </url>
 
    <requires>

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-10 12:45:44 UTC (rev 20696)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-10 13:23:04 UTC (rev 20697)
@@ -229,7 +229,7 @@
    *                      Performs semantic analysis on a tree
    */
   open-import(resolve-path, parse-file, record-declarations):
-    import -> file'
+    import -> import
     where
       if not(!import => COMPLETION(_)) then
         path       := <resolve-path> import;
@@ -249,7 +249,7 @@
           end;
           ${$| CurrentFile:
             rules(CurrentFile := path);
-            file' := <record-declarations> file
+            <record-declarations> file
           |$}$
         end
       end
@@ -370,4 +370,4 @@
   Entity   : ID * List(Property) -> Entity
   Property : ID * Type           -> Property
   Type     : ID                  -> Type
-}
\ No newline at end of file
+}

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-10 12:45:44 UTC (rev 20696)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-10 13:23:04 UTC (rev 20697)
@@ -1,9 +1,9 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <site>
-   <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/unstable/">
+   <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.3.9.4.jar" id="org.strategoxt.imp" version="0.3.9.4">
+   <feature url="features/org.strategoxt.imp_0.4.0.jar" id="org.strategoxt.imp" version="0.4.0">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From R.B.Vermaas at tudelft.nl  Wed Mar 10 14:25:14 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 10 Mar 2010 13:25:14 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20698 - rob -
	hydra/webdsl
Message-ID: <201003101325.o2ADPEYP031371@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-10 13:25:14 +0000 (Wed, 10 Mar 2010)
New Revision: 20698

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20698&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
add maintainers

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-10 13:23:04 UTC (rev 20697)
+++ hydra/webdsl/tests.nix	2010-03-10 13:25:14 UTC (rev 20698)
@@ -20,7 +20,9 @@
     export SMTPTLS=false
   '';
  
-  build = appname : src :
+  defaultMaintainters = [ "rob.vermaas at gmail.com" ];
+
+  build = appname : src : maintainers ; 
     pkgs.stdenv.mkDerivation rec {
       name = "${appname}-r${toString src.rev}";
       buildInputs = [webdsl pkgs.ant];
@@ -43,11 +45,13 @@
 
         touch $out/nix-support/hydra-build-products
       '';
+
+      meta.maintainers = defaultMaintainters ++ maintainers ;
   };
 
 in
 {
-  researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } } : build "researchr" researchrSrc ;
-  webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } } : build "webdslorg" webdslorgSrc ;
-  yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ;
+  researchr   = { researchrSrc ? { outPath = ../../researchr; rev = 1234; } }     : build "researchr" researchrSrc [];
+  webdslorg   = { webdslorgSrc ? { outPath = ../../webdslorg; rev = 1234; } }     : build "webdslorg" webdslorgSrc [];
+  yellowgrass = { yellowgrassSrc ? { outPath = ../../yellowgrass; rev = 1234; } } : build "yellowgrass" yellowgrassSrc ["s.d.vermolen at tudelft.nl"] ;
 }



From R.B.Vermaas at tudelft.nl  Wed Mar 10 14:25:38 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 10 Mar 2010 13:25:38 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20699 - rob -
	hydra/webdsl
Message-ID: <201003101325.o2ADPceL031382@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-10 13:25:38 +0000 (Wed, 10 Mar 2010)
New Revision: 20699

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20699&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
add maintainers

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-10 13:25:14 UTC (rev 20698)
+++ hydra/webdsl/tests.nix	2010-03-10 13:25:38 UTC (rev 20699)
@@ -22,7 +22,7 @@
  
   defaultMaintainters = [ "rob.vermaas at gmail.com" ];
 
-  build = appname : src : maintainers ; 
+  build = appname : src : maintainers :
     pkgs.stdenv.mkDerivation rec {
       name = "${appname}-r${toString src.rev}";
       buildInputs = [webdsl pkgs.ant];



From L.C.L.Kats at tudelft.nl  Wed Mar 10 15:20:11 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 10 Mar 2010 14:20:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20700 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
Message-ID: <201003101420.o2AEKB6j032345@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-10 14:20:11 +0000 (Wed, 10 Mar 2010)
New Revision: 20700

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20700&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	2010-03-10 13:25:38 UTC (rev 20699)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/Descriptor.java	2010-03-10 14:20:11 UTC (rev 20700)
@@ -98,9 +98,11 @@
 	 * @see AbstractService#reinitialize(Descriptor)
 	 */
 	public void reinitialize(Descriptor newDescriptor) throws BadDescriptorException {
+		// Note: may also be reinitialized with the same descriptor
 		synchronized (activeServices) {
-			// Note: may also be reinitialized with the same descriptor
-			for (IDynamicLanguageService service : activeServices.keySet())
+			// Copy the list of services since reinitialize() might chage it
+			IDynamicLanguageService[] currentServices = activeServices.keySet().toArray(new IDynamicLanguageService[0]);
+			for (IDynamicLanguageService service : currentServices)
 				service.reinitialize(newDescriptor);
 			attachedFiles = null;
 			cachedServices.clear();



From L.C.L.Kats at tudelft.nl  Wed Mar 10 15:24:37 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 10 Mar 2010 14:24:37 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20701 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans
Message-ID: <201003101424.o2AEOb1q032434@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-10 14:24:37 +0000 (Wed, 10 Mar 2010)
New Revision: 20701

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20701&view=rev

Added:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str

Log:
missing file

Changes:

Added: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str	                        (rev 0)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str	2010-03-10 14:24:37 UTC (rev 20701)
@@ -0,0 +1,69 @@
+module analysis
+
+imports
+  libstratego-lib
+  libstratego-sdf
+  libstratego-sglr
+  lib/editor-common.generated
+
+strategies
+
+  analyze-ast:
+    (ast, path, project-path) -> ast'
+    with
+      current-file := $[[project-path]/[path]];
+      rules(
+        CurrentDir  := <dirname> $[[project-path]/[path]]
+        CurrentFile := <base-filename> path
+        IsImported  :  current-file
+        ProjectDir  := project-path
+      )
+    with
+      // TODO: sdf-desugar?
+      ast' := <declare-globals-top> ast
+  
+rules
+
+  declare-globals-top =
+    alltd(declare-globals)
+
+  declare-globals:
+    unparameterized(x) -> unparameterized(x)
+    where
+      <open-import(
+        resolve-import
+      , parse-file
+      , declare-globals-top
+      )> x
+
+  declare-globals:
+    parameterized(x, y) -> parameterized(x, y)
+    where
+      <declare-globals> unparameterized(x)
+  
+  resolve-import =
+    // TODO: better import handling
+    \x -> $[[<CurrentDir>]/[x].sdf]\; file-exists
+  <+
+    \x -> $[[<ProjectDir>]/syntax/[x].sdf]\; file-exists
+  <+
+    \x -> $[[<ProjectDir>]/lib/[x].def]\; file-exists
+  
+  declare-globals:
+    prod @ prod(_, sort, _) -> <id>
+    where
+      !sort => sort(x) <+ !sort => parametrized-sort(x, _)
+    with
+      <Declaration> x
+    <+
+      file := <CurrentFile>;
+      rules(
+        Declaration: x -> prod
+        DeclarationFile: x -> file
+      )
+  
+  propose-completion:
+    sort(COMPLETION(x)) -> <all-keys-Declaration> x
+  
+  propose-completion:
+    NOCONTEXT(COMPLETION(x)) -> <all-keys-Declaration> x



From L.C.L.Kats at tudelft.nl  Thu Mar 11 13:21:31 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 11 Mar 2010 12:21:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20702 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	strc-java/trunk/java strc-java/trunk/java/runtime/org/strategoxt
Message-ID: <201003111221.o2BCLVBd017928@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-11 12:21:31 +0000 (Thu, 11 Mar 2010)
New Revision: 20702

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20702&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicStrategoFeedback.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/VarScope.java
   strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java
   strc-java/trunk/java/spoofax-libs.jar

Log:
Added some uninitialization logic to really make sure hybridinterpreter instances are unloaded (diminishing the consequences of a possible memory leak).

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/VarScope.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/VarScope.java	2010-03-10 14:24:37 UTC (rev 20701)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/core/VarScope.java	2010-03-11 12:21:31 UTC (rev 20702)
@@ -138,6 +138,11 @@
         DebugUtil.debug(s);
     }
     
+    public void clear() {
+        vars.clear();
+        svars.clear();
+    }
+    
     public List<BindingInfo> saveUnboundVars() {
         return saveUnboundVars(new ArrayList<BindingInfo>());
     }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicStrategoFeedback.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicStrategoFeedback.java	2010-03-10 14:24:37 UTC (rev 20701)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/DynamicStrategoFeedback.java	2010-03-11 12:21:31 UTC (rev 20702)
@@ -22,5 +22,12 @@
 		initialize(parseController);
 		getWrapped().update(parseController, monitor);
 	}
+	
+	@Override
+	public void reinitialize(Descriptor newDescriptor) throws BadDescriptorException {
+		if (isInitialized())
+			getWrapped().uninitialize();
+		super.reinitialize(newDescriptor);
+	}
 
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-10 14:24:37 UTC (rev 20701)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-11 12:21:31 UTC (rev 20702)
@@ -128,7 +128,7 @@
 		return ((EditorIOAgent) runtime.getIOAgent()).getLog().trim();
 	}
 	
-	private void init(IProgressMonitor monitor) {
+	private void initialize(IProgressMonitor monitor) {
 		assert Thread.holdsLock(getSyncRoot());
 		
 		HybridInterpreter prototype = cachedRuntimes.get(descriptor);
@@ -161,6 +161,19 @@
 		monitor.subTask(null);
 		cachedRuntimes.put(descriptor, runtime);
 	}
+	
+	/**
+	 * Uninitializes the observer and its descriptor runtime.
+	 */
+	public void uninitialize() {
+		HybridInterpreter cachedRuntime = cachedRuntimes.remove(descriptor);
+		if (cachedRuntime != null) {
+			cachedRuntime.uninit();
+		} else if (runtime != null) {
+			runtime.uninit();
+			runtime = null;
+		}
+	}
 
 	private void initRuntime(IProgressMonitor monitor) {
 		assert Thread.holdsLock(getSyncRoot());
@@ -473,7 +486,7 @@
 			throws UndefinedStrategyException, InterpreterErrorExit, InterpreterExit, InterpreterException {
 		
 		synchronized (getSyncRoot()) {
-			if (runtime == null) init(new NullProgressMonitor());
+			if (runtime == null) initialize(new NullProgressMonitor());
 			if (runtime == null) return null;
 			
 		    Debug.startTimer();
@@ -572,7 +585,7 @@
 	
 	public HybridInterpreter getRuntime() {
 		assert Thread.holdsLock(getSyncRoot());
-		if (runtime == null) init(new NullProgressMonitor());
+		if (runtime == null) initialize(new NullProgressMonitor());
 		if (runtime == null) initRuntime(new NullProgressMonitor()); // create empty runtime
 		return runtime;
 	}

Modified: strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java	2010-03-10 14:24:37 UTC (rev 20701)
+++ strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java	2010-03-11 12:21:31 UTC (rev 20702)
@@ -269,6 +269,15 @@
 			registerLibraries();
 		}
 	}
+
+	/**
+	 * Uninitializes the interpreter, making a best-effort attempt
+	 * at releasing any resources associated with it.
+	 */
+	public void uninit() {
+		loadedJars = false;
+		getContext().getVarScope().clear();
+	}
 	
 	/**
 	 * Initialize the interpreter register with all standard library strategies.

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Thu Mar 11 17:21:23 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 11 Mar 2010 16:21:23 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20703 - LennartKats -
	in strc-java/trunk/java: . runtime/org/strategoxt/lang/terms
Message-ID: <201003111621.o2BGLNwt021033@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-11 16:21:22 +0000 (Thu, 11 Mar 2010)
New Revision: 20703

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20703&view=rev

Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
   strc-java/trunk/java/spoofax-libs.jar

Log:
Thread synchronization fix.

Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-11 12:21:31 UTC (rev 20702)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-11 16:21:22 UTC (rev 20703)
@@ -51,7 +51,7 @@
     
     @Override
     public boolean hasConstructor(String name, int arity) {
-        synchronized (this) {
+        synchronized (TermFactory.class) {
         	if (arity == 0) {
             	if (asyncStringPool.containsKey(name)) {
             		return true;
@@ -96,7 +96,7 @@
     @Override
     public StrategoConstructor makeConstructor(String name, int arity) {
         StrategoConstructor result = new StrategoConstructor(name, arity);
-        synchronized (this) {
+        synchronized (TermFactory.class) {
 	        StrategoConstructor cached = asyncCtorCache.get(result);
 	        if (cached == null) {
 	            asyncCtorCache.put(result, result);

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Thu Mar 11 17:22:28 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Thu, 11 Mar 2010 16:22:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20704 - LennartKats -
	in strc-java/trunk/java: . runtime/org/strategoxt/lang/terms
Message-ID: <201003111622.o2BGMSJM021041@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-11 16:22:28 +0000 (Thu, 11 Mar 2010)
New Revision: 20704

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20704&view=rev

Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
   strc-java/trunk/java/spoofax-libs.jar

Log:
Thread synchronization fix.

Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-11 16:21:22 UTC (rev 20703)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-11 16:22:28 UTC (rev 20704)
@@ -159,7 +159,7 @@
     	if (s.length() > MAX_POOLED_STRING_LENGTH)
     		return new StrategoString(s, null, MY_STORAGE_TYPE);
     	
-    	synchronized (this) {
+    	synchronized (TermFactory.class) {
 	    	StrategoString result = asyncStringPool.get(s);
 	    	if (result == null) {
 	        	result = new StrategoString(s, null, MAXIMALLY_SHARED);

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From R.B.Vermaas at tudelft.nl  Fri Mar 12 08:55:16 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 12 Mar 2010 07:55:16 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20705 - rob -
	hydra/webdsl
Message-ID: <201003120755.o2C7tGQt001563@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-12 07:55:16 +0000 (Fri, 12 Mar 2010)
New Revision: 20705

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20705&view=rev

Modified:
   hydra/webdsl/tests.nix

Log:
use ANT_LOGGER to override webdsl logger

Changes:

Modified: hydra/webdsl/tests.nix
===================================================================
--- hydra/webdsl/tests.nix	2010-03-11 16:22:28 UTC (rev 20704)
+++ hydra/webdsl/tests.nix	2010-03-12 07:55:16 UTC (rev 20705)
@@ -29,7 +29,8 @@
       buildCommand = ''
         ensureDir $out/nix-support        
         ulimit -s unlimited 
-        export ANT_ARGS="-logger org.hydra.ant.HydraLogger -lib `ls ${pkgs.hydraAntLogger}/lib/java/*.jar | head -1`"
+        export ANT_ARGS="-lib `ls ${pkgs.hydraAntLogger}/lib/java/*.jar | head -1`"
+        export ANT_LOGGER="org.hydra.ant.HydraLogger"
 
         header "Copying sources"        
         cp -vR ${src}/* .



From L.C.L.Kats at tudelft.nl  Fri Mar 12 12:32:14 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 12 Mar 2010 11:32:14 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20706 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project
Message-ID: <201003121132.o2CBWElA005345@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-12 11:32:14 +0000 (Fri, 12 Mar 2010)
New Revision: 20706

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20706&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-12 07:55:16 UTC (rev 20705)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-12 11:32:14 UTC (rev 20706)
@@ -215,6 +215,12 @@
     | <import-term(include/{sdf-name}.tbl)>
     )
   
+  parse-stream =
+    parse-stream(
+      strsglr-report-parse-error
+    | <import-term(include/{sdf-name}.tbl)>
+    )
+
 strategies
   
   /**



From L.C.L.Kats at tudelft.nl  Fri Mar 12 12:58:15 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 12 Mar 2010 11:58:15 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20707 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.nativebundle/native/cygwin
	org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle
	org.strategoxt.imp.updatesite
Message-ID: <201003121158.o2CBwFx8005544@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-12 11:58:15 +0000 (Fri, 12 Mar 2010)
New Revision: 20707

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20707&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/native/cygwin/cygwin1.dll
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
0.4.1 release: new Windows 7 compatible cygwin

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-12 11:32:14 UTC (rev 20706)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-12 11:58:15 UTC (rev 20707)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.0"
+      version="0.4.1"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/native/cygwin/cygwin1.dll
===================================================================
(Binary files differ)

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 11:32:14 UTC (rev 20706)
+++ spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 11:58:15 UTC (rev 20707)
@@ -9,6 +9,8 @@
 import java.io.Writer;
 import java.net.URL;
 import java.util.Arrays;
+import java.util.Map;
+import java.util.Map.Entry;
 
 import org.eclipse.core.runtime.FileLocator;
 import org.eclipse.core.runtime.Platform;
@@ -145,8 +147,12 @@
 			Writer out = io.getWriter(IOAgent.CONST_STDOUT);
 			Writer err = io.getWriter(IOAgent.CONST_STDERR);
 
+			String[] environment = Platform.getOS() == Platform.OS_WIN32
+				? createWindowsEnvironment()
+				: null;
+			
 			err.write("Invoking native tool " + binaryPath + command + binaryExtension + " " + Arrays.toString(argList) + "\n");
-			int result = new NativeCallHelper().call(commandArgs, null, new File(io.getWorkingDir()), out, err);
+			int result = new NativeCallHelper().call(commandArgs, environment, new File(io.getWorkingDir()), out, err);
 			if (result != 0) {
 				Environment.logException("Native tool " + command
 						+ " exited with error code " + result
@@ -167,6 +173,17 @@
 		}
 	}
 	
+	private String[] createWindowsEnvironment() {
+		Map<String, String> envp = System.getenv();
+		envp.put("nodosfilewarning", "1");
+		String[] env = new String[envp.size()];
+		int i = 0;
+		for (Entry<String, String> entry : envp.entrySet()) {
+			env[i++] = entry.getKey() + "=" + entry.getValue();
+		}
+		return env;
+	}
+
 	private boolean makeExecutable(IOAgent io, String command) {
 		try {
 			Writer out = io.getWriter(IOAgent.CONST_STDOUT);

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-12 11:32:14 UTC (rev 20706)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-12 11:58:15 UTC (rev 20707)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.0.jar" id="org.strategoxt.imp" version="0.4.0">
+   <feature url="features/org.strategoxt.imp_0.4.1.jar" id="org.strategoxt.imp" version="0.4.1">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Fri Mar 12 14:03:20 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 12 Mar 2010 13:03:20 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20708 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.generator
	org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle
	org.strategoxt.imp.runtime
Message-ID: <201003121303.o2CD3KQI006485@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-12 13:03:20 +0000 (Fri, 12 Mar 2010)
New Revision: 20708

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20708&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/build.properties
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/plugin.xml

Log:
- Fixed missing aster.jar
- Fixed control-alt-B shortcut not working on Windows

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/build.properties
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/build.properties	2010-03-12 11:58:15 UTC (rev 20707)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/build.properties	2010-03-12 13:03:20 UTC (rev 20708)
@@ -4,6 +4,7 @@
 bin.includes = META-INF/,\
                includes,\
                lib/make_permissive.jar,\
-               lib/sdf2imp.jar
+               lib/sdf2imp.jar,\
+               lib/aster.jar
 src.includes = src/,\
                lib/

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 11:58:15 UTC (rev 20707)
+++ spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 13:03:20 UTC (rev 20708)
@@ -140,16 +140,15 @@
 
 	private boolean invoke(Context context, String command, IStrategoTerm[] argList) {
 		String[] commandArgs = SSL_EXT_call.toCommandArgs(binaryPath + command, argList);
+		String[] environment = Platform.getOS() == Platform.OS_WIN32
+			? createWindowsEnvironment()
+			: null;
 		IOAgent io = context.getIOAgent();
 		
 		try {
 			if (commandArgs == null) return false;
 			Writer out = io.getWriter(IOAgent.CONST_STDOUT);
 			Writer err = io.getWriter(IOAgent.CONST_STDERR);
-
-			String[] environment = Platform.getOS() == Platform.OS_WIN32
-				? createWindowsEnvironment()
-				: null;
 			
 			err.write("Invoking native tool " + binaryPath + command + binaryExtension + " " + Arrays.toString(argList) + "\n");
 			int result = new NativeCallHelper().call(commandArgs, environment, new File(io.getWorkingDir()), out, err);
@@ -157,31 +156,34 @@
 				Environment.logException("Native tool " + command
 						+ " exited with error code " + result
 						+ "\nCommand:\n  " + Arrays.toString(commandArgs)
+						+ "\nEnvironment:\n " + Arrays.toString(environment)
 						+ "\nWorking dir:\n  " + io.getWorkingDir());
 			}
 			return result == 0;
 		} catch (IOException e) {
 			throw new StrategoException("Could not call native tool " + command
 					+ "\nCommand:\n  " + Arrays.toString(commandArgs)
+					+ "\nEnvironment:\n " + Arrays.toString(environment)
 					+ "\nWorking dir:\n  " + io.getWorkingDir(), e);
 		} catch (InterruptedException e) {
 			throw new StrategoException("Could not call " + command, e);
 		} catch (RuntimeException e) {
 			throw new StrategoException("Could not call native tool " + command
 					+ "\nCommand:\n  " + Arrays.toString(commandArgs)
+					+ "\nEnvironment:\n " + Arrays.toString(environment)
 					+ "\nWorking dir:\n  " + io.getWorkingDir(), e);
 		}
 	}
 	
 	private String[] createWindowsEnvironment() {
 		Map<String, String> envp = System.getenv();
-		envp.put("nodosfilewarning", "1");
-		String[] env = new String[envp.size()];
+		envp.put("CYGWIN", "nodosfilewarning");
+		String[] result = new String[envp.size()];
 		int i = 0;
 		for (Entry<String, String> entry : envp.entrySet()) {
-			env[i++] = entry.getKey() + "=" + entry.getValue();
+			result[i++] = entry.getKey() + "=" + entry.getValue();
 		}
-		return env;
+		return result;
 	}
 
 	private boolean makeExecutable(IOAgent io, String command) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/plugin.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/plugin.xml	2010-03-12 11:58:15 UTC (rev 20707)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/plugin.xml	2010-03-12 13:03:20 UTC (rev 20708)
@@ -284,11 +284,6 @@
             sequence="M1+M3+B"
             schemeId="org.eclipse.ui.defaultAcceleratorConfiguration" />
       <key
-            commandId="org.eclipse.ui.project.buildProject"
-            contextId="org.eclipse.ui.contexts.window"
-            sequence="CTRL+ALT+B"
-            schemeId="org.eclipse.ui.defaultAcceleratorConfiguration" />
-      <key
             commandId="org.strategoxt.imp.runtime.resolveReferenceCommand"
             contextId="org.eclipse.ui.textEditorScope"
             schemeId="org.eclipse.ui.defaultAcceleratorConfiguration"



From L.C.L.Kats at tudelft.nl  Fri Mar 12 14:11:08 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 12 Mar 2010 13:11:08 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20709 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle
Message-ID: <201003121311.o2CDB8hY006580@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-12 13:11:08 +0000 (Fri, 12 Mar 2010)
New Revision: 20709

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20709&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java

Log:
Another attempt to get nodosfilewarning working.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 13:03:20 UTC (rev 20708)
+++ spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 13:11:08 UTC (rev 20709)
@@ -9,6 +9,7 @@
 import java.io.Writer;
 import java.net.URL;
 import java.util.Arrays;
+import java.util.HashMap;
 import java.util.Map;
 import java.util.Map.Entry;
 
@@ -176,7 +177,7 @@
 	}
 	
 	private String[] createWindowsEnvironment() {
-		Map<String, String> envp = System.getenv();
+		Map<String, String> envp = new HashMap<String, String>(System.getenv());
 		envp.put("CYGWIN", "nodosfilewarning");
 		String[] result = new String[envp.size()];
 		int i = 0;



From L.C.L.Kats at tudelft.nl  Fri Mar 12 14:32:46 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 12 Mar 2010 13:32:46 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20710 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle
Message-ID: <201003121332.o2CDWk2R006734@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-12 13:32:46 +0000 (Fri, 12 Mar 2010)
New Revision: 20710

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20710&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 13:11:08 UTC (rev 20709)
+++ spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-12 13:32:46 UTC (rev 20710)
@@ -141,9 +141,11 @@
 
 	private boolean invoke(Context context, String command, IStrategoTerm[] argList) {
 		String[] commandArgs = SSL_EXT_call.toCommandArgs(binaryPath + command, argList);
-		String[] environment = Platform.getOS() == Platform.OS_WIN32
-			? createWindowsEnvironment()
-			: null;
+		// Disabled this check since Windows x64 might identify differently?
+		//String[] environment = Platform.getOS() == Platform.OS_WIN32
+		//	? createWindowsEnvironment()
+		//	: null;
+		String[] environment = createWindowsEnvironment();
 		IOAgent io = context.getIOAgent();
 		
 		try {



From L.C.L.Kats at tudelft.nl  Fri Mar 12 16:29:41 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Fri, 12 Mar 2010 15:29:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20711 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast
Message-ID: <201003121529.o2CFTfJN008152@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-12 15:29:41 +0000 (Fri, 12 Mar 2010)
New Revision: 20711

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20711&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java

Log:
Added a small hackfix for Spoofax/49.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java	2010-03-12 13:32:46 UTC (rev 20710)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java	2010-03-12 15:29:41 UTC (rev 20711)
@@ -6,6 +6,7 @@
 import org.eclipse.core.runtime.IPath;
 import org.eclipse.imp.editor.ModelTreeNode;
 import org.eclipse.imp.parser.ISourcePositionLocator;
+import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.SGLRParseController;
 import org.strategoxt.imp.runtime.parser.tokens.SGLRToken;
 import org.strategoxt.imp.runtime.stratego.adapter.IStrategoAstNode;
@@ -54,10 +55,17 @@
 			node = impObjectToAstNode(element);
 			token = (SGLRToken) node.getLeftIToken();
 		}
-		// Should return -1 if not using the same controller, per HyperLinkDetector
-		return node == null || node.getParseController() == controller
+		
+		try {
+			// Should return -1 if not using the same controller, per HyperLinkDetector
+			return node == null || node.getParseController() == controller
 				? token.getStartOffset()
 				: -1;
+		} catch (IllegalStateException e) {
+			// HACK: avoid this exception here (Spoofax/49)
+			Environment.logException("Could not determine parse controller", e);
+			return token.getStartOffset();
+		}
 	}
 
 	public int getEndOffset(Object element) {



From L.C.L.Kats at tudelft.nl  Mon Mar 15 09:34:49 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 15 Mar 2010 08:34:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20712 - LennartKats -
	strc-java/trunk/trans
Message-ID: <201003150834.o2F8YnL2003511@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-15 08:34:49 +0000 (Mon, 15 Mar 2010)
New Revision: 20712

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20712&view=rev

Modified:
   strc-java/trunk/trans/strj-options.str

Log:
Sanity check: main.java is a bad output file name

Changes:

Modified: strc-java/trunk/trans/strj-options.str
===================================================================
--- strc-java/trunk/trans/strj-options.str	2010-03-12 15:29:41 UTC (rev 20711)
+++ strc-java/trunk/trans/strj-options.str	2010-03-15 08:34:49 UTC (rev 20712)
@@ -39,6 +39,9 @@
       <get-config> "-o"
     ; fatal-err(|"Output file name is not a legal Java name")
     end
+  ; if <get-config> "-o"; base-filename => "main.java" then
+      fatal-err(|"Output file name 'main' is not allowed as it causes problems on case-insensitive file systems; use 'Main' instead")
+    end
   ; if <get-config> "--library"; not(<get-config> "-p" + <get-config> "-F") then
       fatal-err-msg(|"No package name specified")
     end



From R.B.Vermaas at tudelft.nl  Wed Mar 24 11:31:18 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Wed, 24 Mar 2010 10:31:18 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20713 - rob - in
	sql-front/trunk: syn/languages/sql92/expressions test/syn
Message-ID: <201003241131.o2OBVIpZ008964@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-24 10:31:18 +0000 (Wed, 24 Mar 2010)
New Revision: 20713

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20713&view=rev

Added:
   sql-front/trunk/test/syn/test-23.sql
Modified:
   sql-front/trunk/syn/languages/sql92/expressions/Conditional.sdf
   sql-front/trunk/test/syn/query-expr.testsuite

Log:
SQLFront/3 : Bug in BETWEEN syntax

Changes:

Modified: sql-front/trunk/syn/languages/sql92/expressions/Conditional.sdf
===================================================================
--- sql-front/trunk/syn/languages/sql92/expressions/Conditional.sdf	2010-03-15 08:34:49 UTC (rev 20712)
+++ sql-front/trunk/syn/languages/sql92/expressions/Conditional.sdf	2010-03-24 10:31:18 UTC (rev 20713)
@@ -22,7 +22,7 @@
    %%%
   context-free syntax
     RowConstructor CompOp RowConstructor -> CondExpr {cons("Comparison")}
-    RowConstructor Not? "BETWEEN" RowConstructor -> CondExpr {cons("Between")}
+    RowConstructor Not? "BETWEEN" RowConstructor "AND" RowConstructor -> CondExpr {cons("Between")}
     RowConstructor Not? "IN" "(" InPredVal ")" -> CondExpr {cons("In")}
     "NOT" -> Not {cons("Not")}
     QueryExpr       -> InPredVal

Modified: sql-front/trunk/test/syn/query-expr.testsuite
===================================================================
--- sql-front/trunk/test/syn/query-expr.testsuite	2010-03-15 08:34:49 UTC (rev 20712)
+++ sql-front/trunk/test/syn/query-expr.testsuite	2010-03-24 10:31:18 UTC (rev 20713)
@@ -70,3 +70,6 @@
 
 test Omit AS keyword
   file test-22.sql succeeds
+
+test BETWEEN 
+  file test-23.sql succeeds

Added: sql-front/trunk/test/syn/test-23.sql
===================================================================
--- sql-front/trunk/test/syn/test-23.sql	                        (rev 0)
+++ sql-front/trunk/test/syn/test-23.sql	2010-03-24 10:31:18 UTC (rev 20713)
@@ -0,0 +1,5 @@
+SELECT
+  a.ad_id a_ad_id,
+  a.category_id a_category_id
+FROM ads a, categories c, members m
+WHERE c.date BETWEEN m.from AND m.to



From L.C.L.Kats at tudelft.nl  Wed Mar 24 16:13:32 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 24 Mar 2010 15:13:32 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20714 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.feature
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.generator/src/sdf2imp/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast
	org.strategoxt.imp.updatesite
Message-ID: <201003241613.o2OGDWEm013125@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-24 15:13:32 +0000 (Wed, 24 Mar 2010)
New Revision: 20714

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20714&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixImploder.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-24 15:13:32 UTC (rev 20714)
@@ -18,6 +18,12 @@
     | <import-term(include/Stratego-Sugar.tbl)>
     )
   
+  parse-stream =
+    parse-stream(
+      strsglr-report-parse-error
+    | <import-term(include/Stratego-Sugar.tbl)>
+    )
+
 strategies
   
   /**

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-24 15:13:32 UTC (rev 20714)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.1"
+      version="0.4.1.1"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-24 15:13:32 UTC (rev 20714)
@@ -120,7 +120,7 @@
           return [x];
       $}$
       
-      public [t] set_[x] ([t] [x]) ${$
+      public void set_[x] ([t] [x]) ${$
           this.[x] = [x];    
       $}$
   ]
@@ -280,11 +280,13 @@
   import-cache-path:
     full-path -> cache-path
     with
-      project-path := <prim("SSL_EXT_projectpath")>;
+      project-path := <project-path>;
       cache-dir    := <file-exists <+ mkdir> $[[project-path]/.cache];
       full-path'   := <string-replace(|"/", "+"); string-replace(|"{"\\\\"}", "+"); string-replace(|":", "+")> full-path;
       cache-path   := $[[cache-dir]/[full-path'].sig]
 
+  project-path = prim("SSL_EXT_projectpath")
+
   is-newer:
     (file1, file2) -> <id>
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-24 15:13:32 UTC (rev 20714)
@@ -49,5 +49,5 @@
         ~~
         extensions: ~extensions
         table:  ~parsetable
-        start symbols: ~*startsymbols
+        start symbols: ~*startsymbols TODO: can I just comment these out?
     ]|

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixImploder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixImploder.java	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AsfixImploder.java	2010-03-24 15:13:32 UTC (rev 20714)
@@ -100,7 +100,8 @@
 		
 		if (Debug.ENABLED) {
 			Debug.stopTimer("Parse tree imploded");
-			Debug.log("Parsed " + result.toString());
+			// Disabled; printing big trees causes delays
+			// Debug.log("Parsed " + result.toString());
 		}
 		
 		tokenizer.setCachedAst(result);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstAnnoImploder.java	2010-03-24 15:13:32 UTC (rev 20714)
@@ -110,6 +110,7 @@
 	}
 	
 	private AstNode listToAstNode(ATerm term, String sort) {
+		// TODO: Fishy (Spoofax/49)
 		ATermList list = (ATermList) term;
 		ArrayList<AstNode> children = new ArrayList<AstNode>(list.getChildCount());
 		for (int i = 0; i < term.getChildCount(); i++) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-24 10:31:18 UTC (rev 20713)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-24 15:13:32 UTC (rev 20714)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.1.jar" id="org.strategoxt.imp" version="0.4.1">
+   <feature url="features/org.strategoxt.imp_0.4.1.1.jar" id="org.strategoxt.imp" version="0.4.1.1">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar 24 16:14:01 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 24 Mar 2010 15:14:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20715 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building
Message-ID: <201003241614.o2OGE1a7013132@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-24 15:14:01 +0000 (Wed, 24 Mar 2010)
New Revision: 20715

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20715&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/DynamicDescriptorBuilder.java

Log:
Added a work-around for an issue reported by Guido where build.generated.xml was not checked into subversion.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/DynamicDescriptorBuilder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/DynamicDescriptorBuilder.java	2010-03-24 15:13:32 UTC (rev 20714)
+++ spoofax-imp/trunk/org.strategoxt.imp.metatooling/src/org/strategoxt/imp/metatooling/building/DynamicDescriptorBuilder.java	2010-03-24 15:14:01 UTC (rev 20715)
@@ -239,8 +239,8 @@
 		
 		IResource includeDir = project.findMember("include");
 		IResource editorDir = project.findMember("editor");
-		IResource buildFile = project.findMember("build.generated.xml");
-		IResource editorCommonFile = project.findMember("lib/build.generated.xml");
+		// IResource buildFile = project.findMember("build.generated.xml");
+		// IResource editorCommonFile = project.findMember("lib/editor-common.generated.str");
 		IResource cacheDir = project.findMember(".cache");
 
 		if (!(includeDir instanceof IContainer && editorDir instanceof IContainer))
@@ -255,12 +255,12 @@
 				if (member.getName().endsWith(".generated.esv"))
 					member.setDerived(true);
 			}
-			if (buildFile != null)
-				buildFile.setDerived(true);
+			//if (buildFile != null)
+			//	buildFile.setDerived(true);
 		}
 		
 		if (cacheDir != null && cacheDir.exists()) cacheDir.setDerived(true);
-		if (editorCommonFile != null && editorCommonFile.exists()) editorCommonFile.setDerived(true);
+		//if (editorCommonFile != null && editorCommonFile.exists()) editorCommonFile.setDerived(true);
 	}
 	
 	public IResource getTargetDescriptor(IResource mainDescriptor) {



From R.B.Vermaas at tudelft.nl  Fri Mar 26 12:47:31 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 26 Mar 2010 11:47:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20716 - rob -
	aspectj-front/trunk/lib/aspectj/pp
Message-ID: <201003261247.o2QClVGs016375@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-26 11:47:31 +0000 (Fri, 26 Mar 2010)
New Revision: 20716

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20716&view=rev

Modified:
   aspectj-front/trunk/lib/aspectj/pp/Main.str

Log:
AspectJFront/33 : add call to generated parenthesize strategy

Changes:

Modified: aspectj-front/trunk/lib/aspectj/pp/Main.str
===================================================================
--- aspectj-front/trunk/lib/aspectj/pp/Main.str	2010-03-24 15:14:01 UTC (rev 20715)
+++ aspectj-front/trunk/lib/aspectj/pp/Main.str	2010-03-26 11:47:31 UTC (rev 20716)
@@ -18,11 +18,13 @@
   aspectj/pp/pattern/Type
   aspectj/pp/pointcut/Declaration
   aspectj/pp/pointcut/Expression
+  aspectj/parenthesize
 
 strategies
 
   pp-aspectj-box =
-    pp-java5-to-abox(aspectj-to-box <+ java-to-box)
+    parenthesize-aspectj
+  ; pp-java5-to-abox(aspectj-to-box <+ java-to-box)
 
 strategies
 
@@ -30,4 +32,4 @@
     ?Some(<id>); ![<id>] <+ ?None(); ![]
 
 //  aspectj-to-box =
- //   aspectj-to-nice-box <+ aspectj-to-ugly-box
\ No newline at end of file
+ //   aspectj-to-nice-box <+ aspectj-to-ugly-box



From R.B.Vermaas at tudelft.nl  Fri Mar 26 13:05:22 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 26 Mar 2010 12:05:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20717 - rob -
	hydra/strategoxt
Message-ID: <201003261305.o2QD5MlX016729@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-26 12:05:22 +0000 (Fri, 26 Mar 2010)
New Revision: 20717

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20717&view=rev

Modified:
   hydra/strategoxt/packages.nix

Log:


Changes:

Modified: hydra/strategoxt/packages.nix
===================================================================
--- hydra/strategoxt/packages.nix	2010-03-26 11:47:31 UTC (rev 20716)
+++ hydra/strategoxt/packages.nix	2010-03-26 12:05:22 UTC (rev 20717)
@@ -679,13 +679,13 @@
        * On MinGW we don't want to depend on Stratego/XT.
        */
       requires =
-        if (isMinGW pkgs) || (isCygwin pkgs) then [javaFront strategoLibraries aterm] else svnRequires;
+        if (isMinGW pkgs) then [javaFront strategoLibraries aterm] else svnRequires;
 
       /**
        * On MinGW we disable xtc to avoid a dependency on Stratego/XT.
        */
       configureFlags =
-        if (isMinGW pkgs) || (isCygwin pkgs) then null else ["--enable-bootstrap"];
+        if (isMinGW pkgs) then null else ["--enable-bootstrap"];
 
       /**
        * On Cygwin using -g prints a lot warnings (STR-556)



From R.B.Vermaas at tudelft.nl  Fri Mar 26 16:06:31 2010
From: R.B.Vermaas at tudelft.nl (Rob Vermaas)
Date: Fri, 26 Mar 2010 15:06:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20718 - rob - hydra
Message-ID: <201003261606.o2QG6VaV019318@proliant.st.ewi.tudelft.nl>

Author: rob
Date: 2010-03-26 15:06:30 +0000 (Fri, 26 Mar 2010)
New Revision: 20718

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20718&view=rev

Modified:
   hydra/job.nix

Log:
job.nix: add tarball to build job function

Changes:

Modified: hydra/job.nix
===================================================================
--- hydra/job.nix	2010-03-26 12:05:22 UTC (rev 20717)
+++ hydra/job.nix	2010-03-26 15:06:30 UTC (rev 20718)
@@ -11,8 +11,7 @@
 
   jobs = rec {
     tarball = tarballTop ;
-    build   = { system ? "i686-linux"}: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball tarball sysPkgs (spec sysPkgs) ;
-    release = builder.easyReleaseNix pkgsDebRPM spec tarball ;
+    build   = { system ? "i686-linux", tarball ? jobs.tarball }: let sysPkgs = systemPkgs system ; in builder.easyNixBuildFromTarball tarball sysPkgs (spec sysPkgs) ;
   } // builder.debs pkgsDebRPM spec tarballTop
     // builder.rpms pkgsDebRPM spec tarballTop
     // builder.makeDocsJob pkgsDebRPM spec



From L.C.L.Kats at tudelft.nl  Mon Mar 29 10:38:33 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 08:38:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20719 - LennartKats - in
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library:
	. ssl
Message-ID: <201003290938.o2T9cXhI010254@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 08:38:33 +0000 (Mon, 29 Mar 2010)
New Revision: 20719

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20719&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_newname.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_read_term_from_stream.java

Log:


Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2010-03-26 15:06:30 UTC (rev 20718)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/IOAgent.java	2010-03-29 08:38:33 UTC (rev 20719)
@@ -220,6 +220,19 @@
             return file.inputStream;
         }
     }
+
+    /**
+     * Gets the file channel for a file descriptor.
+     * Should only be used for reading data
+     * (since inheritor classes may depend on logging writes).
+     */
+    public FileChannel getInputChannel(int fd) {
+        if (fd == CONST_STDIN || fd == CONST_STDOUT || fd == CONST_STDERR) {
+            throw new UnsupportedOperationException();
+        } else {
+            return openFiles.get(fd).file.getChannel();
+        }
+    }
     
     public Reader getReader(int fd) {
         if (fd == CONST_STDIN)

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_newname.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_newname.java	2010-03-26 15:06:30 UTC (rev 20718)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_newname.java	2010-03-29 08:38:33 UTC (rev 20719)
@@ -1,7 +1,10 @@
 package org.spoofax.interpreter.library.ssl;
 
-import java.util.WeakHashMap;
+import static org.spoofax.interpreter.core.Tools.isTermAppl;
 
+import java.util.HashMap;
+import java.util.concurrent.atomic.AtomicInteger;
+
 import org.spoofax.interpreter.core.IContext;
 import org.spoofax.interpreter.core.InterpreterException;
 import org.spoofax.interpreter.core.Tools;
@@ -13,7 +16,9 @@
 
 public class SSL_newname extends AbstractPrimitive {
 	
-    private WeakHashMap<String, Integer> counters = new WeakHashMap<String, Integer>();
+    // static, like TermFactory.asyncStringPool
+    private static HashMap<String, AtomicInteger> asyncCounters =
+        new HashMap<String, AtomicInteger>();
 	
 	SSL_newname () {
 		super("SSL_newname", 0, 1);
@@ -27,22 +32,31 @@
 
 	    if (Tools.isTermString(tvars[0])) {
 	        prefix = ((IStrategoString) tvars[0]).stringValue();
-	    } else {
+	    } else if (isTermAppl(tvars[0])) {
 	        SSLLibrary library = (SSLLibrary) env.getOperatorRegistry(SSLLibrary.REGISTRY_NAME);
 	        library.get("SSL_get_constructor").call(env, svars, tvars);
 	        prefix = ((IStrategoString) env.current()).stringValue();
+	    } else {
+	        SSLLibrary library = (SSLLibrary) env.getOperatorRegistry(SSLLibrary.REGISTRY_NAME);
+            return library.get("SSL_new").call(env, svars, tvars);
 	    }
-        
+
         ITermFactory factory = env.getFactory();
-	    Integer oldCounter = counters.get(prefix);
-	    int counter = oldCounter == null ? 0 : oldCounter;
+	    AtomicInteger counter;
 	    
+	    synchronized (asyncCounters) {
+	        counter = asyncCounters.get(prefix);
+	        if (counter == null) {
+	            counter = new AtomicInteger();
+	            asyncCounters.put(prefix, counter);
+	        }
+	    }
+	    
         String result;
         do {
-        	result = prefix + counter++;
+        	result = prefix + counter.getAndIncrement();
         } while (factory.hasConstructor(result, 0));
 
-        counters.put(prefix, counter);
         env.setCurrent(factory.makeString(result));
         
 		return true;

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_read_term_from_stream.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_read_term_from_stream.java	2010-03-26 15:06:30 UTC (rev 20718)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/SSL_read_term_from_stream.java	2010-03-29 08:38:33 UTC (rev 20719)
@@ -31,6 +31,13 @@
             return false;
         
         // TODO: optimize - use memory-mapped I/O for reading terms?
+        //       PushBackInputStream.read() is very inefficient;
+        //       why not create our own implementation based on memory-mapped I/O?
+        //
+        // UNDONE: tricky: detecting if it's a BAF term in TermFactory...
+        //
+        // FileChannel channel = or.getIOAgent().getInputChannel(Tools.asJavaInt(tvars[0]));
+        // ChannelPushbackInputStream reader = new ChannelPushbackInputStream(channel);
         SSLLibrary or = (SSLLibrary) env.getOperatorRegistry(SSLLibrary.REGISTRY_NAME);
         InputStream is = or.getIOAgent().getInputStream(Tools.asJavaInt(tvars[0]));
         if(is == null)



From L.C.L.Kats at tudelft.nl  Mon Mar 29 10:50:58 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 08:50:58 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20720 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle
Message-ID: <201003290950.o2T9ow9q010345@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 08:50:58 +0000 (Mon, 29 Mar 2010)
New Revision: 20720

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20720&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java

Log:
Spoofax/48: added a SPOOFAX_NATIVE_PATH environment variable to override the native executable path

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-29 08:38:33 UTC (rev 20719)
+++ spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-29 08:50:58 UTC (rev 20720)
@@ -65,6 +65,9 @@
 	}
 	
 	public String getBinaryPath() throws IOException, UnsupportedOperationException {
+		if (System.getenv("SPOOFAX_NATIVE_PATH") != null)
+			return System.getenv("SPOOFAX_NATIVE_PATH");
+		
 		String os = Platform.getOS();
 		String subdir;
 		if (os.equals(Platform.OS_LINUX)) {



From L.C.L.Kats at tudelft.nl  Mon Mar 29 11:45:39 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 09:45:39 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20721 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl
Message-ID: <201003291045.o2TAjdJT011223@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 09:45:39 +0000 (Mon, 29 Mar 2010)
New Revision: 20721

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20721&view=rev

Added:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/ChannelPushbackInputStream.java

Log:
Added a tentative ChannelPushbackInputStream implementation

Changes:

Added: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/ChannelPushbackInputStream.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/ChannelPushbackInputStream.java	                        (rev 0)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/library/ssl/ChannelPushbackInputStream.java	2010-03-29 09:45:39 UTC (rev 20721)
@@ -0,0 +1,100 @@
+/**
+ * 
+ */
+package org.spoofax.interpreter.library.ssl;
+
+import static java.lang.Math.min;
+
+import java.io.IOException;
+import java.io.PushbackInputStream;
+import java.nio.ByteBuffer;
+import java.nio.channels.FileChannel;
+
+/**
+ * Channel-based PushbackInputStream implementation.
+ * 
+ * @deprecated completely untested
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class ChannelPushbackInputStream extends PushbackInputStream {
+    
+    private static final int BUFFER_SIZE = 512;
+    
+    private final FileChannel channel;
+    
+    private final ByteBuffer buffer;
+    
+    private final byte[] pushbackStack;
+    
+    private int pushbackSize = 0;
+
+    public ChannelPushbackInputStream(FileChannel channel, int bufferSize) {
+        super(null);
+        this.channel = channel;
+        buffer = ByteBuffer.allocateDirect(BUFFER_SIZE);
+        pushbackStack = new byte[bufferSize];
+    }
+    
+    public ChannelPushbackInputStream(FileChannel channel) {
+        this(channel, 1);
+    }
+    
+    @Override
+    public int read() throws IOException {
+        if (pushbackSize > 0) 
+            return pushbackStack[--pushbackSize];
+        if (buffer.hasRemaining()) {
+            return buffer.get();
+        } else {
+            if (channel.read(buffer) == -1)
+                return -1;
+            buffer.rewind();
+            return buffer.get();
+        }
+    }
+    
+    @Override
+    public int read(byte[] b, int off, int len) throws IOException {
+        int i = off;
+        do {
+            if (pushbackSize > 0) {
+                b[i++] = pushbackStack[--pushbackSize];
+            } else {
+                if (!buffer.hasRemaining()) {
+                    if (channel.read(buffer) == -1)
+                        return i == off ? -1 : i - off;
+                    buffer.rewind();
+                }
+                int read = min(buffer.remaining(), len - i);
+                buffer.get(b, i, i + read);
+                i += read;
+            }
+        } while (i < len);
+        return i - off;
+    }
+    
+    @Override
+    public void unread(byte[] b, int off, int len) throws IOException {
+        for (int i = off; i < len; i++)
+            unread(b[i]);
+    }
+    
+    @Override
+    public void unread(int b) throws IOException {
+        if (pushbackSize == pushbackStack.length)
+            throw new IOException("Pushback buffer is full");
+        pushbackStack[pushbackSize++] = (byte) b;
+    }
+    
+    @Override
+    public synchronized void close() throws IOException {
+        channel.close();
+    }
+    
+    @Override
+    public synchronized void reset() throws IOException {
+        throw new IOException("mark/reset not supported");
+    }
+
+}



From L.C.L.Kats at tudelft.nl  Mon Mar 29 13:36:28 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 11:36:28 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20722 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter
	strc-java/trunk/java/runtime/org/strategoxt/lang/terms
Message-ID: <201003291236.o2TCaSj0012728@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 11:36:28 +0000 (Mon, 29 Mar 2010)
New Revision: 20722

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20722&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java

Log:
Fixed Spoofax/62, reported by Nathan: "List construction in map removes annotation"

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java	2010-03-29 09:45:39 UTC (rev 20721)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java	2010-03-29 11:36:28 UTC (rev 20722)
@@ -15,6 +15,7 @@
 import java.io.OutputStream;
 import java.io.PushbackInputStream;
 import java.io.Writer;
+import java.nio.channels.FileChannel;
 import java.util.Collection;
 import java.util.Collections;
 import java.util.HashSet;
@@ -25,6 +26,7 @@
 import java.util.WeakHashMap;
 
 import org.spoofax.NotImplementedException;
+import org.spoofax.interpreter.library.ssl.ChannelPushbackInputStream;
 
 public class BasicTermFactory implements ITermFactory {
 
@@ -47,11 +49,18 @@
     }
 
     public IStrategoTerm parseFromStream(InputStream inputStream) throws IOException {
-        if (!(inputStream instanceof BufferedInputStream))
-            inputStream = new BufferedInputStream(inputStream);
-        PushbackInputStream bis = new PushbackInputStream(inputStream);
+        PushbackInputStream pushbackStream;
         
-        return parseFromStream(bis);
+        if (inputStream instanceof FileInputStream) {
+            FileChannel channel = ((FileInputStream)inputStream).getChannel();
+            pushbackStream = new ChannelPushbackInputStream(channel);
+        } else {
+            if (!(inputStream instanceof BufferedInputStream) && !(inputStream instanceof ChannelPushbackInputStream))
+                inputStream = new BufferedInputStream(inputStream);
+            pushbackStream = new PushbackInputStream(inputStream);
+        }
+        
+        return parseFromStream(pushbackStream);
     }
 
     protected IStrategoTerm parseFromStream(PushbackInputStream bis) throws IOException {
@@ -150,6 +159,7 @@
 
     private IStrategoTerm parseAppl(PushbackInputStream bis) throws IOException {
         //System.err.println("appl");
+        // TODO: share stringbuilder instances?
         StringBuilder sb = new StringBuilder();
         int ch;
         
@@ -157,7 +167,8 @@
         do {
             sb.append((char)ch);
             ch = bis.read();
-        } while(Character.isLetterOrDigit(ch) || ch == '_' || ch == '-'
+        } // TODO: use a switch for this
+          while(Character.isLetterOrDigit(ch) || ch == '_' || ch == '-'
             || ch == '+' || ch == '*' || ch == '$');
         
         //System.err.println(" - " + sb.toString());
@@ -278,19 +289,11 @@
     }
 
     public IStrategoTuple replaceTuple(IStrategoTerm[] kids, IStrategoTuple old) {
-        IStrategoTuple result = makeTuple(kids);
-        IStrategoList annos = old.getAnnotations();
-        return annos.isEmpty()
-            ? result
-            : (IStrategoTuple) annotateTerm(result, annos);
+        return makeTuple(kids, old.getAnnotations());
     }
     
     public IStrategoList replaceList(IStrategoTerm[] kids, IStrategoList old) {
-        IStrategoList result = makeList(kids);
-        IStrategoList annos = old.getAnnotations();
-        return annos.isEmpty()
-            ? result
-            : (IStrategoList) annotateTerm(result, annos);
+        return makeList(kids, old.getAnnotations());
     }
 
     public void unparseToFile(IStrategoTerm t, OutputStream ous) throws IOException {
@@ -353,11 +356,21 @@
         return new BasicStrategoInt(i, null);
     }
 
-    public IStrategoList makeList(IStrategoTerm... terms) {
+    public final IStrategoList makeList(IStrategoTerm... terms) {
+        return makeList(terms, null);
+    }
+
+    public IStrategoList makeList(IStrategoTerm[] terms, IStrategoList outerAnnos) {
         BasicStrategoList result = EMPTY_LIST;
-        for (int i = terms.length - 1; i >= 0; i--) {
-            result = new BasicStrategoList(terms[i], result, null);
+        int i = terms.length - 1;
+        while (i > 0) {
+            result = new BasicStrategoList(terms[i--], result, null);
         }
+        if (i == 0) {
+            result = new BasicStrategoList(terms[0], result, outerAnnos);
+        } else {
+            return new BasicStrategoList(null, null, outerAnnos);
+        }
         return result;
     }
 
@@ -369,9 +382,13 @@
     public final IStrategoList makeList(IStrategoTerm head, IStrategoList tail) {
         return makeListCons(head, tail);
     }
+
+    public final IStrategoList makeListCons(IStrategoTerm head, IStrategoList tail) {
+        return makeListCons(head, tail, null);
+    }
     
-    public IStrategoList makeListCons(IStrategoTerm head, IStrategoList tail) {
-        return new BasicStrategoList(head, tail, null);
+    public IStrategoList makeListCons(IStrategoTerm head, IStrategoList tail, IStrategoList annotations) {
+        return new BasicStrategoList(head, tail, annotations);
     }
 
     public IStrategoReal makeReal(double d) {
@@ -384,9 +401,13 @@
         return new BasicStrategoString(s, null);
     }
 
-    public IStrategoTuple makeTuple(IStrategoTerm... terms) {
-        return new BasicStrategoTuple(terms, null);
+    public final IStrategoTuple makeTuple(IStrategoTerm... terms) {
+        return makeTuple(terms, null);
     }
+
+    public IStrategoTuple makeTuple(IStrategoTerm[] terms, IStrategoList annotations) {
+        return new BasicStrategoTuple(terms, annotations);
+    }
     
     public IStrategoTerm annotateTerm(IStrategoTerm term, IStrategoList annotations) {
         if (term instanceof BasicStrategoTerm) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2010-03-29 09:45:39 UTC (rev 20721)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/main.str	2010-03-29 11:36:28 UTC (rev 20722)
@@ -47,6 +47,12 @@
       );
       <sdf2imp> FILE(esv)
   
+  /*
+  sdf2imp-static-files =
+    create-build-xml;
+    create-common-trans // needs name and project-name
+  */
+  
   // FIXME: dirty hack for getting the .def file
   //        (should do this based on the esv contents instead...)
   find-def-file =

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java	2010-03-29 09:45:39 UTC (rev 20721)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/adapter/WrappedAstNodeFactory.java	2010-03-29 11:36:28 UTC (rev 20722)
@@ -67,7 +67,8 @@
 		
 		// TODO: Optimize - create a WrappedAstNodeAppl with initialized kids field instead
 		//       (but ensure it maintains hte WrappedAstNodeLink.ensureLinks behavior)
-		IStrategoAppl result = makeAppl(constructor, ensureLinks(kids, oldTerm));
+		IStrategoList annos = oldTerm.getAnnotations();
+		IStrategoAppl result = makeAppl(constructor, ensureLinks(kids, oldTerm), annos);
 		
 		return (IStrategoAppl) ensureLink(result, oldTerm);
 	}
@@ -76,7 +77,8 @@
 	public IStrategoTuple replaceTuple(IStrategoTerm[] kids, IStrategoTuple old) {
 		// TODO: Optimize - create a WrappedAstNodeTuple with initialized kids field instead
 		//       (but ensure it maintains hte WrappedAstNodeLink.ensureLinks behavior)
-		return (IStrategoTuple) ensureLink(makeTuple(ensureLinks(kids, old)), old);
+		IStrategoList annos = old.getAnnotations();
+		return (IStrategoTuple) ensureLink(makeTuple(ensureLinks(kids, old), annos), old);
 	}
 	
 	@Override
@@ -85,7 +87,7 @@
 		//       (but ensure it maintains hte WrappedAstNodeLink.ensureLinks behavior)
 		// return (IStrategoList) ensureLink(makeList(ensureLinks(kids, old)), old);
 		assert terms.length == old.getSubtermCount();
-		return replaceList(terms, 0, old);
+		return replaceList(terms, 0, old, old.getAnnotations());
 	}
 
 	/**
@@ -103,19 +105,19 @@
 		}
 	}
 	
-	private IStrategoList replaceList(IStrategoTerm[] terms, int index, IStrategoList old) {
+	private IStrategoList replaceList(IStrategoTerm[] terms, int index, IStrategoList old, IStrategoList annos) {
 		if (index == terms.length) {
 			assert old.isEmpty();
 			return EMPTY_LIST; // we don't bother linking empty lists	 
 		} else {
 			IStrategoTerm head = ensureLink(terms[index], old.head());
-			IStrategoList tail = replaceList(terms, index + 1, old.tail());
+			IStrategoList tail = replaceList(terms, index + 1, old.tail(), null);
 			if (old instanceof WrappedAstNodeList) {
 				WrappedAstNodeList oldList = (WrappedAstNodeList) old;
 				return new WrappedAstNodeList(oldList.getNode(), oldList.getOffset(), head, tail);
 			} else {
 				// UNDONE: assert !(old instanceof IWrappedAstNode);
-				return makeListCons(head, tail);
+				return makeListCons(head, tail, annos);
 			}
 		}
 	}

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-29 09:45:39 UTC (rev 20721)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-29 11:36:28 UTC (rev 20722)
@@ -1,15 +1,19 @@
 package org.strategoxt.lang.terms;
 
-import static java.lang.Math.*;
-import static org.spoofax.interpreter.terms.IStrategoTerm.*;
+import static java.lang.Math.min;
+import static org.spoofax.interpreter.terms.IStrategoTerm.MAXIMALLY_SHARED;
+import static org.spoofax.interpreter.terms.IStrategoTerm.SHARABLE;
+import static org.spoofax.interpreter.terms.IStrategoTerm.STRING;
 
 import java.io.BufferedInputStream;
+import java.io.FileInputStream;
 import java.io.IOException;
 import java.io.InputStream;
+import java.nio.channels.FileChannel;
 import java.util.Collection;
 import java.util.HashMap;
-import java.util.Map;
 
+import org.spoofax.interpreter.library.ssl.ChannelPushbackInputStream;
 import org.spoofax.interpreter.terms.BasicTermFactory;
 import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoConstructor;
@@ -30,7 +34,7 @@
     
     private static final int MY_STORAGE_TYPE = SHARABLE;
     
-    private static final int MAX_POOLED_STRING_LENGTH = 100;
+    public static final int MAX_POOLED_STRING_LENGTH = 100;
     
     private static final IStrategoInt[] intCache = initIntCache();
 
@@ -43,10 +47,12 @@
     public static final StrategoList EMPTY_LIST =
     	new StrategoList(null, null, null, MAXIMALLY_SHARED); 
 
-    private static final Map<StrategoConstructor, StrategoConstructor> asyncCtorCache =
+    private static final HashMap<StrategoConstructor, StrategoConstructor> asyncCtorCache =
         new HashMap<StrategoConstructor, StrategoConstructor>();
     
-    private static final Map<String,StrategoString> asyncStringPool =
+    // TODO: use a WeakValueHashMap for TermFactory.asyncStringPool?
+    //       (WeakHashMap<String, WeakReference> seems to be quite expensive)
+    private static final HashMap<String, StrategoString> asyncStringPool =
         new HashMap<String, StrategoString>();
     
     @Override
@@ -56,7 +62,7 @@
             	if (asyncStringPool.containsKey(name)) {
             		return true;
             	} else if (name.length() > MAX_POOLED_STRING_LENGTH) {
-            		throw new UnsupportedOperationException("String too long to be pooled: " + name);
+            		throw new UnsupportedOperationException("String too long to be pooled (newname not allowed): " + name);
             	} else {
                 	// HACK: pre-allocating strings to avoid race condition 
             		asyncStringPool.put(name, new StrategoString(name, null, MAXIMALLY_SHARED));
@@ -71,11 +77,19 @@
     @Override
     public IStrategoTerm parseFromStream(InputStream inputStream) throws IOException {
         BufferedInputStream bis;
-        if (inputStream instanceof BufferedInputStream)
+        if (inputStream instanceof BufferedInputStream) {
             bis = (BufferedInputStream) inputStream;
-        else
+        } else if (inputStream instanceof FileInputStream) {
+        	FileChannel channel = ((FileInputStream) inputStream).getChannel();
+			ChannelPushbackInputStream pis = new ChannelPushbackInputStream(channel);
+			if (BAFReader.isBinaryATerm(pis)) {
+				return new BAFReader(this, pis).readFromBinaryFile(true);
+			} else {
+				return super.parseFromStream(pis);
+			}
+        } else {
             bis = new BufferedInputStream(inputStream);
-        
+        }
         if (BAFReader.isBinaryATerm(bis)) {
             return new BAFReader(this, bis).readFromBinaryFile(true);
         } else {
@@ -125,14 +139,22 @@
     }
     
     @Override
-    public IStrategoList makeList(IStrategoTerm... terms) {
+    public IStrategoList makeList(IStrategoTerm[] terms, IStrategoList outerAnnos) {
         StrategoList result = EMPTY_LIST;
         int storageType = MY_STORAGE_TYPE;
-        for (int i = terms.length - 1; i >= 0; i--) {
-            IStrategoTerm head = terms[i];
+        int i = terms.length - 1;
+        while (i > 0) {
+        	IStrategoTerm head = terms[i--];
             storageType = min(storageType, getStorageType(head));
 			result = new StrategoList(head, result, null, storageType);
         }
+        if (i == 0) {
+        	IStrategoTerm head = terms[0];
+            storageType = min(storageType, getStorageType(head));
+			result = new StrategoList(head, result, outerAnnos, storageType);
+        } else {
+        	return new StrategoList(null, null, outerAnnos, MY_STORAGE_TYPE);
+        }
         return result;
     }
 
@@ -142,11 +164,11 @@
     }
     
     @Override
-    public IStrategoList makeListCons(IStrategoTerm head, IStrategoList tail) {
+    public IStrategoList makeListCons(IStrategoTerm head, IStrategoList tail, IStrategoList annotations) {
     	int storageType = min(MY_STORAGE_TYPE, getStorageType(head, tail));
     	
     	if (head == null) return EMPTY_LIST;
-    	return new StrategoList(head, tail, null, storageType);
+    	return new StrategoList(head, tail, annotations, storageType);
     }
 
     @Override
@@ -170,9 +192,9 @@
     }
 
     @Override
-    public IStrategoTuple makeTuple(IStrategoTerm... terms) {
+    public IStrategoTuple makeTuple(IStrategoTerm[] terms, IStrategoList annos) {
         int storageType = min(MY_STORAGE_TYPE, getStorageType(terms));
-		return new StrategoTuple(terms, null, storageType);
+		return new StrategoTuple(terms, annos, storageType);
     }
     
     protected static int getStorageType(IStrategoTerm term) {



From L.C.L.Kats at tudelft.nl  Mon Mar 29 13:44:11 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 11:44:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20723 - LennartKats -
	in strc-java/trunk: java java/runtime/org/strategoxt/lang
	java/runtime/org/strategoxt/lang/compat test/basic
Message-ID: <201003291244.o2TCiBXm012805@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 11:44:11 +0000 (Mon, 29 Mar 2010)
New Revision: 20723

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20723&view=rev

Added:
   strc-java/trunk/java/runtime/org/strategoxt/lang/WeakValueHashMap.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java
Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java
   strc-java/trunk/java/spoofax-libs.jar
   strc-java/trunk/test/basic/readterm_1.str

Log:
Added cached ReadFromFile.

Changes:

Copied: strc-java/trunk/java/runtime/org/strategoxt/lang/WeakValueHashMap.java (from rev 20662, spoofax-imp/trunk/org.strategoxt.imp.runtime/lib/org/jboss/util/collection/WeakValueHashMap.java)
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/WeakValueHashMap.java	                        (rev 0)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/WeakValueHashMap.java	2010-03-29 11:44:11 UTC (rev 20723)
@@ -0,0 +1,227 @@
+/***************************************+ *                                     *+ *  JBoss: The OpenSource J2EE WebOS   *+ *                                     *+ *  Distributable under LGPL license.  *+ *  See terms of license at gnu.org.   *+ *                                     *+ ***************************************/++package org.strategoxt.lang;++import java.lang.ref.ReferenceQueue;+import java.lang.ref.WeakReference;+import java.util.AbstractMap;+import java.util.HashMap;+import java.util.Map;+import java.util.Set;++import org.spoofax.NotImplementedException;++/**+ * This Map will remove entries when the value in the map has been cleaned from+ * garbage collection+ * + * @version <tt>$Revision: 1.1.1.1 $</tt>+ * @author <a href="mailto:bill at jboss.org">Bill Burke</a>+ */+ at SuppressWarnings("all")+public class WeakValueHashMap<K,V> extends AbstractMap<K,V> implements Map<K,V> {+	private static class WeakValueRef extends WeakReference {!
 +		public Object key;++		private WeakValueRef(Object key, Object val, ReferenceQueue q) {+			super(val, q);+			this.key = key;+		}++		private static WeakValueRef create(Object key, Object val, ReferenceQueue q) {+			if (val == null)+				return null;+			else+				return new WeakValueRef(key, val, q);+		}++	}++	public Set entrySet() {+		processQueue();+		// return hash.entrySet();+		throw new NotImplementedException();+	}++	/* Hash table mapping WeakKeys to values */+	private Map hash;++	/* Reference queue for cleared WeakKeys */+	private ReferenceQueue queue = new ReferenceQueue();++	/*+	 * Remove all invalidated entries from the map, that is, remove all entries+	 * whose values have been discarded.+	 */+	private void processQueue() {+		WeakValueRef ref;+		while ((ref = (WeakValueRef) queue.poll()) != null) {+			if (ref == (WeakValueRef) hash.get(ref.key)) {+				// only remove if it is the *exact* same WeakValueRef+				//+				hash.remove(!
 ref.key);+			}+		}+	}++	/* -- Constructors -- */++	/**+	 * C
tructs a new, empty <code>WeakHashMap</code> with the given initial+	 * capacity and the given load factor.+	 * +	 * @param initialCapacity+	 *            The initial capacity of the <code>WeakHashMap</code>+	 * +	 * @param loadFactor+	 *            The load factor of the <code>WeakHashMap</code>+	 * +	 * @throws IllegalArgumentException+	 *             If the initial capacity is less than zero, or if the load+	 *             factor is nonpositive+	 */+	public WeakValueHashMap(int initialCapacity, float loadFactor) {+		hash = new HashMap(initialCapacity, loadFactor);+	}++	/**+	 * Constructs a new, empty <code>WeakHashMap</code> with the given initial+	 * capacity and the default load factor, which is <code>0.75</code>.+	 * +	 * @param initialCapacity+	 *            The initial capacity of the <code>WeakHashMap</code>+	 * +	 * @throws IllegalArgumentException+	 *             If the initial capacity is less than zero+	 */+	public WeakValueHashMap(int!
  initialCapacity) {+		hash = new HashMap(initialCapacity);+	}++	/**+	 * Constructs a new, empty <code>WeakHashMap</code> with the default initial+	 * capacity and the default load factor, which is <code>0.75</code>.+	 */+	public WeakValueHashMap() {+		hash = new HashMap();+	}++	/**+	 * Constructs a new <code>WeakHashMap</code> with the same mappings as the+	 * specified <tt>Map</tt>. The <code>WeakHashMap</code> is created with an+	 * initial capacity of twice the number of mappings in the specified map or+	 * 11 (whichever is greater), and a default load factor, which is+	 * <tt>0.75</tt>.+	 * +	 * @param t+	 *            the map whose mappings are to be placed in this map.+	 * @since 1.3+	 */+	public WeakValueHashMap(Map t) {+		this(Math.max(2 * t.size(), 11), 0.75f);+		putAll(t);+	}++	/* -- Simple queries -- */++	/**+	 * Returns the number of key-value mappings in this map.+	 * <strong>Note:</strong> <em>In contrast with most implementatio!
 ns of the+	 * <code>Map</code> interface, the time required by this
eration is+	 * linear in the size of the map.</em>+	 */+	public int size() {+		processQueue();+		return hash.size();+	}++	/**+	 * Returns <code>true</code> if this map contains no key-value mappings.+	 */+	public boolean isEmpty() {+		processQueue();+		return hash.isEmpty();+	}++	/**+	 * Returns <code>true</code> if this map contains a mapping for the+	 * specified key.+	 * +	 * @param key+	 *            The key whose presence in this map is to be tested+	 */+	public boolean containsKey(Object key) {+		processQueue();+		return hash.containsKey(key);+	}++	/* -- Lookup and modification operations -- */++	/**+	 * Returns the value to which this map maps the specified <code>key</code>.+	 * If this map does not contain a value for this key, then return+	 * <code>null</code>.+	 * +	 * @param key+	 *            The key whose associated value, if any, is to be returned+	 */+	public V get(Object key) {+		processQueue();+		WeakReference ref = (W!
 eakReference) hash.get(key);+		if (ref != null)+			return (V) ref.get();+		return null;+	}++	/**+	 * Updates this map so that the given <code>key</code> maps to the given+	 * <code>value</code>. If the map previously contained a mapping for+	 * <code>key</code> then that mapping is replaced and the previous value is+	 * returned.+	 * +	 * @param key+	 *            The key that is to be mapped to the given <code>value</code>+	 * @param value+	 *            The value to which the given <code>key</code> is to be mapped+	 * +	 * @return The previous value to which this key was mapped, or+	 *         <code>null</code> if if there was no mapping for the key+	 */+	public Object put(Object key, Object value) {+		processQueue();+		Object rtn = hash.put(key, WeakValueRef.create(key, value, queue));+		if (rtn != null)+			rtn = ((WeakReference) rtn).get();+		return rtn;+	}++	/**+	 * Removes the mapping for the given <code>key</code> from this map, if+	 * p!
 resent.+	 * +	 * @param key+	 *            The key whose mapping 
to be removed+	 * +	 * @return The value to which this key was mapped, or <code>null</code> if+	 *         there was no mapping for the key+	 */+	public V remove(Object key) {		+		processQueue();+		return ((WeakReference<V>) hash.remove(key)).get();+	}++	/**+	 * Removes all mappings from this map.+	 */+	public void clear() {+		processQueue();+		hash.clear();+	}+}
Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java	2010-03-29 11:36:28 UTC (rev 20722)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java	2010-03-29 11:44:11 UTC (rev 20723)
@@ -48,6 +48,7 @@
 		if ("stratego_lib".equals(component)) {
 			context.addOperatorRegistry(new CompatLibrary());
 			report_failure_compat_1_0.init();
+			ReadFromFile_cached_0_0.init();
 		} else if ("stratego_sglr".equals(component)) {
 			ATermFactory atermFactory = new PureFactory();
 			context.addOperatorRegistry(new JSGLRLibrary(atermFactory));

Added: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java	                        (rev 0)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java	2010-03-29 11:44:11 UTC (rev 20723)
@@ -0,0 +1,85 @@
+package org.strategoxt.lang.compat;
+
+import static org.spoofax.interpreter.core.Tools.asJavaString;
+import static org.spoofax.interpreter.core.Tools.isTermString;
+import static org.spoofax.interpreter.terms.IStrategoTerm.MAXIMALLY_SHARED;
+import static org.spoofax.interpreter.terms.IStrategoTerm.SHARABLE;
+
+import java.io.File;
+import java.util.Map;
+import java.util.WeakHashMap;
+
+import org.spoofax.interpreter.terms.IStrategoTerm;
+import org.strategoxt.lang.Context;
+import org.strategoxt.lang.WeakValueHashMap;
+import org.strategoxt.stratego_lib.$Read$From$File_0_0;
+
+/**
+ * Reads terms from files with caching.
+ * 
+ * @author Lennart Kats <lennart add lclnet.nl>
+ */
+public class ReadFromFile_cached_0_0 extends $Read$From$File_0_0 {
+	
+	private static volatile boolean isInited;
+	
+	private static Map<File, IStrategoTerm> asyncCache =
+		new WeakValueHashMap<File, IStrategoTerm>();
+	
+	private static Map<IStrategoTerm, FileDate> asyncCacheDates =
+		new WeakHashMap<IStrategoTerm, FileDate>();
+	
+	public static void init() {
+		if (!isInited) {
+			$Read$From$File_0_0.instance = new ReadFromFile_cached_0_0();
+			isInited = true;
+		}
+	}
+	
+	@Override
+	public IStrategoTerm invoke(Context context, IStrategoTerm term) {
+		if (!isTermString(term))
+			return super.invoke(context, term);
+		
+		File file = context.getIOAgent().openFile(asJavaString(term));
+		if (!file.exists())
+			return super.invoke(context, term);
+		
+		FileDate cachedDate = null;
+		IStrategoTerm cachedTerm = null;
+		
+		synchronized (asyncCache) {
+			cachedTerm = asyncCache.get(file);
+			if (cachedTerm != null)
+				cachedDate = asyncCacheDates.get(cachedTerm);
+		}
+		
+		long date = file.lastModified();
+		if (cachedDate != null && cachedDate.date < date && cachedDate.file.equals(file)) {
+			return cachedTerm;
+		} else {
+			IStrategoTerm result = super.invoke(context, term);
+			if (result != null &&
+					(result.getStorageType() == SHARABLE || result.getStorageType() == MAXIMALLY_SHARED)) {
+				synchronized (asyncCache) {
+					asyncCache.put(file, result);
+					asyncCacheDates.put(result, new FileDate(file, date));
+				}
+			}
+			return result;
+		}
+	}
+	
+	/**
+	 * @author Lennart Kats <lennart add lclnet.nl>
+	 */
+	private static class FileDate {
+		final File file;
+		final long date;
+		
+		FileDate(File file, long date) {
+			this.file = file;
+			this.date = date;
+		}
+	}
+}

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)

Modified: strc-java/trunk/test/basic/readterm_1.str
===================================================================
--- strc-java/trunk/test/basic/readterm_1.str	2010-03-29 11:36:28 UTC (rev 20722)
+++ strc-java/trunk/test/basic/readterm_1.str	2010-03-29 11:44:11 UTC (rev 20723)
@@ -7,10 +7,14 @@
   
   main =
     t := Some([1,2{3}]{4}){5};
+    debug(!"Writing ");
     <WriteToTextFile> ("readterm_1.trm", t);
     <ReadFromFile> "readterm_1.trm" => t;
+    <ReadFromFile> "readterm_1.trm" => t;
     
     t2 := Some([1,2]);
+    debug(!"Writing ");
     <WriteToTextFile> ("readterm_1.trm", t2);
+    <ReadFromFile> "readterm_1.trm" => t2;
     <ReadFromFile> "readterm_1.trm" => t2
 



From L.C.L.Kats at tudelft.nl  Mon Mar 29 13:54:12 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 11:54:12 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20724 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services
Message-ID: <201003291254.o2TCsCnd012908@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 11:54:12 +0000 (Mon, 29 Mar 2010)
New Revision: 20724

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20724&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str

Log:
buildfix

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-29 11:44:11 UTC (rev 20723)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-29 11:54:12 UTC (rev 20724)
@@ -49,5 +49,5 @@
         ~~
         extensions: ~extensions
         table:  ~parsetable
-        start symbols: ~*startsymbols TODO: can I just comment these out?
+        start symbols: ~*startsymbols // TODO: can I just comment these out?
     ]|



From L.C.L.Kats at tudelft.nl  Mon Mar 29 13:59:41 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 11:59:41 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20725 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms
	strc-java/trunk/java
	strc-java/trunk/java/runtime/org/strategoxt/lang/terms
Message-ID: <201003291259.o2TCxfsT012939@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 11:59:41 +0000 (Mon, 29 Mar 2010)
New Revision: 20725

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20725&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
   strc-java/trunk/java/spoofax-libs.jar

Log:
Removed experimental code accidentally checked in with r20722.

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java	2010-03-29 11:54:12 UTC (rev 20724)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java	2010-03-29 11:59:41 UTC (rev 20725)
@@ -49,6 +49,7 @@
     }
 
     public IStrategoTerm parseFromStream(InputStream inputStream) throws IOException {
+        /*
         PushbackInputStream pushbackStream;
         
         if (inputStream instanceof FileInputStream) {
@@ -61,6 +62,12 @@
         }
         
         return parseFromStream(pushbackStream);
+        */
+        if (!(inputStream instanceof BufferedInputStream))
+            inputStream = new BufferedInputStream(inputStream);
+        PushbackInputStream bis = new PushbackInputStream(inputStream);
+        
+        return parseFromStream(bis);
     }
 
     protected IStrategoTerm parseFromStream(PushbackInputStream bis) throws IOException {

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-29 11:54:12 UTC (rev 20724)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/terms/TermFactory.java	2010-03-29 11:59:41 UTC (rev 20725)
@@ -6,14 +6,11 @@
 import static org.spoofax.interpreter.terms.IStrategoTerm.STRING;
 
 import java.io.BufferedInputStream;
-import java.io.FileInputStream;
 import java.io.IOException;
 import java.io.InputStream;
-import java.nio.channels.FileChannel;
 import java.util.Collection;
 import java.util.HashMap;
 
-import org.spoofax.interpreter.library.ssl.ChannelPushbackInputStream;
 import org.spoofax.interpreter.terms.BasicTermFactory;
 import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoConstructor;
@@ -76,7 +73,8 @@
     
     @Override
     public IStrategoTerm parseFromStream(InputStream inputStream) throws IOException {
-        BufferedInputStream bis;
+        /*
+    	BufferedInputStream bis;
         if (inputStream instanceof BufferedInputStream) {
             bis = (BufferedInputStream) inputStream;
         } else if (inputStream instanceof FileInputStream) {
@@ -95,6 +93,18 @@
         } else {
             return super.parseFromStream(bis);
         }
+        */
+    	BufferedInputStream bis;
+        if (inputStream instanceof BufferedInputStream)
+            bis = (BufferedInputStream) inputStream;
+        else
+            bis = new BufferedInputStream(inputStream);
+        
+        if (BAFReader.isBinaryATerm(bis)) {
+            return new BAFReader(this, bis).readFromBinaryFile(true);
+        } else {
+            return super.parseFromStream(bis);
+        }
     }
 
     @Override

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Mon Mar 29 14:00:56 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 12:00:56 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20726 - LennartKats -
	spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms
Message-ID: <201003291300.o2TD0uHr012975@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 12:00:56 +0000 (Mon, 29 Mar 2010)
New Revision: 20726

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20726&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java

Log:


Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java	2010-03-29 11:59:41 UTC (rev 20725)
+++ spoofax/trunk/spoofax/org.spoofax.interpreter.core/src/java/org/spoofax/interpreter/terms/BasicTermFactory.java	2010-03-29 12:00:56 UTC (rev 20726)
@@ -15,7 +15,6 @@
 import java.io.OutputStream;
 import java.io.PushbackInputStream;
 import java.io.Writer;
-import java.nio.channels.FileChannel;
 import java.util.Collection;
 import java.util.Collections;
 import java.util.HashSet;
@@ -26,7 +25,6 @@
 import java.util.WeakHashMap;
 
 import org.spoofax.NotImplementedException;
-import org.spoofax.interpreter.library.ssl.ChannelPushbackInputStream;
 
 public class BasicTermFactory implements ITermFactory {
 



From L.C.L.Kats at tudelft.nl  Mon Mar 29 14:06:43 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 12:06:43 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20727 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.generator
Message-ID: <201003291306.o2TD6hVi013184@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 12:06:42 +0000 (Mon, 29 Mar 2010)
New Revision: 20727

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20727&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.generator/.project

Log:
Removed org.spoofax.editor reference from .project file

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/.project
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/.project	2010-03-29 12:00:56 UTC (rev 20726)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/.project	2010-03-29 12:06:42 UTC (rev 20727)
@@ -30,15 +30,9 @@
 			<arguments>
 			</arguments>
 		</buildCommand>
-		<buildCommand>
-			<name>org.spoofax.editor.builder.stratego</name>
-			<arguments>
-			</arguments>
-		</buildCommand>
 	</buildSpec>
 	<natures>
 		<nature>org.eclipse.pde.PluginNature</nature>
 		<nature>org.eclipse.jdt.core.javanature</nature>
-		<nature>org.spoofax.editor.nature.stratego</nature>
 	</natures>
 </projectDescription>



From E.Visser at tudelft.nl  Mon Mar 29 15:28:25 2010
From: E.Visser at tudelft.nl (Eelco Visser)
Date: Mon, 29 Mar 2010 13:28:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20728 - visser - tfa
Message-ID: <201003291428.o2TESPnl014083@proliant.st.ewi.tudelft.nl>

Author: visser
Date: 2010-03-29 13:28:25 +0000 (Mon, 29 Mar 2010)
New Revision: 20728

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20728&view=rev

Added:
   tfa/spoofax/

Log:


Changes:



From E.Visser at tudelft.nl  Mon Mar 29 15:29:04 2010
From: E.Visser at tudelft.nl (Eelco Visser)
Date: Mon, 29 Mar 2010 13:29:04 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20729 - visser -
	tfa/spoofax
Message-ID: <201003291429.o2TET4Ao014093@proliant.st.ewi.tudelft.nl>

Author: visser
Date: 2010-03-29 13:29:04 +0000 (Mon, 29 Mar 2010)
New Revision: 20729

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20729&view=rev

Added:
   tfa/spoofax/trunk/

Log:
- clone to make into a spoofax project



Changes:



From E.Visser at tudelft.nl  Mon Mar 29 15:30:31 2010
From: E.Visser at tudelft.nl (Eelco Visser)
Date: Mon, 29 Mar 2010 13:30:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20730 - visser -
	tfa/spoofax
Message-ID: <201003291430.o2TEUVlE014133@proliant.st.ewi.tudelft.nl>

Author: visser
Date: 2010-03-29 13:30:31 +0000 (Mon, 29 Mar 2010)
New Revision: 20730

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20730&view=rev

Removed:
   tfa/spoofax/trunk/

Log:


Changes:



From E.Visser at tudelft.nl  Mon Mar 29 15:30:55 2010
From: E.Visser at tudelft.nl (Eelco Visser)
Date: Mon, 29 Mar 2010 13:30:55 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20731 - visser -
	tfa/spoofax
Message-ID: <201003291430.o2TEUtUB014151@proliant.st.ewi.tudelft.nl>

Author: visser
Date: 2010-03-29 13:30:55 +0000 (Mon, 29 Mar 2010)
New Revision: 20731

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20731&view=rev

Added:
   tfa/spoofax/trunk/

Log:


Changes:



From E.Visser at tudelft.nl  Mon Mar 29 15:32:22 2010
From: E.Visser at tudelft.nl (Eelco Visser)
Date: Mon, 29 Mar 2010 13:32:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20732 - visser -
	tfa/spoofax/trunk
Message-ID: <201003291432.o2TEWMZP014173@proliant.st.ewi.tudelft.nl>

Author: visser
Date: 2010-03-29 13:32:22 +0000 (Mon, 29 Mar 2010)
New Revision: 20732

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20732&view=rev

Added:
   tfa/spoofax/trunk/.project

Log:


Changes:

Added: tfa/spoofax/trunk/.project
===================================================================
--- tfa/spoofax/trunk/.project	                        (rev 0)
+++ tfa/spoofax/trunk/.project	2010-03-29 13:32:22 UTC (rev 20732)
@@ -0,0 +1,37 @@
+<?xml version="1.0" encoding="UTF-8" ?>
+
+<projectDescription>
+      <name>tfa</name>
+      <comment></comment>
+      <buildSpec>
+		<buildCommand>
+			<name>org.eclipse.ui.externaltools.ExternalToolBuilder</name>
+			<triggers>full,incremental,</triggers>
+			<arguments>
+				<dictionary>
+					<key>LaunchConfigHandle</key>
+					<value>&lt;project&gt;/.externalToolBuilders/TIL build.main.xml.launch</value>
+				</dictionary>
+			</arguments>
+		</buildCommand>
+        <buildCommand>
+          <name>org.eclipse.jdt.core.javabuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+        <buildCommand>
+          <name>org.eclipse.pde.ManifestBuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+        <buildCommand>
+          <name>org.eclipse.pde.SchemaBuilder</name>
+          <arguments>
+          </arguments>
+        </buildCommand>
+      </buildSpec>
+      <natures>
+        <nature>org.eclipse.pde.PluginNature</nature>
+        <nature>org.eclipse.jdt.core.javanature</nature>
+      </natures>
+    </projectDescription>
\ No newline at end of file



From E.Visser at tudelft.nl  Mon Mar 29 15:33:01 2010
From: E.Visser at tudelft.nl (Eelco Visser)
Date: Mon, 29 Mar 2010 13:33:01 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20733 - visser -
	tfa/spoofax/trunk
Message-ID: <201003291433.o2TEX1tV014209@proliant.st.ewi.tudelft.nl>

Author: visser
Date: 2010-03-29 13:33:01 +0000 (Mon, 29 Mar 2010)
New Revision: 20733

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20733&view=rev

Added:
   tfa/spoofax/trunk/spec/

Log:
importing tfa def

Changes:



From L.C.L.Kats at tudelft.nl  Mon Mar 29 16:21:11 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 14:21:11 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20734 - LennartKats -
	in strc-java/trunk/java: . runtime/org/strategoxt/lang/compat
Message-ID: <201003291521.o2TFLBdv014985@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 14:21:11 +0000 (Mon, 29 Mar 2010)
New Revision: 20734

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20734&view=rev

Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java
   strc-java/trunk/java/spoofax-libs.jar

Log:
Added filesystem time stamp granularity support to ReadFromFile caching.

Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java	2010-03-29 13:33:01 UTC (rev 20733)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/ReadFromFile_cached_0_0.java	2010-03-29 14:21:11 UTC (rev 20734)
@@ -20,6 +20,14 @@
  * @author Lennart Kats <lennart add lclnet.nl>
  */
 public class ReadFromFile_cached_0_0 extends $Read$From$File_0_0 {
+
+	/**
+	 * The number of milliseconds leeway to give before deciding a file is out
+	 * of date. This is needed because not every file system supports tracking
+	 * the last modified time to the millisecond level. 2 seconds should
+	 * even be good for FAT16.
+	 */
+	private static long FILE_TIME_GRANULARITY = 2001;
 	
 	private static volatile boolean isInited;
 	
@@ -48,22 +56,30 @@
 		FileDate cachedDate = null;
 		IStrategoTerm cachedTerm = null;
 		
+		long now = System.currentTimeMillis();
+		long fileDate = file.lastModified();
+		
 		synchronized (asyncCache) {
 			cachedTerm = asyncCache.get(file);
 			if (cachedTerm != null)
 				cachedDate = asyncCacheDates.get(cachedTerm);
 		}
 		
-		long date = file.lastModified();
-		if (cachedDate != null && cachedDate.date < date && cachedDate.file.equals(file)) {
+		if (now < fileDate + FILE_TIME_GRANULARITY) {
+			// Date stamp too recent or in the future
+			return super.invoke(context, term);
+		} else if (cachedDate != null
+				&& cachedDate.accessed > fileDate + FILE_TIME_GRANULARITY
+				&& cachedDate.file.equals(file)) {
 			return cachedTerm;
 		} else {
 			IStrategoTerm result = super.invoke(context, term);
 			if (result != null &&
-					(result.getStorageType() == SHARABLE || result.getStorageType() == MAXIMALLY_SHARED)) {
+					(result.getStorageType() == SHARABLE ||
+					 result.getStorageType() == MAXIMALLY_SHARED)) {
 				synchronized (asyncCache) {
 					asyncCache.put(file, result);
-					asyncCacheDates.put(result, new FileDate(file, date));
+					asyncCacheDates.put(result, new FileDate(file, now));
 				}
 			}
 			return result;
@@ -75,11 +91,11 @@
 	 */
 	private static class FileDate {
 		final File file;
-		final long date;
+		final long accessed;
 		
-		FileDate(File file, long date) {
+		FileDate(File file, long accessed) {
 			this.file = file;
-			this.date = date;
+			this.accessed = accessed;
 		}
 	}
 }

Modified: strc-java/trunk/java/spoofax-libs.jar
===================================================================
(Binary files differ)



From L.C.L.Kats at tudelft.nl  Mon Mar 29 16:24:26 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Mon, 29 Mar 2010 14:24:26 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20735 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.generator/src/sdf2imp/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
Message-ID: <201003291524.o2TFOQL7015001@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-29 14:24:26 +0000 (Mon, 29 Mar 2010)
New Revision: 20735

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20735&view=rev

Removed:
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/read-main-descriptor.meta
Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-29 14:21:11 UTC (rev 20734)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-29 14:24:26 UTC (rev 20735)
@@ -18,12 +18,6 @@
     | <import-term(include/Stratego-Sugar.tbl)>
     )
   
-  parse-stream =
-    parse-stream(
-      strsglr-report-parse-error
-    | <import-term(include/Stratego-Sugar.tbl)>
-    )
-
 strategies
   
   /**

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-29 14:21:11 UTC (rev 20734)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-main-descriptor.str	2010-03-29 14:24:26 UTC (rev 20735)
@@ -49,5 +49,5 @@
         ~~
         extensions: ~extensions
         table:  ~parsetable
-        start symbols: ~*startsymbols // TODO: can I just comment these out?
+        start symbols: ~*startsymbols
     ]|

Deleted: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/read-main-descriptor.meta
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/read-main-descriptor.meta	2010-03-29 14:21:11 UTC (rev 20734)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/read-main-descriptor.meta	2010-03-29 14:24:26 UTC (rev 20735)
@@ -1 +0,0 @@
-Meta([Syntax("Stratego-Java-EditorService")])

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-29 14:21:11 UTC (rev 20734)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-29 14:24:26 UTC (rev 20735)
@@ -1,6 +1,3 @@
-/**
- * 
- */
 package org.strategoxt.imp.runtime.stratego;
 
 import static org.eclipse.core.resources.IResource.DEPTH_INFINITE;



From m.dejonge at tudelft.nl  Mon Mar 29 17:27:38 2010
From: m.dejonge at tudelft.nl (Maartje de Jonge)
Date: Mon, 29 Mar 2010 15:27:38 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20736 - MaartjeDeJonge -
	spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr
Message-ID: <201003291627.o2TGRcc4015856@proliant.st.ewi.tudelft.nl>

Author: MaartjeDeJonge
Date: 2010-03-29 15:27:38 +0000 (Mon, 29 Mar 2010)
New Revision: 20736

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20736&view=rev

Modified:
   spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NewStructureSkipper.java

Log:
yellowgrass bug 35: bugfix 

Changes:

Modified: spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NewStructureSkipper.java
===================================================================
--- spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NewStructureSkipper.java	2010-03-29 14:24:26 UTC (rev 20735)
+++ spoofax/trunk/spoofax/org.spoofax.jsglr/src/org/spoofax/jsglr/NewStructureSkipper.java	2010-03-29 15:27:38 UTC (rev 20736)
@@ -86,7 +86,7 @@
         ArrayList<StructureSkipSuggestion> fwSkips=new ArrayList<StructureSkipSuggestion>();
         ArrayList<StructureSkipSuggestion> nextSiblings=getCurrentAndNextSkipSuggestions(failureIndex);
         ArrayList<StructureSkipSuggestion> prevRegionSuggestions=selectPrevRegion(failureIndex);
-        if(prevRegionSuggestions.isEmpty()){
+        if(prevRegionSuggestions.isEmpty() && nextSiblings.size()> 0){
             prevRegionSuggestions=getCurrentRegionSkips(failureIndex);
             nextSiblings.remove(0);
         }



From L.C.L.Kats at tudelft.nl  Tue Mar 30 09:55:14 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 30 Mar 2010 07:55:14 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20737 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
	strc-java/trunk/java/runtime/org/strategoxt
	strc-java/trunk/java/runtime/org/strategoxt/lang/compat
Message-ID: <201003300855.o2U8tEjm028465@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-30 07:55:13 +0000 (Tue, 30 Mar 2010)
New Revision: 20737

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20737&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java
   strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java
   strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java

Log:
Fixed a bug that caused Spoofax to create HybridInterpreters without the IMPJSGLRLibrary. Reported by Nathan.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2010-03-29 15:27:38 UTC (rev 20736)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2010-03-30 07:55:13 UTC (rev 20737)
@@ -208,6 +208,7 @@
 		assert result.getContext().lookupOperator(IMPParseStringPTPrimitive.NAME) instanceof IMPParseStringPTPrimitive;
 		assert result.getCompiledContext().lookupPrimitive(IMPParseStringPTPrimitive.NAME) instanceof IMPParseStringPTPrimitive;
 		assert result.getCompiledContext().lookupPrimitive(IMPOpenFile.NAME) instanceof IMPOpenFile;
+		assert result.getCompiledContext().getOperatorRegistry(IMPJSGLRLibrary.REGISTRY_NAME) instanceof IMPJSGLRLibrary;
 		result.setIOAgent(new EditorIOAgent());
 		
 		return result;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-29 15:27:38 UTC (rev 20736)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-30 07:55:13 UTC (rev 20737)
@@ -50,6 +50,8 @@
 import org.strategoxt.imp.runtime.parser.SGLRParseController;
 import org.strategoxt.imp.runtime.parser.ast.AstMessageHandler;
 import org.strategoxt.imp.runtime.stratego.EditorIOAgent;
+import org.strategoxt.imp.runtime.stratego.IMPJSGLRLibrary;
+import org.strategoxt.imp.runtime.stratego.IMPLibrary;
 import org.strategoxt.imp.runtime.stratego.StrategoConsole;
 import org.strategoxt.imp.runtime.stratego.StrategoTermPath;
 import org.strategoxt.imp.runtime.stratego.adapter.IStrategoAstNode;
@@ -133,7 +135,7 @@
 		
 		HybridInterpreter prototype = cachedRuntimes.get(descriptor);
 		if (prototype != null) {
-			runtime = new HybridInterpreter(prototype);
+			runtime = new HybridInterpreter(prototype, IMPJSGLRLibrary.REGISTRY_NAME, IMPLibrary.REGISTRY_NAME);
 			return;
 		}
 		
@@ -497,6 +499,8 @@
 			initRuntimePath(resource);
 
 			((LoggingIOAgent) runtime.getIOAgent()).clearLog();
+			assert runtime.getCompiledContext().getOperatorRegistry(IMPJSGLRLibrary.REGISTRY_NAME)
+					instanceof IMPJSGLRLibrary;
 			boolean success = runtime.invoke(function);
 			
 			Debug.stopTimer("Evaluated strategy " + function + (success ? "" : " (failed)"));

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2010-03-29 15:27:38 UTC (rev 20736)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPLibrary.java	2010-03-30 07:55:13 UTC (rev 20737)
@@ -7,7 +7,7 @@
  */
 public class IMPLibrary extends AbstractStrategoOperatorRegistry {
 	
-	private static final String REGISTRY_NAME = "sdf2imp";
+	public static final String REGISTRY_NAME = "sdf2imp";
 	
 	public IMPLibrary() {
 		add(new SubtermPrimitive());

Modified: strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java	2010-03-29 15:27:38 UTC (rev 20736)
+++ strc-java/trunk/java/runtime/org/strategoxt/HybridInterpreter.java	2010-03-30 07:55:13 UTC (rev 20737)
@@ -6,6 +6,8 @@
 import java.net.URL;
 import java.net.URLClassLoader;
 import java.util.Enumeration;
+import java.util.HashSet;
+import java.util.Set;
 import java.util.jar.JarEntry;
 import java.util.jar.JarFile;
 
@@ -73,13 +75,21 @@
 	
 	/**
 	 * Creates an interpreter that bases its definition scope on an existing instance.
+	 * 
+	 * @param interpreter		The interpreter to base this instance on.
+	 * 
+	 * @param reuseRegistries	The names of operator registries that should not be re-created,
+	 *                       	but can be reused from the old instance.
 	 */
-	public HybridInterpreter(HybridInterpreter interpreter) {
+	public HybridInterpreter(HybridInterpreter interpreter, String... reuseRegistries) {
 		this(interpreter.getFactory(), ((org.spoofax.interpreter.core.Context) interpreter.getContext()).getProgramFactory());
+		Set<String> reusable = asSet(reuseRegistries);
+		
 		getContext().setVarScope(new VarScope(interpreter.getContext().getVarScope()));
 		interpreter.init();
 		for (IOperatorRegistry registry : interpreter.getCompiledContext().getOperatorRegistries()) {
-			if (getContext().getOperatorRegistry(registry.getOperatorRegistryName()) == null)
+			IOperatorRegistry existing = getContext().getOperatorRegistry(registry.getOperatorRegistryName());
+			if (existing == null || reusable.contains(registry.getOperatorRegistryName()))
 				addOperatorRegistry(registry);
 		}
 		registeredLibraries = interpreter.registeredLibraries;
@@ -122,6 +132,13 @@
 		}
 	}
 
+	private static Set<String> asSet(String... reuseRegistries) {
+		Set<String> reusable = new HashSet<String>();
+		if (reuseRegistries != null)
+			for (String reuse : reuseRegistries) reusable.add(reuse);
+		return reusable;
+	}
+
 	private static void warnUnqualifiedInvoke(HybridInterpreter interpreter, String main) {
 		interpreter.init();
 		SDefT invoked = interpreter.lookupUncifiedSVar(main);

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java	2010-03-29 15:27:38 UTC (rev 20736)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/compat/CompatManager.java	2010-03-30 07:55:13 UTC (rev 20737)
@@ -19,13 +19,15 @@
 	
 	private final Context context;
 	
-	private static Set<String> asyncComponents = new HashSet<String>();
+	private static final Set<String> asyncComponents = new HashSet<String>();
 	
 	public CompatManager(Context context) {
 		this.context = context;
 	}
 	
 	public void init() {
+		// We have to initialize the current context based on asyncComponents,
+		// since registerComponent() is only called in the life cycle of the JVM 
 		synchronized (asyncComponents) {
 			for (String component : asyncComponents) {
 				activateComponent(component);
@@ -44,7 +46,7 @@
 	 * Dynamically loads any compatibility library or operator registry
 	 * associated with a Stratego library.
 	 */
-	public void activateComponent(String component) {
+	private void activateComponent(String component) {
 		if ("stratego_lib".equals(component)) {
 			context.addOperatorRegistry(new CompatLibrary());
 			report_failure_compat_1_0.init();



From L.C.L.Kats at tudelft.nl  Tue Mar 30 10:33:31 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 30 Mar 2010 08:33:31 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20738 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.updatesite
Message-ID: <201003300933.o2U9XVDO028971@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-30 08:33:31 +0000 (Tue, 30 Mar 2010)
New Revision: 20738

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20738&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
New release 0.4.1.9

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-30 07:55:13 UTC (rev 20737)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-30 08:33:31 UTC (rev 20738)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.1.1"
+      version="0.4.1.9"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-30 07:55:13 UTC (rev 20737)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-30 08:33:31 UTC (rev 20738)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.1.1.jar" id="org.strategoxt.imp" version="0.4.1.1">
+   <feature url="features/org.strategoxt.imp_0.4.1.9.jar" id="org.strategoxt.imp" version="0.4.1.9">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Tue Mar 30 14:29:49 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 30 Mar 2010 12:29:49 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20739 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.sdf
	org.strategoxt.imp.editors.sdf/editor
	org.strategoxt.imp.editors.sdf/lib
	org.strategoxt.imp.editors.sdf/trans org.strategoxt.imp.feature
Message-ID: <201003301329.o2UDTnSr000741@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-30 12:29:49 +0000 (Tue, 30 Mar 2010)
New Revision: 20739

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20739&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/.classpath
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml

Log:
Minor fixes to SDF editor analysis; now creates a JAR instead of a ctree.

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/.classpath
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/.classpath	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/.classpath	2010-03-30 12:29:49 UTC (rev 20739)
@@ -1,8 +1,8 @@
-<?xml version="1.0" encoding="UTF-8" ?>
-
+<?xml version="1.0" encoding="UTF-8"?>
 <classpath>
 	<classpathentry kind="src" path="editor/java"/>
 	<classpathentry kind="con" path="org.eclipse.jdt.launching.JRE_CONTAINER/org.eclipse.jdt.internal.debug.ui.launcher.StandardVMType/J2SE-1.5"/>
 	<classpathentry kind="con" path="org.eclipse.pde.core.requiredPlugins"/>
+	<classpathentry kind="lib" path="utils/strategoxt.jar"/>
 	<classpathentry kind="output" path="bin"/>
-</classpath>
\ No newline at end of file
+</classpath>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/build.main.xml	2010-03-30 12:29:49 UTC (rev 20739)
@@ -20,7 +20,7 @@
         <property name="build.sdf.imports" value=""/>
         <property name="build.stratego.args" value="--library
                         -I &quot;${trans}&quot; -I &quot;${basedir}&quot;
-                        -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
+                        -la strc -la stratego-lib -la stratego-sglr -la stratego-gpp -la stratego-xtc -la stratego-aterm"/>
         
         <property name="externaldef" location="syntax/SDF.def"/>
         <!-- External .def and .jar locations
@@ -37,5 +37,5 @@
         <import file="build.generated.xml"/>
     
         <!-- Main target -->
-        <target name="all" depends="sdf2table,stratego.ctree,sdf2imp"/>
+        <target name="all" depends="sdf2table,stratego.jar,sdf2imp"/>
     </project>

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/editor/SDF-Builders.esv	2010-03-30 12:29:49 UTC (rev 20739)
@@ -5,7 +5,7 @@
 
 builders
   
-  provider : include/sdf.ctree
+  provider : include/sdf.jar
   
   observer : editor-analyze
   

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-30 12:29:49 UTC (rev 20739)
@@ -18,6 +18,12 @@
     | <import-term(include/SDF.tbl)>
     )
   
+  parse-stream =
+    parse-stream(
+      strsglr-report-parse-error
+    | <import-term(include/SDF.tbl)>
+    )
+
 strategies
   
   /**
@@ -77,11 +83,13 @@
   import-cache-path:
     full-path -> cache-path
     with
-      project-path := <prim("SSL_EXT_projectpath")>;
+      project-path := <project-path>;
       cache-dir    := <file-exists <+ mkdir> $[[project-path]/.cache];
       full-path'   := <string-replace(|"/", "+"); string-replace(|"\\", "+"); string-replace(|":", "+")> full-path;
       cache-path   := $[[cache-dir]/[full-path'].sig]
 
+  project-path = prim("SSL_EXT_projectpath")
+
   is-newer:
     (file1, file2) -> <id>
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str	2010-03-30 12:29:49 UTC (rev 20739)
@@ -31,9 +31,9 @@
     unparameterized(x) -> unparameterized(x)
     where
       <open-import(
-        resolve-import
-      , parse-file
-      , declare-globals-top
+        debug(!1); resolve-import; debug(!2)
+      , debug(!3); parse-file; debug(!4)
+      , debug(!5); declare-globals-top
       )> x
 
   declare-globals:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/sdf.str	2010-03-30 12:29:49 UTC (rev 20739)
@@ -15,6 +15,10 @@
   editor-analyze:
     (ast, path, project-path) -> ([], warnings, [])
     with
+      // Ensure all dynamic rules are properly scoped
+      try(dr-scope-all-end);
+      dr-scope-all-start
+    with
       analyze-ast;
       warnings := <collect(?context-free-syntax(<filter(context-free-syntax-warning)>))> ast
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-30 08:33:31 UTC (rev 20738)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-30 12:29:49 UTC (rev 20739)
@@ -222,8 +222,7 @@
          id="org.strategoxt.imp.editors.sdf"
          download-size="0"
          install-size="0"
-         version="0.1.1.qualifier"
-         unpack="false"/>
+         version="0.1.1.qualifier"/>
 
    <plugin
          id="org.strategoxt.imp.editors.stratego"



From L.C.L.Kats at tudelft.nl  Tue Mar 30 14:56:33 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 30 Mar 2010 12:56:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20740 - LennartKats -
	spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans
Message-ID: <201003301356.o2UDuXua001086@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-30 12:56:33 +0000 (Tue, 30 Mar 2010)
New Revision: 20740

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20740&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str

Log:


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str	2010-03-30 12:29:49 UTC (rev 20739)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/trans/analysis.str	2010-03-30 12:56:33 UTC (rev 20740)
@@ -31,9 +31,9 @@
     unparameterized(x) -> unparameterized(x)
     where
       <open-import(
-        debug(!1); resolve-import; debug(!2)
-      , debug(!3); parse-file; debug(!4)
-      , debug(!5); declare-globals-top
+        resolve-import
+      , parse-file
+      , declare-globals-top
       )> x
 
   declare-globals:



From L.C.L.Kats at tudelft.nl  Tue Mar 30 16:11:00 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Tue, 30 Mar 2010 14:11:00 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20741 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.feature
	org.strategoxt.imp.generator/src/sdf2imp/project
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
	org.strategoxt.imp.updatesite
Message-ID: <201003301511.o2UFB0Is002582@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-30 14:11:00 +0000 (Tue, 30 Mar 2010)
New Revision: 20741

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20741&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPAnnoLocationPrimitive.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPReadTextFromStream.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SourceMappings.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
fixes/tweaks

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-30 14:11:00 UTC (rev 20741)
@@ -18,6 +18,12 @@
     | <import-term(include/Stratego-Sugar.tbl)>
     )
   
+  parse-stream =
+    parse-stream(
+      strsglr-report-parse-error
+    | <import-term(include/Stratego-Sugar.tbl)>
+    )
+
 strategies
   
   /**
@@ -77,11 +83,13 @@
   import-cache-path:
     full-path -> cache-path
     with
-      project-path := <prim("SSL_EXT_projectpath")>;
+      project-path := <project-path>;
       cache-dir    := <file-exists <+ mkdir> $[[project-path]/.cache];
       full-path'   := <string-replace(|"/", "+"); string-replace(|"\\", "+"); string-replace(|":", "+")> full-path;
       cache-path   := $[[cache-dir]/[full-path'].sig]
 
+  project-path = prim("SSL_EXT_projectpath")
+
   is-newer:
     (file1, file2) -> <id>
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-30 14:11:00 UTC (rev 20741)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.1.9"
+      version="0.4.1.99"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/project/create-example-trans.str	2010-03-30 14:11:00 UTC (rev 20741)
@@ -35,10 +35,7 @@
   editor-analyze:
     (ast, path, project-path) -> (errors, warnings, notes)
     with
-      // Ensure all dynamic rules are properly scoped
-      try(dr-scope-all-end);
-      dr-scope-all-start
-    with
+      editor-init;
       analyze;
       errors   := <collect-all(constraint-error, conc)> ast;
       warnings := <collect-all(constraint-warning, conc)> ast;
@@ -294,6 +291,11 @@
 
 strategies
   
+  editor-init =
+    // Ensure all dynamic rules are properly scoped
+    try(dr-scope-all-end);
+    dr-scope-all-start
+  
   refresh-workspace-file:
     path -> <prim("SSL_EXT_refreshresource", path)>
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -31,6 +31,7 @@
 import org.spoofax.interpreter.core.StackTracer;
 import org.spoofax.interpreter.core.UndefinedStrategyException;
 import org.spoofax.interpreter.library.LoggingIOAgent;
+import org.spoofax.interpreter.library.jsglr.JSGLRLibrary;
 import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
@@ -135,7 +136,10 @@
 		
 		HybridInterpreter prototype = cachedRuntimes.get(descriptor);
 		if (prototype != null) {
-			runtime = new HybridInterpreter(prototype, IMPJSGLRLibrary.REGISTRY_NAME, IMPLibrary.REGISTRY_NAME);
+			runtime = new HybridInterpreter(prototype,
+					IMPJSGLRLibrary.REGISTRY_NAME, // is spoofax-specific
+					JSGLRLibrary.REGISTRY_NAME,    // connected to the library above
+					IMPLibrary.REGISTRY_NAME);     // also used
 			return;
 		}
 		

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPAnnoLocationPrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPAnnoLocationPrimitive.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPAnnoLocationPrimitive.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -1,8 +1,11 @@
 package org.strategoxt.imp.runtime.stratego;
 
+import java.io.File;
+
 import org.spoofax.interpreter.core.IContext;
 import org.spoofax.interpreter.core.InterpreterException;
 import org.spoofax.interpreter.stratego.Strategy;
+import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.lang.compat.sglr.STRSGLR_anno_location;
@@ -35,9 +38,13 @@
 		if (oldChars == null) return true;
 
 		ATerm newAsfixTerm = Environment.getATermConverter().convert(newAsfix);
+		File inputFile = oldAsfix instanceof IStrategoAppl
+			? mappings.getInputFile((IStrategoAppl) oldAsfix)
+			: null;
 		mappings.putInputChars(newAsfix, oldChars);
 		mappings.putInputTerm(newAsfix, newAsfixTerm);
-		mappings.putInputFile(newAsfix, mappings.getInputFile(oldAsfix));
+		if (newAsfix instanceof IStrategoAppl)
+			mappings.putInputFile((IStrategoAppl) newAsfix, inputFile);
 		mappings.putTokenizer(newAsfix, mappings.getTokenizer(oldAsfix));
 		
 		return true;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPImplodeAsfixStrategy.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -3,6 +3,7 @@
 import java.io.File;
 
 import org.spoofax.interpreter.library.IOperatorRegistry;
+import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.ast.AsfixImploder;
@@ -39,7 +40,9 @@
 		SourceMappings mappings = ((IMPJSGLRLibrary) library).getMappings();
 		char[] inputChars = mappings.getInputChars(asfix);
 		ATerm asfixATerm = mappings.getInputTerm(asfix);
-		File inputFile = mappings.getInputFile(asfix);
+		File inputFile = asfix instanceof IStrategoAppl
+				? mappings.getInputFile((IStrategoAppl) asfix)
+				: null;
 		SGLRTokenizer tokenizer = mappings.getTokenizer(asfix);
 		
 		if (inputChars == null || asfix == null) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPParseStringPTPrimitive.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -1,11 +1,13 @@
 package org.strategoxt.imp.runtime.stratego;
 
+import java.io.File;
 import java.io.IOException;
 import java.util.IdentityHashMap;
 import java.util.Map;
 
 import org.spoofax.interpreter.core.IContext;
 import org.spoofax.interpreter.core.InterpreterException;
+import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.jsglr.Disambiguator;
@@ -62,16 +64,20 @@
 		char[] inputChars = input.toCharArray();
 		
 		final ATerm asfix = parser.parseNoImplode(inputChars, path);
-		IStrategoTerm result = new LazyTerm() {
+		IStrategoAppl result = new LazyTerm() {
 			@Override
 			protected IStrategoTerm init() {
 				return Environment.getATermConverter().convert(asfix);
 			}
 		};
 
+		File inputFile = mappings.getInputFile(inputTerm);
+		if (inputFile == null)
+			Environment.logWarning("Could not determine original file name for parsed string");
+		
 		mappings.putInputTerm(result, asfix);
 		mappings.putInputChars(result, inputChars);
-		mappings.putInputFile(result, mappings.getInputFile(inputTerm));
+		mappings.putInputFile(result, inputFile);
 		mappings.putTokenizer(result, parser.getTokenizer());
 		
 		return result;

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPReadTextFromStream.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPReadTextFromStream.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/IMPReadTextFromStream.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -19,12 +19,15 @@
 
 	@Override
 	protected IStrategoString call(IContext env, int fd) throws IOException {
-		final IStrategoString result = super.call(env, fd);
+		IStrategoString result = super.call(env, fd);
 		if (result == null) return null;
 		
-		mappings.putInputFile(result, mappings.getInputFile(fd));
+		// Wrap in an unshared object; strings may be shared
+		// TODO: use identity hash code or something?
+		SourceMappings.MappableString mappableResult = new SourceMappings.MappableString(result); 
+		mappings.putInputFile(mappableResult, mappings.getInputFile(fd));
 		
-		return result;
+		return mappableResult;
 	}
 
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/RefreshResourcePrimitive.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -80,6 +80,10 @@
 	}
 
 	public static IResource getResource(File file) {
+		if (file == null) {
+			assert false : "file should not be null";
+			return null;
+		}
 		URI uri = file.toURI();
 		IWorkspace workspace = ResourcesPlugin.getWorkspace();
 		IResource[] resources = workspace.getRoot().findFilesForLocationURI(uri);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SourceMappings.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SourceMappings.java	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/SourceMappings.java	2010-03-30 14:11:00 UTC (rev 20741)
@@ -1,14 +1,16 @@
 package org.strategoxt.imp.runtime.stratego;
 
-import static org.spoofax.interpreter.terms.IStrategoTerm.APPL;
+import static org.spoofax.interpreter.core.Tools.isTermAppl;
 
 import java.io.File;
 import java.util.Map;
 import java.util.WeakHashMap;
 
+import org.spoofax.interpreter.terms.IStrategoAppl;
 import org.spoofax.interpreter.terms.IStrategoString;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.runtime.parser.tokens.SGLRTokenizer;
+import org.strategoxt.lang.terms.StrategoWrapped;
 
 import aterm.ATerm;
 
@@ -21,7 +23,7 @@
 	
 	private final Map<Integer, File> inputFileMap = new WeakHashMap<Integer, File>();
 	
-	private final Map<IStrategoString, File> stringInputFileMap = new WeakHashMap<IStrategoString, File>();
+	private final Map<MappableKey, File> stringInputFileMap = new WeakHashMap<MappableKey, File>();
 	
 	private final Map<IStrategoTerm, File> asfixInputFileMap = new WeakHashMap<IStrategoTerm, File>();
 	
@@ -35,11 +37,11 @@
 		return inputFileMap.put(fd, file);
 	}
 
-	public File putInputFile(IStrategoString string, File file) {
-		return stringInputFileMap.put(string, file);
+	public File putInputFile(MappableString string, File file) {
+		return stringInputFileMap.put(string.identityKey, file);
 	}
 	
-	public File putInputFile(IStrategoTerm asfix, File file) {
+	public File putInputFile(IStrategoAppl asfix, File file) {
 		return asfixInputFileMap.put(asfix, file);
 	}
 
@@ -60,11 +62,16 @@
 	}
 	
 	public File getInputFile(IStrategoString string) {
-		return stringInputFileMap.get(string);
+		if (string instanceof MappableString) {
+			MappableKey key = ((MappableString) string).identityKey;
+			return stringInputFileMap.get(key);
+		} else {
+			return null;
+		}
 	}
 	
-	public File getInputFile(IStrategoTerm asfix) {
-		assert asfix.getTermType() == APPL;
+	public File getInputFile(IStrategoAppl asfix) {
+		assert isTermAppl(asfix);
 		return asfixInputFileMap.get(asfix);
 	}
 	
@@ -79,4 +86,25 @@
 	public SGLRTokenizer getTokenizer(IStrategoTerm asfix) {
 		return tokenizerMap.get(asfix);
 	}
+	
+	/**
+	 * @author Lennart Kats <lennart add lclnet.nl>
+	 */
+	public static class MappableString extends StrategoWrapped {
+
+		final MappableKey identityKey = new MappableKey();
+		
+		public MappableString(IStrategoString wrapped) {
+			super(wrapped);
+		}
+
+		@Override
+		public int getStorageType() {
+			return IMMUTABLE;
+		}
+	}
+	
+	private static class MappableKey {
+		// Just used for identity hashcode and equals implementation
+	}
 }

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-30 12:56:33 UTC (rev 20740)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-30 14:11:00 UTC (rev 20741)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.1.9.jar" id="org.strategoxt.imp" version="0.4.1.9">
+   <feature url="features/org.strategoxt.imp_0.4.1.91.jar" id="org.strategoxt.imp" version="0.4.1.91">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar 31 11:40:22 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 31 Mar 2010 09:40:22 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20742 - LennartKats -
	strc-java/trunk/java/runtime/org/strategoxt/lang
Message-ID: <201003311040.o2VAeMB4017384@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-31 09:40:22 +0000 (Wed, 31 Mar 2010)
New Revision: 20742

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20742&view=rev

Modified:
   strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_newint_0_0.java

Log:


Changes:

Modified: strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_newint_0_0.java
===================================================================
--- strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_newint_0_0.java	2010-03-30 14:11:00 UTC (rev 20741)
+++ strc-java/trunk/java/runtime/org/strategoxt/lang/SRTS_EXT_newint_0_0.java	2010-03-31 09:40:22 UTC (rev 20742)
@@ -6,6 +6,7 @@
 import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.spoofax.interpreter.terms.ITermPrinter;
+import org.strategoxt.lang.terms.TermFactory;
 
 /**
  * @author Lennart Kats <lennart add lclnet.nl>
@@ -33,7 +34,7 @@
 		}
 
 		public IStrategoList getAnnotations() {
-			return null;
+			return TermFactory.EMPTY_LIST;
 		}
 
 		public int getStorageType() {



From L.C.L.Kats at tudelft.nl  Wed Mar 31 12:02:17 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 31 Mar 2010 10:02:17 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20743 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.sdf/lib
	org.strategoxt.imp.editors.stratego/editor
	org.strategoxt.imp.editors.stratego/lib
	org.strategoxt.imp.editors.stratego/trans org.strategoxt.imp.feature
	org.strategoxt.imp.generator/src/sdf2imp/util
	org.strategoxt.imp.generator/src/syntax
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego
	org.strategoxt.imp.updatesite
Message-ID: <201003311102.o2VB2HT6017897@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-31 10:02:15 +0000 (Wed, 31 Mar 2010)
New Revision: 20743

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20743&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Builders.esv
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/ide-support.str
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/BuildersService.sdf
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/BuilderFactory.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/CustomStrategyBuilder.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
Spoofax/72: Have editor services operate on the resulting/decorated AST

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.sdf/lib/editor-common.generated.str	2010-03-31 10:02:15 UTC (rev 20743)
@@ -97,6 +97,11 @@
 
 strategies
   
+  editor-init =
+    // Ensure all dynamic rules are properly scoped
+    try(dr-scope-all-end);
+    dr-scope-all-start
+  
   refresh-workspace-file:
     path -> <prim("SSL_EXT_refreshresource", path)>
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Builders.esv
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Builders.esv	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/editor/Stratego-Sugar-Builders.esv	2010-03-31 10:02:15 UTC (rev 20743)
@@ -13,8 +13,8 @@
   observer : editor-analyze
 
   builder : "Show desugared AST (selection)" =
-    generate-desugared-aterm (realtime) (meta) (openeditor)
+    generate-desugared-aterm (realtime) (meta) (openeditor) (source)
 
   builder : "Show AST (selection)" =
-    generate-aterm (realtime) (meta) (openeditor) 
+    generate-aterm (realtime) (meta) (openeditor) (source) 
  
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/lib/editor-common.generated.str	2010-03-31 10:02:15 UTC (rev 20743)
@@ -97,6 +97,11 @@
 
 strategies
   
+  editor-init =
+    // Ensure all dynamic rules are properly scoped
+    try(dr-scope-all-end);
+    dr-scope-all-start
+  
   refresh-workspace-file:
     path -> <prim("SSL_EXT_refreshresource", path)>
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str	2010-03-31 10:02:15 UTC (rev 20743)
@@ -14,7 +14,7 @@
 rules
 
   editor-analyze:
-    (ast, path, project-path) -> (errors, warnings, [])
+    (ast, path, project-path) -> (/*ast',*/ errors, warnings, [])
     with
       // Ensure all dynamic rules are properly scoped
       try(dr-scope-all-end);
@@ -40,15 +40,25 @@
       <basic-desugar-top; analyze-ast-local> ast;
       proposals := <ContentProposals>
  
+  /* TODO: return ast' from analysis and use this rule based on the decorated ast
   editor-resolve:
     (selected, position, ast, path, project-path) -> target
     where
+      target := <declaration-of> <term-at-position(|position)> ast
+    <+
+      target := <declaration-of> <parent-at-position(|position)> ast
+  */
+  
+  editor-resolve:
+    (selected, position, ast, path, project-path) -> target
+    where
       position' := <desugar-position(basic-desugar|ast)> position
     where
       target := <declaration-of> <term-at-position(|position')> <DecoratedAst>
     <+
       target := <declaration-of> <parent-at-position(|position')> <DecoratedAst>
 
+
   editor-hover:
     (node, position, ast, path, project-path) -> text
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-31 10:02:15 UTC (rev 20743)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.1.99"
+      version="0.4.1.999"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/ide-support.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/ide-support.str	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/util/ide-support.str	2010-03-31 10:02:15 UTC (rev 20743)
@@ -61,4 +61,22 @@
         position := [start-index | i*]
       else
         position := <position-of-term(is-term | <inc> start-index)> t*
-      end
\ No newline at end of file
+      end
+
+  term-at-position(|position):
+    t -> t'
+    where
+      at-position(?t'|position)
+   
+  at-position(s|position):
+    c#(t*) -> t'
+    where
+      !position => [i | position']
+    where
+      t' := c#(<at-index(at-position(s|position'))> (i, t*))
+
+  at-position(s|position):
+    t -> t'
+    where
+      !position => [];
+      t' := <s> t
\ No newline at end of file

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/BuildersService.sdf
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/BuildersService.sdf	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/BuildersService.sdf	2010-03-31 10:02:15 UTC (rev 20743)
@@ -26,3 +26,4 @@
     "(persistent)" -> BuilderOption {cons("Persistent")}
     "(meta)"       -> BuilderOption {cons("Meta")}
     "(cursor)"     -> BuilderOption {cons("Cursor")}
+    "(source)"     -> BuilderOption {cons("Source")}

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/syntax/EditorService-pretty.pp	2010-03-31 10:02:15 UTC (rev 20743)
@@ -20,6 +20,7 @@
    RealTime             -- KW["(realtime)"],
    Persistent           -- KW["(persistent)"],
    Meta                 -- KW["(meta)"],
+   Source               -- KW["(source)"],
    Cursor               -- KW["(cursor)"],
    Strategy             -- _1,
    Attribute            -- H hs=0 [ KW["id"] KW["."] _1 ],

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/Environment.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -284,7 +284,7 @@
 			if (message != null) STDERR.println(message);
 			t.printStackTrace();
 		}
-		if (message == null) message = t.getLocalizedMessage();
+		if (message == null) message = t.getLocalizedMessage() == null ? t.getMessage() : t.getLocalizedMessage();
 		Status status = new Status(IStatus.ERROR, RuntimeActivator.PLUGIN_ID, 0, message, t);
 		RuntimeActivator activator = RuntimeActivator.getInstance();
 		if (activator != null) activator.getLog().log(status);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/BuilderFactory.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/BuilderFactory.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/dynamicloading/BuilderFactory.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -61,6 +61,7 @@
 			boolean persistent = false;
 			boolean meta = false;
 			boolean cursor = false;
+			boolean source = false;
 			
 			for (IStrategoTerm option : options.getAllSubterms()) {
 				String type = cons(option);
@@ -74,12 +75,14 @@
 					meta = true;
 				} else if (type.equals("Cursor")) {
 					cursor = true;
+				} else if (type.equals("Source")) {
+					source = true;
 				} else {
 					throw new BadDescriptorException("Unknown builder annotation: " + type);
 				}
 			}
 			if (!meta || d.isDynamicallyLoaded())			
-				builders.add(new StrategoBuilder(feedback, caption, strategy, openEditor, realTime, cursor, persistent, derivedFromEditor));
+				builders.add(new StrategoBuilder(feedback, caption, strategy, openEditor, realTime, cursor, source, persistent, derivedFromEditor));
 		}
 	}
 

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/parser/ast/AstNodeLocator.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -20,10 +20,10 @@
  */
 public class AstNodeLocator implements ISourcePositionLocator {
 	
-	private final SGLRParseController controller;
+	//private final SGLRParseController controller;
 	
 	public AstNodeLocator(SGLRParseController controller) {
-		this.controller = controller;
+		//this.controller = controller;
 	}
 
 	public IStrategoAstNode findNode(Object root, int startOffset, int endOffset) {
@@ -57,10 +57,11 @@
 		}
 		
 		try {
-			// Should return -1 if not using the same controller, per HyperLinkDetector
-			return node == null || node.getParseController() == controller
-				? token.getStartOffset()
-				: -1;
+			// UNDONE: Should return -1 if not using the same controller, per HyperLinkDetector
+			// return node == null || node.getParseController() == controller
+			// 	? token.getStartOffset()
+			// 	: -1;
+			return token.getStartOffset();
 		} catch (IllegalStateException e) {
 			// HACK: avoid this exception here (Spoofax/49)
 			Environment.logException("Could not determine parse controller", e);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/CustomStrategyBuilder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/CustomStrategyBuilder.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/CustomStrategyBuilder.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -34,7 +34,8 @@
 		synchronizedMap(new HashMap<String, String>());
 	
 	public CustomStrategyBuilder(StrategoObserver observer, EditorState derivedFromEditor) {
-		super(observer, "Apply custom rule...", null, true, true, false, false, derivedFromEditor);
+		// TODO: reconsider source = false here?
+		super(observer, "Apply custom rule...", null, true, true, false, false, false, derivedFromEditor);
 	}
 	
 	@Override

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoBuilder.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -56,6 +56,8 @@
 	
 	private final boolean cursor;
 	
+	private final boolean source;
+	
 	private final boolean persistent;
 	
 	private final EditorState derivedFromEditor;
@@ -66,7 +68,7 @@
 	 * @param derivedFromEditor  The editor the present editor is derived from, if the present editor is an ATerm editor.
 	 */
 	public StrategoBuilder(StrategoObserver observer, String caption, String builderRule,
-			boolean openEditor, boolean realTime, boolean cursor, boolean persistent,
+			boolean openEditor, boolean realTime, boolean cursor, boolean source, boolean persistent,
 			EditorState derivedFromEditor) {
 		
 		this.observer = observer;
@@ -75,6 +77,7 @@
 		this.openEditor = openEditor;
 		this.realTime = realTime;
 		this.cursor = cursor;
+		this.source = source;
 		this.persistent = persistent;
 		this.derivedFromEditor = derivedFromEditor;
 	}
@@ -200,8 +203,8 @@
 			InterpreterErrorExit, InterpreterExit, InterpreterException {
 		
 		IStrategoTerm inputTerm = derivedFromEditor != null
-				? observer.makeATermInputTerm(node, true) 
-				: observer.makeInputTerm(node, true);
+				? observer.makeATermInputTerm(node, true, derivedFromEditor.getResource()) 
+				: observer.makeInputTerm(node, true, source);
 		IStrategoTerm result = observer.invoke(builderRule, inputTerm, node.getResource());
 		return result;
 	}
@@ -225,7 +228,8 @@
 		
 		if (EditorState.isUIThread()) {
 			// Only show if builder runs interactively (and not from the StrategoBuilderListener background builder)
-			Status status = new Status(IStatus.ERROR, RuntimeActivator.PLUGIN_ID, e.getLocalizedMessage(), e);
+			String message = e.getLocalizedMessage() == null ? e.getMessage() : e.getLocalizedMessage();
+			Status status = new Status(IStatus.ERROR, RuntimeActivator.PLUGIN_ID, message, e);
 			ErrorDialog.openError(editor.getEditor().getSite().getShell(), caption, null, status);
 		}
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/StrategoObserver.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -1,8 +1,10 @@
 package org.strategoxt.imp.runtime.services;
 
+import static org.spoofax.interpreter.core.Tools.isTermTuple;
 import static org.spoofax.interpreter.core.Tools.termAt;
 import static org.spoofax.interpreter.terms.IStrategoTerm.LIST;
 import static org.spoofax.interpreter.terms.IStrategoTerm.TUPLE;
+import static org.strategoxt.imp.runtime.dynamicloading.TermReader.cons;
 
 import java.io.File;
 import java.io.IOException;
@@ -78,6 +80,9 @@
 	private static Map<Descriptor, HybridInterpreter> cachedRuntimes =
 		Collections.synchronizedMap(new WeakHashMap<Descriptor, HybridInterpreter>());
 	
+	private final Map<IResource, IStrategoTerm> resultingAsts =
+		new WeakHashMap<IResource, IStrategoTerm>();
+	
 	private final String feedbackFunction;
 	
 	private final AstMessageHandler messages = new AstMessageHandler(AstMessageHandler.ANALYSIS_MARKER_TYPE);
@@ -298,6 +303,7 @@
 		
 		try {
 			synchronized (getSyncRoot()) {
+				resultingAsts.remove(ast.getResource());
 				feedback = invokeSilent(feedbackFunction, makeInputTerm(ast, false), ast.getResource());
 	
 				if (feedback == null) {
@@ -365,6 +371,7 @@
 		messages.clearMarkers(resource);
 
 		try {
+			feedback = extractResultingAST(resource, feedback);
 			if (feedback.getTermType() == TUPLE
 					&& termAt(feedback, 0).getTermType() == LIST
 					&& termAt(feedback, 1).getTermType() == LIST
@@ -385,6 +392,20 @@
 		}
 	}
 	
+	private IStrategoTerm extractResultingAST(IResource resource, IStrategoTerm feedback) {
+		if (isTermTuple(feedback) && feedback.getSubtermCount() == 4
+				&& (!"None".equals(cons(feedback.getSubterm(0))) || feedback.getSubterm(0).getSubtermCount() > 0)) {
+			resultingAsts.put(resource, feedback.getSubterm(0));
+			
+			IStrategoTuple newFeedback = Environment.getTermFactory().makeTuple(
+					feedback.getSubterm(1), feedback.getSubterm(2), feedback.getSubterm(3));
+			return newFeedback;
+		} else {
+			resultingAsts.remove(resource);
+			return feedback;
+		}
+	}
+	
 	private final void feedbackToMarkers(IResource resource, IStrategoList feedbacks, int severity) {
 		assert Thread.holdsLock(getSyncRoot());
 		
@@ -423,16 +444,43 @@
 		return invoke(function, input, node.getResource());
 	}
 
-	protected IStrategoTuple makeInputTerm(IStrategoAstNode node, boolean includeSubNode) {
+	/**
+	 * Create an input term for a control rule.
+	 */
+	public IStrategoTuple makeInputTerm(IStrategoAstNode node, boolean includeSubNode) {
+		return makeInputTerm(node, includeSubNode, false);
+	}
+	
+	/**
+	 * Create an input term for a control rule.
+	 */
+	public IStrategoTuple makeInputTerm(IStrategoAstNode node, boolean includeSubNode, boolean useSourceAst) {
+		assert Thread.holdsLock(getSyncRoot());
+		
+		Context context = getRuntime().getCompiledContext();
+		IStrategoTerm resultingAst = useSourceAst ? null : resultingAsts.get(node.getResource());
+		IStrategoList termPath = StrategoTermPath.getTermPathWithOrigin(context, resultingAst, node);
+		IStrategoTerm targetTerm;
+		IStrategoTerm rootTerm;
+		
+		if (termPath != null) {
+			targetTerm = StrategoTermPath.getTermAtPath(context, resultingAst, termPath);
+			rootTerm = resultingAst;
+		} else {
+			targetTerm = node.getTerm();
+			termPath = StrategoTermPath.createPath(node);
+			rootTerm = getRoot(node).getTerm();
+		}
+		
 		ITermFactory factory = Environment.getTermFactory();
 		String path = node.getResource().getProjectRelativePath().toPortableString();
 		String absolutePath = node.getResource().getProject().getLocation().toOSString();
 		
 		if (includeSubNode) {
 			IStrategoTerm[] inputParts = {
-					node.getTerm(),
-					StrategoTermPath.createPath(node),
-					getRoot(node).getTerm(),
+					targetTerm,
+					termPath,
+					rootTerm,
 					factory.makeString(path),
 					factory.makeString(absolutePath)
 				};
@@ -447,13 +495,17 @@
 		}
 	}
 
-	protected IStrategoTuple makeATermInputTerm(IStrategoAstNode node, boolean includeSubNode) {
+	/**
+	 * Create an input term for a control rule,
+	 * based on the ATerm syntax of the AST of the source file.
+	 */
+	public IStrategoTuple makeATermInputTerm(IStrategoAstNode node, boolean includeSubNode, IResource resource) {
 		assert Thread.holdsLock(getSyncRoot());
 		stratego_aterm.init(runtime.getCompiledContext());
 		
 		ITermFactory factory = Environment.getTermFactory();
-		String path = node.getResource().getProjectRelativePath().toPortableString();
-		String absolutePath = node.getResource().getProject().getLocation().toOSString();
+		String path = resource.getProjectRelativePath().toPortableString();
+		String absolutePath = resource.getProject().getLocation().toOSString();
 		
 		if (includeSubNode) {
 			node = getImplodableNode(node);

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/stratego/StrategoTermPath.java	2010-03-31 10:02:15 UTC (rev 20743)
@@ -10,6 +10,7 @@
 import org.spoofax.interpreter.terms.IStrategoList;
 import org.spoofax.interpreter.terms.IStrategoTerm;
 import org.strategoxt.imp.generator.position_of_term_1_0;
+import org.strategoxt.imp.generator.term_at_position_0_1;
 import org.strategoxt.imp.runtime.Environment;
 import org.strategoxt.imp.runtime.parser.ast.AbstractVisitor;
 import org.strategoxt.imp.runtime.parser.ast.AstNode;
@@ -93,7 +94,57 @@
 			}
 		});
 	}
+	
+	/**
+	 * Determine the path to a term in 'ast' with origin 'origin'.
+	 */
+	public static IStrategoList getTermPathWithOrigin(Context context, IStrategoTerm ast, IStrategoAstNode origin) {
+		if (ast == null)
+			return null;
+		
+		final IStrategoAstNode originChild = origin.getChildren().size() == 0
+				? null
+				: (IStrategoAstNode) origin.getChildren().get(0);
+		
+		class TestOrigin extends Strategy {
+			IStrategoAstNode origin;
+			IStrategoAstNode nextBest;
+			
+			@Override
+			public IStrategoTerm invoke(Context context, IStrategoTerm current) {
+				if (current instanceof IWrappedAstNode) {
+					IStrategoAstNode currentOrigin = ((IWrappedAstNode) current).getNode();
+					if (currentOrigin == origin) return current;
+					List children = currentOrigin.getChildren();
+					if (nextBest == null && originChild != null) {
+						for (int i = 0; i < children.size(); i++)
+							if (children.get(i) == originChild)
+								nextBest = currentOrigin;
+					}
+				}
+				return null;
+			}
+		}
+		TestOrigin testOrigin = new TestOrigin();
+		testOrigin.origin = origin;
+		
+		IStrategoTerm perfectMatch = position_of_term_1_0.instance.invoke(context, ast, testOrigin);
+		if (perfectMatch != null) {
+			return (IStrategoList) perfectMatch;
+		} else if (testOrigin.nextBest != null) {
+			Environment.logWarning("Could not determine term corresponding to " + origin.toString() + " in resulting AST; using next best match " + testOrigin.nextBest);
+			testOrigin.origin = testOrigin.nextBest;
+			return (IStrategoList) position_of_term_1_0.instance.invoke(context, ast, testOrigin);
+		} else {
+			Environment.logWarning("Could not determine term corresponding to " + origin.toString() + " in resulting AST");
+			return null;
+		}
+	}
 
+	public static IStrategoTerm getTermAtPath(Context context, IStrategoTerm term, IStrategoList path) {
+		return term_at_position_0_1.instance.invoke(context, term, path);
+	}
+
 	private static int indexOfIdentical(List<?> children, IStrategoAstNode node) {
 		int index = 0;
 		for (int size = children.size(); index < size; index++) {

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-31 09:40:22 UTC (rev 20742)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-31 10:02:15 UTC (rev 20743)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.1.91.jar" id="org.strategoxt.imp" version="0.4.1.91">
+   <feature url="features/org.strategoxt.imp_0.4.1.999.jar" id="org.strategoxt.imp" version="0.4.1.999">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar 31 13:21:33 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 31 Mar 2010 11:21:33 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20744 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.editors.stratego/trans
	org.strategoxt.imp.feature
	org.strategoxt.imp.generator/src/sdf2imp/services
	org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle
	org.strategoxt.imp.updatesite
Message-ID: <201003311221.o2VCLXNo019083@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-31 11:21:33 +0000 (Wed, 31 Mar 2010)
New Revision: 20744

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20744&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
   spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/how-not-to.txt
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
Release 0.4.2

Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str	2010-03-31 10:02:15 UTC (rev 20743)
+++ spoofax-imp/trunk/org.strategoxt.imp.editors.stratego/trans/stratego_sugar.str	2010-03-31 11:21:33 UTC (rev 20744)
@@ -44,7 +44,7 @@
   editor-resolve:
     (selected, position, ast, path, project-path) -> target
     where
-      target := <declaration-of> <term-at-position(|position)> ast
+      target := <declaration-of> selected
     <+
       target := <declaration-of> <parent-at-position(|position)> ast
   */
@@ -58,7 +58,6 @@
     <+
       target := <declaration-of> <parent-at-position(|position')> <DecoratedAst>
 
-
   editor-hover:
     (node, position, ast, path, project-path) -> text
     where

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-31 10:02:15 UTC (rev 20743)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-31 11:21:33 UTC (rev 20744)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.1.999"
+      version="0.4.2"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">

Modified: spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	2010-03-31 10:02:15 UTC (rev 20743)
+++ spoofax-imp/trunk/org.strategoxt.imp.generator/src/sdf2imp/services/create-builders-descriptor.str	2010-03-31 11:21:33 UTC (rev 20744)
@@ -73,9 +73,10 @@
           ~//   (persistent)  Indicates that the resulting file should be saved to disk.
           ~//   (realtime)    Indicates that the resulting editor should be updated in real-time
           ~//                 as the source file is edited.
+          ~//   (source)      Always apply this builder to the source AST, not to the AST
+          ~//                 after it has been analyzed/desugared by the observer.
           ~//
-          ~// The 'on save' handler can be used  to generate code as files
-          ~// are saved:
+          ~// The 'on save' handler can be used  to generate code as files are saved:
           ~//   
           ~//   on save : generate-java
       ]|

Modified: spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-31 10:02:15 UTC (rev 20743)
+++ spoofax-imp/trunk/org.strategoxt.imp.nativebundle/src/org/strategoxt/imp/nativebundle/SDFBundleCommand.java	2010-03-31 11:21:33 UTC (rev 20744)
@@ -42,6 +42,8 @@
 	
 	private final xtc_command_1_0 proceed = xtc_command_1_0.instance;
 	
+	private final String[] windowsEnvironment = createWindowsEnvironment();
+	
 	private String binaryPath;
 	
 	private String binaryExtension;
@@ -148,7 +150,7 @@
 		//String[] environment = Platform.getOS() == Platform.OS_WIN32
 		//	? createWindowsEnvironment()
 		//	: null;
-		String[] environment = createWindowsEnvironment();
+		String[] environment = windowsEnvironment;
 		IOAgent io = context.getIOAgent();
 		
 		try {
@@ -181,7 +183,7 @@
 		}
 	}
 	
-	private String[] createWindowsEnvironment() {
+	private static String[] createWindowsEnvironment() {
 		Map<String, String> envp = new HashMap<String, String>(System.getenv());
 		envp.put("CYGWIN", "nodosfilewarning");
 		String[] result = new String[envp.size()];

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/how-not-to.txt
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/how-not-to.txt	2010-03-31 10:02:15 UTC (rev 20743)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/how-not-to.txt	2010-03-31 11:21:33 UTC (rev 20744)
@@ -5,12 +5,10 @@
 3.  DON'T specify the "unpack" attribute in feature.xml; let Eclipse surprise you instead (the little checkbox won't tell you what happens)
 4.  DON'T delete the content.jar and artifacts.jar after cleaning up the update dir
 5.  DON'T open feature.xml in Eclipse and set all versions to those in the projects using the "Versions" button
-6.  There is no number 6
-7.  DON'T open site.xml in Eclipse and choose "Add Feature" and add the new feature (be sure you DON'T put it in the category so it won't show up)
-8.  Or DON'T pick "Synchronize all" if you made an update site already
+6.  DON'T open site.xml in Eclipse and choose "Add Feature" and add the new feature (be sure you DON'T put it in the category so it won't show up)
+7.  Or DON'T pick "Synchronize all" if you made an update site already
+8.  DON'T save before building the feature.xml
 9.  DON'T choose "Build All"; if you pick "Build" it will act like its building but won't build all plugins
 10. Especially DON'T invoke your favorite deity through prayer and/or song at this point
 11. If you're using a testing directory for updates, be sure you DON'T adapt site.xml with the new url
 12. Finally, to test it, DON'T use a clean Eclipse installation and DON'T use a clean workspace (Eclipse 3.4+ may do workspace-based caching!)
-13. ???
-14. Profit

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-31 10:02:15 UTC (rev 20743)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-31 11:21:33 UTC (rev 20744)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.1.999.jar" id="org.strategoxt.imp" version="0.4.1.999">
+   <feature url="features/org.strategoxt.imp_0.4.2.jar" id="org.strategoxt.imp" version="0.4.2">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



From L.C.L.Kats at tudelft.nl  Wed Mar 31 16:36:25 2010
From: L.C.L.Kats at tudelft.nl (Lennart Kats)
Date: Wed, 31 Mar 2010 14:36:25 +0000
Subject: [Stratego-commits] SVN commit: StrategoXT - 20745 - LennartKats -
	in spoofax-imp/trunk: org.strategoxt.imp.feature
	org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services
	org.strategoxt.imp.updatesite
Message-ID: <201003311536.o2VFaPRh022319@proliant.st.ewi.tudelft.nl>

Author: LennartKats
Date: 2010-03-31 14:36:24 +0000 (Wed, 31 Mar 2010)
New Revision: 20745

You can view the changes in this commit at:
   https://svn.strategoxt.org/viewvc/StrategoXT?rev=20745&view=rev

Modified:
   spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
   spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
   spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml

Log:
- ContentProposer shouldn't operate on the decorated AST (Spoofax/72)
- Spoofax/69: Code completion (error recovery?) produces weird ASTs


Changes:

Modified: spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-31 11:21:33 UTC (rev 20744)
+++ spoofax-imp/trunk/org.strategoxt.imp.feature/feature.xml	2010-03-31 14:36:24 UTC (rev 20745)
@@ -2,7 +2,7 @@
 <feature
       id="org.strategoxt.imp"
       label="Spoofax/IMP"
-      version="0.4.2"
+      version="0.4.2.1"
       plugin="org.strategoxt.imp.runtime">
 
    <description url="http://strategoxt.org/Stratego/Spoofax-IMP">
@@ -147,8 +147,7 @@
          id="lpg.runtime"
          download-size="0"
          install-size="0"
-         version="2.0.17.qualifier"
-         unpack="false"/>
+         version="2.0.17.qualifier"/>
 
    <plugin
          id="org.eclipse.imp.smapi"

Modified: spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-31 11:21:33 UTC (rev 20744)
+++ spoofax-imp/trunk/org.strategoxt.imp.runtime/src/org/strategoxt/imp/runtime/services/ContentProposer.java	2010-03-31 14:36:24 UTC (rev 20745)
@@ -209,7 +209,8 @@
 				IStrategoTerm result;
 				public void run() {
 					synchronized (observer.getSyncRoot()) {
-						result = observer.invokeSilent(completionFunction, currentCompletionNode);
+						IStrategoTerm input = observer.makeInputTerm(currentCompletionNode, true, false);
+						result = observer.invokeSilent(completionFunction, input, currentCompletionNode.getResource());
 						if (result == null) {
 							observer.reportRewritingFailed();
 							result = TermFactory.EMPTY_LIST;
@@ -538,8 +539,12 @@
 	}
 	
 	private void replacePrefix(AstNode completionNode, String prefix) {
-		if (completionNode.getConstructor() != COMPLETION_CONSTRUCTOR)
-			completionNode = completionNode.getChildren().get(0);
+		if (completionNode.getConstructor() != COMPLETION_CONSTRUCTOR) {
+			for (Object child : completionNode.getChildren()) {
+				if (((AstNode) child).getConstructor() == COMPLETION_CONSTRUCTOR)
+					completionNode = (AstNode) child;
+			}
+		}
 		StringAstNode prefixNode = (StringAstNode) completionNode.getChildren().get(0);
 		prefixNode.setValue(prefix);
 	}

Modified: spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml
===================================================================
--- spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-31 11:21:33 UTC (rev 20744)
+++ spoofax-imp/trunk/org.strategoxt.imp.updatesite/site.xml	2010-03-31 14:36:24 UTC (rev 20745)
@@ -3,7 +3,7 @@
    <description name="Spoofax/IMP" url="http://www.lclnet.nl/update/">
       Spoofax/IMP update site
    </description>
-   <feature url="features/org.strategoxt.imp_0.4.2.jar" id="org.strategoxt.imp" version="0.4.2">
+   <feature url="features/org.strategoxt.imp_0.4.2.1.jar" id="org.strategoxt.imp" version="0.4.2.1">
       <category name="Spoofax/IMP"/>
    </feature>
    <category-def name="Spoofax/IMP" label="Spoofax/IMP">



